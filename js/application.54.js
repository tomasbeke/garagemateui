self.__bootstrap__||(self.__bootstrap__={modules:{},cssvarmap:{},templates:{}});
__bootstrap__.templates["z/data/appauth.html"] = "<div class=`app-auth`>[NL] <form class=`app-auth-form` action=`javascript:void(0)`>[NL] <br/>[NL] <div> User Id</div>[NL] <input type=`text` class=`app-auth-loginid`  placeholder=`User id` autofocus=`autofocus` name=`auth_loginid` id=`auth_loginid`   style=`display:block;text-shadow:1px 1px 1px #ccc;background:white;border:1px solid #ccc;color:#333color:#333;padding:0 5px; font-size:1.2rem;line-height:2;width:16rem;border-radius:5px;`/>[NL] <div> Password</div>[NL] <input type=`password` class=`app-auth-pw` placeholder=`Password`   name=`auth_pw` id=`auth_pw`   style=`display:block;text-shadow:1px 1px 1px #ccc;background:white;border:1px solid #ccc;color:#333color:#333;padding:0 5px; font-size:1.2rem;line-height:2;width:16rem;border-radius:5px;`/>[NL][NL] <div id=`login-msg` class=`login-msg` style=`text-align:center;color:red;`></div>[NL][NL] <div style=`text-align:right;margin-top:5px;padding-right:5px;clear:both;height:30px;`>[NL] <span style=`float:left;` class=`app-auth-forgot-pw`>forgot password?</span>[NL] <button class=`app-auth-enter` type=`submit` style=`float:right;height: 1.8em;background:#f3f3f3; border: 2px solid #999; color: #333;padding: 1px 10px;color:#fff; background:#7AC548;border-color:#7AC548;` >Enter</button>[NL] </div>[NL] <div class=`app-auth-acts` >[NL] <span  class=`app-auth-new-account` onclick=`app.promptNewAccount()`>Create New Account</span>[NL] </div>[NL] </form>[NL]</div>"
__bootstrap__.templates["z/data/pagecontent.html"] = "<div class=`outer-content`>[NL][NL][NL]</div>"
__bootstrap__.modules["common/AppInitConfig"] = function(module){
/**
 * Created by Atul on 9/1/2015.
 */
var NOTIFICATIONLISTENER=null;
/**
 * Description
 * @method AppInitConfig
 * @param {} app
 * @return LogicalExpression
 */
function AppInitConfig(app){
	var user = app.user
	if(!app.userDetails){
		var userDet=$.require("common/UserDetails")
		app.userDetails = new userDet()
	}

	if(!app.location){
		app.properties.setItem("location",null);
		app.location={};
	}
	if(!app.MESSAGES){
		app.MESSAGES= $.require("common/AppMessages")
		app.bingKey = "AueimIB2RGZZf2HLlbFUCb2tjWTmV2079vyOkazOqaEtiWmn-JY54zaW7FVIV-fJ"
		app.mqKey = "Fmjtd%7Cluur29682l%2C75%3Do5-90rsg4"
	}

	if(!app.appassetsPath && app.contextPath){
		app.appassetsPath=app.contextPath+"app/theme/assets/"
		if(typeof(Data)!="undefined"){
			Data.servicePath = app.servicePath || (app.contextPath + "router")
		}
	}
	if ($.browser.ie) {
		$d(document.body).addClass("noselection")
	}
	if (!(user && user.id)) {
		var userinfo=app.restoreUserInfo( )
		if(userinfo){
			$.extend(user,userinfo);
		}

	}

	if(!NOTIFICATIONLISTENER){
		/**
		 * Description
		 * @param {} ev
		 * @return 
		 */
		NOTIFICATIONLISTENER=function (ev) {
			var record=ev.data.record||{}
			app.splashInfo("Notification<br/>" + (record.msg||ev.data.message||""), 1000)
			app.observer.fire("notificationupdate", ev.data)
		}
		app.onRemote("notificationupdate", NOTIFICATIONLISTENER);
		app.onRemote("notificationcreated", NOTIFICATIONLISTENER);

		app._showCard=function(optns){
			$.require("common/ReserveCardView").show(optns)
		}
		/**
		 * Description
		 * @method showReceipt
		 * @param {} args
		 * @return 
		 */
		app.showReceipt=function(args){
			var resnum=args.reservenum
			if(resnum){
				app.remoteDirective("reserveinfo",{reserve_num:resnum,includefacility:true},function(data){
					if(!data){return}
					try{
						if($.browser.phantomjs){
							$.date.__tmzot=Number(args.tmzot)||0
						}
						var optns = {
							template: "receipt",
							record: data,showreceipt:true,
							container: $.browser.phantomjs ? document.body : null,
							anchor: $.browser.phantomjs ? null : $d.util.getActiveElement()
						}
						app._showCard(optns);
						return
					} catch(e){
						return e.toString()
					}
				})
			}
		}
		/**
		 * Description
		 * @method showClaimCheck
		 * @param {} args
		 * @return 
		 */
		app.showClaimCheck=function(args){
			var resnum=args.reservenum
			if(resnum){
				app.remoteDirective("reserveinfo",{reserve_num:resnum,includefacility:true},function(data) {
					try {
						if (!data) {
							return
						}
						if ($.browser.phantomjs) {
							$.date.__tmzot = Number(args.tmzot) || 0
						}
						var optns = {
							template: "claimcheck",
							record: data,
							container: $.browser.phantomjs ? document.body : null,
							anchor: $.browser.phantomjs ? null : $d.util.getActiveElement()
						}
						app._showCard(optns);
					} catch(e){
						return e.toString()
					}
					return
				})
			}
		}
		/**
		 * Description
		 * @method setScroll
		 * @param {} scroll
		 * @return 
		 */
		app.setScroll = function (scroll) {
			app.noscroll = scroll !== true
			document.documentElement.style.overflow = app.noscroll ? "hidden" : "auto"
			if (app.noscroll) {
				document.body.scrollTop = document.documentElement.scrollTop = 0
			}
		}
	}
	return app.user||(app.user={id:0})

}

module.exports=AppInitConfig
}
__bootstrap__.modules["common/AppMessages"] = function(module){
/**
 * Created by Atul on 9/1/2015.
 */
var AppMessages={
	"getvehicle":"Message sent to facility to retrieve the vehicle and prepare for check-out"
}

module.exports=AppMessages;
}
__bootstrap__.modules["common/AppnotificationsView"] = function(module){
/**
 * Created by Atul on 6/1/2015.
 */
var SimpleView=$.require("SimpleView")
var ReserveCardView=$.require("common/ReserveCardView")
var ReserveModel=$.require("models/ReserveModel")
var PopupView =$.require("PopupView")

var STATUS={
 UNREAD:0,
 PENDING:1,
 ACCEPT:1,
 REJECT:3,
 //WITHDRAW:1,
 COMPLETE:2,
}
 var AppnotificationsView=Klass(SimpleView,{
  triggerCount:null,
  currentItems:null,
     notificationTypes:null,
     filter:null,
  triggerSelector:".app-notifications-link",
  /**
   * Description
   * @method init
   * @return 
   */
  init:function() {
    this.initView()
    this.el.addClass("fit-vp-content")
    this.el.addClass("app-notifications-view").css({zIndex:20})
    this.on("afterRender",function(){this.el.toFront(true)})
    this.onpropertychange("currentItems",function(){
       this.updateView();
    })
      app.observer.on("notificationupdate", function (data) {
          if (app.notificationsView && app.notificationsView.el.isVisible()) {
              app.notificationsView.refreshView()
          }
      });


  },
   /**
    * Description
    * @method applyFilter
    * @param {} filter
    * @return 
    */
   applyFilter:function(filter){
       if(filter==this.filter){return}
       this.filter=filter;this.renderRows();
   },
  /**
   * Description
   * @method beforeRender
   * @return 
   */
  beforeRender:function(){
   this.el.html("<h2 class='blue_bar' style='text-align: left'>Notifications and Tasks<div class='notification-opts'>" +
       "<span class='filter'>Filter</span>" +
       "<span class='refresh'></span>" +
       "</div></h2>" +
       "<div class='fill-container notification-list'><ul class='notification-list-wrap'></ul></div>")
   this.$(".notification-opts .refresh").on("click",  this.refreshView.bind(this))
      this.$(".notification-opts .filter").on("click",  function(ev){
          var el=$d(ev.target),vw=this;
          if(!this._filterList) {
              this._filterList=PopupView.lookupList([{id: 100, label: "All"},{id: -2, label: "Assigned to me"}, {
                  id: 1,label: "Request for Premium Services" }, {id: 2, label: "Retrieve Car"}, {id: 3, label: "Park Car"}, {id: -1, label: "Other"}], {
                  minWidth: 200, destroyonhide:false,
/**
 * Description
 * @method callback
 * @param {} a
 * @return 
 */
callback: function (a) {
                      el.html(a.label)
                      vw.applyFilter(a.id);
                  }
              })
          }
          this._filterList.show()
      }.bind(this))

  },
  /**
   * Description
   * @method updateTrigger
   * @return 
   */
  updateTrigger:function(){
   if(this.currentItems && this.triggerCount){
    $d.html(this.triggerCount,this.currentItems.length||"")
       if(this.currentItems.length>9){$d.addClass(this.triggerCount,"shrink")}
       else {$d.removeClass(this.triggerCount,"shrink")}
       var d=$d(".garage-slot.notification .txt")
       if(d){d.html(String(this.currentItems.length))}
   }
  },
  /**
   * Description
   * @method updateView
   * @return 
   */
  updateView:function(){
   if(this.currentItems){
    this.updateTrigger()
       if(!this.notificationTypes) {
           if(!this._pending) {
               this._pending = true;
               var ths = this;
               app.getEntity("appnotificationtype").then(function (ent) {
                   var store = ent.createStore();
                   store.load().then(
                       function () {
                           ths.notificationTypes = store;
                           ths.renderRows()
                       }
                   )
               })
           }
            return;
       }
       this.renderRows()

   }
  },
  /**
   * Description
   * @method renderRows
   * @return 
   */
  renderRows:function(){
   var items=this.currentItems,facid=app.user.facility?app.user.facility.id: 0,cnt=0
   if(items){
    var actions=[["<div class='notification-act' data-key='1'>Accept</div>","<div class='notification-act' data-key='3'>Reject</div>","<div class='notification-act' data-key='100'>Assign</div>","<div class='notification-act' data-key='2'>Done</div>"],["<div class='notification-act' data-key='0'>Withdraw</div>","<div class='notification-act' data-key='2'>Done</div>"]]
   var vw=this;
    if(!this.el.q(".notification-list")){
     return
    }
       var notiStore=this.notificationTypes,filter=this.filter,uid=app.user.id;
       if(filter==100){filter=null;}
    this.el.q(".notification-list").html(
        "<ul class='notification-list-wrap'>"+

      items.map(function(it){var status_id=it.status_id||it.statusid|| 0,acts=actions[status_id]||[]
          if(filter) {
              if (filter > 0 && filter != it.type_id) {
                  return ""
              } else if(filter==-1 && (it.type_id==1 || it.type_id==2 || it.type_id==3)){return ""}
              else if(filter==-2 && (it.assigned_to!=uid)){return ""}
          }
          cnt++
        return ("<li data-typ='"+it.type_id+"' class='noti_item "+ ((notiStore.findById(it.type_id)||{}).istask?" ":"isnottask ")+
                (it.assigned_to?"assigned ":"") +"status-"+status_id+"' data-key='"+it.id+"' data-reserveid='"+it.reserve_id+"'>" +
                "<span class='noti-message'>"+it.msg+"</span>" +
                "<div class='notification-acts'>"+acts.join("")+"</div>" +
            "</li>");
      })
          .join("")
          .replace(/::([\w]+)\b/g,function(a,b){return "<span class='noti-reserve-link'>"+b+"</span>"})
          .replace(/date\(([\w\.]+)\)/,function(a,b){return $.date.format(Number(b.trim()),"mmm, dd yyyy hh:nn tt")}).trim()
          .replace(/,$/,"").trim()
        +"</ul>"
    );
       var ths=this;
       if(facid){
           app.getEntity("facility_staff").then(function (ent) {
               var store = ent.createStore();
               store.load( {criteria:"facility_id="+facid}).then(
                   function () {
                       ths.facilityStaffStore = store;
                   }
               )
           })
       }

    this.el.q(".notification-list-wrap").on("click",function(ev,el){
        var id=$d.up(el,"li").domdata("key"),reserveid=$d.up(el,"li").domdata("reserveid")
        if(!id||!reserveid){
            return
        }
        if(el.hasClass("noti-reserve-link")){
            var rec=app.remoteDirective("reserveinfo",{reserve_id:reserveid}).then(
                function(a){
                    var data= a.data||a;
                    data._isreserverecord=1
                    var model=new ReserveModel();
                    model.readRecord(data)
                    vw.cardView=ReserveCardView.show({
                        id: "notificationview",
                        showtimer: true,
                        showBarCode: false,
                        anchor: el,
                        record: model
                    });
                }
            )

            return
        }
     var nuid=$d.domdata(el,"key")
     if(nuid){

       var data={id:id,user_id:app.user.id}
         if(nuid=="100"){
             data.status_id=STATUS.ACCEPT
             if(!ths.facilityStaffStore){return}
             if(!ths.staffListView){
                 ths.staffListView=new PopupView({anchor:el,width:150,alignAnchor:"below",animateShow:"t",container:ths.el})
                 ths.staffListView.el.on("click.popup",function(ev,elli){
                     data.assigned_to=$d.domdata(elli,"key")
                      data.assigned_on= +(new Date())
                     app.remoteDirective("updatenotification",{ndata:data})
                 }.bind(this)   ,{selector:"li"})
             }
             ths.staffListView.config.options.anchor=el
             ths.staffListView.setContent(ths.facilityStaffStore.records.map(function(a){return "<li class='list-item' data-key='"+a.id +"'>"+a.firstname+" "+ (a.lastname||"")+"</li>"}).join(""))
             ths.staffListView.show()
             return;
         }

     data.status_id=nuid
       if(nuid=="1"){
         data.assigned_to=app.user.id
        data.assigned_on= +(new Date())
       }
         app.remoteDirective("updatenotification",{ndata:data})
      }

    },{selector:".notification-act,.noti-reserve-link"})
       this.$(".notification-opts .refresh").html( $.date().format("hh:nn tt")+"</br/>"+ cnt+" items")
   }
  },
  /**
   * Description
   * @method refreshView
   * @return 
   */
  refreshView:function(){
    var userid=app.user.id,
        facility_id=app.user.facility?app.user.facility.id:0
       var vw=this;
       app.remoteDirective("getnotifications",{assigned_to:userid,facility_id:facility_id}).then(
           function(data){if(!(data )){return}
               var items=data.items||data
               if(!(items && items.length)){return}
            vw.currentItems=items
           }
       )
  },
  /**
   * Description
   * @method toggleView
   * @return 
   */
  toggleView:function(){
   if(this.el.isVisible()){
     this.hide()
   } else{
     this.refreshView()
     this.show()

   }

  },
  /**
   * Description
   * @method hideImpl
   * @param {} anim
   * @param {} animconfig
   * @return 
   */
  hideImpl: function (anim,animconfig) {
      if(this.cardView && this.cardView.getEl && this.cardView.getEl() && this.cardView.getEl().isVisible(true)){
          this.cardView.hideView();
      }
      var actel=$d.util.getActiveElement();
      if(actel && (this.el.contains(actel) || $d.selfOrUp(actel,".filter-listbox"))){
           return;
      }
   if(this._dochandle){
     $d(document.body).off("mousedown", this._dochandle)
     this._dochandle=null
   }
   if(this.el.isVisible()){
    this.el.disAppear(
        function(){$d.hide(this.el)}
    )
   }

  },
  /**
   * Description
   * @method showImpl
   * @param {} anim
   * @param {} animconfig
   * @return 
   */
  showImpl: function (anim,animconfig) {
   if(this._dochandle){
     $d(document.body).off("mousedown", this._dochandle)
     this._dochandle=null
   }
   $d.show(this.el )
   var vw=this
   this.el.appear({anchor:"r",easing:"ease-out"} ,"fast",function(){
     $d(document.body).on("mousedown", vw._dochandle=function hndl(ev){
         if(vw.cardView && vw.cardView.getEl && vw.cardView.getEl() && vw.cardView.getEl().contains(ev.target)){
             return
         }
      if(vw.el.contains(ev.target) || $d(ev.target).selfOrUp(vw.triggerSelector)){return}
      if(vw.el.isVisible()){
        vw.hide();
      }
    } );
     $d.fillContainer(vw.el.q(".notification-list"))
   })
  },



 });











module.exports=AppnotificationsView
}
__bootstrap__.modules["common/Appstores"] = function(module){
var stores=  {} ,garageStorePromise,garagestorestatus=0;//0 - not loaded, 1 - needs refresh, 2 - resolved, 3 - pending

/**
 * Description
 * @method getGarageStore
 * @param {} onlyifpending
 * @param {} callback
 * @return garageStorePromise
 */
function getGarageStore(onlyifpending,callback){
    if(typeof(onlyifpending)=="function"){
        callback=onlyifpending
        onlyifpending=false
    }
    var locid=(app.location||{}).id||(app.user.facility||{}).location_id

    if(!locid || (garageStorePromise && garageStorePromise._locationid!=locid)){
        if(garagestorestatus==2){garageStorePromise=null;}
        garagestorestatus=1

    }

    if(!garageStorePromise) {
        garageStorePromise = Promise.deferred()

    }
    if(typeof(callback)=="function"){
        garageStorePromise.then(callback)
    }
    garageStorePromise._locationid=locid

    if(!locid){
        garagestorestatus=1;
        return garageStorePromise
    }

    if(garagestorestatus>=2 || (onlyifpending && garagestorestatus!=1)){
        return garageStorePromise
    }
    garagestorestatus=3;

        app.getEntity("facilitywithrates",null,{nocache:1}).then(
            function(ent){
                var garagemeta=typeof(metatemplates)!="undefined"?metatemplates.garagemeta:null
                if(garagemeta){
                    $.each(garagemeta,function(v,k){var prop=$.clone(v)
                        var f=(prop&&prop.name)?ent.findField(prop.name):null;
                        if(f){  delete prop.name;
                            f.updateProperties(prop);
                        }
                    })
                }
                ent.findField("name").ui.style={width:400,marginTop:"10px"};
                ent.findField("lat").ui.style={width:80}
                ent.findField("lng").ui.style={width:50}
                ent.findField("lng").ui.wrapklass="compressed"
                ent.findField("gstatus_id").ui.style={width:120}
                var provider=new Data.UrlProvider( app.servicePath+"?entity=facilitywithrates" )
                var garagesStore=new Data.store( ent,{ provider:provider})

                provider.store= garagesStore
                /**
                 * Description
                 * @method latlng
                 * @param {} rec
                 * @return LogicalExpression
                 */
                garagesStore.StoreRecordProto.latlng=function(rec){
                    if( !(rec.lat&&rec.lng)){return null}
                    return rec.__latlng||( rec.__latlng={lat:rec.lat,lng:rec.lng});
                }

                garagesStore.observer.once("dataloadcompleted",function(){

                    if(garageStorePromise){
                        garagestorestatus=2
                         garageStorePromise.resolve(garagesStore)
                    }
                })
                garagesStore.addExpr("picurl",function(rec){
                    if(rec.location_id==3){
                        return rec.asset_thumbs
                    }
                    return "http://parcmate.com/pmr/fi/"+rec.id+".png"
                    /* var url=rec.asset_thumbs
                    if(!url){return FACILITY_URL_DEFAULT}
                    url=String(url).replace(/^http:\/\//,"")
                    if(url.indexOf("s3")==0){return "http://"+url}
                    return FACILITY_URL_PREFIX+url*/
                },{vars:["asset_thumbs"]});

                 garagesStore.pager.pagesize=-1
                  garagesStore.defaultCriteria="location_id="+garageStorePromise._locationid
                 garagesStore.load(true) ;
                garagesStore.pager.isCachedLocal=true
            }
        );


    return garageStorePromise

}
/**
 * Description
 * @method getFacilityModel
 * @param {} facid
 * @param {} callback
 * @return CallExpression
 */
function getFacilityModel(facid,callback){
    if(typeof(facid)=="function"){callback=facid;facid=null}
    stores.pending||(stores.pending={});
    if(typeof(callback)!="function"){
        callback=function(){} }
    if(facid && stores.pending["facility:"+facid]){
        var pr1=stores.pending["facility:"+facid]
        pr1.then(callback)
        return pr1;
    }

     if(facid){
        var pr=Promise.deferred()
         stores.pending["facility:"+facid]=pr
        if(app.user1 &&  app.user.facility &&  app.user.facility.id==facid){
            var rec= $.clone(app.user.facility)
            pr.resolve(rec)
            callback(rec )
         }
        else{
            getGarageStore( ).then(function(id,fn,store){
                    var rec=store.findById(id);
                    pr.resolve(rec)
                    if(fn){fn(rec,store)}
                }.bind(this,facid,callback)
            )
        }

        return pr;
    }
    return  getGarageStore( callback  )
}
 /**
  * Description
  * @method getVehicleModel
  * @param {} vid
  * @param {} callback
  * @return ConditionalExpression
  */
 function getVehicleModel(vid,callback){
    if(typeof(vid)=="function"){callback=vid;vid=null}
    else{
        vid=Number(vid)||0
    }
     if(vid && app.userDetails && app.userDetails.usertype== 5){
         if(app.userDetails.vehicles){
             var veh=app.userDetails.vehicles.find(function(a){return a.id==vid})
             if(typeof(callback)=="function") {
                 callback(veh)
             }
             return veh
         }
     }
    var dorefresh= stores.refreshvehicles
     if(vid){
         stores.pending||(stores.pending={});
         if(stores.pending["vehicles"+vid]){
             if(typeof(callback)=="function"){
                 stores.pending["vehicles"+vid].then(callback)
             }
             return stores.pending["vehicles"+vid]
         }
         stores.pending["vehicles"+vid]=Promise.deferred()
     }
    if(!stores.vehicleStorePromise){
        dorefresh=true
        stores.vehicleStorePromise=Promise.deferred();
    }
    if(callback){
        if(!vid){
            stores.vehicleStorePromise.then(callback)
        }
        else {dorefresh=true
            stores.pending["vehicles"+vid].then(callback)
        }

    }

    if(!dorefresh && !vid){return stores.vehicleStorePromise}
    app.getEntity("vehicle").then(function(ent){
        var vehicle_color=ent.findField("vehicle_color")
        if(vehicle_color){
            /**
             * Description
             * @method reader
             * @param {} val
             * @return val
             */
            vehicle_color.reader=function(val){
                if($.Color && val){
                    var colorModel=$.Color.from(val)
                    if(colorModel){return colorModel.getColorName()||val}
                }
                return val;
            }
        }
        var vehicle_plate=ent.findField("vehicle_plate")
        if(vehicle_plate){
            /**
             * Description
             * @method reader
             * @param {} val
             * @return ConditionalExpression
             */
            vehicle_plate.reader=function(val){
                if(val==null){}
                return val==null?"":val;
            }
        }
        var vehicle_year=ent.findField("vehicle_year")
        if(vehicle_year){
            /**
             * Description
             * @method reader
             * @param {} val
             * @return ConditionalExpression
             */
            vehicle_year.reader=function(val){
                return val==null?"":val;
            }
        }
        var st=ent.createStore(),args={};
        if(vid) {
            args.id=vid
        } else {
            args.user_id=app.user.id
        }
        st.observer.once("dataloadcompleted",function(a){
            if(args.id && stores.pending["vehicles"+args.id]){
                var rec=st.findById(args.id)
                if(rec){
                    stores.pending["vehicles"+args.id].resolve(rec)
                }
                return
            }

            stores.vehicleStorePromise && stores.vehicleStorePromise.resolve(st);
            if(!st.size() || app.user.facility_id){
                stores.refreshvehicles=true
                stores.vehicleStorePromise=null;
            } else{
                stores.refreshvehicles=false
            }

        })
        st.load({includelookups:false,criteria:args,
/**
 * Description
 * @method callback
 * @return 
 */
callback:function(){ }})
    });
    return vid?stores.pending["vehicles"+vid]:stores.vehicleStorePromise
}
 /**
  * Description
  * @method getOperatorModel
  * @param {} id
  * @param {} callback
  * @return MemberExpression
  */
 function getOperatorModel(id,callback) {
    if(typeof(id)=="function"){callback=id;id=null}
    var dofetch=false
    if(!stores.operatorStorePromise){
        dofetch=true
        stores.operatorStorePromise=Promise.deferred();
    }
    if(typeof(callback)=="function"){
        if(!id){
            stores.operatorStorePromise.then(callback)
        }
        else {
            stores.operatorStorePromise.then(function(id,fn,store){
                fn(store.findById(id),store)
            }.bind(this,id,callback))
        }
    }

    if(!dofetch){return stores.operatorStorePromise}
    app.getEntity("operator").then(function (ent) {
        var st = ent.createStore();
        st.pager.pagesize = -1
        st.load(true).then(function () {
            stores.operatorStorePromise.resolve(st);
        })
    });
    return stores.operatorStorePromise
}
/**
 * Description
 * @method getUserModel
 * @param {} userid
 * @param {} callback
 * @return pr
 */
function getUserModel(userid,callback){
    if(!Number(userid) || !userid){return}
    stores.pending||(stores.pending={});
    var pr=stores.pending["user:"+userid],doload
    if(!pr){doload=true
        pr=Promise.deferred()
    }

    if(typeof(callback)=="function"){pr.then(callback)}
    if(!doload){return pr}

    var res
    if(stores.userStore && (res=stores.userStore.findById(userid))){
        pr.resolve(res)
        return pr
    }

    stores.pending["user:"+userid]=pr;
    app.getEntity("appuser").then(function(id,ent){
        if(!stores.userStore){
            stores.userStore=ent.createStore()
            stores.userStore.StoreRecordProto.addExpr("fullname","$firstname $lastname")
        }
        ent.getProvider().getRecord(id).then(function(r){
            if(!r  ){return}
            var rec=stores.userStore.addRecord(r)
            pr.resolve(rec)
        })
    }.bind(this,userid))
    return pr
}
/**
 * Description
 * @method getNonMemberUserModel
 * @param {} userid
 * @param {} callback
 * @return pr
 */
function getNonMemberUserModel(userid,callback){
    if(!Number(userid) || !userid){return}
    stores.pending||(stores.pending={});
    var pr=stores.pending["user_nonmember:"+userid],doload
    if(!pr){doload=true
        pr=Promise.deferred()
    }

    if(typeof(callback)=="function"){pr.then(callback)}
    if(!doload){return pr}

    var res
    if(stores.userStore_nonmember && (res=stores.userStore_nonmember.findById(userid))){
        pr.resolve(res)
        return pr
    }

    stores.pending["user_nonmember:"+userid]=pr;
    app.getEntity("appuser_nonmember").then(function(id,ent){
        if(!stores.userStore_nonmember){
            stores.userStore_nonmember=ent.createStore()
            stores.userStore_nonmember.StoreRecordProto.addExpr("fullname","$firstname $lastname")
        }
        ent.getProvider().getRecord(id).then(function(r){
            if(!r  ){return}
            var rec=stores.userStore_nonmember.addRecord(r)
            pr.resolve(rec)
        })
    }.bind(this,userid))
    return pr
}
var reservestore=null;
/**
 * Description
 * @method getReserveStore
 * @param {} callback
 * @param {} refresh
 * @param {} memberid
 * @return 
 */
function getReserveStore(callback,refresh,memberid){
    if(refresh===true){
        reservestore=null
    }
    if(reservestore){callback(reservestore);return reservestore}
    app.getEntity("facility_reserveusers").then(function(ent) {
        reservestore = ent.createStore()
        reservestore.pager.pagesize=-1
        reservestore.defaultCriteria = "resstatus < 99 and member_id=" + (memberid||app.user.id) +""
        reservestore.load(true).then(function () {
            callback(reservestore)
        })
    });
}
var extrastore=null;
/**
 * Description
 * @method getExtrasStore
 * @param {} callback
 * @return 
 */
function getExtrasStore(callback){

    if(extrastore){callback(extrastore);return extrastore}
    app.getEntity("facility_extras").then(function(ent) {
        extrastore = ent.createStore()
        callback(extrastore)

    });
}
var Appstores={
    getNonMemberUserModel:getNonMemberUserModel,
    getExtrasStore:getExtrasStore,
    getUserModel:getUserModel,
    getOperatorModel:getOperatorModel,
    getVehicleModel:getVehicleModel,
    getFacilityModel:getFacilityModel,
    getReserveStore:getReserveStore,
    getGarageStore:getGarageStore
}
module.exports=Appstores
}
__bootstrap__.modules["common/AppUtil"] = function(module){
var _confirmMessageVw,reservestore=null;
var dateformat="ddd, mmm dd yyyy",reservestore=null,  timeformat="hh:nn tt"
var statusStrings=null

var AppUtil={
    RESSTATUS: {
        CHECKEDIN: 2,
        RESERVED: 1,
        lATE: 3,

        NEEDSFOLLOWUP: 5,
        PAYMENTPENDING: 6,
        PAYMENTPROCESSED: 7,
        CHECKEDOUT: 99,
        COMPLETED: 100,
        CANCELLED: 500
    },
    states: {initial: 1, positioning: 2, loading: 3, ready: 5, dragging: 6, inactive: 7},
    dateformat:"ddd, mmm dd yyyy",reservestore:null,  timeformat:"hh:nn tt",datetimeformat:"ddd hh:nn tt",
    TESTGARAGE:45,
    vehicleStore:null,
    stateList : ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"],


    /**
     * Description
     * @method getLocation
     * @param {} showPosition
     * @return 
     */
    getLocation:function getLocation(showPosition) {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showPosition);
        } else {
        }
    },

    /**
     * Description
     * @method trimAddress
     * @param {} a0
     * @param {} loc
     * @return CallExpression
     */
    trimAddress:function _trimAddress(a0,loc){
        var zip,state,a=String(a0||"").trim()
        a= a.replace(/united states of america/i,"").replace(/\bUSA?\b/i,"")
            .replace(/\bavenue\b/i,"Ave.").replace(/\bstreet\b/i,"st.").replace(/,\s*,/g,",").replace(/,\s*,/g,",").replace(/^\s*,|,\s*$/g,"").trim()
        a=a.replace(/[\d\-]+$/,function(a){zip=a;return ""}).trim()
            .replace(/\b[a-z][a-z]$/i,function(a){state=a;return ""}).trim()
        if(loc&&loc.cityRe){
            a=a.replace(loc.cityRe,"")
        }
        a=a.replace(/Downtown Brooklyn/i,"").trim().replace(/,\s*(?:,|$)/mg,"").trim()
        if(loc.cityalias){
            loc.cityalias.forEach(function(al){
                a= a.replace(al,"")
            })
        }

        return a.trim().replace(/,$/,"").trim()
    },
    /**
     * Description
     * @method getReserveStore
     * @param {} callback
     * @return 
     */
    getReserveStore:function getReserveStore(callback){
        if(reservestore){callback(reservestore);return reservestore}
        app.getEntity("facility_reserveusers").then(function(ent) {
            reservestore = ent.createStore()
            reservestore.pager.pagesize=-1
            reservestore.defaultCriteria = "member_id=" + app.user.id +""
            reservestore.load().then(function () {
                callback(reservestore)
            })
        });
    }

}

/**
 * Description
 * @method getStatusString
 * @param {} id
 * @return MemberExpression
 */
AppUtil.getStatusString=function (id){
    if(!statusStrings){
        statusStrings=Object.keys(AppUtil.RESSTATUS).reduce(function(m,a){m[AppUtil.RESSTATUS[a]]=a;return m},{})
    }
    return statusStrings[id+""];
}


/**
 * Description
 * @method settitle
 * @param {} msg
 * @return 
 */
AppUtil.settitle=function settitle(msg) {
    var T=document.querySelector(".page-title");
    if(T){T.innerHTML = msg||""}
}
/**
 * Description
 * @method ensureVehicle
 * @param {} first
 * @param {} domel
 * @param {} propname
 * @param {} onchange
 * @return 
 */
AppUtil.ensureVehicle=function ensureVehicle(first,domel,propname,onchange){
    propname=propname||"userVehicle"
    var vel=this.el.q(domel),_self=this;
    var model=this.model,ths=this,vehmodel=model[propname];
    if(!vel || !vehmodel){return}
    if(!vehmodel.id || first){

        if(!app.isLoggedIn()){
            vel.addOptions([
                {id: "regular", label: "Regular"},
                {id: "oversize", label: "Oversize"}
            ]).val(this.model[propname].vehicle_type||"")
        }
        /**
         * Description
         * @method userrefresh
         * @param {} user
         * @return 
         */
        function userrefresh(user){
            var pri,_id=vehmodel.id
            if(_id){
                pri=user.vehicles.find(function (rec) {
                    return rec.id==_id
                })
            }
            if(!pri){
                pri = user.vehicles.find(function (rec) {
                        return rec.isprimary
                    }) || user.vehicles[0]
            }

            pri && vehmodel.readRecord(pri )
            if (vel) {
                vel.addOptions(user.vehicles.map(function (r) {
                    return {id: r.id, label: r.vehicle_label}
                }), true)

                pri && vel.val(pri.id)
            }
            _self.observer.fire("userdetails",user)
            //chkmulti.call(ths)

        }
        app.userDetails.whenAvailable( userrefresh)
        app.userDetails.observer.add("refresh",userrefresh)

    }
    var vw=this
    if(first && vel){
        vel.el.addEventListener("change", function () {
            if(!app.userDetails.id || this.value=="oversize" || this.value=="regular"){
                vehmodel.vehicle_type=  this.value
            } else{
                vehmodel.readRecord(app.userDetails.findVehicle(this.value))
            }

            onchange && onchange.call(vw)
        });
    }
}


module.exports=AppUtil
}
__bootstrap__.modules["common/BrowserGeoLocation"] = function(module){
var _onchange=null,_onchangeOnce=null,_emitter=null,
        _current=null;
 var geo_options = {
     enableHighAccuracy: false,
     maximumAge        : 30000,
     timeout           : 27000
 };
    if (navigator.geolocation) {
        /**
         * Description
         * @method success
         * @param {} pos
         * @return 
         */
        function success(pos){
            var userlocation=pos.coords.latitude+","+pos.coords.longitude
            var latlng = {lat:pos.coords.latitude,lng:pos.coords.longitude};
            if (!(latlng && latlng && latlng.lng && latlng.lat)) {
                 //typeof(_onchange)=="function" && _onchange(false,"invalid address");
                return
            }
             _current=latlng;
            _emitter && _emitter.dispatch("change",latlng)
            /*if(typeof(_onchangeOnce)=="function" ){
                _onchangeOnce(latlng)
                _onchangeOnce=null;
            }
            typeof(_onchange)=="function" && _onchange(latlng)*/
        }
        /**
         * Description
         * @method errorCallback
         * @param {} error
         * @return 
         */
        function errorCallback(error) {
            var message = "";
             // Check for known errors
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "This website does not have permission to use " +
                        "the Geolocation API";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "The current position could not be determined.";
                    break;
                case error.TIMEOUT:
                    message = "The current position could not be determined " +
                        "within the specified timeout period.";
                    break;
            }

            // If it is an unknown error, build a message that includes
            // information that helps identify the situation so that
            // the error handler can be updated.
            if (message == "")
            {
                var strErrorCode = (error.alertcode||{}).toString();
                message = "The position could not be determined due to " +
                    "an unknown error (Code: " + strErrorCode + ").";
            }
            _emitter && _emitter.dispatch("change","")
            /*if(typeof(_onchangeOnce)=="function" ){
                _onchangeOnce(false,message)
                _onchangeOnce=null;
            }
            typeof(_onchange)=="function" && _onchange(false,message);*/

        }
        navigator.geolocation.getCurrentPosition(success,errorCallback);
        navigator.geolocation.watchPosition(success,errorCallback,geo_options);
    }

var BrowserGeoLocation={
    /**
     * Description
     * @method onChange
     * @param {} fn
     * @param {} remove
     * @return 
     */
    onChange:function(fn,remove){
        if(!_emitter){
            _emitter= $.emitter.simpleObserver(BrowserGeoLocation)
        }
        _emitter.add("change",fn,remove==true?false:undefined)
        //_onchange=fn;
        if(_current && !remove){
            fn(_current)
        }
    },
    /**
     * Description
     * @method getCurrent
     * @param {} callback
     * @return _current
     */
    getCurrent:function(callback ){
        if(callback){
            if(!_current){
                if(!_emitter){
                    _emitter= $.emitter.simpleObserver(BrowserGeoLocation)
                }
                _emitter.add("change",callback,true)
                //_onchangeOnce=callback;
            } else{
                callback(_current)
            }
        }
        return _current
    }
}
module.exports=BrowserGeoLocation
}
__bootstrap__.modules["common/GarageFinder"] = function(module){
/**
 * Created by Atul on 5/2/2015.
 */
 var MAXDISTANCEALLOWED=1
var DISTANCESTRATEGY=1 //1 - as the crow flies , 2 - driving distance , 3 - walking distance

var GeoUtils=$.require("common/GeoUtils")
/**
 * Description
 * @method toRad
 * @param {} num
 * @return BinaryExpression
 */
function toRad (num) {
    return num * Math.PI / 180;
}
/**
 * Description
 * @method computeDistances
 * @param {} map
 * @param {} callback
 * @return promise
 */
function computeDistances(map,callback){
    var MQKEY="Fmjtd%7Cluu821u72d%2Cra%3Do5-942aq4";
    var MQURL="http://open.mapquestapi.com/directions/v2/routematrix?unit=m&doReverseGeocode=false&narrativeType=false&key="+MQKEY+"&json=";//appendjson

    var promise=(function(loclist){
        var pr=Promise.deferred();
        var list =loclist.slice()

        var q= loclist.map(function(l){
            return {latLng:{lat:String(l.latlng.lat),lng:String(l.latlng.lng)}}
        })
        var fn="fn"+Math.random().toString(36).substr(2)
        /**
         * Description
         * @method fn
         * @param {} data
         * @return 
         */
        window[fn]=function(data){
            scrpt.parentNode&&scrpt.parentNode.removeChild(scrpt);
            delete window[fn]
            if(data&&data.distance&&data.distance.length===list.length){
                data.distance.forEach(function(it,i){
                    list[i].distance=it
                    list[i].time=data.time[i]
                });
                pr.resolve(list)
                return
            }
            pr.reject();
        }
        var str="{locations:"+JSON.stringify(q)+",options:{allToAll:false}}"
        var url=MQURL+ str  +"&callback="+fn
        var scrpt=document.createElement("script")
        /**
         * Description
         * @method onerror
         * @param {} e
         * @return 
         */
        scrpt.onerror=function(e){
            scrpt.parentNode&&scrpt.parentNode.removeChild(scrpt);
            //delete self.__jsonp[nm]
            pr.reject(e)
        }
        document.head.appendChild(scrpt)
        scrpt.src=url
        return pr
    })(map);
    if(typeof(callback)=="function"){
        promise.then(callback);
    }
    return promise
}
/**
 * Description
 * @method distanceBetween
 * @param {} latlon1
 * @param {} latlon2
 * @return BinaryExpression
 */
function distanceBetween(latlon1,latlon2){
    var R = 6371; // km
    var dLat = toRad(latlon2.lat-latlon1.lat);
    var dLon = toRad(latlon2.lng-latlon1.lng);
    var lat1 = toRad(latlon1.lat);
    var lat2 = toRad(latlon2.lat);
    // var dx = myLatlng.longitude - marker.longitude;
    // var dy = myLatlng.latitude - marker.latitude;
    // var distance = Math.sqrt( dx * dx + dy * dy );
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}
    var GarageFinder=  Klass("GarageFinder",
    {
        significantRecords:null,anchorlatlng:null,facilityRecords:null,
        /**
         * Description
         * @method init
         * @return 
         */
        init:function(){
             var lasttime= 0,wrk,start=0

        },
        /**
         * Description
         * @method computeDistances
         * @param {} max
         * @param {} facilityRecords
         * @param {} callback
         * @return 
         */
        computeDistances:function( max,facilityRecords,callback){
             var arr=facilityRecords||this.facilityRecords

            GeoUtils.distancesFrom(this.anchorlatlng,arr,"latlng");
            var recs0=arr.slice(0,max )
            if(DISTANCESTRATEGY==1){
                //point to point distance
                var filtered=recs0.filter(function(a){return !MAXDISTANCEALLOWED || a.dist<MAXDISTANCEALLOWED});
                var res=filtered.map(function(a){a.distance=a.dist;return a})
                callback(res)
                return;
            }

            //use a geo service
              /*computeDistances([{id:100000,latlng:{lat:this.anchorlatlng.lat,lng:this.anchorlatlng.lng},target:1}].concat(recs0))
                .then(callback,
                function(a){callback(false,a);
                    $.handleEx(a)
                });*/
        },
        /**
         * Description
         * @method distanceFrom
         * @param {} from
         * @param {} rec
         * @return CallExpression
         */
        distanceFrom:function(from,rec){
            if(!(rec && rec.latlng)){return }
            return Math.abs( distanceBetween(from,rec.latlng))
        },
        /**
         * Description
         * @method collectStats
         * @param {} latlng
         * @param {} facrecs
         * @param {} success
         * @param {} failure
         * @return 
         */
        collectStats:function(latlng,facrecs,success,failure){
            if(!facrecs){
                alert("no records")
            }

            if(!(latlng && latlng.lat)){
                failure("No Latlng")
                return
            }
            /**
             * Description
             * @method resolveDistances
             * @param {} res
             * @return 
             */
            app.remoteDirective("computedistances", {origin: latlng.lat + "," + latlng.lng}).then(
                success,failure

            );

            return
        },
        /**
         * Description
         * @method takeNextBatch
         * @param {} count
         * @param {} callback
         * @return 
         */
        takeNextBatch:function(count,callback){
            if(this.significantRecords){
                callback([].splice.call(this.significantRecords,0,count))
            }

        },
        /**
         * Description
         * @method resolveLocations
         * @param {} records
         * @param {} computePrice
         * @param {} callback
         * @return 
         */
        resolveLocations:function(records,computePrice,callback){
             var closest,cheapest,best,ths=this
           var  map={},recs=records.slice();

             //all within one mile -- sorted by distance
            var mileone=recs.filter(function(it){return it.distance>=0&&it.distance<=1})
            var rates=[],ids=[]

            mileone.forEach(function(targetrec){
                targetrec.rate=computePrice(targetrec)
            })
            map.closest=mileone[0] //first is closest
            //lowest price with in one mile

            // sort by rate
            //if same rate then closest
            mileone.sort(function(a,b){
                var diff=a.rate - b.rate;
                if(!diff){//if same rate then closest
                    return a.distance - b.distance
                }
                return a.rate - b.rate
            })
            map.cheapest=mileone[0]
            //map.cheapest=$.A.min(mileone,"rate") ;
            //all within 1/4 mile
            var bestrecs=mileone.filter(function(it){return it.distance<.25})

            map.best=bestrecs[0]

            //lowest price with 1/4 mile
            if(!map.best){//if non best then closest
                map.best=map.closest
            }
            var tofilter=[map.closest,map.cheapest,map.best]
            if(map.closest){
                recs.filter(function(it){return tofilter.indexOf(it)>=0}).slice().forEach(function(a){
                    var i=recs.indexOf(a)
                    if(i>=0){recs.splice(i,1)}
                });
            }
            callback(map,recs)
            this.significantRecords=recs;
        }
    }

);

module.exports=GarageFinder
}
__bootstrap__.modules["common/GarageFinderbk"] = function(module){
/**
 * Created by Atul on 5/2/2015.
 */
 var MAXDISTANCEALLOWED=1
var DISTANCESTRATEGY=1 //1 - as the crow flies , 2 - driving distance , 3 - walking distance

var GeoUtils=$.require("common/GeoUtils")
/**
 * Description
 * @method toRad
 * @param {} num
 * @return BinaryExpression
 */
function toRad (num) {
    return num * Math.PI / 180;
}
/**
 * Description
 * @method computeDistances
 * @param {} map
 * @param {} callback
 * @return promise
 */
function computeDistances(map,callback){
    var MQKEY="Fmjtd%7Cluu821u72d%2Cra%3Do5-942aq4";
    var MQURL="http://open.mapquestapi.com/directions/v2/routematrix?unit=m&doReverseGeocode=false&narrativeType=false&key="+MQKEY+"&json=";//appendjson

    var promise=(function(loclist){
        var pr=Promise.deferred();
        var list =loclist.slice()

        var q= loclist.map(function(l){
            return {latLng:{lat:String(l.latlng.lat),lng:String(l.latlng.lng)}}
        })
        var fn="fn"+Math.random().toString(36).substr(2)
        /**
         * Description
         * @method fn
         * @param {} data
         * @return 
         */
        window[fn]=function(data){
            scrpt.parentNode&&scrpt.parentNode.removeChild(scrpt);
            delete window[fn]
            if(data&&data.distance&&data.distance.length===list.length){
                data.distance.forEach(function(it,i){
                    list[i].distance=it
                    list[i].time=data.time[i]
                });
                pr.resolve(list)
                return
            }
            pr.reject();
        }
        var str="{locations:"+JSON.stringify(q)+",options:{allToAll:false}}"
        var url=MQURL+ str  +"&callback="+fn
        var scrpt=document.createElement("script")
        /**
         * Description
         * @method onerror
         * @param {} e
         * @return 
         */
        scrpt.onerror=function(e){
            scrpt.parentNode&&scrpt.parentNode.removeChild(scrpt);
            //delete self.__jsonp[nm]
            pr.reject(e)
        }
        document.head.appendChild(scrpt)
        scrpt.src=url
        return pr
    })(map);
    if(typeof(callback)=="function"){
        promise.then(callback);
    }
    return promise
}
/**
 * Description
 * @method distanceBetween
 * @param {} latlon1
 * @param {} latlon2
 * @return BinaryExpression
 */
function distanceBetween(latlon1,latlon2){
    var R = 6371; // km
    var dLat = toRad(latlon2.lat-latlon1.lat);
    var dLon = toRad(latlon2.lng-latlon1.lng);
    var lat1 = toRad(latlon1.lat);
    var lat2 = toRad(latlon2.lat);
    // var dx = myLatlng.longitude - marker.longitude;
    // var dy = myLatlng.latitude - marker.latitude;
    // var distance = Math.sqrt( dx * dx + dy * dy );
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}
    var GarageFinder=  Klass("GarageFinder",
    {
        significantRecords:null,anchorlatlng:null,facilityRecords:null,
        /**
         * Description
         * @method init
         * @return 
         */
        init:function(){
             var lasttime= 0,wrk,start=0

        },
        /**
         * Description
         * @method computeDistances
         * @param {} max
         * @param {} facilityRecords
         * @param {} callback
         * @return 
         */
        computeDistances:function( max,facilityRecords,callback){
             var arr=facilityRecords||this.facilityRecords

            GeoUtils.distancesFrom(this.anchorlatlng,arr,"latlng");
            var recs0=arr.slice(0,max )
            if(DISTANCESTRATEGY==1){
                //point to point distance
                var filtered=recs0.filter(function(a){return !MAXDISTANCEALLOWED || a.dist<MAXDISTANCEALLOWED});
                var res=filtered.map(function(a){a.distance=a.dist;return a})
                callback(res)
                return;
            }

            //use a geo service
              /*computeDistances([{id:100000,latlng:{lat:this.anchorlatlng.lat,lng:this.anchorlatlng.lng},target:1}].concat(recs0))
                .then(callback,
                function(a){callback(false,a);
                    $.handleEx(a)
                });*/
        },
        /**
         * Description
         * @method distanceFrom
         * @param {} from
         * @param {} rec
         * @return CallExpression
         */
        distanceFrom:function(from,rec){
            if(!(rec && rec.latlng)){return }
            return Math.abs( distanceBetween(from,rec.latlng))
        },
        /**
         * Description
         * @method collectStats
         * @param {} latlng
         * @param {} facrecs
         * @param {} success
         * @param {} failure
         * @return 
         */
        collectStats:function(latlng,facrecs,success,failure){
            if(!facrecs){
                alert("no records")
            }

            if(latlng && latlng.lat){
                this.anchorlatlng=latlng;
            } else{latlng=null}
            var ths=this;
            if(!this.anchorlatlng){
                failure("No Latlng")

            }
            /**
             * Description
             * @method resolveDistances
             * @param {} res
             * @return 
             */
            function resolveDistances(res){
                if(!res ){
                    failure("invalid data");
                    return
                }

                res=res.data||res
                if(res.response){res=res.response}
                if(res.error){
                    failure("no garages found");
                    return
                }
                var recs= []
                res.forEach(function(it){
                    if(!(it&&it.id)||it.target){return}
                    var id=it.id
                    var f=facrecs.find( function(r){return r.id==id})
                    if(f){
                        var ds=Number(it.distance)||0,ds1=Number(it.walkdistance||it.distance)||0
                        if(ds){ds=Math.round(ds*100)/100}
                        if(ds1){ds1=Math.round(ds1*100)/100}
                        it.distance=ds||0;  it.walkdistance=ds1||0; it.time=it.time;
                        recs.push(it)
                    } });

                recs.sort(function(a,b){return a.distance- b.distance})
                success(recs);
            }

             this.computeDistances(35,facrecs,resolveDistances )


            return
        },
        /**
         * Description
         * @method takeNextBatch
         * @param {} count
         * @param {} callback
         * @return 
         */
        takeNextBatch:function(count,callback){
            if(this.significantRecords){
                callback([].splice.call(this.significantRecords,0,count))
            }

        },
        /**
         * Description
         * @method resolveLocations
         * @param {} records
         * @param {} computePrice
         * @param {} callback
         * @return 
         */
        resolveLocations:function(records,computePrice,callback){
             var closest,cheapest,best,ths=this
           var  map={},recs=records.slice();

             //all within one mile -- sorted by distance
            var mileone=recs.filter(function(it){return it.distance>=0&&it.distance<=1})
            var rates=[],ids=[]

            mileone.forEach(function(targetrec){
                targetrec.rate=computePrice(targetrec)
            })
            map.closest=mileone[0] //first is closest
            //lowest price with in one mile

            // sort by rate
            //if same rate then closest
            mileone.sort(function(a,b){
                var diff=a.rate - b.rate;
                if(!diff){//if same rate then closest
                    return a.distance - b.distance
                }
                return a.rate - b.rate
            })
            map.cheapest=mileone[0]
            //map.cheapest=$.A.min(mileone,"rate") ;
            //all within 1/4 mile
            var bestrecs=mileone.filter(function(it){return it.distance<.25})

            map.best=bestrecs[0]

            //lowest price with 1/4 mile
            if(!map.best){//if non best then closest
                map.best=map.closest
            }
            var tofilter=[map.closest,map.cheapest,map.best]
            if(map.closest){
                recs.filter(function(it){return tofilter.indexOf(it)>=0}).slice().forEach(function(a){
                    var i=recs.indexOf(a)
                    if(i>=0){recs.splice(i,1)}
                });
            }
            callback(map,recs)
            this.significantRecords=recs;
        }
    }

);
var GarageFinderbk=GarageFinder
module.exports=GarageFinderbk
}
__bootstrap__.modules["common/GeoLatLng"] = function(module){
/**
 * Created by Atul on 8/4/2015.
 */
var _converters={},_cache={ }
var GoogMap=$.require("common/GoogMap")
var AddressModel=$.require("models/AddressModel")
function _parse(){
	var first=arguments[0],latlng
	if(!first){return}
	if(first.__parsedlatlng__){return first}
	if(arguments[1] && !isNaN(first) && !isNaN(arguments[1])){
		latlng={lat:first,lng:arguments[1]}
	} else if(Array.isArray(first)){
		latlng={lat:first[0],lng:first[1]}
	} else if(typeof(first)=="object"){
		latlng={lat:typeof(first.lat)=="function"?first.lat():parseFloat(first.lat),lng:typeof(first.lng)=="function"?first.lng():parseFloat(first.lng)}
	} else if(typeof(first)=="string"){
		latlng=first.split(/[,\s]/g).map(function(a){return parseFloat(a.trim())})
	}
	if(typeof(latlng.lat)!="number"){latlng.lat=null}
	if(typeof(latlng.lng)!="number"){latlng.lng=null}
	if(latlng && latlng.lat && latlng.lng){
		latlng.__parsedlatlng__=true
	} else{
		return null
	}
	return latlng
}
function _toString(lat){
	if(!(lat && lat.lat && lat.lng)){return "invalid LatLng"}
	return lat.lat+" , "+lat.lng
}
/**
 * Description
 * @method GeoLatLng
 * @return 
 */
var GeoLatLng=function GeoLatLng(){
	Object.defineProperties(this,{
		__inner:{
			value:{lat:null,lng:null},writable:false,configurable:true,enumerable:false
		},
		"lat":{ 
/**
  * Description
  * @method get
  * @return MemberExpression
  */
 get:function(){ return this.__inner.lat },
			/**
			 * Description
			 * @method set
			 * @param {} v
			 * @return 
			 */
			set:function(v){
				alert(v+" not writable")
			}, configurable:true,enumerable:true},
		"lng":{ 
/**
  * Description
  * @method get
  * @return MemberExpression
  */
 get:function(){ return this.__inner.lng },
/**
 * Description
 * @method set
 * @param {} v
 * @return 
 */
set:function(v){
			alert(v+" not writable")
		}, configurable:true,enumerable:true},
		"latlng":{ 
/**
  * Description
  * @method get
  * @return CallExpression
  */
 get:function(){ return this.toMap()},
			/**
			 * Description
			 * @method set
			 * @param {} v
			 * @return 
			 */
			set:function(v){
				this.isValid() || this.parse(v);
			}, configurable:true,enumerable:true},

		"address":{ 
/**
  * Description
  * @method get
  * @return MemberExpression
  */
 get:function(){ return this.__inner.address },
			/**
			 * Description
			 * @method set
			 * @param {} v
			 * @return 
			 */
			set:function(v){
				if(!v){return}
				this.__inner.address=AddressModel.parse(v)

		}, configurable:true,enumerable:true}
	})
	this.parse.apply(this,arguments)
}
/**
 * Description
 * @method serialize
 * @return CallExpression
 */
GeoLatLng.prototype.serialize=function(){
	return [this.lat,this.lng,this.address.toMap()].join("|")
}
/**
 * Description
 * @method parse
 * @return 
 */
GeoLatLng.prototype.parse=function(){
	if(this.isValid()){
		alert("not writable")
		return
	}
	var latlng=_parse.apply(this,arguments)||{}
	this.__inner.lat=latlng.lat
	this.__inner.lng=latlng.lng

	if(this.isValid()){
		_cache[this.toString()]=this
		if(arguments[0] && arguments[0].address){
			this.address=arguments[0].address
		}
		else if(this._pending){
			this.resolveAddress()
		}

	}
}
/**
 * Description
 * @method valueOf
 * @return CallExpression
 */
GeoLatLng.prototype.valueOf=function(){
	return this.toString()
}
/**
 * Description
 * @method isSame
 * @param {} other
 * @return LogicalExpression
 */
GeoLatLng.prototype.isSame=function(other){
	if(!other || !this.isValid()){return}
	if(other===this){return true}
	if(other instanceof GeoLatLng){return this.toString()===other.toString()}
	var otherlt=_parse.apply(this,arguments)
	return (otherlt && otherlt.lat == this.lat && otherlt.lng == this.lng)
}
/**
 * Description
 * @method isValid
 * @return LogicalExpression
 */
GeoLatLng.prototype.isValid=function(){
	return this.lat && this.lng
}
/**
 * Description
 * @method toJSON
 * @return CallExpression
 */
GeoLatLng.prototype.toJSON=function() {
	return JSON.stringify(this.toMap())
}
/**
 * Description
 * @method toMap
 * @return ObjectExpression
 */
GeoLatLng.prototype.toMap=function() {
	return {lat:this.lat,lng:this.lng}
}
/**
 * Description
 * @method convertTo
 * @param {} key
 * @return CallExpression
 */
GeoLatLng.prototype.convertTo=function(key){
	if(key && _converters[String(key).toLowerCase()]){
		return _converters[String(key).toLowerCase()](this)
	}
	return this.toMap()
}
/**
 * Description
 * @method toString
 * @return CallExpression
 */
GeoLatLng.prototype.toString=function(){
	return _toString(this)
}
/**
 * Description
 * @method resolveAddress
 * @param {} callback
 * @return MemberExpression
 */
GeoLatLng.prototype.resolveAddress=function(callback){
	var latlng=this,callbacks=[]
	this.addressPromise=this.addressPromise||Promise.deferred()
	if(!this.isValid()){
		if(typeof(callback)=="function"){
			this._pending||(this._pending=[])
			this._pending.indexOf(callback)==-1 && this._pending.push(callback)
		}
		return
	}

	 if(this._pending){
		callbacks=this._pending.slice()
		this._pending=null;
	}
	if(typeof(callback)=="function"){
		callbacks.push(callback)
	}
	var pr=this.addressPromise
	if(pr){
		while(callbacks.length){
			pr.then(callbacks.shift())
		}
	}
	if(this.address){
		if(this._addresscallpending!==2){
			this.addressPromise.resolve(this.address)
		}
		this._addresscallpending=2;
 	}
	if(!this.isValid()){
		return
	}
	if(this._addresscallpending>=1){
		return
	}
	this._addresscallpending=1;
 	 var lt=this.convertTo()

	var optns = {}//{args: lt} //type: "app", cmd: "getaddress",
	optns.callback = function (  a,err) {
		if(err){console.log("resolveLocation",latlng,err)}

		if (a && a.data) { 	a = a.data }
		if (a && a.response) { a = a.response }
		if (a && a.data) { 	a = a.data }
		a=a||{}
 		var formattedaddress= a.formatted_address||"",parts={formattedaddress:formattedaddress,latlng:this.toMap()},addressparts=AddressModel.ADDRESSPARTS
		if (a && a.response) { a = a.response }
		if (a && a.address) { a = a.address}
		a=a||{}

		if(a.address_components){
			for(var i= 0,l=a.address_components,ln= l.length,compo;compo=l[i],i<ln;i++){
				if(compo && compo.types && compo.types.length && (compo.long_name||compo.short_name)){
					for(var i1= 0,l1=compo.types,ln1= l1.length,type;type=l1[i1],i1<ln1;i1++){
						if(type && addressparts[String(type).toLowerCase()]){
							parts[addressparts[String(type).toLowerCase()]]=compo.long_name||compo.short_name
						}
					}
				}


			}
		} else{
			$.each(a,function(val,key){
				if(key && addressparts[String(key).toLowerCase()]){
					parts[addressparts[String(key).toLowerCase()]]=val
				}
			})
 		}
		if(!Object.keys(parts).length){
			this._addresscallpending=0;
			return

		}
		var adressmodel=AddressModel.parse(parts)
		this.__inner.address=adressmodel
		this._addresscallpending=2;
		this.addressPromise && this.addressPromise.resolve(adressmodel)
	}.bind(this );
	if(GoogMap && GoogMap.latlngToAddressX){
		GoogMap.latlngToAddress(this.toMap(),optns.callback)
	}
	else{var lt=this.toMap();
		$.xhr.jsonp("http://api.geonames.org/findNearestAddressJSON?lat="+lt.lat+"&lng="+lt.lng+"&username=atulny",optns.callback,"callback")
	}
	//$.xhr.get(app.servicePath, optns)
 	return this.addressPromise;
}
/**
 * Description
 * @method addConverter
 * @param {} key
 * @param {} fn
 * @return AssignmentExpression
 */
GeoLatLng.addConverter=function(key,fn){
	return GeoLatLng._converters[key.toString().toLowerCase()]=fn
}
/**
 * Description
 * @method fromSerialized
 * @param {} str
 * @return nu
 */
GeoLatLng.fromSerialized=function(str){
	var parts=str.split("|")
	var nu=GeoLatLng.from(parts[0],parts[1])
	if(!nu.address){
		nu.__inner.address=nu.parts[2];
	}
	return nu
}
/**
 * Description
 * @method fromAddress
 * @param {} address
 * @param {} callback
 * @return 
 */
GeoLatLng.fromAddress=function(address,callback){
	var addressmodel=AddressModel.parse(address)
	if(addressmodel.formattedaddress){
		GoogMap.addressToLatLng(addressmodel.formattedaddress,function(a){
			callback(GeoLatLng.from(a))
		})
	}

}
/**
 * Description
 * @method from
 * @return CallExpression
 */
GeoLatLng.from=function(){
	var args=[].slice.call(arguments),usecached
	if(typeof(args[0])=="boolean"){usecached=args.shift()}
	var lat=args.shift(),lng=args.shift()
	if(lat && lat instanceof GeoLatLng){return lat}
	if(lat) {
		var address=lat?lat.address:null
		var latlng = _parse(lat, lng)
		if (latlng && latlng.lat && latlng.lng) {
			if (_cache[_toString(latlng)]) {
				return _cache[_toString(latlng)];
			}
			latlng.address = address
			return new GeoLatLng(latlng)
		}
	}
	return GeoLatLng.getEmpty()
}
var EMPTYCACHE=[]
/**
 * Description
 * @method cacheEmpty
 * @param {} empty
 * @return 
 */
GeoLatLng.cacheEmpty=function(empty){
	EMPTYCACHE.push(empty)
}
/**
 * Description
 * @method getEmpty
 * @return nu
 */
GeoLatLng.getEmpty=function(){
	if(EMPTYCACHE.length){return EMPTYCACHE.shift()}
	var nu=new GeoLatLng()
	return nu
}
module.exports=GeoLatLng
}
__bootstrap__.modules["common/GeoLocation"] = function(module){
/**
 * Created by Atul on 3/1/2015.
 */
var LocationAddress=$.require("common/LocationAddress")
var ScheduleModel=$.require("models/ScheduleModel")
var stores=$.require("common/Appstores")
var PriceModel=$.require("models/PriceModel")
var FacilityModel=$.require("models/FacilityModel")
var GeoLatLng=$.require("common/GeoLatLng")
var detailVwwrap='<div class="loc-vw loc-map-vw loc-map-vw-$type"> <div class="loc-vw-container"> </div></div>'
  var GeoLocation=$.model.make("GeoLocation", {
      shared_data:null,
        address: null,
        latlng:{ reader:function(v,curr){
                   var nu=GeoLatLng.from(v);
                  if(curr &&  curr!==nu && curr.pending && curr.pending.length ){
                      nu.pending=curr.pending;
                      curr.pending=null;
                  }
                  if(nu.pending){
                      nu.resolveAddress()
                  }

                  return nu
              }
          },
          ishidden:null,
      facility:null,
          schedule:null,
         pricing:null,
          locationid:null,popuptemplate:null,lastAnchorLatlng:null,path:null,
         isAnchorLocation:null,
         locKey:null,reservelabel:null,issecondary:null,locid:null,
         refid:null,typ:null,isadditional:null,locname:null,rate:null,operatorname:null,
         id:null,walkdistance:null,drivedistance:null,distance:null,type:null,dataView:null,notfound:null,
          walktime:null,drivetime:null,
         record:null,markerconfig:null,
         domEl:null,   marker:null, color :null,  label:null,markerDom:null,geoMap:null ,
         isTargetLocation:null,
         isvalid:true,popup:null ,info:null
    },
    {
        /**
         * Description
         * @method initModelInstance
         * @return 
         */
        initModelInstance: function() {
             var ths=this;
            this.info={}
            this.markerconfig||(this.markerconfig={})
            /*if(!this.schedule){
                this.schedule=new ScheduleModel()
            }*/
            if(!this.facility){
                this.facility=new FacilityModel()
            }
            if(!this.latlng){
                this.latlng=new GeoLatLng()
            }
            if(!this.pricing){
                this.pricing=new PriceModel()
             }
            if(this.locKey=="addtnl"){
                this.isadditional=true
            }
            if(this.locKey && !this.isadditional){
                this.label=String(this.locKey).charAt(0).toUpperCase()+String(this.locKey).substr(1)
            } else{this.label=""}
            if(this.label){
                this.reservelabel=this.label+" Option"
            } else{
                this.reservelabel="";
            }

            delete this.emitter;
            delete this.observer;
            this.observer=$.emitter.augment(this);
            this.onchange("record",function(rec){
                if(!rec.value){return}
                 this.readFacilityRecord(rec.value)
            });
            this.onchange("latlng",function(rec){
                if(rec.value && rec.value.isValid()){
                    this.address=rec.value.address
                    if(!this.ignoreUpdateUIonLatlng) {
                        this.updateUI()
                        if(this.isTargetLocation && this.geoMap && this.geoMap.centerOnNextLocation){
                            this.geoMap.updateView(true)
                        }
                    }

                    rec.value.resolveAddress(function(address){
                        if(!address){return}
                        this.address=address
                        address.recalcAll()

                    }.bind(this))
                }
             });
            if(this.latlng && this.latlng.isValid()){
                this.latlng.resolveAddress(function(address){
                    if(!address){return}
                    this.address= address
                        address.recalcAll()
                }.bind(this)
                )
            }
        },
        /**
         * Description
         * @method unblur
         * @return 
         */
        unblur:function(){
            this.marker && this.marker.unblur()
        },
        /**
         * Description
         * @method blur
         * @param {} opacity
         * @return 
         */
        blur:function(opacity){
            this.marker && this.marker.blur(Number(opacity))
        },
        /**
         * Description
         * @method readFacilityRecord
         * @param {} record
         * @return 
         */
        readFacilityRecord:function(record){
            this.facility.record=record
            this.locationid=record.id;
            var nulatlng
            if(record.lat && record.lng){
                nulatlng={lat:record.lat,lng:record.lng}
            }
            if(record.address){
                (nulatlng||this.latlng).address=record.address;
            }
            if(nulatlng){
                this.latlng=nulatlng
            }
            if(record.operator_id){
                if(record.operator && typeof(record.operator)=="string"){
                    this.operatorname=record.operator;
                }
                else{
                    stores.getOperatorModel( record.operator_id,function(rec){
                        this.operatorname=rec.name;
                    }.bind(this))
                }
             }
         },
        /**
         * Description
         * @method readRecord
         * @param {} data
         * @return ThisExpression
         */
        readRecord:function(data){if(!data){return}
            this.readDataRecord(data,["id"])
            if(data.id){this.locationid=data.id}

            if(data.lat && data.lng){
                //this.latlng=[data.lat ,data.lng]
                //if(data.address){this.latlng.address=data.address}
            }
            return this
        },
        /**
         * Description
         * The locKey is required, the labels and info should not be displayed if locKey is not specified.
         *
         * @method updateLabels
         * @param {} schedule
         * @param {} vehicle
         * @return ThisExpression
         */
        updateLabels:function(schedule,vehicle){
            if(this.ishidden || !this.locKey){
                 return this;
            }
            var geolocation=this
            var rate="",domEl= this.domEl
            schedule=schedule||(this.geoMap.sharedLocationData||{}).schedule;
            vehicle=vehicle||(this.geoMap.sharedLocationData||{}).vehicle;
            if(schedule && schedule.reserveDateTime){
                 rate=this.getIconContent(schedule,vehicle)
            }

            if(this.facility && this.facility.id && domEl){
                if(!this.pricing.shared_data){
                    this.pricing.set("shared_data",this.geoMap.sharedLocationData)
                }

                this.pricing.facility=this.facility;
                this.pricing.recalcAll()
                if(Number(this.facility.rating)>0){
                    this.facility.set("starrating",Math.round(Number(this.facility.rating)));

                } else{
                    this.facility.set("starrating",0);
                }
                domEl.show()
                if(!geolocation.dataView){
                    geolocation.dataView=$.dataview(app.getResource("map_selection_detail"))
                }
                var wrpel=domEl.q(".loc-vw-container")
                    if(!wrpel){
                        domEl.html(detailVwwrap.replace(/\$type/,geolocation.locKey))
                        wrpel=domEl.q(".loc-vw-container")
                    }
if(!this.facility.operator){
    this.facility.operator="&nbsp;"
}
                     this.dataView.rerender(this ,wrpel )
                var rating=wrpel.q(".facility-rating-wrap");
                if(rating) {
                    rating.style.display = this.facility.starrating ? "" : "none"
                }
                     domEl.on("click.locationselected",function(){
                        if(this.ishidden){return}
                        //geolocation.geoMap.fire("locationselected",geolocation);
                        this.fire("locationselected");
                    }.bind(this));
              }
            if(rate && this.marker){
                 this.marker.updateUI(this.latlng?this.latlng.toMap():null,rate)
            }
            return this;
        },
        _updateUI:function(schedule,vehicle){
            if(!this.locKey && this.isTargetLocation){
                this.locKey="target"
            }
            if(!(this.geoMap && this.geoMap.container && this.geoMap.container.isVisible(true) && (this.locKey) && this.latlng.isValid())){
                 return
            }
            this.show()
            this.addMarker( );
            this.updateLabels(schedule,vehicle)
        },
        /**
         * Description
         * @method updateUI
         * @param {} schedule
         * @param {} vehicle
         * @return 
         */
        updateUI:function(schedule,vehicle){
            if(!this.updateUIthrottled){
                this.updateUIthrottled=$.throttle(this._updateUI.bind(this),{delay:500,tailEnd:true})
            }
            if(!(this.geoMap && this.geoMap.container && this.geoMap.container.isVisible(true) && this.latlng && this.latlng.isValid())){console.log("hidden2")
                return
            }
            this.pricing.setItem("shared_data",this.geoMap.sharedLocationData)
            this.updateUIthrottled(schedule,vehicle)
        },
        /**
         * Description
         * @method computePrice
         * @param {} schedule
         * @param {} vehicle
         * @return CallExpression
         */
        computePrice:function(schedule,vehicle){
            return this.pricing.computeRate(schedule,this.facility,vehicle)
        },

        /**
         * Description
         * @method getIconContent
         * @param {} newcontentData
         * @param {} vehicle
         * @return BinaryExpression
         */
        getIconContent:function( newcontentData,vehicle){
            if(!newcontentData || this.isAnchorLocation || this.isTargetLocation){return null}
            var rate =this.computePrice(newcontentData,vehicle)//this.computeRate(contentData.reserveDate,contentData.duration,contentData.durationType)
            if(!rate){return null}
            if(Number(rate)>0){rate=Math.round(+rate)}
            return "$" + String(rate||"")
        },
        /**
         * @method clearUI
         * Description
         * removes the marker and popup. Also hides the detail domel.
         * sets the locKey to blank to ensure that its not rendered.
         * @return 
         */
        clearUI:function(removedom){
            if(this.marker){
                this.marker.remove && this.marker.remove();
                this.marker=null;
            }
            this.locKey="";
            if(this.domEl){
                if(removedom===true){
                    $d.remove(this.domEl)
                    this.domEl=null;
                } else{
                    $d.hide(this.domEl)
                }

            }
            if(this.path){
                this.geoMap.clearPath(this);
            }
            this.latlng=GeoLatLng.getEmpty()
        },
         /**
          * Description
          * @method showMessage
          * @param {} msg
          * @return 
          */
         showMessage:function(msg){


        },
        /**
         * Description
         * @method showLoadMessage
         * @return 
         */
        showLoadMessage:function(){
            if(!this.domEl){return}
            var m=this.domEl.q(".load-msg")||this.domEl.append("Z!div.load-msg>label{working...}")
            m.show()
            setTimeout(function(){
                if(this.domEl && this.domEl.q(".load-msg")&&$d.isVisible(this.domEl.q(".load-msg label"))){
                    this.domEl.q(".load-msg label").html(this.notfound===true?"Not found":"Searching...")}
            }.bind(this),1000)
            setTimeout(function(){
                if(this.domEl && this.domEl.q(".load-msg")&&$d.isVisible(this.domEl.q(".load-msg label"))){
                    this.domEl.q(".load-msg label").html(this.notfound===true?"Not found":"Checking...")}
            }.bind(this),2000)
        },
        /**
         * Description
         * @method hide
         * @param {} showmsg
         * @return ThisExpression
         */
        hide:function(showmsg){
            if(this.domEl){
                this.domEl.show().qq(".loc-vw-container").css({opacity:.1})
                showmsg && this.showLoadMessage();
            }
            this.ishidden=true
            this.marker && this.marker.hide && this.marker.hide();
            return this
        },
        /**
         * Description
         * @method show
         * @param {} latlng
         * @return ThisExpression
         */
        show:function(latlng){
             //this.domEl.css({opacity:1})//.appear("c",100);
            // app.rootView.MembersVw.reserveview.show()
            this.ishidden=false
            if(this.domEl) {
                this.domEl.show().qq(".loc-vw-container").css({opacity: 1})
                this.domEl.qq(".load-msg").hide()
            }
            //this.marker && this.marker.show && this.marker.show();
            return this;
         },

        /**
         * Description
         * @method addMarker
         * @param {} markerconfig
         * @return ThisExpression
         */
        addMarker:function(markerconfig){
            if(this.geoMap && this.geoMap.container && this.geoMap.container.isVisible(true) && this.latlng && this.latlng.isValid()){
                this.markerconfig||(this.markerconfig={});
                $.extend(this.markerconfig,markerconfig||{})

                var latlng=this.latlng.toMap()
                if(this.isTargetLocation){
                    if(this.marker && this.marker.getPosition && this.latlng.isSame(this.marker.getPosition())){

                    } else{
                        //this.marker && this.marker.remove();
                        //this.marker=null;
                    }

                }
                if(latlng && latlng.lat) {
                    if ( this.marker && this._savedlatlng && !(this._savedlatlng.lat == latlng.lat && this._savedlatlng.lng == latlng.lng)) {
                        if(!this.markerconfig.animatemove) {
                            this.marker && this.marker.remove && this.marker.remove();
                            this.marker = null;
                        }
                    }
                    this._savedlatlng = latlng
                    if (!this.marker) {
                        if (!this.color && this.domEl && this.domEl.q(".loc-map-vw")) {
                            this.color = this.domEl.q(".loc-map-vw").css("backgroundColor")
                        }
                        var config = {
                            latlng: latlng,
                            content: "",
                            locKey: (this.isAnchorLocation || this.isTargetLocation) ? "target" : this.locKey,
                            noanimation: this.markerconfig.noanimation
                        };
                        if (!config.imgurl) {
                            config.imgurl = app.appassetsPath + 'facility-' + (config.locKey || "addtnl") + '-icon.png'
                        }
                        if (!this.markerconfig.showPopup && this.popupTemplate) {
                            this.markerconfig.showPopup = true;
                        }
                        if (this.markerconfig.draggable) {
                            config.ondragend = function (ev) {
                                var latlng = ev.latLng || ev.latlng
                                this.observer.fire("aftermove", latlng)
                            }.bind(this)
                        } else {
                            if (this.markerconfig.renderDirections || this.markerconfig.showPopup) {
                                config.onclick = function (ev) {
                                    this.markerconfig.renderDirections && this.drawPath();
                                    this.showPopup({
                                        marker: this.marker,
                                        onclick: function (ev) {
                                            var el = $d.selfOrUp(ev.target, ".item-wrap")
                                            if (!el || this.ishidden) {
                                                return
                                            }
                                            var sel, id = el.domdata("key")
                                            if (id) {
                                                sel = this.geoMap.locations.find(function (a) {
                                                    return a.facility && a.facility.id == id
                                                });
                                            }
                                            sel && sel.fire("locationselected", sel);
                                        }.bind(this)
                                    })

                                }.bind(this)
                            }
                        }
                        this._savedConfig=config
                        this.marker = this.geoMap.addMarker(config);

                    }
                    if(this.markerconfig.animatemove && this.marker.animateTo){
                        this.marker.animateTo(latlng)
                     }
                    //this.marker && this.updateMarker();

                    this.marker && this.marker.updateUI && this.marker.updateUI(latlng, (markerconfig || {}).content || "?");
                }
            }

            return this;

        },
        /**
         * Description
         * @method showPopup
         * @param {} config
         * @return 
         */
        showPopup:function(config ){
            //this.geoMap.addMarker(config);
            if(this.popupTemplate){
                if(typeof(this.popupTemplate)=="string"){
                    this.popupTemplateFn= $.template(this.popupTemplate)
                } else if(typeof(this.geoLocation.popupTemplate)=="function"){
                    this.popupTemplateFn= this.popupTemplate
                }
                //this.showPopup()
                this.marker && this.marker.showPopUp && this.marker.showPopUp( this.popupTemplateFn(this),config);
            }

            return;


        },
/**
 * Description
 * @method drawPath
 * @return 
 */
drawPath:function(){
            if(this.geoMap && this.geoMap.targetLocation && this.geoMap.targetLocation.latlng && this.geoMap.impl){
                //this.geoMap.impl.renderDirections(this.geoMap.targetLocation.latlng.toMap(), this.latlng.toMap(), this.color||"gray");
                var address=this.geoMap.targetLocation.facility.address||this.geoMap.targetLocation.latlng.toMap(),
                    address2=this.facility.address||this.latlng.toMap()

                this.geoMap.impl.renderDirections(address, address2, this.color||"gray");
            }
            return
        }

    }
);


module.exports=GeoLocation
}
__bootstrap__.modules["common/GeoMap"] = function(module){
var GeoLocation=$.require("common/GeoLocation")
var GoogMap=$.require("common/GoogMap")
var DEFAULTLATLNG={lat:40.748817,lng:-73.985428}
/**
 * Description
 * @method Que
 * @param {} callback
 * @param {} onend
 * @param {} batch
 * @return nu
 */
function Que(callback,onend,batch){
    var nu=[]
    nu._callback=callback
    if(typeof(onend)=="number"){
        nu._batch=onend
    } else if(typeof(onend)=="function"){
        nu._onend=onend
    }
    if(typeof(batch)=="number"){
        nu._batch=batch
    }
    /**
     * Description
     * @method add
     * @param {} list
     * @return ThisExpression
     */
    nu.add=function(list ){
        if(Array.isArray(list)){
            [].push.apply(this,list)
        } else{
            this.push(list)
        }

        return this
    }
    /**
     * Description
     * @method start
     * @return ThisExpression
     */
    nu.start=function(){
        this._stopped=null;
        this.next();
        return this
    }
    /**
     * Description
     * @method next
     * @return 
     */
    nu.next=function(){
        this._timer=0
        if(this._stopped||!this.length){
            if(this._onend){this._onend()}
            return
        }

        var nxt;
        if(this._batch){
            nxt=this.splice(0,this._batch)
            if(!nxt.length){nxt=null}
        } else{
            nxt=this.shift()
        }
        if(nxt){
            this._callback(nxt,this)
        }
        if(this.length){
            this._timer=setTimeout(this.next.bind(this),0);
        } else{
            if(this._onend){this._onend()}
        }
    }
    /**
     * Description
     * @method stop
     * @return ThisExpression
     */
    nu.stop=function(){
        if(this._timer){clearTimeout(this._timer);this._timer=0}
        this._stopped=true;
        this.length=0;
        return this
    }
    return nu
};

var GeoMap=Klass("GeoMap", {
    impl:null,container:null, latlng:{
/**
 * Description
 * @method comparator
 * @param {} a
 * @param {} b
 * @return BinaryExpression
 */
comparator:function(a,b){
        if(a==b){return 0}
        if(b==null){return 1}
        if(a==null){return -1}
        return ((a.lat||0)*(a.lng||0)) - ((b.lat||0)*(b.lng||0))
    }
    },
    zoomLevel:null,
    loader:null,locations:null,targetLocation:null,isready:null,showAll:null,
    visibleAdditionalLocations:null,mapConfig:null,
    /**
     * Description
     * @method init
     * @return 
     */
    init:function(){
        var ths=this;
        this.sharedLocationData={}
         this.mapConfig=this.mapConfig||{}
        this.locations= List.from( []).chainable(new GeoLocation(null));
        this.visibleAdditionalLocations=[];
         if(this.targetLocation){
            this.setTargetLocation(this.targetLocation)
        }
        this.getTargetLocation().onchange("latlng",function(rec){
           if(!(rec && rec.value&& rec.value.isValid())){return}
            ths.setup()
        });

        $.viewport.on(
            function(){
                if(this.container && this.container.isVisible(true)){
                    this.forceRedraw();
                }
            }.bind(this)
        )

     },
    /**
     * Description
     * @method calculateDistances
     * @param {} list
     * @param {} callback
     * @return 
     */
    calculateDistances:function(list,callback){
      //if(this._calculating){return}
       // this._calculating=true;
        list=list||this.locations
      var src=this.targetLocation.latlng.toMap(),res=[]
        var promises=[Promise.deferred(),Promise.deferred()]
        var allPromise=Promise.all(promises)
      var destinations= list.map(function(a){
          if(a.facility && a.facility.address){
              return a.facility.address
          }
          if(a.latlng){return {lat: a.latlng.lat,lng: a.latlng.lng}}
          return {lat: a.lat,lng: a.lng}
      })
        destinations.forEach(function(a,i){res[i]={d:a}})
        GoogMap.calculateDistances(src,destinations,"DRIVING",function(a){
            a && a.forEach(function(data,i){
                list[i]||(list[i]={});
                if(data && data.distance){
                    list[i].drivedistance= data.distance
                    list[i].drivetime= data.duration
                }

            });
            promises[0].resolve()
        });
        GoogMap.calculateDistances(src,destinations,"WALKING",function(a){
            a && a.forEach(function(data,i){
                list[i]||(list[i]={});
                if(data && data.distance){
                    list[i].walkdistance= data.distance
                    list[i].walktime= data.duration
                }
            });
            promises[1].resolve()

        });
        allPromise.then(function () {
            callback(list);
        })
    },
    /**
     * Description
     * @method toggleLoader
     * @param {} show
     * @return 
     */
    toggleLoader:function(show){return
        if(!this.loader && this.container){
            this.loader=$d(this.container).append("<div class='fxtx map-loading-wrap'><div class='map-loading'><div class='bubblingG'><span class='bubble-closest' id='bubblingG_1'></span><span class='bubble-cheapest' id='bubblingG_2'></span><span class='bubble-best' id='bubblingG_3'></span></div></div></div>");
            this.loader.toFront().show()
            this.loader.on("mousedown",function(ev){ev.stopPropagation()})
        }
        if(!this.loader){return}
         if(show==null){show=!this.loader.isVisible()}
        if(show){this.loader.show()

            this.locations.hide(true)
        }
        else{this.loader.hide()
            this.locations.show()
        }
    },

    /**
     * Description
     * @method distanceFrom
     * @param {} latlng
     * @return 
     */
    distanceFrom:function(latlng){
         alert("distanceFrom")
    },
    /**
     * Description
     * @method clearPath
     * @param {} loc
     * @return ThisExpression
     */
    clearPath: function(loc){return
         if(!(loc && loc.path)){return}
        try {
            this.impl.removeLayer(loc.path)
            loc.path=null;
        } catch(e){
         }
        return this
    },
    /**
     * Description
     * @method addMarker
     * @param {} data
     * @return 
     */
    addMarker:function(data){
        if(!this.impl ){return}
        if(typeof(this.impl.marker)=="function"){
            return this.impl.marker(data)
        }
     },
    /**
     * Description
     * @method addPopup
     * @param {} data
     * @return 
     */
    addPopup:function(data){
        if(!this.impl ){return}
        if(typeof(this.impl.popup)=="function"){
            return this.impl.popup(data.content,{marker:this.data.marker,latlng:data.latlng})
        }
     },


    /**
     * Description
     * @method closePopup
     * @param {} popup
     * @return 
     */
    closePopup:function(popup){
        this.impl && this.impl.closePopup(popup)
    },
    /**
     * Description
     * @method forceRedraw
     * @param {} noview
     * @return 
     */
    forceRedraw:function(noview){
         if(this.impl && this.impl.invalidateSize){this.impl.invalidateSize(false)}
        noview||this.updateView(true);
    },
    /**
     * Description
     * @method setTargetLocation
     * @param {} loc
     * @return MemberExpression
     */
    setTargetLocation:function( loc){
        this.targetLocation=loc
        this.targetLocation.isAnchorLocation=this.targetLocation.isTargetLocation=true;
        this.targetLocation.geoMap = this

        return this.targetLocation
    },
    /**
     * Description
     * @method getTargetLocation
     * @param {} config
     * @return MemberExpression
     */
    getTargetLocation:function( config){
        if(!this.targetLocation) {
            this.setTargetLocation(new GeoLocation(config))
        }
        return this.targetLocation;
    },
    /**
     * Description
     * @method removeAdditional
     * @return 
     */
    removeAdditional:function(){
        var torem=[]
        this.locations.each(function(l){
            if(l.isadditional ==true && !l.issecondary){
                l.clearUI();
                l.marker && l.marker.setMap && l.marker.setMap(null);
                torem.push(l)
            }

        });
         while(torem.length){
            this.locations.remove(torem.shift())
        }

    },
    /**
     * Description
     * @method addAddtnlLocation
     * @param {} config
     * @return nu
     */
    addAddtnlLocation:function(config){
        var nu=new GeoLocation(config)
        nu.geoMap=this
         return nu;
    },
    /**
     * Description
     * @method addLocation
     * @param {} config
     * @return nu
     */
    addLocation:function(config){
        var nu=new GeoLocation(config)
        nu.geoMap=this
        nu.observer.on("locationselected", function(){
            this.geoMap.fire("locationselected",this)
        })
         this.locations.add(nu)
        return nu;
    },
    /**
     * Description
     * @method panBy
     * @param {} pt
     * @return ThisExpression
     */
    panBy:function(pt){this.impl.panBy(pt);return this;},
    /**
     * Description
     * @method zoomIn
     * @param {} z
     * @return ThisExpression
     */
    zoomIn:function(z){ this.impl && this.impl.zoomIn.apply(this.impl,arguments);return this;},
    /**
     * Description
     * @method zoomOut
     * @param {} z
     * @return ThisExpression
     */
    zoomOut:function(z){ this.impl && this.impl.zoomOut.apply(this.impl,arguments);return this;},
    /**
     * Description
     * @method setZoom
     * @param {} z
     * @return ThisExpression
     */
    setZoom:function(z){ this.impl && this.impl.setZoom.apply(this.impl,arguments);
        this.zoomLevel=z;
        return this;
    },
    /**
     * Description
     * @method getZoom
     * @return LogicalExpression
     */
    getZoom:function(){ return this.impl && this.impl.getZoom()},
    /**
     * Description
     * @method setZoomAround
     * @return LogicalExpression
     */
    setZoomAround:function(){ return this.impl && this.impl.setZoomAround.apply(this.impl,arguments)},
    /**
     * Description
     * @method mouseEventToLatLng
     * @param {} ev
     * @return LogicalExpression
     */
    mouseEventToLatLng:function(ev){
        return  this.impl && this.impl.mouseEventToLatLng(ev.originalEvent||ev)
    },
    /**
     * Description
     * @method latLngToPoint
     * @param {} latlng
     * @return LogicalExpression
     */
    latLngToPoint:function(latlng){
        return  this.impl && this.impl.latLngToContainerPoint(latlng||this.getTargetLocation().latlng)
    },
    /**
     * Description
     * @method pointToLatLng
     * @param {} pt
     * @return LogicalExpression
     */
    pointToLatLng:function(pt){
        return  this.impl && this.impl.containerPointToLatLng(pt)
    },
    /**
     * Description
     * @method containerPointToLayerPoint
     * @param {} pos
     * @return LogicalExpression
     */
    containerPointToLayerPoint:function(pos){
        return  this.impl && this.impl.containerPointToLayerPoint(pos)
    },
    /**
     * Description
     * @method getContentBounds
     * @return bounds
     */
    getContentBounds:function(){
        if(!this.container){return}
        var paths=this.container.qq(".map-labels").filter(function(a){return a.offsetHeight>10 })
        if(paths.length<=2){return}
        var bounds = UI.Rect.mergeBounds(paths.map(function(a){
            var b=a.bounds()
            if(b.height>100){b.height=50;b.bottom= b.top+ b.height}

            return b}))
        var cont=this.container.bounds()

       bounds.relativeTo(cont)
        return bounds
    },
    /**
     * Description
     * @method getLatLngBounds
     * @param {} bounds
     * @return LogicalExpression
     */
    getLatLngBounds:function(bounds){
        var ltbounds = []
        ltbounds[0] = this.pointToLatLng([bounds.left, bounds.bottom])
        ltbounds[1] = this.pointToLatLng([bounds.right, bounds.top])
        if(!ltbounds[0] || !ltbounds[1]){return}
        if(this.impl.getLatLngBounds){
            return this.impl.getLatLngBounds(ltbounds)
        }
        return this.implapi && this.implapi.latLngBounds(ltbounds);
    },
    /**
     * Description
     * @method checkReadyState
     * @param {} noreset
     * @return 
     */
    checkReadyState:function(noreset){
        var ths=this;

        if(!ths.impl){return}
        if(this.getTargetLocation().latlng){
             if(!ths.isready){
                ths.isready=true;
                ths.fire("ready")
            }
            if(!noreset){ths.fire("viewreset")}
        }
        else{
            if(ths.isready==null){ths.isready=false}
        }
    },
    /**
     * Description
     * @method setup
     * @return 
     */
    setup:function(){
        if(this.busy||this.impl){
            if(this.impl && this.getTargetLocation().latlng){
                this.updateView();
            }
           return
        }

        var  loc=this.getTargetLocation().latlng
         var ths=this;
       // this.busy=true;
        if(!ths.container || !$d.isVisible(ths.container,true)){
             return
        }

        if( ths.container.height()<50|| ths.container.width()<100){
             setTimeout(function(){
                ths.busy=0;
                ths.setup()
            },500)
             return;
        }
        this.busy=1;
         //$d(this.container).css({width:9,height:0})
        if(!(loc && loc.isValid())){
             loc={lat:app.location.lat,lng:app.location.lng}
            this.toggleLoader(true)
        }
        var mapConfig=this.mapConfig||{}
        mapConfig.zoom=mapConfig.zoom||16
        mapConfig.onclick=function(ev){
            this.fire("click",ev);
        }.bind(this)
        var googMap=new GoogMap($d(this.container).el, loc,mapConfig);
        this.impl =googMap;
        googMap.addListener('zoom_changed', function() {
            this.zoomLevel=this.getZoom();
        }.bind(this));
        this.checkReadyState(true)
        if(!this.isready){
            setTimeout(this.checkReadyState.bind(this,true),500)
        }

    },
    /**
     * Description
     * @method updateRates
     * @param {} newcontentData
     * @param {} vehicle
     * @return 
     */
    updateRates:function(newcontentData,vehicle){
        if(newcontentData && newcontentData.reserveTime){
            this.sharedLocationData.schedule=newcontentData
        }
        vehicle && (this.sharedLocationData.vehicle=vehicle)
        this.locations.each(
            function(l){l && l.updateLabels(newcontentData,vehicle)}
        )
    },

    /**
     * Description
     * @method showAllInBound
     * @param {} facilityRecords
      * @return
     */
    showAllInBound : function( facilityRecords ){
        if(!this.isready){this.checkReadyState(true)}
        if(!(this.impl && this.isready && this.targetLocation && this.container)){
            return
        }
        if(!this._boundchangehandle){
            this.impl.onBoundsChange(this._boundchangehandle= $.throttle(this.showAllInBound.bind(this),{tailEnd:true,delay:500}))
        }
        if(this.showAll){
            if(facilityRecords){
                this._facilityRecords=facilityRecords;
            }
             if(!this._que){
                this._que=  Que(function(batch,q){
                        if(!batch){return}
                        var tgl=false
                        while(batch.length){
                            var nxt= tgl?batch.pop():batch.shift()
                            tgl=!tgl
                            if(nxt){
                                nxt[0].readFacilityRecord(nxt[1])
                                nxt[0]._updateUI( )
                             }   else{break;}
                        }
                    }
                    ,function(){ },15)
            }
            this._que.stop();
           // this.visibleAdditionalLocations.forEach(function(l){  l.clearUI(); });
            var bb=[],vis= this.visibleAdditionalLocations
            ,curr=vis.slice(),visln=vis.length,currlocs=this.locations.findAll(function(a){return !a.issecondary}).collect("locationid");
            var addresses=[];
            // visln=0;
            //vis=this.visibleAdditionalLocations=[];
            //var b=this.impl.getBounds();
            var b=this.getLatLngBounds({left:10,top:10,right:this.container.width()-10,bottom:this.container.height()-10})
            if(!b){return}
            var recs=facilityRecords||this._facilityRecords
            for(var i= 0,l=recs||[],ln= l.length;i<ln;i++){
                if(currlocs.indexOf(l[i].id)>=0){continue}
                var lt=l[i].latlng
                if(lt && b.contains([lt.lat,lt.lng])){
                    bb.push(l[i]);

                }
            }

            var template=app.getResource("map_popup_view"),hasnu= 0,que=[]

            for(var i= 0,ln= bb.length ;i<ln;i++){
                var x;
                if(i>=visln){hasnu++
                    x= this.addLocation({id:"map_vw_showall_"+(i),locKey:"addtnl",popupTemplate:template,
                        label:"",isadditional:true,issecondary:true,className:"marker-faded",markerconfig:{noanimation:true}})
                    x.ignoreUpdateUIonLatlng=true;
                    vis.push(x)
                 } else {
                    x=vis[i]
                 }
                que.push([x,bb[i]])
            }


            this._que.add(que).start();


        } else {
            this.visibleAdditionalLocations.forEach(function(l){
                l.clearUI();
            });
            this.visibleAdditionalLocations.length=0;
        }

     },
    /**
     * Description
     * @method showFacilitiesInBound
     * @return 
     */
    showFacilitiesInBound:function(){
        if(this.showAll){
            if(this._boundchangehandle){this._boundchangehandle()}
            else{this.showAllInBound( )}
        }
    },
    /**
     * Description
     * @method positionOnTap
     * @param {} callback
     * @return 
     */
    positionOnTap:function(callback){

        if(!this.container ){
            this.onpropertychange("container",function(){
                if(this.container){
                    this.positionOnTap(callback);
                }
            });

        }

    },
    /**
     * Description
     * @method positionOverlay
     * @param {} bounds
     * @return 
     */
    positionOverlay:function(bounds){
        if(!(this._overlay && $d.isAttached(this._overlay))){
            this._overlay=$d("<div/>").appendTo(this.container);
            this._overlay.css({position:"absolute", background:"rgba(255,255,255,.9)",border:"1px solid #ccc"})
                 .toFront(true).mousedown(function(a){
                    this.remove()

                });
        }
         if(!bounds){
            bounds = this.getContentBounds()
        }
        this._overlay.el.style.top=bounds.top+"px"
        this._overlay.el.style.left=bounds.left+"px"
        this._overlay.el.style.height=(bounds.bottom - bounds.top)+"px"
        this._overlay.el.style.width=(bounds.right - bounds.left)+"px"
        //this._overlay.css({top:bounds.top,left:bounds.left,height:bounds.height,width:bounds.width})

    },
    adjustZoom:function(){
        if(Math.min($.viewport.height,$.viewport.width) < 600){
            this.setZoom(15)
            this.zoomLevel=15;
            this.setView(true);
            return true
        }
        return
    },
    /**
     * Description
     * @method positionView
     * @param {} optns
     * @return 
     */
    positionView:function(optns){

        var latlng=this.getTargetLocation().latlng
        if(!(this.impl&&latlng&&latlng.isValid() && this.container  && this.container.isVisible(true) )){
            return
        }
        if(this.adjustZoom()){
            return
        }
            var bounds = this.getContentBounds()
	        if(!bounds){return}
            var cont=this.container.bounds(),iswithin=bounds.within(cont);
            if( !(cont.height>50&& cont.width>100)) {
                return
            }
            // bounds.relativeTo(cont)

 	       // alert(this.getZoom())
            bounds.top=bounds.top-30;
            bounds.bottom=bounds.bottom
	        var latLngbounds = this.getLatLngBounds(bounds)
            if(!latLngbounds){return}
	        this.impl.fitBounds(latLngbounds);
        this.zoomLevel=this.getZoom();
        //this.positionOverlay(bounds)
            //setTimeout(this.positionOverlay.bind(this),500)
            return;

    },
    /**
     * Description
     * @method setView
     * @param {} verified
     * @param {} optns
     * @return 
     */
    setView:function(verified,optns){
        if(!this.impl){return}
        var latlng=this.getTargetLocation().latlng
        if(verified===true || (this.impl&&latlng&&latlng.isValid() && this.container  && this.container.isVisible(true)) ){
            this.impl.setView(latlng.toMap())
            this.zoomLevel=this.getZoom()
        }
    },
    /**
     * Description
     * @method updateView
     * @param {} andPos
     * @param {} animate
     * @return 
     */
    updateView:function(andPos,animate){
        var latlng=this.getTargetLocation().latlng
        var dopos=this.centerOnNextLocation||this._positioned
        if(this.impl&&latlng&&latlng.isValid() && this.container  && this.container.isVisible(true) ){
            this.targetLocation.updateUI()

            if(!this._positioned || this.centerOnNextLocation ){
                this.setView(true);
                this.centerOnNextLocation=false;
                this._positioned=true;
            }

           // this.positionView();

        }
        if(dopos||andPos){
            setTimeout(this.positionView.bind(this),1000)
        }
    }

});



module.exports=GeoMap
}
__bootstrap__.modules["common/GeoUtils"] = function(module){
/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
	/*  Latitude/longitude spherical geo formulae & scripts
	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
 	var GeoUtils = {};

	/**
	 * Creates a LatLon point on the earth's surface at the specified latitude / longitude.
	 * @constructor
	 * @example
	 *     var p1 = new LatLon(52.205, 0.119);
	 * @classdesc Tools for geodetic calculations
	 * @requires GeoUtils
	 * @method LatLon
	 * @param {number} lat - Latitude in degrees.
	 * @param {number} lon - Longitude in degrees.
	 * @param {} height
	 * @param {} radius
	 * @return 
	 */
	function LatLon(lat, lon, height, radius) {
		// allow instantiation without 'new'
		if (!(this instanceof LatLon)) return new LatLon(lat, lon, height, radius);

		if (typeof height == 'undefined') height = 0;
		if (typeof radius == 'undefined') radius = 6371;
		radius = Math.min(Math.max(radius, 6353), 6384);

		this.lat    = Number(lat);
		this.lon    = Number(lon);
		this.height = Number(height);
		this.radius = Number(radius);
	}


	/**
	 * Returns the distance from 'this' point to destination point (using haversine formula).
	 * @example
	 *     var p1 = new LatLon(52.205, 0.119), p2 = new LatLon(48.857, 2.351);
	 *     var d = p1.distanceTo(p2); // d.toPrecision(4): 404.3
	 * @method distanceTo
	 * @param {LatLon} point - Latitude/longitude of destination point.
	 * @return d
	 */
	LatLon.prototype.distanceTo = function(point) {
		var R = this.radius||1;
		var O1 = this.lat.toRadians(),  A1 = this.lon.toRadians();
		var O2 = point.lat.toRadians(), A2 = point.lon.toRadians();
		var LO = O2 - O1;
		var LA = A2 - A1;

		var a = Math.sin(LO/2) * Math.sin(LO/2) +
			Math.cos(O1) * Math.cos(O2) *
			Math.sin(LA/2) * Math.sin(LA/2);
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		var d = R * c;

		return d;
	}


	/**
	 * Returns the (initial) bearing from 'this' point to destination point.
	 * @example
	 *     var p1 = new LatLon(52.205, 0.119), p2 = new LatLon(48.857, 2.351);
	 *     var b1 = p1.bearingTo(p2); // b1.toFixed(1): 156.2
	 * @method bearingTo
	 * @param {LatLon} point - Latitude/longitude of destination point.
	 * @return BinaryExpression
	 */
	LatLon.prototype.bearingTo = function(point) {
		var O1 = this.lat.toRadians(), O2 = point.lat.toRadians();
		var LA = (point.lon-this.lon).toRadians();

		// see http://mathforum.org/library/drmath/view/55417.html
		var y = Math.sin(LA) * Math.cos(O2);
		var x = Math.cos(O1)*Math.sin(O2) -
			Math.sin(O1)*Math.cos(O2)*Math.cos(LA);
		var Q = Math.atan2(y, x);

		return (Q.toDegrees()+360) % 360;
	}


	/**
	 * Returns final bearing arriving at destination destination point from 'this' point; the final bearing
	 * will differ from the initial bearing by varying degrees according to distance and latitude.
	 * @example
	 *     var p1 = new LatLon(52.205, 0.119), p2 = new LatLon(48.857, 2.351);
	 *     var b2 = p1.finalBearingTo(p2); // p2.toFixed(1): 157.9
	 * @method finalBearingTo
	 * @param {LatLon} point - Latitude/longitude of destination point.
	 * @return BinaryExpression
	 */
	LatLon.prototype.finalBearingTo = function(point) {
		// get initial bearing from destination point to this point & reverse it by adding 180�
		return ( point.bearingTo(this)+180 ) % 360;
	}


	/**
	 * Returns the midpoint between 'this' point and the supplied point.
	 * @example
	 *     var p1 = new LatLon(52.205, 0.119), p2 = new LatLon(48.857, 2.351);
	 *     var pMid = p1.midpointTo(p2); // pMid.toString(): 0.5363�N, 001.2746�E
	 * @method midpointTo
	 * @param {LatLon} point - Latitude/longitude of destination point.
	 * @return NewExpression
	 */
	LatLon.prototype.midpointTo = function(point) {
		// see http://mathforum.org/library/drmath/view/51822.html for derivation

		var O1 = this.lat.toRadians(), A1 = this.lon.toRadians();
		var O2 = point.lat.toRadians();
		var LA = (point.lon-this.lon).toRadians();

		var Bx = Math.cos(O2) * Math.cos(LA);
		var By = Math.cos(O2) * Math.sin(LA);

		var O3 = Math.atan2(Math.sin(O1)+Math.sin(O2),
			Math.sqrt( (Math.cos(O1)+Bx)*(Math.cos(O1)+Bx) + By*By) );
		var A3 = A1 + Math.atan2(By, Math.cos(O1) + Bx);
		A3 = (A3+3*Math.PI) % (2*Math.PI) - Math.PI; // normalise to -180..+180�

		return new LatLon(O3.toDegrees(), A3.toDegrees());
	}


	/**
	 * Returns the destination point from 'this' point having travelled the given distance on the
	 * given initial bearing (bearing normally varies around path followed).
	 * @example
	 *     var p1 = new LatLon(51.4778, -0.0015);
	 *     var p2 = p1.rhumbDestinationPoint(300.7, 7.794); // p2.toString(): 51.5136�N, 000.0983�W
	 * @method destinationPoint
	 * @param {number} brng - Initial bearing in degrees.
	 * @param {number} dist - Distance in km (on sphere of 'this' radius).
	 * @return NewExpression
	 */
	LatLon.prototype.destinationPoint = function(brng, dist) {
		// see http://williams.best.vwh.net/avform.htm#LL

		var Q = Number(brng).toRadians();
		var L = Number(dist) / this.radius; // angular distance in radians

		var O1 = this.lat.toRadians();
		var A1 = this.lon.toRadians();

		var O2 = Math.asin( Math.sin(O1)*Math.cos(L) +
			Math.cos(O1)*Math.sin(L)*Math.cos(Q) );
		var A2 = A1 + Math.atan2(Math.sin(Q)*Math.sin(L)*Math.cos(O1),
				Math.cos(L)-Math.sin(O1)*Math.sin(O2));
		A2 = (A2+3*Math.PI) % (2*Math.PI) - Math.PI; // normalise to -180..+180�

		return new LatLon(O2.toDegrees(), A2.toDegrees());
	}


	/**
	 * Returns the point of intersection of two paths defined by point and bearing.
	 * @example
	 *     var p1 = LatLon(51.8853, 0.2545), brng1 = 108.55;
	 *     var p2 = LatLon(49.0034, 2.5735), brng2 =  32.44;
	 *     var pInt = LatLon.intersection(p1, brng1, p2, brng2); // pInt.toString(): 50.9078�N, 4.5084�E
	 * @method intersection
	 * @param {LatLon} p1 - First point.
	 * @param {number} brng1 - Initial bearing from first point.
	 * @param {LatLon} p2 - Second point.
	 * @param {number} brng2 - Initial bearing from second point.
	 * @return NewExpression
	 */
	LatLon.intersection = function(p1, brng1, p2, brng2) {
		// see http://williams.best.vwh.net/avform.htm#Intersection

		var O1 = p1.lat.toRadians(), A1 = p1.lon.toRadians();
		var O2 = p2.lat.toRadians(), A2 = p2.lon.toRadians();
		var Q13 = Number(brng1).toRadians(), Q23 = Number(brng2).toRadians();
		var LO = O2-O1, LA = A2-A1;

		var L12 = 2*Math.asin( Math.sqrt( Math.sin(LO/2)*Math.sin(LO/2) +
				Math.cos(O1)*Math.cos(O2)*Math.sin(LA/2)*Math.sin(LA/2) ) );
		if (L12 == 0) return null;

		// initial/final bearings between points
		var Q1 = Math.acos( ( Math.sin(O2) - Math.sin(O1)*Math.cos(L12) ) /
			( Math.sin(L12)*Math.cos(O1) ) );
		if (isNaN(Q1)) Q1 = 0; // protect against rounding
		var Q2 = Math.acos( ( Math.sin(O1) - Math.sin(O2)*Math.cos(L12) ) /
			( Math.sin(L12)*Math.cos(O2) ) );

		if (Math.sin(A2-A1) > 0) {
			var Q12 = Q1;
			var Q21 = 2*Math.PI - Q2;
		} else {
			var Q12 = 2*Math.PI - Q1;
			var Q21 = Q2;
		}

		var x1 = (Q13 - Q12 + Math.PI) % (2*Math.PI) - Math.PI; // angle 2-1-3
		var x2 = (Q21 - Q23 + Math.PI) % (2*Math.PI) - Math.PI; // angle 1-2-3

		if (Math.sin(x1)==0 && Math.sin(x2)==0) return null; // infinite intersections
		if (Math.sin(x1)*Math.sin(x2) < 0) return null;      // ambiguous intersection

		//x1 = Math.abs(x1);
		//x2 = Math.abs(x2);
		// ... Ed Williams takes abs of x1/x2, but seems to break calculation?

		var x3 = Math.acos( -Math.cos(x1)*Math.cos(x2) +
			Math.sin(x1)*Math.sin(x2)*Math.cos(L12) );
		var L13 = Math.atan2( Math.sin(L12)*Math.sin(x1)*Math.sin(x2),
			Math.cos(x2)+Math.cos(x1)*Math.cos(x3) )
		var O3 = Math.asin( Math.sin(O1)*Math.cos(L13) +
			Math.cos(O1)*Math.sin(L13)*Math.cos(Q13) );
		var LA13 = Math.atan2( Math.sin(Q13)*Math.sin(L13)*Math.cos(O1),
			Math.cos(L13)-Math.sin(O1)*Math.sin(O3) );
		var A3 = A1 + LA13;
		A3 = (A3+3*Math.PI) % (2*Math.PI) - Math.PI; // normalise to -180..+180�

		return new LatLon(O3.toDegrees(), A3.toDegrees());
	}


	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */

	/**
	 * Returns the distance travelling from 'this' point to destination point along a rhumb line.
	 * @example
	 *     var p1 = new LatLon(51.127, 1.338), p2 = new LatLon(50.964, 1.853);
	 *     var d = p1.distanceTo(p2); // d.toPrecision(4): 40.31
	 * @method rhumbDistanceTo
	 * @param {LatLon} point - Latitude/longitude of destination point.
	 * @return dist
	 */
	LatLon.prototype.rhumbDistanceTo = function(point) {
		// see http://williams.best.vwh.net/avform.htm#Rhumb

		var R = this.radius;
		var O1 = this.lat.toRadians(), O2 = point.lat.toRadians();
		var LO = O2 - O1;
		var LA = Math.abs(point.lon-this.lon).toRadians();
		// if dLon over 180� take shorter rhumb line across the anti-meridian:
		if (Math.abs(LA) > Math.PI) LA = LA>0 ? -(2*Math.PI-LA) : (2*Math.PI+LA);

		// on Mercator projection, longitude distances shrink by latitude; q is the 'stretch factor'
		// q becomes ill-conditioned along E-W line (0/0); use empirical tolerance to avoid it
		var LY = Math.log(Math.tan(O2/2+Math.PI/4)/Math.tan(O1/2+Math.PI/4));
		var q = Math.abs(LY) > 10e-12 ? LO/LY : Math.cos(O1);

		// distance is pythagoras on 'stretched' Mercator projection
		var L = Math.sqrt(LO*LO + q*q*LA*LA); // angular distance in radians
		var dist = L * R;

		return dist;
	}


	/**
	 * Returns the bearing from 'this' point to destination point along a rhumb line.
	 * @example
	 *     var p1 = new LatLon(51.127, 1.338), p2 = new LatLon(50.964, 1.853);
	 *     var d = p1.rhumbBearingTo(p2); // d.toFixed(1): 116.7
	 * @method rhumbBearingTo
	 * @param {LatLon} point - Latitude/longitude of destination point.
	 * @return BinaryExpression
	 */
	LatLon.prototype.rhumbBearingTo = function(point) {
		var O1 = this.lat.toRadians(), O2 = point.lat.toRadians();
		var LA = (point.lon-this.lon).toRadians();
		// if dLon over 180� take shorter rhumb line across the anti-meridian:
		if (Math.abs(LA) > Math.PI) LA = LA>0 ? -(2*Math.PI-LA) : (2*Math.PI+LA);

		var LY = Math.log(Math.tan(O2/2+Math.PI/4)/Math.tan(O1/2+Math.PI/4));

		var Q = Math.atan2(LA, LY);

		return (Q.toDegrees()+360) % 360;
	}


	/**
	 * Returns the destination point having travelled along a rhumb line from 'this' point the given
	 * distance on the  given bearing.
	 * @example
	 *     var p1 = new LatLon(51.127, 1.338);
	 *     var p2 = p1.rhumbDestinationPoint(116.7, 40.31); // p2.toString(): 50.9641�N, 001.8531�E
	 * @method rhumbDestinationPoint
	 * @param {number} brng - Bearing in degrees from north.
	 * @param {number} dist - Distance in km (on sphere of 'this' radius).
	 * @return NewExpression
	 */
	LatLon.prototype.rhumbDestinationPoint = function(brng, dist) {
		var L = Number(dist) / this.radius; // angular distance in radians
		var O1 = this.lat.toRadians(), A1 = this.lon.toRadians();
		var Q = Number(brng).toRadians();

		var LO = L * Math.cos(Q);

		var O2 = O1 + LO;
		// check for some daft bugger going past the pole, normalise latitude if so
		if (Math.abs(O2) > Math.PI/2) O2 = O2>0 ? Math.PI-O2 : -Math.PI-O2;

		var LY = Math.log(Math.tan(O2/2+Math.PI/4)/Math.tan(O1/2+Math.PI/4));
		var q = Math.abs(LY) > 10e-12 ? LO / LY : Math.cos(O1); // E-W course becomes ill-conditioned with 0/0

		var LA = L*Math.sin(Q)/q;

		var A2 = A1 + LA;

		A2 = (A2 + 3*Math.PI) % (2*Math.PI) - Math.PI; // normalise to -180..+180�

		return new LatLon(O2.toDegrees(), A2.toDegrees());
	}


	/**
	 * Returns the loxodromic midpoint (along a rhumb line) between 'this' point and second point.
	 * @example
	 *     var p1 = new LatLon(51.127, 1.338), p2 = new LatLon(50.964, 1.853);
	 *     var p2 = p1.rhumbMidpointTo(p2); // p2.toString(): 51.0455�N, 001.5957�E
	 * @method rhumbMidpointTo
	 * @param {LatLon} point - Latitude/longitude of second point.
	 * @return NewExpression
	 */
	LatLon.prototype.rhumbMidpointTo = function(point) {
		// http://mathforum.org/kb/message.jspa?messageID=148837

		var O1 = this.lat.toRadians(), A1 = this.lon.toRadians();
		var O2 = point.lat.toRadians(), A2 = point.lon.toRadians();

		if (Math.abs(A2-A1) > Math.PI) A1 += 2*Math.PI; // crossing anti-meridian

		var O3 = (O1+O2)/2;
		var f1 = Math.tan(Math.PI/4 + O1/2);
		var f2 = Math.tan(Math.PI/4 + O2/2);
		var f3 = Math.tan(Math.PI/4 + O3/2);
		var A3 = ( (A2-A1)*Math.log(f3) + A1*Math.log(f2) - A2*Math.log(f1) ) / Math.log(f2/f1);

		if (!isFinite(A3)) A3 = (A1+A2)/2; // parallel of latitude

		A3 = (A3 + 3*Math.PI) % (2*Math.PI) - Math.PI; // normalise to -180..+180�

		return new LatLon(O3.toDegrees(), A3.toDegrees());
	}


	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */


	/**
	 * Returns a string representation of 'this' point, formatted as degrees, degrees+minutes, or
	 * degrees+minutes+seconds.
	 * @method toString
	 * @param {} format
	 * @param {} dp
	 * @return BinaryExpression
	 */
	LatLon.prototype.toString = function(format, dp) {
		if (typeof format == 'undefined') format = 'dms';

		return GeoUtils.toLat(this.lat, format, dp) + ', ' + GeoUtils.toLon(this.lon, format, dp);
	}

	GeoUtils.LatLon=LatLon

	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */


	/** Extend Number object with method to convert numeric degrees to radians */
	if (typeof Number.prototype.toRadians == 'undefined') {
		/**
		 * Description
		 * @method toRadians
		 * @return BinaryExpression
		 */
		Number.prototype.toRadians = function() { return this * Math.PI / 180; }
	}


	/** Extend Number object with method to convert radians to numeric (signed) degrees */
	if (typeof Number.prototype.toDegrees == 'undefined') {
		/**
		 * Description
		 * @method toDegrees
		 * @return BinaryExpression
		 */
		Number.prototype.toDegrees = function() { return this * 180 / Math.PI; }
	}


	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
	if (!window.console) window.console = { 
/**
  * Description
  * @method log
  * @return 
  */
 log: function() {} };
	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
	/*  Geodesy representation conversion functions                       (c) Chris Veness 2002-2014  */
	/*   - www.movable-type.co.uk/scripts/latlong.html                                                */
	/*                                                                                                */
	/*  Sample usage:                                                                                 */
	/*    var lat = GeoUtils.parseDMS('51� 28? 40.12? N');                                                 */
	/*    var lon = GeoUtils.parseDMS('000� 00? 05.31? W');                                                */
	/*    var p1 = new LatLon(lat, lon);                                                              */
	/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
	'use strict';


	/**
	 * Tools for converting between numeric degrees and degrees / minutes / seconds.
	 *
	 * @namespace
	 */



// note Unicode Degree = U+00B0. Prime = U+2032, Double prime = U+2033


	/**
	 * Parses string representing degrees/minutes/seconds into numeric degrees.
	 * This is very flexible on formats, allowing signed decimal degrees, or deg-min-sec optionally
	 * suffixed by compass direction (NSEW). A variety of separators are accepted (eg 3� 37? 09?W).
	 * Seconds and minutes may be omitted.
	 * @method parseDMS
	 * @param {} dmsStr
	 * @return CallExpression
	 */
	GeoUtils.parseDMS = function(dmsStr) {
		// check for signed decimal degrees without NSEW, if so return it directly
		if (typeof dmsStr == 'number' && isFinite(dmsStr)) return Number(dmsStr);

		// strip off any sign or compass dir'n & split out separate d/m/s
		var dms = String(dmsStr).trim().replace(/^-/,'').replace(/[NSEW]$/i,'').split(/[^0-9.,]+/);
		if (dms[dms.length-1]=='') dms.splice(dms.length-1);  // from trailing symbol

		if (dms == '') return NaN;

		// and convert to decimal degrees...
		switch (dms.length) {
			case 3:  // interpret 3-part result as d/m/s
				var deg = dms[0]/1 + dms[1]/60 + dms[2]/3600;
				break;
			case 2:  // interpret 2-part result as d/m
				var deg = dms[0]/1 + dms[1]/60;
				break;
			case 1:  // just d (possibly decimal) or non-separated dddmmss
				var deg = dms[0];
				// check for fixed-width unseparated format eg 0033709W
				//if (/[NS]/i.test(dmsStr)) deg = '0' + deg;  // - normalise N/S to 3-digit degrees
				//if (/[0-9]{7}/.test(deg)) deg = deg.slice(0,3)/1 + deg.slice(3,5)/60 + deg.slice(5)/3600;
				break;
			default:
				return NaN;
		}
		if (/^-|[WS]$/i.test(dmsStr.trim())) deg = -deg; // take '-', west and south as -ve
		return Number(deg);
	}


	/**
	 * Converts decimal degrees to deg/min/sec format
	 *  - degree, prime, double-prime symbols are added, but sign is discarded, though no compass
	 *    direction is added.
	 * @private
	 * @method toDMS
	 * @param {number} deg - Degrees to be formatted as specified.
	 * @param {} format
	 * @param {} dp
	 * @return dms
	 */
	GeoUtils.toDMS = function(deg, format, dp) {
		if (isNaN(deg)) return null;  // give up here if we can't make a number from deg

		// default values
		if (typeof format == 'undefined') format = 'dms';
		if (typeof dp == 'undefined') {
			switch (format) {
				case 'd':   dp = 4; break;
				case 'dm':  dp = 2; break;
				case 'dms': dp = 0; break;
				default:    format = 'dms'; dp = 0;  // be forgiving on invalid format
			}
		}

		deg = Math.abs(deg);  // (unsigned result ready for appending compass dir'n)

		switch (format) {
			case 'd':
				d = deg.toFixed(dp);     // round degrees
				if (d<100) d = '0' + d;  // pad with leading zeros
				if (d<10) d = '0' + d;
				var dms = d + '�';
				break;
			case 'dm':
				var min = (deg*60).toFixed(dp);  // convert degrees to minutes & round
				var d = Math.floor(min / 60);    // get component deg/min
				var m = (min % 60).toFixed(dp);  // pad with trailing zeros
				if (d<100) d = '0' + d;          // pad with leading zeros
				if (d<10) d = '0' + d;
				if (m<10) m = '0' + m;
				var dms = d + '�' + m + '?';
				break;
			case 'dms':
				var sec = (deg*3600).toFixed(dp);  // convert degrees to seconds & round
				var d = Math.floor(sec / 3600);    // get component deg/min/sec
				var m = Math.floor(sec/60) % 60;
				var s = (sec % 60).toFixed(dp);    // pad with trailing zeros
				if (d<100) d = '0' + d;            // pad with leading zeros
				if (d<10) d = '0' + d;
				if (m<10) m = '0' + m;
				if (s<10) s = '0' + s;
				var dms = d + '�' + m + '?' + s + '?';
				break;
		}

		return dms;
	}


	/**
	 * Converts numeric degrees to deg/min/sec latitude (2-digit degrees, suffixed with N/S).
	 * @method toLat
	 * @param {number} deg - Degrees to be formatted as specified.
	 * @param {} format
	 * @param {} dp
	 * @return ConditionalExpression
	 */
	GeoUtils.toLat = function(deg, format, dp) {
		var lat = GeoUtils.toDMS(deg, format, dp);
		return lat==null ? '�' : lat.slice(1) + (deg<0 ? 'S' : 'N');  // knock off initial '0' for lat!
	}


	/**
	 * Convert numeric degrees to deg/min/sec longitude (3-digit degrees, suffixed with E/W)
	 * @method toLon
	 * @param {number} deg - Degrees to be formatted as specified.
	 * @param {} format
	 * @param {} dp
	 * @return ConditionalExpression
	 */
	GeoUtils.toLon = function(deg, format, dp) {
		var lon = GeoUtils.toDMS(deg, format, dp);
		return lon==null ? '�' : lon + (deg<0 ? 'W' : 'E');
	}


	/**
	 * Converts numeric degrees to deg/min/sec as a bearing (0�..360�)
	 * @method toBrng
	 * @param {number} deg - Degrees to be formatted as specified.
	 * @param {} format
	 * @param {} dp
	 * @return ConditionalExpression
	 */
	GeoUtils.toBrng = function(deg, format, dp) {
		deg = (Number(deg)+360) % 360;  // normalise -ve values to 180�..360�
		var brng =  GeoUtils.toDMS(deg, format, dp);
		return brng==null ? '�' : brng.replace('360', '0');  // just in case rounding took us up to 360�!
	}

	/**
	 * Description
	 * @method distancesFrom
	 * @param {} latlng1
	 * @param {} latlng2
	 * @param {} prop
	 * @return CallExpression
	 */
	GeoUtils.distancesFrom=function(latlng1,latlng2,prop){
		var   arr=latlng2,p1 = LatLon(GeoUtils.parseDMS(latlng1.lat), GeoUtils.parseDMS( latlng1.lng));
		arr.forEach(function(it){
			it.dist=GeoUtils.distanceFrom(p1,prop?it[prop]:(it.latlng||it))
		});
		return   arr.sort(function(a,b){return a.dist- b.dist})
	}
	/**
	 * Description
	 * @method distanceFrom
	 * @param {} latlon
	 * @param {} latlng2
	 * @return CallExpression
	 */
	GeoUtils.distanceFrom=function(latlon,latlng2){
		var    p2 = LatLon(GeoUtils.parseDMS(latlng2.lat), GeoUtils.parseDMS( latlng2.lng));
		return latlon.distanceTo(p2)
	}
	/**
	 * Description
	 * @method computeDistance
	 * @param {} latlng1
	 * @param {} latlng2
	 * @return CallExpression
	 */
	GeoUtils.computeDistance=function(latlng1,latlng2){
		var   p1 = LatLon(GeoUtils.parseDMS(latlng1.lat), GeoUtils.parseDMS( latlng1.lng))
		return GeoUtils.distanceFrom(p1,latlng2)
	}

	module.exports=GeoUtils
}
__bootstrap__.modules["common/GoogMap"] = function(module){
/**
 * Created by Atul on 7/30/2015.
 * @method RotateIcon
 * @param {} options
 * @return 
 */
var RotateIcon = function(options){
	this.options = options || {};
	this.rImg = options.img || new Image();
	this.rImg.src = this.rImg.src || this.options.url || '';
	this.options.width = this.options.width || this.rImg.width || 52;
	this.options.height = this.options.height || this.rImg.height || 60;
	canvas = document.createElement("canvas");
	canvas.width = this.options.width;
	canvas.height = this.options.height;
	this.context = canvas.getContext("2d");
	this.canvas = canvas;
};
/**
 * Description
 * @method makeIcon
 * @param {} url
 * @return NewExpression
 */
RotateIcon.makeIcon = function(url) {
	return new RotateIcon({url: url});
};
var directionsService=null

/**
 * Description
 * @method calculateDistances
 * @param {} origin
 * @param {} destinations
 * @param {} mode
 * @param {} cb
 * @return 
 */
function calculateDistances(origin,destinations,mode,cb) {
	var service = new google.maps.DistanceMatrixService();
	service.getDistanceMatrix(
		{
			origins: [toGLatLng(origin)],
			destinations: destinations.map(function(it){
				return typeof(it)=="string"?it:toGLatLng(it)
			}),
			travelMode: google.maps.TravelMode[mode||"DRIVING"],
			unitSystem: google.maps.UnitSystem.IMPERIAL,
			avoidHighways: false,
			avoidTolls: false
		}, function callback(response, status) {
			if (status != google.maps.DistanceMatrixStatus.OK) {
				cb(false,status)
			} else {
				var res=[]
				var rorigins = response.originAddresses;
				var rdestinations = response.destinationAddresses;
				for (var i = 0; i < rorigins.length; i++) {
					var results = response.rows[i].elements;
 					for (var j = 0; j < results.length; j++) {
					    res.push({destination:destinations[j] ,distance:results[j].distance.text,duration:results[j].duration.text})
					}
				}
				cb(res)
			}
		});
}
/**
 * Description
 * @method calcRoute
 * @param {} origin
 * @param {} destination
 * @param {} selectedMode
 * @param {} callback
 * @return 
 */
function calcRoute(origin,destination,selectedMode,callback) {
	directionsService || (directionsService= new google.maps.DirectionsService());
	if(typeof(selectedMode)=="function"){callback=selectedMode;selectedMode=null}
	var request = {
		origin: toGLatLng(origin),
		destination: toGLatLng(destination),
		// Note that Javascript allows us to access the constant
		// using square brackets and a string value as its
		// "property."
		travelMode: google.maps.TravelMode[selectedMode || "DRIVING"]
	};
	directionsService.route(request, function(response, status) {
		if (status == google.maps.DirectionsStatus.OK) {
			callback(response);
		}
	});
}
/**
 * Description
 * @method setRotation
 * @param {} options
 * @return ThisExpression
 */
RotateIcon.prototype.setRotation = function(options){
	var canvas = this.context,
		angle = options.deg ? options.deg * Math.PI / 180:
			options.rad,
		centerX = this.options.width/2,
		centerY = this.options.height/2;

	canvas.clearRect(0, 0, this.options.width, this.options.height);
	canvas.save();
	canvas.translate(centerX, centerY);
	canvas.rotate(angle);
	canvas.translate(-centerX, -centerY);
	canvas.drawImage(this.rImg, 0, 0);
	canvas.restore();
	return this;
};
/**
 * Description
 * @method getUrl
 * @return CallExpression
 */
RotateIcon.prototype.getUrl = function(){
	return this.canvas.toDataURL('image/png');
};

/**
 * Description
 * @method GoogMap
 * @param {} dom
 * @param {} latlng
 * @param {} config
 * @return 
 */
var GoogMap=function(dom,latlng,config){
	this.initMap(dom,latlng,config)
};

/**
 * Description
 * @method setRectangle
 * @param {} pos
 * @return sc
 */
function setRectangle(pos){var map=this._map
	var scale = Math.pow(2,map.getZoom());
	var proj = map.getProjection();
	var wc = proj.fromLatLngToContainerPixel?proj.fromLatLngToContainerPixel(pos):proj.fromLatLngToPoint(pos);
 	var sw = new google.maps.Point(((wc.x * scale) - 50)/ scale, ((wc.y * scale) - 50)/ scale);
	 return sc;

}
/**
 * Description
 * @method lttopx
 * @param {} pos
 * @return p
 */
function lttopx(pos){

	var map=this._map
	var projection = this.getProjection();

	if (!projection) {
		// The map projection is not ready yet so do nothing
		return;
	}
	var centerPos = projection.fromLatLngToContainerPixel(map.getCenter());
	var pos = projection.fromLatLngToContainerPixel(latLng);
	var latLng = projection.fromContainerPixelToLatLng(pos);
// Find out how much space at the top is free
	var spaceTop = centerPos.y - height;

	// Fine out how much space at the bottom is free
	var spaceBottom = mapHeight - centerPos.y;

	var needsTop = spaceTop < 0;
	var deltaY = 0;

	if (needsTop) {
		spaceTop *= -1;
		deltaY = (spaceTop + spaceBottom) / 2;
	}
	if (map.getCenter() != latLng) {
		map.panTo(latLng);
	}
	pos.y -= deltaY;
	var overlay = new google.maps.OverlayView();
	/**
	 * Description
	 * @method draw
	 * @return 
	 */
	overlay.draw = function() {};
	overlay.setMap(map);

	var proj = overlay.getProjection();
	var p = proj.fromLatLngToContainerPixel(pos);
	return p
}
/**
 * Description
 * @method pixelOffsetToLatLng
 * @param {} offsetx
 * @param {} offsety
 * @return latLngPosition
 */
function pixelOffsetToLatLng(offsetx,offsety) {
	 var map=this._map
	var latlng = map.getCenter();
	var scale = Math.pow(2, map.getZoom());
	var nw = new google.maps.LatLng(
		map.getBounds().getNorthEast().lat(),
		map.getBounds().getSouthWest().lng()
	);

	var worldCoordinateCenter = map.getProjection().fromLatLngToPoint(latlng);
	var pixelOffset = new google.maps.Point((offsetx/scale) || 0,(offsety/scale) ||0);

	var worldCoordinateNewCenter = new google.maps.Point(
		worldCoordinateCenter.x - pixelOffset.x,
		worldCoordinateCenter.y + pixelOffset.y
	);

	var latLngPosition = map.getProjection().fromPointToLatLng(worldCoordinateNewCenter);

	return latLngPosition;
}
/**
 * Description
 * @method toLatLng
 * @param {} latlng
 * @return ConditionalExpression
 */
function toLatLng(latlng){
	if(!latlng){return}
	if(typeof(latlng.lat)=="function"){
		return {lat:latlng.lat(),lng:latlng.lng()};
	} else if(Array.isArray(latlng)){
		return {lat:latlng[0],lng:latlng[1]};
	}
	return latlng.lat?{lat:latlng.lat,lng:latlng.lng}:null
}
/**
 * Description
 * @method toGLatLng
 * @param {} latlng
 * @return ConditionalExpression
 */
function toGLatLng(latlng){
	if(!latlng){return}
	if(latlng instanceof google.maps.LatLng){return latlng}
	latlng=toLatLng(latlng)
	return latlng?new google.maps.LatLng(latlng.lat, latlng.lng):null;
}
/**
 * Description
 * @method initialize
 * @return 
 */
function initialize() {
	geocoder = new google.maps.Geocoder();
	var mapOptions = {
		zoom: 8
	}
	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	codeAddress();
}
/**
 * Description
 * @method calcDist
 * @return 
 */
function calcDist(){
	var geocoder = new google.maps.Geocoder();

	/**
	 * Description
	 * @method calculateDistances
	 * @return 
	 */
	function calculateDistances() {
		var service = new google.maps.DistanceMatrixService();
		service.getDistanceMatrix(
			{
				origins: [origin1, origin2],
				destinations: [destinationA, destinationB],
				travelMode: google.maps.TravelMode.DRIVING,
				unitSystem: google.maps.UnitSystem.METRIC,
				avoidHighways: false,
				avoidTolls: false
			}, callback);
	}

	/**
	 * Description
	 * @method callback
	 * @param {} response
	 * @param {} status
	 * @return 
	 */
	function callback(response, status) {
		if (status != google.maps.DistanceMatrixStatus.OK) {
			alert('Error was: ' + status);
		} else {
			var origins = response.originAddresses;
			var destinations = response.destinationAddresses;
			var outputDiv = document.getElementById('outputDiv');
			outputDiv.innerHTML = '';
			deleteOverlays();

			for (var i = 0; i < origins.length; i++) {
				var results = response.rows[i].elements;
				addMarker(origins[i], false);
				for (var j = 0; j < results.length; j++) {
					addMarker(destinations[j], true);
					outputDiv.innerHTML += origins[i] + ' to ' + destinations[j]
						+ ': ' + results[j].distance.text + ' in '
						+ results[j].duration.text + '<br>';
				}
			}
		}
	}

}
/**
 * Description
 * @method latlngToAddress
 * @param {} latlng
 * @param {} callback
 * @return 
 */
function latlngToAddress(latlng,callback) {
	var geocoder = new google.maps.Geocoder(),glatlng=toGLatLng(latlng);
	geocoder.geocode( { 'location': glatlng}, function(results, status) {
		if (status == google.maps.GeocoderStatus.OK) {
			if (results[1]) {
				callback(results[1])
			} else{

			}
			}
	});
}
/**
 * Description
 * @method addressToLatLng
 * @param {} query
 * @param {} callback
 * @return 
 */
function addressToLatLng(query,callback) {
	var address = query;
	var geocoder = new google.maps.Geocoder();
	geocoder.geocode( { 'address': address}, function(results, status) {
		if (status == google.maps.GeocoderStatus.OK) {
			callback(toLatLng(results[0].geometry.location),results[0]);
			;
		} else {
			alert('Geocode was not successful for the following reason: ' + status);
		}
	});
}
GoogMap.addressToLatLng=addressToLatLng

GoogMap.latlngToAddress=latlngToAddress
GoogMap.calculateDistances=calculateDistances
GoogMap.calculateRoute=calcRoute
//panToBounds
GoogMap.prototype={
	/**
	 * Description
	 * @method getLatLngBounds
	 * @param {} ltbounds
	 * @return nu
	 */
	getLatLngBounds:function(ltbounds){
		if(ltbounds instanceof google.maps.LatLngBounds){return ltbounds}
		var nu=new google.maps.LatLngBounds(toGLatLng(ltbounds[0]),toGLatLng(ltbounds[1]))
		nu._contains=nu.contains
		/**
		 * Description
		 * @method contains
		 * @param {} lt
		 * @return CallExpression
		 */
		nu.contains=function(lt){
			var latlng=toGLatLng(lt)
			return this._contains(latlng)
		}
		return nu
	},
	/**
	 * Description
	 * @method onBoundsChange
	 * @param {} fn
	 * @return 
	 */
	onBoundsChange:function(fn){
		this.addListener('bounds_changed', fn)
	},
	addListener:function(ev,fn){
		if(!this._map){return}
		google.maps.event.addListener(this._map, ev, fn);
	},
	/**
	 * Description
	 * @method invalidateSize
	 * @return 
	 */
	invalidateSize:function(){
		google.maps.event.trigger(this._map,'resize')
	},
	/**
	 * Description
	 * @method removeLayer
	 * @return 
	 */
	removeLayer:function(){},
	/**
	 * Description
	 * @method closePopup
	 * @return 
	 */
	closePopup:function(){},
 	/**
	  * Description
	  * @method zoomIn
	  * @return 
	  */
	 zoomIn:function(){},
	/**
	 * Description
	 * @method zoomOut
	 * @return 
	 */
	zoomOut:function(){},
	/**
	 * Description
	 * @method getZoom
	 * @return CallExpression
	 */
	getZoom:function(){return this._map.getZoom()},
	/**
	 * Description
	 * @method panBy
	 * @param {} a
	 * @param {} b
	 * @return 
	 */
	panBy:function(a,b){this._map.panBy(a,b)},
	/**
	 * Description
	 * @method setZoomAround
	 * @return 
	 */
	setZoomAround:function(){},
	/**
	 * Description
	 * @method setZoom
	 * @param {} n
	 * @return 
	 */
	setZoom:function(n){this._map.setZoom(n)},
	/**
	 * Description
	 * @method mouseEventToLatLng
	 * @return 
	 */
	mouseEventToLatLng:function(){},
	/**
	 * Description
	 * @method latLngToContainerPoint
	 * @param {} latlng
	 * @return wc
	 */
	latLngToContainerPoint:function(latlng){var map=this._map
		var proj = map.getProjection(),pos=toGLatLng(latlng);
		if(!proj){return}
		var wc = proj.fromLatLngToContainerPixel?proj.fromLatLngToContainerPixel(pos):proj.fromLatLngToPoint(pos);
		return wc
	},
	/**
	 * Description
	 * @method renderDirections
	 * @param {} start
	 * @param {} end
	 * @param {} color
	 * @return 
	 */
	renderDirections:function(start,end,color){
		directionsService || (directionsService= new google.maps.DirectionsService());
		var directionsDisplay = new google.maps.DirectionsRenderer({preserveViewport:true,suppressInfoWindows:true,suppressMarkers:true,polylineOptions:{strokeColor:color||"blue"}});
		var request = {
			origin:typeof(start)=="string"?start:toGLatLng(start),
			destination:typeof(end)=="string"?end:toGLatLng(end),
			travelMode: google.maps.TravelMode.DRIVING
		};
		if(this._directionsDisplay){this._directionsDisplay.setMap(null)}
		directionsDisplay.setMap(this._map);
		this._directionsDisplay=directionsDisplay
		directionsService.route(request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				directionsDisplay.setDirections(response);
			}
		});
	},
	/**
	 * Description
	 * @method containerPointToLatLng
	 * @param {} x
	 * @param {} y
	 * @return ObjectExpression
	 */
	containerPointToLatLng:function pointToLatLng(x,y){
		if(Array.isArray(x)){
			y=x[1]
			x=x[0]
		}
			var map=this._map
			var latLngBounds = map.getBounds();
			var neBound = latLngBounds.getNorthEast();
			var swBound = latLngBounds.getSouthWest();

			// convert the bounds in pixels
			var neBoundInPx = map.getProjection().fromLatLngToPoint(neBound);
			var swBoundInPx = map.getProjection().fromLatLngToPoint(swBound);

			// compute the percent of x and y coordinates related to the div containing the map; in my case the screen
			var dombounds=map.getDiv().getBoundingClientRect()
			var procX = x/dombounds.width;
			var procY = y/dombounds.height;

			// compute new coordinates in pixels for lat and lng;
			// for lng : subtract from the right edge of the container the left edge,
			// multiply it by the percentage where the x coordinate was on the screen
			// related to the container in which the map is placed and add back the left boundary
			// you should now have the Lng coordinate in pixels
			// do the same for lat
			var newLngInPx = (neBoundInPx.x - swBoundInPx.x) * procX + swBoundInPx.x;
			var newLatInPx = (swBoundInPx.y - neBoundInPx.y) * procY + neBoundInPx.y;

			// convert from google point in lat lng and have fun :)
			var newLatLng = map.getProjection().fromPointToLatLng(new google.maps.Point(newLngInPx, newLatInPx));
			return {lat:newLatLng.lat(),lng:newLatLng.lng()};
	},
	/**
	 * Description
	 * @method containerPointToLayerPoint
	 * @param {} x
	 * @param {} y
	 * @return CallExpression
	 */
	containerPointToLayerPoint:function(x,y){return this.containerPointToLatLng(x,y)},
	/**
	 * Description
	 * @method addLayer
	 * @return 
	 */
	addLayer:function(){},
	/**
	 * Description
	 * @method setView
	 * @param {} latlng
	 * @return ThisExpression
	 */
	setView:function(latlng){
		var GlatLng = toGLatLng(latlng);
		this._map && GlatLng && this._map.setCenter(GlatLng);
		return this
	},
	/**
	 * Description
	 * @method getCenter
	 * @return CallExpression
	 */
	getCenter:function(){return this._map.getCenter()},
	/**
	 * Description
	 * @method getBounds
	 * @return CallExpression
	 */
	getBounds:function(){return this._map.getBounds()},
	/**
	 * Description
	 * @method fitBounds
	 * @param {} bounds
	 * @return 
	 */
	fitBounds:function(bounds){

		var ltb=this.getLatLngBounds(bounds)
		if(!ltb){return}
		this._map.fitBounds(ltb)
		return
		this._map.panToBounds(ltb)
		var b=this.getBounds()
		var lat1=Math.abs(ltb.getSouthWest().lat() - ltb.getNorthEast().lat()),lng1=Math.abs(ltb.getSouthWest().lng() - ltb.getNorthEast().lng()),
			lat2=Math.abs(b.getSouthWest().lat() - b.getNorthEast().lat()),lng2=Math.abs(b.getSouthWest().lng() - b.getNorthEast().lng())
		var center=ltb.getCenter()
		if(!(b.contains(ltb.getNorthEast()) && b.contains(ltb.getSouthWest()))){
			if(lat1>lat2 || lng1>lng2) {
				this._map.setZoom(Math.max(8, this._map.getZoom() - 1));
			} else{
				this._map.setCenter(center)
			}
		} else{
			if(lat2 > lat1*2.5 && lng2 > lng1*2.5){
				this._map.setZoom(Math.min(18,this._map.getZoom()+1));
				this._map.setCenter(center)
			}
		}

	},
	/**
	 * Description
	 * @method initMap
	 * @param {} dom
	 * @param {} latlng
	 * @param {} config
	 * @return 
	 */
	initMap:function(dom,latlng,config){
		this._config=	config||{}
		var noPoi = [
			{
				featureType: "poi", elementType: "labels",
				stylers: [ { visibility: "off" } ]
			},
			{
				featureType: "transit", elementType: "labels",
				stylers: [ { visibility: "off" } ]
			}
		];
		var initialLatLng = toGLatLng(latlng);
		this._map = new google.maps.Map(dom, {
			mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl: false,
			streetViewControl:false,
			minZoom:config.minZoom||10,
			maxZoom:config.maxZoom||16,
			zoom: this._config.zoom||14});
		initialLatLng && this._map.setCenter(initialLatLng);
		if(config.onclick){
			google.maps.event.addListener(this._map, 'click', function(ev){
				config.onclick({latlng:toLatLng(ev.latLng)} )
			});
		}
		this._map.setOptions({styles: noPoi});

	},
	/**
	 * Description
	 * @method popUp
	 * @param {} content
	 * @param {} config
	 * @return infoWindow
	 */
	popUp:function(content,config){
		var infoWindow = new InfoBubble({
			map: this._map,
			content: content,
			//position: new google.maps.LatLng(-35, 151),
			shadowStyle: 1,
			padding: 0,
			minWidth:150,
			minHeight:80,
				backgroundColor: 'rgb(255,255,255)',
			borderRadius: 8,
			arrowSize: 10,
			borderWidth: 1,
			borderColor: '#ccc',
			hideCloseButton: true,
			arrowPosition:40,
			backgroundClassName: 'garage-location',
			arrowStyle: 0,
			disableAutoPan:true
		}),marker=config.marker,points=config.points;

		//var infoWindow = new google.maps.InfoWindow({
		//	content: content
		//});
		var ths=this
		/**
		 * Description
		 * @method show
		 * @param {} map
		 * @param {} marker
		 * @param {} content
		 * @param {} onclick
		 * @return ThisExpression
		 */
		infoWindow.show=function(map,marker,content,onclick){
			if (ths.previousInfoWindow) {
				ths.previousInfoWindow.close();
			}
			this.open(map,marker||undefined)
			if(onclick){
				setTimeout(
					function(){
						 [].slice.call(document.querySelectorAll(".garage-location .item-wrap:not(.listener-added)")).forEach(
							function(el){
								el.classList.add("listener-added")
								el.addEventListener("click",onclick);
							}
						);

					},100
				)
			}
			content && this.setContent(content);
			ths.previousInfoWindow = this
			return this
		}

		if (!marker && points&& points.length>=4) {
			var point = toGLatLng([(points[0] + points[2]) / 2, (points[1] + points[3]) / 2]);
			infoWindow.setPosition(point);
		} else if(points && points.lat){
			var point = toGLatLng(points);
			infoWindow.setPosition(point);
		}
		infoWindow.show(this._map,marker,null,config.onclick);
		return infoWindow;

	},
	/**
	 * Description
	 * @method showCircle
	 * @param {} config
	 * @param {} ondragend
	 * @return 
	 */
	showCircle:function(config,ondragend){
		if(!config && this["_circle" ]){
			this["_circle"].setMap(null);
			delete this["_circle" ];
			return
		}
		if(ondragend){config.draggable=true}
		if(this["_circle" ]){
			this["_circle"].setCenter(config.center)
			return
			//this["_circle" ].setMap(null)
		}
		config.className="map-circle"
		config.map=this._map,
		this["_circle" ]= new google.maps.Circle(config);
		if(ondragend){
			google.maps.event.addListener(this._circle, "dragend",ondragend)
		}
	},
	/**
	 * Description
	 * @method marker
	 * @param {} config
	 * @return marker
	 */
	marker:function(config){
		config=config||{}
		if(!config.latlng){return}
//icon: image
		if(config.ondragend){config.draggable=true}

		var gLatLng=toGLatLng(config.latlng)
		if(!gLatLng){
			return
		}
		/*var marker = new google.maps.Marker({
		 position: new google.maps.LatLng(latlng.lat, latlng.lng),
		 map: this._map,
		 icon:image,draggable:true,
		 label:  (content||"..")
		 });*/
		if(config.locKey=="closest"){
			config.color="orange"
			//config.offset=-3
		} else if(config.locKey=="best"){
			config.color="blue"
		} else if(config.locKey=="cheapest"){
			config.color="green"
			//config.offset=5
		}
		var isTarget=config.locKey=="target"
		var labeldiv=document.createElement("div") ,content=config.content
		var wd=isTarget?30:40,ht=isTarget?40:52
		labeldiv.style.minWidth= "22px";labeldiv.style.lineHeight="20px";
		labeldiv.style.textAlign="center";//labeldiv.style.backgroundColor="white"
		labeldiv.style.maxHeight=ht+"px";
		labeldiv.style.overflow="hidden";
		labeldiv.className="map-label-content"
		if(config.offset){
			labeldiv.style.textIndent=config.offset+"px"
		}
		//labeldiv.style.color=config.color;
		labeldiv.style.zIndex=isTarget?2:1
		labeldiv.innerHTML="&nbsp;"
		var C={}

		var imgurl= config.imgurl,
			url//=RotateIcon.makeIcon( imgurl).setRotation({deg: 12}).getUrl()
		 url=imgurl
		var image = {
			 url: url,
			size: new google.maps.Size(parseInt(wd), parseInt(ht),"px","px"),// This marker is 20 pixels wide by 32 pixels tall.
			origin: new google.maps.Point(parseFloat(0),parseFloat(0))//,// The origin for this image is 0,0.
			//anchor: new google.maps.Point(parseFloat(wd/2), parseFloat(ht)  )// The anchor for this image is the base of the flagpole at 0,32.
		};


		var marker = new  MarkerWithLabel({
			position: gLatLng,
			title:gLatLng.toString(),
			map: this._map,
			icon:image,
			draggable:!!config.draggable,
			labelContent:  labeldiv,
 			labelAnchor: new google.maps.Point(parseFloat(12+(config.offset||0)), parseFloat(40)  ),
			labelClass: "map-labels", // the CSS class for the label
			//labelStyle:{border:"1px solid red"},
			//labelInBackground: true,
			zIndex:isTarget?10:1
		});
		var impl=this;
if(!config.noanimation){
	marker.setAnimation(google.maps.Animation.DROP);
}
		/**
		 * Description
		 * @method blur
		 * @param {} opacity
		 * @return 
		 */
		marker.blur=function(opacity){
			if(this._infoWindow){
				this._infoWindow.setMap(null)
			}
			if(this.labelContent && this.labelContent.parentNode && this.labelContent.parentNode.style){
				this.labelContent.parentNode.style.opacity=(opacity||.3)
			}
		}
		/**
		 * Description
		 * @method unblur
		 * @param {} opacity
		 * @return 
		 */
		marker.unblur=function(opacity){

			if(this.labelContent && this.labelContent.parentNode && this.labelContent.parentNode.style){
				this.labelContent.parentNode.style.opacity=1
			}
			if(this.__image){

			}
		}
		/**
		 * Description
		 * @method showPopUp
		 * @param {} content
		 * @param {} config
		 * @return MemberExpression
		 */
		marker.showPopUp=function(content,config){
			config=config||{}
			if(!this._infoWindow){config.marker=this
				this._infoWindow=impl.popUp(content,config)
			}
			else {
				this._infoWindow.show(this._map,this,content,config.onclick)
			}
			return this._infoWindow

		}


		/**
		 * Description
		 * @method remove
		 * @return 
		 */
		marker.remove=function(){
			this.hide();
			if(this._infoWindow){
				this._infoWindow.setMap(null)
			}
			this.setMap(null)
		}
		/**
		 * Description
		 * @method hide
		 * @return 
		 */
		marker.hide=function(){
			if (impl.previousInfoWindow && impl.previousInfoWindow==this._infoWindow) {
				this._infoWindow.close();
				impl.previousInfoWindow=null;
			}
			if(impl._directionsDisplay){
				impl._directionsDisplay.setMap(null)
				impl._directionsDisplay=null;
			}
			this.setVisible(false);
		}
		/**
		 * Description
		 * @method updateUI
		 * @param {} latlng
		 * @param {} content
		 * @return 
		 */
		marker.updateUI=function(latlng,content){
			this.setVisible(true);
			var glt
			if(latlng  ){
				glt=toGLatLng(latlng)
				if(!(glt && glt.lat)){
					console.log("invalid latlng",latlng)
					glt =null
				}

				glt && this.setPosition(glt)
			}
			if(content){
				var lbl=""
				if(typeof(content)=="string"){
					lbl=content

				} else if(typeof(content)=="function"){
					lbl=content();
				}
				if(this.labelContent  ){
					this.labelContent.innerHTML=lbl=="?"?"&nbsp;":lbl
					//this.label.setContent(lbl)
				} else{
					this.setLabel(lbl)
				}
			}
			if(this._infoWindow){
				try{
					this._infoWindow.close()
					impl.previousInfoWindow=null;
				} catch(e){}
			}
		}
		if(config.onclick) {
			google.maps.event.addListener(marker, 'click', function (e) {
				config.onclick(e)
			});
		}
		if(config.ondragend){
			google.maps.event.addListener(marker, 'dragend', function (e) {
				if(!e.latLng){return}
				config.ondragend({latlng:toLatLng(e.latLng)} )
			});
		}

		//self.markers[latlng.toString()].setMap(this._map);

		return marker
	}
};
/*
google.maps.Marker.prototype.animateTo = function(position, options) {
	defaultOptions = {
		duration: 1000,
		easing: 'linear',
		complete: null
	}
	options = options || {};
	var newPosition=toGLatLng(position)
	// complete missing options
	for (key in defaultOptions) {
		options[key] = options[key] || defaultOptions[key];
	}

	// throw exception if easing function doesn't exist
	if (options.easing != 'linear') {
		if (typeof jQuery == 'undefined' || !jQuery.easing[options.easing]) {
			throw '"' + options.easing + '" easing function doesn\'t exist. Include jQuery and/or the jQuery easing plugin and use the right function name.';
			return;
		}
	}

	window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
	window.cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame;

	// save current position. prefixed to avoid name collisions. separate for lat/lng to avoid calling lat()/lng() in every frame
	this.AT_startPosition_lat = this.getPosition().lat();
	this.AT_startPosition_lng = this.getPosition().lng();

	var	newPosition_lat = newPosition.lat();
	var newPosition_lng = newPosition.lng();

	// crossing the 180� meridian and going the long way around the earth?
	if (Math.abs(newPosition_lng - this.AT_startPosition_lng) > 180) {
		if (newPosition_lng > this.AT_startPosition_lng) {
			newPosition_lng -= 360;
		} else {
			newPosition_lng += 360;
		}
	}

	var animateStep = function(marker, startTime) {
		var ellapsedTime = (new Date()).getTime() - startTime;
		var durationRatio = ellapsedTime / options.duration; // 0 - 1
		var easingDurationRatio = durationRatio;

		// use jQuery easing if it's not linear
		if (options.easing !== 'linear') {
			easingDurationRatio = jQuery.easing[options.easing](durationRatio, ellapsedTime, 0, 1, options.duration);
		}

		if (durationRatio < 1) {
			var deltaPosition = new google.maps.LatLng( marker.AT_startPosition_lat + (newPosition_lat - marker.AT_startPosition_lat)*easingDurationRatio,
				marker.AT_startPosition_lng + (newPosition_lng - marker.AT_startPosition_lng)*easingDurationRatio);
			marker.setPosition(deltaPosition);

			// use requestAnimationFrame if it exists on this browser. If not, use setTimeout with ~60 fps
			if (window.requestAnimationFrame) {
				marker.AT_animationHandler = window.requestAnimationFrame(function() {animateStep(marker, startTime)});
			} else {
				marker.AT_animationHandler = setTimeout(function() {animateStep(marker, startTime)}, 17);
			}

		} else {

			marker.setPosition(newPosition);

			if (typeof options.complete === 'function') {
				options.complete();
			}

		}
	}

	// stop possibly running animation
	if (window.cancelAnimationFrame) {
		window.cancelAnimationFrame(this.AT_animationHandler);
	} else {
		clearTimeout(this.AT_animationHandler);
	}

	animateStep(this, (new Date()).getTime());
}*/
module.exports=GoogMap
}
__bootstrap__.modules["common/layoutHelper"] = function(module){
/**
 * Created by Atul on 9/1/2015.
 * @method layoutHelper
 * @param {} app
 * @return 
 */
function layoutHelper(app) {
	$d._util.documentVisibility(function (vis) {
		if ($.browser.hostedApp) {
			if (vis) {
				var ts = +(new Date())
				var lastts = Data.cookie.get("_ts_")
				//if more than 5 mins than refresh page
				if (lastts && (ts - Number(lastts)) > (1000 * 60 * 60 * 5)) {
					Data.cookie.set("_ts_", null);
					location.reload()
				}

			} else {
				Data.cookie.set("_lp_", app.router.getCurrentPath())
				Data.cookie.set("_ts_", String(+(new Date())))
			}
		}

	});

//hackish way to control layout
	if ($.browser.ie) {
		$d(document.body).addClass("noselection")
	}
	;
	(function (app) {
		var dochkvh = 1, dochkcalc = 1, dochkcalcvh = 0, timer = 0, defvw

		/**
		 * Description
		 * @method isvis
		 * @param {} el
		 * @return BinaryExpression
		 */
		function isvis(el) {
			return (el && el.offsetHeight + el.offsetWidth + el.offsetTop + el.offsetLeft) > 0
		}

		/**
		 * Description
		 * @method chk1
		 * @return 
		 */
		function chk1() {
			onendtimer = 0;
			chk(true)
		}

		var _cntr = 0

		/**
		 * Description
		 * @method chk
		 * @param {} chkvis
		 * @return 
		 */
		function chk(chkvis) {

			timer = 0;
			var vp = {}
			try {
				vp = $.viewport
			} catch (r) {
			}
			var tophdr = document.querySelector(".top-header"), ht = vp.height, wd = vp.width

			defvw || (defvw = document.defaultView);

			if (!(ht>100 && tophdr )) {
				setTimeout(chk,1500);
				return
			}
			;

			var hdrht = tophdr.offsetHeight;
			var diff = Math.abs((tophdr.offsetLeft + tophdr.offsetWidth) - wd);
			//$d.html(".app-out-msg",(++_cntr)+" "+wd+" "+tophdr.offsetWidth+" "+ht+" "+window.innerHeight)
			if (diff > 4) {
				tophdr.style.left = "0";
				if (Math.abs(tophdr.offsetWidth - wd) > 5) {
					diff = wd;
					tophdr.style.width = wd + "px";
				}

			}
			;
			[].forEach.call(document.querySelectorAll(".fit-vp-content"), function (el) {
					if (chkvis === true && !isvis(el)) {
						return
					}
					el.style.height = (ht - Math.max(el.offsetTop, hdrht)) + "px";
					var diffH = (el.offsetTop + el.offsetHeight) - ht
					if (diffH > 1) {
						el.style.height = (el.offsetHeight - diffH) + "px";
					}
					var diff = (el.offsetLeft + el.offsetWidth) - wd
					if (diff > 1) {
						el.style.left = "1px";
						if (el.offsetWidth > wd) {
							diff = (el.offsetWidth - wd);
							el.style.width = (el.offsetWidth - diff) + "px";
						}

					}
					if (defvw && defvw.getComputedStyle(el).display != "block") {


					}

				}
			);
			[].forEach.call(document.querySelectorAll(".fit-vp-height"), function (el) {
					if (chkvis === true && !isvis(el)) {
						return
					}
					el.style.minHeight = (ht - hdrht) + "px";
				}
			);
			[].forEach.call(document.querySelectorAll(".fill-container"), function (el) {
					if (chkvis === true && !isvis(el)) {
						return
					}

					var par = el.offsetParent || el.parentNode
					if (par && par.clientHeight > 10) {
						el.style.height = (par.clientHeight - el.offsetTop) + "px";
					}

				}
			)
		}

		var vp = {}
		try {
			vp = $.viewport
		} catch (r) {
		}
		var ht = vp.height, wd = vp.width, userAgent = navigator.userAgent;
		;

		var chromever = Number((userAgent.match(/Chrome\/(\d+)/) || [])[1] || "0");
		var issafari = (/safari/i.test(userAgent) && !/chrome/i.test(userAgent))
		if (issafari || (chromever && chromever <= 35) || userAgent.match(/ipad|iphone|mobile/i)) {
			dochkvh = 1;
			dochkcalc = 1;
		} else {
			var vhcheck = document.getElementById("vhcheck")
			var calccheck = document.getElementById("calccheck")
			var calccheckvh = document.getElementById("calccheckvh")
			if ((vhcheck && Math.abs(vhcheck.offsetHeight - ht) < 20)) {
				dochkvh = 0
			}
			if ((calccheck && Math.abs(ht - calccheck.offsetHeight) < 10)) {
				dochkcalc = 0
			}
			if ((calccheckvh && Math.abs(calccheckvh.offsetHeight - ht) < 30)) {
				dochkcalcvh = 0
			}
		}

		calccheck && calccheck.parentNode.removeChild(calccheck);
		vhcheck && vhcheck.parentNode.removeChild(vhcheck);
		calccheckvh && calccheckvh.parentNode.removeChild(calccheckvh);
		window.__chkht = function () {
		};

		if (dochkvh || dochkcalc || dochkcalcvh) {
			//$d.html(".app-out-msg","1")
			var onendtimer = 0
			vp.on(chk);
			window.__chkht = chk
			setTimeout(chk, 100)
			onendtimer = setInterval(chk1, 5000)
		}

	})(app);

	(function setupScrollCheck(app){
		var cntr = 0;
		/**
		 * Description
		 * @method scrollcheck
		 * @return 
		 */
		function scrollcheck() {
			if (app.noscroll) {
				setTimeout(scrollcheck, 5000);
				return
			}
			cntr++
			var vp = $.viewport, docele = document.documentElement
			var curr = $d.css(docele, "overflow-y"), diff = (docele.scrollHeight - vp.height), nexttime = 5000
			if (curr == "auto" && diff < 24) {
				docele.style.overflowY = "hidden";
				nexttime = cntr > 4 ? 5000 : 2000
			} else if (diff > 24) {
				docele.style.overflowY = "auto"
			}

			curr = $d.css(docele, "overflow-x");
			diff = (docele.scrollWidth - vp.width)
			if (curr == "auto" && diff < 24) {
				if (diff < 24) {
					docele.style.overflowX = "hidden"
				}
				nexttime = cntr > 4 ? 5000 : 2000
			} else if (diff > 24) {
				docele.style.overflowX = "auto"
			}
			setTimeout(scrollcheck, nexttime )
		}
		$.viewport.on( scrollcheck )
		setTimeout(scrollcheck, 100)
		app.on("viewchanged", function () {
			$.require("PopupView").hideAll()
			cntr=0;
			setTimeout(scrollcheck,100)
		});
	})(app);
}
module.exports=layoutHelper;
}
__bootstrap__.modules["common/LocationAddress"] = function(module){
var LocationIO=$.require("common/LocationIO")
var addressparts={
    street_number: ["streetNumber"],
    street:["streetaddress","route"],
    neighborhood: null,
    borrough: ["sublocality_level_1"],
    city: ["locality","adminName1"],
    county: ["administrative_area_level_2"],
    addressstate: ["administrative_area_level_1","adminName2","state"],
    country:["countryCode"],
    zip:["zipcode","postalcode","postalCode","postal_code"],

}
var _cache={};
/**
 * Description
 * @method trimstr
 * @param {} s
 * @return CallExpression
 */
function trimstr(s){
    return String(s||"").trim()
}
var LocationAddress= $.model.make(
    "LocationAddress",
    {   address:null,
        "street_number":null,"street":null,"neighborhood":null,"borrough":null,"city":null,county:null,addressstate:null,country:null,zip:null,lat:null,lng:null,
        streetaddress: {descriptor: true, expr: "$street_number $street"},
        citystate: {descriptor: true, expr: "$city $addressstate $zip"},
        resolvedAddress:null
    },
    {
        /**
         * Description
         * @method initModelInstance
         * @return 
         */
        initModelInstance:function(){
            this.__addressresolve||(this.__addressresolve=$.persistentPromise());
            this.parseAddress();
        },
        /**
         * Description
         * @method whenAvailable
         * @param {} callback
         * @return 
         */
        whenAvailable:function(callback){
            if(this.isValid()){
                callback(this)
                return
            }
            this.__addressresolve.then(callback)
        },
        /**
         * Description
         * @method isValid
         * @return UnaryExpression
         */
        isValid:function(){
            return !!this.__valid
        },
        /**
         * Description
         * @method clearValues
         * @return 
         */
        clearValues:function(){
         },
        /**
         * Description
         * @method clear
         * @return ThisExpression
         */
        clear:function(){
            this.__addressresolve.reset();
            $.each(addressparts,function(alias,name){
                this.setItem(name, null);
            },this);
            this.lng=this.lat=this.address=null;
            this.__valid=false;
            return this;
        },
        /**
         * Description
         * @method checkValidity
         * @return AssignmentExpression
         */
        checkValidity:function(){
            return this.__valid = !!((this.street || this.street_number)&& this.city)
         },
        /**
         * Description
         * @method isSame
         * @param {} address
         * @return 
         */
        isSame:function(address){if(!address){return false}
            var locationAddress = new LocationAddress();
            locationAddress.parseAddress(address,true);
            if((locationAddress.streetaddress && locationAddress.streetaddress===this.streetaddress) || (locationAddress.lat && locationAddress.lat===this.lat&& locationAddress.lng===this.lng) ){
                return true
            }
        },
        /**
         * Description
         * @method parseAddress
         * @param {} address
         * @param {} noresolve
         * @return ThisExpression
         */
        parseAddress:function(address,noresolve){
            var add={},old=this.citystate;

            var lat,lng
            if(address && address.latlng){
                lat=address.latlng.lat
                lng=address.latlng.lng
            } else  if(address && address.lat && address.lng) {
                lat=address.lat
                lng=address.lng
            }
            this.checkValidity()
            if(this.isValid() && this.isSame(address)){
                    return this
            }

             if(address !== undefined){
                 this.address=address
                $.each(addressparts,function(alias,name){
                    add[name]="" ;
                },this)
                if(!noresolve){
                    //this.__addressresolve.reset();
                }
            }
             var addressdata
            addressdata=this.address
            if(addressdata && typeof(addressdata)=="object" && "address" in addressdata){addressdata=addressdata.address}
            if(typeof(addressdata)=="string"){
                var parts1=addressdata.split(/\s+/),last,counter=0
                if ((last = parts1[parts1.length - 1]) && last.length >= 5 && /^[\d]+(\-[\d]+)?$/.test(last)) {
                    add.zip = parts1.pop()
                    addressdata=parts1.join(" ");
                }
                parts1=addressdata.split(/\s*,\s*/)
                while(parts1.length && counter<10) {
                    counter++
                    if (!add.zip && (last = parts1[parts1.length - 1]) && last.length >= 6 && /^[\d]+(\-[\d]+)?$/.test(last)) {
                        add.zip = parts1.pop()
                    }

                    if (!add.country && (last = parts1[parts1.length - 1]) && (last.toLowerCase() === "us" || last.toLowerCase() === "united states")) {
                        add.country = parts1.pop()
                    }
                    if (!add.addressstate && (last = parts1[parts1.length - 1]) && (last.toLowerCase() === "ny" || last.toLowerCase() === "new york")) {
                        add.addressstate = parts1.pop()
                    }
                    if (!add.city && (last = parts1[parts1.length - 1]) && (last.toLowerCase() === "nyc" || last.toLowerCase() === "new york city")) {
                        add.city = parts1.pop()
                    }
                    if (!add.street && (last = parts1[parts1.length - 1]) && (/\bst\b/.test(last.toLowerCase()) || /\bstreet\b/.test(last.toLowerCase()) || (/\bav\b/.test(last.toLowerCase())) || (/\bave\b/.test(last.toLowerCase())) || (/\bavenue\b/.test(last.toLowerCase())))) {
                        add.street = parts1.pop()
                        if (/^\d+\D/.test(add.street)) {
                            add.streetnumber = add.street.match(/^\d+\D/)[0].trim()
                        }
                    }
                }
                if (parts1.length==1 && !add.street) {
                    add.street = parts1.shift()
                }
                if(parts1.length){
                    var parts=parts1;
                    if(parts.length && !add.street){add.street=parts.shift();}
                    if(parts.length && !add.city){add.city=parts.shift();}
                    if(parts.length && !add.country){add.country=parts.shift();}
                    if(parts.length && !add.addressstate){add.addressstate=parts.shift();}
                    if(add.addressstate && !add.zip){
                        add.addressstate=(add.addressstate+" ").replace(/\s+([\d\-]+)\s+/,function(a,b){
                            add.zip=b;return"";
                        }).trim()
                    };
                }

            } else if($.isPlain(addressdata)){
                $.each(addressparts,function(alias,name){
                    var ky=name
                    if(alias && !addressdata[name]){
                        ky=alias.find(function(a){return addressdata[a]})
                    }
                    if(ky && addressdata[ky]){
                        add[name]= addressdata[ky]
                    }
                });
            }

            if(lat) {
                this.lat = lat
                this.lng = lng
            }

            this.update(add)
            ;this.checkValidity()
            if(!this.isValid() && !noresolve && lat){
                this.resolveLocation({lat: lat, lng: lng})
                return  this;
            }
            if(this.isValid()){
                 this.recalcAll()
                var nu=this.toMap();
                delete nu.address;
                if(nu.lat && nu.lng){
                    _cache[nu.lat +"," +nu.lng]=nu;
                }
                var hc=$.hashCode(nu)
                this.resolvedAddress=nu;
                this.__addressresolve.resolve(this) ;
            }
            return this;
        },
        /**
         * Description
         * @method resolveLocation
         * @param {} latlng
         * @return CallExpression
         */
        resolveLocation:function(latlng){
            return LocationIO.resolveLocation(
                latlng,function(a){this.parseAddress(a,true)}.bind(this)
            );
        }
    }


)
/**
 * Description
 * @method parse
 * @param {} address
 * @return nu
 */
LocationAddress.parse=function(address){

    var data=null
    if(address) {
        if (address.lat && address.lng) {
            if (_cache[address.lat + "," + address.lng]) {
                data = _cache[nu.lat + "," + nu.lng]
            }
        } else if (address.latlng) {
            if (_cache[address.latlng.lat + "," + address.latlng.lng]) {
                data = _cache[address.latlng.lat + "," + address.latlng.lng]
            }
        }
    }
    var nu=new LocationAddress();
    if(data){
        nu.readRecord(data)
    } else{
        address && nu.parseAddress(address)
    }
    return nu
}
module.exports=LocationAddress
}
__bootstrap__.modules["common/LocationIO"] = function(module){
/**
 * Created by Atul on 5/15/2015.
 */
var LocationIO={
    _cache:{},
    _parseRes:function(){

    },
    /**
     * Description
     * @method resolveLocation
     * @param {} latlng
     * @param {} callback
     * @return MemberExpression
     */
    resolveLocation:function(latlng,callback){
        var ky=latlng.lat+","+latlng.lng,io=this;
        if(io._cache[ky] && io._cache[ky].then){
            io._cache[ky].then(callback);
            return
        }
        io._cache[ky]=Promise.deferred();
        var lt={lat: latlng.lat, lng: latlng.lng}
        var optns = {}//{args: lt} //type: "app", cmd: "getaddress",
        optns.callback = $.fn.curry(function (id,latlng,a,err) {
            if(err){console.log("resolveLocation",latlng,err)}
            if (a && a.data) {
                a = a.data
            }
            if (a && a.response) {
                a = a.response
            }
            if (!(a && a.address)) {
                if (a && a.status && a.status.message) {
                    app.splash && app.splash(String(a.status.message).replace(/atul/g, "---"))
                }
                return
            }
            a.latlng=latlng;
            io._cache[id] && io._cache[id].resolve(a)
        },ky,lt);
        $.xhr.jsonp("http://api.geonames.org/findNearestAddressJSON?lat="+lt.lat+"&lng="+lt.lng+"&username=atulny",optns.callback,"callback")
        //$.xhr.get(app.servicePath, optns)
        if(callback){io._cache[ky].then(callback)}
        return io._cache[ky];
    }
}

module.exports=LocationIO
}
__bootstrap__.modules["common/MapLocationService"] = function(module){
/**
 * Created by Atul on 8/5/2015.
 */

var MapLocationService={
	//finds cheapest best and closest locations
	/**
	 * Description
	 * @method findFacilities
	 * @param {} targetloc
	 * @return 
	 */
	findFacilities:function(targetloc){

	}

}

module.exports=MapLocationService;
}
__bootstrap__.modules["common/metaTemplates"] = function(module){
var metatemplates={
	garagemeta:
		[
			{"name":"id","type":"number"},
			{"name":"facility_ratesid",hidden:true},
			{"name":"effective_date",hidden:true},
			{"name":"halfhour",width:80,label:"Half Hour"},
			{"name":"hour_1",width:80,label:"1st Hour"},
			{"name":"hour_2",width:80,label:"2 Hours"},
			{"name":"hour_10",width:80,label:"10 Hours"},
			{"name":"hour_24",width:80,label:"24 Hours"},
			{"name":"early_bird",width:80},
			{"name":"evening",width:80},
			{"name":"sat_sun",width:80},
			{"name":"monthly",width:80},
			{"name":"weekly",width:80},
			{"name":"oversize_addtnl",width:80},
			{"name":"name","type":"string",width:700,label:"_",wrapklass:"profilelabel"},
			{"name":"asset_thumbs",iptype:"img",type:"img",label:"_",width:100,height:100, wrapklass:"profileimage"},
			{"name":"gstatus_id","type":"int",wrapklass:"",label:"Status",width:100,
				bindrule:{property:"background-color",value:"it.value  =='1'?'green':'red'"},
				format:{
/**
 * Description
 * @method fn
 * @param {} a
 * @return CallExpression
 */
fn:function(a){return String(a).replace(/^\w/,function(a){return a.toUpperCase()})}}
			},
			{"name":"lat","type":"decimal",width:80,labelwidth:90,wrapklass:"",label:"Lat Lng"},
			{"name":"lng",wrapklass:"","type":"decimal",labelwidth:5,width:60,label:"/",wrapstyle:{marginLeft:0}},
			{"name":"is_open","type":"boolean",width:80},
			{"name":"region_id","type":"int"},
			{"name":"hrs_id","type":"int", 
/**
  * Description
  * @param {} v
  * @return ConditionalExpression
  */
 "reader":function(v){return Array.isArray(v)?v.join(', '):(v||'')}},
			{"name":"operator_id","type":"int" },
			{"name":"zip","type":"string",width:80},
			{"name":"pmt_type_id","type":"string"},
			{"name":"spaces_total","type":"number",width:80},
			{"name":"rate_model_id","type":"number",hidden:true,width:120},

			{"name":"calculated_rates","type":"string"  ,
/**
 * Description
 * @param {} v1
 * @return ConditionalExpression
 */
"reader":function(v1){var v=v1
				if(typeof(v)=='string'&&( v.charAt(0)=='['||v.charAt(0)=='{')){
					try{
						if(/=\w/.test(v)){v=v1.replace(/=(\w)/g,':$1').replace(/:([^,\}]+)/g,':"$1"') }
						v=(1,eval)(v)
					}catch(e){v=v1}
				}
				return Array.isArray(v)?v.map(function ff(it){var v=it;if(!it){return ''}
					return ((it&&it.quoted_duration)?('$' + it.rate_cost+' / '+(String(it.quoted_duration).replace(/[:0]/g,'') + ' hr(s)')):'')
				}).join(', '): ( v||'')
			} },
			{"name":"space_type_id","type":"string"},
			{"name":"facilityformat_id","type":"int"},
			{"name":"phone","type":"string"},
			{"name":"address","type":"string"}

		] ,
	vehicle_types:{}
}
module.exports=metatemplates
}
__bootstrap__.modules["common/PriceDescription"] = function(module){
var PopupView =$.require("PopupView")

var PriceDescription=$.createClass( {


	/**
	 * Description
	 * @method show
	 * @param {} target
	 * @param {} model
	 * @return 
	 */
	show: function(target,model) {
		var content=String(model.pricing.rateDescription).split(/\n/).map(function(a){return a.split(":").map(function(b,i){
			return "<span style='display:inline-block;"+(i==0?"width:100px;overflow;hidden;":"width:40px;text-align:right;")+"'>"+b+"</span>"
		}).join("")}).join("")
		this.vw=new PopupView({width:160,anchor: target,alignAnchor:"below",content:content,destroyonhide:true})
		this.vw.show()
	}
});

module.exports=PriceDescription;
}
__bootstrap__.modules["common/ReserveCardView"] = function(module){
var ReserveModel=$.require("models/ReserveModel")
var  GeoMap= $.require("common/GeoMap")
var browserGeoLocation=$.require("common/BrowserGeoLocation");
var PopupView=$.require("PopupView");
var containermap={},model
function _showMap(model,el,optns) {

    if(!model.facility){
        app.splashError("no fac")
        return
    }

    var geoMap=model.geoMap,
        record=model.facility.record

    if(!(record && record.lat  && record.lng)) {
        return
    }

    if(!geoMap) {

        geoMap=model.geoMap = new GeoMap({container: el });
        geoMap.setup()
        var currlatlng=browserGeoLocation.getCurrent()
        if((currlatlng && currlatlng.lat && currlatlng.lng) ) {
            geoMap.getTargetLocation().latlng=currlatlng
        }
        browserGeoLocation.onChange(
            function(latlng){
                if(latlng && latlng.lat && latlng.lng && geoMap.container && geoMap.container.isVisible(true)) {
                    geoMap.getTargetLocation().latlng=latlng
                }
            }
        )
    }
    if(!geoMap){return}

    if(!geoMap.isready){
        geoMap.on("ready",_showMap.bind(this,model,el,optns));
        geoMap.checkReadyState()
    }
    else {
        if(!model.mylocation){
            model.mylocation=geoMap.addLocation( )
            model.mylocation.latlng={lat:record.lat,lng:record.lng}
            model.mylocation.addMarker({className: "my-location", title: "My Location" });
            model.mylocation.updateUI( )
            model.mylocation.drawPath()
        }

        geoMap.updateView(  )
        geoMap.toggleLoader(false);
        setTimeout(
            function(){
                this.centerOnNextLocation=true
            }.bind(geoMap),600
        )

    }
}
/**
 * Description
 * @method ensureBarCode
 * @param {} notimer
 * @return 
 */
function ensureBarCode(notimer) {
    var dom=this.container
    if(!this.options || !(dom && dom.q(".user-bar-code"))){return}
    if(this.options.showBarCode==null){
        this.options.showBarCode=true
    }
    if( this.options.showBarCode) {
        dom.q(".user-bar-code").show()
        if (dom.q(".user-bar-code img")) {
            return
        }

        if (this.userVehicle && this.userVehicle.barcode) {
            this.userVehicle.drawBarCode && this.userVehicle.drawBarCode(dom.q(".user-bar-code"))
        }
    } else {
        dom.q(".user-bar-code").hide()
    }
}
/**
 * Description
 * @method afterShow
 * @return 
 */
function afterShow() {
    var locmap,optns=this.options,containerVw=this.containerVw,container=this.container
    if(container){
        locmap=container.q(".loc-map")
        if(locmap){
            if(optns.showmap){
                 locmap.show()
                _showMap(this,locmap,optns)

            } else {
                locmap.hide()
            }
            containerVw && containerVw.layout()
        }

        setTimeout(ensureBarCode.bind(this),100)
    }
}
/**
 * Description
 * @method showCard
 * @param {} optns
 * @param {} vwmodel
 * @return model
 */
function showCard(optns,vwmodel) {
    var data = optns.record
    var dom=$d(optns.container)
    var model=new ReserveModel()
    if(vwmodel){
        model.readModel(vwmodel)
    }
    model.options=optns||{}
    if(!dom) {
        var vwoptns = $.extend({
            anchor: $d(optns.anchor),
            animateShow: false,
            //animateHide: {anchor: "c", duration: 200},
            anchorPos: optns.anchor?"pointer":null,draggable:true,
            destroyonhide: true,
            showcancellink:true,
            width: 320,
            title:optns.title,
            minHeight:200
        }, optns.viewoptions || {})

        var containerVw = new PopupView(vwoptns)
        containerVw.$content().css("overflow", "auto")
        optns.id && (containermap[optns.id] = containerVw);
        containerVw.observer.on("aftershow",function(a){
            setTimeout(afterShow.bind(this),500)
        }.bind(model))
        containerVw.show();
        model.container=containerVw.$content()
    } else{
        model.container=dom
    }

    if(!data.duration_type){data.duration_type="h"}
    if(data) {
        if (data.schedule) {
            model.readModel(data);
        }
        else {
            model.readRecord(data);
        }
    }

    if(!model.allresolved){

        model.onchange("allresolved",function(){
            var id=this.userVehicle.id;
            if(id && !this.userVehicle.barcode){
                this.userVehicle.load(id).then(ensureBarCode.bind(this))
            }

        },{once:true})
    }

    if(containerVw){


        containerVw.config.anchor = optns.anchor
        dom=containerVw.$content()
    }
    //??

    //alert(model.schedule.pricing.get("duration"))

    // alert(data.model)
var template=optns.template||(optns.showreceipt?"receipt.html":"reservecard2.html")
    if(optns.template=="receipt"){
        optns.showreceipt=true;
    }
    var pv = $.partialview(template)

    //var model = data.makeModel(true)
    model.setItem("elem", dom.id)
    model.setItem("tmzot", ((new Date()).getTimezoneOffset()))
    dom.clear();
    model.bindRecalc(true);
    /**
     * Description
     * @method hideView
     * @return 
     */
    model.hideView=function(){

        if(this.containerVw){
            this.containerVw.hide()
        } else if(this.container){

        }
    };
    model.containerVw=containerVw;

    /**
     * Description
     * @method refreshServices
     * @param {} reload
     * @return 
     */
    model.refreshServices=function(reload){
        if(reload===true){
            app.remoteDirective("reserveinfo",{reserve_id:this.reserve_id},function(data){
                data=data.data||data
                this.extraServices.parse(data.reserve_extra_extras)
                this.refreshServices()
            }.bind(this))
            return
        }
        var dom=this.containerVw?this.containerVw.$content():this.container
        if(!dom){return}

         var servicesinfo=dom.q(".facility-services-info .srvc-items");
        if(servicesinfo && this.extraServices){

             var html=this.extraServices.getListContent()
            if(!html){
                servicesinfo.parent().hide()
            } else{servicesinfo.parent().show()}
            servicesinfo.html( html )
            if(model.isCheckedOut()){
                servicesinfo.qq('.srvc-cancel').hide()
            } else{
                servicesinfo.on("click.cancel",function(ev,el){
                    var it=el.up(".srvc-item")
                    if(it){
                        this.extraServices.removeExtra(it.domdata("key"),function(){
                            this.refreshServices();
                        }.bind(this))

                    }
                }.bind(this),'.srvc-cancel')
            }

        }

    }


    /**
     * Description
     * @method hideOnBlur
     * @param {} hide
     * @return 
     */
    model.hideOnBlur=function(hide){
        if(this.containerVw){
            //this.containerVw.config.hideOnBlur=!!hide
        }

    }
    /**
     * Description
     * @method getEl
     * @return LogicalExpression
     */
    model.getEl=function(){
        return (this.containerVw && this.containerVw.el)||this.container
    }
    var showMap=_showMap.bind(model)
    var _self=model

    pv.appendTo(dom).then(function () {
            if(containerVw){
                //dom.css("overflow-x","hidden").append("div.top-right-cancel").on("click",function(){this.hide()}.bind(containerVw||dom))
            }

            var locmap=dom.q(".loc-map") ;
            if(locmap){
                if( optns.showmap){
                    locmap.show()
                }
            }
            if(optns.showBarCode){
                var barcode=dom.q(".user-bar-code") ;
                barcode && barcode.show()
             }

            if(containerVw && optns.showOptions) {
                var email = model.user.email, phone = model.user.phonenumber
                dom.prepend("<div class='check-opts'><span class='print opt'>Print</span><span class='email opt'>Email</span><span class='pdf opt'>Pdf</span><span class='text opt'>Text</span></div>")
                dom.q(".check-opts .print").on("click", function () {
                    $d.printEl(containerVw.$content(".view-content"), {border: "1px solid #777"})
                })
                dom.q(".check-opts .email").on("click", function (ev) {
                    var vw = new PopupView({
                        title: "Email Options",
                        anchor: ev.target, alignAnchor: "bl",
                        container: containerVw.$content(),
                        destroyonhide: true,
                        content: "<h5>Send an email to the following address</h5><input/><br/><br/>"
                    });

                    vw.addButton({
                        label: "Send", 
                        /**
                          * Description
                          * @method callback
                          * @param {} a
                          * @return
                          */
                         callback: function (a) {
                            var email=vw.$("input").val()||""
                            app.remoteDirective("sendemail",{targeturl:app.contextPath,email:email,tmzot1:(new Date()).getTimezoneOffset(),reservenum:model.reservenum,mode:optns.showreceipt?"receipt":"claimcheck"})
                            app.splash("Email sent")
                            this.hide()
                        }
                    }).addButton({
                        label: "Cancel", 
                        /**
                          * Description
                          * @method callback
                          * @param {} a
                          * @return
                          */
                         callback: function (a) {
                            this.hide()
                        }
                    })
                    vw.show().$("input").val(email || "");
                });
                dom.q(".check-opts .pdf").on("click", function (ev) {
                    window.open(app.servicePath + "?dorender=pdf&targeturl=" + app.contextPath + "&reservenum=" + model.reservenum + "&mode="+(optns.showreceipt?"receipt":"claimcheck")+"&tmzot1="+((new Date()).getTimezoneOffset()))
                });
                dom.q(".check-opts .text").on("click", function (ev) {
                    var vw = new PopupView({
                        title: "Text message Options",
                        anchor: ev.target,
                        alignAnchor: "bl",
                        container: containerVw.$content(),
                        destroyonhide: true,
                        content: "<h5>Send a text message to the following number</h5><input/><br/><br/>"
                    });

                    vw.addButton({
                        label: "Send", 
                        /**
                          * Description
                          * @method callback
                          * @param {} a
                          * @return
                          */
                         callback: function (a) {
                            app.splash("Feature not yet available");
                            this.hide()
                        }
                    }).addButton({
                        label: "Cancel", 
                    /**
                      * Description
                      * @method callback
                      * @param {} a
                      * @return
                      */
                     callback: function (a) {
                            this.hide()
                        }
                    }).show().$("input").val(phone || "")
                })
            }
             var runningtime=dom.q(".running-time")
            if(runningtime) {
                model.schedule.setupDates();
                if (optns.showtimer && !model.isCheckedOut()) {
                    var end = model.isCheckedIn() ? model.schedule.reserveDateTimeEnd : model.schedule.reserveDateTime;
                    if (end) {
                        var endtime=+end,prefix = model.isCheckedIn() ? "Time to check-out" : "Time to check-in",pastprefix="Overdue"
                        model.addProperty("runningtime", "..")
                        var elem = runningtime.q(".running-time-message"),slider= runningtime.q(".running-time-slider"),total=(+model.schedule.reserveDateTimeEnd) - (+model.schedule.reserveDateTime)
                        model.onchange("runningtime", function (rec) {
                            if ($d.isAttached(runningtime)) {
                                var str=String(rec.value || "")
                                if(str.indexOf(pastprefix)>=0){
                                    $d.css(elem,"color","red")
                                } else{$d.css(elem,"color","black")}
                                if(this.isCheckedIn() && slider){
                                    var diff=Math.max(0,endtime - (+$.date()))
                                    slider.css("width", (Math.max(0,(total-diff)/total))* runningtime.width())
                                }
                                elem.html(str)
                            }
                        })
                        setTimeout(function comptime() {
                            model.runningtime = $.date().asDuration(end, prefix, pastprefix)
                            if ($d.isAttached(elem) && dom && dom.isVisible(true)) {
                                setTimeout(comptime, 30000)
                            }
                        }, 200);
                        runningtime.show()
                     } else {
                        runningtime.hide()
                    }
                }
            }


            if(optns.actions){var actions=[],mixin={}
                $.each(optns.actions,function(fn,nm){
                    if(!fn){return}
                    var ky=nm.replace(/[^\w]/g,"_").toLowerCase()
                    mixin[ky]=fn
                    actions.push('<button class="reserve-action" data-cmd="'+ky+'">'+ nm +'</button>')
                });
                var el=dom.q(".reserve-actions")
                if(el){el.html(actions.join(""))}
                model.getController().mixin(mixin)

            }
            model.digest(dom)
            model.refreshServices()
             if(!containerVw){
                setTimeout(afterShow.bind(model),500)
            } else{
                if(!containerVw.isVisible()){containerVw.show();}
                containerVw.layout();

                 containerVw.$content().css("opacity",.5).anim({opacity:1})
                 setTimeout(containerVw.layout.bind(containerVw),100)
             }



        }
    );
    return model
}

var ReserveCardView={
    /**
     * Description
     * @method show
     * @param {} optns
     * @param {} model
     * @return CallExpression
     */
    show:function(optns,model){
        optns=optns||{}
        return showCard(optns,model)
    }

    
}
module.exports=ReserveCardView
}
__bootstrap__.modules["common/ReserveCheckInCheckOut"] = function(module){
/**
 * Created by Atul on 6/5/2015.
 */
 var userutils=$.require("common/AppUtil")
var ScheduleModel= $.require("models/ScheduleModel")
var PopupView=$.require("PopupView");
var ReserveModel=$.require("models/ReserveModel")
var listitemtemplate="<li class='resstatus-item resstatus-item-$resstatusString $cancheckin $overlapmode' data-key='$reserve_id'>$resstatusString, $garagename , $vehicle <span class='resstatus-item-sched'>$reserveDateTime to  $reserveDateTimeEnd, $slotname</span><div class='act-links'><span class='select-reserve'>Select</span><span class='cancel-reserve'>Cancel</span></div></li>"
var hdrtemplate="<div class='hdr'><div class='user-fullname' style='font-size:2rem;'>$user.fullname</div><div class=''><span class='vehicle-label bold'>$userVehicle.vehicle_label</span> $userVehicle.vehicle_plate $userVehicle.vehicle_make $userVehicle.vehicle_model </div></div>"

/**
 * Description
 * @method dowalkinNonmember
 * @param {} plate
 * @param {} facility_id
 * @param {} callback
 * @return 
 */
function dowalkinNonmember(plate,facility_id,callback){
 	app.remoteDirective("findnonmember", {
			vehicle_plate:plate ,facility_id: facility_id,ensure:true

 	},function(data){
		if(data.id){
			data.nonmember_id=data.id;
			delete data.id
			callback(data);
		}
	})
 }



/**
 * Description
 * @method buildContentForcheckin
 * @param {} overlaps
 * @param {} hdr
 * @return html
 */
function buildContentForcheckin(overlaps,hdr){
	var html=[],activecheckin,nooverlaps

	if(overlaps.some(function(a){return a.isCheckedIn()})){
		html.push("<h3 class='checkin-error'>" + app.resolveMessage("PM-003") + "</h3>")
		activecheckin=true
	} else if(overlaps.some(function(a){return a.overlaps})){
		html.push("<h3 class='checkin-error'>" + app.resolveMessage("PM-007") + "</h3>")
	} else {
 		nooverlaps=true
 		html.push("<div class='noconflict-reserve'>Create new reservation<br/><span class='continue-reserve'>Continue</span></div>")
	}
	var htmlcntnt=buildOverLapHTML(null,overlaps,hdr,activecheckin,true);
	[].push.apply(html,htmlcntnt);
	return html;

}
/**
 * Description
 * @method buildContent
 * @param {} overlaps
 * @param {} hdr
 * @return html
 */
function buildOverLapHTML(model,overlaps,hdr,cancheckin,checkinmode){
	var html=[]
	if(typeof(listitemtemplate)=="string"){listitemtemplate= $.template(listitemtemplate)}
	var resData=overlaps.sort(function(a,b){return (+a.schedule.reserveDateTime) - (+b.schedule.reserveDateTime)})
		.map(
		function(a){
			a.schedule.setupDates()
			return {
				reserve_id: a.reserve_id,garagename:a.facilityname,vehicle:a.userVehicle.label,
				resstatusString: a.resstatusString,overlapmode:a.overlapmode,
				reserveDateTimeEnd: $.date.format(a.schedule.reserveDateTimeEnd,userutils.timeformat),
				slotname: a.reserveSlot.slotname,
				reserveDateTime: $.date.format(+a.schedule.reserveDateTime,userutils.datetimeformat),
				cancheckin:cancheckin
			}
		})
	html.push("<ul class='resstatus-list"+(checkinmode?" checkin-mode":"")+"'>")


	resData.forEach(function(a){  html.push(listitemtemplate(a))});
	html.push("</ul>")

	if(hdr!==false  && !(hdr && typeof(hdr)=="string") && model) {
		hdr= $.template(hdrtemplate)(model)
		hdr=hdr.replace(/null/g,"")

	}
	if(hdr && typeof(hdr)=="string"){
		html.unshift(hdr || "","<div class='message-body'>")
		html.push("</div></div>")
	}
	html.push("")
	return html;
}
function buildContent(overlaps,hdr){
	var html=[],activecheckin,nooverlaps
	if(overlaps.some(function(a){return  a.isCheckedIn()})){
		//html.push("<h3 class='checkin-error'>There is an active check-in.</h3>")
		activecheckin=true
	}
	if(overlaps.some(function(a){return a.overlaps})){
		html.push("<h3 class='checkin-error'>" + app.resolveMessage("PM-007") + "</h3>")
	} else {
		nooverlaps=true
		html.push("<div class='noconflict-reserve'>There are no overlaps.<br/><span class='continue-reserve'>Continue</span></div>")
	}
	var htmlcntnt=buildOverLapHTML(null,overlaps,hdr,activecheckin);
	 [].push.apply(html,htmlcntnt);
	return html;
}
/**
 * Description
 * @method getData
 * @param {} model
 * @return data
 */
function getData(model){
	var facid
	var data={};
	if($.isPlain(model)){
		data=model;
	} else{
		if(model.selectedLocation){
			facid=model.selectedLocation.facility.id

		} else if(model.facility){
			facid=model.facility.id
		} else {
			facid=model.facility_id
		}
		if(!facid){
			app.splashError("facility id is required");return
		}
		var userVehicle = model.userVehicle||model.vehicle
		data={
			member_id:model.user.id,
			facility_id:facid,
			barcode:userVehicle.barcode,
			vehicle_id:userVehicle.id
		}
		//date_from:model.schedule.reserveDate,   time_from:model.schedule.reserveTime,  scheduled_duration:model.schedule.duration,amount:model.selectedLocation.record.rate, tip:model.tip
		var schedule=model.schedule;
		if( schedule){
			schedule.getDataRecord(data);
		}
	}


	if(!data.facility_id || !(data.barcode||data.userid)){
		app.splashError("barcode or userid is required");
		return
	}
	return data
}
/**
 * Description
 * @method canReserve
 * @param {} overlapdata
 * @return 
 */
function canReserve(overlapdata){

}
/**
 * Description
 * @method canCheckin
 * @param {} overlapdata
 * @return 
 */
function canCheckin(overlapdata){

}





/**
 * Description
 * @method dowalkin
 * @param {} model
 * @param {} callback
 * @return 
 */
function dowalkin(model,callback) {
	if(model.user.isNonMember || model.user.nonmember_id){
		model.user.isNonMember=model.isNonMember=true
	}
	if(!model.facility.id){
		app.splashError("no facility")
		return
	}
	var data={walkin:true,facility_id:model.facility.id,entry_time:+(new Date())}
		if(model.isNonMember){
 			data.firstname=model.user.firstname
			data.lastname=model.user.lastname
			data.email=model.user.email
			data.nonmember_id=model.user.nonmember_id||model.user.id

		} else {
			data.member_id=model.user.id
		}

	var vehicleInfo=$.compact(model.userVehicle.toMap());
	vehicleInfo.vehicle_id=vehicleInfo.id;
	delete vehicleInfo.id
	$.extend(data ,vehicleInfo)
	model.schedule.getDataRecord(data)
 	data.slotid= model.reserveSlot.id
	if(!data.facility_id){
		data.facility_id=model.facility.id||(model.facility.record.id)
	}

	app.remoteDirective("docheckin",{ sel: data },callback)

}

/**
 * Description
 * @method docheckin
 * @param {} model
 * @param {} callback
 * @return 
 */
function docheckin(model,callback) {
	if(!model.reservenum){
		dowalkin.call(this,model,callback);
		return
	}

	var data={reserve_num:model.reservenum}
	model.schedule.getDataRecord(data)
	if(model.facility_id){
		data.facility_id=model.facility_id
	} else if(model.facility && model.facility.id){
		data.facility_id=model.facility.id
	}
	app.remoteDirective("docheckin",{ sel: data },callback)
}
/**
 * Description
 * @method docheckout
 * @param {} model
 * @param {} callback
 * @param {} override
 * @return 
 */
function docheckout(model,callback,override){
	if(override!==true && model.reserveTaskList && model.reserveTaskList.hasUnResolved()){
		app.splashError("There are unresolved tasks which must be completed or cancelled before checkout.")
		return
	}
	var exit_time= +(model.exit_time||new Date()),
		cost = model.recalcPrice()||{};
 	app.remoteDirective("docheckout", {
			sel:  {
				reserve_num:model.reservenum,
				tip:        model.pricing.calctip,
				amount:     cost.price,
				exit_time:  exit_time,
				staff_id:   app.user.id
			}
		}
	 ,callback)
}
/**
 * Description
 * @method cancelreserve
 * @param {} reserve_id
 * @param {} callback
 * @param {} showsplash
 * @return 
 */
function cancelreserve(reserve_id,callback,showsplash){
	app.remoteDirective("cancelreserve",{reserve_id:reserve_id},function(data){
		showsplash && app.splashInfo("PM-010")
		typeof(callback) =='function' && callback(data)
	});
}
var RESERVE="reserve"
var CHECKIN="checkin"

/**
 * Description
 * @method ReserveCheckInCheckOut
 * @param {} baseData
 * @param {} mode
 * @param {} foruser
 * @return 
 */
function ReserveCheckInCheckOut(baseData,mode,foruser){
	if(mode=="reserve"){
		this.mode=RESERVE
	} else {
		this.mode=CHECKIN
	}

 	this.baseModel=ReserveModel.from(baseData)
	if(baseData.user && baseData.user.id){
		this.baseModel.user.id=baseData.user.id;
	}

	this.baseModel.set("iswalkin",!this.baseModel.hasReserved())
	this.baseModel.set("foruser",!!foruser)
	this.baseModel.set("overlaps",[])
	this.baseModel.set("ispending",0)

}
/**
 * Description
 * @method showDialogOrResolve
 * @param {} callback
 * @return 
 */
ReserveCheckInCheckOut.prototype.showDialogOrResolve=function  ( callback){
	var forwalkin=false,buldfn=this.mode==CHECKIN?buildContentForcheckin:buildContent;

	var hdr= $.template(hdrtemplate)(this.baseModel)
	hdr=hdr.replace(/null/g,"")
	//if(this.baseModel.overlaps.length){
	var messageDom=this.messageContainer?$d(this.messageContainer):null;
	if(!messageDom){
		var optns={animateHide:true,centered:true,width:350,resizable:true,draggable:true,title:"Reservations and Checkins",destroyonhide:true}
		var dialogvw = new PopupView(optns);
		dialogvw.addButton({label:"Close",
		callback:function(){
			this.hide()
		} })
		dialogvw.show()

		dialogvw.UI.border="1px solid #666"
		dialogvw.contentUI.padding="3px"
		messageDom=dialogvw.$content()

	}
	var ths=this;
	var html=buldfn(this.baseModel.overlaps,hdr)
	messageDom.html( html.join(""))
	var wrap=messageDom.q(".checkin-verification")||messageDom
	messageDom.on("click",function(ev ){
		var el=$d(ev.target)
			if(el.selfOrUp(".continue-reserve")){
				dialogvw && dialogvw.hide();
 				callback.call(ths,true)
				return;
			}
		if(!el.up(".resstatus-item")){return}
		var id=el.up(".resstatus-item").domdata("key");
			if(el.selfOrUp(".select-reserve")){
				dialogvw && dialogvw.hide();
				var model=ths.baseModel.overlaps.find(function(a){return a.reserve_id==id})
				if(!model){
					return
				}
				dialogvw && dialogvw.hide();
				callback.call(ths,model)
				return;
			}
			if(id && el.selfOrUp(".cancel-reserve")){
				app.remoteDirective("cancelreserve",{reserve_id: id},function(e){
					app.splash(e.message||"Cancelled")
					ths.getOverLaps(function(ths){
						var messagebody=messageDom.q(".message-body")
							if(messagebody){
								messagebody.clear();
								var  html=buldfn(ths.baseModel.overlaps,false)
								messagebody.html(html.join(""))
							}


					});

				});
			}
		})

 		return
	//}
	//pr.resolve(ReserveModel.from(data))
}
/**
 * Description
 * @method getOverLaps
 * @param {} callback
 * @return pr
 */
ReserveCheckInCheckOut.prototype.getOverLaps=function (callback){
	//by user - openreservationsbyuser(targetuser:id)
	//by facility - openreservationsbybarcode(facility_id,barcode)
	if(this.ispending==2){return Promise.reject()}
	var args={isnonmember:this.baseModel.isNonMember},directive=""
	if(args.isnonmember){
		args.nonmemberid=this.baseModel.user.id
		args.vehicle_plate=this.baseModel.userVehicle.vehicle_plate
	}
	if(this.baseModel.foruser){
		args.targetuser=this.baseModel.user.id
		if(this.baseModel.userVehicle.barcode){
			args.barcode=this.baseModel.userVehicle.barcode
		}

		args.vehicle_id=this.baseModel.userVehicle.id
 		directive="openreservationsbyuser"
		if(!(args.targetuser  )){
			app.splashError("invalid data targetuser:"+args.targetuser)
		}
	} else {
		args.barcode=this.baseModel.userVehicle.barcode
		args.facility_id=this.baseModel.facility.id
		args.isnonmember=this.baseModel.isNonMember
		directive="openreservationsbybarcode"
		if(!( args.facility_id && (args.barcode||args.vehicle_plate))){
			app.splashError("invalid data barcode:"+args.barcode +" facility_id:" +args.facility_id)
			return Promise.reject()
		}
	}
	var ths=this,schedule=this.baseModel.schedule
	schedule.setupDates()
	this.baseModel.set("ispending",2)
	this.baseModel.overlaps=[]
	var pr=Promise.deferred()
    app.remoteDirective(directive,args ).then(function(a) {
	    if(!a || a.error || a=="null"){
		    pr.reject((a||{}).error);
		    return
	    }
	    var promises=[],allpromises=null;
	    var pr1=Promise.deferred()
		    promises.push(pr1)
		ths.baseModel.user.readRecord(a).then(
			function(){pr1.resolve()},
			function(){pr1.resolve()}
		)
	    var pr2=Promise.deferred()

	    var vehicle
	    if(a.vehicles && a.vehicles.length){
		    vehicle=a.vehicles[0]
	    } else if(a.nonmemberid  ){
		    vehicle=a
	    }
	    if(!vehicle && (a.vehicle_id||a.vehicleid)){
		    vehicle={id:a.vehicle_id||a.vehicleid}
	    }
	    if(vehicle){
		    promises.push(pr2)
		    ths.baseModel.userVehicle.readRecord(vehicle ).then(
			    function(){pr2.resolve()},function(){pr2.resolve()}
		    )
	    }
	    allpromises=Promise.all(promises)
		var overlaps=[],min15=15*60*1000,sixhrs=6*60*60*1000,now=+(new Date());
		var canreserve=true, cancheckin=true,items=a.items||a.reservations
		if (items && items.length) {
			items.forEach(function(it){it.resstatus||(it.resstatus=1);})
			var models = items.map(ReserveModel.from)
			overlaps = []

			var overlap,start = +schedule.reserveDateTime , end = +schedule.reserveDateTimeEnd
			models.forEach(function (a) {
				var sch=a.schedule
				sch.setupDates()
				var astart=+sch.reserveDateTime,mode=[]
				//in range
				if(astart <= end && (+sch.reserveDateTimeEnd) >= start){
					a.setItem("overlaps","overlaps");
					overlap=true
					mode.push("overlaps")
				}
				if(overlap && Math.abs(astart - start)<=min15){
					mode.push("overlaps-active")

				}
				if( !overlap &&   (+a.schedule.reserveDateTime <= (end+min15) && +a.schedule.reserveDateTimeEnd >= (start-min15))){
					a.setItem("overlaps15",true);
					mode.push("overlaps15")

				}
				a.setItem("overlapmode",mode.join(" ").trim());
				overlaps.push(a);
				if(!mode.length){
					a.setItem("overlapmode","nooverlaps");
				}
				if(overlap ){//|| Math.abs(end - astart) < sixhrs
					//overlaps.push(a);
				}
 			})
			ths.baseModel.overlaps=overlaps;
		}
		ths.baseModel.set("ispending",1)
	    allpromises.finally(
			function(){
				pr.resolve(ths )
			}
	    )

	},function(msg){
	    pr.reject(msg)
    });
	if(typeof(callback)=="function"){pr.finally(callback)}
	return pr
}
/**
 * Description
 * @method canReserveSync
 * @return UnaryExpression
 */
ReserveCheckInCheckOut.prototype.canReserveSync=function (){
	return !this.baseModel.overlaps.some(function(a){return a.overlaps && a.isReserved()})
}
/**
 * Description
 * @method canReserve
 * @return pr
 */
ReserveCheckInCheckOut.prototype.canReserve=function (){
	var pr=Promise.deferred()
	if(this.ispending==1){
		if(this.canReserveSync()){
			pr.resolve(this)
		} else {pr.reject("")}
		return pr
	}

	this.baseModel.on("ispending",function(rec){
		if(rec.value==1){
			this.canReserve()
		}
	}.bind(this),{once:true})
	return pr
}
/**
 * Description
 * @method canCheckinSync
 * @return UnaryExpression
 */
ReserveCheckInCheckOut.prototype.canCheckinSync=function () {
	return !(this.baseModel.overlaps && this.baseModel.overlaps.some(function(a){return a.overlaps && a.isCheckedIn()}))
}
/**
 * Description
 * @method canCheckin
 * @return pr
 */
ReserveCheckInCheckOut.prototype.canCheckin=function (){
	var pr=Promise.deferred()
	if(this.ispending==1){
		if(this.canCheckinSync()){
			pr.resolve(this)
		} else {pr.reject("")}
		return pr
	}

	this.baseModel.on("ispending",function(rec){
			if(rec.value==1){
				this.canCheckin()
			}
		}.bind(this),{once:true})
	return pr
}
/**
 * Description
 * @method isWalkin
 * @return LogicalExpression
 */
ReserveCheckInCheckOut.prototype.isWalkin=function (){
	return this.mode==CHECKIN && !this.baseModel.hasReserved()
}
/**
 * Description
 * @method canWalkin
 * @return 
 */
ReserveCheckInCheckOut.prototype.canWalkin=function (){
	return
}
/**
 * Description
 * @method verifyCheckin
 * @param {} callback
 * @param {} nodialogifnooverlaps
 * @return 
 */
ReserveCheckInCheckOut.prototype.verifyCheckin=function (callback,nodialogifnooverlaps){
	this.baseModel.on("allresolved",function(rec){
		if(!rec.value){return}

		this.getOverLaps().then(
			function(ths){

				if(ths.canCheckinSync() && nodialogifnooverlaps){
					var tocheck=ths.baseModel.overlaps.find(function(a){return !a.isCheckedIn()})
					callback && callback.call(ths,tocheck||true)
				}
				else {


				//	this.baseModel.on("allresolved", function (rec) {
						ths.showDialogOrResolve(callback)
				//	})
				}
 					/*if(ths.baseModel.overlaps.length){
						ths.showDialogOrResolve(callback)
					} else{
						callback.call(ths,true)
					}*/

			//	}
			}
		)
	}.bind(this),{once:true})

}
/**
 * Description
 * @method verifyReserve
 * @param {} callback
 * @return 
 */
ReserveCheckInCheckOut.prototype.verifyReserve=function (callback){
	this.baseModel.on("allresolved",function(rec){
		if(!rec.value){
			callback(false)
			return
		}

		this.getOverLaps().then(
			function(ths){
				//if(!ths.canReserveSync()){
				//	callback.call(ths,false)
				//}/ else {
					if(ths.baseModel.overlaps.length){
						ths.showDialogOrResolve(callback)
					} else{
						callback.call(ths,true)
					}

				//}
			}
		)
	}.bind(this),{once:true})
}
/**
 * Description
 * @method verifyWalkin
 * @param {} callback
 * @return CallExpression
 */
ReserveCheckInCheckOut.prototype.verifyWalkin=function (callback){
	return this.verifyCheckin(callback)
}

/**
 * Description
 * @method reserve
 * @param {} callback
 * @return 
 */
ReserveCheckInCheckOut.prototype.reserve=function doreserve(callback){
	this.verifyReserve(
		function(model){
			if(model===false){
				app.splashError("Reservation failed")
 				return
			} else if(model===true){
				model=this.baseModel
			}
			if(!model.facility.id || !model.user.id || !model.userVehicle.id){
				app.splashError("A facility, user and a vehicle is required to make a reservation")
				return
			}
 			var data={multientry:model.multientry,facility_id:model.facility.id,member_id: model.user.id,vehicle_id:model.userVehicle.id}
			model.schedule.getDataRecord(data)
			data.slotid= model.reserveSlot.id

			app.remoteDirective("confirmreserve", {
					sel: data
 			},callback,function(a){
				app.splashError("Reservation failed",a)
				callback(a);
			})
		});

}
/**
 * Description
 * @method checkin
 * @param {} callback
 * @param {} verify
 * @return CallExpression
 */
ReserveCheckInCheckOut.prototype.checkin=function (callback,verify){
	if(verify){
		this.verifyCheckin(function(nu){
			if(!nu){return}
			docheckin(this.baseModel,callback)
		}.bind(this),true)
		return
	}
	return docheckin(this.baseModel,callback)
}
/**
 * Description
 * @method checkout
 * @param {} callback
 * @return CallExpression
 */
ReserveCheckInCheckOut.prototype.checkout=function (callback){
	return docheckout(this.baseModel,callback)
}
/**
 * Description
 * @method walkinNonmember
 * @param {} plate
 * @param {} facility_id
 * @param {} callback
 * @return 
 */
ReserveCheckInCheckOut.prototype.walkinNonmember=function dowalkinNonmember(plate,facility_id,callback){

	app.remoteDirective("findnonmember", {
 			vehicle_plate:plate ,facility_id: facility_id,ensure:true

	},function(data){
		if(data.id){
			data.nonmember_id=data.id;
			delete data.id
			callback(data);
		}
	})

}

ReserveCheckInCheckOut.checkout=docheckout
ReserveCheckInCheckOut.checkin=docheckin
ReserveCheckInCheckOut.walkinNonmember=dowalkinNonmember
ReserveCheckInCheckOut.cancel=cancelreserve
/*var ReserveCheckInCheckOut={
	verify:fStatus,
	verifyReserve:verifyReserveStatus,
	verifyWalkin:verifyCheckInWalkin,
 	checkin:docheckin,
	checkout:docheckout,
	reserve:doreserve,
	walkin:dowalkin,
	cancel:cancelreserve,
	walkinNonmember:dowalkinNonmember
	}*/

ReserveCheckInCheckOut.buildOverLapHTML=buildOverLapHTML

module.exports= ReserveCheckInCheckOut
}
__bootstrap__.modules["common/timeLookups"] = function(module){
var dateformat="ddd, mmm dd yyyy",     timeformat="hh:nn tt"
var TimeSelector= $.require("TimeSelector")
var PopupView=$.require("PopupView");

/**
 * Description
 * @method timeLookups
 * @param {} wrap
 * @param {} date
 * @param {} vwmodel
 * @param {} dateselector
 * @param {} timeselector
 * @param {} datekey
 * @param {} timekey
 * @return 
 */
function timeLookups(wrap,date,vwmodel,dateselector,timeselector,datekey,timekey ){
    var now= new Date();
    if(!now.getFullYear){now=new Date()}
    now.setHours(0)
    now.setMinutes(0);
    now.setSeconds(0);
    now.setMilliseconds(0);
    $.require("UI.Calendar",function(cal){
        /**
         * Description
         * @method pad
         * @param {} s
         * @return BinaryExpression
         */
        var maxdate=new Date(now.getFullYear(),now.getMonth(),now.getDate()+30),
            pad=function(s){return (String(s).length==1?"0":"")+s},
        /**
         * Description
         * @param {} name
         * @return FunctionExpression
         */
        handle=function(name){
            return function(evt){
                evt.stopImmediatePropagation()
                var ip=$d(evt.target),model=ip.data("_cal");
                if(!model){
                    model=cal(null,{ ip:ip,
                        /**
                         * Description
                         * @method dateFilter
                         * @param {} chk
                         * @return 
                         */
                        dateFilter:function(chk ){ if(+chk   > (+maxdate) || chk<now){return !1}},
                        /**
                         * Description
                         * @method onselect
                         * @param {} k
                         * @param {} lbl
                         * @return 
                         */
                        onselect:function(k,lbl){
                            vwmodel[name]=$.date.asDate(k,dateformat);
                            model.view.hide()

                        }
                    })
                    ip.data("_cal",model)
                }
                model.render(vwmodel[name]||vwmodel["reserveDateTime"]);
            }
        }
        var list=[]
        if(wrap.q(timeselector)){
            var el=wrap.q(timeselector)

           /**
            * Description
            * @method resetList
            * @param {} date
            * @return 
            */
           function resetList(date){

               var dt=$.date(+date)||$.date()
               if($.date().trunc() - dt.trunc() == 0 ){
                   dt=$.date()
               }
               list=[]
               var today = $.date().trunc()
               if(Math.abs((+dt) - (+today)) > (1000*60*60*24) ){dt=dt.trunc()}
               var now=$.date(+dt).toNearestQuarterMinutes(),date=now.date,count=24*4
               for(var i=0;i<count;i++){
                   if(now.date !=date){break;}
                   list.push(now.format(timeformat))
                   now.plus("n",15)
               }
               /**
                * var currhr=dt.getHours(),currmin=dt.getMinutes(),mins= [0,15,30,45],list=[]
                * for(var i=0;i<24;i++){
                * if(currhr>i){continue}
                * var v = i, s = i == 0 ? "12" : ((v > 12 ? (v - 12) : v) + ""), ap = (v >= 12 ? " pm" : " am");
                * for(var j=0;j<4;j++){
                * if(currhr==i && mins[j]<currmin){ continue}
                * list.push(pad(s) + ":" + (mins[j]||"00") +ap)
                * }
                * }
                * @method onchange
                * @return 
                */
               el.addOptions(list,true).onchange=function(){
                   vwmodel[timekey]=$.date.asTime(this.value)
               };
           }
             /**
              * Description
              * @method ondatachange
              * @param {} rec
              * @return 
              */
             function ondatachange(rec){
                 if(!$d.isVisible(el,true)){
                     return false
                 }
                 resetList(rec.value)
             }
            resetList(vwmodel[timekey])
            vwmodel.onchange(datekey, ondatachange);

            var time=vwmodel[timekey]
            if(!time){
                time=vwmodel["reserveDateTime"]
            }
              el.val( $.date.format(time,timeformat))

        }

        wrap.q(dateselector) && wrap.on("click",handle(datekey),dateselector);
        wrap.q(".gl-icon-calendar") && wrap.q(".gl-icon-calendar").mousedown(handle(datekey));
    })
}


module.exports=timeLookups
}
__bootstrap__.modules["common/TipsWidget"] = function(module){
/**
 * Created by Atul on 6/8/2015.
 */

var template='<div class="tips-wrap" z-scope="pricingtips">' +
				'<span class="val-label">TIP</span>' +
				'<span class="currency-val val" z-bind="pricing.calctip"></span>' +
				'<div class="reserve-pricing">' +
					'<span class="val-wrap  pricing-tips">' +
						'<span class="val light-blue-colorbg" z-bindto="schedule.tip">5%</span>' +
						'<span class="val light-blue-colorbg" z-bindto="schedule.tip">10%</span>' +
						'<span class="val light-blue-colorbg" z-bindto="schedule.tip">15%</span>' +
						'<input class="val light-blue-colorbg"  z-bindto="schedule.tip" max="100" min="1" step=".5" placeholder="Other" type="number" />' +
					'</span>' +
				'</div>' +
			'</div>',
	templateElement=null

var TipsWidget=$.widget.extend( {
	isreadonly: null,
	model:null,
	modelscopeid:null,
	/**
	 * Description
	 * @method init
	 * @return 
	 */
	init: function () {
		if(!templateElement){
			templateElement=document.createElement("div")
			templateElement.innerHTML=template;
			templateElement=templateElement.removeChild(templateElement.firstChild);
 		 }
		this.el=$d(templateElement.cloneNode(true));
		//this.el.attr("z-scope",this.modelscopeid);
	},

	/**
	 * Description
	 * @method setReadOnly
	 * @return 
	 */
	setReadOnly:function(){

	} ,
	/**
	 * Description
	 * @method renderimpl
	 * @param {} a
	 * @return 
	 */
	renderimpl: function(a) {
		this.modelscopeid && this.el.attr("z-scope",this.modelscopeid);
		if(this.model){
			this.model.digest(this.el,this.modelscopeid)
 		}

	}
});

module.exports=TipsWidget;
}
__bootstrap__.modules["common/UserDetails"] = function(module){
var VehicleModel= $.require("models/VehicleModel")
/*var VehicleModel= $.require("models/VehicleModel")
var VehicleModel= $.require("models/VehicleModel")*/
var UserDetails=$.model.make("UserDetails", {
	id:null,
	facility_id:null,
		"region": null,
		"fid": null,
		"billingzipcode": null,
		"accountnum": null,
		"billingstate": null,
		"address1": null,
		"lastname":null,
		"address2": null,
		"cardcvv": null,
		"billingcountry": null,
		"expirationyear": null,
 		"emailsenton": null,
		"expirationmonth": null,
		"billingcity": null,
		"firstnameoncard": null,
		"phonenumber": null,
		"sendemail": null,
		"middlename": null,
		"usertype": null,
		"cardnumber": null,
		"loginid": null,
		"firstname": null ,
		"pic": null,
 		"email":null,
		"dob": null,
		"lastnameoncard": null,
		isNonMember:null,
	fullname:{descriptor:true,
/**
 * Description
 * @method expr
 * @param {} rec
 * @return nm
 */
expr:function(rec){
		var nm=rec.firstname+" "+rec.lastname;
		if(rec.isNonMember){nm=nm+ " (Non Member)"}
		return nm
	}, vars:["firstname" ,"lastname","isNonMember"]
	},
	vehicles:null,
	notifications:null,
	reservations:null
},
	{	
/**
	 * Description
	 * @method init
	 * @return 
	 */
	init:function() {
			this.vehicles=[];
			this.notifications=[];
			this.reservations=[];
			this._whenAvailable=Promise.deferred();
			this.observer=  $.emitter.simpleObserver(this)
		},
		/**
		 * Description
		 * @method whenAvailable
		 * @param {} fn
		 * @return 
		 */
		whenAvailable:function(fn){
			this._whenAvailable.then(fn)
		},

		/**
		 * Description
		 * @method refresh
		 * @param {} callback
		 * @return 
		 */
		refresh:function(callback){
			if(this.id){
				this.load(this.id,callback)
			}
		},
		/**
		 * Description
		 * @method findVehicle
		 * @param {} vid
		 * @return CallExpression
		 */
		findVehicle:function(vid){
			return this.vehicles.find(function (r) { return r.id==vid})
		}   ,
		/**
		 * Description
		 * @method readRecord
		 * @param {} data
		 * @return 
		 */
		readRecord:function(data){
			var ths=this;
			if(!data){return}
			var V=data.vehicles,N=data.notifications,R=data.reservations,M=data.monthly;
			delete data.vehicles;
			delete data.notifications;
			delete data.monthly;
			ths.readDataRecord(data)
 			ths.vehicles=V.map(function(rec){
				var VM=ths.findVehicle(rec.id)||new VehicleModel();
				VM.readRecord(rec,true);
				return VM
			});
			ths.notifications=N//V.map(function(rec){var VM=new VehicleModel();VM.readRecord(rec,true);return VM})
			ths.reservations=R//V.map(function(rec){var VM=new VehicleModel();VM.readRecord(rec,true);return VM})
			ths.monthly=M
			ths._whenAvailable.resolve(ths)
			ths.observer.dispatch("refresh",ths)
		},
		/**
		 * Description
		 * @method load
		 * @param {} id
		 * @param {} callback
		 * @return 
		 */
		load:function(id,callback){
			var ths=this;

			if(typeof(callback)=="function"){this._whenAvailable.then(callback)}
			app.remoteDirective("userdetails",{targetid:id}).then(
				function(data){
					ths.readRecord(data)
 				}
			)
		}
})
module.exports=UserDetails;
/*
 "vehicles": [{
 "id": 53,
 "user_id": 2076,
 "vehicle_label": "SSS",
 "vehicle_make": "HUMMER",
 "vehicle_plate": "SSS",
 "vehicle_color": "blue",
 "vehicle_year": 2015,
 "barcode": "35345-526-954",
 "vehicle_model": "H3"
 }
 "monthly": [{
 "id": 1,
 "facility_id": 193,
 "member_id": 2076,
 "start_date": "2015-06-28T04:00:00+0000",
 "reserve_num": "2mvJdgyl"
 },
 */
}
__bootstrap__.modules["common/VehicleWidget"] = function(module){
var SimpleView=$.require("SimpleView")
var VehicleModel=$.require("models/VehicleModel")
 /**
  * Description
  * @method imgErrorhandler
  * @param {} ev
  * @return 
  */
 function imgErrorhandler(ev){
	var target
	if(ev && ev.target){target=ev.target}
	else if(ev && ev.nodeType){target=ev}
	if(!(target && target.classList && target.style.display!="none")){return}
	//if(!(target.naturalHeight && target.naturalWidth) ){return}
	//target.classList.add("missing-img")
	target.style.display="none";
	var defimg=target.parentNode.querySelector(".vehicle-img-def")
	if(!defimg){
		defimg=target.parentNode.insertBefore(document.createElement("img"),target.nextElementSibling);
		defimg.className="vehicle-img vehicle-img-def";
		defimg.style.cssText=target.style.cssText;
		defimg.style.borderBottomWidth="0px"
		defimg.src=app.appassetsPath+"defaultvehicle.png";
	}
	defimg.style.backgroundColor=target.style.borderBottomColor
	defimg.style.display="inline-block"


}
self._globalimgErrorhandler= $.throttle(imgErrorhandler,{tailend:true})
var template='' +
	'<div class="vehicle-widget" >' +
		'<div class="vehicle-widget-form" style="display:inline-block;width:  width: 24rem;position: relative;">' +
		    '<div class="fld-row">' +
				'<span class="val-label">Label</span>' +
				'<input  z-bind="vehicle_label"   class="vehicle-val vehicle-label" placeholder="Label"/>' +
			'</div>' +
			'<div class="fld-row">' +
				'<span class="val-label">Plate</span>' +
				'<input  z-bind="vehicle_plate" min="4" max="20" readonly class="vehicle-val vehicle-plate" required placeholder="Plate number"/>' +
			'</div>' +
			'<div class="fld-row">' +
				'<span class="val-label">Make</span>' +
				'<select z-bind="vehicle_make"   class="vehicle-val vehicle-make" style="width:9.4rem;margin-right:4px"><option value="">-Make-</option></select>' +
		        '<select z-bind="vehicle_year"   style="width:6rem" class="vehicle-val vehicle-year"/><option  value="">-year-</option></select>' +
			'</div>' +
			'<div class="fld-row">' +
				'<span class="val-label">Model</span>' +
			    '<select z-bind="vehicle_model" class="val vehicle-model" style="width:9.4rem;margin-right:4px"><option value="">-Model-</option></select>' +
				'<select z-bind="vehicle_type"  style="width:6rem" class="vehicle-val vehicle-type "><option  value="">-Type-</option><option value="sml">Small</option><option value="med">Medium</option><option  value="lrg">Large</option><option  value="suv">SUV</option><option  value="lux">Luxury</option><option  value="spr">Sports Car</option><option  value="exo">Exotic</option></select>' +
			'</div>' +
			 '<div class="fld-row">' +
				'<span class="val-label">Color</span>' +
				'<select z-bind="vehicle_color"  class="vehicle-val vehicle-color"/><option  value="">-Color-</option></select>' +
			'</div>' +
		'</div>' +
		'<div class="vehicle-widget-img" style="width:10rem;text-align:center;display:inline-block;position: relative;margin-left: 15px;">' +
 				'<img class="vehicle-img user-vehicle-img" src="{{vehicleimgpath}}" onerror="_globalimgErrorhandler(this)" style="border-bottom-color:{{vehicle_color}};"/>' +
 		'</div>'+
	'</div>'


var summarytemplate='' +
	'<div class="vehicle-widget" >' +
	'<div z-bind="vehicle_label" class="section-label vehicle-label"></div>' +
	'<div class="vehicle-widget-img" style="width:10rem;display:block;position: relative;margin: 0 auto;">' +
 			'<img class="vehicle-img" src="{{vehicleimgpath}}"  style="border-bottom-color:{{vehicle_color}};"/>' +
 		'</div>'+
		    '<div class="val-row">' +
				'<span class="val-label">Plate</span>' +
				'<span  z-bind="vehicle_plate" class="vehicle-val vehicle-plate"></span>'+
		    '</div>' +
		    '<div class="val-row">' +
				'<span class="val-label">Model</span>' +
				'<span  z-bind="vehicle_make" class="vehicle-val vehicle-make"></span> ' +
	             '<span  z-bind="vehicle_model" class="vehicle-val vehicle-model"></span> ' +
				'<span  z-bind="vehicle_year" class="vehicle-val vehicle-year"></span> ' +
			    '<span  z-bind="vehicle_type" class="val vehicle-type"></span>' +
			'</div>' +

	'</div>'

var templateElement=null,
	templateSummaryElement=null
/**
 * Description
 * @method addOptions
 * @param {} el
 * @param {} list
 * @param {} clear
 * @return 
 */
function addOptions(el,list,clear){
	if(clear===true){
		while(el  && el.options && el.options.length){
			el.removeChild(el.options[0]);
		}
	}
	for(var i= 0, l=list,ln=l.length;i<ln;i++){
		var O=l[i]
		if(O==null){continue}
		var opt=document.createElement("option")
		opt.text = O
		opt.setAttribute && opt.setAttribute("value", O);
		typeof(el.add)=="function"?el.add(opt):el.appendChild(opt);
	}
}
var VehicleWidget=$.widget.extend( {
	isreadonly: null,
	model:null,
	modelscopeid:null,
	showsummary:null,
	container:null,
	/**
	 * Description
	 * @method init
	 * @return 
	 */
	init: function ( ) {
		if(!this.model){
			this.model=new VehicleModel();
		}


		var vw=this

		if(!this.modelscopeid){
			this.modelscopeid="VehicleWidget"
		}
		if(!this.container){
			if(!templateEl){
				var templateEl = this.showsummary?templateSummaryElement:templateElement
				if(this.showsummary){
					templateSummaryElement=document.createElement("div")
					templateSummaryElement.innerHTML=summarytemplate
					templateEl=templateSummaryElement;
				} else {
					templateElement=document.createElement("div")
					templateElement.innerHTML=template;
					templateElement=templateElement.removeChild(templateElement.firstChild);

					templateEl=templateElement;
				}

			}
			this.el=$d(templateEl.cloneNode(true));
		} else{
			this.el=this.container
			if(this.el.q(".vehicle-widget-img img")){
				this.el.q(".vehicle-widget-img img").el.onerror=_globalimgErrorhandler
			}

		}
		if(!this.showsummary) {
			var vehiclemake = this.el.q(".vehicle-make");
			addOptions(vehiclemake, VehicleModel.getMakes())
			var i = 0, numofyears = 20, yrs = [], current = (new Date()).getFullYear();
			while (i < numofyears) {
				yrs.push(String(current - i));
				i++
			}
			addOptions(this.el.q(".vehicle-year"), yrs)
			addOptions(this.el.q(".vehicle-color"), ['Black', "Blue", 'Brown', 'Gray', 'Green', 'Maroon', 'Orange', 'Red', "Silver", 'Tan', 'White', 'Yellow'])
		}
 		this.model.onchange(function(rec){
			if(!vw.el){return}
			if(rec.name=="imgpath"){
 				vw.setImgPath(rec.value||"")
			} else{
				var k=rec.name.replace("vehicle_","").trim()
				vw.el.q(".vehicle-"+k) && vw.el.q(".vehicle-"+k).val(rec.value)
				if(k=="color"){
					vw.setImgPath()
				}
			}
		})

 	},
	/**
	 * Description
	 * @method setImgPath
	 * @param {} imgpath
	 * @return 
	 */
	setImgPath:function(imgpath){
		var vw=this
		if(imgpath==null || typeof(imgpath)!="string") {
			imgpath = this.model.imgpath;
		}
		if(!vw.el){return}
		var el=vw.el.q(".user-vehicle-img")
		if(!el){
			el=vw.el.q(".vehicle-widget-img img")
			if(el){el.addClass("vehicle-img").addClass("user-vehicle-img")}
		}
		if(!el){return}
 		el.removeClass("missing-img")
		if(el.css("display")=="none") {
			el.css("display", "")
			if(el.css("display")=="" || el.css("display")=="none") {
				el.css("display", "inline-block")
			}
		}
		el.css("border-bottom-color",this.model.vehicle_color||"white")
		if(!imgpath){
			imgErrorhandler({target:el.el})
		} else{
			el.el.onerror=_globalimgErrorhandler
			el.prop("src",imgpath );
			var defimg=el.parent().q(".vehicle-img-def")
			if(defimg){defimg.hide()}
			setTimeout(function(el,src){
				el.el.src=src;
				if(el.hasClass("missing-img")){
					el.css("background-color",this.model.vehicle_color||"white")
				}else {
					el.el.src=src;
					el.css("background-color","transparent")
					el.css("border-bottom-color",this.model.vehicle_color||"white")
				}
				el.el.setAttribute && el.el.setAttribute("src",src)
			}.bind(this,el,imgpath),200)
		}

	},
	/**
	 * Description
	 * @method getDataRecord
	 * @return mp
	 */
	getDataRecord:function(){
		var ths=this
		var data={}
		if(this.showsummary){return}
		this.el.qq(".val,.vehicle-val").each(function(){data[this.attr("z-bind")]=this.val()})
		this.model.readDataRecord(data);
		var mp=this.model.toMap();
		delete mp.imgpath
		return mp;
	},
	/**
	 * Description
	 * @method setFieldReadOnly
	 * @param {} flg
	 * @param {} readonly
	 * @return 
	 */
	setFieldReadOnly:function(flg,readonly){
		if(this.showsummary){return}
		var fld=this.el.q(".val."+flg)||this.el.q(".vehicle-val.vehicle-"+flg)
		if(fld){
			fld.prop("readonly",readonly==null||readonly===true?"readonly":null)
		}
	},
	/**
	 * Description
	 * @method setReadOnly
	 * @return 
	 */
	setReadOnly:function(){

	},
	/**
	 * Description
	 * @method digest
	 * @return 
	 */
	digest:function(){
		this.setVehicleModelList()
		"make model type year color plate".split(" ").forEach(
			function(k){
				this.el.q(".vehicle-"+k) && this.el.q(".vehicle-"+k).val(this.model.get("vehicle_"+k))
			}.bind(this)
		)
		this.setImgPath()
		//this.el.qq("select").css("color",function(){return this.val()?"black":"#ccc"})
	},
	/**
	 * Description
	 * @method setVehicleModelList
	 * @param {} a
	 * @return 
	 */
	setVehicleModelList: function(a) {
		if(this.showsummary){return}
		var make=a
		if(a && $.isPlain(a) ){make= a.value|| a.newValue;}
		if(typeof(make)=="undefined"){make=this.model.vehicle_make}

		var vehiclemodelEl=this.el.querySelector(".vehicle-model");
		if(!vehiclemodelEl){return}
		addOptions(vehiclemodelEl,VehicleModel.getModels(make)||[],true);
 	},
	/**
	 * Description
	 * @method renderimpl
	 * @param {} a
	 * @return 
	 */
	renderimpl: function(a) {
 		this.digest()
		if(this.showsummary){return}
		this.el.q(".vehicle-make").el.addEventListener("change",function(ev){
 			this.model.vehicle_make=(ev.target.value);
		}.bind(this))
		this.el.q(".vehicle-model").el.addEventListener("change",function(ev){this.model.vehicle_model=(ev.target.value);}.bind(this))
		this.el.q(".vehicle-type").el.addEventListener("change",function(ev){this.model.vehicle_type=(ev.target.value);}.bind(this))
		this.el.q(".vehicle-year").el.addEventListener("change",function(ev){this.model.vehicle_year=(ev.target.value);}.bind(this))
		this.el.q(".vehicle-color").el.addEventListener("change",function(ev){this.model.vehicle_color=(ev.target.value);}.bind(this))

		this.model.onchange("vehicle_make",this.setVehicleModelList.bind(this))

	}
});

module.exports=VehicleWidget;
}
__bootstrap__.modules["common/WeatherWidget"] = function(module){
var WeatherWidget=$.widget.extend( {
	container:null,
	/**
	 * Description
	 * @method init
	 * @param {} container
	 * @return 
	 */
	init: function (container) {
			$d.onAttach( container,function(el){
				this.el=el
				this.render()
			}.bind(this))


		this._timer=$.timer.every(300000,this.refresh.bind(this))
 	},
 	/**
	  * Description
	  * @method refresh
	  * @return 
	  */
	 refresh:function(){
		if(!(this.el && this.el.q("img"))){return}
	    if(!this.citystate) {
		    this.citystate = "new york, ny"
		    if (app.user.facility && app.user.facility.address) {
			    var address = $.require("models/AddressModel").parse(app.user.facility.address)
			    if (address && address.zip) {
				    this.citystate = address.zip
			    }
		    }
	    }
		$.xhr.jsonp("https://query.yahooapis.com/v1/public/yql?q=select *  from weather.forecast where woeid in (select woeid from geo.places(1) where text='"+(this.citystate)+"')&format=json",
			function(a){
				if(!(a && a.response && a.response.query&& a.response.query.results&& a.response.query.results.channel&& a.response.query.results.channel.item)){return}
				var div=document.createElement("div")
				var item= a.response.query.results.channel.item;
				div.innerHTML=item.description
				var img=div.querySelector("img")
				this.el.q("img").prop("src",img.src)

				this.el.q(".current-temp").html(item.condition.temp+'&#176;')
			}.bind(this),"callback")
	},
	/**
	 * Description
	 * @method renderimpl
	 * @param {} a
	 * @return 
	 */
	renderimpl: function(a) {
		if(!this.el){return}
		this.el.html("<img src='../theme/img/spacer.png' style='max-width: 30px;margin:0 5px;'/><span class='current-temp'></span>")
		this.refresh()
	}
});

module.exports=WeatherWidget;
}
__bootstrap__.modules["garage/AppnotificationsView"] = function(module){
/**
 * Created by Atul on 6/1/2015.
 */
var SimpleView=$.require("SimpleView")
var ReserveCardView=$.require("ReserveCardView")
var ReserveModel=$.require("models/ReserveModel")
var PopupView =$.require("PopupView")

var STATUS={
 UNREAD:0,
 PENDING:1,
 ACCEPT:1,
 REJECT:3,
 //WITHDRAW:1,
 COMPLETE:2,
}
 var AppnotificationsView=Klass(SimpleView,{
  triggerCount:null,
  currentItems:null,
     notificationTypes:null,
     filter:null,
  triggerSelector:".app-notifications-link",
  init:function() {
    this.initView()
    this.el.addClass("fit-vp-content")
    this.el.addClass("app-notifications-view").css({zIndex:20})
    this.on("afterRender",function(){this.el.toFront(true)})
    this.onpropertychange("currentItems",function(){
       this.updateView();
    })
      app.observer.on("notificationupdate", function (data) {
          if (app.notificationsView && app.notificationsView.el.isVisible()) {
              app.notificationsView.refreshView()
          }
      });


  },
   applyFilter:function(filter){
       if(filter==this.filter){return}
       this.filter=filter;this.renderRows();
   },
  beforeRender:function(){
   this.el.html("<h2 class='blue_bar' style='text-align: left'>Notifications and Tasks<div class='notification-opts'>" +
       "<span class='filter'>Filter</span>" +
       "<span class='refresh'></span>" +
       "</div></h2>" +
       "<div class='fill-container notification-list'><ul class='notification-list-wrap'></ul></div>")
   this.$(".notification-opts .refresh").on("click",  this.refreshView.bind(this))
      this.$(".notification-opts .filter").on("click",  function(ev){
          var el=$d(ev.target),vw=this;
          if(!this._filterList) {
              this._filterList=PopupView.lookupList([{id: -2, label: "Assigned to me"}, {
                  id: 1,label: "Request for Premium Services" }, {id: 2, label: "Retrieve Car"}, {id: 3, label: "Park Car"}, {id: -1, label: "Other"}], {
                  minWidth: 200, destroyonhide:false,callback: function (a) {
                      el.html(a.label)
                      vw.applyFilter(a.id);
                  }
              })
          }
          this._filterList.show()
      }.bind(this))

  },
  updateTrigger:function(){
   if(this.currentItems && this.triggerCount){
    $d.html(this.triggerCount,this.currentItems.length||"")
       if(this.currentItems.length>9){$d.addClass(this.triggerCount,"shrink")}
       else {$d.removeClass(this.triggerCount,"shrink")}
       var d=$d(".garage-slot.notification .txt")
       if(d){d.html(String(this.currentItems.length))}
   }
  },
  updateView:function(){
   if(this.currentItems){
    this.updateTrigger()
       if(!this.notificationTypes) {
           if(!this._pending) {
               this._pending = true;
               var ths = this;
               app.getEntity("appnotificationtype").then(function (ent) {
                   var store = ent.createStore();
                   store.load().then(
                       function () {
                           ths.notificationTypes = store;
                           ths.renderRows()
                       }
                   )
               })
           }
            return;
       }
       this.renderRows()

   }
  },
  renderRows:function(){
   var items=this.currentItems,facid=app.user.facility?app.user.facility.id: 0,cnt=0
   if(items){
    var actions=[["<div class='notification-act' data-key='1'>Accept</div>","<div class='notification-act' data-key='3'>Reject</div>","<div class='notification-act' data-key='100'>Assign</div>","<div class='notification-act' data-key='2'>Done</div>"],["<div class='notification-act' data-key='0'>Withdraw</div>","<div class='notification-act' data-key='2'>Done</div>"]]
   var vw=this;
    if(!this.el.q(".notification-list")){
     return
    }
       var notiStore=this.notificationTypes,filter=this.filter,uid=app.user.id;
    this.el.q(".notification-list").html(
        "<ul class='notification-list-wrap'>"+

      items.map(function(it){var status_id=it.status_id||it.statusid|| 0,acts=actions[status_id]||[]
          if(filter) {
              if (filter > 0 && filter != it.type_id) {
                  return ""
              } else if(filter==-1 && (it.type_id==1 || it.type_id==2 || it.type_id==3)){return ""}
              else if(filter==-2 && (it.assigned_to!=uid)){return ""}
          }
          cnt++
        return ("<li data-typ='"+it.type_id+"' class='noti_item "+ ((notiStore.findById(it.type_id)||{}).istask?" ":"isnottask ")+
                (it.assigned_to?"assigned ":"") +"status-"+status_id+"' data-key='"+it.id+"' data-reserveid='"+it.reserve_id+"'>" +
                "<span class='noti-message'>"+it.msg+"</span>" +
                "<div class='notification-acts'>"+acts.join("")+"</div>" +
            "</li>");
      })
          .join("")
          .replace(/::([\w]+)\b/g,function(a,b){return "<span class='noti-reserve-link'>"+b+"</span>"})
          .replace(/date\(([\w\.]+)\)/,function(a,b){return $.date.format(Number(b.trim()),"mmm, dd yyyy hh:nn tt")}).trim()
          .replace(/,$/,"").trim()
        +"</ul>"
    );
       var ths=this;
       if(facid){
           app.getEntity("facility_staff").then(function (ent) {
               var store = ent.createStore();
               store.load( {criteria:"facility_id="+facid}).then(
                   function () {
                       ths.facilityStaffStore = store;
                   }
               )
           })
       }

    this.el.q(".notification-list-wrap").on("click",function(ev,el){
        var id=$d.up(el,"li").domdata("key"),reserveid=$d.up(el,"li").domdata("reserveid")
        if(!id||!reserveid){
            return
        }
        if(el.hasClass("noti-reserve-link")){
            var rec=app.remoteDirective("reserveinfo",{reserve_id:reserveid}).then(
                function(a){
                    var data= a.data||a;
                    data._isreserverecord=1
                    var model=new ReserveModel();
                    model.readRecord(data)
                    vw.cardView=ReserveCardView.show({
                        id: "notificationview",
                        showtimer: true,
                        showBarCode: false,
                        anchor: el,
                        record: model
                    });
                }
            )

            return
        }
     var nuid=$d.domdata(el,"key")
     if(nuid){

       var data={id:id,user_id:app.user.id}
         if(nuid=="100"){
             data.status_id=STATUS.ACCEPT
             if(!ths.facilityStaffStore){return}
             if(!ths.staffListView){
                 ths.staffListView=new PopupView({anchor:el,width:150,alignAnchor:"below",animateShow:"t",container:ths.el})
                 ths.staffListView.el.on("click.popup",function(ev,elli){
                     data.assigned_to=$d.domdata(elli,"key")
                      data.assigned_on= +(new Date())
                     app.remoteDirective("updatenotification",{ndata:data})
                 }.bind(this)   ,{selector:"li"})
             }
             ths.staffListView.config.options.anchor=el
             ths.staffListView.setContent(ths.facilityStaffStore.records.map(function(a){return "<li class='list-item' data-key='"+a.id +"'>"+a.firstname+" "+ (a.lastname||"")+"</li>"}).join(""))
             ths.staffListView.show()
             return;
         }

     data.status_id=nuid
       if(nuid=="1"){
         data.assigned_to=app.user.id
        data.assigned_on= +(new Date())
       }
         app.remoteDirective("updatenotification",{ndata:data})
      }

    },{selector:".notification-act,.noti-reserve-link"})
       this.$(".notification-opts .refresh").html( $.date().format("hh:nn tt")+"</br/>"+ cnt+" items")
   }
  },
  refreshView:function(){
    var userid=app.user.id,
        facility_id=app.user.facility?app.user.facility.id:0
       var vw=this;
       app.remoteDirective("getnotifications",{assigned_to:userid,facility_id:facility_id}).then(
           function(data){if(!(data )){return}
               var items=data.items||data
               if(!(items && items.length)){return}
            vw.currentItems=items
           }
       )
  },
  toggleView:function(){
   if(this.el.isVisible()){
     this.hide()
   } else{
     this.refreshView()
     this.show()

   }

  },
  hideImpl: function (anim,animconfig) {
      if(this.cardView && this.cardView.getEl && this.cardView.getEl() && this.cardView.getEl().isVisible(true)){
          this.cardView.hideView();
      }
      var actel=$d.util.getActiveElement();
      if(actel && (this.el.contains(actel) || $d.selfOrUp(actel,".filter-listbox"))){
           return;
      }
   if(this._dochandle){
     $d(document.body).off("mousedown", this._dochandle)
     this._dochandle=null
   }
   if(this.el.isVisible()){
    this.el.disAppear(
        function(){$d.hide(this.el)}
    )
   }

  },
  showImpl: function (anim,animconfig) {
   if(this._dochandle){
     $d(document.body).off("mousedown", this._dochandle)
     this._dochandle=null
   }
   $d.show(this.el )
   var vw=this
   this.el.appear({anchor:"r",easing:"ease-out"} ,"fast",function(){
     $d(document.body).on("mousedown", vw._dochandle=function hndl(ev){
         if(vw.cardView && vw.cardView.getEl && vw.cardView.getEl() && vw.cardView.getEl().contains(ev.target)){
             return
         }
      if(vw.el.contains(ev.target) || $d(ev.target).selfOrUp(vw.triggerSelector)){return}
      if(vw.el.isVisible()){
        vw.hide();
      }
    } );
     $d.fillContainer(vw.el.q(".notification-list"))
   })
  },



 });











module.exports=AppnotificationsView
}
__bootstrap__.modules["garage/capacity"] = function(module){
/**
 * Created by Atul on 5/24/2015.
 */
var app=$.require("app")
var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")
var DataGrid=$.require("DataGrid")
var capacityview=$.require("garage/capacityview")
var PopupView=$.require("PopupView")
function controller(el) {
    if(this.visibleFirst && !this.model){
        this.model=$.model.newInstance()
    }
      el.parent().fillContainer("min");
     el.fillContainer("min");
    var gr=el.q(".capacity-grid")
    //el.parent().fillContainer( );
    // el.fillContainer( );
    gr.fillContainer("min" );
    if(!this.visibleFirst){
        return;
    }
    capacityview.init(gr);
    capacityview.build($.date().trunc());
    function slotalloc(data){
        capacityview.updateSlot(data)
    }

    app.onRemote("slotalloc",slotalloc);
    app.onRemote("reserved",slotalloc);
    app.onRemote(function(){
        // gr.up(".garageschedule").fillContainer( )
        // gr.parent().fillContainer( );
        //  gr.fillContainer( );
        //   gr.q(".row-set-wrap").fillContainer( );
        //   gr.q(".row-set").fillContainer( );
        //    if(capacityview.config.scroll){
        //        capacityview.config.scroll.resetDims()
        //    }
    })
    return

    el.parent().fillContainer( "min");

    el.fillContainer("min" );
         gr.fillContainer("min" );
        var holder=this.data("_grid");
        if(!holder){
            holder= {}
            this.data("_grid",holder)
            app.getEntity("facility_reserveusers").then(function(ent){
                holder.formPanel=new PopupView({height:460,width:500,footer:{height:30},modal:true})
                holder.store=ent.createStore( true)

                ent.updateFields({
                    facility_id: {
                        hidden: true
                    },
                    date_from: {type: "date"},
                    time_from: {type: "time",cellui:{style:{whiteSpace:"nowrap"}}},
                    created_by:{hidden: true},
                    createdon: {hidden: true}
                });
                holder.store.defaultCriteria="facility_id="+app.user.facility.id
                holder.store.provider.includelookups=false;
                var opt={entityForm:{},sortable:true,scrollable:true,  resizable:true,columns:"reserve_num date_from time_from scheduled_duration actual_duration slot firstname lastname, vehicle_type vehicle_plate  vehicle_color".split(/\s+/)}
                holder.grid=new  DataGrid(holder.store,opt);

                holder.grid.build(gr )
                holder.grid.pager.loadPage()
            });
        } else if(holder.grid){
            holder.grid.resize();
        }
}

var garage_capacity=app.defineView({ id:"garageschedule", template:"garagespacemngmnt",title:"Capacity Management",controller:controller});

module.exports=garage_capacity
}
__bootstrap__.modules["garage/capacityview"] = function(module){
var DATEFORMAT="ddd, mmm dd yyyy"
var crit=$.template("facility_id=$facid and computed_end_long>=$st and computed_start_long<=$end")
var ReserveModel=$.require("models/ReserveModel")
var ReserveCardView=$.require("common/ReserveCardView")
var storeSlotReserve=null,storeSlots=null,busy= 0,hrflds=[],ready= 0,pending=null,confirmVw=null;
var FILTERONDRAG=false
function loadStore(dt ,callback) {
    var d = $.date(dt).trunc();
    var end = d.clone().plus("d", 1)
    storeSlotReserve.clear();
    storeSlotReserve.load({criteria:crit(app.user.facility.id, +d, +end)}).then(function (a) {
         callback(d, storeSlotReserve)
    });
}
function syncStore(){
    var fldkeys=hrflds,fldkeysln=fldkeys.length;
    var gpd=storeSlotReserve.groupBy("slotid")


    storeSlots.each(
        function(slot){//slot._state="reset"
            for(var i= 0;i<fldkeysln;i++){
                slot.set(fldkeys[i],null,true);
            }
            var l=gpd.get(slot.id+"");
            if(l){
                l.forEach(function(rec){
                    if(!rec.slotkey ){return}
                    // var ky="h_"+rec.hrs+(rec.mins?("_"+rec.mins):"")//,dur=rec.get("actual_duration")||rec.get("scheduled_duration")||1
                    slot.set(rec.slotkey,rec)

                })
            } else{

            }

        }
    );
}
function refreshStore(dt ,callback){
     if(!storeSlotReserve ){return}
    loadStore(dt,function(d,store){
            syncStore()
            callback(d)
        })
}
var refreshStore_throttled=$.throttle(refreshStore)
function buildHeader(strtdate) {
    var weeks=[
        "<div class='header-wrap'>" ,
        // "<div class='scroller'>"+scrollerhtml+"<div class='scroller-date-selector'><div class='left'></div><div class='right'></div><div class='middle'></div></div></div>",
        "<div class='day-lbl'><span class='prev-date'>&lt;</span><span class='date-lbl'>"+$.date.format(strtdate,DATEFORMAT)+"</span><span class='next-date'>&gt;</span></div>",
         "<div class='day-slots-opts'><span class='refresh-link ui-button small'>Refresh</span><span class='slot-filter-label'>Show only</span><span class='slot-filter only-av'>Available</span><span class='slot-filter only-occupied'>Occupied</span><div class='slot-filter-message'></div></div>",
        "<span class='slot-name-ph slot-name'>Slot</span><span class='day-hdr-wrap'><span class='day-hdr day-gradient'>"

    ]
    var hours=List.create(23,function(a){var h=(a+1);
        return  "<span class='slot hr'    data-key='"+h+"'>"   +   h+"</span>" +
                "<span class='slot qtr'   data-key='"+(h+"_15")+"'>15</span>" +
                "<span class='slot  half' data-key='"+(h+"_30")+"'>30</span>" +
                "<span class='slot  qtr2' data-key='"+(h+"_45")+"'>45</span>"}).join("");
    weeks.push(hours,"",
        "</span>", "</span>",
        "<div class='header-spanner'><div class='header-spanner-stub'><div class='header-spanner-stub-left'></div><div class='header-spanner-stub-message'></div><div class='header-spanner-stub-right'></div></div></div>",
       "</div>"
    )
    return weeks.join("")
}

function buildView(strtdate  ) {

    var rows=[], ln=hrflds.length;
     storeSlots.each(
        function(a){var sid=a.id;

            var cells=["<div class='slot-row"+(a.currentstate==2?" notav":"") +"' data-slot='"+ sid +"'><span  class='slot-name'>"+ (a.name||("slot "+ sid)) +"</span>"]
            for(var i=0;i<ln;i++){
                var k=hrflds[i],v= a.get(k),kls="slot"+(k.length<=4?" hr":"")
                if(v && v.get){
                    var dur=v.get("actual_duration")||v.get("scheduled_duration")|| 1,status=v.get("resstatus")
                    if(typeof(dur)!="number" || !(dur>0) ){dur=1}
                    var span=dur*4
                         var wd=100*span,ml=dur*2;
                        kls=kls+(status==1?" isconfirmed":" isreserved")

                        cells.push("<span id='id_"+(sid+"_"+k)+"' class='isoccupied "+kls+"' data-key='"+k+"'><div class='slot-content' style='width:"+wd+"%;padding:0 "+dur+"px;'></div></span>")
                    if(span>1){
                        for(var ii=1;ii<span;ii++){
                            if(i+1>= ln-1){break;}
                            i++;
                            var k1=hrflds[i]
                            cells.push("<span id='id_"+(sid+"_"+k1)+"' class='slot isoccupied' data-key='"+k+"'><div class='slot-content'></div></span>")
                        }
                    }
                        continue;

                }
               cells.push("<span id='id_"+(sid+"_"+k)+"' class='"+kls+"' data-key='"+k+"'><div class='slot-content'></div></span>")



            }
            cells.push("</div>")

            rows.push(cells.join(""))
        }
    );

    return rows.join("")

}
function afterLoad(stdt){
    this.config.header.q(".date-lbl").html($.date(this.config.date).format(DATEFORMAT))

    var dayhdr=this.config.dom.q(".day-hdr"),rowset=this.config.rowset
    this.config.dom.removeClass("loading")
    rowset.css({width:(dayhdr.offsetWidth+dayhdr.parent().offsetLeft )})
    //rowset.parent().css({height:$.viewport.height - (rowset.bounds().top+10) })


    if(!this.config.scroll){
        app.setScroll(false);
         this.config.scroll=this.setupScroll();
         this.config.scroll.setup();
    }
 }
var capacityview={
    config:{},
    setupScroll:function(){
        var view=this;
        var hscroll,vscroll,slotwd=null,slotht=null,horscrollinner=null,vertscrollinner=null,horscroll=null,vertscroll=null,rowset,rowsetwrp,scrollwrapwd=0,
            dom,leftOffset=0,topOffset= 0,
            scrollQu={
            left:null,top:null,p:0,maxw:0
        }
        function resetDims(){
            var  ht=$.viewport.height-(topOffset );
            rowsetwrp.css("height",ht)
            horscroll.css({ width:($.viewport.width-( leftOffset))})
            horscrollinner.css({width:rowset.scrollWidth})
            vertscrollinner.el.style.height=rowset.scrollHeight+"px"
            vertscroll.css({ height:ht})
             scrollQu.maxw=rowset.scrollWidth-(rowsetwrp.offsetWidth -10)
         }
        function setup(){
            dom=view.config.dom
            rowset = dom.q(".row-set");
            var scrollwrap=dom.q(".slot-name-wrap")
                rowsetwrp = dom.q(".row-set-wrap");
            horscroll=rowset.after("<div class='hor-scroll'></div>")
            vertscroll=rowset.after("<div  class='ver-scroll'></div>")
            scrollwrapwd=scrollwrap.width()
            horscroll.css({position:"absolute",left:scrollwrapwd,width:dom.clientWidth-scrollwrapwd,bottom:0,height:18,bg:"#efefef",overflowX:"auto"})
            var ht=dom.clientHeight - rowsetwrp.offsetTop
            vertscroll.css({position:"absolute",right:0,width:18,top:0,height:ht-20,bg:"#efefef",overflowY:"auto"})
            rowsetwrp.css({height:ht  })
            horscrollinner=horscroll.insert("<div>").css("h",1)
            vertscrollinner=vertscroll.insert("<div>")

            vertscrollinner.addClass("ver-scroll-inner")
            var bounds=rowset.bounds()
            leftOffset=bounds.left+scrollwrapwd
            topOffset=bounds.top
            setTimeout(function(){
                resetDims();

            },100)
            resetDims();

            var dayhdr=dom.q(".day-hdr"),spanner=$d(".header-spanner")

            function _apply(){
                if(scrollQu.left!=null) {
                    var l=scrollQu.left;scrollQu.left=null
                    l=Math.max(0,Math.min(scrollQu.maxw||l,l))
                     //scrollwrap.css("left", l)
                    if (dayhdr) {
                        dayhdr.css("marginLeft", 0 - l)
                    }
                    rowset.css("marginLeft",0 - l)
                    if (spanner) {
                        var trgt = $d(spanner.data("_target"))
                        if (trgt) {
                            var l1 = trgt.bounds().left   - (spanner.parent().bounds().left+scrollwrap.offsetWidth)
                            spanner.css("left", l1)
                        }
                    }

                }
                if(scrollQu.top!=null) {
                    var l=scrollQu.top;scrollQu.top=null
                    rowset.css("marginTop",0 - l)
                    scrollwrap.scrollTop=l
                }
                scrollQu.p=0
            };
            hscroll=function hscroll(l){
                if(slotwd===null){
                    slotwd=rowset.q(".slot").width()
                    var x = scrollQu.maxw+slotwd
                    scrollQu.maxw=x-(x%slotwd)
                }
                var diff=Math.floor(l%slotwd);
                l=l-diff

                if(!scrollwrap){
                    scrollwrap=dom.q(".slot-name-wrap")
                    if(scrollwrap){
                        scrollwrap.css("h",rowset.scrollHeight)
                    }
                }

                scrollQu.left=l
                if(!scrollQu.p){
                    scrollQu.p=1
                    $d.util.animframe(_apply);
                }
            }


            vscroll=function vScroll(scrollTop){
                if(slotht===null){
                    slotht=rowset.q(".slot").height()
                }
                if(scrollTop<=slotht){
                    scrollQu.top=0
                }
                else {
                    var diff = Math.floor((scrollTop + slotht) % slotht);
                    scrollQu.top = Math.max(0, (scrollTop + slotht) - diff)
                }
                if(!scrollQu.p){
                    scrollQu.p=1
                    $d.util.animframe(_apply);
                }
            }
            vertscroll.on("scroll",function(){ vscroll(this.scrollTop) });
            horscroll.on("scroll",function(){ hscroll(this.scrollLeft)});

            rowsetwrp.on("wheel",function(event){
                var deltaY=event.wheelDeltaY||event.deltaY
                 if(deltaY){
                     if(slotht===null){
                         slotht=rowset.q(".slot").height()
                     }
                    vertscroll.scrollTop=vertscroll.scrollTop+(slotht*10*(deltaY>0?-1:1))
                 }
            });
             $.viewport.on(resetDims)
        }
        return {
            setup:setup ,
            reset:function(){

            },
            scrollToRow:function(rowid){
                if(rowid) {
                    var trgt = view.config.dom.q(".slot[data-slot='" + rowid + "']")
                }
            },
            scrollToSlot:function(slotkey){
                if(slotkey){
                    var trgt=view.config.dayhdr.q(".slot[data-key='"+slotkey+"']")
                    if(trgt){
                        var b=trgt.bounds()
                        var left=Math.max(leftOffset,trgt.bounds().right-leftOffset)
                        if(left>0){
                            hscroll(left)
                        }
                    }
                }
            },
            scrollTo:function(x,y){
                if(x>0 ){
                    if(x>horscroll.offsetWidth){horscroll.el.scrollLeft=x}
                    else{horscroll.el.scrollLeft=0}

                }
                if(y){
                    vscroll(y)
                }
            },

            resetDims:resetDims
        }
    },
    redraw:function(sync){
        if(sync===true){
            syncStore();
        }
        var start=$.date(this.config.date),stdt=Date.now(),b=this.config.dom.bounds(),spanner=$d(".header-spanner"),rowset=this.config.rowset

        $d.html(this.config.rowset, buildView(start));
         var hrdom=this.config.dayhdr.q(".hr"),hrwd=20,top=0
        if(hrdom.next(".hr")) {
            hrwd = hrdom.next(".hr").offsetLeft - hrdom.offsetLeft
        }
        top = (this.config.dayhdr.bounds().top - b.top) - 10
        spanner.css({"visibility":"visible","top":top,
            "height":this.config.dom.height()-top,"width":hrwd})
        var slotkey,slotkeyend,trgt =$d(spanner.data("_target"))
        if(!trgt){
            var now=new Date()
            var mins = now.getMinutes(), hr = now.getHours()
            if (mins % 15) {
                if (mins > 40) {       mins = 45  }
                else if (mins > 25) {    mins = 30       }
                else if (mins > 10) {     mins = 15      }
                else {            mins = 0   }
            }
            slotkey =  hr+(mins?("_"+mins):"")
            slotkeyend=(hr+1)+(mins?("_"+mins):"")
            trgt=this.config.dayhdr.q(".slot[data-key='"+slotkey+"']")
        } else{
            slotkey =  $d.domdata(trgt,"key")
            slotkeyend =  $d.data(spanner,"_slotend")
        }
         this.config.range={start:slotkey,end:slotkeyend}

        var ht=this.config.dayhdr.parent().offsetTop+this.config.dayhdr.parent().offsetHeight
        if(this.config.header){
            this.config.header.css("h",ht)
        }
        if(trgt){
            if(slotkeyend){
                var trgtEnd=this.config.dayhdr.q(".slot[data-key='"+slotkeyend+"']")
                if(trgtEnd){
                    spanner.css("width",trgtEnd.offsetLeft - trgt.offsetLeft)
                }
            }
             spanner.data("_target",trgt.id)
            spanner.data("_slotend",slotkeyend)
            var hdrwrap=spanner.parent();
            var l=trgt.bounds().left-hdrwrap.bounds().left
             spanner.css("left",l)
            var slotnameph=this.config.dom.q(".slot-name-ph")
             if(this.config.scroll){
                this.config.scroll.scrollTo(l-(slotnameph?slotnameph.offsetWidth:0) )
            }

        } else{

        }
        afterLoad.call(this,stdt)
        setTimeout(function(spanner){
            spanner.css({"height":this.config.dom.height()-(spanner.bounds().top - this.config.dom.bounds().top)})
            this.filterRange();
            var slotnameph=this.config.dom.q(".slot-name-ph")
            if(this.config.scroll){
                 this.config.scroll.scrollTo(spanner.offsetLeft-(slotnameph?slotnameph.offsetWidth:0) )
            }
        }.bind(this,spanner,b),1000)

    },
    getStore:function(){
      return storeSlotReserve
    },
    updateSlot:function(data){
        if(!(storeSlots && storeSlotReserve)){return}
        data=data.data||data
        var st,store=storeSlotReserve
        if(data.st||data.computed_start_long){
            st=String(data.st||data.computed_start_long).replace(/\d{3}$/, "000")
        }
 var slot,slotkey
        if(st && store){
            var rec=store.findById(data.id)
            if(!rec){
                rec=store.find(function(rec){return String(rec.computed_start_long)==st})
            }
            if(!rec) {
                rec = store.addRecord(data)
             }
            if(rec) {
                if($.isPlain(data)){
                    rec.update(data);
                }
                slot = rec.get("slotid"), slotkey = rec.get("slotkey") || rec.slotkey
                if (slot && slotkey) {
                    var slotrec = storeSlots.findById(slot)
                    if (slotrec) {
                        slotrec.set(slotkey, rec)
                    }
                }
            }

            if(!(rec && slot && slotkey && this.config.dom && $d.isVisible(this.config.dom))){return}

                        var id="id_"+slot+"_"+slotkey,el=document.getElementById(id),status=rec.get("resstatus");
                        var kls=(status==1?"isconfirmed":"isreserved")
                        if(el){
                            $d.removeClass(el,["isconfirmed","isreserved"]).addClass( [kls,"isoccupied"]);
                            var dur=rec.get("actual_duration")||rec.get("scheduled_duration")||1
                            if(typeof(dur)!="number" || !(dur>0) ){dur=1}
                            var span=dur*4

                            var rec=100*span,ml=dur*2;
                            $d.css(el.firstElementChild,{"width":(span*100)+"%",marginLeft:ml+"px"});
                            if(span>1){var nxtall=$d.nextAll(el,".slot")
                                for(var ii=1;ii<span;ii++){
                                    if(!nxtall.length){break;}
                                    var nxt=nxtall.shift();
                                    if(nxt.hasClass("isoccupied")){nxt.addClass("isconflict")}
                                    nxt.addClass("isoccupied").domdata("key",slotkey)

                                }
                            }
                        } else{  }

                    }



    },
    init:function(dom){
        ready=-1;
        this.config.dom=dom;
        var flds1={
            id:{type:"number"},
            slotname:{type:"string"},
            loc:{type:"string"},
            currentstate:{type:"number"}
            }
        List.create(23,function(a){var i=a +1;hrflds.push("h_"+i,"h_"+i+"_15","h_"+i+"_30","h_"+i+"_45")});
        hrflds.forEach(function(a){flds1[a]={type:"object"}})
        app.getEntity("facility_reserveusers").then(
            function(e){
                 storeSlotReserve=e.createStore(true);
                storeSlotReserve.StoreRecordProto.addExpr("reserveDate",function(rec){
                    return $.date.format(rec.get("date_from"),"mmm dd, yyyy")
                })
                storeSlotReserve.StoreRecordProto.addExpr("reserveTime",function(rec){
                    return $.date.format(rec.get("time_from"),"hh:nn tt")
                })

                storeSlotReserve.StoreRecordProto.addExpr("slotkey",function(rec){
                    if(!rec || !rec.__record__){return null}
                    rec.__temp||(rec.__temp={});
                    var dt,st,slotkey=rec.__temp.slotkey
                   // if(slotkey!=null){return slotkey}

                        dt= rec.get("computed_start_long")
                        if(!dt){return rec.__temp.slotkey }
                        st = new Date(+dt)
                        if (st) {
                            var mins = st.getMinutes(), hr = st.getHours()
                            if (mins % 15) {
                                if (mins > 40) {       mins = 45  }
                                else if (mins > 25) {    mins = 30       }
                                else if (mins > 10) {     mins = 15      }
                                else {            mins = 0   }
                            }
                            rec.__temp.mins = mins;
                            rec.__temp.hrs = hr;
                            slotkey = "h_"+hr+(mins?("_"+mins):"")
                        }

                     return rec.__temp.slotkey= slotkey
                })
                storeSlotReserve.pager.pagesize=-1
             }
        );
        var ent=Data.defineLocalEntity("allslotshrs",flds1)
          storeSlots=ent.createStore(true);

                this.refreshSlots().then(
                    function(){ ready=1;
                        if(pending && pending.length){
                            capacityview.build.apply(capacityview,pending.slice())

                        }
                        pending=null;
                    }
                )


    },
    refreshSlots:function(){
        var pr=Promise.deferred();
        app.remoteDirective("slots",{type: "slots", facility_id:app.user.facility.id }, function (a) {
            var data=a;
            if(data.data){data= data.data}
            if(data && data.items){storeSlots.clear();
                storeSlots.addAll(data.items.map(function(it){return {id:it.id,slotname:it.name,loc:it.location,currentstate:it.currentstate}}))
            }
            pr.resolve()

        });
        return pr
    },
    filterRange:function(){
        if(this.config.allvis==null){this.config.allvis=true;}
        var start,end,occupied=-1,slots
        if(this.config.range && this.config.range.start && this.config.range.end) {
            var date = $.date(this.config.date)
            var start = date.clone().trunc(), end = date.clone().trunc()
            var arr = String(this.config.range.start).split(/_/)
            if (arr[0]) {
                start.setHours(+arr.shift())
                if (arr[0]) {
                    start.setMinutes(+arr.shift())
                }
            }
            arr = String(this.config.range.end).split(/_/)
            if (arr[0]) {
                end.setHours(+arr.shift())
                if (arr[0]) {
                    end.setMinutes(+arr.shift())
                }
            }
            var startnum= (+start)
            var endnum= (+end)
            slots=storeSlotReserve.findAll(function(r){
                return  r.computed_end_long > startnum+1 && r.computed_start_long < endnum-1;
            }).collect("slotid").sortBy(Number);
            occupied=slots.length
        }
        if(slots && this.config.filter){


            var tohide=[], onlyav=this.config.filter=="av"
            var rowset = this.config.dom.q(".row-set")
            var all1 = this.config.dom.qq(".slot-name-wrap .slot-name")
              //computed_start_long,computed_end_long
            if(occupied>0) {
                 rowset.hide()
                var all = rowset.qq(".slot-row");
                rowset.removeClass("filtered-view")
                tohide = all.filter(function (a,i) {
                    var idx = slots.indexOf(Number(a.domdata("slot")));
                    a._index=i
                    if (onlyav) {
                        return idx >= 0
                    }
                    return idx < 0
                });
            }
            if(!this.config.allvis ){
                for(var i= 0,l=this.config.dom.qq(".filtered-row"),ln=l.length;i<ln;i++){
                    l[i].el.classList.remove("filtered-row")

                    //all[i].el.style.display=""
                }

                this.config.allvis=true
            }

            if(tohide.length){
                for(var i= 0,ln=tohide.length;i<ln;i++){
                    tohide[i].el.classList.add("filtered-row")
                    var wrap=all1[tohide[i]._index]
                     if(wrap){wrap.el.classList.add("filtered-row")}

                    //tohide[i].el.style.display="none"
                }
                this.config.allvis=false
            }
             rowset.addClass("filtered-view").show()


        } else if(!this.config.allvis){
            for(var i= 0,l=this.config.dom.qq(".filtered-row"),ln=l.length;i<ln;i++){
                l[i].el.classList.remove("filtered-row")
             }
             this.config.allvis=true
        }
        var stub=this.config.dom.q(".header-spanner-stub-message")
        var all=this.config.dom.qq(".row-set .slot-row").length
        if(stub){
            if(occupied<=0){stub.html("")}
            else{var rest=this.config.filter=="av"?(all-occupied):occupied
                stub.html(rest + " / "+ all)
            }
        }
        var msg=this.config.dom.q(".slot-filter-message")
        if(msg){var m=[]
            if(start){m.push($.date.format(start,"hh:nn tt"),"to",$.date.format(end,"hh:nn")+",")}
            if(occupied>=0){m.push("occupied",occupied," of ");}
            m.push(all);
            msg.html(m.join(" "))
        }
        if(this.config.scroll){
            this.config.scroll.resetDims()
        }

    },
    hoverSlot:function(slot,rem) {
        var rs=$d.up(slot,".row-set"),has=$d.hasClass(slot,"hover-slot")
        if(rs && rs.hasClass("dragging-slot") && rem!==false){return}
        if(!rs){return}
        var row=$d.parent(slot),id=$d(slot).id;
        if(rem===false){
            if(rs.data("_priorslot")!==$d.domdata(slot,"key")){
                rs.qq(".hover-slot").each(function(a){$d.removeClass(a,"hover-slot")})
            }

            rs.qq(".hover").each(function(a){$d.removeClass(a,"hover")})
        }
        if(!rem){
            if(!has){
                rs.qq(".slot:nth-child("+($d.at(slot)+1)+")").each(function(a){$d.addClass(a,"hover-slot")})
            }
            if(row) {
                if (!row.hasClass("hover")) {
                    row.addClass("hover")
                    $d.addClass(this.config.slotnamewrap.q(".slot-name[data-slot='" + row.domdata("slot") + "']"), "hover")
                 }

            }
        }

        if(rem ){
            if(has){
                rs.qq(".slot:nth-child("+($d.at(slot)+1)+")").each(function(a){$d.removeClass(a,"hover-slot")})
            }
            if(row){
                if(row.hasClass("hover")) {
                    row.removeClass("hover")
                    $d.removeClass(this.config.slotnamewrap.q(".slot-name[data-slot='" + row.domdata("slot") + "']"), "hover")
                }
            }
        }
        rs.data("_priorslot",$d.domdata(slot,"key"))
        rs.data("_prior",id)

    },
    build:function(start,norefresh) {
        if (ready !== 1) {
            pending = [start, norefresh]
            if (!ready) {
                this.init();
            }
            return;
        }
        var startdate = start?$.date(start).trunc():this.config.date
        var dom = this.config.dom, isnu;

        this.config.date = startdate;
        if (!this.config.rowset) {
            isnu = true
            dom.addClass("noselection")
            dom.html(buildHeader(startdate) + "<div class='row-set-wrap'><div class='row-set'></div><div class='slot-name-wrap'></div></div><div class='loading-msg'>Loading ..</div>")

            dom.q(".refresh-link").on("click",function(ev) {
                this.refreshSlots().then(this.build.bind(this))
            }.bind(this));
            dom.q(".only-occupied").on("click",function(ev) {var el=$d(ev.target)
                if(el.is(".selected")){el.removeClass("selected");this.config.filter="";}
                else {
                    el.parent().st(".selected").removeClass("selected")
                    el.addClass("selected")
                    this.config.filter = "occupied";
                }
                this.filterRange()
            }.bind(this))
            dom.q(".only-av").on("click",function(ev) {var el=$d(ev.target)
                if(el.is(".selected")){el.removeClass("selected");this.config.filter="";}
                else {
                    el.parent().st(".selected").removeClass("selected")
                    el.addClass("selected")
                    this.config.filter = "av";
                }
                this.filterRange()
            }.bind(this))
            this.config.rowset = dom.q(".row-set");
            this.config.header = dom.q(".header-wrap");
            var slotnamewraphtml= storeSlots.collect(function(a){return "<span  class='slot-name' data-slot='"+a.id+"'>"+ (a.name||("slot "+ a.id)) +"</span>"})
            this.config.slotnamewrap=dom.q(".slot-name-wrap");
            this.config.slotnamewrap.html(slotnamewraphtml.join(""))

            $d.hover(this.config.rowset,function(a,slot){
                this.hoverSlot(slot)
            }.bind(this),function(a,slot){
                this.hoverSlot(slot,true)
            }.bind(this),".slot")

         }
        if (this.config.rowset) {
            this.config.dom.addClass("loading")
            this.config.header.q(".date-lbl").html("loading ...")
            if(norefresh===true){
                this.redraw();
            }
            else {

                refreshStore(this.config.date, this.redraw.bind(this))

            }
            if (!isnu) {
                return;
            }
        }
        //$d.fillContainer(dom);
        var rowset = dom.q(".row-set");
        var dayhdr = dom.q(".day-hdr")
        this.config.dayhdr = dayhdr;
        this.config.header.q(".next-date").on("click", function () {
            this.build(this.config.date.clone().plus("d", 1))
        }.bind(this))
        this.config.header.q(".prev-date").on("click", function () {
            this.build(this.config.date.clone().plus("d", -1))
        }.bind(this))
        this.config.header.q(".date-lbl").on("click", function (ev) {
            var el = $d.selfOrUp(ev.target, ".date-lbl"), date = this.config.date, ths = this;
            $.require("UI.Calendar", function (cal) {
                    var model = cal(null, {
                        ip: el,
                        onselect: function (k, lbl) {
                            ths.build($.date(k))
                             model.view.hide()
                        }
                    } )
                    model.render(date)
                }
            )
        }.bind(this))
        function findSlot(dragel) {
            var b=dragel.bounds(),pt= {x:b.left+4,y: b.top+5};
            dragel.el.style.display = "none"

            var el = document.elementFromPoint(pt.x, pt.y)
            if (el && $d.selfOrUp(el, ".slot-row")) {
                el = $d.selfOrUp(el, ".slot")
            }
            dragel.el.style.display = ""

            return el;
        };
        function dragSlot(ev,trgt,resrec,slotrec,offset) {
            var target = trgt.clone(true).css({cursor: "move",borderLeft:"none",borderLeftStyle:"none",marginLeft:0}).addClass("slot-clone"), prev=null,ths=this;
            trgt.before(target)
              $d.absolutize(target)
            trgt.parent().append(target)
            target.toFront( );
             trgt.hide()
            var rowset=trgt.up(".row-set")
            var tr = $d.trackMouse(), stw = target.offsetLeft, sth = target.offsetTop,prev=null,initoffset=offset;
            $d.on(target,"mousedown",function(){
                $d.trackMouse(
                     {target:target,
                        start: function (memo) {
                            if(rowset){rowset.addClass("dragging-slot")}
                            target.css("outline","1px solid blue")
                        },
                        move: function (memo) {
                            var el = findSlot(target, ev.data.point) || prev
                            if(el){ths.hoverSlot(el,false)}

                        },
                    end: function (memo) {
                        $d.css(target,"outline",null)
                        var resrec=this.record,target=this.target,trgt=this.orig,wd = target.scrollWidth
                        var el = findSlot(target, memo.pos) || prev
                        target.remove();
                        trgt.show( )
                        prev = null;
                        if(rowset){rowset.removeClass("dragging-slot")}
                        if (!el) {
                            return
                        }
                        el.style.backgroundColor = "transparent"
                        if ((el && el != trgt)) {
                             trgt.removeClass(["isreserved", "isconfirmed"]).css("width", null)
                             if ($d.q(el, ".slot-content")) {
                                  var dt= $.date(resrec.get("computed_start_long"))
                                 dt.trunc();
                                 var orig=resrec.slotkey,hr=el.domdata("key").split(/_/).map(Number),nuslot=$d.up(el, ".slot-row").domdata("slot")
                                 hr.shift()
                                 dt.hours=hr.shift()||0
                                 dt.minutes=hr.shift()||0
                                  var upd={
                                     slotid:nuslot,
                                     computed_start_long:+dt,
                                     time_from:dt
                                 }
                                 var slotrec = storeSlots.findById(resrec.slotid)
                                 if(slotrec){slotrec.set(orig,null)}

                                 resrec.__temp=null;
                                 resrec.update(upd);
                                 slotrec = storeSlots.findById(nuslot)
                                 if(slotrec){slotrec.set(resrec.slotkey,resrec)}
                                   //syncStore()

                                 capacityview.build(null,true)
                                  return
                                $.webSocket.dispatch("slotalloc", {
                                    slotid: resrec.slotid,
                                    st: trgt.domdata("key"),
                                    reserve_id: resrec.id,
                                    remove: true
                                })
                                $.webSocket.dispatch("slotalloc", {
                                    slotid: $d.up(el, ".slot-row").domdata("slot"),
                                    st: $d.domdata(el, "key"),
                                    reserve_num: resrec.reserve_num,
                                    reserve_id: resrec.id
                                })
                            }
                        }
                        //
                    }.bind({record:resrec,target:target,orig:trgt}),
                    applyElPos:true,
                     }   

                )    
            })
            
               
          }
        function showCard(trgt,slotrec) {
            ReserveCardView.show(
                {anchor:trgt,record:slotrec,id:"capacityvw",actions:{
                  "Confirm Slot":function () {
                      this.resstatus = 1;
                       app.remoteDirective("assignslot", {
                          slotid: this.reserveSlot.id,
                          reserve_num: this.reservenum,
                          reserve_id: this.reserve_id
                      },function(ev){
                           capacityview.updateSlot(ev.data)
                       })

                      this.containerVw.hide()
                  }
                }}
            )

          }
        var ths=this
        dom.on("mousedown", function (ev) {
            var trgt
            if ($d.selfOrUp(ev.target, ".slot-row")) {
                var row = $d.selfOrUp(ev.target, ".slot-row");
                var slot = row.domdata("slot")
                if (trgt = $d.selfOrUp(ev.target, ".slot-content")) {
                    ev.stopPropagation();
                    var slotcell = trgt.parent()
                    if (slotcell.is(".isoccupied")) {
                        if (!slotcell.is(".isreserved,.isconfirmed")) {
                            slotcell = slotcell.prev(".isreserved,.isconfirmed")
                        }
                        if (slotcell) {
                            trgt = slotcell.down(".slot-content") || trgt
                        }
                        var ky = trgt.parent().domdata("key")
                        if (ky && slot) {
                            var resrec=storeSlotReserve.find(function(r){return r.slotkey==ky && r.slotid==slot})
                            if(!resrec){return}
                            var slotrec = storeSlots.findById(slot),pos=$d.mousePos(ev)
                             $d.holdMouse(500,
                                 function () {
                                     dragSlot.call(ths,ev,slotcell,resrec,slotrec,pos)
                                 },
                               function () {showCard(trgt,resrec,slotrec)  },
                               true
                            );
                                //var slotrec=storeSlotReserve.find(function(r){return r.slotkey==ky})

                        }
                    }
                 }
            }

        });

        dom.q(".header-spanner-stub").on("mousedown", function (ev) {
            var target = this.parent(),taegerdir
            if($d.is(ev.target,".header-spanner-stub-left")){taegerdir="left"}
            else if($d.is(ev.target,".header-spanner-stub-right")){taegerdir="right"}

            var    stw = target.offsetLeft,max=target.parent().width()-target.offsetWidth;
            if(taegerdir=="right"){stw= target.offsetWidth}
            if($d.is(ev.target,".header-spanner-stub-left")){taegerdir="left"}
            else if($d.is(ev.target,".header-spanner-stub-right")){taegerdir="right"}
            var spans=List.from(target.parent().st(".slot").collect(function(el){return [el.id,el.offsetLeft]})),
                offset=target.parent().q(".day-hdr-wrap").offsetLeft

            var cachedwd= target.offsetWidth
            var qu={el:null,pos:null,pending:null}
                function _filter(){
                    if(!target || !target.el){return}
                    var nu=target.el.offsetLeft - offset
                    var left=spans.min(function(e){return Math.abs(e[1]-nu)  })

                    nu=nu+target.width()
                    var right=spans.min(function(e){return Math.abs(e[1]-nu)  })


                    if(left && right){
                        ths.config.range={start:$d.domdata(left[0],"key"),end:$d.domdata(right[0],"key")}
                        target.data("_slotend",$d.domdata(right[0],"key"))
                    }
                    ths.filterRange();
                }
            $d.trackMouse(
                {target:target,
                    start: function (ev) {  target.css("outline","1px solid blue")},
                    move: function (ev) {
                        var nu=stw+ev.delta.x - offset;
                         if(nu<1){nu=0}
                        if(nu>max){nu=max}
                         var closest=spans.min(function(e){return Math.abs(e[1]-nu)  })
                        if(!closest || qu.el===closest[0]){return}
                        qu.el=closest[0];
                        qu.pos=closest[1]+offset
                        if(qu.pending){return}
                        qu.pending=1
                        $d.util.animframe(function(){
                            if(qu.pos==null){return}
                            if(taegerdir==="right"){

                                target.el.style.width=  (qu.pos)+"px"
                            } else{
                                if(taegerdir==="left"){
                                    var lft=target.el.offsetLeft,curr=lft+target.el.offsetWidth
                                    target.el.style.left = (qu.pos)+"px";
                                    var wd=curr-target.el.offsetLeft;
                                    if(wd>10){
                                        target.el.style.width = wd+"px";
                                    }

                                }
                                else{target.el.style.left=qu.pos+"px"}
                                target.data("_target",qu.el)


                            }

                            qu.pending=null;
                            FILTERONDRAG && _filter()
                        });
                    },
                    end: function (ev) {
                        target.css("outline",null)
                        _filter()
                        //
                    }
                }
            )
             
        });

    }
 }
module.exports=capacityview
}
__bootstrap__.modules["garage/checkin"] = function(module){
var app=$.require("app")
var utils=$.require("garage/garageutils")
var userutils=$.require("common/AppUtil")
var service=$.require("garage/garageservice")
var SlotView= $.require("garage/SlotView")
var VehicleWidget= $.require("common/VehicleWidget")
var ReserveModel=$.require("models/ReserveModel")
var ReserveCheckInCheckOut=$.require("common/ReserveCheckInCheckOut")
var SimpleView=$.require("SimpleView")
var PopupView=$.require("PopupView")
var resstore = null,userrowTemplate, rowTemplate = null

function dowalkinNonmember(ev){
    var plate=this.el.q(".non-member-checkin .plate_num").val(),state=this.el.q(".non-member-checkin .plate_num_state").val()
    if(!plate || /\s/.test(plate)) {
        app.splashError("Invalid Plate number<br/>Spaces and special characters are not allowed.<br/>Please enter a valild number")
        return
    }
    ReserveCheckInCheckOut.walkinNonmember(state+"-"+plate.toUpperCase(),app.user.facility_id,function(data){
        showInfo.call(this,data,true);
    }.bind(this))

}


function docheckin(ev) {
    if(ev && $d.selfOrUp(ev.target,".hasnocontent")){return}
    this.clearSearch();
    var v=this.vehicleWidget.getDataRecord();
    if(typeof(v.id)!="number"){v.id=0}
    if(!this.model.reservenum) {
        if(this.model.isNonMember){
            this.model.userVehicle.update(v)
            this.model.user.firstname = this.$(".user-firstname").val()||""
            this.model.user.lastname  = this.$(".user-lastname").val()||""
            this.model.user.email     = this.$(".user-email").val()||""
            this.model.user.phonenumber=this.$(".user-phonenumber").val()||""
        }
        //dowalkin.call(this);
    }

    var nudate=new Date()
    this.model.schedule.setEntryTime(nudate)
    var data={
        facility_id:this.model.facility.id,
        reservenum:this.model.reservenum
    }
    this.model.schedule.getDataRecord(data);
    var veh=this.model.userVehicle.toMap()
    veh.vehicle_id=veh.id
    delete veh.id
    $.extend(data,veh);
    data.member_id=this.model.user.id;
    app.remoteDirective("docheckin",{
        sel:data
    }).then(function(res){
        if(!(res && typeof(res )=="object")){return}
        //resstore.clear();
        if(res && res.confirmed){
            res=res.confirmed;
        } else{
            if(res && res.error){
                app.splashError(res.error)
                return;
            }
        }

        //resstore.load({includelookups:false})
        if(!this.model.reservenum && res.reserve_num){
            this.model.readRecord(res)
        }
        // app.showClaimCheck({reservenum:this.model.reservenum})
        $.require("common/ReserveCardView").show({template:"claimcheck",
            showOptions:true,title:"Claim check",
            record:this.model
        });
        // utils.showclaimCheck(this.model)
        clear.call(this)
    }.bind(this));
        return
    var reserveCheckInCheckOut = new ReserveCheckInCheckOut(this.model,"checkin");
    if(this.model.isNonMember){
        reserveCheckInCheckOut.baseModel.isNonMember=true
        reserveCheckInCheckOut.baseModel.user.id=reserveCheckInCheckOut.baseModel.user.nonmember_id=this.model.user.id||this.model.user.nonmember_id
    }
    reserveCheckInCheckOut.checkin(
        function(res){
            if(!(res && typeof(res )=="object")){return}
            //resstore.clear();
            if(res && res.confirmed){
                res=res.confirmed;
            } else{
                if(res && res.error){
                    app.splashError(res.error)
                    return;
                }
            }

            //resstore.load({includelookups:false})
            if(!this.model.reservenum && res.reserve_num){
                this.model.readRecord(res)
            }
            // app.showClaimCheck({reservenum:this.model.reservenum})
            $.require("common/ReserveCardView").show({template:"claimcheck",
                showOptions:true,title:"Claim check",
                record:this.model
            });
            // utils.showclaimCheck(this.model)
            clear.call(this)

            //if(res===false){ pr.reject();return }
            //showInfo.call(ths,res===true?this.baseModel:res);
            //pr.resolve()
        }.bind(this) );
    /*ReserveCheckInCheckOut.checkin(this.model ,
     function(){
     resstore.clear();
     resstore.load()
     showclaimCheck.call(this)
     clear.call(this)
     }.bind(this))*/


}
function clear(excludeip,excludemodel){
    this.el.addClass("hasnocontent")
    if(this.cloak){this.cloak.show()}
    this.el.qq(".check-in-info input,.check-in-info select").prop("disabled","disabled")
    if(excludemodel!==true){
        this.model.clearValues(["stateOptions"]);
        this.vehicleWidget.model.clearValues();
    }
    if(excludeip!==true){
        this.el.qq(".plate_num").val("")
    }
    this.el.q(".check-in-info").css("overflow","hidden").anim("height",1,"fast")
    this._cleared=true;
}
function forBarCode(code,pr){
    if(!code){return}
    var view=this
    app.remoteDirective("vehicledetails",{barcode:code,facility_id:this.model.facility.id}).then(
        function(data){
            if(data.error){return}
            resolveOverLaps(view,data.user,data,data.reservations)
        }
    )
   /* var ths=this,reserveCheckInCheckOut = new ReserveCheckInCheckOut({barcode:code,facility_id:app.user.facility_id},"checkin");
    reserveCheckInCheckOut.verifyCheckin(
        function(res){
            if(res===false){ pr && pr.reject();return }
            showInfo.call(ths,res===true?this.baseModel:res);
            pr && pr.resolve()
        },true )*/
}
function showInfo(rec,excludeip){
    if(!this._cleared   ) {
        clear.call(this,excludeip,rec == this.model)}
    this._cleared=false;
    if(rec !== this.model) {
        this.model.bindRecalc(true);
        if (!rec.facility_id) {
            if (!rec.facility) {
                rec.facility = app.user.facility
            }
            rec.facility_id = app.user.facility_id

        }
        this.model.readRecord(rec)
        if(rec.user && rec.user.id){
            this.model.user.id=rec.user.id;
        }
    }
    this.data("_last", "");
    var nudate=new Date()
    this.model.schedule.setEntryTime(nudate)

    if(rec.iswalkin){
        this.model.schedule.duration=2;
    }

    this.model.schedule.setupDates();
//    this.model.schedule.reserveDateTime._wraptag=true
//this
    if(!this.model.reservenum){
        this.model.reservenumlabel="Walk-in"

        if(!this.model.reserveSlot.id){
            app.remoteDirective("findslot",{facility_id:this.model.facility_id||this.model.facility.id,date_from:+this.model.schedule.reserveDateTime,date_to:+this.model.schedule.reserveDateTimeEnd},
                function(data){
                    data=data.data||data;
                    this.model.reserveSlot.readRecord(data)
                }.bind(this))
        }

    }

    this.el.removeClass("hasnocontent")
    if(this.cloak){this.cloak.hide();}
    var section=this.el.q(".check-in-info")
    section.anim("height",section.scrollHeight,"fast").then(
        function(){
            section.css({height:null})
        }
    )
    this.el.qq(".check-in-info input,.check-in-info select").prop("disabled",null)
    // this.el.q(".check-in-user-info").scrolltoView(true,true)
    //this.model.schedule.time_from=new Date()
    var dur=this.model.schedule.reserveDuration
    this.digest();
    var est=this.el.q(".est_duration")
    est && (est.value=dur);
    this.model.schedule.reserveDuration=dur
    this.vehicleWidget.model.readRecord(this.model.userVehicle.toMap())
    this.vehicleWidget.digest()

    //this.el.qq(".nonmember-info input").attr("readonly",this.model.isNonMember?null:"readonly");
}
function buildContentForcheckin(model,overlaps ,activecheckin){
    var html=["<div class='checkin-verification'>"]
     if(overlaps.some(function(a){return a.isCheckedIn()})){
        html.push("<h3 class='checkin-error'>" + app.resolveMessage("PM-003") + "</h3>")
        activecheckin=true
    } else{
         var htmlcntnt=ReserveCheckInCheckOut.buildOverLapHTML(model,overlaps,false,activecheckin,true);
         [].push.apply(html,htmlcntnt);
      }
    html.push("</div>")
    return html;

}

function resolveOverLaps(view,user,vehicle,overlaps,dialog){
    var dialogvw=dialog
    var monthly,facility_id=app.user.facility_id,vid=vehicle.id,ths=view
    var reservations=(overlaps||[]).filter(function(a){return a.vehicle_id==vid})
    if(reservations.some(function(a){return a.resstatus>1 && a.resstatus<99})){
        app.splash("already checkedin")
       // return
    }

    ths.model.clearValues(["stateOptions","facility"]);
    ths.model.user.readRecord(user);
    ths.model.userVehicle.readRecord(vehicle);
    if(reservations && reservations.length){
        if(reservations.length==11){
            var rec= $.clone(reservations[0])
            rec.user=user
            rec.vehicle=vehicle
            showInfo.call(ths,rec);
        } else {
            if(!dialogvw) {
                var optns = {
                    animateHide: true, centered: true,  width: 350,  resizable: true,  draggable: true, destroyonhide: true,
                    title: "Reservations and Checkins"
                }
                dialogvw = new PopupView(optns);
                dialogvw.addButton({
                    label: "Close",
                    callback: function () {
                        this.hide()
                    }
                })
                dialogvw.UI.border = "1px solid #666"
                dialogvw.contentUI.padding = "3px"
                dialogvw.show()


            }
            var messageDom=dialogvw.$content(),overlaps=reservations.map(ReserveModel.from);
            overlaps.forEach(function(a){
                if(a.isCheckedIn()){
                    return
                }
                a.set("overlapmode","overlaps overlaps-active")
            })
            var html=buildContentForcheckin(ths.model,overlaps )
            messageDom.html( html.join(""))
            messageDom.on("click",function(ev ){
                var el=$d(ev.target)
                if(el.selfOrUp(".continue-reserve")){
                    dialogvw && dialogvw.hide();
                    showInfo.call(ths,ths.model);
                    return;
                }
                if(!el.up(".resstatus-item")){return}
                var id=el.up(".resstatus-item").domdata("key");
                if(el.selfOrUp(".select-reserve")){
                    dialogvw && dialogvw.hide();
                    var model= overlaps.find(function(a){return a.reserve_id==id})
                    if(!model){
                        return
                    }
                    dialogvw && dialogvw.hide();
                    showInfo.call(ths, model)
                    return;
                }
                if(id && el.selfOrUp(".cancel-reserve")){
                    app.remoteDirective("cancelreserve",{reserve_id: id},function(e){
                        app.splash(e.message||"Cancelled")
                        app.remoteDirective("vehicledetails",{vehicle_id:vehicle.id,facility_id:ths.model.facility.id}).then(function(veh){
                            resolveOverLaps(view,user,vehicle, veh.reservations,dialogvw )
                        })

                    });
                }
            })

        }
     } else {
        dialogvw && dialogvw.hide();
        showInfo.call(ths,ths.model);
    }


}




function setupSlotSelection() {
    var slotstore, dialogvw = null,ths=this,slotView
    function onslotsel(slotmodel ){
        var record=slotmodel.get("record")||{}
        //if(record.reserve_num){return}

        var nuslotid=record.slotid,vw=this;
        if(!ths.model.reservenum){
            ths.model.reserveSlot.id=nuslotid;
            ths.model.reserveSlot.slotname=record.slotname||record.name;
            dialogvw.hide();
            return
        }
        app.remoteDirective("assignslot", {
            pars:{reserve_num:ths.model.reservenum,slotid:nuslotid}
        }).then(
            function(nu){
                var curr=ths.model.reserveSlot.id;
                var rec = slotstore.records.find(function(r){return r.slotid == curr});
                if(rec){
                    rec.slot_status=0;
                    vw.redraw(rec)
                }
                ths.model.reserveSlot.id=nuslotid;
                ths.model.reserveSlot.slotname=nu.slotname;
                record.read(nu);
                slotView.selectSlot(nuslotid)
                dialogvw.hide();
            }
        );
    }
    this.model.getController().mixin({
        checkinslot:function(ev) {
            var ip = $d(ev.target), model = ths.model;
            if (!dialogvw) {
                dialogvw = new PopupView({animateHide: true, resizable: true, draggable: true,showcancellink:true})
            }
            if (!slotstore) {
                slotstore = ths._parent.getSlotStore()
            }
            //if(model.reserveSlot.id){

            if(ip){ip.blur()}
            dialogvw.show()
            slotView = SlotView.slotSelector(
                {
                    id: "checkinselector",
                    container: dialogvw.$content(),
                    time_from: model.schedule.reserveDateTime,
                    time_to: model.schedule.reserveDateTimeEnd,
                    facility_id: app.user.facility_id,
                    slotstore: slotstore,
                    current: model.reserveSlot.id
                }, onslotsel);
            //}
            slotView.on("cancelled",function(){dialogvw.hide()});
        }
    })

}
function setupNonMember() {
    this.model.set("stateOptions",userutils.stateList.slice())
    this.model.set("platenumstate","NY");
    //this.el.q(".plate_num_state").addOptions(userutils.stateList.slice())
    //this.el.q(".plate_num_state").val("NY")
    this.model.getController().mixin({
        platenumkey:function(ev) {
            var val = ($d.val(ev.target) || "").trim()
            if (val && /\s/.test(val)) {
                $d.val(ev.target,val.replace(/\s/g, ''));
                //app.splashError("Invalid Plate number<br/>Spaces and special characters are not allowed.<br/>Please enter a valild number")
                return
            }
            if (ev.keyCode == 13) {
                walkinNonmember()
                ev.stopImmediatePropagation()
            }
        }
    })
}
function setupVehicleWidget(){
    this.vehicleWidget=new VehicleWidget( {container:this.el.q(".check-in-info")})
    this.vehicleWidget.render()

}
function controller() {
    if (!this.visibleFirst) {
        if(this.clearSearch){this.clearSearch()}
        return
    }
    this.model.bindRecalc(true);
    clear.call(this,false,true)
    this.model.syncFacility(app.user.facility_id);
    //update half hour
    try{   this.el.q(".val-duration").options[0].text="½"   } catch (e){}
    setupVehicleWidget.call(this)
    setupNonMember.call(this)
    utils.setupReservationSearch.call(this,userutils.RESSTATUS.RESERVED,".check-in-find",".searchcnt",resolveOverLaps.bind(this),showInfo.bind(this))
    setupSlotSelection.call(this)
    this.model.getController().mixin( {
            checkinscan:function(){
                forBarCode.call(this,"35929-8067-1657")
                //utils.captureQRCode(forBarCode.bind(this))
            }.bind(this),
            nonmembercheckin:dowalkinNonmember.bind(this),
            docheckin:docheckin.bind(this) ,
            doreset: clear.bind(this)
        }
    )

}

var garage_checkin=app.defineView( {id:"garagecheckin" ,  template:"garagecheckin2",model:new  ReserveModel(),title:"Check-in",controller:controller});

module.exports=garage_checkin
}
__bootstrap__.modules["garage/checkinout"] = function(module){
var app=$.require("app")
 var utils=$.require("garage/garageutils")
var  apputils=$.require("common/AppUtil")
var service=$.require("garage/garageservice")
var SlotView= $.require("garage/SlotView")
var VehicleWidget= $.require("common/VehicleWidget")
var ReserveModel=$.require("models/ReserveModel")
var ReserveCheckInCheckOut=$.require("common/ReserveCheckInCheckOut")
var SimpleView=$.require("SimpleView")
var PopupView=$.require("PopupView")
var resstore = null,userrowTemplate, rowTemplate = null
var DataGrid=$.require("DataGrid");

function dowalkinNonmember(ev){
    var plate=this.el.q(".non-member-checkin .plate_num").val(),state=this.el.q(".non-member-checkin .plate_num_state").val()
    if(!plate || /\s/.test(plate)) {
        app.splashError("Invalid Plate number<br/>Spaces and special characters are not allowed.<br/>Please enter a valild number")
        return
    }
     ReserveCheckInCheckOut.walkinNonmember(state+"-"+plate.toUpperCase(),app.user.facility_id,function(data){
           showInfo.call(this,data,true);
    }.bind(this))

}


function docheckin(ev) {
     if(ev && $d.selfOrUp(ev.target,".hasnocontent")){return}
    var v=this.vehicleWidget.getDataRecord();
     if(typeof(v.id)!="number"){v.id=0}
     if(!this.model.reservenum) {
        if(this.model.isNonMember){
            this.model.userVehicle.update(v)
            this.model.user.firstname = this.el.q(".user-firstname").val()||""
            this.model.user.lastname  = this.el.q(".user-lastname").val()||""
            this.model.user.email     = this.el.q(".user-email").val()||""
            this.model.user.phonenumber=this.el.q(".user-phonenumber").val()||""
        }
        //dowalkin.call(this);
     }

    var nudate=new Date()
    this.model.schedule.setEntryTime(nudate)
    this.model.pricing && this.model.pricing.recalcAll()
     var reserveCheckInCheckOut = new ReserveCheckInCheckOut(this.model,"checkin");
    if(this.model.isNonMember){
        reserveCheckInCheckOut.baseModel.isNonMember=true
        reserveCheckInCheckOut.baseModel.user.id=reserveCheckInCheckOut.baseModel.user.nonmember_id=this.model.user.id||this.model.user.nonmember_id
    }
     reserveCheckInCheckOut.checkin(
        function(res){
            resstore.clear();
            resstore.load()
            // app.showClaimCheck({reservenum:this.model.reservenum})
            $.require("common/ReserveCardView").show({template:"claimcheck",
                   showOptions:true,
                record:this.model
            });
           // utils.showclaimCheck(this.model)
            clear.call(this)

            //if(res===false){ pr.reject();return }
            //showInfo.call(ths,res===true?this.baseModel:res);
            //pr.resolve()
        }.bind(this),true);
    /*ReserveCheckInCheckOut.checkin(this.model ,
        function(){
            resstore.clear();
            resstore.load()
                showclaimCheck.call(this)
                clear.call(this)
         }.bind(this))*/


}
function clear(excludeip,excludemodel){
    this.el.addClass("hasnocontent")
    if(this.cloak){this.cloak.show()}
    this.el.qq(".check-in-info input,.check-in-info select").prop("disabled","disabled")
    if(excludemodel!==true){
        this.model.clearValues(["stateOptions"]);
        this.vehicleWidget.model.clearValues();
    }
    if(excludeip!==true){
        this.el.qq(".plate_num").val("")
    }
    this.el.q(".check-in-info").css("overflow","hidden").anim("height",1,"fast")
    this._cleared=true;
}
function forBarCode(code,pr){
    if(!code){return}
    onselectRecord.call(this,{barcode:code})

}
function showInfo(rec,excludeip){
   if(!this._cleared) {clear.call(this,excludeip)}
    this._cleared=false;
    if(!rec.facility_id){rec.facility_id=app.user.facility_id}
    this.data("_last","");
    this.model.readRecord(rec)

    var nudate=new Date()
    this.model.schedule.setEntryTime(nudate)

    if(rec.iswalkin){
         this.model.schedule.duration=2;
    }
     if(rec.user && rec.user.id){
        this.model.user.id=rec.user.id;
    }

    this.model.schedule.setupDates();
    this.model.schedule.reserveDateTime._wraptag=true

    if(!this.model.reservenum){
        this.model.reservenumlabel="Walk-in"

        if(!this.model.reserveSlot.id){
             app.remoteDirective("findslot",{facility_id:this.model.facility_id||this.model.facility.id,date_from:+this.model.schedule.reserveDateTime,date_to:+this.model.schedule.reserveDateTimeEnd},
                function(data){
                    data=data.data||data;
                     this.model.reserveSlot.readRecord(data)
                 }.bind(this))
        }

    }

    this.el.removeClass("hasnocontent")
    if(this.cloak){this.cloak.hide();}
    this.el.q(".check-in-info").anim("height",this.el.q(".check-in-info").scrollHeight,"fast")
    this.el.qq(".check-in-info input,.check-in-info select").prop("disabled",null)
   // this.el.q(".check-in-user-info").scrolltoView(true,true)
    //this.model.schedule.time_from=new Date()
   var dur=this.model.schedule.reserveDuration
    this.digest();
    var est=this.el.q(".est_duration")
    est && (est.value=dur);
    this.model.schedule.reserveDuration=dur
     this.vehicleWidget.model.readRecord(this.model.userVehicle.toMap())
    this.vehicleWidget.digest()

    //this.el.qq(".nonmember-info input").attr("readonly",this.model.isNonMember?null:"readonly");
 }
function onselectRecord(r) {
    //r.facility_id=app.user.facility_id
    var crit=["resstatus < 99"]
    $.each(r,function(v,k){crit.push(k+"= "+(k=="barcode"?("'"+v+"'"):v))});
    this._grid.grid.pager.filter= crit.join(" and "); ;
    this._grid.grid.pager.loadPage().then(
        function(a){
            console.log(a)
        }
    )
     /*app.remoteDirective("reservehistory", r ).then(
         function(d){
             console.log(d)
         }
     )*/
}
function onselect(r) {
    var ths=this,resid = r.id,        usersrch=ths.el.q(".user-search")  && ths.el.q(".user-search").val()===true
    if(usersrch){
        if(r && r.id){
            ths.ip.val(r.fuillname)
        }
        app.remoteDirective("userdetails",{targetid:resid}).then(
            function(u){
                var activeel=$d.util.getActiveElement()
                var anchor=$d.selfOrUp(activeel,".list-item")
                if(!anchor){return}
                if(u.vehicles && u.vehicles.length>=1){
                    var vehicleListView = new PopupView({
                        minWidth:350,
                        maxHeight:function(bnds){
                            if(this.config && this.config.options&& this.config.options.anchor){
                                $.viewport.height - $d(this.config.options.anchor).bounds().top;
                                this.$content().css("overflowY","auto")
                                return $.viewport.height - ($d(this.config.options.anchor).bounds().bottom+40)
                            }
                            return 0
                        },
                        alignAnchor:"below",
                        anchor:anchor.el, title:'select a Vehicle' ,
                        content:"<ul class='vehicle-sel-list'>"+
                        u.vehicles.map(function(a){
                            return "<li class='list-row' style='white-space:nowrap;' data-key='"+(a.barcode)+"'>"+a.vehicle_plate +" "+a.vehicle_make +" "+a.vehicle_model +" "+a.vehicle_year +"</li>"
                        }).join("")+"</ul>"
                    });

                    vehicleListView.el.css({background:"white"})
                    vehicleListView.el.on("click",function(ev,el){
                        var code=el.domdata("key")
                        var vehicle=u.vehicles.find(function(a){return a.barcode==code}),user=Object.assign({},u);
                        delete user.vehicles;
                        vehicleListView.hide()
                        var monthly,facility_id=app.user.facility_id,vid=vehicle.id
                        onselectRecord.call(ths,{barcode:vehicle.barcode})

                    },".list-row")
                    vehicleListView.show()
                    if(vehicleListView.el.height()+vehicleListView.el.offsetTop > $.viewport.height){

                    }

                } else {
                    app.splashError("A vehicle is required for checkin")
                }
            }
        )
        return false
    }
    var rec = resstore.findById(resid)
    if(rec){
        onselectRecord.call(ths,{reserve_id:rec.id})

    }


}
function _searchCallback( ev) {

    var ths=this,reservemodel = this.model ,el=this.el,val=this.ip.val()
        if (!(resstore && val && (typeof(val)=="string"))) {
            return Promise.reject()
        }
    var pr=Promise.deferred(),usersrch=ths.el.q(".user-search")  && ths.el.q(".user-search").val()===true

        var barcodesrch
        if((barcodesrch=ths.el.q(".barcode-search")) && barcodesrch.val()===true){
            if(!val){
                return Promise.reject()
            }
            var code=String(val).trim(),facility_id=app.user.facility_id
            if(code && ev && ev.type && (String(ev.type)== "paste" || (String(ev.type).indexOf("key")==0 && ev.keyCode== 13))){
                forBarCode.call(ths,code,pr)

                /*} else if(userid && vehicleid){
                 showInfo.call(ths,{user_id:userid,vehicle_id:vehicleid,facility_id:facility_id})

                 pr.resolve()
                 }*/
            }
            return pr
        }
        if(usersrch){
            if(!userrowTemplate ){
                userrowTemplate=$d.template("<div class='lookup-record'><span  class='rec-firstname'>$firstname</span> <span  class='rec-lastname'>$lastname</span>, <span  class='rec-lastname'>$email</span></div>")
            }
            app.remoteDirective("findusers",{srch:val}).then(
                function(a){
                     a=a||[]

                    var rows=[].concat(a).map(function(r){
                        return {id: r.id,label:userrowTemplate(r)}
                    })

                    pr.resolve(rows)
                },
                function() {
                    ths._searchPending = false;
                }
            );
            return pr
        }
         resstore.clear()
        resstore.load().then(
            function(){
                ths._searchPending=false;
                var val=ths.ip.val()
                if(!val){return pr.resolve([])}
                var recs=val=="*"?resstore.getList():reservemodel.findReservationsByText(val,resstore)
                     pr.resolve(recs.map(
                        function (r) {//r.duration_type=r.duration_type||"h"
                            r.duration_type = r.duration_type || "h"
                            var label = r.applyTemplate(rowTemplate)

                            return {
                                id: r.id, label: label
                            }
                        }
                    ))
            },
            function() {
                ths._searchPending = false;
            }

        )
        return pr;
    }
function triggerSearch(ev,clear){

    var ip=$d(this.ip);
    if(!ip){return}

    var list=this.data("_list"),val=ip.val()
    if(clear===true || !val){
        this.clearSearch()
        return
    }
    var vw=this;

    if(!list){
        list=$.require("PopupView").lookupList([{id:0,label:"searching .."}],{
            defaultText:"searching..",ignoreanchorstyle:true,
            destroyonhide:false,
            callback:function(rec){
                onselect.call(vw,rec);
                this.hide();
            }
        }).show()
        list.observer.on("beforehide",function(el){
            if(ip.contains(el)){return false}
        })
	    vw.data("_list",list);
    }
    if(vw.data("_last")==val){
        list.el.isVisible(true) || list.show()
        return
    }
	vw.data("_last","");
    if(this._searchPending){return}

    this.searchCallback( ev).then(
        function(rows){
	        vw._searchPending=false;
	        vw.data("_last",val)
            if(!(rows && rows.length)){
                vw.clearSearch(true)
                return;
             }
            list.config.options.anchor=vw.ip;
            list.reset(rows)
        },
        function(err){err=err||{}
            list.reset([{id:0,label:typeof(err)=="string"?err:(err.error||"..error...")}])
        }
    )

}

function setupCombo(){
    var ths=this;
    var reservemodel = this.model;
    this.searchCallback=_searchCallback.bind(this)
    var dosearch=$.throttle(triggerSearch.bind(this),{tailend:true})
    var ip = this.el.q(".check-in-find");
    var _clearSearch=  function(noreset){
        var ip=this.ip;
        if(!ip){return}
        this.data("_last","")
        var l=this.data("_list")
        if(noreset!==true){
            ip.val("");
        }
        this._searchPending=false;
        if(l){l.hide()}

    }.bind(this) ;
    this.clearSearch=_clearSearch;
	ip.on("input focus mousedown",function(ev){
		if(!this.hassearchTrigger){dosearch(ev)}
	}.bind(this));
	ip.on("seachcancel esc",_clearSearch);
    this.ip=ip;
    var dom = this.el,activeel=null,vw=this;
	this.model.getController().mixin({
		toggleusersearch:function(ev) {
			if ($d.val(ev.target)) {
				vw.hassearchTrigger = true
                dom.q(".check-in-find-user-link").show().on("click.searchtrigger", dosearch)
				//ip.setTrigger(but)

			} else {
				//ip.setTrigger(null)
				vw.hassearchTrigger = null
				dom.q(".check-in-find-user-link").hide().off("click", "searchtrigger")
			}
			vw.clearSearch()
		}.bind(this)
	})



    app.getEntity("facility_reserveusers").then(function (ent) {
        resstore= ent.createStore()
        resstore.pager.sortcol = "id"
        resstore.pager.sortdir = "d"
        resstore.provider.includelookups = false;
        resstore.pager.pagesize = -1
        resstore.dataRecordPrototype.addExpr("reservetime",function(a){return $.date.format(a.computed_start_long,"mm/dd/yy hh:nn tt")})
        var targetdate= $.date.minus("d",1)
        resstore.defaultCriteria = "facility_id=" + app.user.facility.id + " and resstatus < 99"// or   (resstatus >= 99 and  computed_start_long >  "+(+targetdate)+")"
        rowTemplate = resstore.dataRecordPrototype.prepTemplate(utils.reserveRecordTemplate, function (s, name, rec) {
            if (!s || !s.trim()) {//if(name=="vehicle_color"){alert(s)}
                return name == "vehicle_color" ? "auto" : "<span title='value for " + $.titleize(name) + " not available' class='no-content'>?</span>"
            }
            return s
        })
        resstore.on("dataloadcompleted", function() {
            //thsvw.model.checkedincount=resstore.size()
        })
        resstore.load()
    })
}
function setupSlotSelection() {
    var slotstore, dialogvw = null,ths=this,slotView
    function onslotsel(slotmodel ){
        var record=slotmodel.get("record")||{}
        //if(record.reserve_num){return}

        var nuslotid=record.slotid,vw=this;
        if(!ths.model.reservenum){
            ths.model.reserveSlot.id=nuslotid;
            ths.model.reserveSlot.slotname=record.slotname||record.name;
            dialogvw.hide();
            return
        }
        app.remoteDirective("assignslot",{
            reserve_num:ths.model.reservenum,slotid:nuslotid
        }).then(
            function(nu){
                var curr=ths.model.reserveSlot.id;
                var rec = slotstore.records.find(function(r){return r.slotid == curr});
                if(rec){
                    rec.slot_status=0;
                    vw.redraw(rec)
                }
                ths.model.reserveSlot.id=nuslotid;
                ths.model.reserveSlot.slotname=nu.slotname;
                record.read(nu);
                slotView.selectSlot(nuslotid)
                dialogvw.hide();
            }
        );
    }
	this.model.getController().mixin({
		checkinslot:function(ev) {
			var ip = $d(ev.target), model = ths.model;
			if (!dialogvw) {
				dialogvw = new PopupView({animateHide: true, resizable: true, draggable: true})
			}
			if (!slotstore) {
				slotstore = ths._parent.getSlotStore()
			}
			//if(model.reserveSlot.id){
			dialogvw.show()
			slotView = SlotView.slotSelector(
				{
					id: "checkinselector",
					container: dialogvw.$content(),
					time_from: model.schedule.reserveDateTime,
					time_to: model.schedule.reserveDateTimeEnd,
					facility_id: app.user.facility_id,
					slotstore: slotstore,
					current: model.reserveSlot.id
				}, onslotsel);
			//}

		}
    })

}
function setupNonMember() {
	this.model.set("stateOptions",apputils.stateList.slice())
	this.model.set("platenumstate","NY");
    //this.el.q(".plate_num_state").addOptions(apputils.stateList.slice())
    //this.el.q(".plate_num_state").val("NY")
	this.model.getController().mixin({
		platenumkey:function(ev) {
			var val = ($d.val(ev.target) || "").trim()
			if (val && /\s/.test(val)) {
				$d.val(ev.target,val.replace(/\s/g, ''));
				//app.splashError("Invalid Plate number<br/>Spaces and special characters are not allowed.<br/>Please enter a valild number")
				return
			}
			if (ev.keyCode == 13) {
				walkinNonmember()
				ev.stopImmediatePropagation()
			}
		}
    })
}
function setupVehicleWidget(){
    this.vehicleWidget=new VehicleWidget( {container:this.el.q(".check-in-info")})
    this.vehicleWidget.render()

}
function setupGrid(container){
    var holder = {}
    this._grid=holder
    app.getEntity("facility_reserveusers").then(function (ent) {
        holder.store = ent.createStore(true)
        holder.store.StoreRecordProto.addExpr("actions",function(a){
            var st=a.get("resstatus",true)
            return "<button type='button'>"+(st==1?"Checkin":(st==2?"Checkout":"NA"))+"</button>";
        })
        var cfg = {
             scheduled_duration: {label: "duration"},
            duration_type: {label: "durationType"},
            computed_start_long: {label: "From",type:"timestamp",format:"mm/dd/yy hh:nn tt",hidden: false},
            computed_end_long: {label: "To",type:"timestamp",format:"hh:nn tt",hidden: false},
            vehicle_make: {label: "Make" },
            username: {label: "Name" },
            vehicle_model: {label: "Model" },
            vehicle_plate: {label: "Plate" },
            slotname: {label: "slot" },
            //duration: {expr: "duration"},
            member_id:{searchalias:"username"},
            resstatus: {
                list:[{id:1,label:"Reserved"},{id:2,label:"Checked In"},{id:99,label:"Checked Out"},{id:500,label:"Cancelled"}],
                label:"Status",
                cellRenderer: function (val,k) {
                    return "<div style='background-color:" + (val == 'Reserved' ? "yellow" : (val == 'Checked In' ? "green" : (val == 'Checked Out' ? "blue" : "red"))) + "'>"+k+"</div>"
                }, defaultValue: 1
            },
        };
        //"date_from time_from reserve_extra_extras  actual_duration discount promotion entry_time exit_time payment_status needs_followup follow_up_message multientry account_num email phone_number barcode slot_status location_id notifications checked_out member_id facility_id operator_id operator floor_manager_id reserve_id address name vehicle_type vehicle_id vehicle_description vehicle_model usertype slotlocation slotid firstname lastname middlename rate_model_id extra1 extra2 isprimary vehicle_color vehicle_year".split(/\s+/).forEach(function (a) {
         //   cfg[a] = {hidden: true}
        //});

        ent.updateFields(cfg);
        var opt = {nowrap: true,
            //headerFilter: {filterColumns:"username date_from duration_type scheduled_duration vehicle_plate barcode reserve_num resstatus vehicle_model vehicle_make slot_name account_num email".split(/\s+/)},
            sortable:true,
            columns:["resstatus","computed_start_long","computed_end_long","slotname","username" ,"vehicle_make","vehicle_model","vehicle_plate","actions"]
        }
        holder.store.defaultCriteria = "facility_id = " + app.user.facility_id
        holder.grid = new DataGrid(holder.store, opt);
        holder.grid.build(container)
        holder.grid.pager.sortcol = "id"
        holder.grid.pager.sortdir = "d"
        holder.grid.pager.pagesize = 20


    });
}
function controller() {
    if (!this.visibleFirst) {
        if(this.clearSearch){this.clearSearch()}
        return
    }
    clear.call(this,false,true)
    //update half hour
    try{   this.el.q(".val-duration").options[0].text="½"   } catch (e){}
    setupVehicleWidget.call(this)
    setupNonMember.call(this)
    setupCombo.call(this)
    setupSlotSelection.call(this)
    setupGrid.call(this,this.el.q(".checkinout-grid"));
     this.model.getController().mixin( {
            checkinscan:function(){
                utils.captureQRCode(forBarCode.bind(this))
            }.bind(this),
            nonmembercheckin:dowalkinNonmember.bind(this),
            docheckin:docheckin.bind(this) ,
            doreset: clear.bind(this)
        }
    )

}

var garage_checkin=app.defineView( {id:"garagecheckinout" ,  template:"garagecheckinout",model:new  ReserveModel(),title:"Check-in",controller:controller});

module.exports=garage_checkin
}
__bootstrap__.modules["garage/checkout"] = function(module){
var app=$.require("app")
var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")
var userutils=$.require("common/AppUtil")
 var ReserveModel=$.require("models/ReserveModel")
var service=$.require("garage/garageservice")
var VehicleWidget=$.require("common/VehicleWidget")
var ReserveCheckInCheckOut=$.require("common/ReserveCheckInCheckOut"), rowTemplate = null;

 function processCheckout(model,override){
    if(override!==true && model.reserveTaskList && model.reserveTaskList.hasUnResolved()){
        app.splashError("There are unresolved tasks which must be completed or cancelled before checkout.")
        return
    }
    var exit_time=+(model.exit_time||new Date());
    app.remoteDirective("docheckout", {
            sel:  {
                reserve_num: model.reservenum,
                tip:model.pricing.calctip,
                amount:model.reservecost,
                exit_time:exit_time,
                staff_id:app.user.id
            }
        }
        ,function () {
            this.$(".garagecheckout").addClass("hasnoselection")

            $.require("common/ReserveCardView").show({template:"receipt",
                showOptions:true,
                showreceipt:true,title:"Receipt",
                record:this.model
            });
        }.bind(this))
}
function docheckout() {
    var reserve_id=this.model.reserve_id
    if(!reserve_id){
        app.splashError("Reserve id not found")
        return
    }
    this.model.schedule.setExitDate(new Date())
      var manualprice=this.model.manualprice
    $d.html(".scanned-code","")
    app.remoteDirective("reserveinfo",{reserve_id:reserve_id}).then(
        function(rec){
            var numodel=ReserveModel.from(rec);
            numodel.schedule.setExitDate(new Date())
             if(manualprice){
                numodel.manualprice=manualprice
            } else {
                numodel.recalcPrice()
            }

            if(!numodel.allresolved) {
                 numodel.onchange("allresolved", function () {
                    processCheckout.call(this,numodel)
                }.bind(this))
            } else {
                processCheckout.call(this, numodel)
            }
        }.bind(this)
    )



}
function showReserveCard(rec) {
    var reservecard = this.el.q(".reserve-card"), scopeid = "garagecheckout"
    this.data("_last","");
    //this.model.clearValues()
    var reservemodel = this.model;
    reservemodel.scopeid = scopeid
     if (reservecard) {
         reservemodel.bindRecalc(true)
         if(app.user.facility){
             rec.facility=app.user.facility
         }

        reservemodel.readRecord(rec).then(function(rec){
              reservemodel.schedule.setExitDate(new Date())
            reservemodel.recalcPrice(true)
               reservecard.show()
             this.el.q(".garagecheckout").removeClass("hasnoselection")
            reservemodel.digest(reservecard,"reserve-card");
              this.vehicleWidget.digest();
          }.bind(this));
     }
}

function forBarCode(code,pr){
    if(!code){return}
     app.remoteDirective("vehicledetails",{barcode:code,facility_id:this.model.facility.id}).then(
        function(data){
            if(data.error){return}
            var rec
            if(data && Array.isArray(data.reservations) && data.reservations.length){
                rec=data.reservations.find(function(r){return r.resstatus==2})
            }
            if(rec){
                showReserveCard.call(this,rec)
            } else{
                app.splashError("No Reservation found for this vehicle :" + code)
            }

        }.bind(this)
    )
    /* var ths=this,reserveCheckInCheckOut = new ReserveCheckInCheckOut({barcode:code,facility_id:app.user.facility_id},"checkin");
     reserveCheckInCheckOut.verifyCheckin(
     function(res){
     if(res===false){ pr && pr.reject();return }
     showInfo.call(ths,res===true?this.baseModel:res);
     pr && pr.resolve()
     },true )*/
}
function setupScan() {
    this.el.q(".check-out-scan").on("click",function(){
        $d.html(".scanned-code","")
        utils.captureQRCode(function(code){
            if( !code){app.splashError("Invalid code");return}
            code=code.trim()
            $d.html(".scanned-code",code)
            forBarCode.call(this,code,pr)

        }.bind(this))
    }.bind(this))
}
function setupTaskList(){
    this.model.reserveTaskList.showListWithStatus(this.el.q(".extra-service"))
    app.observer.on("notificationupdate",function(data){
        if(  data && data.record && data.record.reserve_id==this.model.reserve_id){
            if(this.model.reserveTaskList && this.model.reserveTaskList.tasks){
                var id=data.record.id
                var tasks=this.model.reserveTaskList.tasks,task=tasks.find(function(a){return a && a.id==id})
                data.record.status=data.record.status_id
                if(task){task.update(data.record)}
                this.model.reserveTaskList.tasks=tasks.slice();

            }
            data.record.id
        }
    }.bind(this))
}
function setupVehicleWidget(){
    this.vehicleWidget=new VehicleWidget({showsummary:true,model:this.model.userVehicle})
    this.vehicleWidget.appendTo(this.el.q(".vehicle-info"))

}
function controller() {
    this.el.q(".garagecheckout").addClass("hasnoselection")
    $d.html(".scanned-code","")
    this.model.bindRecalc(true);
    if (!this.visibleFirst) {
        return
    }
    this.model.getController().mixin({
        checkoutmember: docheckout.bind(this),
        checkoutmembercash:function(ev){alert("Cash")},
        checkoutmembercc:function(ev){alert("CC")},
        checkoutmembermonthly:function(ev){alert("monthly")}
    })
    setupVehicleWidget.call(this)
    utils.setupReservationSearch.call(this,userutils.RESSTATUS.CHECKEDIN,".check-out-find",".searchcnt",null,function(rec){
        if(rec && rec.id){
            app.remoteDirective("reserveinfo",{reserve_id:rec.id}).then(
                function(data){
                    showReserveCard.call(this,data)
                }.bind(this))
        }

    }.bind(this))

    setupScan.call(this)
    setupTaskList.call(this)
}
var model=new  ReserveModel()
model.addProperty("checkedincount",0)
var garage_checkout=app.defineView({id:"garagecheckout",layout:"fill", model:model,template:"garagecheckout",title:"Check-out",controller:controller});

module.exports=garage_checkout
}
__bootstrap__.modules["garage/dashboard"] = function(module){
var app=$.require("app")
var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")
var GraphWidget=$.require("GraphWidget")
var DataGrid=$.require("DataGrid");
var SlotView= $.require("garage/SlotView")
var ReserveCardView=$.require("common/ReserveCardView")
var slotGroupStore,operatorStore,vehicleStore,_pending=0
var PopupView=$.require("PopupView")

function refreshSlotStore(override){
    var date=$.date().toNearestQuarterMinutes(true)
    var isvis=this.el.isVisible(true)
    /*if(isvis){
        app.remoteDirective("slotstatus",{facility_id: facility_id,date_from:+date,date_to:(+date)+(1000*60*60 ),onlyreserved:true},
            function(data){
             });
     }*/


    var store=this.slotView.slotstore||(this.slotView.slotstore=this._parent.getSlotStore());
    store.records.setKeyProvider(function(rec){return rec.get("slotid")})
    store.getOriginalList().setKeyProvider(function(rec){return rec.get("slotid")})
      this.slotView.loadData(date).then(
        function(store){
            if(this.el.isVisible(true) && this.slotView){
                var cntnr=this.el.q(".db-check-in .db-content");
                this.slotView.setup(store,cntnr)
                this.slotView.show();
                this.slotView.el && this.slotView.el.css("height",cntnr.height()-10);
            } else{
                _pending=1;
            }

            var total=store.records.length;
            var occ1=store.records.findAll(function(a){return a.slotstatus>0})

            var occ= occ1.length;
               app.updateFacilityStats({occupied:occ,available:total-occ})
        }.bind(this)
    )
}
function setupClockWeather(){
    var panel=this.panel= app.viewRoot.garagehome;

    panel.el.q(".db-wrap").fillContainer("min").css("h", function (el, rec) {
        return this.height()
    });

    function getInRange(min, max) {
        return Math.ceil(Math.random() * (max - min) + min);
    }

    var nuel

    function _go() {

        var dom = document.querySelector(".db-trend .db-content");
        var vals1 = [], vals2 = [], vals3 = [], vals4 = [], total = 50
        var i = 0;
        while (++i < total) {
            vals1.push(getInRange(50, 10));
        }
        i = 0;
        while (++i < total) {
            vals2.push(getInRange(50, 10));
        }
        i = 0;
        while (++i < total) {
            vals3.push(getInRange(50, 10));
        }
        i = 0;
        while (++i < total) {
            vals4.push(getInRange(50, 10));
        }
        if (!nuel) {
            nuel = GraphWidget.create()
            // nuel.addSeries("year",{smooth:true,data:vals1,attr: {fill: "rgba(0,0,255,.3)", stroke: "blue","data-key":"year"}})
            //nuel.addSeries("month",{smooth:true,data:vals2,attr: {fill: "rgba(0,255,0,.3)", stroke: "green","data-key":"month"}})
            //nuel.addSeries("week",{smooth:true,data:vals3,attr: {fill: "rgba(255,0,0,.3)", stroke: "red","data-key":"week"}})
            nuel.addSeries("today", {
                smooth: true,
                data: vals4,
                attr: {
                    fill: "rgba(215,255,0,.3)",
                    "stroke-width": ".4px",
                    stroke: "rgba(215,255,0)",
                    "data-key": "today"
                }
            })
            nuel.addLine("_", [0, 40], [240, 40], {stroke: "green", fill: "rgba(0,0,0)"})

            nuel.appendTo(dom)
            var vw = nuel.config.viewBox, bottom = vw[3], span = vw[2] / 4, cnt = 4, i = 0, labaltop = 35;
            nuel.addText({
                "9 am": {x: 0 - 10},
                "12 pm": {x: span * 1 - 10},
                "3 pm": {x: span * 2 - 10},
                "6 pm": {x: span * 3 - 10},
                "9 pm": {x: span * 4 - 10}
            }, {y: bottom - 20, stroke: "none", fill: "black"})

        } else {
            nuel.render(vals)
        }
        nuel.cleanUp()
         $d(dom).append("<div style='position:absolute;top:10px;left:10px'>Quick Overview</div>")
    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    _go()
    var count = Number(app.user.facility.spacestotal) || 20
    var slots = panel.el.q(".db-check-in .db-content").css({overflowY: "auto", padding: "3px"})

    function addFlags(cnt) {
        for (var i = 0; i < 5; i++) {
            var v = getRandomInt(1, cnt)
            var rl=slots.q("[data-index='"+v+"']")
            if(rl){rl.addClass("notav").attr("title","Not available")}
        }
        for (var i = 0; i < 15; i++) {
            var v = getRandomInt(1, cnt)
            var rl=slots.q("[data-index='"+v+"']")
            if(rl){rl.addClass("occupied").attr("title","Occupied")}
        }
        var v=Math.max(25,cnt/2)
        for (var i = 0; i < v; i++) {
            var v = getRandomInt(1, cnt)
            var rl=slots.q("[data-index='"+v+"']")
            if(rl){rl.addClass("reserved").attr("title","Reserved")}
        }
    }
}
function setupGrid(){
    var panel=this.panel= app.viewRoot.garagehome;
    var grid=panel.el.q(".db-space-mng .db-content")
    //this.slotView.appendTo(this.el.q(".db-check-in .db-content"))
    //    this.slotView.show();
     app.getEntity("appnotification_det").then(function(ent){
        var holder= {}
        holder.formPanel=new PopupView({height:460,width:500,footer:{height:30},modal:true})
        holder.store=ent.createStore( )
        ent.updateFields({
            facility_id: {hidden:true},
            reserve_id: {hidden:true},
            type_id: {hidden:true},
            response_msg: {hidden:true},
            assigned_on: {hidden:true},
            facility_staff_name: {label:"Assigned To"},
            assigned_by: {hidden:true},
            assigned_to: {hidden:true},
            assigned_to_name: {hidden:true},
            msg: {label:"Message"},
            reservetime: {hidden:true},
            facility_name: {hidden:true},
            user_name: {hidden:true},
            resstatus: {hidden:true},
            user_id: {hidden:true},duration_type: {hidden:true},duration: {hidden:true},vehicle_id: {hidden:true},
            forfacilitystaff: {hidden:true},
            type_key : {hidden:true},
            status_id: {cellRenderer:function(val){
                return "<div style='background-color:"+(val==2?"green":"red") +"'>&nbsp;</div>"
            },defaultValue:1}
        });
        /*ent.updateFields({
            date_from: {type: "date"},
            time_from: {type: "time",cellui:{style:{whiteSpace:"nowrap"}}}
        });
*/
        holder.store.defaultCriteria="forfacilitystaff = 1 and status_id < 2 and facility_id="+app.user.facility_id
        var opt={entityForm:{},sortable:true,scrollable:true,  title:"Notifications",
            editoptions:{del:false,add:false},zebraColumn:true  ,resizable:true,columns1:"member_id date_from  scheduled_duration slot vehicle_id photos notes".split(/\s+/)}
        holder.grid=new  DataGrid(holder.store,opt);
        holder.grid.build(grid )
        holder.grid.pager.sortcol="added_on"
        holder.grid.pager.sortdir="d"
        holder.grid.pager.pagesize=10
        holder.grid.pager.loadPage().then(
            function(p){
              }
        );
         var refresh= $.throttle(function(){
             holder.grid.pager.loadPage({includelookups:false}).then(
                 function(){
                     $d.html(".slots .notifications .quantity",String(holder.grid.pager.totalrows||"&nbsp;"))
                 }
             );
         },{tailEnd:true,delay:2000})
         app.observer.on("notificationupdate",refresh)
    });
}
var refreshSlotStoreThrottled
function showSlotSelector(dialogvw,slotvw,slotstore,record,slotmodel ){
    var cardView=this;
    var  reservenum = record.reserve_num,
        reserveid = record.reserve_id
    var slotView=SlotView.slotSelector(
        {   container:dialogvw.$content(),
            time_from:slotvw.reservedate,
            time_to:slotvw.reservedatetimeEnd,
            facility_id:slotvw.facility_id,
            slotstore:slotstore,
            current: record.slotid
        },
        function(slotmodel3){
            var record3=slotmodel3.get("record")||{}
            app.remoteDirective("assignslot", {
                slotid: record3.slotid,
                reserve_num: reservenum,
                reserve_id: reserveid
            },function(ev){
                dialogvw.hide()
                this.current= record3.slotid
                slotvw.refreshView();
                cardView.reserveSlot.slotid= record3.slotid
                if(slotmodel.record){
                    slotmodel.record.slotid=record3.slotid;

                }

                cardView.reserveSlot.slotname= record3.slotname
                cardView.hideOnBlur(true)
            })

        }
    );

    dialogvw.el.toFront(true)
    dialogvw.el.css("z-index",Number(cardView.getEl().css("z-index")||10)+1);
    return slotView
}
function controller(el) {
        var $this=this ,ismobile=$.browser.isTouchDevice
        if(!app.user.facility_id&&app.user.facility&&app.user.facility.id){
            app.user.facility_id=app.user.facility.id
        }
    if(!this.slotView){
        this.slotView=new SlotView();
        this.slotView.facility_id=app.user.facility.id
        this.slotView.reservedate= $.date().toNearestQuarterMinutes(true);
        this.slotView.reservedatetimeEnd=$.date().plus("h",1);
        var vw=this,dialogvw,slotstore;
        this.slotView.on("slotpointerselection",function(slotmodel){
            var record=slotmodel.get("record")||{}
            if(!record.reserve_num){
                return
            }
             var slotvw=this,reservenum = record.reserve_num,
                reserveid = record.reserve_id
            slotstore=slotstore||vw._parent.getSlotStore();
            app.remoteDirective("reserveinfo",{reserve_id:reserveid},function(record){
                 ReserveCardView.show(
                    {anchor:slotmodel.el,record:record,id:"capacityvw",
                        showBarCode:false,
                        actions:{
                        "Change Slot":function () {
                            var first,slotView=null;
                            if(!dialogvw){
                                dialogvw = new   PopupView({resizable:true,draggable:true,minHeight:400 })
                                dialogvw.on("aftershow resize",function(){
                                    slotView && slotView.el.css({height:this.el.innerHeight()-20})
                                });

                            }
                            if(this.containerVw){
                                this.containerVw.on("beforehide",function(){
                                    if(dialogvw && dialogvw.isVisible()){return false}
                                })
                            }
                            dialogvw.show()
                            this.hideOnBlur(false)
                            slotView=showSlotSelector.call(this,dialogvw,slotvw,slotstore,record,slotmodel )

                        }
                    }}
                )
            })

        })
        this.slotView.on("refresh",function() {
            this.loadData($.date().toNearestQuarterMinutes(true)).then(
                function(store){
                    this.renderSlots()
                }.bind(this)
            );
        });
        this.cloak=$d.util.cloak(null,{opacity:.4});
        this.cloak.setMessage("<div class='fxtx map-loading-wrap'><div class='map-loading'><div class='bubblingG'><span class='bubble-closest' id='bubblingG_1'></span><span class='bubble-cheapest' id='bubblingG_2'></span><span class='bubble-best' id='bubblingG_3'></span></div></div></div>")
        this.slotView.observer.once("slotsrendered",function(){
            this.cloak.hide()

        }.bind(this))
    }
    if(!refreshSlotStoreThrottled) {
        refreshSlotStoreThrottled = $.throttle(refreshSlotStore.bind(this), {topEnd: true, delay: 500})
    }
    if(!this.visibleFirst){

        refreshSlotStoreThrottled();

        return
    }


     setupClockWeather.call(this)
    setupGrid.call(this)
    app.on("reservestatusupdate" ,function(ev){
        refreshSlotStoreThrottled ( )
    })


    app.remoteDirective("dbmodified",{pars:{entity:"slot_group",criteriacol:"facility_id",criteriaval:app.user.facility.id}});
    app.onRemote("dbmodified.slot_group", $.throttle(function(){
        if(this.slotView && this.slotView.el && this.slotView.el.isVisible()) {
            this.slotView.refreshGroupList(true)
        }
    }.bind(this),{tailEnd:true}))
        app.getEntity("operator").then(function(ent){
            var st=ent.createStore();
            st.pager.pagesize=-1
            st.load().then(function(){
                operatorStore=st;
            })
        });
        app.getEntity("vehicle").then(function(ent){
            var st=ent.createStore(); st.pager.pagesize=-1
            st.load().then(function(){
                vehicleStore=st;
            })
        });

    refreshSlotStoreThrottled(true )



}

    var rootmodel= $.model.newInstance("garage");
    if(app.user && app.user.facility){
        rootmodel.addProperties(app.user.facility)
    }



app.updateFacilityStats=function(rec){
    rec.occupied=rec.occupied||0
    app.viewRoot.model.readDataRecord(rec);
 }
var garage_db=app.defineView({id:"garagehome",layout:"fill",template:"garagedashboard", title:"Home" ,model:rootmodel,controller:controller});

module.exports=garage_db
}
__bootstrap__.modules["garage/FloorLayout"] = function(module){
function floorLayout(){
    var ths=garageVendorView,panel=this
    if(panel.$content().q(".floor-layout")){return}
    $d("<div><div style='position:absolute;top:0;left:0;width:99.5%;height:99.5%;box-shadow:inset 3px 3px 8px #111,inset -3px -3px 8px #111;background-color:#f3f3f3' class='floor-layout'></div></div>"
    ).appendTo(panel.$content())
    function _init(s){
        if(app.kanvas){return}
        this.state=this.state||{}
        var kanvas=s.createCanvas(panel )
        var _elmenu,_opmenu,offset=kanvas.getUILayer().getBoundingClientRect(),
            _hideMenu=function(){
                _elmenu&&(_elmenu.style.display="none")
                _opmenu&&(_opmenu.style.display="none")
            }
        kanvas.state=kanvas.state||{}
        app.kanvas=kanvas;
        kanvas.on("el-added el-deleted clear",function(ev){      _hideMenu()  })
        kanvas.on("config",function(ev){
            if(ev.data.key=="spaceavailable"){
                ev.el.prop("klass",(ev.data.value?"":"!")+"space-not-available")
            }
        })
        kanvas.on("elementslassoed",function(ev){
            _hideMenu();
            [].concat(ev.data||[]).forEach(function(it){it && it.wrapel&& it.wrapel.classList.add("lassoed-el")})
        })
        kanvas.on("elementsunlassoed",function(ev){//_hideMenu();
            [].concat(ev.data||[]).forEach(function(it){it && it.wrapel&& it.wrapel.classList.remove("lassoed-el")})
        })
        kanvas.on("elementunselected",function(ev){_hideMenu();
            [].concat(ev.data||[]).forEach(function(it){it && it.wrapel&& it.wrapel.classList.remove("active-el")})
        });
        kanvas.on("remove",function(ev){this.removeEl(ev.data||this.state.el);_hideMenu(); })
        kanvas.on("duplicate",function(ev){this.dup(ev.data||this.state.el); })
        var _syncpos=function _syncpos(ev){var el=ev.el
            if(!(el&&el._active)){return false}
            if(!_elmenu){return}
            _elmenu.style.display="";
            var b=el.svg.getBoundingClientRect()   ,b2=_elmenu.getBoundingClientRect()
            _elmenu.style.top=(b.top-(offset.top+(b2.height||18)+5))+"px"
            _elmenu.style.left=(b.left+ b.width-(offset.left+b2.width||70))+"px"
        }
        kanvas.on("afterdraw", $.throttle(_syncpos,{immediate:true,delay:10}))
        kanvas.on("elementselected",function(ev){
            var el=ev.data ,target
            if(!(el && el.wrapel)){return}
            [].forEach.call(this.dom.parentNode.querySelectorAll(".active-el"),function(it){
                it && it.classList.remove("active-el")
            })
            target=el.wrapel
            target.classList.add("active-el") ;


            var _self=this ;
            if(!_elmenu){
                _elmenu=this.getUILayer().appendChild(document.createElement("div"))
                _elmenu.style.cssText="position:absolute;width:70px;font-size:.75em;height:18px;border:1px solid #666;box-shadow:2px 2px 2px #666;border-radius:5px;background-color:#333;cursor:pointer;opacity:.8;color:ivory;padding:0 0 0 5px;z-index:200;"
                _elmenu.innerHTML="Options <span class='mover' style='cursor:move'>: : :</span>";
                _elmenu.className="def-content-style option-list fxtx_25 noselection"

                _opmenu=this.getUILayer().appendChild(document.createElement("ul"))
                $d(_opmenu).css({width:150}).addClass("def-content-style  option-list").html("...");
                $d(_opmenu).css({display:"none"})
                this._eloptions={
                    availability:function(elem){
                        var k="spaceavailable";
                        elem.setConfig(k,!elem.getConfig(k))
                    }
                }
                _elmenu.addEventListener("mousedown",function(ev){
                    var elem=this.getActiveEl()
                    ev.stopPropagation&&ev.stopPropagation();
                    if(!(elem )){return}
                    if(ev.target.classList.contains("mover")){
                        setTimeout(this.dragHandles.mover.activate.bind(this.dragHandles.mover,ev,{el:elem}),10);
                        return
                    } else{
                        var  b=ev.target.getBoundingClientRect()
                        _opmenu.style.top=(b.bottom-offset.top)+"px"
                        _opmenu.style.left=(b.left-offset.left)+"px"
                        _opmenu.style.display=""
                        _opmenu.style.height=(_opmenu._ht||_opmenu.scrollHeight)+"px"

                        _opmenu.classList.add("fxtx_25")
                        var av=elem.getConfig("spaceavailable")
                        _opmenu.innerHTML=["" ,
                            "<li class='icon-thumbs-up' data-key='availability'><span class='glyph "+(av?'good':'danger')+"'>"+(String.fromCharCode(av?10003:10008))+"</span>Mark as "+(av?"un":"")+"available</li>",
                            "<li data-key='remove'>Remove</li>",
                            "<li data-key='copy'>Copy</li>",
                            "<li data-key='cut'>Cut</li>",
                            "<li data-key='duplicate'>Duplicate</li>",
                            ""
                        ].join("") ;


                        setTimeout(function(){
                            if(_opmenu.style.display=="none"){return}
                            _opmenu._ht=(_opmenu.scrollHeight);
                            _opmenu.style.height=_opmenu._ht+"px"
                            function _hndl(ev){if(_hndl._processed){return }
                                var target=ev.target;
                                _opmenu.style.height=".1px"
                                setTimeout(function(){_opmenu.classList.remove("fxtx_25");
                                    _opmenu.style.display="none"},600)
                                _opmenu.removeEventListener("mousedown",_hndl);
                                document.removeEventListener("mousedown",_hndl);
                                if(target && _opmenu.contains(target)&&target.dataset &&target.dataset.key){
                                    var k=target.dataset.key,elem=_self.getActiveEl();
                                    if(_self._eloptions[k]){_self._eloptions[k].call(this,elem)}
                                    _self.fire(k,elem)
                                    //elem._dispatch(k)
                                }
                                _hndl._processed=1
                            }
                            _opmenu.addEventListener("mousedown",_hndl)
                            document.addEventListener("mousedown",_hndl)
                        },100);
                    }
                }.bind(this))
            }

            _syncpos({data:{el:el}});

        })
    }
    ;
    _init(Svg)
}
}
__bootstrap__.modules["garage/garage"] = function(module){
/**
 * Created by Atul on 5/24/2015.
 */
var app=$.require("app")
var SimpleView=$.require("SimpleView")
var GraphWidget=$.require("GraphWidget")
var DataGrid=$.require("View.DataGrid")
var Form=$.require("UI.Form")
var GeoMap=$.require("common/GeoMap")
var Checkin=$.require("garage/checkin")
var Checkout=$.require("garage/checkout")
var Dashboard=$.require("garage/dashboard")
var Capacity=$.require("garage/capacity")
var Reports=$.require("garage/reports")
var Settings=$.require("garage/settings")
var Garagepricing=$.require("garage/garagepricing")
var ReserveTaskList= $.require("models/ReserveTaskList")
var Search= $.require("garage/garagesearch")
var qrtest= $.require("garage/qrtest")
var WeatherWidget= $.require("common/WeatherWidget")
var rootmodel=null,reservestore=null,
    vehicleStore=null,operatorStore=null
var AppnotificationsView = $.require("common/AppnotificationsView")
var PopupView=$.require("PopupView")
var ReserveCardView=$.require("common/ReserveCardView")
var GarageBrowser=$.require("garage/GarageBrowser")

var reserveStorePending=1,reserveStorePromise=null
function getReserveStore(callback){
    if(!reserveStorePromise){reserveStorePromise=Promise.deferred()}
    if(callback){reserveStorePromise.then(callback)}
    if(reserveStorePending>0&&reserveStorePending<4) {
        app.getEntity("facility_reserveusers").then(function (ent) {

            ent.updateFields({
                date_from: {type: "date", label: "Date"},
                time_from: {type: "time", label: "Time", cellui: {style: {whiteSpace: "nowrap"}}},
                reserve_num: {label: "Num"}
            });

            reservestore = ent.createStore()
            app.Xreservestore = reservestore;
            reservestore.pager.sortcol = "id"
            reservestore.pager.sortdir = "d"
            reservestore.provider.includelookups = false;
            reservestore.pager.pagesize = -1
            reservestore.defaultCriteria = "facility_id=" + app.user.facility.id + " and resstatus < 99"
            reservestore.load().then(function () {
                    reserveStorePending = 0
                    reserveStorePromise.resolve(reservestore)
                },
                function () {
                    reserveStorePending++
                    setTimeout(getReserveStore, 0)
                })
        });
    }
    return reserveStorePromise
}
function setLandingDims( ) {
     if(!app.viewRoot || !app.viewRoot.garagehome){return}
    var outer=app.viewRoot.$(".garage-content"),tp=0//outer.offsetTop
     var vwp = $.viewport.get(), garagedashboard = app.viewRoot.garagehome.el;
    var els = {}, lb = garagedashboard.bounds(), top, lbht, ht
    var top =  garagedashboard.el.getBoundingClientRect().top + document.body.scrollTop

    var dbweap, vpht = vwp.height , vpht2 = vwp.height - (top )

    /*if (app.rootView.theview) {
        app.rootView.theview.el.style.minHeight = (vwp.height - (app.rootView.theview.el.bounds().top)) + "px";
    }*/
    //app.rootView.el.css({minHeight:vpht+"px"})
    //$d.css(".tab-panels",{minHeight:vpht2})
    if (!lb.top) {
        //return
    }

    if (garagedashboard.isVisible(true)) {
        if (dbweap = garagedashboard.q(".db-wrap")) {

            if (dbweap.isVisible(true)) {
                dbweap.css({minHeight: vpht - top, height: vpht - top})

            }
        }
    } else { }



}
function Service(cmd,pars,cb) {if(pars.facility_id===null){pars.facility_id=app.user.facility_id}
    app.remoteDirective(cmd, {type: cmd, args: pars}, function (a) {
        if(a.data){a= a.data}
        cb(a);
    });
}


function _makeViews(dom) {
    rootmodel= $.model.newInstance("garage");
    var date= $.date()
    rootmodel.set("currentdate", $.date())
    app.userDetails.set("appversion",app.user.appversion)
    rootmodel.set("user",app.userDetails)

     setInterval(function(){
        rootmodel.set("currentdate", $.date())
    },15000)
    ReserveTaskList.setupLookup()
    if(app.user && app.user.facility){
        rootmodel.addProperties(app.user.facility)
        //rootmodel.set("operator","")
    }

    rootmodel.addProperties({
        total:(app.user.facility?app.user.facility.spaces_total:0)||0,
        available:0,
        upcoming:0,
        notification:0,
        slotEntity:null
    })

    var root=new SimpleView({model:rootmodel,id:"garage",template:"garage",controller:function(el){
        el.parent().show().opacity(1)}
    })



            root.add(Dashboard())
           // root.add(Checkinout())
            root.add(Checkin())
            root.add(Checkout())
            root.add(Search())
            root.add(Capacity())
            root.add(Reports())
            root.add(Garagepricing())
            root.add(GarageBrowser())
            var c= rootmodel.getController(),mixin={}

            root.children.each(function(ch){

                    mixin["cmd_"+ch.id] = root.setView.bind(root,ch.id)
                }
            )
            mixin.useroptions=function(ev){
                var PopupView = $.require("PopupView")
                var useroptions = new PopupView.lookupList(['Settings',app.isLoggedIn()?'Logout':'Login','Change Garage'],{
                    anchor: ev.target,minWidth:150,
                    callback:function(rec){
                        if(rec.id=="Change Garage"){
                            app.viewRoot.model.getController().invoke("changegarage",[ev])
                        }
                        else if(rec.id=="Settings"){
                            app.viewRoot && app.viewRoot.setView("myaccount")
                        } else{
                            app.viewRoot.model.getController().invoke("loginAct",[])
                        }
                    }
                });
                useroptions.show()

            }
            mixin.changegarage=function(ev){
                $.xhr.get(app.servicePath,{entity:"facilitywithrates",columns:"id,name,operator"}).then(function(data){
                    var list=[]
                    if(data.mode=="list"){
                        data.data.forEach(function(a){
                            if(a[1] && a[0]>0){
                                list.push({id:a[0],label:(a[2]?(a[2]+":"):"")+a[1]})
                            }
                         })
                    } else{
                        list=data.data
                    }
                    var PopupView = $.require("PopupView")
                    var garagelist = PopupView.lookupList(list,{
                             ignoreanchorstyle:true,combo:true,combotitle:"Search",
                            destroyonhide:false,anchor:ev.target,maxHeight:200,minWidth:250 ,
                            callback:function(rec){

                                app.authenticate("facility__manager"+rec.id,"auto").then(function(){
                                     window.location.reload();
                                })

                                this.hide()
                            }
                        })
                     garagelist.show()
                 })


            }
            mixin.loginAct=function(act){
                if(act=="signup"){
                    app.promptNewAccount(function(data){
                        app.promptLogin(function(data){
                            app.setUpSession(data)
                        },true,data.loginid)
                    } );
                    return
                }
                if(!app.isLoggedIn()){
                    app.promptLogin(function(data){
                        app.setUpSession(data)
                    },true)
                } else {
                    app.signOut();
                }
            }
            c.mixin(mixin);


            root.on("viewchange",function(nu){
                var key="cmd_"+nu.id
                var link=root.el.q("[data-cmd='"+key+"']")
                if(link){link.parent().qq(".active").removeClass("active")
                    link.addClass("active")
                }

                app.router.pushState({path:nu.id,handle:this.setView.bind(this,nu.id)})
                var title=nu.title
                if(nu.title=="DashBoard"){title=""}

                var el=this.el.q(".garage-menu-"+nu.id)
                this.el.st(".garage-meu.selected").removeClass("selected")
                if(el){
                    el.addClass("selected");
                }
            });

            $.viewport.on(setLandingDims )

            $d.on(".user-signin","click.sigin",function(ev){
                if(!app.user.id){
                    app.promptLogin(function(data){
                        app.setUpSession(data)
                    },true)
                } else {
                    app.signOut("garage");
                }
            });

           // $.fn.delay(setLandingDims,2200)


    app.viewRoot=root;

    return root;
}
function updateUpcoming(){
    if(!app.viewRoot){return}
    var upcoming=app.viewRoot.el.q(".slots .upcoming");
    if(!app.user.facility_id){
        if(app.user.facility && app.user.facility.id){
            app.user.facility_id=    app.user.facility.id
        }
    }
    upcoming && app.remoteDirective("upcomingcount",{facility_id:app.user.facility_id}).then(
        function(data){
            data && upcoming.q(".quantity").html(String(data.count||0))
        })
}
var garageview = {
    $el:null,
    resetDims:function(){
        var ht=$.viewport.get().height;
        //$d.css(userview.$el,{maxWidth:$.viewport.get().width});//,overflowY:ht<640?"auto":"hidden"
        //$d.css(".search-map",{h:Math.max(200,ht-(220+150+($d.height(".top-header")||0)))})
    },
    activate: function () {

    },
    init: function () {
         var cntnr=$d(".content-outer .user-views")
        /*app.rootView.theview.on("afterlayout",function(){
            this.el.css({position: "relative",height: "auto"})
        });
        app.rootView.show();*/
        var root=_makeViews(cntnr)
        root.show()
        var ww=new WeatherWidget( ".weather" )
        ////var weatherph = $d(".weatherph")
       // ww.render()

        $d.addClass(root.el,"garage")
        root.on("attach",function(){
                var dummymodel=$.model.newInstance()
                dummymodel.addProperty("user")
                dummymodel.getController().mixin({signOut:function(){app.signOut()}})
                dummymodel.user=app.userDetails;
                dummymodel.digest($d(".top-header"))
                root.setView("garagehome");
                setTimeout(setLandingDims,100);
                $d(".app-splash") && $d(".app-splash").anim("hide")
                var upcoming=root.el.q(".slots .upcoming");
                if(app.user && !app.user.facility_id){
                    if(app.user.facility && app.user.facility.id){
                        app.user.facility_id=    app.user.facility.id
                    }
                }
                if(upcoming){
                    app.remoteDirective("upcoming",{facility_id:app.user.facility_id}).then(
                        function(data){
                            upcoming.q(".quantity").html(String(data.items.length))
                        })
                    var template=DataGrid.generateTemplate({cellklass:"upcoming-item",cols:[{label:"User",name:"username"},{label:"Start",name:"starttime"},{label:"Duration",name:"duration"},{label:"Slot",name:"slotname"}]})
                    //var template=$d.template("<tr class='upcoming-item-row grid-row'><td class='upcoming-item grid-cell'>$username</td><td class='upcoming-item  grid-cell'>$starttime</td><td class='upcoming-item  grid-cell'>$duration</td><td class='upcoming-item  grid-cell'>$slotname</td></tr>")
                    upcoming.on("click",function(){var anchor=this;
                        app.remoteDirective("upcoming",{facility_id:app.user.facility_id}).then(
                            function(data){if(!data){return}
                                upcoming.q(".quantity").html(String(data.items.length));

                                var content=template({row:data.items.map(function(a){
                                    return {username: a.username,slotname: a.slotname,id: a.id,
                                        starttime:$.date.format(a.computed_start_long,"mm/dd/yyyy hh:nn tt"),duration:a.scheduled_duration+" "+ a.duration_type}
                                })})
                                //list.push("</tbody></table>")
                                var dial=new PopupView({showarrow:true,anchor:anchor,height:300,width:500, title:"Upcoming",contentUI:{overflowY:"auto"},destroyonhide:true})
                                dial.show();
                                dial.setContent(content);
                                dial.$content().addClass("upcoming-items gridtable").css("overflowY","auto")
                                    .on("click",function(ev,el){
                                            if($d.domdata(el,"id")){
                                            app.remoteDirective("reserveinfo",{reserveid:$d.domdata(el,"id")},function(data){
                                                data && ReserveCardView.show({record:data,showtimer:true, anchor:el})
                                            })
                                        }
                                    },"tbody tr");
                            }
                        )

                    })

                }
                var notificationlink = $d(".slots .notifications")

                if (notificationlink) {
                    notificationlink.on("click", function () {
                        app.notificationsView.toggleView();
                    });

                }
            }

        );
        app.onRemote("reservestatus" ,function(ev){
            var msg=ev.data.message||ev.data.msg;
            if(msg){
                app.splashInfo("Updated<br/>"+(msg||""),1000)
            }

            if(ev.data.stats){
                app.updateFacilityStats(ev.data.stats)
            }
            updateUpcoming()
            app.fire("reservestatusupdate",ev.data)
        })
        var d=new Date(),d1=new Date(),flds= [
            {name:"facility_id",type:"number"},
            {name:"slotid",type:"number"},
           // {name:"}//slotcolor",type:"string"},
            {name:"slotgroupname",type:"string"},
            {name:"slotgroupid",type:"number"},
            {name:"end",type:"number"},
            {name:"st",type:"number"},
            {name:"resstatus",type:"number"},
            {name:"reserve_id",type:"number"},
            {name:"member_id",type:"number"},
            {name:"reserve_num",type:"string"},
            {name:"dur",type:"number"},
            {name:"act_dur",type:"number"},
            {name:"slot_status",type:"number"},
            {name:"slotname",type:"string"},
            {name:"location",type:"string"}
       ],onlyreservedflds= [
            {name:"facility_id",type:"number"},
            {name:"slotid",type:"number"},
            // {name:"}//slotcolor",type:"string"},
             {name:"end",type:"number"},
            {name:"st",type:"number"},
            {name:"resstatus",type:"number"},
            {name:"reserve_id",type:"number"},
            {name:"member_id",type:"number"},
            {name:"reserve_num",type:"string"},
            {name:"dur",type:"number"},
            {name:"act_dur",type:"number"},
            {name:"slot_status",type:"number"},
         ];;
        root.getSlots=function(){
            if(!this._slotListpromise){
                this._slotListpromise=Promise.deferred()
                app.remoteDirective("slots",{facility_id:app.user.facility.id}).then(function(a){
                    var data=a.items.map(function(r){return {slotid: r.id,slotname: r.name,slotgroupid: r.slot_group_id,slotgroupname: r.slot_group_name,}})

                    this._slotListpromise.resolve(JSON.stringify(data))
                }.bind(this))
            }
            return this._slotListpromise;
        }

        var ths=this
        root.model.slotEntity = Data.defineLocalEntity("allslots",flds)
        root.getSlotStore=function(){
             var store=this.model.slotEntity.createStore(),allcols=flds.map(function(a){return a.name})
            app.slotstore1=store;
            store.loadData=function(facility_id,date,dateto){

                var store=this,pr=Promise.deferred()
                app.remoteDirective("allslots", {type:"allslots" ,args:{facility_id: facility_id,date_from:+date,date_to:+dateto,onlyreserved:true}},function(a){

                      root.getSlots().then(function(data){
                         var slotmap={},slots=JSON.parse(data)
                         var cols=onlyreservedflds.map(function(a){return a.name}),data=[],
                             othercols=allcols.filter(function(k){return cols.indexOf(k)==-1})
                          if(!store.getOriginalList().length){
                              store.addAll(slots);
                          }
                          var recs=store.records
                         if(a && a.items){
                             data = a.items.split("```").map(function(it){return it.split(/\|/).reduce(function(m,v,i){
                                 m[cols[i]]=v;
                                 return m
                             },{})});

                         }
                         var slotln=slots.length,dalaln=data.length,ids=[],recln=recs.length
                          for(var i=0;i<dalaln;i++){
                              ids.push(+data[i].slotid)
                              data[i].slot_status||(data[i].slot_status="0");
                              delete data[i].slotid;
                          }
                          for(var i=0;i<recln;i++){
                              var rec=recs[i],id=+rec.slotid,idx=ids.indexOf(id)
                              if(idx>=0){
                                  rec.update(data[idx])
                              } else if((+rec.slot_status)!=0){
                                  rec.slot_status="0"
                              }

                          }
                          store.setOriginalList(recs.slice())

                          /*for(var i=0;i<dalaln;i++){
							  var id=+data[i].slotid
							  var rec=store.find(function(r){return r.slotid== id})
							  data[i].slot_status||(data[i].slot_status="0");
							  if(rec){ids.push(id)
								  rec.update(data[i])
							  }
							  //slotmap[slots[i].slotid]
							  //slotmap[data[i].slotid]=data[i];
						  }
                           store.getOriginalList().each(function(rec){
                              if(ids.indexOf(rec.slotid)==-1 && rec.slot_status!="0"){
                                  rec.slot_status="0"
                              }
                          })
                         for(var i=0;i<slotln;i++){
                             store.findById()
                             slotmap[slots[i].slotid] && Object.assign(slots[i],slotmap[slots[i].slotid]);
                             slots[i].slot_status||(slots[i].slot_status="0");
                         }
                          store.clear();
                          store.addAll(slots);*/

                         pr.resolve(store)


                     })

                 });
                return pr
            }
            return store;
        }
        if (!app.notificationsView) {
            app.notificationsView = new AppnotificationsView({triggerCount: ".slots .notifications .quantity"})
        }
        app.notificationsView.refreshView();


    }
}

module.exports=garageview
//app.addModule("garage",garageview)
}
__bootstrap__.modules["garage/GarageBrowser"] = function(module){
var ReserveModel=$.require("models/ReserveModel")
var DataGrid=$.require("DataGrid");
 var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")

function controller(el){
	//el.fillContainer()
	var container=el.q(".grid-container")
	container.css({h:$.viewport.height - container.bounds().top});
	if(this.visibleFirst) {
		var holder = {}
		this._grid=holder
		app.getEntity("facilitywithrates").then(function (ent) {

			holder.store = ent.createStore(true)
			var cfg = {  };
			"id operator_id gstatus_id ASSET_THUMBS refid is_open zip rate_model_id facility_ratesid floor_manager_id owner_id fund_id spec_rates hrs_id space_type_id effective_date".split(/\s+/).forEach(function (a) {
				cfg[a.toLowerCase()] = {hidden: true}
			});
			cfg.operator_id||(cfg.operator_id={});
			cfg.operator_id.searchalias="operator"
 			ent.updateFields(cfg);
			 var opt = {nowrap: true,  headerFilter: {filterColumns:"name operator_id address region_id spaces_total facility_format_id".split(/\s+/)},sortable:true}
			 holder.store.defaultCriteria = "location_id = 1"

			holder.grid = new DataGrid(holder.store, opt);
			holder.grid.build(container)
			holder.grid.pager.sortcol = "id"
			holder.grid.pager.sortdir = "d"
			holder.grid.pager.pagesize = 40
			holder.grid.pager.loadPage()
			holder.grid.domcomponents.toolbar.append("<button class='ui-button-sm'>Export</button>").on("click",function(){
				var store=ent.createStore(true)
				store.pager.cachekey=holder.grid.pager.cachekey
				store.defaultCriteria=holder.store.defaultCriteria
				store.pager.sortcol = holder.grid.pager.sortcol
				store.pager.sortdir = holder.grid.pager.sortdir
				store.pager.filter = holder.grid.pager.filter
 				store.pager.pagesize=-1

				var ele=holder.grid.domcomponents.tab,cols=[],i=0
				 ele.qq(".grid-col").each(function(a,i){
					 cols.push({name:a.domdata("name"),idx: i})});
 				ele.qq(".grid-header tr th" )
					.each(function (it,i) {
						cols[i]||(cols[i]={});
						cols[i].wd= it.offsetWidth
						cols[i].label= it.val();
						cols[i].stl= (it.css("textAlign") == "right" ? "numstyle" : "genstyle")
						i++
					})
 				store.pager.loadPage().then(
					function(data){
 						var rows=data.map(function(rec){
 							return  cols.map(function(it){return rec[it.name]})
						})
						Util.exportToExcel({rows:[].slice.call(rows),cols:cols,filename:"facilities.xls"})
					}
				)
				//Util.exportToExcel({el:holder.grid.domcomponents.tab,})

			})


			});
	}
}

var GarageBrowser=app.defineView( {id:"garagebrowser" ,model:new  ReserveModel(),title:"Search",controller:controller});

module.exports=GarageBrowser
}
__bootstrap__.modules["garage/garagepricing"] = function(module){
var app=$.require("app")
var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")
var PopupView=$.require("PopupView")

var DataGrid= $.require("DataGrid")
var formtemplate="Z!div.flr.profileheader>{{id}}+{{asset_thumbs}}+(div.flr.profilelabel>{{name}})+{{lat}}+{{lng}}+{{operator_id}}+{{phone}}+{{region_id}}+{{hrs_id}}+{{pmt_type_id}}+{{spaces_total}}+{{facilityformat_id}}\
 div.flr>{{address}}+{{space_type_id}}\
 div.flr>{{fund_id}}+{{owner_id}}+{{floor_manager_id}}"

function controller(el){
	if(this.visibleFirst && !this.model){this.model=$.model.newInstance()}
	var vw=this ,_formInst=this.data("form")   ;
	if(_formInst){return}
	if(this.visibleFirst){

		//vw.el.q(".garage-info").fillContainer("min");
		var  defaultCriteria={facility_id:app.user.facility.id}
		function prepGrid(store,dom,optns){
			var holder= {dom:dom}
			holder.formPanel=new PopupView({height:380,width:500,footer:{height:30},modal:true})
			holder.store=store
			var opt= $.extend({entityForm:{defaultCriteria:{facility_id:app.user.facility.id}},sortable:true,   title:"Staff",
				editoptions:{},zebraColumn:true ,resizable:true},optns||{})
			holder.grid=new  DataGrid(holder.store,opt);
			holder.grid.build(holder.dom)
			holder.grid.pager.pagesize=-1
			holder.grid.pager.loadPage()

			return holder
		}
		function prepStore(ent,nocache){
			var store = ent.createStore(nocache)
			store.defaultCriteria={facility_id:app.user.facility.id}
			store.meta.updateFields({
					facility_id: { hidden: true, defaultValue: app.user.facility.id }
				}
			);
			return store
		}

		app.getEntity("facility_rates_alt",true).then(function(ent){
			var store=prepStore(ent,true);
			ent.updateFields({
					effective_date: {hidden: true},
					isactive: {type: "bool"}
				}
			);
			var opts={meta:store.meta,ui:{labelwidth:100},defaultCriteria:{facility_id:app.user.facility.id} }
			store.load().then(
				function(rec){
					opts.dataRecord=store.records[0];
					$.require("UI.Form",function(form){
						var _formInst=form(opts);
						vw.data("form",_formInst)    ;
						_formInst.appendTo(vw.el.q(".garage-rates-alt .form-body"))
						vw.el.q(".garage-rates-alt .form-ftr button").on("click",function(a){
							_formInst.save().then(
								function(){

								}
							);

						})
					})
				}
			);
		})
		app.getEntity("facility_rates",true).then(function(ent){
			var store=prepStore(ent,true);
			ent.updateFields({
					effective_date: {hidden: true},
					isactive: {hidden: true}
				}
			);
			var opts={meta:store.meta,ui:{labelwidth:100},defaultCriteria:{facility_id:app.user.facility.id} }
			store.load().then(
				function(rec){  opts.dataRecord=store.records[0];
					$.require("UI.Form",function(form){
						var _formInst=form(opts);
						vw.data("form",_formInst)    ;
						_formInst.appendTo(vw.el.q(".garage-rates .form-body"))
						vw.el.q(".garage-rates .form-ftr button").on("click",function(a){
							_formInst.save();
						})
					})
				}
			);


		});

		function makeMultiSel(el,options){
			/*

			 */
			var targetip,wrap=el
			if(el && el.is("input") && !el.is("select")){
				el.wrapEl("div");
				targetip=el
				targetip.hide();
				wrap=el.up()
			}
			else if(el && el.is("select")){
				el.addClass("multi-sel-ip")
				el.wrapEl("div")
				wrap=el.up()
			}
			wrap.addClass("multi-sel-wrap");
			var sel=wrap.q("select")
			options=options||{}
			if(!sel){
				sel=wrap.append(document.createElement("select"))
				var list
				if(options) {
					if (typeof(options) == "string") {
						list = options.split(/\s+/)
						options = {}
					}
					else if (Array.isArray(options)) {
						list=options;
						options = {}
					}
					else if (options.list) {
						list = options.list
					}
				}
				if(list && Array.isArray(list)){
					sel.addOptions(list)
				}

			}
			if(sel.options && ![].slice.call(sel.options).some(function(a){return a.value=="_"|| a.value=="_"})){
				var option = document.createElement("option");
				option.value = "";
				option.text = options.placeholder||"[select an item]";
				sel.el.add(option,0)
			}
			var lookuplist=[];
				[].slice.call(sel.options).forEach(function(a,i){if(a.value && a.value!="_" && a.value!="all"){
					lookuplist.push(a.value)
				}
				})
			function sync(){
				if(!(wrap && wrap.isVisible(true))){return ""}
 				var vals=wrap.select(".item").map(function(a){return a.dataset.key})
				vals.sort(function(a,b){return lookuplist.indexOf(a)-lookuplist.indexOf(b)})
				targetip && targetip.val(vals.join(","));
				return vals.join(",")
			}
			function clearList(){
				if(!(wrap && wrap.isVisible(true))){return this}
				wrap.select("span").remove()
				sync()
				return this
			}
			function updateList(val,label){
				if(!(wrap && wrap.isVisible(true))){return this}
				var container=wrap
				if(Array.isArray(val)){
					val.forEach(updateList)
					return this
				}
				if(val=="_"||val=="-"||!val){return this}
				var nu,toclone=container.q(".item")
				if(toclone){
					nu=toclone.el.cloneNode(true)
				} else{
					nu=document.createElement("span")
					nu.classList.add("item")
					nu.innerHTML="<div  class='content'></div><div class='cancel-link'>&Cross;</div>"
				}
				nu.dataset.key=val
				if(!(label && typeof(label)=="string")){
					label=$.titleize(String(val))
				}
				nu.querySelector(".content").innerHTML=label

				container.q("select").before(nu);

				return this
			}
			wrap.addEventListener("click",function(ev){
				if(!ev.target.classList.contains("cancel-link")){return}
				var par=ev.target.parentNode
				par.parentNode.removeChild(par)
				sync()
			});
			sel.addClass("multi-sel-ip").removeClass("ui-ip").css("width","auto")
			sel.on("change",function(){
				var val=this.val(),label=(this.options[this.selectedIndex]||{}).text||val;
				if(val=="_"||val=="-"||!val){return}

				this.selectedIndex=0;
				if(this.parent().select(".item").some(function(a){return a.dataset.key==val})){
					return
				}
				this.val("_");
				var curr=sync().split(",")
				if(val=="all"){
					val=[].slice.call(this.options).map(function(a){return a.value}).filter(function(a){return a && a!="_" && a!="all" && curr.indexOf(a)==-1})
				}
				updateList(val,label )
				var vals=sync()
				clearList()
				updateList(vals.split(",") )

			});
			if(options && options.vals){
				updateList(options.vals,wrap)
			}
			return {
				update:function(vals){
					clearList();
					updateList(vals)
				},
				clear:clearList,
				sync:sync

			}
		}
		//special rates
		function _makeForm(ent,grid,dataRecord){
			var dt=$.date(),timelist=[""],timelistNextDay=[]
			var today = $.date().trunc(),daylong= (+today);
			var now=$.date(+today) ,date=now.date,count=(24*4)
			for(var i=0;i<count;i++){
				timelist.push({id:String((+now) - daylong) ,label:now.format("hh:nn tt")})
				now.plus("n",15)
			}
			var lastdayentry= $.date(+now).minus("n",1),offset=(+now) - daylong
			timelist.push({id:String((+lastdayentry) - daylong) ,label:lastdayentry.format("hh:nn tt")})
 			for(var i=1;i<count;i++){
				timelistNextDay.push({id:String(offset+((+now) - daylong)) ,label:"Next Day - "+now.format("hh:nn tt")})
				now.plus("n",15)
			}
			var labelwd=70
			var upd={
					active_from:{type:"date",ui:{inline:true},label:"From",format:"mm/dd/yyyy",labelwidth:labelwd,width:80},
					active_to:{type:"date" ,format:"mm/dd/yyyy",label:"To",ui:{inline:true},labelwidth:30,width:80},
					days:{label:"_", wrapstyle:{display:"block"} },
					"rate":{labelwidth:labelwd},
					"name":{labelwidth:labelwd},
					"coupon_code":{labelwidth:labelwd},
					reservation_required:{labelwidth:labelwd,label:"Res Reqd."}
				},
				formtemplate="Z!(div.flr>{{name}})(div.flr>{{rate}})";
				formtemplate += "(div.flr>{{coupon_code}})";
				formtemplate += "(div.flr>{{reservation_required}})";
				formtemplate += "(h4.labl>{Active})(div.flr>{{active_from}}+{{active_to}}+span.cancel[display:inline-block;]>{X})";
	            formtemplate += "(h4.labl>{Days of Week:})(div.flr>{{days}}";



			"startmin startmax endmin endmax durationmin durationmax".split(" ").forEach(function(k) {
				var range= k.substr(k.length-3),nm= k.substr(0,k.length-3),label=range
				upd[k] = { width: nm=="duration"?70:120,labelwidth:range == "max"?50:labelwd ,list:nm=="duration"?null:timelist}
				if(nm=="start") {
					if (range == "min") {
						label = "-"

					}
					else {
						label = "and"
					}
				} else if(nm=="end") {
					if (range == "min") {
						label = "-"
					}
					else {
						label = "and"
					}
				} else{
					upd[k].label=range == "min"?"-":"to"
					upd[k].iptype="number"
				}
				if (range == "max") {
					upd[k].labelstyle={textAlign:"center"}
				}
				if(nm!="duration" && !(nm=="start" && range=="min")){
					upd[k].list=upd[k].list.concat(timelistNextDay)
				}
				upd[k].label=label
			});
			formtemplate += ")(h4.labl>{Enter between})(div.flr>{{startmin}}+{{startmax}}+span.cancel[display:inline-block;]>{X})"
			formtemplate += "(h4.labl>{- Leave between})(div.flr>{{endmin}}+{{endmax}}+span.cancel[display:inline-block]>{X}) "
			formtemplate += "(h4.labl>{OR})"
			formtemplate += "(h4.labl>{- Duration within})(div.flr>{{durationmin}}+{{durationmax}}+span.cancel[display:inline-block]>{X})"


			ent.updateFields(upd );

			var opts={meta:ent,ui:{labelwidth:80},layoutTemplate:formtemplate,defaultCriteria:{facility_id:app.user.facility.id} }
			var form=$.require("UI.Form")
			var vw=new PopupView({animateShow:false,minWidth:400,title:"Special Rate",destroyonhide:true})
			vw.show();
			opts.dataRecord=dataRecord

			var _formInst=form(opts);
			vw.data("form",_formInst)    ;
			vw.observer.on("beforehide",function(el){
				if(el && $d.selfOrUp(el,".popup-view")){
					return false;
				}
			})
			_formInst.appendTo(vw.$content())
			_formInst.config.noadjustwidth=true;
			var fld=vw.$content().q("[data-key='days'] .ui-ip")
			var wrap=fld.up(".field-wrap2")
			if(wrap){wrap.css("display","block")}

			var multisel=makeMultiSel(fld,{
					list:[{key:"_",label:"[select a day]"},{key:"all",label:"[All]"}].concat(["sun","mon","tue","wed","thru","fri","sat"].map(function(a){return {key:a,label: $.titleize(a)}}))}
			);
			vw.addButton({label:"Save",callback:function(){
			    _formInst.model.set("days",multisel.sync());
				"startmin startmax endmin endmax durationmin durationmax".split(/\s+/).forEach(
					function(k){
						_formInst.model.ifnull(k,0)
					}
				)
				_formInst.save().then(function () {
					vw.hide()
					grid.pager.loadPage()
					grid.fire("save", dataRecord)
				})
			}});
			_formInst.formDom.qq("span.cancel").css({marginLeft:"10px",cursor:"pointer",color:"red"}).on("click",function(){
				this.up(".flr").qq(".ui-ip").val("")
			});
			_formInst._view=vw;
			_formInst.model.onchange("days",function(rec){
				if(rec.value){
					multisel.update(rec.value.split(","))
				}
			})
			return _formInst;
		}

		app.getEntity("rate_model",true).then(function(ent){
			var store=prepStore(ent,true);
			ent.updateFields({rate_list:{hidden:true},
				rate_msg:{cellRenderer:function(val){
					return val.replace(/;/g,"<li>&nbsp;&nbsp;")
				}},
				reservation_required:{cellRenderer:function(val){
					return val=="1"?"Yes":"No"
				}},
				rate:{cellRenderer:function(val){
					return val?$.numberFormat(val,"$##.00"):val
				}}
			} );
			prepGrid(store,vw.el.q(".garage-spec-rates"),{ columns:["name","coupon_code","rate","rate_msg"], title: "Special Rates",entityForm:{setUp:function(grid,record){
				return _makeForm(ent,grid,record)

			}}});

		});
	}

 }

var garagepricing=app.defineView( {id:"garagepricing" , template:"garagepricing"  ,model:null,title:"Pricing",controller:controller});

module.exports=garagepricing
}
__bootstrap__.modules["garage/garagesearch"] = function(module){
var ReserveModel=$.require("models/ReserveModel")
var DataGrid=$.require("DataGrid");

function controller(el){
	//el.fillContainer()
	var container=el.q(".grid-container")
	container.css({h:$.viewport.height - container.bounds().top});
	if(this.visibleFirst) {
		var holder = {}
		this._grid=holder
		app.getEntity("facility_reserveusers").then(function (ent) {

			holder.store = ent.createStore(true)
			var cfg = {
				scheduled_duration: {label: "duration"},
				member_id:{searchalias:"username"},
				duration_type: {
					list:[{id:"h",label:"Hourly"},{id:"m",label:"Monthly"},{id:"d",label:"Daily"}]
				},
				resstatus: {
					list:[{id:1,label:"Reserved"},{id:2,label:"Checked In"},{id:99,label:"Checked Out"},{id:500,label:"Cancelled"}],
					label:"Status",
					cellRenderer: function (val,k) {
						return "<div style='background-color:" + (val == 'Reserved' ? "yellow" : (val == 'Checked In' ? "green" : (val == 'Checked Out' ? "blue" : "red"))) + "'>"+k+"</div>"
					}, defaultValue: 1
				}
			};
			"reserve_extra_extras notifications checked_out member_id facility_id operator_id operator floor_manager_id reserve_id address name vehicle_type vehicle_id vehicle_description vehicle_model usertype slotlocation slotid firstname lastname middlename computed_start_long rate_model_id computed_end_long extra1 extra2 isprimary vehicle_color vehicle_year".split(/\s+/).forEach(function (a) {
				cfg[a] = {hidden: true}
			});
			ent.updateFields(cfg);
			var opt = {nowrap: true,  headerFilter: {filterColumns:"username date_from duration_type scheduled_duration vehicle_plate barcode reserve_num resstatus vehicle_model vehicle_make slot_name account_num email".split(/\s+/)},sortable:true}
	holder.store.defaultCriteria = "facility_id = " + app.user.facility_id
	holder.grid = new DataGrid(holder.store, opt);
	holder.grid.build(container)
			holder.grid.pager.sortcol = "id"
			holder.grid.pager.sortdir = "d"
			holder.grid.pager.pagesize = 40
			holder.grid.pager.loadPage()

		});
	}
}

var garage_search=app.defineView( {id:"garagesearch" , template:"garagesearch",model:new  ReserveModel(),title:"Search",controller:controller});

module.exports=garage_search
}
__bootstrap__.modules["garage/garageservice"] = function(module){
var app=$.require("app")

function doCheckIn( data,callback) {
    return app.remoteDirective("docheckin",{ sel: data },callback)

}
function doReserve( data,callback) {
    return app.remoteDirective("confirmreserve",{ sel: data },callback)
}
function doCheckOut(data,callback ) {
    return app.remoteDirective("docheckout",{ sel: data },callback)
}


module.exports={
    doCheckOut:doCheckOut,
    doReserve:doReserve,
    doCheckIn:doCheckIn

}
}
__bootstrap__.modules["garage/garagestores"] = function(module){
var reservestore,reserveStorePending=1,reserveStorePromise=null,reserveStoreReservedPending=1,reserveStoreReservedPromise=null,reservestoreReserved=null;
function refreshReserveStore(callback){
    if(!reserveStorePending) {
        reserveStorePending = 1
        reserveStorePromise = null;
    }
    getReserveStore(callback)
}
function getReserveStore(callback){
    if(!reserveStorePromise){reserveStorePromise=Promise.deferred()}
    if(callback){reserveStorePromise.then(callback)}
    if(reserveStorePending>0&&reserveStorePending<4) {
        app.getEntity("facility_reserveusers").then(function (ent) {

            ent.updateFields({
                date_from: {type: "date", label: "Date"},
                time_from: {type: "time", label: "Time", cellui: {style: {whiteSpace: "nowrap"}}},
                reserve_num: {label: "Num"},
            });
            reservestore = ent.createStore()
            app.Xreservestore = reservestore;
            reservestore.pager.sortcol = "id"
            reservestore.pager.sortdir = "d"
            reservestore.provider.includelookups = false;
            reservestore.pager.pagesize = -1
            reservestore.defaultCriteria = "facility_id=" + app.user.facility.id + " and resstatus < 99"
            reservestore.load(true).then(function () {
                    reserveStorePending = 0
                    reserveStorePromise.resolve(reservestore)
                },
                function () {
                    reserveStorePending++
                    setTimeout(getReserveStore, 0)
                })
        });
    }
    return reserveStorePromise
}
var checkedInStore,checkedInStoreActivePromise
function getCheckedInStore(callback){
    if(!checkedInStore){
        app.getEntity("facility_reserveusers").then(function (ent) {
            checkedInStore= ent.createStore()
            checkedInStore.pager.sortcol = "id"
            checkedInStore.pager.sortdir = "d"
            checkedInStore.provider.includelookups = false;
            checkedInStore.pager.pagesize = -1
            checkedInStore.defaultCriteria = "facility_id=" + app.user.facility.id + " and resstatus = 2"
        })
    }
    if(checkedInStoreActivePromise){checkedInStoreActivePromise.then(callback)}
    checkedInStoreActivePromise=Promise.deferred()
    checkedInStore.load(true).then(function () {
            checkedInStoreActivePromise.resolve(reservestore)
            checkedInStoreActivePromise=null;
        },
        function () {
            checkedInStoreActivePromise.resolve(reservestore)
            checkedInStoreActivePromise=null;
        });
}

function refreshReserveStoreReserved(callback){
    if(!reserveStoreReservedPending) {
        reserveStoreReservedPending = 1
        reserveStoreReservedPromise = null;
    }
    getReserveStoreReserved(callback)
}
function getReserveStoreReserved(callback){
    if(!reserveStoreReservedPromise){reserveStoreReservedPromise=Promise.deferred()}
    if(callback){reserveStoreReservedPromise.then(callback)}
    if(reserveStoreReservedPending>0&&reserveStoreReservedPending<4) {
        app.getEntity("facility_reserveusers").then(function (ent) {

            ent.updateFields({
                date_from: {type: "date", label: "Date"},
                time_from: {type: "time", label: "Time", cellui: {style: {whiteSpace: "nowrap"}}},
                reserve_num: {label: "Num"},
            });
            reservestoreReserved = ent.createStore()
            reservestoreReserved.pager.sortcol = "id"
            reservestoreReserved.pager.sortdir = "d"
            reservestoreReserved.provider.includelookups = false;
            reservestoreReserved.pager.pagesize = -1
            reservestoreReserved.defaultCriteria = "facility_id=" + app.user.facility.id + " and resstatus = 1"
            reservestoreReserved.load(true).then(function () {
                    reserveStoreReservedPending = 0
                    reserveStoreReservedPromise.resolve(reservestoreReserved)
                },
                function () {
                    reserveStoreReservedPending++
                    setTimeout(getReserveStoreReserved, 0)
                })
        });
    }
    return reserveStoreReservedPromise
}

var refstores={
    refreshReserveStore:refreshReserveStore,
    getCheckedInStore:getCheckedInStore,
    getReserveStore:getReserveStore,
    getReserveStoreReserved:getReserveStoreReserved,
    refreshReserveStoreReserved:refreshReserveStoreReserved
}
module.exports=refstores
}
__bootstrap__.modules["garage/garageutils"] = function(module){
/**
 * Created by Atul on 5/24/2015.
 */
var ReserveModel=$.require("models/ReserveModel")
var SimpleView=$.require("SimpleView")
var PopupView=$.require("PopupView")
var qrcodeDialog
function ensureBarCode(dom,model) {
    if(!(dom && dom.q(".user-bar-code"))){return}
   if(dom.q(".user-bar-code img")){return}
   if(model.userVehicle && model.userVehicle.id){
      model.userVehicle.drawBarCode && model.userVehicle.drawBarCode(dom.q(".user-bar-code"))
   }
}
var garageutils={
   RESSTATUS: {
      CHECKEDIN: 2,
      RESERVED: 1,
      lATE: 3,
      CANCELLED: 4,
      NEEDSFOLLOWUP: 5,
      PAYMENTPENDING: 6,
      PAYMENTPROCESSED: 7,
      CHECKEDOUT: 99,
      COMPLETED: 100
   },
   captureQRCode:function captureQRCode(callback) {
      window.addEventListener("message",function _onmessage(ev){
         if(typeof(ev.data)=="string" && ev.data.indexOf("!_")==0){return}
         var data=typeof(ev.data)=="string"?JSON.parse(ev.data):ev.data
         if(data && data.type=="qrcode"){
            window.removeEventListener("message",_onmessage)
            qrcodeDialog && qrcodeDialog.hide();
            callback && typeof(callback)=="function" && callback(data.result)
             qrcodeDialog=null;
         }

      })
      if(!qrcodeDialog){
         qrcodeDialog=new PopupView({height:400,width:350,
            hideonblur:false,
            resizable:true,showcancellink:true,
            title:"Capture QR Code"
         })
         qrcodeDialog.setContent({url:app.contextPath+"app/qrcodecapture/qr.html"})
         qrcodeDialog.observer.on("hide",function(){
            this.$content() && this.v.remove();
            qrcodeDialog=null;
         });
      }

      qrcodeDialog.show();
   },
   setupReservationSearch:function setupReservationSearch(reservestatus,ip,cntselector,resolveOverLaps,callback){
   var ths=this;
   var reservemodel = this.model,userrowTemplate,rowTemplate;
   function onselect(r,lkup) {
      var ths=this,resid = r.id
      if(_isUserSearch()){

         var activeel=$d.util.getActiveElement()
         // var anchor=$d.selfOrUp(activeel,".list-item")
         if(!$d.selfOrUp(activeel,".list-item")){return}
         if(r && r.id){
            ths.ip.val(r.fullname)
         }
         var anchor=lkup.config.options.anchor

         app.remoteDirective("userdetails",{targetid:resid}).then(
             function(u){
                var activeel=$d.util.getActiveElement()
                // var anchor=$d.selfOrUp(activeel,".list-item")
                //if(!anchor){return}
                if(u.vehicles && u.vehicles.length>=1){
                   var vehicleListView = new PopupView({
                      minWidth:350,animateShow:false,
                      maxHeight:function(bnds){
                         if(this.config && this.config.options&& this.config.options.anchor){
                            $.viewport.height - $d(this.config.options.anchor).bounds().top;
                            this.$content().css("overflowY","auto")
                            return $.viewport.height - ($d(this.config.options.anchor).bounds().bottom+40)
                         }
                         return 0
                      },
                      alignAnchor:"below",
                      anchor:anchor, title:'select a Vehicle' ,
                      content:"<ul class='vehicle-sel-list'>"+
                      u.vehicles.map(function(a){
                         return "<li class='list-row' style='white-space:nowrap;' data-key='"+(a.barcode)+"'>"+a.vehicle_plate +" "+a.vehicle_make +" "+a.vehicle_model +" "+a.vehicle_year +"</li>"
                      }).join("")+"</ul>"
                   });

                   vehicleListView.el.css({background:"white"})
                   vehicleListView.el.on("click",function(ev,el){
                      var code=el.domdata("key")
                      var vehicle=u.vehicles.find(function(a){return a.barcode==code}),user=Object.assign({},u);
                      delete user.vehicles;
                      vehicleListView.hide()
                      resolveOverLaps(ths,user,vehicle,user.reservations )

                   },".list-row")
                   vehicleListView.show()
                } else {
                   app.splashError("A vehicle is required for check=in")
                }
             }
         )
         return false
      }
      var rec = r//(this._currentRecords||[]).find(function(r){return r.id==resid})

      callback ( rec)

   }
   function _isUserSearch() {
      return ths.el.q(".user-search")  && ths.el.q(".user-search").val()===true
   }
   function _searchCallback( ev) {

      var ths=this,reservemodel = this.model ,el=this.el,val=this.ip.val()
      if (!( val && (typeof(val)=="string"))) {
         return Promise.reject()
      }
      var pr=Promise.deferred(),usersrch=_isUserSearch()

      var barcodesrch,facility_id=app.user.facility_id
      if(usersrch){
         if(!userrowTemplate ){
            userrowTemplate=$d.template("<div class='lookup-record'><span  class='rec-id'>$id</span><span  class='rec-firstname'>$firstname</span> <span  class='rec-lastname'>$lastname</span>, <span  class='rec-lastname'>$email</span></div>")
         }

         app.remoteDirective("findusers",{srch:val}).then(
             function(a){
                a=a||[]

                var rows=[].concat(a).map(function(r){
                   return {id: r.id,label:userrowTemplate(r),datarecord:r}
                })

                pr.resolve(rows)
             },
             function() {pr.reject( msg)
                ths._searchPending = false;
             }
         );
         return pr
      }

      if(!rowTemplate){
         rowTemplate = $.template(garageutils.reserveRecordTemplate)
      }
      console.log("findreservations",val)
      app.remoteDirective("findreservations",{searchstr:val,facility_id:facility_id,resstatus:reservestatus}).then(
          function(data){
             if(data && data.list){console.log("findreservations")
                pr.resolve( data.list.map(function(r){
                   return {id: r.id,label: rowTemplate(r),datarecord:r}
                }) )
             }
          },
          function(msg) {
             pr.reject( msg)
             ths._searchPending = false;
          }
      )

      return pr;
   }
   function triggerSearch(ev,clear){

      var ip=$d(this.ip);
      if(!ip){return}
      var list=this.data("_list"),val=ip.val()
      if(clear===true || !val){
         this.clearSearch()
         return
      }
      var vw=this;

      if(!list){

         list=$.require("PopupView").lookupList([{id:0,label:"searching .."}],{
            defaultText:"searching..",ignoreanchorstyle:true,
            destroyonhide:false,anchor:vw.ip,
            callback:function(rec){
               onselect.call(vw,rec,this);
               this.hide()
            }
         }).show()
         list.observer.on("beforehide",function(el){
            if(ip.contains(el)){return false}
         })
         vw.data("_list",list);
      }
      var _last=vw.data("_last");
      if(_last && vw.data("_last")==val && list.isVisible(true)){
         return
      }
      vw.data("_last","");
      if(this._searchPending){
         return
      };
      (function(vw,val,list, last,currentrecords){
         function _seachResults(rows ){
            vw._searchPending=false;
            vw.data("_last",val)
            vw._currentRecords=rows
            if(cntselector && vw.el.q(cntselector)){
               vw.el.q(cntselector).html(rows.length+" found");
            }
            if(!(rows && rows.length)){
               vw.clearSearch(true)
               return;
            }
            list.reset(rows,{anchor:vw.ip })
         }

         if(last && val && val.indexOf(last)==0 && currentrecords && list.isVisible(true)){
            var  rows=vw.model.findReservationsByText(val,currentrecords,_isUserSearch()?"user":"")
            _seachResults(rows,val)
         }
         else{vw._currentRecords=null;
            vw.searchCallback( ev).then(_seachResults ,
                function(err){err=err||{}
                   list.reset([{id:0,label:typeof(err)=="string"?err:(err.error||"..error...")}],vw.ip)
                }
            )
         }
      })(vw,val,list,_last,vw._currentRecords);
   }

   this.searchCallback=_searchCallback.bind(this)
   var dosearch=$.throttle(triggerSearch.bind(this),{tailend:true,delay:1000})
   var ip = this.el.q(ip);
   var _clearSearch=  function(noreset){
      var ip=this.ip;
      if(!ip){return}
      this.data("_last","")
      var l=this.data("_list")
      if(noreset!==true){
         ip.val("");
      }
      this._searchPending=false;
      if(l){l.hide()}

   }.bind(this) ;
   this.clearSearch=_clearSearch;
   ip.on("input focus mousedown",function(ev){
      if(!this.hassearchTrigger){dosearch(ev)}
   }.bind(this));
   ip.on("seachcancel esc",_clearSearch);
   this.ip=ip;
   var dom = this.el,activeel=null,vw=this;
   this.model.getController().mixin({
      toggleusersearch:function(ev) {
         var userlink=dom.q(".check-in-find-user-link");
         if(!userlink){return}
         if ($d.val(ev.target)) {
            vw.hassearchTrigger = true

            userlink.show().css({position:"absolute"}).on("click.searchtrigger",
                function(ev){
                   dosearch(ev);
                }
            )
            //ip.setTrigger(but)

         } else {
            //ip.setTrigger(null)
            vw.hassearchTrigger = null
            userlink.hide().off("click", "searchtrigger")
         }
         vw.clearSearch()
      }.bind(this)
   })

},
     reserveRecordTemplate:"<div class='lookup-record'>" +
        "<span  class='rec-reserve_num'>$reserve_num</span><span class='rec-time_from'>$reservetime</span>" +
        "<span class='rec-scheduled_duration'>$scheduled_duration</span><span class='rec-duration_type'>$duration_type</span><span  class='rec-slot'>$slotname</span>" +
        "<div  class='rec-name'>" +
        "<span  class='rec-firstname'>$firstname</span>" +
        "<span  class='rec-lastname'>$lastname</span>" +
        "<span  class='rec-vehicle_plate'>$vehicle_plate</span>" +
        "<span  style='color:$vehicle_color' class='rec-vehicle_make'>$vehicle_make</span>" +
        "</div>" +
        "</div>"
}
module.exports=garageutils
}
__bootstrap__.modules["garage/qrtest"] = function(module){
/**
 * Created by Atul on 7/13/2015.
 */
function controller(el){

	document.addEventListener("deviceready", loaded, false);
	function loaded() {
		pictureSource = navigator.camera.PictureSourceType;
		destinationType = navigator.camera.DestinationType;
		$d(".camera-control").on("click",capturePhoto)
	}

	function capturePhoto() {
		navigator.camera.getPicture(getPhoto, onFail, {
			quality : 50
		});
	}
	function getPhoto(imageData) {
 		var smallImage = document.getElementById('cameraPic');
		smallImage.style.display = 'block';
		smallImage.src = "data:image/jpeg;base64," + imageData;
	}
	function onFail(message) {
		alert('Failed because: ' + message);
	}

}

var qrtest=app.defineView({id:"qrtest",layout:"fill", selector:".qrtest", template:"qrtest", title:"qrtest",controller:controller});

module.exports=qrtest
}
__bootstrap__.modules["garage/reports"] = function(module){
var app=$.require("app")
var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")
var PopupView=$.require("PopupView")

var DataGrid= $.require("DataGrid")
var formtemplate="Z!div.flr.profileheader>{{id}}+{{asset_thumbs}}+(div.flr.profilelabel>{{name}})+{{lat}}+{{lng}}+{{operator_id}}+{{phone}}+{{region_id}}+{{hrs_id}}+{{pmt_type_id}}+{{spaces_total}}+{{facilityformat_id}}\
 div.flr>{{address}}+{{space_type_id}}\
 div.flr>{{fund_id}}+{{owner_id}}+{{floor_manager_id}}"

function controller(el){
	if(this.visibleFirst && !this.model){this.model=$.model.newInstance()}
	var vw=this ,_formInst=this.data("form")   ;
	if(_formInst){return}
	if(this.visibleFirst){

		this.data("form","pending")
		app.getEntity("facility").then(function(ent){
			var store=ent.createStore(true);
			store.meta.updateFields({
				asset_thumbs:{iptype:"img",type:"img",label:"_",width:100,height:100, wrapklass:"profileimage",reader:function(a){return "http://s3-w2.parkme.com/lot_img/"+a}},
				is_open:{hidden:true},
				lat:{"type":"decimal",width:90,labelwidth:90, label:"Lat Lng",wrapstyle:{marginLeft:0,textAlign:"right"}},
				lng:{ "type":"decimal",labelwidth:5,width:90,label:"/",wrapstyle:{marginLeft:0,textAlign:"left"}},
				name:{ "label":"_"}
			});
			store.defaultCriteria="id="+app.user.facility.id;
			store.load().then(
				function( ){
					$.require("UI.Form",function(form){
						var rec=store.getList().first();
						_formInst=form(store.meta,null, formtemplate,rec);
						_formInst.config.adjustwidths=false
						vw.data("form",_formInst)    ;
						_formInst.appendTo(vw.el.q(".contact-form"))
					});
				})
		})
		//vw.el.q(".garage-info").fillContainer("min");
		var  defaultCriteria={facility_id:app.user.facility.id}
		function prepGrid(store,dom,optns){
			var holder= {dom:dom}
			holder.formPanel=new PopupView({height:380,width:500,footer:{height:30},modal:true})
			holder.store=store
			var opt= $.extend({entityForm:{defaultCriteria:{facility_id:app.user.facility.id}},sortable:true,   title:"Staff",
				editoptions:{},zebraColumn:true ,resizable:true},optns||{})
			holder.grid=new  DataGrid(holder.store,opt);
			holder.grid.build(holder.dom)
			holder.grid.pager.pagesize=-1
			holder.grid.pager.loadPage()

			return holder
		}
		function prepStore(ent,nocache){
			var store = ent.createStore(nocache)
			store.defaultCriteria={facility_id:app.user.facility.id}
			store.meta.updateFields({
					facility_id: { hidden: true, defaultValue: app.user.facility.id }
				}
			);
			return store
		}
		app.getEntity("garage_slots").then(function(ent) {
			prepGrid(prepStore(ent),vw.el.q(".garage-slots"),{  title: "Slots", editoptions: {del: false, add: false} })
		});
		app.getEntity("monthly_user").then(function(ent) {
			prepGrid(prepStore(ent),vw.el.q(".garage-monthly"),{  title: "Monthly Users", editoptions: {add: false},columns:["username","vehicle_id","amount"] })
		});

		app.getEntity("facility_staff",true).then(function(ent){
			prepGrid(prepStore(ent),vw.el.q(".garage-staff"),{  title: "Staff"  })
		})

		app.getEntity("slot_group",true).then(function(ent){
			var store=ent.createStore(true),Color=$.require("ColorPicker").Color;
			ent.updateFields({
					color: {
						cellRenderer:function(val){
							var c=Color.from(val),hx
							if(c){
								hx= c.name && isNaN(c.name)? c.name:c.toHex(true)
							}
							return hx?"<div class='color-value' style='background:"+hx+";'>.</div>":val
						}
					}
				}
			);
			prepGrid(prepStore(ent),vw.el.q(".slot-groups"),{  title: "Slot Groups"  })
		})
		app.getEntity("facility_extras",true).then(function(ent){
			ent.updateFields({ active: { type:"boolean" }}  );
			prepGrid(prepStore(ent),vw.el.q(".garage-extras"),{  title: "Extras"  })
		})
	}

 }

var garage_reports=app.defineView( {id:"garagereports" , template:"garagesettings"  ,model:null,title:"Settings",controller:controller});

module.exports=garage_reports
}
__bootstrap__.modules["garage/settings"] = function(module){
var app=$.require("app")
var stores=$.require("garage/garagestores")
var utils=$.require("garage/garageutils")
var DataGrid= $.require("DataGrid")


function controller(el){

 }

var garage_settings=app.defineView( {id:"garagecontact" , template:"garagesettings",selector:".garagecontact" ,model:null,title:"Settings",controller:controller});

module.exports=garage_settings
}
__bootstrap__.modules["garage/SlotModel"] = function(module){
var SlotModel  = $.simpleModel.extend({
          record: null,
          el:null,
          updateStatus:function(){

         }
     }
 )

 module.exports=SlotModel
}
__bootstrap__.modules["garage/SlotView"] = function(module){
var SimpleView=$.require("SimpleView")
var SlotModel=$.require("garage/SlotModel")
var hdrtemplate = $.template("<span class='lbl'>Slots</span><span class='val'>$total</span><span class='lbl'>Occupied</span><span class='val'>$occupied</span><br/>" +
    "<span class='lbl'>Date:</span><span class='val'>$reservedate</span><span class='lbl'>from</span><span  class='val'>$time_from</span><span class='lbl'>to</span><span z-type='time' class='val'>$time_to</span>" +
    "")
 var template= "" +
     "<div class='parking-slot current-state-$slot_status group-color-$slotgroupid' data-index='$index' data-key='$slotid'>" +
         "<span class='slot-name' >$slotname</span>" +
         "<span class='slot-loc'>$slotgroupname</span>" +
         "<div class='status-flag'></div>" +
     "</div>",templatefn=null
var SlotView=Klass(SimpleView,{
        reservedate:{descriptor:true,type:"date"},
        reservedateEnd :{descriptor:true,type:"date"},
        last_refreshed:null,
        facility_id:null,
        slotstore:null,
        slotGroupStore:null,
        statusfilter:null,
        init:function() {
            this.properties.addProperties({
                "occupied":{descriptor:true,expr:function(rec){
                    if(rec.slotstore){
                        var cnt=rec.slotstore.size()
                        return rec.slotstore.records.findAll(function(a){return a && a.slot_status>0}).length
                    }
                }},
                "total":{descriptor:true,expr:function(rec){
                    if(rec.slotstore){
                        return rec.slotstore?rec.slotstore.size():0
                    }
                }}
            })
            this.initView()
            this.onpropertychange("last_refreshed",function(rec){
                this.updateTs()
            });
             this.onpropertychange("statusfilter",function(rec){

                 if(!this.el){return}

                if(rec.value!=null){

                    this.el.qq(".slot-stats-filter .status-item.selected").removeClass("selected");
                    this.el.qq(".slot-stats-filter .status-item[data-key='"+rec.value+"']").addClass("selected");
                }
                  if(!this.el.q(".slot-list")){return}

                 this.renderSlots()
            });

        },
        updateTs: function () {
            if(!this.el || !this.el.isVisible(true)){return}
            var dom=this.el.q(".refresh-list-message"),dt=$.date(this.last_refreshed);
            dom && dt && dom.html("last refreshed<br/>"+ dt.format("hh:nn tt"))
            setTimeout(this.updateTs.bind(this),6000)
        },
        setGroupList: function () {
                if (!this.slotGroupStore) {
                    return
                }
                var grpsel = this.el.q(".group-list-wrap .group-list")
                if (grpsel) {
                    var curr = this.properties.get("slotgroup")
                    var lst = this.slotGroupStore.collect(function (rec) {
                        return {id: rec.id, label: rec.name}
                    }).toArray()
                    lst.unshift({id: "0", label: "All"})
                    if (lst.length == grpsel.options.length) {
                        return
                    }

                    $d.addOptions(grpsel, lst, true)
                    if (curr) {
                        $d.val(grpsel, curr)
                    }
                    grpsel.el.onchange = function (ev) {
                        this.properties.set("slotgroup", ev.target.value)
                    }.bind(this)

                }
            if(this.last_refreshed){
                this.el.q(".refresh-list-message").html("last refreshed "+ $.date(this.last_refreshed).format("recency"))
            }

         },
        redrawHeader: function () {
            var store = this.slotstore, dom = this.el

            this.properties.recalcAll();
            var cnt = store.records.size(), occupied = store.records.findAll(function (a) {
                return a.slot_status>0
            }).length
            var data ={};
            data.total = store.size()
            data.occupied = occupied
            if (this.reservedate) {
                data.time_from = $.date.asTime(this.reservedate).format()
                data.reservedate = $.date(this.reservedate).format("mm/dd/yyyy")
            }
            if (!this.reservedateEnd) {
                this.reservedateEnd=$.date(this.reservedate).clone().plus("h",1)
            }
            data.time_to = $.date.asTime(this.reservedateEnd).format()

            dom.q(".slot-stats .slot-stats-hdr").html(hdrtemplate(data))
            this.setGroupList()

        },
        redraw: function (record) {
            var store = this.slotstore, dom = this.el
            var rl = dom.q("[data-key='" + record.id + "']"), v = record.slot_status||0
            if (rl) {
                var nu
                rl.removeClass(["current-state-","current-state-1", "current-state-0", "current-state-2"]).attr("title", "");
                nu = "current-state-" + v
                rl.addClass(nu).attr("title", v == 1 ? "Reserved" : (v == 2 ? "Verify and Assign" : "Not Available"))
            }

            this.redrawHeader()
        },
        getSlotRecord:function(slotid){
            if(!this.slotstore){return}
             return this.slotstore.records.find(function(r){return r.slotid == slotid});
         },
        renderSlots: function () {
            if(!this.reservedate || !this.slotstore){return}
            var store = this.slotstore, gp = Number(this.slotgroup) || 0, dom = this.el
             var colors = [],statusfilter=this.statusfilter;

             store.filter((gp || statusfilter)? function (a) {
                 if(!gp || a.slotgroupid == gp) {
                     if(statusfilter) {
                         if (!a.reserve_num && (statusfilter == "notav"||statusfilter == "recent")) {
                             return false
                         }
                         if (a.reserve_num && statusfilter == "av") {
                             return false
                         }
                     }
                     return true
                 }
                return false
            } : "_clear_")

            if (this.slotGroupStore) {
                this.slotGroupStore.records.each(
                    function (rec) {
                        var k = rec.color;
                        if (!k) {
                            return
                        }
                        var csscolor = (k.length == 6 && /^[0-9A-F]+$/i.test(k)) ? ("#" + k) : k
                        try{
                            $d.css.addRule(".group-color-" + rec.id, "background-color:" + csscolor + ";")
                        } catch(e){
                            console.log("arror while adding rule",".group-color-" + rec.id, "background-color:" + csscolor + ";")
                        }

                    }
                )
            }
            if (!dom.q(".slot-list")) {
                dom.append("<div class='slot-list'></div>")
            }
            //for simplicity resolve template simplified
            //var vars=template.match(/\$\w+/g).map(function(a){return a.substr(1)}),ln=vars.length
            //if(!templatefn){templatefn=$.template(template)}
            var listel=dom.el.querySelector(".slot-list");
            if(listel ){
                var chk=listel.offsetHeight,el=listel

                var cntnt=store.getList().map(function(rec,idx){
                    //rec.index=idx;
                    //return templatefn(rec)
                    return template.replace(/\$(\w+)/g,function(a,b){return (b=="index"?idx:rec.get(b))||""})
                }).join("")
                el.innerHTML=cntnt||"";


el.classList.add("_rendered")
            }


            if (!this.reservedate) {
                this.reservedate = $.date(new Date())
            }
            if (!this.reservedateEnd) {
                this.reservedateEnd = $.date(+this.reservedate).plus("h",1)
            }
            this.redrawHeader()
            var ths = this

            $d.on(listel,"click.slot", function (ev) {
                    var dl = $d.selfOrUp(ev.target, ".parking-slot")
                var store = ths.slotstore
                    if (dl) {
                        var id = dl.domdata("key");
                        var rec = store.records.find(function(r){return r.slotid == id});
                        if (rec) {
                            var model=new SlotModel({record:rec,el:dl})
                            ths.slotClicked(model)
                        }
                    }
                /*var dl = $d.selfOrUp(ev.target, ".parking-slot")
                if (dl) {
                    var id = dl.domdata("key");
                    var rec = store.records.findById(id)
                    if (rec) {
                        if (rec.resstatus == 1) {
                            rec.resstatus = 2
                        }
                        else {
                            rec.resstatus = 1;
                        }
                        ths.redraw(rec)
                        //$.webSocket.dispatch("assignslot" ,{slotid:id,currentstate:rec.currentstate})
                    }
                }*/
            });
            if(this.current){
                this.selectSlot(this.current)
            }
            this.updateTs()

            this.observer.fireAsync("slotsrendered")

        },
        refreshGroupList: function (andredraw) {
            if (this.slotGroupStore) {
                var pr = this.slotGroupStore.load()
                if (andredraw) {
                    pr.then(function () {
                        this.renderSlots();
                    }.bind(this))
                }
            }
        },

        slotClicked:function(slotrec){
            this.fire("slotpointerselection",slotrec)
        },
        loadData:function(date,dateto,callback) {
            if(typeof(date)=="function"){callback=date;date=null;dateto=null;}
            if(date){this.reservedate = $.date(date);
                this.reservedateEnd =null;
            }
            dateto && (this.reservedateEnd = $.date(dateto));
            if (this.reservedate  && !this.reservedateEnd) {
                this.reservedateEnd=$.date(+this.reservedate).plus("h",1)
            }
            var pr=Promise.deferred();
            if (typeof(callback) != "function") {
                pr.then(callback);
            }
            if (this.slotstore && this.reservedate && this.reservedateEnd && this.facility_id){
                var ths=this,d1=+this.reservedate, d2=+this.reservedateEnd;
                this.slotstore.loadData(this.facility_id, +this.reservedate, +this.reservedateEnd).then(
                    function (store) {
                        if(store.records.length){
                            pr.resolve(store)
                            ths.last_refreshed=+(new Date())
                        } else{
                            pr.reject( )
                        }

                    }
                );
            } else {pr.reject( )}
            return pr
        },
        refreshView:function(){
            this.fire("refresh")
        },
        selectSlot:function(slotid){
            var rec=this.getSlotRecord(slotid)
            //if(rec){this.redraw(rec)}
            if(!this.el.q(".parking-slot")){return}
            this.el.qq(".parking-slot.selected").removeClass("selected")
            var sel=this.el.q(".parking-slot[data-key='"+slotid+"']")
            if(sel){sel.addClass("selected");
                var st=sel.el.parentNode.scrollTop,diff=sel.el.offsetTop-st
                if(diff < 0){
                    sel.el.parentNode.scrollTop = st + diff
                } else if(diff>sel.el.parentNode.clientHeight){
                    sel.el.parentNode.scrollTop = st + (diff-sel.el.parentNode.clientHeight)
                }

            }

        },
        setup: function (store,container) {
            if(store){
                this.slotstore = store
            }
            if(container && $d(container)){
                if(!$d(container).contains(this.el)){
                    this._issetup=null
                }

            }
            if(this._issetup){
                this.renderSlots();
                return;
            }
            store=this.slotstore;
            store.dataRecordPrototype.updateState = function (nustate) {
                if (nustate !== this._state) {
                    this.resstatus = nustate
                }
            }
            store.dataRecordPrototype.render = function (tmplate) {
                tmplate = tmplate || this.template
                if (tmplate) {
                    return tmplate(this)
                }
                return ""
            }
            var ths = this, slots = this.el
            store.on("data", function (ev) {
                if (ev.action == "value" && ev.record && ev.datarecord) {
                    if (ev.datarecord.name == "slot_status" || ev.datarecord.name == "resstatus") {
                        ths.redraw(ev.record)
                    }

                }
            });

            //store.records = store.records.chainable()

            this.onpropertychange("slotGroupStore", function (rec) {
                this.renderSlots()
            });
            this.properties.set("slotgroup", 0);
            this.onpropertychange("slotgroup", function (rec) {
                if (rec.oldValue == null) {
                    return
                }
                this.renderSlots()
            });


             app.getEntity("slot_group").then(function (ent) {
                var store = ent.createStore();
                   store.defaultCriteria = "facility_id=" + app.user.facility.id
                store.load().then(
                    function () {
                        ths.slotGroupStore = store;
                        ths.setGroupList()
                    }
                );

            });
            this._issetup=true;
            this.el.html(
                "<div class='slot-stats'>" +
                    "<div class='slot-stats-hdr'></div>" +

                    "<div class='slot-stats-filter'>" +
                        "<div class='status-list-wrap'>" +
                            "<span  class='status-item selected' data-key=''>All</span>" +
                            "<span  class='status-item status-item-av'  data-key='av'>Available</span>" +
                            "<span   data-key='notav' class='status-item status-item-notav'>Occupied</span>" +
                            "<span  class='status-item status-item-recent' data-key='recent'>Recent</span>" +
                        "</div>" +
                        "<div class='group-list-wrap'>Zone:<select class='group-list'></select></div>" +
                    "</div>" +
                    "<div  class='refresh-list'><span  class='refresh-list-icon'></span><span  class='refresh-list-message'>last refreshed<br/>just now ..</span></div>" +

                "</div>" +
                "<div class='slot-list'></div>"
            )
            if(container){
               $d.addClass(container,"slot-view")
               this.appendTo(container);
                 var statuslist=this.el.q(".status-list-wrap")
                  if(statuslist){
                        statuslist.on("click.statuslist",function(ev,el) {
                                 ths.statusfilter = el.domdata("key")
                            }
                        ,{selector:".status-item"})

                        this.el.q(".refresh-list").on("click.statuslist",function(ev) {
                            ths.refreshView();
                        })
                      this.el.qq(".top-right-cancel").on("click.cancel",function(ev) {
                          ths.observer.fire("cancelled");
                      })
                  }


            }
        }

    }
)
var cachedMap={}
SlotView.slotSelector=function(optns,callback){
    //time_from,time_to,facility_id,slotstore,curr_sel
    if(typeof(optns.callback)=="function"){callback=optns.callback}
    var slotView,id=optns.id||"slotselector"
    if(cachedMap[id]){
        slotView=cachedMap[id];
    } else{
        slotView=new SlotView();
        cachedMap[id]=slotView;
    }

    slotView.reservedate=optns.time_from;
    slotView.reservedateEnd=optns.time_to;
    slotView.facility_id= optns.facility_id;
    slotView.slotstore=optns.slotstore

    var curr=optns.current,selcallback=callback
    slotView.current=curr
    if(optns.container){
        var cntnr=optns.container
        slotView._container=cntnr;
        slotView.loadData().then(
            function(store){
                var dorender;
                slotView.setup(store,cntnr)
                slotView.show();
                slotView.el.css("height",cntnr.height()-10);
                //slotView.statusfilter="av"
                if(curr){
                    slotView.on("slotsrendered",function(){
                        this.selectSlot(curr)
                    },{once:true});
                }
            },
            function(){
                //rejected
            }
        )
    } else{
        slotView.on("slotsrendered",function(){
            this.selectSlot(curr)
        },{once:true});

        slotView.show();
    }
     slotView.on("slotpointerselection",selcallback,{once:true});

    return slotView;
}


module.exports=SlotView
}
__bootstrap__.modules["models/AddressModel"] = function(module){
/**
 * Created by Atul on 8/4/2015.
 */
var addressparts = {
	"street_number": "street_number",
	"streetnumber": "street_number",

	"street": "street",
	"streetaddress": "street",
	"route": "street",
	"point_of_interest":"street",

	"neighborhood": "neighborhood",
	"borrough": "borrough",
	"sublocality_level_1": "borrough",

	"city": "city",
	"locality": "city",
	"adminname1": "city",
	"county": "county",
	"administrative_area_level_2": "county",
	"addressstate": "addressstate",
	"administrative_area_level_1": "addressstate",
	"adminname2": "addressstate",
	"state": "addressstate",
	"country": "country",
	"political": "country",
	"countrycode": "country",
	"zip": "zip",
	"zipcode": "zip",
	"postalcode": "zip",
	"postal_code": "zip"
}
var AddressModel= $.simpleModel.make(null, {
		address:null,
		formattedaddress:null,
		"street_number":null,
		"street":null,
		"neighborhood":null,
		"borrough":null,
		"city":null,
		county:null,
		addressstate:null,
		country:null,
		zip:null,
		streetaddress: {descriptor: true, expr: "$street_number $street"},
		citystate: {descriptor: true, expr: "$city $addressstate $zip"},
		resolvedAddress:null
	}
);
AddressModel.ADDRESSPARTS=addressparts
/**
 * Description
 * @method parse
 * @param {} address
 * @return nu
 */
AddressModel.parse=function(address){
	var add={} ;

	if(address !== undefined){
 		$.each(addressparts,function(alias,name){
			add[alias]=null ;
		},this)

	} else if(address instanceof AddressModel){
		return address
	}
	var addressdata
	addressdata=address
	if(addressdata && typeof(addressdata)=="object" && "address" in addressdata){addressdata=addressdata.address}
	if(typeof(addressdata)=="string"){
		add.formattedaddress=addressdata
		var parts1=addressdata.split(/\s+/),last,counter=0
		if ((last = parts1[parts1.length - 1]) && last.length >= 5 && /^[\d]+(\-[\d]+)?$/.test(last)) {
			add.zip = parts1.pop()
			addressdata=parts1.join(" ");
		}


		parts1=addressdata.split(/\s*,\s*/)
		while(parts1.length && counter<10) {
			counter++
			if (!add.zip && (last = parts1[parts1.length - 1]) && last.length >= 6 && /^[\d]+(\-[\d]+)?$/.test(last)) {
				add.zip = parts1.pop()
			}
			if (!add.country && (last = parts1[parts1.length - 1]) && (last.toLowerCase() === "us" || last.toLowerCase() === "usa" || last.toLowerCase() === "united states")) {
				add.country = parts1.pop()
			}
			if (!add.addressstate && (last = parts1[parts1.length - 1]) && (last.toLowerCase() === "ny" || last.toLowerCase() === "new york")) {
				add.addressstate = parts1.pop()
			}
			if (!add.city && (last = parts1[parts1.length - 1]) && (last.toLowerCase() === "nyc" || last.toLowerCase() === "new york city")) {
				add.city = parts1.pop()
			}
			if (!add.street && (last = parts1[parts1.length - 1]) && (/\bst\b/.test(last.toLowerCase()) || /\bstreet\b/.test(last.toLowerCase()) || (/\bav\b/.test(last.toLowerCase())) || (/\bave\b/.test(last.toLowerCase())) || (/\bavenue\b/.test(last.toLowerCase())))) {
				add.street = parts1.pop()
				if (/^\d+\D/.test(add.street)) {
					add.streetnumber = add.street.match(/^\d+\D/)[0].trim()
				}
			}
		}
		if (parts1.length==1 && !add.street) {
			add.street = parts1.shift()
		}
		if(parts1.length){
			var parts=parts1;
			if(parts.length && !add.street){add.street=parts.shift();}
			if(parts.length && !add.city){add.city=parts.shift();}
			if(parts.length && !add.country){add.country=parts.shift();}
			if(parts.length && !add.addressstate){add.addressstate=parts.shift();}
			if(add.addressstate && !add.zip){
				add.addressstate=(add.addressstate+" ").replace(/\s+([\d\-]+)\s+/,function(a,b){
					add.zip=b;return"";
				}).trim()
			};
		}

	} else if($.isPlain(addressdata)){
		add.formattedaddress=addressdata.formattedaddress
		if(addressdata.address && $.isPlain(addressdata.address)){
			add.formattedaddress=add.formattedaddress||addressdata.address.formattedaddress
			addressdata=addressdata.address
		}
		$.each(addressparts,function(name,alias){
			if(!add[name] && alias && addressdata[alias]){
				add[name]= addressdata[alias]
			}
		});

	}
	 if(!add.formattedaddress && add.street){
		 add.formattedaddress=[add.street,add.city,add.addressstate,add.country,add.zip].filter(function(a){return (a||"").trim()}).join(", ");
	 }
	var nu=new AddressModel(add);
	nu.recalcAll();
	return nu;
}
module.exports=AddressModel
}
__bootstrap__.modules["models/ContactusModel"] = function(module){
/**
 * Created by Atul on 9/17/2015.
 */
var ContactusModel=$.model.make("ContactusModel", {
	contactphone:null

})

module.exports=ContactusModel;
}
__bootstrap__.modules["models/ExtraModel"] = function(module){
var map={
	0:"Pending",
	1:"Processing",
	2:"Completed",
	3:"Cancelled"
}
var ExtraModel=$.model.make("ExtraModel", {
	reserve_id:null,
	id:null,
	name:null,
	price:null,
	status:null,
	statusstring:{
		descriptor:true,
		/**
		 * Description
		 * @method expr
		 * @param {} rec
		 * @return LogicalExpression
		 */
		expr:function(rec){
			return map[rec.status]||""
		},vars:["status"]
	}
})
ExtraModel.statusLookup=map
module.exports=ExtraModel;
}
__bootstrap__.modules["models/ExtrasModel"] = function(module){
var stores=$.require("common/Appstores")
var ExtraModel=$.require("models/ExtraModel")
var extraServiceTemplate="<li class='srvc-item' data-key='$id'><span class='srvc-name'>$name</span><span class='srvc-price'>$price</span><span class='srvc-status-string'>$statusstring</span><span class='srvc-cancel'>Cancel</span></li>"
var extraServiceTemplateWithStatus="<li class='srvc-item' data-key='$id'><span class='srvc-name'>$name</span><div class='srvc-status $statusstring'>#statuslist</div></li>"
var PopupView =$.require("PopupView")


var ExtrasModel=$.model.make("ExtrasModel", {
	extras:null,
	parseStr:null,
	reserve_id:null,
	facility_id:null

},{
	/**
	 * Description
	 * @method getAll
	 * @param {} callback
	 * @param {} reset
	 * @return MemberExpression
	 */
	getAll:function(callback,reset){
		if(typeof(callback)=="function" && this.extrasStore){
			callback(this.extrasStore)
			return this._storePromise;
		}
		if(!this._storePromise) {
			this._storePromise = Promise.deferred()

				this.onchange("facility_id",
				function(){
					stores.getExtrasStore(function (store) {
						store.clear();
 						store.load({facility_id: this.facility_id}).then(function () {
							this.extrasStore = store;
							this._storePromise.resolve(store)
						}.bind(this))
					}.bind(this))
				}
			);
		}
		if(typeof(callback)=="function"){
			this._storePromise.then(callback)
		}
		return this._storePromise;
	},
	/**
	 * Description
	 * @method parse
	 * @param {} arr
	 * @return 
	 */
	parse:function(arr){
		var extras=[]
		if(typeof(arr)=="string"){
			arr=arr.split(",")
		}
		this.parseStr=arr;
		if(Array.isArray(arr) && arr.length){
			var list=arr.slice()
			while(list.length){
				var a=list.shift().split(/\|/);
				extras.push(new ExtraModel({reserve_id:this.reserve_id,id:a[0],name:a[1],price:Number(a[2])||0,status:Number(a[3])||0}))
			}

		}
		this.extras=extras
	},
	/**
	 * Description
	 * @method removeExtra
	 * @param {} id
	 * @param {} callback
	 * @return 
	 */
	removeExtra:function(id,callback){
		app.remoteDirective("removeextra",{id:id}).then(function(rec){
			app.splash("Service removed" )
			var rec=this.extras.find(function(a){return a.id==id})
			if(rec){
				this.extras.splice(this.extras.indexOf(rec),1)
				this.firePropertyChangeEv("extras")
			}
			typeof(callback)=="function" && callback(rec)
		}.bind(this)
		)
	},
	/**
	 * Description
	 * @method addExtra
	 * @param {} extra_id
	 * @return pr
	 */
	addExtra:function(extra_id){
		if(!extra_id){return }
		var pr=Promise.deferred()
		this.getAll(function(store){
			//if(this.extras && this.extras.some(function(a){return }))
 			app.remoteDirective("addextra",{extra_id:extra_id,reserve_id:this.reserve_id}).then(function(rec){if(!rec){return}
			    if(rec.error){
				    app.splashError(rec.error)
				    return
			    }
				app.splash("Service added" )
  			    var nu=new ExtraModel({reserve_id:this.reserve_id,id:rec.id,name:rec.name,price:rec.price,status:1});
				this.extras.push(nu)
			    this.firePropertyChangeEv("extras")
			    pr.resolve(nu)
			}.bind(this),function(e){
				app.splash("<div style='color:red;'>Error</div>"+ e )
			})

		}.bind(this))
		return pr
	},
	/**
	 * Description
	 * @method init
	 * @return 
	 */
	init:function(){
		this.extras=[]
		this.reserve_id||(this.reserve_id=0);
	},
	/**
	 * Description
	 * @method getListContent
	 * @param {} container
	 * @param {} link
	 * @param {} store
	 * @param {} callback
	 * @return CallExpression
	 */
	getListContent:function showExtrasPopup(container,link,store,callback ){
		if(typeof(extraServiceTemplate)=="string"){extraServiceTemplate=$.template(extraServiceTemplate)}
		return this.extras.map(function(rec){
			return extraServiceTemplate(rec)
		}).join("")
	},

	/**
	 * Description
	 * @method showInlinePopup
	 * @param {} container
	 * @param {} link
	 * @param {} callback
	 * @return 
	 */
	showInlinePopup:function showExtrasPopup(container,link ,callback){
		this.getAll(function(store){
			var extras=store.records,model=this
 			//if(!this.popupView){this.setUpPopup(container,link ,store.records,callback)}
			 if(!this.popupView) {
				 var list = extras.filter(function (it) {
					 return it && it.id && it.name
				 })

				 if (!(list && list.length)) {
					 list = [{id: "", label: "None available"}]
				 }

				 this.popupView = PopupView.lookupList(list, {
					 container: container,destroyonhide:false,
					 keyName: "id",  labelName: "name",
					 anchor: link,
					 callback: function(extra){
						 if(!extra || !extra.id){return}
 						 this.addExtra(extra.id).then(callback)
					 }.bind(this)
				 })
			 }
 		    this.popupView.show();

		}.bind(this))

	},
	/**
	 * Description
	 * @method showListWithStatus
	 * @param {} container
	 * @param {} callback
	 * @return 
	 */
	showListWithStatus:function showListWithStatus(container ,callback){
		if(typeof(extraServiceTemplateWithStatus)=="string"){
			extraServiceTemplateWithStatus=extraServiceTemplateWithStatus.replace(/#statuslist/,Object.keys(ExtraModel.statusLookup).map(function(k){
				var nm=ExtraModel.statusLookup[k];
				return "<span data-key='"+k+"' class='srvc-status-item srvc-status-"+ nm.toLowerCase()+"'>"+nm+"</span>"
			}).join(""))
			extraServiceTemplateWithStatus=$.template(extraServiceTemplateWithStatus)
		}
		var listcontainer=$d(container)
		var  ths=this
		this.onchange("extras",function(a){
			if(!listcontainer){return}
			var extras=this.extras||[]
 			listcontainer.html(
				extras.map(function (it) {
					return extraServiceTemplateWithStatus(it)
				}).join("")||"No tasks found"
			);
			var items=listcontainer.qq(".srvc-item")
			extras.forEach(function (it,i) {
 				var nm=String(it.statusstring).toLowerCase();
				items[i] && items[i].qq(".srvc-status-"+ nm).addClass("current")
			})
		})


		listcontainer && listcontainer.on("click",function(ev,el){
			var li=el.up("li"),status=el.domdata("key");
			var extras=this.extras
 			if(!(li && li.domdata("key"))){return}
			var id=li.domdata("key")
			var extra=extras.find(function(a){return a.id==id})
			if(!extra){return}
				app.remoteDirective("updateextra",{id:id,status:status}).then(function(rec){
                        var rec=this.extras.find(function(a){return a.id==id})

 						typeof(callback)=="function" && callback(rec)
						this.firePropertyChangeEv("extras")
					}.bind(ths)
				)
				extra.status=Number(status)||0
			el.up().qq(".current").removeClass("current")
			el.addClass("current")

		}.bind(this)   ,{selector:".srvc-status-item"})

	}

});

//5|Car Wash|10.50|1
module.exports=ExtrasModel;
}
__bootstrap__.modules["models/FacilityModel"] = function(module){
var _facModel =  new $.simpleModel({record:null});
var props={}
"id name lat lng address rating operator_id sat_sun monthly weekly halfhour hour_1 hour_2 hour_10 hour_24 early_bird evening operator locname oversize_addtnl spaces_total phone  region_id".split(/\s+/).forEach(
	function(k){
		props[k]={descriptor:true,delegatedTo:"record"}
	}
);
_facModel.addProperties(props);
_facModel.addExpr("picurl",function(rec){
	if(rec.location_id>1){
		return rec.asset_thumbs
	}
	return "http://parcmate.com/pmr/fi/"+rec.id+".png"
	/* var url=rec.asset_thumbs
	 if(!url){return FACILITY_URL_DEFAULT}
	 url=String(url).replace(/^http:\/\//,"")
	 if(url.indexOf("s3")==0){return "http://"+url}
	 return FACILITY_URL_PREFIX+url*/
},{vars:["asset_thumbs"]});

var FacilityModel= _facModel.asCtor();
/**
 * Description
 * @method initModelInstance
 * @return 
 */
FacilityModel.prototype.initModelInstance=function(){
	this.onchange("record",function(rec){
		if(this.__triggering||!rec.value){return}
		this.dataAvailable()
		this.__triggering=true;
		this.trigger("*");                //this.update(rec.value)
		this.__triggering=false;
	})
}
module.exports=FacilityModel;
}
__bootstrap__.modules["models/PriceModel"] = function(module){
var alias={
        "scheduled_duration":"duration",
        date_from:"reserveDateTime",
        time_from:"reserveDateTime",
        reserveDate1:"reserveDateTime",
        reserveTime1:"reserveDateTime",
        duration_type:"durationType",
        vehicle_type:"vehicleType"

    },
    _linkedfields="duration durationType tip extra1 extra2".split(" "),
    _ignorefields="reserveDate reserveTime".split(" ")
function _formatNum(num){
    return (num && !isNaN(num)) ?+((Math.round(Number(num)*100)/100).toFixed(2).replace(/\.00$/,"")):0

}
var PriceModel=$.model.make("RatesModel", {
    shared_data:null,
    isactualPricing:null,
     amount:{descriptor:true,type:"currency",defaultValue:0},
    tax:{descriptor:true,type:"currency"},
    schedule:null,
    facility:null,
    vehicle:null,
    selectedField:null,
     rateDescription:null,
    computedrate:null,
    needsrecalc:null,
      /*tip:{descriptor:true,type:"string"},
    duration:null,
    durationType:null,
    reserveDate:null,
    reserveTime:null,*/
    vehicleType:null,
    extratotal:{descriptor:true,type:"currency",
/**
 * Description
 * @method expr
 * @param {} rec
 * @return Literal
 */
expr:function(rec){
        if(rec.extraServices && rec.extraServices.extras){
             return rec.extraServices.extras.reduce(function(m,a){return a?(m + (a.price||0)):m},0)
        }
        return 0
    },vars:["extraServices"]
    },
    calctip:{descriptor:true,
/**
 * Description
 * @method expr
 * @param {} rec
 * @return Literal
 */
expr:function(rec){
        var Sch=rec.schedule
        if(Sch &&  Sch.tip){
            return _formatNum(this.computeTip(rec.computedrate,Sch.tip))
         }
        return 0
    },vars:["computedrate","tip"]
    },
    calcprice:{descriptor:true,
/**
 * Description
 * @method expr
 * @param {} rec
 * @return CallExpression
 */
expr:function(rec){
             return _formatNum(rec.computePrice(rec.schedule,rec.facility,rec.vehicle))
        },
        vars:[ "needsrecalc","calctip","extratotal" ]
    },
    calcraterounded:{descriptor:true, 
/**
  * Description
  * @method expr
  * @param {} rec
  * @return LogicalExpression
  */
 expr:function(rec) {
        return rec.computeRate(rec.schedule,rec.facility,rec.vehicle,true)  || 0
    },vars:[ "calcrate"]},
    calcrate:{descriptor:true, 
/**
  * Description
  * @method expr
  * @param {} rec
  * @return CallExpression
  */
 expr:function(rec){
        return _formatNum(rec.computeRate(rec.schedule,rec.facility,rec.vehicle))
    }
        ,vars:["vv"],vars1:[ "manualprice", "schedule","facility" ]
    }
},{
    /**
     * Description
     * @method init
     * @return 
     */
    init:function(){   },
    /**
     * Description
     * @method computePrice
     * @param {} schedule
     * @param {} facility
     * @param {} vehicle
     * @param {} forsecalc
     * @return UnaryExpression
     */
    computePrice:function(schedule,facility,vehicle,forsecalc){
        if(!schedule){return 0}
        if(forsecalc===true){this.needsrecalc=true}
         var  rate=((this.needsrecalc||this.needsrecalc==null)?Number(this.computeRate(schedule,facility,vehicle)):this.computedrate)||0,tip=this.computeTip(rate, (schedule||{}).tip )||0 ,
            extratotal=Number(this.extratotal)||0 ;
         return +((Number(rate+tip+extratotal )||0).toFixed(2))
    },
    /**
     * Description
     * @method computeTip
     * @param {} calcrate
     * @param {} tip
     * @return tip
     */
    computeTip:function(calcrate,tip){
        if(!calcrate  || !tip){return 0}
        var rate=calcrate||0,tip=String(tip||0);
        if(tip.indexOf('%')>0){
            tip=((Number(tip.replace(/%$/,"").trim())||0)/100)*rate;
        } else {
            tip=Number(tip)||0
        }

        return tip
    },
    _computeRate:function(schedule,facility,vehicle,rounded){
        var rec=this,descript=[]
        if(!schedule && this.shared_data && this.shared_data.schedule){
            schedule=this.shared_data.schedule
        }
        if(!vehicle && this.shared_data && this.shared_data.vehicle){
            vehicle=this.shared_data.vehicle
        }
        if(!(facility && schedule)){return 0}

        var fld="",Fac=facility,Sch=schedule||{},hours= 1,duration=Sch.duration ,typ=Sch.durationType ,date=Sch.reserveDateTime//,range=Sch.getTimeRange(true)
        if(!date || !typ || !duration){return 0}
        var days= 0,toadd= 0, ret= 0,duration=Sch.duration|| 1//range.getDurationInHours();
        if(duration<1){
            duration=.5
        } else {
            duration=Math.ceil(duration)
        }
        if(typ=="h" && Sch.exit_time && (+Sch.exit_time)>100 && (+Sch.entry_time)>100){
            duration=((+Sch.exit_time) - (+Sch.entry_time))/(1000*60*60 )
            if(duration < .3){
                duration=.5

            } else {
                duration=Math.ceil(duration)
            }
        } else {
            if(duration <= .5){
                duration=.5

            }
        }
        /*if(Fac.sat_sun && range.start.isWeekEnd() && range.end.isWeekEnd()){
            fld = "sat_sun"
        }
         */
        if(typ=="h" && duration >= 25){
            days=Math.floor(duration/24)
            toadd=(Fac["hour_24"]||0)*(days)
            date=$.date(date).clone().plus("d",days)
            duration=duration - (24*days)
            days>0 && toadd && descript.push(days+" day(s): $"+_formatNum(toadd))
        }
        if(typ=="m"){
            fld = "monthly"
        }
        else if(typ=="w"){
            ret = (Fac.weekly||0)*duration
            descript.push("Weekly:$"+_formatNum(ret))
        }
        else if(typ=="d"){
            ret = (Fac.hour_24||0)*(duration)
            descript.push("Dauly:$"+_formatNum(ret))
        } else if(duration<=.5){
            fld = "halfhour";
        } else{
            if(duration<=1){hours=1}
            else if(duration<=2){hours=2}
            else if(duration<=10){hours=10}
            else if(duration<=24){hours=24}
            fld="hour_"+hours;
        }
        if(fld){
            ret=Number(Fac[fld])||0
            if(ret <=0){
                return 0
            }
            descript.push(String(fld).replace(/hour_(\d+)/,"$1 hour(s)") +": $"+ret)
        }
        var str=""

        var fin=toadd+ret
        str=str+String(fld).replace(/hour_(\d+)/,": $1 hour(s)") +"$"+fin
        if(vehicle && vehicle.isOverSize && vehicle.isOverSize() && Fac.oversize_addtnl){
            fin= fin+(Fac.oversize_addtnl||0)
            descript.push("Oversize Additional" +": $"+(Fac.oversize_addtnl||0))
        }
        if(typeof(fin)=="number" && fin - Math.floor(fin)>0){fin=Number(fin.toFixed(2))}
        return {
            amount:fin,
            multiday:days,
            selectedField:fld,
            rateDescription:descript.join("\n")
        };

    },
    /**
     * Description
     * @method bindToSchedule
     * @param {} schedule
     * @return 
     */
    bindToSchedule:function( schedule){
        if(!schedule){return}
         if( schedule && this.__boundto != schedule.UUID()){
            this.__boundto =  schedule.UUID()
             schedule.onchange("duration durationType reserveDateTime entry_time  exit_time tip",function(rec){
                 if(rec.name=="tip"){
                     this.getDescriptor("calcprice").calc(this);
                 } else{
                     this.recalc()
                 }

            }.bind(this))
        }


    },
    /**
     * Description
     * @method computeRate
     * @param {} schedule
     * @param {} facility
     * @param {} vehicle
     * @param {} rounded
     * @return MemberExpression
     */
    computeRate:function(schedule,facility,vehicle,rounded){
        var res=this._computeRate(schedule,facility,vehicle)
        if(!res){return 0}
         this.multiday=res.multiday
        this.selectedField=res.selectedField
        this.rateDescription=res.rateDescription
        this.needsrecalc=0;
        this.computedrate=res.amount
        if(rounded===true){
            return Math.round(Number(res.amount)||0)
        }
        return res.amount
    },
    /**
     * Description
     * @method recalc
     * @param {} mod
     * @return 
     */
    recalc:function(mod){
        if(!this.__throttledrecalc){
            this.__throttledrecalc= $.throttle(function(mod){
                 if(mod=="tip"){
                    this.getDescriptor("calctip").calc(this);
                } else{
                    this.needsrecalc=1
                }
             },{tailEnd:true});
        }

       //this.__throttledrecalc(mod);
        if(mod=="tip"){
            this.getDescriptor("calctip").calc(this);
        } else{
            this.needsrecalc=1
        }
       return
    },
    /**
     * Description
     * @method recalcAll
     * @return CallExpression
     */
    recalcAll:function(){
        return this.recalc()

        var calcrate=this.getDescriptor("calcrate")
        calcrate.calc(this)
        var calctip=this.getDescriptor("calctip")
        calctip.calc(this)
    },
    /**
     * Description
     * @method calcAdditional
     * @param {} calcrate
     * @param {} sch
     * @return BinaryExpression
     */
    calcAdditional:function(calcrate,sch){
        if(calcrate!=null && sch){
            return this.extratotal + this.computeTip(calcrate,sch.tip)
        }
        return this.extratotal + this.calctip
    },
    /**
     * Description
     * @method getPriceSheet
     * @return CallExpression
     */
    getPriceSheet:function(){
        return this.toMap()

    },
    /**
     * Description
     * @method readRecord
     * @param {} data
     * @return 
     */
    readRecord:function(data ){

    }
});
module.exports=PriceModel;
}
__bootstrap__.modules["models/RatesModel"] = function(module){
var RatesModel=$.model.make("RatesModel", {
    amount:null,
    tips:null,
    tax:null


});
module.exports=RatesModel;
}
__bootstrap__.modules["models/ReserveModel"] = function(module){
var dateformat="ddd, mmm dd yyyy", timeformat="hh:nn tt"
var ScheduleModel= $.require("models/ScheduleModel")
var VehicleModel= $.require("models/VehicleModel")
var Utils=$.require("common/AppUtil")
var stores=$.require("common/Appstores")
var utils=$.require("common/AppUtil")
var UserModel=$.require("models/UserModel");
var ReserveSlotModel=$.require("models/ReserveSlotModel");
var ExtrasModel=$.require("models/ExtrasModel")
var ReserveTaskList=$.require("models/ReserveTaskList")
var app=$.require("app");
var PriceModel=$.require("models/PriceModel")
var FacilityModel=$.require("models/FacilityModel")
var PopupView=$.require("PopupView");

var ReserveModel=$.model.make("ReserveModel", {
        record:null,
        reserveInfo:null,
        memo:null,
        manualprice:null,
        facility_id:null,
        operatorname:null,
        locaddress:null,
        facilityname:null,
        reservenum:null,
        resstatus:null,
        slot_status:null,
        reserve_id:null,
        multientry:null,
        resstatusString:null,
        iswalkin:null,
        nonmember_id:null,
        isNonMember:null,
        reservenumlabel:null,
        amount:null,
        tip:null,
        computedCost:null,
        pricing:null,
        schedule:null,
        facility:null,
        operator:null,
        userVehicle:null,
        user:null,
        reserveSlot:null,
        userOptions:null,
        extraServices:null,
        reserveTaskList:null,
        updatingrates:null,
        rateversion:null,
        reservecost:null,
        reserveprice:null,
        calctip:null,

        extratotal:{
            descriptor:true,type:"currency",
            expr:function(rec){
                if(rec.extraServices && rec.extraServices.extras){
                    return rec.extraServices.extras.reduce(function(m,a){return a?(m + (a.price||0)):m},0)
                }
                return 0
            },vars:["extraServices"]
        },
        allresolved:null
    },

    {
        /**
         * Description
         * @method init
         * @return
         */
        init:function( ){
            //this.extraServices=List.create(["aaa","vvv"]);

            this.initReserveModel();
        },
        initReserveModel:function(){
            if(!this.schedule){
                this.schedule=new ScheduleModel( );
            } else{
            }
            this.rateversion=0;

            // this.pricing=this.schedule.pricing;
            this.user=this.user|| new UserModel();

            this.facility=this.facility||new FacilityModel();
            //this.facility.delegateTo("record",null,{writable:false})
            this.operator=this.operator||$.model.from({operator_id:0,name:""})
            this.userVehicle=this.userVehicle||new VehicleModel();
            this.reserveSlot=this.reserveSlot||new ReserveSlotModel()
            this.extraServices=this.extraServices||new ExtrasModel()
            this.reserveTaskList=this.reserveTaskList||new ReserveTaskList()
            this.pricing=this.pricing||new PriceModel()

            this.setupEvents();
        },
        setupEvents:function(){
            //if(this.__setupEventsdone){return}
            this.__setupEventsdone=true
            this.onchange("record",function(rec){
                this.readRecord(rec.value);
            });
            this.facility.whenDataAvailable(function(rec){
                if(rec && rec.hour_1) {
                    this.readFacilityRecord(rec);
                }

            }.bind(this))
            this.onchange("resstatus",function(rec){
                this.resstatusString=utils.getStatusString(rec.value);
            });



        },
        onPriceUpdate:function(data){
            if(!this.pricingdata){this.pricingdata={data:{}}}
            if(data && data.rate ){
                this.pricingdata.computed=data
                this.reservecost=this.pricingdata.computed.rate
                this.reserveprice=(this.pricingdata.computed.price||this.pricingdata.computed.rate);
                this.calctip=this.pricingdata.computed.calctip
                this.rateversion++;
            }
        },
        refreshPrcingData:function(){
            if(!this.pricingdata){this.pricingdata={data:{}}}
            var facility_id=this.facility_id
            if(!facility_id && this.facility){
                facility_id=this.facility.id
            }
            if(!facility_id){
                return
            }
            var nudata={
                facility_id:facility_id,
                starttime:+this.schedule.reserveDateTime,
                vehicle_type:this.userVehicle.vehicle_type,
                duration:this.schedule.duration,
                durationType:this.schedule.durationType,
                tips:String(this.tip||"0").replace("%","PERC"),
                extratotal:this.get("extratotal")||"0"
            }
            if(Object.keys(nudata).some(function(a){return !a})){
                console.log("invalid pricing data",nudata)
                return
            }
            var hash=JSON.stringify(nudata).replace(/"/g,"")

            if(this.pricingdata.hash!=hash){
                this.pricingdata.data=nudata;
                this.pricingdata.hash=hash;

                this.pricingdata.pending=true
            }

        },
        bindRecalc:function(doremote){
            this._calcremote=!!doremote;
            if(this.__bindRecalc){return}
            this.__bindRecalc=true;

            var ths=this;
            this.extraServices.onchange("extras",function(rec){
                if(rec.value){
                    this.recalcPrice()
                }
            }.bind(this))
            this.onchange("tip",function(rec){
                if(rec.value==null || this.__holdcalc   ){return}
                this.recalcPrice()
            }.bind(this));

            this.userVehicle.onchange("vehicle_type",function(rec){
                if(!rec.value){return}
                this.recalcPrice()
            }.bind(this));
            this.schedule.onchange("duration durationType reserveDateTime entry_time  exit_time",function(rec){
                if(rec.value==null || this.__holdcalc || this.schedule.__holdcalc ){return}
                this.recalcPrice()
            }.bind(this));
        },
        /**
         * Description
         * @method computeCost
         * @return cost
         */

        computeTip:function(){
            if(this.pricingdata && this.pricingdata.computed){
                return this.pricingdata.computed.calctip||0
            }
            return 0
        },
        calcAdditional:function(){
            if(this.reservecost!=null ){
                return  this.get("extratotal") + this.computeTip()
            }
            return this.get("extratotal") + this.get("calctip")
        },
        afterRecalc:function(fn){
            if(this.pricingdata && !this.pricingdata.pending && this.pricingdata.computed){
                fn.call(this)
            } else {
                this.onchange("rateversion", fn, {once: true, nodefault:true})
            }
            return this;
        },
        recalcPriceRemote: $.throttle(
            function(rounded){
                if(this.__holdcalc || this.schedule.__holdcalc || !(this.pricingdata && this.pricingdata.pending)){return}
                this.computedCost=null

                this.pricingdata.pending=false;
                app.remoteDirective("computeprice",this.pricingdata.data).then(
                    function(data){
                        if(data && data.rate){
                            this.updatingrates=false;
                            this.onPriceUpdate(data);
                        }

                    }.bind(this))
            },
            {tailEnd:true,delay:1000}
        ),
        recalcPrice:function(rounded){
            var callback
            if(typeof(rounded)=="function"){
                callback=rounded
            }

            if((this.__bindRecalc||rounded===true) && !( this.__holdcalc || (this.schedule && this.schedule.__holdcalc)|| this.nocalc)) {
                this.refreshPrcingData()

                if (!this.pricingdata.pending) {
                    if(callback){ callback.call(this) }
                    return
                }

                this.updatingrates = true
                this.recalcPriceRemote(rounded);
            }
            if(callback){
                this.onchange("rateversion", callback, {once: true, nodefault:true})
            }
        },
        /**
         * Description
         * @method setBreakPoints
         * @return
         */
        setBreakPoints:function(){},
        /**
         * Description
         * @method readDataRecord
         * @param {} record
         * @return
         */
        readDataRecord:function(record){
            if(!record){return}
            if(record != this.record){
                this.record=record
            } else {
                this.readRecord(record)
            }
        },
        /**
         * Description
         * @method afterLoad
         * @param {} notallresolved
         * @return
         */
        afterLoad:function(notallresolved){
            this.schedule.setupDates()
            if(this.isCheckedOut()){
                //this.pricing=this.schedule.actualPricing;
            }

            if(notallresolved!==true){
                if(this.user.isNonMember){
                    this.isNonMember=this.user.isNonMember
                }
                this.allresolved=true
            }
            this.recalcPrice();
        },
        /**
         * Description
         * @method copyValues
         * @param {} record
         * @return
         */
        copyValues:function(record){

            this.allresolved=null
            if(!record){return}
            var id=record.reserve_id||record.id
            if(id){
                record._isreserverecord=1
                this.reserve_id=id;
            }
            this.manualprice=record.manualprice
            this.amount=record.amount
            this.facilityname=record.facilityname||record.name
            this.reserveTaskList.reserve_id=this.extraServices.reserve_id=this.reserve_id;
            this.facility_id=this.extraServices.facility_id=this.reserveTaskList.facility_id=record.facility_id;
            if(record.multientry=="null" || record.multientry=="0"){record.multientry=null}
            this.multientry=record.multientry;
            this.reservenumlabel=this.reservenum=record.reservenum||record.reserve_num
            this.resstatus=record.resstatus
            this.resstatusString=record.resstatusString||utils.getStatusString(record.resstatus);
            this.operatorname=record.operatorname
            if(typeof(record.operator)=="string"){
                this.operatorname=record.operator;
            }
            this.slot_status=record.slot_status
            this.locationaddress=record.address
            if(record.address && record.address.address){
                this.locationaddress=record.address.address
            }

            this._originaltip=typeof(record.tip)=="undefined"?record.tip:String(record.tip||"");
            if(record.tip){
                this.set("tip",String(record.tip||""))
            }

        },
        /**
         * Description
         * @method readRecord
         * @param {} record
         * @param {} facility
         * @return allpromise
         */
        readRecord:function(record,facility){
            this.allresolved=null
            if(!record){return Promise.reject()}
            this.__holdcalc=true;
            var promises = [], allpromise
            try {
                if ((record.__model || record.__isModel || record.isModel) && record.schedule) {
                    return this.readModel(record)
                }

                if(record.facility && $.isPlain(record.facility)){
                    facility=record.facility;
                }
                if(facility && facility.id){
                    record.facility_id=facility.id;
                }
                this.copyValues(record)
                if (facility && ($.isPlain(facility) || facility.__record__)) {
                    this.facility.record = facility;
                } else {
                    promises.push(this.syncFacility(record))
                }
                this.extraServices.parse(record.reserve_extra_extras)
                if (record.notifications) {

                }
                this.reserveTaskList.parse(record.notifications)
                promises.push(
                    this.syncUser(record),
                    this.syncVehicle(record),
                    this.syncOperator(record),
                    this.schedule.readRecord(record),
                    this.reserveSlot.readRecord(record)
                )
                promises = promises.filter(function (a) {
                    return a && a.isPromise
                })

                if (promises.length) {
                    allpromise = Promise.all(promises)
                } else {
                    allpromise = Promise.resolve(this)
                }
                if (record.nonmember_id) {
                    this.user.isNonMember = this.isNonMember = true;
                } else {
                    this.user.isNonMember = this.isNonMember = false;
                }

                this.viewmode = "active"
                this.checkinmode = "reservation"
                allpromise.then(this.afterLoad.bind(this),function(){alert("error")})

            } finally{
                this.__holdcalc=false;
            }
            this.afterLoad(true);
            return allpromise
        },
        /**
         * Description
         * @method readModel
         * @param {} model
         * @return allpromise
         */
        readModel:function(model){
            if(!model){return Promise.reject()}
            var promises=[],facpromise=Promise.deferred(),allpromise
            var operator
            this.__holdcalc=true;
            try {
                this.copyValues(model)
                if(model.facility){
                    if($.isPlain(model.facility)){
                        this.facility.record=model.facility;
                        delete model.facility;
                    } else{

                        model.facility.onchange("record",function(rec){
                            if(!rec.value){return}
                            this.facility.record=rec.value
                            this.extraServices.facility_id=rec.value.id
                            this.reserveTaskList.facility_id=rec.value.id
                            if(this.facility.hour_1){
                                facpromise.resolve()
                            } else{
                                this.syncFacility(rec.value.id).then(function(a){
                                    facpromise.resolve(a)
                                })
                            }

                        }.bind(this),{once:true})
                    }
                } else if(model.selectedLocation ){
                    if(model.selectedLocation.facility && model.selectedLocation.facility.record){
                        this.facility.record=model.selectedLocation.facility.record
                        this.facilityname=this.facility.locname
                        facpromise.resolve()
                    } else{
                        facpromise=this.syncFacility(model.selectedLocation.locationid)
                    }

                }
                if(model.operator){operator=model.operator.toMap?model.operator.toMap():model.operator}
                promises=[
                    facpromise,
                    this.schedule.readModel(model.schedule ),
                    model.user?this.user.readRecord(model.user.toMap?model.user.toMap():model.user):null,
                    operator?this.operator.readRecord(operator):null,
                    this.userVehicle.readRecord(model.userVehicle.toMap()),
                    model.reserveSlot?this.reserveSlot.readRecord(model.reserveSlot.toMap()):null
                ].filter(function(a){return a && a.isPromise})


                if(model.extraServices){
                    this.extraServices.parse(model.extraServices.parseStr )
                }
                if(model.reserveTaskList){
                    this.reserveTaskList.parse(model.reserveTaskList.parseStr )
                }
                this.pricing.set("extraServices",this.extraServices)
                //this.schedule.actualpricing.set("extraServices",this.extraServices)

                if(promises.length){
                    allpromise=Promise.all(promises)
                } else{
                    allpromise=Promise.resolve(this)
                }
                allpromise.then(this.afterLoad.bind(this),function(){alert("error")})
            } finally{
                this.__holdcalc=false;
            }
            this.afterLoad(true);
            return allpromise
        },
        /**
         * Description
         * @method syncOperator
         * @param {} record
         * @return CallExpression
         */
        syncOperator:function(record){
            if(!record){return}
            this.allresolved=null
            this.operator.readRecord({id:record.operator_id,name:record.operator_name||record.operator})

            if(( this.operator.id && this.operator.name)) {
                return
            }
            return stores.getOperatorModel(record.operator_id,function(rec){if(!rec){return}
                this.operator.update({id:rec.id,name:rec.name||"-"})
            }.bind(this))

        },
        /**
         * Description
         * @method syncVehicle
         * @param {} record
         * @return CallExpression
         */
        syncVehicle:function(record){
            return this.userVehicle.readRecord(record)
        },
        /**
         * Description
         * @method syncUser
         * @param {} record
         * @return CallExpression
         */
        syncUser:function(record){
            return this.user.readRecord(record);
        },
        /**
         * Description
         * @method syncFacility
         * @param {} facid
         * @return pr
         */
        syncFacility:function(facid){
            var rec
            if(facid && typeof(facid)=="object"){
                rec=facid;
                facid=rec.facility_id
                if(facid){
                    this.facility.record={id:facid,name:rec.name,address:rec.address,operator_id:rec.operator_id}
                }
            } else{
                if(!Number(facid)){facid=0}
                var pr,curr=(this.facility.record||{}).id
                if(!facid){
                    facid=curr||this.facility_id
                }

            }
            if(!facid){return}
            this.facility_id=facid;
            this.extraServices.facility_id=facid;
            this.reserveTaskList.facility_id=facid;
            var ths=this
            pr=Promise.deferred()

            stores.getFacilityModel(facid,function(facRec){
                if(facRec){
                    if(ths.facility.record===facRec){
                        ths.readFacilityRecord(facRec);
                    }
                    else{ths.facility.record=facRec;}
                    ths.facility.id=facRec.id
                    pr.resolve(facRec)
                }

            })


            return pr
        },
        /**
         * Description
         * @method findReservationsByText
         * @param {} val
         * @param {} resstore
         * @param {} fields
         * @return LogicalExpression
         */
        findReservationsByText: function(val,resstore,fields){
            var recs=[],idlist=[], _match=function(v1,v2,full){
                if(full){return v1==v2}
                return v1 && v1.toLowerCase().indexOf(v2)>=0
            }
            if(val) {var records=resstore.records||resstore
                val = val.toLowerCase()
                var re = new RegExp("(" + RegExp.escape(val) + ")", "gi"),users=fields=="users"
                recs = records.filter(function (rec) {
                    if(rec.datarecord){rec=rec.datarecord}
                    var member_id=rec.member_id
                    var firstname=rec.firstname,lastname=rec.lastname
                    var matchesname=_match(firstname , val) || _match(firstname +" "+lastname, val)   || _match(lastname +","+ firstname, val)  || _match(lastname , val)
                    if(matchesname){
                        idlist.indexOf(member_id)==-1 && idlist.push(users?member_id:rec)
                        return true
                    }
                    if(users){
                        return false
                    }
                    if (   _match(rec.vehicle_plate, val)
                        || _match(rec.vehicle_make, val)
                        || _match(rec.vehicle_model, val)
                        || _match(rec.reserve_num, val)
                        || _match(rec.slot, val,true)
                        || _match(rec.barcode, val,true)
                    ) {
                        idlist.push(rec)
                        return true
                    }
                    return false;
                })
            }
            return recs||[];
        },
        /**
         * Description
         * @method findReservation
         * @param {} val
         * @param {} options
         * @return
         */
        findReservation: function(val,options){
        },
        /**
         * Description
         * @method hasReserved
         * @return BinaryExpression
         */
        hasReserved:function(){
            return this.reservenum>0
        },
        /**
         * Description
         * @method hasSlot
         * @return BinaryExpression
         */
        hasSlot:function(){
            return this.reserveSlot.id > 0
        },
        /**
         * Description
         * @method ensureSlot
         * @return CallExpression
         */
        ensureSlot:function(){
            var pr=Promise.deferred()
            if(!(this.hasSlot())){
                app.remoteDirective("findslot",{facility_id:this.model.facility.id,date_from:+this.model.schedule.reserveDateTime,date_to:+this.model.schedule.reserveDateTimeEnd},
                    function(data){
                        data=data.data||data;
                        this.model.reserveSlot.readRecord(data)
                        pr.resolve(this)
                    }.bind(this))
                return pr
            }
            return pr.resolve(this)
        },
        /**
         * Description
         * @method isReserved
         * @return BinaryExpression
         */
        isReserved:function(){
            return this.resstatus == Utils.RESSTATUS.RESERVED
        },
        /**
         * Description
         * @method isCheckedIn
         * @return LogicalExpression
         */
        isCheckedIn:function(){
            return this.resstatus >= Utils.RESSTATUS.CHECKEDIN && this.resstatus < Utils.RESSTATUS.CHECKEDOUT
        },
        isCompleted:function(){
            return  this.resstatus > Utils.RESSTATUS.CHECKEDOUT
        },
        /**
         * Description
         * @method isCheckedOut
         * @return LogicalExpression
         */
        isCheckedOut:function(){
            return  this.resstatus >= Utils.RESSTATUS.CHECKEDOUT && this.resstatus < 500
        },
        /**
         * Description
         * @method remoteCall
         * @param {} cmd
         * @param {} args
         * @param {} data
         * @param {} callback
         * @return pr
         */
        remoteCall:function(cmd,args,data,callback){
            if(data && $.isPlain(data)){
                $.extend(args,data)
            }
            if(!args.facility_id){
                args.facility_id=this.facility_id||this.facility.id
            }
            var pr=Promise.deferred();
            if(typeof(callback)=="function"){pr.then(callback)}
            app.remoteDirective(cmd, {  sel: data }
                ,function (nu) {
                    var data=nu.data||nu
                    if(data.confirmed){data=data.confirmed}
                    this.readRecord(data);
                    pr.resolve(this)
                }
            )
            return pr;
        },
        /**
         * Description
         * @method checkOut
         * @param {} data
         * @param {} callback
         * @return CallExpression
         */
        checkOut:function(data,callback){
            var args={
                reserve_num: this.reservenum,
                tip:this.calctip
            };
            return this.remoteCall("docheckout",args,data,callback);
        },
        /**
         * Description
         * @method updateStatus
         * @param {} nustatus
         * @param {} data
         * @param {} callback
         * @return CallExpression
         */
        updateStatus:function(nustatus,data,callback){
            if(typeof(data)=="function"){callback=data;data=null;}
            var args={
                reserve_num: this.reservenum,
                nustatus: nustatus
            };
            return this.remoteCall("updatestatus",args,data,callback);

        },
        /**
         * Description
         * @method reserveParking
         * @param {} data
         * @param {} callback
         * @return CallExpression
         */
        reserveParking:function(data,callback){
            var args={
                member_id: this.user.id,
                facility_id: this.facility_id,
                vehicle_id: this.userVehicle.id
            };
            return this.remoteCall("confirmreserve",args,data,callback);

        },
        /**
         * Description
         * @method checkIn
         * @param {} data
         * @param {} callback
         * @return CallExpression
         */
        checkIn:function(data,callback){
            var args={
                member_id: this.user.id,
                facility_id: this.facility_id,
                vehicle_id: this.userVehicle.id
            };

            return this.remoteCall("docheckin",args,data,callback);
        },
        /**
         * Description
         * @method readFacilityRecord
         * @param {} record
         * @return
         */
        readFacilityRecord:function(record){
            if(record){
                //this.pricing.readRecord(record)
                //this.schedule.actualpricing.readRecord(record)
                this.syncOperator(record)
                this.recalcPrice();
                this.setBreakPoints();
            }
        },

        /**
         * Description
         * @method changepickuptime
         * @return
         */
        changepickuptime:function(){
            var model=this.clone(true),ths=this;
            model.addProperty("newpickupTime",{descriptor:true,type:"time",format:timeformat});
            model.addProperty("newpickupDate",{descriptor:true,type:"date",format:dateformat})
            model.addProperty("extendTime",(model.duration||"1")+" "+(model.durationType||"h").substr(0,1))
            model.addProperty("scheduledTime",(model.pickupDate?model.pickupDate.format(dateformat,true):"")+" "+(model.pickupTime?model.pickupTime.format(timeformat,true):""))
            model.removeProperty("record")
            model.newpickupTime=model.pickupTime
            model.newpickupDate=model.pickupDate
            model.onchange("pickupTime",function(rec){
                this.newpickupTime= $.date.asTime(rec.value)
            });
            model.onchange("pickupDate",function(rec){
                this.newpickupDate= $.date(rec.value)
            });
            model.onchange("extendTime",function(rec){
                var arr=String(rec.value).split(/\s+/)
                if(arr.length>1){
                    this.duration=Number(arr[0])
                    this.durationType=(String(arr[1])||"h").substr(0,1)
                }
            })

            var vw=new PopupView({
                title:"Change pickup Time",modal:true,minHeight:350,height:350
            }).show()
            var HR=1000*60*60,DAY=HR*24,MNTH=DAY*30
            vw.addButton("Save",function(){
                var hr,min,hrst,minst,st= $.date.asDate(+model.reserveDateTime) ,
                    end=$.date.asDate(+model.newpickupDate).trunc().update({h:model.newpickupTime.getHours(),n:model.newpickupTime.getMinutes()});
                var diff=end-st;
                if(diff>0) {
                    if (model.durationType == "m") {
                        model.duration = Math.ceil(diff / MNTH)
                    } else if (model.durationType == "d") {
                        model.duration = Math.ceil(diff / DAY)
                    } else {
                        var dur = diff / HR, base = Math.floor(dur), frac = dur - Math.floor(dur)
                        model.duration = Math.ceil(diff / HR)
                    }
                }
                ths.durationType=model.durationType
                ths.duration=model.duration
                ths.record.scheduled_duration=model.duration
                ths.record.durationType=model.durationType
                ths.record.save();
                this.hide();
            })
            var p=$.partialview({url:"app/data/extendtime.html",model:model})
            p.appendTo(vw.$content());

        },
        /**
         * Description
         * @method load
         * @param {} id
         * @param {} callback
         * @return pr
         */
        load:function(id,callback){
            var pars={}
            if(!isNaN(id) && id>0){
                pars.reserveid=id
            } else{
                pars.reservenum=id
            }
            var pr=Promise.deferred()
            if(typeof(callback)=="function"){
                pr.then(callback)
            }
            app.remoteDirective("reserveinfo",pars,function(ev){
                var rec=ev.data||ev
                this.readRecord(rec)
                pr.resolve(this)
            }.bind(this))
            return pr
        },
        /**
         * Description
         * @method readyforpickup
         * @return
         */
        readyforpickup:function(){
            app.showMessage("Message delivered.")
        }

    });

/**
 * Description
 * @method for
 * @param {} id
 * @param {} callback
 * @return CallExpression
 */
ReserveModel.for=function(id,callback){
    var res=new ReserveModel();
    if(typeof(callback)!="function"){callback=null}
    return res.load(id,callback)
}
/**
 * Description
 * @method from
 * @param {} record
 * @return res
 */
ReserveModel.from=function(record){
    var res=new ReserveModel();
    res.readRecord(record)
    return res
}
module.exports=ReserveModel
}
__bootstrap__.modules["models/ReserveSlotModel"] = function(module){
/**
 * Created by Atul on 5/31/2015.
 */
var ReserveSlotModel=$.model.make("ReserveSlotModel", {
    slot:null,
    id:null,
    name:null,
    slotname:null,
    location:null,
    group_id:null,
    group_name:null,
    color:null,
    slot_status :null
},
    {
/**
 * Description
 * @method readRecord
 * @param {} record
 * @return 
 */
readRecord:function(record) {
        var id=record.slotid,name=record.slotname,loc=record.slotlocation
        if(!record._isreserverecord){
            id=record.id||id
            name=record.name||name
            loc=record.location||loc
        }
        this.readDataRecord(
        {
            id: id,
            name: name,
            slotname: name,
            location: loc,
            slot_status: record.slot_status
        }
    )
}
})


    module.exports=ReserveSlotModel;
}
__bootstrap__.modules["models/ReserveTask"] = function(module){
var map={
	0:"Pending",
	1:"Processing",
	2:"Completed",
	3:"Cancelled"
}

var ReserveTask=$.model.make("ReserveTask", {
	reserve_id:null,
	id:null,
	type_id:null,
	name:null,
	assigned_to:null,
	status:null,
	statusstring:{
		descriptor:true,
		/**
		 * Description
		 * @method expr
		 * @param {} rec
		 * @return LogicalExpression
		 */
		expr:function(rec){
			return map[rec.status]||""
		},vars:["status"]
	}
})
ReserveTask.statusLookup=map
module.exports=ReserveTask;
}
__bootstrap__.modules["models/ReserveTaskList"] = function(module){
var stores=$.require("common/Appstores")
var ReserveTask=$.require("models/ReserveTask")
var taskTemplate="<li class='srvc-item' data-key='$id'><span class='srvc-name'>$name</span><span class='srvc-price'>$price</span><span class='srvc-cancel'>Cancel</span><span class='srvc-status'>$statusstring</span></li>"
var taskTemplateWithStatus="<li class='srvc-item' data-key='$id'><span class='srvc-name'>$name</span><div class='srvc-status $statusstring'>#statuslist</div></li>"
var typelookup=null,_pending=null
/**
 * Description
 * @method setupLookup
 * @return 
 */
function setupLookup(){
	if(!typelookup && !_pending){
		_pending=true;
		app.getEntity("appnotificationtype").then(
			function(ent){
				typelookup=ent.createStore()
				typelookup.load()
				_pending=false
			}
		)
	}
}
var ReserveTaskList=$.model.make("ReserveTaskList", {
	tasks:null,
	parseStr:null,
	reserve_id:null,
	facility_id:null

},{ 
/**
  * Description
  * @method parse
  * @param {} array
  * @return 
  */
 parse:function(array){
		var tasks=[]
	if(!array){return}
	if(typeof(array)=="string"){
		if(!array.trim()){return}
		array=array.split(",")
	}
	var arr=Array.isArray(array)?array:(array?[array]:[])
		if(typeof(arr)=="string"){
			arr=arr.split(",")
		}
		this.parseStr=arr;
		if(arr && arr.length){
			var list=arr.slice()
 			while(list.length){
				var a=list.shift().split(/\|/);
			    if(!a[0]){continue}
				var data={reserve_id:this.reserve_id,id:a[0],type_id:Number(a[1])||0,status:Number(a[2])||0,assigned_to:Number(a[3])||0,response_msg: a[5] };
				if(a[4]){
					data.name=a[4];
 				}
				 if(typelookup){
					var type=typelookup.find(function(rec){
						return rec.id==data.type_id
					});
					if(type && !data.name){
 						data.name=type.short_msg||type.shortmsg
  					}
				}
 				tasks.push(new ReserveTask(data))
			}

		}
		this.tasks=tasks
	},
	 /**
 	 * Description
 	 * @method hasUnResolved
 	 * @return CallExpression
 	 */
 	hasUnResolved:function(){
		return this.tasks.some(function(a){ return a.status<2})
	 },
	/**
	 * Description
	 * @method init
	 * @return 
	 */
	init:function(){
		setupLookup()
		this.tasks=[]
		this.reserve_id||(this.reserve_id=0);
	},

	/**
	 * Description
	 * @method showListWithStatus
	 * @param {} container
	 * @param {} callback
	 * @return 
	 */
	showListWithStatus:function showListWithStatus(container ,callback){
		if(typeof(taskTemplateWithStatus)=="string"){
			taskTemplateWithStatus=taskTemplateWithStatus.replace(/#statuslist/,Object.keys(ReserveTask.statusLookup).map(function(k){
				var nm=ReserveTask.statusLookup[k];
				return "<span data-key='"+k+"' class='srvc-status-item srvc-status-"+ nm.toLowerCase()+"'>"+nm+"</span>"
			}).join(""))
			taskTemplateWithStatus=$.template(taskTemplateWithStatus)
		}
		var listcontainer=$d(container)
		var  ths=this
		this.onchange("tasks",function(a){
			if(!listcontainer){return}
			var tasks=this.tasks||[]
 			listcontainer.html(
				tasks.map(function (it) {it.recalcAll()
					return taskTemplateWithStatus(it)
				}).join("")||"No tasks found"
			);
			var items=listcontainer.qq(".srvc-item")
			tasks.forEach(function (it,i) {
				var nm=String(it.statusstring).toLowerCase()
				items[i] && items[i].qq(".srvc-status-"+ nm).addClass("current")
			})
		})


		listcontainer && listcontainer.on("click",function(ev,el){
			var li=el.up("li"),status=el.domdata("key");
			var tasks=this.tasks
			if(!(li && li.domdata("key"))){return}
			var id=li.domdata("key")
			var extra=tasks.find(function(a){return a.id==id})
			if(!extra){return}
			app.remoteDirective("updateextra",{id:id,status:status}).then(function(rec){
					var rec=this.tasks.find(function(a){return a.id==id})

					typeof(callback)=="function" && callback(rec)
					this.firePropertyChangeEv("tasks")
				}.bind(ths)
			)
			extra.status=Number(status)||0
			el.up().qq(".current").removeClass("current")
			el.addClass("current")

		}.bind(this)   ,{selector:".srvc-status-item"})

	}

});
ReserveTaskList.setupLookup=setupLookup
ReserveTaskList.typelookup=null
//5|Car Wash|10.50|1
module.exports=ReserveTaskList;
}
__bootstrap__.modules["models/ScheduleModel"] = function(module){
var PriceModel=$.require("models/PriceModel")
 var dateformat="ddd, mmm dd yyyy", timeformat="hh:nn tt", datetimeformat="ddd hh:nn tt"
/**
 * Description
 * @method pad
 * @param {} v0
 * @return BinaryExpression
 */
function pad(v0){ return (String(v0).length==1?"0":"")+v0 }
var dbMap={
    time_from:"reserveDateTime",
    date_from:"reserveDateTime",
    duration_type:"durationType",
    scheduled_duration:"duration"
 }
var ScheduleModel=$.model.make("ScheduleModel", {
    record:null,
     reserveDateTime:{descriptor:true,type:"date",format:timeformat},
    reserveDateTimeEnd:{descriptor:true,type:"date" },
    reserveDate:{descriptor:true,type:"date" },
    reserveTime:{descriptor:true,type:"time" },
    computedDuration:null,
    resstatus:null,
    entry_time:{descriptor:true,type:"date",format:datetimeformat},
    exit_time:{descriptor:true,type:"date",format:datetimeformat},
    extra2price:{descriptor:true,type:"float",defaultValue:5.00},
    extra1price:{descriptor:true,type:"float",defaultValue:5.00},
    extra2:{descriptor:true,type:"currency",defaultValue:0},
    extra1:{descriptor:true,type:"currency",defaultValue:0},
    duration:null,
    tip:null,
    daterange:null,
    durationType:null,

    actualDuration:null,
    reserveDuration:null,
    checkinsince:{descriptor:true,type:"string",format:timeformat,
/**
 * Description
 * @method expr
 * @param {} rec
 * @return CallExpression
 */
expr:function(rec){
        var st=rec.entry_time||rec.reserveDateTime
        if(!st){return ""}
        var daterange=$.date.makeRange(st,$.date())
            return daterange.format()
        },vars:[ "reserveDateTime","entry_time"]
    } ,
     formattedDuration: {
        descriptor: true, type: "string", 
/**
  * Description
  * @method expr
  * @param {} rec
  * @return val
  */
 expr: function (rec) {

            var dur=Number(rec.duration|| 1)||1,typ=(rec.durationType||" ").charAt(0).toLowerCase()||"h"

            if(typ=="m"){return "Monthly"}
            else if(typ=="d"){return "Daily"}
            if(dur<1){
                return (dur*60) +" mins"
            }
             var val=  (pad(dur) +" hr").trim()
              return val
        },vars:[ "duration","durationType"]
    },
    dorecalc:null

}, {
    /**
     * Description
     * @method updateLinks
     * @return 
     */
    updateLinks:function(){return

    },
    /**
     * Description
     * @method setEntryTime
     * @param {} nudate
     * @return ThisExpression
     */
    setEntryTime:function(nudate){
         this.computed_start_long=+nudate
        this.reserveDateTime=$.date(+nudate)
        this.entry_time=$.date(+nudate)
        this.setupDates()
         return this
    },
    /**
     * Description
     * @method getTimeRange
     * @param {} refresh
     * @return 
     */
    getTimeRange:function(refresh){
        if(!this.daterange){
            this.daterange=$.date.makeRange()
            refresh=true
        }
        if(refresh){
            if(this.entry_date){
                this.daterange.start=this.entry_date
            }
            if(this.exit_date){
                this.daterange.end=this.exit_date
            } else{
                this.daterange.setDuration(this.durationType,this.duration)
            }
        }
    },
    /**
     * Description
     * @method setExitDate
     * @param {} nudate
     * @return 
     */
    setExitDate:function(nudate){
        this.exit_time=$.date(+nudate);
         this.setupDates()
        //if(duration<30){duration=.5}
        //else if(duration<60){duration=1}
        //else {duration=Math.floor(duration/60)}
       // sch.duration=duration
        this.recalcAll()
    },
    /**
     * Description
     * @method init
     * @return 
     */
    init:function() {
          this.dorecalc=0;
        this.daterange=$.date.makeRange()
         this.onchange("record", function (rec) {
             this.readRecord(rec.value)
        });
        this.onchange("reserveDuration",function(rec){
            this.parseDuration(rec.value)
        } );
        this.onchange("reserveDate reserveTime",function(rec){
            if(!rec.value){return}
            if(!this.reserveDateTime){
                if(this.reserveDate && this.reserveTime){
                    var nu= $.date(this.reserveDate)
                    var tm= $.date(this.reserveTime)
                    if(tm){
                        nu.trunc()
                        nu.setHours(tm.getHours())
                        nu.setMinutes(tm.getMinutes())
                        this.reserveDateTime=nu;
                        this.setupDates();

                    }
                }
            } else {
                if(rec.name=="reserveTime"){
                    var tm= $.date(rec.value)
                    if(tm){
                        var nu= $.date(+this.reserveDateTime).trunc()
                        nu.setHours(tm.getHours())
                        nu.setMinutes(tm.getMinutes())
                        if(+this.reserveDateTime != +nu) {
                            this.reserveDateTime = nu;
                            this.setupDates();
                        }
                    }
                } else if(rec.name=="reserveDate"){
                    var dt= $.date(rec.value)
                    if(dt){
                        var nu= $.date(+this.reserveDateTime)
                        nu.setFullYear(dt.getFullYear())
                        nu.setMonth(dt.getMonth())
                        nu.setDate(dt.getDate())
                        if(+this.reserveDateTime != +nu) {
                            this.reserveDateTime = nu;
                            this.setupDates();
                        }
                    }
                }
            }

        } );

    },
    /**
     * Description
     * @method parseDuration
     * @param {} resdur
     * @return 
     */
    parseDuration: function(resdur){
        if(!resdur){return}
        this.daterange||(this.daterange=$.date.makeRange());
        var val=String(resdur||"")
        if(val=="0.5 h"||val==".5 h"){
            this.daterange.duration=this.duration    = .5
            this.durationType    = "h"
            this.daterange.durationType="h"
            return
        }
        var dur=Number(val.replace(/[^\d\.]+$/g,"").trim())||1
        var durtyp=val.replace(/^[\d\.]+/g,"").trim()
        if(!durtyp){durtyp="h"}
        durtyp=durtyp.charAt(0).toLowerCase()
        if(durtyp){
            if(durtyp!=="h" && durtyp!=="m" && durtyp!=="d"){
                durtyp="h"
            }
            this.daterange.durationType=dur
            this.durationType    = durtyp
        }
        if(dur){
            this.daterange.duration=dur
            this.duration    = dur}

    },
    /**
     * Description
     * @method recalcPrice
     * @return 
     */
    recalcPrice:function(){

    },
    /**
     * Description
     * @method getDataRecord
     * @param {} holder
     * @param {} useactual
     * @return holder
     */
    getDataRecord:function(holder,useactual){
        holder=holder||{}
        this.recalcAll()
         this.setupDates()
        $.each(dbMap,function(v,k){
            holder[k]=this.get(v)
            if(holder[k] && holder[k].getTime){
                holder[k] = holder[k].getTime()
            }
         },this);
        return holder
    },

    /**
     * Description
     * @method setupDates
     * @return ThisExpression
     */
    setupDates:function( ){
        this.__holdcalc=true
        this.daterange||(this.daterange=$.date.makeRange());
            var duration_type = this.durationType || "h", duration = Number(this.duration) || 1, actual_duration = this.actual_duration
            var actualDuration,reserveDateTime =this.reserveDateTime//.trunc();
        var reserveDateTimeEnd
        //if(!(duration_type && duration>=0 && this.reserveDate && this.reserveTime)){return }
            try {
                if(reserveDateTime && !reserveDateTime.__isdate__){reserveDateTime= $.date(reserveDateTime)}
                if (!reserveDateTime) {
                    if (this.entry_time && $.date(this.entry_time)) {
                        reserveDateTime = $.date(+this.entry_time, timeformat)
                    }
                }
                if (!reserveDateTime) {
                    if(this.reserveDate){
                        reserveDateTime=$.date(+this.reserveDate)
                        if(this.reserveTime){
                            var t=$.date(this.reserveTime)
                            reserveDateTime.setHours(t.getHours())
                            reserveDateTime.setMinutes(t.getMinutes())
                        }
                    }
                 }


                //reserveDateTime.setHours(this.reserveTime.getHours())
                //reserveDateTime.setMinutes(this.reserveTime.getMinutes());

                 if (this.exit_time) {
                      reserveDateTimeEnd = $.date(this.exit_time, timeformat)
                    if(reserveDateTimeEnd<(+this.entry_time)){reserveDateTimeEnd=$.date(+this.entry_time)}

                }
                else {
                    var typ = duration_type, dur = duration;
                    if (duration_type == "h" && duration < 1) {
                        dur = 60 * duration
                        typ = "n"
                    }
                    if(reserveDateTime){
                        reserveDateTimeEnd = $.date(+reserveDateTime, timeformat)
                            if(reserveDateTimeEnd ){
                                reserveDateTimeEnd.plus(typ, dur)
                            }

                    }

                }
                if(reserveDateTime && reserveDateTime!=this.reserveDateTime){
                    this.reserveDateTime= $.date(+reserveDateTime)
                }
                this.reserveDateTimeEnd = reserveDateTimeEnd
                if (this.entry_time && this.exit_time) {
                    actualDuration=((+this.exit_time) - (+this.entry_time))
                    duration=actualDuration/(1000*60*60 )
                    var h, str=""
                    if (duration< 1) {
                        duration = .5
                     } else {
                        duration = Math.floor(duration)
                     }
                    this.duration = duration
                    if (actualDuration > 0) {

                           h = Math.floor(actualDuration / $.date.unitToMS("h"))//this.exit_time.getHours() - this.entry_time.getHours()

                    }
                    if (h < 0.5) {
                        h = .5
                    }
                    this.computedDuration = h
                    //this.actualDuration = str
                }
                duration_type = String(duration_type || "h").charAt(0).toLowerCase()
                if(duration_type!=="h" && duration_type!=="m" && duration_type!=="d"){
                    duration_type="h"
                }
                 this.reserveDuration = duration + " " + (duration_type=="h"?"hr":duration_type)

                this.daterange.start= this.entry_time||reserveDateTime
                this.daterange.end=reserveDateTimeEnd
                //this.daterange.setDuration(duration_type,duration)
                this.actualDuration=this.daterange.format()
              } catch (e) {
                console.error(e)
            } finally{
                this.__holdcalc=false;
             }
            if (!this.dorecalc) {
                this.dorecalc = 0
            }
            this.dorecalc++
return this;
     },
    /**
     * Description
     * @method readModel
     * @param {} model
     * @return 
     */
    readModel:function(model){
        if(!model){return}
        var time=model.reserveDateTime
        if(!time){
            model.setupDates();
            time=model.reserveDateTime
        }
        this.readRecord({
            duration:model.duration,
            durationType:model.durationType,
             reserveDateTime: $.date(+time),
            entry_time: model.entry_time?$.date(+model.entry_time):null,
             exit_time:+(model.exit_time||0)
        })
    },
    /**
     * Description
     * @method readRecord
     * @param {} record
     * @return 
     */
    readRecord:function(record){
        if(!record){return}
        try{this.__holdcalc=true;
            var time_from ,date_from ,
                duration_type=record.duration_type||record.durationType, duration =record.scheduled_duration||record.duration,
                actual_duration=record.actual_duration
            var resstatus

            if(record.entry_time && $.date(record.entry_time)){
                time_from=$.date(record.entry_time)
            }
            else if(record.reserveDateTime){
                time_from=$.date(record.reserveDateTime)
            }
            else if(record.computed_start_long){
                time_from =  $.date(record.computed_start_long)
            } else if(record.time_from && record.date_from){
                time_from=$.date(record.date_from)
                    var tm=$.date.asTime(record.time_from)
                if(time_from && tm){
                    time_from.trunc();
                    time_from.setHours(tm.getHours())
                    time_from.setMinutes(tm.getMinutes())
                }
            }
            if (!time_from) {
                time_from = $.date()
            }
            if (!duration) {
                duration = 2
            }
            duration_type = duration_type || "h"

             var reserveTime = $.date.asTime(time_from, timeformat)
             if(record.entry_time && $.date(record.entry_time)){
                this.entry_time =$.date.asTime(record.entry_time, datetimeformat);
            }
            if(record.exit_time){
                this.exit_time =$.date.asTime(record.exit_time, datetimeformat);
            }

            this.resstatus=record.resstatus;
            this.reserveDateTime =reserveTime;
             duration_type=String( duration_type || "h").charAt(0).toLowerCase()
            if(duration_type!=="h" && duration_type!=="m" && duration_type!=="d"){
                duration_type="h"
            }
            this.durationType = duration_type
            this.duration =  duration<1?.5:Math.ceil(duration);
            this.tip=record.tip||0
        } finally{
            this.__holdcalc=false;
            this.setupDates();
        }

        //this.recalcAll();
    }

});
module.exports=ScheduleModel;
}
__bootstrap__.modules["models/UserModel"] = function(module){
var stores=$.require("common/Appstores")

var UserModel=$.model.make("UserModel", {
         id:null,
        facility_id:null,
        lastname:null,
        middlename:null,
        username:null,
        email:null,
        usertype:null,
        firstname:null,
    phonenumber:null,
        pic:null,
        isNonMember:null,
         fullname:{descriptor:true,
/**
 * Description
 * @method expr
 * @param {} rec
 * @return nm
 */
expr:function(rec){
            var nm=rec.firstname+" "+rec.lastname;
            if(rec.isNonMember){nm=nm+ " (Non Member)"}
            return nm
        }, vars:["firstname" ,"lastname","isNonMember"]}
    },
    {
        /**
         * Description
         * @method init
         * @param {} id
         * @return 
         */
        init:function(id){
             this.readRecord(id);
         },
        /**
         * Description
         * @method loadRecord
         * @param {} id
         * @param {} pr
         * @return pr
         */
        loadRecord:function(id,pr){
            if(this.isNonMember){
                stores.getNonMemberUserModel(id,function(rec){
                    this.readRecord(rec,true,true)
                    this.isNonMember=true;
                    if(pr){pr.resolve()}
                }.bind(this))

                return pr
            }
            stores.getUserModel(id,function(rec){
                this.readRecord(rec,true)
                if(pr){pr.resolve(this)}
            }.bind(this))
            return pr
        },
        /**
         * Description
         * @method readRecord
         * @param {} record
         * @param {} noload
         * @param {} isnonmember
         * @return pr
         */
        readRecord:function(record,noload,isnonmember){
            if(!record){return Promise.resolve()}
            var id,pr=Promise.deferred()
            if(typeof(record)!="object"){
                id=Number(record)||0
            }
            if(id && id>0){
                if(this.id!=id){
                     this.clearValues();
                    this.id=id
                    return this.loadRecord(id,pr);
                }
             } else{
                if(record.user ){
                    this.readDataRecord($.isPlain(record.user)?record.user:record.user.toMap(), [ "fullname"])
                } else{
                    if(!record._isreserverecord && record.id){
                         this.readDataRecord(record, ["fullname"])
                    }
                    else if(record.member_id||record.userid||record.user_id ){
                        this.id = record.member_id||record.userid||record.user_id;
                    }
                 }
                if(record.nonmember_id||record.isNonMember||isnonmember===true){
                    if(record.nonmember_id){
                        this.nonmember_id=this.id=record.nonmember_id
                    } else{
                        this.nonmember_id=this.nonmember_id||this.id
                    }

                    this.isNonMember=true;
                    if(record.firstname || record.lastname ){
                        this.readDataRecord(record, ["fullname","id"])
                    }
                } else{
                    this.isNonMember=false;
                    record.nonmember_id=0;
                }

            }
            if(!this.firstname  ){
                if(this.id && noload!==true){
                    if(app.user.id==this.id && !app.user.facility){
                        this.readDataRecord(app.user, ["fullname"])
                        pr.resolve(this)
                        return pr;
                    }
                    return this.loadRecord(this.id,pr);
                }
            }
            pr.resolve(this);
            return pr
        }



    });
module.exports=UserModel;
}
__bootstrap__.modules["models/UserSelectionModel"] = function(module){
var dateformat="ddd, mmm dd yyyy", timeformat="hh:nn tt"
 var VehicleModel = $.require("models/VehicleModel")
var GeoLocation = $.require("common/GeoLocation")
var ScheduleModel= $.require("models/ScheduleModel")
var ReserveModel=$.require("models/ReserveModel")
var UserSelectionModel=$.model.make("UserSelectionModel", {
        baseModel:ReserveModel,
        location:null, userOptions:null ,
        locations:null
    },
    {
        /**
         * Description
         * @method init
         * @return 
         */
        init:function(){
            this.locations = $.model.Collection({itemKlass:GeoLocation})
            if(!this.user){
                this.user=  $.extend({},app.user);
            }
            this.userOptions=this.userOptions||{};

            //this.targetLocation = new GeoLocation()
            this.location = new GeoLocation()

            if(!this.userVehicle){
                this.userVehicle=new VehicleModel();
            }
            if (!this.schedule){
                 this.schedule=new ScheduleModel();
            }
        },

        /**
         * Description
         * @method selectVehicle
         * @param {} v
         * @return MemberExpression
         */
        selectVehicle:function(v){
            if(this.vehicleStore){
                var rec=this.vehicleStore.find(v)
                if(rec){this.userVehicle.record.readRecord(rec.toMap())}
            }
            return this.userVehicle;
        }
    })

module.exports=UserSelectionModel
}
__bootstrap__.modules["models/UserSelectionsConfirmModel"] = function(module){
/**
 * Created by Atul on 5/21/2015.
 */
var dateformat="ddd, mmm dd yyyy", timeformat="hh:nn tt"
 var VehicleModel = $.require("models/VehicleModel")
var GeoLocation = $.require("common/GeoLocation")
var ScheduleModel= $.require("models/ScheduleModel")
var PriceModel=$.require("models/PriceModel")
var stores=$.require("common/Appstores")
var ReserveModel=$.require("models/ReserveModel")
var UserSelectionsConfirmModel=$.model.make("UserSelectionsConfirmModel", {
        baseModel:ReserveModel,
          selectedLocation:null,
         userOptions:null,
        syncdWithSelections:null
       },
    {
        /**
         * Description
         * @method init
         * @return 
         */
        init:function(){
            this.locations = $.model.Collection({itemKlass:GeoLocation})
            if(!this.user){
                this.user=  $.extend({},app.user);
            }
            this.userOptions=this.userOptions||{};

            this.selectedLocation = new GeoLocation()
            //this.facility=this.selectedLocation.facility
            if(!this.userVehicle){
                this.userVehicle=new VehicleModel();
            }
            if (!this.schedule){
                this.schedule=new ScheduleModel();
                this.schedule.onchange("duration durationType",function(rec){
                    if(rec.value){
                        this.recalcPrice();
                    }

                })
            }

                this.schedule.onchange("tip",
                    function(){this.recalcPrice()
                }.bind(this))

        },

        /**
         * Description
         * @method updateFromSelections
         * @param {} selections
         * @param {} targetLocation
         * @return ThisExpression
         */
        updateFromSelections:function(selections,targetLocation){
            if(selections.schedule){
                selections.schedule.setupDates()
                this.schedule.readModel(selections.schedule)
            }

            if(selections.userVehicle){
                this.userVehicle.readRecord(selections.userVehicle)
             }
            //var targetLocation=app.activeSesstion.selections.selectedLocation
             if( targetLocation){
                var selectedLocation=this.selectedLocation//,targetLocation=selections.targetLocation
                 selectedLocation.readFacilityRecord(targetLocation.facility);
                "locationid locKey locname reservelabel walkdistance distance type color".split(/\s+/).forEach(
                 function(k){
                     selectedLocation[k]=targetLocation[k];
                 }
                );


                 selectedLocation.latlng=targetLocation.latlng
                   //this.schedule.pricing.readRecord(pricing)
                // this.pricing.facility=targetLocation.facility;
                // selectedLocation.locationAddress.checkValidity()

            }


            this.schedule.setupDates()
            this.syncdWithSelections=true;
            return this
        }
    })

module.exports=UserSelectionsConfirmModel
}
__bootstrap__.modules["models/VehicleModel"] = function(module){
var stores=$.require("common/Appstores")
var defImgSrc=null;
var PMR="http://parcmate.com/pmr/"
var QRCode=$.require("QRCode")
var VehicleModel=$.model.make("VehicleModel", {
        barcode:null,
        vehicle_make:null,
        vehicle_model:null,
        vehicle_plate:null,
        vehicle_type:null,
        vehicle_year:null,
        vehicle_color:null,
        vehicle_label:null,
        primary:null,
        label:{descriptor:true,
            /**
             * Description
             * @method expr
             * @param {} rec
             * @return CallExpression
             */
            expr:function(rec){
                if(String(rec.vehicle_label||"").trim()){
                    return rec.vehicle_label
                }
                return [rec.vehicle_plate,rec.vehicle_make,rec.vehicle_model,rec.vehicle_year,rec.vehicle_color].filter(function(a){return !!a}).join(", ")
            }
        },
        imgpath:{descriptor:true,
            /**
             * Description
             * @method expr
             * @param {} rec
             * @return src
             */
            expr:function(rec){
                if(!this.vehicle_make){
                    return ""
                }
                var make=String(this.vehicle_make).replace(/[^a-z]/ig,"").trim().toLowerCase()
                var src= PMR+"vi/logos/"+make+".png"
               /*
                var  src= pmr+rec.vehicle_make+"/"+rec.vehicle_year+"/"+rec.vehicle_model+"/"+String(rec.vehicle_color).toLowerCase()+".png"
                if(src.indexOf(defImgSrc)==-1 && (src.indexOf("undefined")>=0||src.indexOf("null")>=0)){
                    return app.contextPath+defImgSrc
                }*/
                return src
            },vars:[ "vehicle_make","vehicle_color" ]
        },
        id:null,
    },
    {
        /**
         * Description
         * @method getAltImgPath
         * @return src
         */
        getAltImgPath:function(){
            if(!this.vehicle_make){return}
            var make=String(this.vehicle_make).replace(/[^a-z]/ig,"").trim().toLowerCase()
            var src= pmr+make+".png"
            return src
        },
        /**
         * Description
         * @method getDefaultImgPath
         * @return defImgSrc
         */
        getDefaultImgPath:function(){
            defImgSrc||(defImgSrc=app.appassetsPath+"defaultvehicle.png");
            return defImgSrc
        },
        /**
         * Description
         * @method isOverSize
         * @return BinaryExpression
         */
        isOverSize:function(){
            return ["lrg","suv","oversize"].indexOf(String(this.vehicle_type||"-").toLowerCase())>=0
        },
        /**
         * Description
         * @method isPrimary
         * @return UnaryExpression
         */
        isPrimary:function(){
            return !!this.primary
        },
        /**
         * Description
         * @method readRecord
         * @param {} record
         * @param {} noload
         * @return pr
         */
        readRecord:function(record,noload){
            if(!record){return Promise.reject()}
            var pr=Promise.deferred();

            if(!isNaN(record) ){
                if(this.id && this.id==record){return}
                return this.load(record)

            }
            var data={}
            var map= $.isPlain(record)?record:record.toMap?record.toMap():record
            if(map.vehicle && $.isPlain(map.vehicle)){
                map=map.vehicle
            };
            "make model label year type color plate id".split(/\s+/).forEach(function(a){
                var nm="vehicle_"+a;
                data[nm]=map[nm]||""
            });

            if(map.barcode){data.barcode=map.barcode}
            if(data.vehicle_id){data.id=data.vehicle_id}
            else if(data.vehicleid){data.id=data.vehicleid}

            if(this.vehicle_plate && data.id && this.id==data.id){
                this.readDataRecord(data)
                pr.resolve(this)
                return pr
            }


            if(record.nonmember_id||record.nonmemberid){
                this.id=data.id=0;
                if(record.user){
                    "make model label year type color plate".split(/\s+/).forEach(function(a){
                        var nm="vehicle_"+a;
                        data[nm]=record.user[nm]||""
                    });
                }
            } else if(!record._isreserverecord){
                if(!data.id && map.id && Object.keys(data).length) {
                    data.id = map.id;
                }

            }

            if(data.vehicle_plate && Object.keys(data).length){
                this.clearValues();
                this.readDataRecord(data)
                this.id=data.id;
                pr.resolve(this)
                return pr
            } else{
                var id=data.id
                if(id){

                    if(this.id!=id){
                        this.clearValues();
                        this.readDataRecord(data,["id"])
                        this.id=id;
                    }

                } else{
                    if(data.vehicle_type){
                        this.vehicle_type=data.vehicle_type
                    }
                }
            }

            if(!noload && this.id && !( data.vehicle_plate)){
                return this.load(this.id)
            } else {

            }
            if(data.vehicle_make && String(data.vehicle_make).indexOf(":")>0){
                var arr=data.vehicle_make.split(":").map(function(a){return a.trim()})
                data.vehicle_make=arr[0]
                data.vehicle_model=arr[1]
            }
            if(!(this.id && this.vehicle_plate)){
                this.readDataRecord(data,this.id?["id"]:[])
            }

            pr.resolve(this)
            return pr;
        },
        /**
         * Description
         * @method load
         * @param {} id
         * @return pr
         */
        load:function(id){
            var pr=Promise.deferred();
             this.id=id;
            stores.getVehicleModel(id,function(rec,store){
                //if(arguments.length==1){store=rec;rec=null;}
                if(!rec && store){
                    var pri=store.find(function(rec){return rec.isprimary})||store.records.first()
                    if(pri){this.readDataRecord(pri)}
                }
                else{
                    this.readDataRecord(rec,["id"] )
                }
                pr.resolve(this)
            }.bind(this))
            return pr
        },
     /**
      * Description
      * @method drawBarCode
      * @param {} el
      * @param {} noload
      * @return 
      */
     drawBarCode:function(el,noload){
        el=$d(el)

         if(!this.barcode &&  !noload && this.id){
            this.load(this.id).then(this.drawBarCode.bind(this,el,true))
            return
         }

        if(this.barcode && el){
            if(el.q(".qrcode")){
                var img=el.q(".qrcode img");
                if(img && img.data("barcode")===this.barcode && img.el.naturalHeight){
                    return
                }
                 el.q(".qrcode").remove()
                el.q(".qrcode-text") && el.q(".qrcode-text").remove()
            }
            this.barCodeEl=el.append("div.qrcode");
            el.append("div.qrcode-text").html(this.barcode);
             if(el.isVisible(true)){
                 var qrcode = new QRCode(this.barCodeEl.el , {
                    text: this.barcode,
                    width: 140,
                    height: 140,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                 var img=el.q(".qrcode img");
                if(img ){
                    img.data("barcode",this.barcode);
                }
            }

        }
    },
    /**
     * Description
     * @method drawSvg
     * @param {} el
     * @return 
     */
    drawSvg:function(el){
         $d.addClass(el,"default-car-img");
     }


});

VehicleModel.vehicleData={"Acura":["ILX","ILX Hybrid","MDX","RDX","RL","RLX","TL","TLX","TSX","TSX Sport Wagon","ZDX"],"Audi":["A3","A3 e-tron","A4","A6","A7","A8","allroad","Q3","Q5","Q7","RS 7","S3","S4","S6","S7","S8","SQ5","TT","TTS"],"BMW":["3 Series","3 Series Gran Turismo","4 Series Gran Coupe","5 Series","5 Series Gran Turismo","6 Series Gran Coupe","7 Series","ActiveHybrid 5","ActiveHybrid 7","ActiveHybrid X6","ALPINA B6 Gran Coupe","ALPINA B7","i3","M3","M5","M6 Gran Coupe","X1","X3","X4","X5","X5 M","X6","X6 M"],"Buick":["Anthem","Enclave","Encore","LaCrosse","Lucerne","Regal","Verano"],"Cadillac":["ATS","ATS-V","CTS","CTS Coupe","CTS Wagon","CTS-V","CTS-V Coupe","CTS-V Wagon","DTS","Escalade","Escalade ESV","Escalade Hybrid","SRX","STS","XTS"],"Chevrolet":["Aveo","Captiva Sport","City Express","Cobalt","Colorado","Cruze","Equinox","HHR","Impala","Impala Limited","Malibu","Malibu Hybrid","Silverado 1500","Silverado 2500HD","Silverado 3500HD","Sonic","Spark","Spark EV","SS","Suburban","Tahoe","Tahoe Hybrid","Traverse","Trax","Volt"],"Chrysler":["200","300","PT Cruiser","Sebring","Town and Country"],"Dodge":["Avenger","Caliber","Charger","Dakota","Dart","Durango","Grand Caravan","Journey","Journey","Nitro"],"FIAT":["500","500e","500L"],"Ford":["C-Max Energi","C-Max Hybrid","Crown Victoria","Edge","Escape","Escape Hybrid","Expedition","Explorer","Fiesta","Flex","Focus","Focus ST","Fusion","Fusion Energi","Fusion Hybrid","Taurus","Transit Connect"],"GMC":["Acadia","Canyon","Sierra 1500","Sierra 2500HD","Sierra 3500HD","Terrain","Yukon","Yukon Hybrid","Yukon XL"],"Honda":["Accord","Accord Crosstour","Accord Hybrid","Accord Plug-In Hybrid","Civic","CR-V","CR-Z","Crosstour","Element","Fit","Fit EV","HR-V","Insight","Odyssey","Pilot"],"HUMMER":["H3"],"Hyundai":["Accent","Azera","Elantra","Elantra GT","Elantra Touring","Equus","Genesis","Santa Fe","Santa Fe","Santa Fe Sport","Sonata","Sonata Hybrid","Tucson","Veloster","Veracruz"],"Infiniti":["EX","EX35","FX","FX35","FX50","G Sedan","G37 Sedan","JX","M","M35","M37","M45","M56","Q40","Q50","Q70","QX","QX50","QX56","QX60","QX70","QX80"],"Jaguar":["XF","XJ"],"Jeep":["Cherokee","Commander","Compass","Grand Cherokee","Grand Cherokee SRT","Liberty","Patriot","Renegade","Wrangler"],"Kia":["Cadenza","Forte","K900","Optima","Rio","Sedona","Sorento","Soul","Soul EV","Sportage"],"Land Rover":["Discovery Sport","LR2","LR4","Range Rover","Range Rover Evoque","Range Rover Sport"],"Lexus":["CT 200h","ES 300h","ES 350","GS 350","GS 450h","GS 460","GX 460","HS 250h","IS 250","IS 350","IS F","LS 460","LS 600h L","LX 570","NX 200t","NX 300h","RX 350","RX 450h"],"Lincoln":["MKC","MKS","MKT","MKX","MKZ","MKZ Hybrid","Navigator","Town Car"],"Mazda":["CX-5","CX-7","CX-9","Mazda2","Mazda3","Mazda5","Mazda6","Mazdaspeed3","Tribute"],"Mercedes-Benz":["B-Class Electric Drive","C-Class","CLA-Class","CLS-Class","E-Class","G-Class","GL-Class","GLA-Class","GLK-Class","M-Class","R-Class","S-Class"],"Mercury":["Grand Marquis","Mariner","Mariner Hybrid","Milan","Milan Hybrid","Mountaineer"],"MINI":["Cooper","Cooper Clubman","Cooper Countryman","Cooper Coupe","Cooper Paceman"],"Mitsubishi":["Eclipse","Endeavor","Galant","i-MiEV","Lancer","Lancer Evolution","Lancer Sportback","Mirage","Outlander","Outlander Sport"],"Nissan":["Altima","Altima Hybrid","Armada","Cube","Juke","Leaf","Maxima","Murano","Murano CrossCabriolet","NV200","Pathfinder","Quest","Rogue","Rogue Select","Sentra","Versa","Versa Note","Xterra"],"Pontiac":["G6","Vibe"],"Porsche":["Cayenne","Macan","Panamera"],"Ram":["C/V Cargo Van","C/V Tradesman","CV Tradesman","Dakota","ProMaster City"],"Rolls-Royce":["Ghost","Phantom"],"Saab":["41885","41887","9-3 Griffin","9-4X"],"Scion":["iQ","tC","xB","xD"],"smart":["fortwo"],"Subaru":["Forester","Impreza","Impreza WRX","Legacy","Outback","Tribeca","WRX","XV Crosstrek"],"Suzuki":["Equator","Grand Vitara","Kizashi","SX4"],"Tesla":["Model S","Model X"],"Toyota":["4Runner","Avalon","Avalon Hybrid","Camry","Camry Hybrid","Corolla","FJ Cruiser","Highlander","Highlander Hybrid","Land Cruiser","Matrix","Prius","Prius c","Prius Plug-in","Prius v","RAV4","RAV4 EV","Sequoia","Sienna","Tacoma","Tundra","Venza","Yaris"],"Volkswagen":["Beetle","CC","e-Golf","GLI","Golf","Golf R","Golf SportWagen","GTI","Jetta","Jetta GLI","Jetta Hybrid","Jetta SportWagen","New Beetle","Passat","Routan","Tiguan","Touareg"],"Volvo":["C30","S40","S60","S80","V50","V60","V70","XC60","XC70","XC90"]}
/**
 * Description
 * @method getMakes
 * @return CallExpression
 */
VehicleModel.getMakes=function(){
    return Object.keys(VehicleModel.vehicleData)
}
/**
 * Description
 * @method getModels
 * @param {} make
 * @return LogicalExpression
 */
VehicleModel.getModels=function(make){
    return VehicleModel.vehicleData[make]||[]
}

module.exports=VehicleModel;
}
__bootstrap__.templates["app/data/aboutus.html"] = "<div  class=`fit-vp-content aboutus-wrap` style=`text-align: center;`>[NL] <img src=`app/theme/assets/contactus-mock.png` align=`center` style=`border:1px solid #ccc;height:100%;width:auto;`/>[NL]</div>"
__bootstrap__.templates["app/data/admin-dashboard.html"] = "[NL]<div class=`admin-dashboard`>[NL] <div class='chart-cont chart-cont1'></div><div class='chart-cont chart-cont2'></div><div class='chart-cont chart-cont3'></div>[NL] <div class='chart-small-wrap'>[NL] <div class='chart-small-cont chart-small-cont1'></div><div class='chart-small-cont chart-small-cont2'></div><div class='chart-small-cont chart-small-cont3'></div><div class='chart-small-cont chart-small-cont4'></div><div class='chart-small-cont chart-small-cont5'></div><div class='chart-small-cont chart-small-cont6'></div>[NL] </div>[NL][NL]</div>"
__bootstrap__.templates["app/data/appauth.html"] = "<div class=`app-auth`>[NL] <form class=`app-auth-form` action=`javascript:void(0)`>[NL] <br/>[NL] <div> User Id</div>[NL] <input type=`text` class=`app-auth-loginid`  placeholder=`User id` autofocus=`autofocus` name=`auth_loginid` id=`auth_loginid`   style=`display:block;text-shadow:1px 1px 1px #ccc;background:white;border:1px solid #ccc;color:#333color:#333;padding:0 5px; font-size:1.2rem;line-height:2;width:16rem;border-radius:5px;`/>[NL] <div> Password</div>[NL] <input type=`password` class=`app-auth-pw` placeholder=`Password`   name=`auth_pw` id=`auth_pw`   style=`display:block;text-shadow:1px 1px 1px #ccc;background:white;border:1px solid #ccc;color:#333color:#333;padding:0 5px; font-size:1.2rem;line-height:2;width:16rem;border-radius:5px;`/>[NL][NL] <div id=`login-msg` class=`login-msg` style=`text-align:center;color:red;`></div>[NL][NL] <div style=`text-align:right;margin-top:5px;padding-right:5px;clear:both;height:30px;`>[NL] <span style=`float:left;` class=`app-auth-forgot-pw`>forgot password?</span>[NL] <button class=`app-auth-enter` type=`submit` style=`float:right;height: 1.8em;background:#f3f3f3; border: 2px solid #999; color: #333;padding: 1px 10px;color:#fff; background:#7AC548;border-color:#7AC548;` >Enter</button>[NL] </div>[NL] <div class=`app-auth-acts` >[NL] <span  class=`app-auth-new-account` onclick=`app.promptNewAccount()`>Create New Account</span>[NL] </div>[NL] </form>[NL]</div>"
__bootstrap__.templates["app/data/capacity.html"] = "<div>[NL] <span>Monday</span><span>Tuesday</span><span>Wednesday</span><span>Thursday</span><span>Friday</span><span>Saturday</span><span>Sunday</span>[NL] <span class='slot'>1AM</span><span class='slot'>2AM</span><span class='slot'>3AM</span><span class='slot'>4AM</span><span class='slot'>5AM</span><span class='slot'>6AM</span><span class='slot'>7AM</span><span class='slot'>8AM</span><span class='slot'>9AM</span><span class='slot'>10AM</span><span class='slot'>11AM</span><span class='slot'>0PM</span><span class='slot'>1PM</span><span class='slot'>2PM</span><span class='slot'>3PM</span><span class='slot'>4PM</span><span class='slot'>5PM</span><span class='slot'>6PM</span><span class='slot'>7PM</span><span class='slot'>8PM</span><span class='slot'>9PM</span><span class='slot'>10PM</span><span class='slot'>11PM</span>[NL]</div>"
__bootstrap__.templates["app/data/claimcheck.html"] = "[NL]<div class=`claim-check  view-content`>[NL][NL] <div class=`schedule-info-reservenum`  z-bind=`reservenum`></div>[NL] <div class=`user-bar-code`>[NL] </div>[NL][NL] <div class=`vehicle-info info-section`>[NL] <div class=`user-name`>[NL] <span class=`info-val` z-bind=`user.fullname`></span>[NL] </div>[NL] <img class=`vehicle-info-img info-val` src=`{{userVehicle.imgpath}}`/>[NL] <span class=`info-val` z-bind=`userVehicle.vehicle_plate`></span>[NL] <span class=`info-val` z-bind=`userVehicle.vehicle_make`></span>[NL] <span class=`info-val` z-bind=`userVehicle.vehicle_model`></span>[NL] </div>[NL] <div class=`schedule-info info-section`>[NL] <div class=`blue_bar`    z-bind=`schedule.reserveDate`></div>[NL] <div class=`info-val operator-name`  z-bind=`operator.name`></div>[NL] <div class=`info-val`  z-bind=`facility.name`></div>[NL] <div class=`garage-info-address info-val` >{{facility.address==facility.name?'':facility.address}}</div>[NL] <div class=`schedule-info-times`>[NL] <span class=`schedule-info-starttime info-val`  z-bind=`schedule.reserveDateTime`  z-format=`hh:nn tt` ></span> <span class=`rightarrow`>&hyphen;</span><span class=`rightarrow2`>&rtrif;</span> <span class=`schedule-info-endtime info-val`  z-format=`hh:nn tt` z-bind=`schedule.reserveDateTimeEnd`></span>[NL] </div>[NL] <div class=`info-val-label`>Duration</div>[NL] <div class=`schedule-info-duration info-val`  z-bind=`schedule.formattedDuration`></div>[NL][NL] <div class=`timerview`>[NL][NL] </div>[NL] </div>[NL]<div class=`user-reserve-info info-section`>[NL] <div class=`blue_bar` style=`background-color: #185799`>PRICING</div>[NL] <label>DURATION</label><span class=`info-val` z-bind=`schedule.reserveDuration`></span>[NL] <label>COST</label><span class=`info-val` z-type=`currency` z-bind=`reservecost`></span>[NL] <label>EXTRAS</label> <span class=`info-val` z-type=`currency` z-bind=`pricing.extratotal`></span>[NL] <label>PRESET TIP</label><span class=`info-val` z-type=`currency` z-bind=`pricing.calctip`></span>[NL] <label>PROMO/COUPON</label><span class=`info-val` z-bindto=`pricing.promocoupon`></span>[NL][NL] <div class=`payment-info info-section`>[NL] <div class=`blue_bar final-amount`>[NL] <span class=`lbl`>Total</span><span class=`gold val` z-type=`currency` z-bind=`reserveprice`></span>[NL] </div>[NL][NL] </div>[NL][NL] </div>[NL]</div>"
__bootstrap__.templates["app/data/defaultLayout.html"] = "<!DOCTYPE html>[NL]<view model>[NL][NL]</view>"
__bootstrap__.templates["app/data/extendtime.html"] = "[NL][NL]<div class=`extend-time`>[NL] <h4 style=`margin-top:4px`>Scheduled Time</h4>[NL] <span class=`scheduled-time`> {{scheduledTime}}</span>[NL][NL] <h4>Change To </h4>[NL] <div class=`extend-time-new clear-fix`>[NL] <label class=`form-label` > Date </label>[NL] <date-time-input class=`form-ip` format=`mm/dd/yyyy` style=`border:1px solid #666;line-height: 1.7;` z-model=`newreserveDate`></date-time-input>[NL] <label class=`form-label` >Time </label>[NL] <date-time-input class=`form-ip` format=`hh:nn tt` style=`border:1px solid #666;line-height: 1.7;` z-model=`newreserveTime`></date-time-input>[NL] </div>[NL] <h4>Change Duration</h4>[NL] <div class=`extend-time-extend`>[NL] <time-duration class=`form-ip` z-model=`extendTime`/>[NL] </div>[NL][NL]</div>"
__bootstrap__.templates["app/data/fav.html"] = "[NL]<div class=`fav`>[NL] <div class='fav-hdr'>[NL] <div class='fav-hdr-tabs'>[NL] <label data-typ='1' class='selected'>Favorites</label>[NL] <label data-typ='4'>History</label>[NL] <label data-typ='6'>Reservations</label>[NL][NL] </div>[NL] <input class='fav-search fxtx_25' placeholder='Search' type='search'/></div>[NL] <div class='fav-hdr-shadow'></div>[NL] <div class='list-container'></div>[NL]</div>"
__bootstrap__.templates["app/data/garage.html"] = "<div  z-scope=`garage`>[NL]<header class=`garage-hdr masthead`>[NL]<div class=`info`>[NL] <div class=`info-part burger`><a href=`#`>menu</a></div>[NL] <div class=`info-part logo`><a href=`dashboard`>logo</a></div>[NL] <div class=`info-part weather`>[NL][NL] </div>[NL] <div class=`clockbox`>[NL] <span class=`month`>{{currentdate.mmm}} </span><span class=`day`>{{currentdate.dd}}</span><span>,</span><span class=`time`><span[NL] class=`hour`>{{currentdate.hh}}</span><span>:</span><span class=`minute`>{{currentdate.nn}}</span><span[NL] class=`meridiem`>{{currentdate.TT}}</span> </span>[NL] </div>[NL]<div  class=`facility-info`><div class=`operatorname`>{{operator}}</div> <span  class=`facilityname`>{{name}}</span></div>[NL]</div>[NL] <nav>[NL] <ul>[NL] <li class=`fxtx_25 dashboard` data-cmd=`cmd_garagehome`><span class=`icon`></span><span class=`text`>dashboard</span></li>[NL] <li class=`fxtx_25 checkin` data-cmd=`cmd_garagecheckin`><span class=`icon`></span><span   class=`text`>checkin</span></li>[NL] <li class=`fxtx_25 checkout`  data-cmd=`cmd_garagecheckout`><span class=`icon`></span><span class=`text`>checkout</span></li>[NL] <li class=`fxtx_25 pricing` data-cmd=`cmd_garagepricing` > <span class=`icon`></span><span class=`text`>pricing</span> </li>[NL] <li class=`fxtx_25 reports`  data-cmd=`cmd_garagereports` ><span class=`icon`></span><span class=`text`>Settings</span></li>[NL] <li class=`fxtx_25 browser`  data-cmd=`cmd_garagebrowser` ><span class=`icon`></span><span class=`text`>Browser</span></li>[NL][NL] <li class=`fxtx_25 user`   z-onclick=`useroptions` title=`{{user.fullname}}`><span class=`icon`></span><span class=`text`>{{user.fullname}}</span></li>[NL][NL] <li class=`fxtx_25 search` data-cmd=`cmd_garagesearch`><span class=`icon`></span><span class=`text`>search</span></li>[NL] </ul>[NL] <div class=`user-info`>[NL] <span class=`user-name` >ver:{{user.appversion}}</span>[NL] </div>[NL] </nav>[NL] </header>[NL]<section class=`slots`>[NL] <div class=`slot total`><span class=`quantity`>{{total}}</span><span class=`name`>Total Slots</span></div>[NL] <div class=`slot available`><span class=`quantity`>{{available}}</span><span class=`name`>Available Slots</span></div>[NL] <div class=`slot upcoming`><span class=`quantity`>{{upcoming}}</span><span class=`name`>Upcoming Reservations</span></div>[NL] <div class=`slot notifications`><span class=`quantity`>{{notification}}</span><span class=`name`>Notifications</span></div>[NL] <div class=`slot messages`><span class=`quantity`>0</span><span class=`name`>Messages</span></div>[NL] <!--div.slot.auxillary--></section>[NL][NL]</div>[NL]"
__bootstrap__.templates["app/data/garagebrowser.html"] = "<div class=`grid-container`>[NL][NL][NL]</div>"
__bootstrap__.templates["app/data/garagecheckin2.html"] = "[NL][NL][NL]<div class=`garagecheckin container`>[NL] <form id=`checkin` class=`checkin-form`>[NL] <section class=`checkin box`>[NL] <header><h2>Check-In</h2></header>[NL] <div class=`group`>[NL] <header class=`headers`><h3>Member</h3>[NL][NL] <h3>Non-Member</h3></header>[NL] <legend>Member</legend>[NL][NL] <fieldset  form=`checkin` class=`member module`>[NL] <img src=`app/theme/assets/barcode-placeholder.png` width=`100` height=`100` class=`check-in-scan bar-scan-img`   z-onclick=`checkinscan`>[NL][NL] <span>[NL] or[NL] </span>[NL][NL] <div class=`input`>[NL] <div class=`check-in-find-options`>[NL] <label><input class=`user-search` type=`checkbox` z-onchange=`toggleusersearch`/> Search By Name</label>[NL] </div>[NL][NL] <input class=`check-in-find`  placeholder=`Search For Reservations/users` type=`search`/>[NL] <button class=`check-in-find-user-link` type=`button` >Find</button>[NL] <span class=`searchcnt`   z-bind=`searchcnt`></span>[NL] </div>[NL] </fieldset>[NL] <legend>Non-Member</legend>[NL] <fieldset form=`checkin` class=`non-member-checkin non-member module`>[NL] <div class=`fields`>[NL] <div class=`input select`><select class=`plate_num_state` placeholder=`State` z-bind=`platenumstate` value=`NY` z-options=`stateOptions`><option value=``>-states-</option></select>[NL] </div>[NL] <span>&mdash;</span>[NL][NL] <div class=`input license-number`><input class=`plate_num` type=`text` placeholder=`Enter License Plate` z-onkeyup=`platenumkey`></div>[NL] <button type=`button` class=`non-member-link default`  z-onclick=`nonmembercheckin`>Enter</button>[NL] </div>[NL] </fieldset>[NL] </div>[NL] </section>[NL] <section class=`check-in-info parking-vehicle-info  `>[NL] <div class=`parking-info box module`>[NL] <header><h2>Parking Information</h2></header>[NL] <fieldset name=`Parking Information` form=`checkin`>[NL] <div class=`nonmember-info`>[NL] <div class=`row`><label>First Name</label><div class=`input`><input  type=`text` class=`val user-firstname` z-bind=`user.firstname` placeholder=`First Name`/></div></div>[NL] <div class=`row`><label>Last Name</label><div class=`input`><input  type=`text` class=`val user-lastname` z-bind=`user.lastname` placeholder=`Last Name`/></div></div>[NL] <div class=`row`><label>Email</label><div class=`input`><input  type=`text` class=`val user-email` z-bind=`user.email` placeholder=`Email`/></div></div>[NL] <div class=`row`><label>Phone Num</label><div class=`input`><input  type=`text` class=`val user-phonenumber` z-bind=`user.phonenumber` placeholder=`Phone number`/></div></div>[NL] </div>[NL][NL] <div class=`row license-plate`><label for=`License Plate`>License Plate</label>[NL] <div class=`input`><input type=`text` id=`License Plate` z-bind=`vehicle_plate` class=`vehicle-plate` placeholder=`Select the license`></div>[NL] </div>[NL] <div class=`row coupon`><label for=`Coupon`>Coupon</label>[NL] <div class=`input`><input type=`text` id=`Coupon` placeholder=`Enter coupon code if available`></div>[NL] </div>[NL][NL] <div class=`row alternate-rate`><label for=`AlternateRate`>Alternate Rate</label>[NL][NL] <div class=`input select`><select class=`val` name=`AlternateRate`>[NL] <option value=`1`>Alternate Rate1</option>[NL] <option value=`2`>Alternate Rate2</option>[NL] <option value=`3`>Alternate Rate3</option>[NL] </select></div>[NL] </div>[NL][NL] <div class=`row`><label>Time In</label>[NL] <div class=`input` style=`text-align: left;display:inline-block;`>[NL] <span   class=`val` z-bind=`schedule.reserveDateTime` z-format=`hh:nn tt` style=`width:12rem`></span>[NL] <select class=`val val-duration` value=`1` z-bindto=`schedule.duration` style=`font-family:'open sans';padding:0 5px;width:5rem;border:  1px solid #ccc;`><option value=`0.5`>�</option><option value=`1`>1</option><option value=`2`>2</option><option value=`3`>3</option><option value=`4`>4</option><option value=`5`>5</option><option value=`6`>6</option><option value=`7`>7</option><option value=`8`>8</option><option value=`9`>9</option><option value=`10`>10</option><option value=`11`>11</option><option value=`12`>12</option><option value=`13`>13</option><option value=`14`>14</option><option value=`15`>15</option><option value=`16`>16</option><option value=`17`>17</option><option value=`18`>18</option><option value=`19`>19</option><option value=`20`>20</option><option value=`21`>21</option><option value=`22`>22</option><option value=`23`>23</option><option value=`24`>24</option></select>[NL] <select class=`val val-duration-type` z-bindto=`schedule.durationType`  style=`padding:0 5px;width:10rem;border: 1px solid #ccc;`><option value=`h` selected=`selected`>Hr(s)</option><option value=`d`>Day(s)</option><option value=`m`>Mnth(s)</option></select>[NL] </div>[NL] </div>[NL] <div class=`row`><label>EST Price</label><div class=`input`><input class=`val est_price val` readonly=`readonly` z-format=`currency` z-bind=`reserveprice`/></div></div>[NL] <div class=`row`><label>Slot </label><div class=`input`><input class=`val checkin-slot` readonly=`readonly` z-onclick=`checkinslot` z-bind=`reserveSlot.slotname`/></div></div>[NL] </fieldset>[NL] </div>[NL] <div class=`group`>[NL] <div class=`vehicle-info box module`>[NL] <header>[NL] <h2>Vehicle Information</h2></header>[NL] <fieldset name=`Vehicle Information` form=`checkin` class=`vehicle-info`>[NL] <div class=`row`><label for=`vehicle_make`>Vehicle Make</label>[NL] <div class=`input select`><select class=`val vehicle-make` z-bind=`vehicle_make` name=`vehicle_make`><option value=``>-Make-</option></select></div>[NL] </div>[NL] <div class=`row`><label for=`vehicle_model`>Model </label>[NL][NL] <div class=`input select`><select class=`val vehicle-model` z-bind=`vehicle_model` name=`vehicle_model`> </select></div>[NL] </div>[NL] <div class=`row`><label for=`vehicle_type`>Vehicle Type</label>[NL] <div class=`input select`><select class=`val vehicle-type` z-bind=`vehicle_type` name=`vehicle_type`><option  value=``>-Type-</option><option value=`sml`>Small</option><option value=`med`>Medium</option><option  value=`lrg`>Large</option><option  value=`suv`>SUV</option><option  value=`lux`>Luxury</option><option  value=`spr`>Sports Car</option><option  value=`exo`>Exotic</option></select></div>[NL] </div>[NL] <div class=`row`><label for=`vehicle_year`>Year </label>[NL][NL] <div class=`input select`><select class=`val vehicle-year` z-bind=`vehicle_year` name=`vehicle_year`> </select></div>[NL] </div>[NL] <div class=`row`><label for=`vehicle_color`>Color </label>[NL] <div class=`input select`><select class=`val vehicle-color` z-bind=`vehicle_color` name=`vehicle_color`> </select></div>[NL] </div>[NL] <div class=`vehicle-widget-img` >[NL] <img class=`fxtx_5` z-src=`{{vehicleimgpath}}` src=`../app/theme/assets/defaultvehicle.png`/>[NL] </div>[NL] </fieldset>[NL] </div>[NL] <div class=`controls`>[NL] <button type=`button` name=`reset` class=`member-link-reset grey` z-onclick=`doreset`>Reset</button>[NL] <button type=`button` name=`check-in-button` class=`garage-link member-link-confirm default`  z-onclick=`docheckin`>Complete Check In</button>[NL] </div>[NL] </div>[NL] </section>[NL] </form>[NL]</div>"
__bootstrap__.templates["app/data/garagecheckout.html"] = "<div class=`garagecheckout`>[NL][NL]<div class=`col col1`>[NL] <h3><span class=`lbl`>Check Out</span></h3>[NL] <div class=`check-out-find-wrap`>[NL] <div class=`check-out-find-options`>[NL] </div>[NL] <input class=`check-out-find`  placeholder=`Search` type=`search`/><span class=`searchcnt`   z-bind=`searchcnt`></span>[NL][NL] <div class=`check-out-scan` >[NL] <div class=`scanned-code`></div>[NL] </div>[NL][NL] </div>[NL] <h3><span class=`lbl`>User Information</span></h3>[NL] <div class=`showonselection garage-user-info`>[NL] <div class=`userq` z-bind=`user.fullname`></div>[NL] <div class=`vehicle-info`>[NL][NL] </div>[NL] </div>[NL]</div>[NL]<div class=`col col2`>[NL] <h3><span class=`lbl`>Cost</span></h3>[NL] <div class=`showonselection task-list`>[NL] <h4>Tasks</h4>[NL] <div class=`extra-service`>[NL] </div>[NL][NL] </div>[NL] <div class=`showonselection checkout-bar`>[NL] <button class=`checkout-link checkout-link-member` z-onclick=`checkoutmember`>Checkout</button>[NL] <button class=`checkout-link checkout-link-cash` z-onclick=`checkoutmembercash`>Check-out CASH</button>[NL] <button class=`checkout-link checkout-link-cc`  z-onclick=`checkoutmembercc`>Check-out CC</button>[NL] <button class=`checkout-link checkout-link-monthly`  z-onclick=`checkoutmembermonthly`>Check-out MONTHLY</button>[NL][NL] </div>[NL][NL] <div class=`reservecard-wrap showonselection`>[NL] {{>reservecard}}[NL] </div>[NL][NL] </div>[NL]</div>"
__bootstrap__.templates["app/data/garagedashboard.html"] = "[NL]<div class=`garagedashboard`>[NL] <div class='layout-panel-content db-wrap'>[NL] <div class='db-row db-row1'>[NL] <div class='db-cell db-trend'><div class='db-content'></div></div>[NL] <div class='db-cell db-check-in'><div class='db-content'></div></div>[NL] </div>[NL] <div class='db-row db-row2'>[NL][NL] <div class='db-cell db-space-mng'><div class='db-content'></div></div>[NL] </div>[NL] </div>[NL] </div>"
__bootstrap__.templates["app/data/garagepricing.html"] = "[NL]<div zscope=`garage-pricing` class=`garage-pricing`>[NL] <div class='garage-info' style='position: relative;border-top: 1px solid #888;'>[NL] <div class='garage-info-tab garage-rates'>[NL] <h4 class='form-hdr'>Rate Sheet</h4>[NL] <div  class='form-body'></div>[NL] <div class='grid-footer form-ftr'><button class=`ui-button`>Save</button></div>[NL] </div>[NL] <div class='garage-info-tab garage-rates-alt'>[NL] <h4 class='form-hdr'>Alternate Rate Sheet</h4>[NL] <div  class='form-body'></div>[NL] <div class='grid-footer form-ftr'><button class=`ui-button`>Save</button></div>[NL] </div>[NL] <div class='garage-info-tab garage-spec-rates'>[NL][NL] </div>[NL][NL]</div>[NL]</div>"
__bootstrap__.templates["app/data/garagereports.html"] = "<div>[NL] Reports[NL]</div>"
__bootstrap__.templates["app/data/garagesearch.html"] = "<div class=`grid-container`>[NL][NL][NL]</div>"
__bootstrap__.templates["app/data/garagesettings.html"] = "[NL]<div zscope=`garage-settings` class=`garage-settings`>[NL]<div class='contact-form' style=''></div>[NL]<div class='garage-info' style='position: relative;border-top: 1px solid #888;'>[NL] <div class='garage-info-tab slot-groups' ></div>[NL] <div class='garage-info-tab garage-slots'></div>[NL] <div class='garage-info-tab garage-staff'></div>[NL] <div class='garage-info-tab garage-extras'></div>[NL] <div class='garage-info-tab garage-monthly'></div>[NL]</div>[NL]</div>"
__bootstrap__.templates["app/data/garagespacemngmnt.html"] = "[NL][NL][NL]<div class=`capacity-grid`>[NL][NL]</div>"
__bootstrap__.templates["app/data/garagestats.html"] = "<div class=`monitor-map`>[NL][NL]</div>"
__bootstrap__.templates["app/data/header.html"] = "<section class=`top-header light-blue-colorbg`  z-scope=`userviewheader`>[NL] <header class=`masthead`>[NL] <div class=`info`>[NL] <div class=`burger`><a href=`#`>menu</a></div>[NL] <div class=`logo`><a href=`dashboard`>logo</a></div>[NL] <div class=`weather`><span class=`counter`><span class=`num`>75</span><span>&deg;</span></span><span[NL] class=`graphic`><img src=`assets/weather-graphic.png` height=`25` width=`25`></span></div>[NL] <div class=`clockbox`><span class=`month`>May </span><span class=`day`>15, </span><span class=`time`><span[NL] class=`hour`>1</span><span>:</span><span class=`minute`>20</span><span[NL] class=`meridiem`> PM</span></span></div>[NL] </div>[NL] <nav>[NL] <ul>[NL] <li class=`dashboard`><a href=`dashboard`><span class=`icon`></span><span class=`text`>dashboard</span></a>[NL] </li>[NL] <li class=`checkin`><a href=`checkin` class=` active`><span class=`icon`></span><span[NL] class=`text`>checkin</span></a></li>[NL] <li class=`checkout`><a href=`checkout`><span class=`icon`></span><span class=`text`>checkout</span></a>[NL] </li>[NL] <li class=`pricing`><a href=`pricing`><span class=`icon`></span><span class=`text`>pricing</span></a></li>[NL] <li class=`reports`><a href=`reports`><span class=`icon`></span><span class=`text`>reports</span></a></li>[NL] <li class=`user`><span class=`icon`></span><span class=`user-name text`>{{user.name}}</span><span class=`user-logout` data-cmd=`signOut`>{{app.user.id?`logoutX`:`Sign in`}}</span><span class=`app-version`>{{user.appversion}}</span></li>[NL] <li class=`search`><a href=`search`><span class=`icon`></span><span class=`text`>search</span></a></li>[NL] </ul>[NL] </nav>[NL] </header>[NL][NL] <!--<div style=`position:fixed;top:0;left:50px;width:auto;height:auto;color:white;font-size:.8rem;font-weight: 100;` class=`system_noti`></div>[NL] <span class=`nav-back`>&lt;</span><span class=`app-out-msg`>..</span>[NL] <img class=`logo` src=`app/theme/assets/start-up-logo-small.png` data-cmd=`home`/>[NL] <span class=`page-title`>ParcMate</span>[NL] <div class=`social-links`>[NL] <div class=`social-links-label`style=`font-size:.8rem;font-style: italic;  line-height: .9;`>follow us</div>[NL] <a href=`http://facebook.com/parcmate` class=`sm-link` target=`_blank`><img src=`/theme/img/icon-fb.png` alt=`facebook`></a>[NL] <a href=`http://twitter.com/parcmate` class=`sm-link` target=`_blank`><img src=`/theme/img/icon-twitter.png` alt=`twitter`></a>[NL] <a href=`https://plus.google.com/u/3/?_ga=1.85828636.462837917.1431336585` class=`sm-link`  target=`_blank`><img src=`/theme/img/icon-gplus.png` alt=`gplus`></a>[NL] </div>[NL] <span class=`user-info`><span class=`user-name`>{{user.name}}</span><span class=`user-logout` data-cmd=`signOut`>{{app.user.id?`logoutX`:`Sign in`}}</span><span class=`app-version`>{{user.appversion}}</span></span>[NL] <div class=`app-notifications-link`><div class=`app-notifications-count`>?</div> </div>[NL] <span class=`ham-burger app-menu`> </span>[NL]</section>"
__bootstrap__.templates["app/data/landing.html"] = "[NL] <div class=`landing` style=``>[NL] <div class=`landing-links` style=``>[NL] <div class=`landing-link landing-header`><img style=`height:auto;` src=`app/theme/assets/landing/headerlogo.png`/></div>[NL] <div class=`landing-link  landing-header-links landing-act`   >[NL] <img  class=`leftph` src=`app/theme/assets/landing/headerleft.png`/>[NL] <img class=`landing-header-link landing-header-link-signin` data-cmd=`signin` src=`app/theme/assets/landing/loginlink.png`/>[NL] <img class=`landing-header-link landing-header-link-signup`data-cmd=`signup` src=`app/theme/assets/landing/signup.png`/>[NL] <span class=`landing-header-link landing-header-link-location link-img2` z-onclick=`showlocations` ></span>[NL] <img  class=`rightph` src=`app/theme/assets/landing/headerright.png`/>[NL] </div>[NL] <div class=`landing-app-links` style=`height:80%`>[NL] <div class=`landing-link landing-act`  >[NL] <img  class=`leftph` src=`app/theme/assets/landing/left1.png`/>[NL] <img class=`link-img` data-cmd=`checkin` src=`app/theme/assets/landing/mytab.png`/>[NL] <img class=`link-img link-img2` data-cmd=`userselections` src=`app/theme/assets/landing/findagarage.png`/>[NL] <img class=`rightph` src=`app/theme/assets/landing/right1.png`/>[NL] </div>[NL] <div class=`landing-link landing-act`  >[NL] <img  class=`leftph` src=`app/theme/assets/landing/left2.png`/>[NL] <img class=`link-img` data-cmd=`fav` src=`app/theme/assets/landing/fav.png`/>[NL] <img class=`link-img link-img2` data-cmd=`notifications` src=`app/theme/assets/landing/notifications.png`/>[NL] <img  class=`rightph` src=`app/theme/assets/landing/right2.png`/>[NL] </div>[NL] <div class=`landing-link landing-act` >[NL] <img  class=`leftph` src=`app/theme/assets/landing/left3.png`/>[NL] <img class=`link-img` data-cmd=`myaccount` src=`app/theme/assets/landing/account.png`/>[NL] <img class=`link-img link-img2` data-cmd=`contactus` src=`app/theme/assets/landing/contactus.png`/>[NL] <img  class=`rightph` src=`app/theme/assets/landing/right3.png`/>[NL] </div>[NL] <div class=`landing-footer` >[NL][NL] </div>[NL][NL] </div>[NL]</div>"
__bootstrap__.templates["app/data/mapfilter.html"] = "[NL]<div class=`map-filters`>[NL] <div class=`val-row`>[NL] <span class=`val-label`>Covered Parking</span><span  class=`val-val`><select data-key=`covered_parking` class=`val-covered_parking`><option value=``> </option><option value=`1`>Yes</option><option value=`0`>No</option></select></span>[NL] </div>[NL] <div class=`val-row`>[NL] <span class=`val-label`>Credit Cards Accepted</span><span class=`val-val`><select data-key=`cc` class=`val-cc`><option value=``> </option><option value=`1`>Yes</option><option value=`0`>No</option></select></span>[NL] </div>[NL] <div class=`val-row`>[NL] <span class=`val-label`>Open 24 Hours</span><span class=`val-val`><select data-key=`open24` class=`val-open24`><option value=``> </option><option value=`1`>Yes</option><option value=`0`>No</option></select></span>[NL] </div>[NL] <div class=`val-row`>[NL] <span class=`val-label`>Maximum Rate/hour</span><span class=`val-val`>$<input  data-key=`maxrate` class=`val-maxrate` min=`1` step=`.5` type=`number`/><span class=`maxrate-cancel`>X</span></span>[NL] </div>[NL][NL] <button class=`filter-apply`>Apply</button>[NL][NL]</div>"
__bootstrap__.templates["app/data/misha.html"] = "<!DOCTYPE html>[NL]<html>[NL][NL]<head>[NL] <meta charset=`utf-8`>[NL] <meta name=`viewport` content=`width=device-width, initial-scale=1.0`>[NL] <link rel=`stylesheet` href=`misha.css`>[NL][NL]</head>[NL]<body class=`checkin`>[NL]<header class=`masthead`>[NL] <div class=`info`>[NL] <div class=`burger`><a href=`#`>menu</a></div>[NL] <div class=`logo`><a href=`dashboard`>logo</a></div>[NL] <div class=`weather`><span class=`counter`><span class=`num`>75</span><span>&deg;</span></span><span[NL] class=`graphic`><img src=`assets/weather-graphic.png` height=`25` width=`25`></span></div>[NL] <div class=`clockbox`><span class=`month`>May </span><span class=`day`>15, </span><span class=`time`><span[NL] class=`hour`>1</span><span>:</span><span class=`minute`>20</span><span[NL] class=`meridiem`> PM</span></span></div>[NL] </div>[NL] <nav>[NL] <ul>[NL] <li class=`dashboard`><a href=`dashboard`><span class=`icon`></span><span class=`text`>dashboard</span></a>[NL] </li>[NL] <li class=`checkin`><a href=`checkin` class=` active`><span class=`icon`></span><span[NL] class=`text`>checkin</span></a></li>[NL] <li class=`checkout`><a href=`checkout`><span class=`icon`></span><span class=`text`>checkout</span></a>[NL] </li>[NL] <li class=`pricing`><a href=`pricing`><span class=`icon`></span><span class=`text`>pricing</span></a></li>[NL] <li class=`reports`><a href=`reports`><span class=`icon`></span><span class=`text`>reports</span></a></li>[NL] <li class=`user`><a href=`user`><span class=`icon`></span><span class=`text`>user</span></a></li>[NL] <li class=`search`><a href=`search`><span class=`icon`></span><span class=`text`>search</span></a></li>[NL] </ul>[NL] </nav>[NL]</header>[NL]<section class=`slots`>[NL] <div class=`slot total`><span class=`quantity`>500</span><span class=`name`>Total Slots</span></div>[NL] <div class=`slot available`><span class=`quantity`>240</span><span class=`name`>Available Slots</span></div>[NL] <div class=`slot upcoming`><span class=`quantity`>10</span><span class=`name`>Upcoming Reservations</span></div>[NL] <div class=`slot notifications`><span class=`quantity`>2</span><span class=`name`>Notifications</span></div>[NL] <div class=`slot messages`><span class=`quantity`>0</span><span class=`name`>Messages</span></div>[NL] <!--div.slot.auxillary--></section>[NL]<div class=`container`>[NL] <form id=`checkin` class=`checkin-form`>[NL] <section class=`checkin box`>[NL] <header><h2>Check-In</h2></header>[NL] <div class=`group`>[NL] <header class=`headers`><h3>Member</h3>[NL][NL] <h3>Non-Member</h3></header>[NL] <legend>Member</legend>[NL] <fieldset id=`member` form=`checkin` class=`member module`><img src=`assets/barcode-placeholder.png`[NL] width=`100` height=`100`[NL] class=`bar-scan-img`><span>or</span>[NL][NL] <div class=`input`><input type=`search` placeholder=`Search for ParcMate User`>[NL] <button type=`button` class=`search`></button>[NL] </div>[NL] </fieldset>[NL] <legend>Non-Member</legend>[NL] <fieldset form=`checkin` class=`non-member module`>[NL] <div class=`fields`>[NL] <div class=`input select`><select name=`State`>[NL] <option value=`State`>State</option>[NL] <option value=`1`>1</option>[NL] <option value=`2`>2</option>[NL] <option value=`3`>3</option>[NL] <option value=`4`>4</option>[NL] <option value=`5`>5</option>[NL] </select></div>[NL] <span>&mdash;</span>[NL][NL] <div class=`input license-number`><input type=`text` placeholder=`Enter License Plate`></div>[NL] <button type=`button` class=`default`>Enter</button>[NL] </div>[NL] </fieldset>[NL] </div>[NL] </section>[NL] <section class=`parking-vehicle-info`>[NL] <div class=`parking-info box module`>[NL] <header><h2>Parking Information</h2></header>[NL] <fieldset name=`Parking Information` form=`checkin`>[NL] <div class=`row license-plate`><label for=`License Plate`>License Plate</label>[NL][NL] <div class=`input`><input type=`text` id=`License Plate` placeholder=`Select the license`></div>[NL] </div>[NL] <div class=`row coupon`><label for=`Coupon`>Coupon</label>[NL][NL] <div class=`input`><input type=`text` id=`Coupon` placeholder=`Enter coupon code if available`>[NL] </div>[NL] </div>[NL] <div class=`row`><label for=`Time In`>Time In</label>[NL][NL] <div class=`time-selection`>[NL] <div class=`timer`><span class=`counter input`><span[NL] class=`hour`>12</span><span>:</span><span class=`minute`>33</span><span[NL] class=`meridiem`> AM</span></span></div>[NL] <div class=`input select`><select name=`1;00`>[NL] <option value=`Select Duration`>Select Duration</option>[NL] <option value=`1:30`>1:30</option>[NL] <option value=`2:30`>2:30</option>[NL] <option value=`3:30`>3:30</option>[NL] </select></div>[NL] </div>[NL] </div>[NL] <div class=`row alternate-rate`><label for=`Alternate Rate`>Alternate Rate</label>[NL][NL] <div class=`input select`><select name=`Alternate Rate`>[NL] <option value=`1`>Alternate Rate1</option>[NL] <option value=`2`>Alternate Rate2</option>[NL] <option value=`3`>Alternate Rate3</option>[NL] </select></div>[NL] </div>[NL] <div class=`row slot-name`><label for=`Slot`>Slot</label>[NL][NL] <div class=`input`><input type=`text` id=`Slot` placeholder=`The slot will autofill`></div>[NL] </div>[NL] <div class=`row est-cost`><label for=`EST Cost`>EST Cost</label>[NL][NL] <div class=`input`><input type=`text` id=`EST Cost` placeholder=`The price will autofill`></div>[NL] </div>[NL] </fieldset>[NL] </div>[NL] <div class=`group`>[NL] <div class=`vehicle-info box module`>[NL] <header><h2>Vehicle Information</h2></header>[NL] <fieldset name=`Vehicle Information` form=`checkin` id=`vehicle-info`>[NL] <div class=`row`><label for=`Vehicle Make `>Vehicle Make </label>[NL][NL] <div class=`input select`><select name=`Vehicle Make `>[NL] <option value=`1`>Vehicle Make 1</option>[NL] <option value=`2`>Vehicle Make 2</option>[NL] <option value=`3`>Vehicle Make 3</option>[NL] </select></div>[NL] </div>[NL] <div class=`row`><label for=`Model `>Model </label>[NL][NL] <div class=`input select`><select name=`Model `>[NL] <option value=`1`>Model 1</option>[NL] <option value=`2`>Model 2</option>[NL] <option value=`3`>Model 3</option>[NL] </select></div>[NL] </div>[NL] <div class=`row`><label for=`Year `>Year </label>[NL][NL] <div class=`input select`><select name=`Year `>[NL] <option value=`1`>Year 1</option>[NL] <option value=`2`>Year 2</option>[NL] <option value=`3`>Year 3</option>[NL] </select></div>[NL] </div>[NL] <div class=`row`><label for=`Color `>Color </label>[NL][NL] <div class=`input select`><select name=`Color `>[NL] <option value=`1`>Color 1</option>[NL] <option value=`2`>Color 2</option>[NL] <option value=`3`>Color 3</option>[NL] </select></div>[NL] </div>[NL] </fieldset>[NL] </div>[NL] <div class=`controls`>[NL] <button type=`reset` name=`reset` class=`grey`>Reset</button>[NL] <button type=`submit` name=`submit` class=`default`>Complete Check In</button>[NL] </div>[NL] </div>[NL] </section>[NL] </form>[NL]</div>[NL]<footer></footer>[NL]</body>[NL]<Xcr ipt src=`https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js`></Xcr ipt>[NL]<Xcr ipt src=`js/modal.js`></Xcr ipt>[NL]<Xcr ipt src=`js/app.js`></Xcr ipt>[NL]</html>"
__bootstrap__.templates["app/data/myaccount.html"] = "[NL][NL]<form class=`fit-vp-height myaccount`>[NL]<div class=`fxtx error-message`></div>[NL] <h2>Basic Information</h2>[NL]<dl>[NL] <div class=`pic-wrap`>[NL] <img data-key=`pic` style=`height:90px;` src=`{{pic}}`  class=`user-pic`>[NL] <div  class='pic-bar' style='text-align: center'>[NL] <button class='ui-button small smaller'  type='button' data-key='snap'>Snap</button>[NL] <span class='for-upload-file' style='position:relative;overflow:hidden;'>[NL] <button  class='ui-button small smaller'type='button' data-key='upload' style='z-index:1; '>Upload</button>[NL] </span>[NL] </div>[NL] </div>[NL] <dt> First Name </dt>[NL] <dd>[NL] <input required z-bindto=`firstname`/>[NL] </dd>[NL] <dt> Middle Name </dt>[NL] <dd>[NL] <input   z-bindto=`middlename`/>[NL] </dd>[NL] <dt> Last Name </dt>[NL] <dd>[NL] <input required z-bindto=`lastname`/>[NL] </dd>[NL] <dt> Date of Birth </dt>[NL] <dd>[NL] <input type=`date` z-bindto=`dob`/>[NL] </dd>[NL] <dt> Email </dt>[NL] <dd>[NL] <input required type=`email` z-bindto=`email` value=``/>[NL] </dd>[NL] <dt> Phone Number </dt>[NL] <dd>[NL] <input type=`phone` z-bindto=`phonenumber` value=``/>[NL] </dd>[NL] </dl>[NL]<h2>Vehicles</h2>[NL]<dl class=`vehicle-list`>[NL]<dt> Primary Vehicle </dt>[NL]<dd class=`user-vehicle`>[NL][NL]</dd>[NL] <div class=`add-more add-more-vehicle`>[+]Add More</div>[NL]</dl>[NL]<h2>Account/Payment Information</h2>[NL]<dl>[NL] <dt> Account Number </dt>[NL] <dd>[NL] <input z-bindto=`account_num`value=``/>[NL] </dd>[NL] <h4>Credit Card 1 </h4>[NL] <dt> Name on Card </dt>[NL] <dd class=`nameoncard`>[NL] <input z-bindto=`firstname_on_card` value=``/> <input z-bind=`lastname_on_card` value=``/>[NL] </dd>[NL] <dt> Card Number </dt>[NL] <dd>[NL] <input z-bindto=`card_number` value=``/>[NL] </dd>[NL] <dt> Expiration Date</dt>[NL] <dd class=`expiration`>[NL] <input z-bindto=`expiration_month`  placeholder=`MM` pattern=`[0-1][0-9]` style=`width:3rem`/><input placeholder=`YY`  pattern=`[1-3][0-9]` z-bindto=`expiration_year` style=`width:3rem`/>[NL] </dd>[NL] <dt> Billing Address</dt>[NL] <dd class=`billingaddress`>[NL] <input z-bindto=`billing_city` placeholder=`city`  value=``/><input z-bindto=`billing_state` placeholder=`state`  value=``/><input z-bindto=`billing_country` placeholder=`country`  value=``/>[NL] <input z-bindto=`billing_zipcode` placeholder=`zip` value=``/>[NL] </dd>[NL] <div class=`add-more`>[+]Add More</div>[NL]</dl>[NL]<div style=`text-align: right`><a href=`http://parcmate.com/pmr/Parcmate.apk` target=`_blank`>Deploy Android App</a></div>[NL] <div style=`text-align: center;margin-bottom: 20px;`>[NL] <button type=`submit` class=`save-account`>Save</button>[NL]</div>[NL][NL]</form>"
__bootstrap__.templates["app/data/pagecontent.html"] = "<div  class=`page-content defBg static-header`>[NL] <div class=`content-outer` style=`opacity: 1;`>[NL][NL] </div>[NL] <!--<footer class=`footer`>[NL] <a href=`#`>Copyright</a><a  href=`#`>About us</a><a   href=`#`>Privacy Policy</a><a href=`#`>Contact Us</a><a href=`#`>Partners</a><span>build:{BUILD}</span>[NL] </footer>-->[NL]</div>"
__bootstrap__.templates["app/data/partialtest.html"] = "<div>[NL] sssssss[NL][NL]</div>"
__bootstrap__.templates["app/data/pricing_tips.html"] = "<div  class=`val-row-tips`>[NL]<div  class=`val-row val-row-tips`>[NL] <span class=`val-label`>TIPS</span>[NL] <span class=`val` z-type=`currency` z-bind=`pricing.calctip`></span>[NL]</div>[NL]<span class=`val-wrap pricing-tips`>[NL] <span class=`val light-blue-colorbg` z-bindto=`schedule.tip`>5%</span>[NL] <span class=`val light-blue-colorbg` z-bindto=`schedule.tip`>10%</span>[NL] <span class=`val light-blue-colorbg` z-bindto=`schedule.tip`>15%</span>[NL] <input class=`val light-blue-colorbg`  z-target=`schedule.tip` max=`100` min=`1` step=`.5` placeholder=`Other` type=`number` />[NL] </span>[NL] </div>"
__bootstrap__.templates["app/data/qrtest.html"] = "[NL]<div id=`camera`>[NL] <button class=`camera-control` >CapturePhoto</button>[NL] <div style=`text-align: center; margin: 20px;`>[NL] <img id=`cameraPic` src=`` style=`width: auto; height: 120px;`>     <img>[NL] </div></div>[NL]"
__bootstrap__.templates["app/data/receipt.html"] = "[NL]<div class=`receipt view-content`>[NL] <section  class=`section-bg`>[NL] <img src=`app/theme/assets/logo.jpg`/>[NL] </section>[NL] <div class=`reserve-info`>[NL] <div class=`schedule-info-reservenum`  z-bind=`reservenum`></div>[NL][NL] <div class=`schedule-info info-section`>[NL] <div class=`blue_bar`    z-bind=`schedule.reserveDate`></div>[NL] <div class=`info-val operator-name`  z-bind=`operator.name`></div>[NL] <div class=`info-val`  z-bind=`facility.name`></div>[NL] <div class=`garage-info-address info-val` >{{facility.address==facility.name?'':facility.address}}</div>[NL] <div class=`schedule-info-times`>[NL] <span class=`schedule-info-starttime info-val`  z-bind=`schedule.reserveDateTime`  z-format=`hh:nn tt` ></span> <span class=`rightarrow`>&hyphen;</span><span class=`rightarrow2`>&rtrif;</span>[NL] <span class=`schedule-info-endtime info-val`  z-format=`hh:nn tt` z-bind=`schedule.reserveDateTimeEnd`></span>[NL] </div>[NL] <div class=`info-val-label`>Duration</div>[NL] <div class=`schedule-info-duration info-val`  z-bind=`schedule.actualDuration`></div>[NL][NL] <div class=`timerview`>[NL][NL] </div>[NL] </div>[NL]<div class=`user-reserve-info info-section`>[NL] <div class=`blue_bar` style=`background-color: #185799`>PRICING</div>[NL] <label>DURATION</label><span class=`info-val` z-bind=`schedule.actualDuration`></span>[NL] <label>COST</label><span class=`info-val` z-type=`currency` z-bind=`reservecost`></span>[NL] <label>EXTRAS</label> <span class=`info-val` z-type=`currency` z-bind=`pricing.extratotal`></span>[NL] <label>PRESET TIP</label><span class=`info-val` z-type=`currency` z-bind=`pricing.calctip`></span>[NL] <label>PROMO/COUPON</label><span class=`info-val` z-bindto=`pricing.promocoupon`></span>[NL][NL] <div class=`payment-info info-section`>[NL] <div class=`blue_bar final-amount`>[NL] <span class=`lbl`>Total</span><span class=`gold val currency-val` title=`{{pricing.rateDescription}}` z-type=`currency` z-bind=`reserveprice`></span>[NL] </div>[NL][NL] </div>[NL][NL] </div>[NL]</div>[NL] </div>"
__bootstrap__.templates["app/data/reservecard.html"] = "[NL]<div class=`reserve-card`>[NL][NL] <div class=`schedule-info-reservenum`  z-bind=`reservenum`></div>[NL][NL] <div class=`schedule-info info-section`>[NL] <div class=`blue_bar`   z-bind=`schedule.reserveDate`></div>[NL] <div class=`info-val operator-name`  z-bind=`operator.name`></div>[NL] <div class=`info-val`  z-bind=`facility.name`></div>[NL] <div class=`garage-info-address info-val` >{{facility.address==facility.name?'':facility.address}}</div>[NL] <div class=`schedule-info-times`>[NL] <span class=`schedule-info-starttime info-val` z-format=`hh:nn tt`  z-bind=`schedule.entry_time`></span>[NL] <span class=`rightarrow`>&Rightarrow;</span><span class=`rightarrow2`></span> <span class=`schedule-info-starttime info-val`  z-format=`hh:nn tt` z-bind=`schedule.exit_time`></span>[NL] </div>[NL] <div class=`info-val-label`>Duration</div>[NL] <div class=`schedule-info-duration info-val`  z-bind=`schedule.actualDuration`></div>[NL][NL] <div class=`timerview`>[NL][NL] </div>[NL] </div>[NL]<div class=`user-reserve-info info-section`>[NL] <div class=`blue_bar`>PRICING</div>[NL] <label>DURATION</label><span class=`info-val` z-bind=`schedule.actualDuration`></span>[NL] <label>COST</label><span class=`info-val  pricing-val {{priceupdate==1?'refreshing':''}}` z-type=`currency` z-bind=`reservecost`></span>[NL] <label>EXTRAS</label> <span class=`info-val` z-type=`currency` z-bind=`extratotal`></span>[NL] <label>PRESET TIP</label><span class=`info-val` z-type=`currency` z-bind=`calctip`></span>[NL] <label>PROMO/COUPON</label><span class=`info-val` z-bindto=`pricing.promocoupon`></span>[NL] <label>ALTERNATE RATE</label><input  type=`number` step=`.25` class=`info-val` z-bindto=`manualprice` placeholder=`Enter an alternate amount`/>[NL][NL] <!--<div class=`user-reserve-info-name  info-section-title` z-bind=`member.name` ></div>[NL] <div class=`car-img` >[NL] </div>[NL] <div class=`car-info `>[NL] <div><label>Model</label><span class=`info-val vehicle-info-make`  z-bind=`userVehicle.vehicle_make`></span></div>[NL] <div><label>Plate</label><span class=`info-val vehicle-info-plate` z-bind=`userVehicle.vehicle_plate`></span></div>[NL] <div><label>Year</label> <span class=`info-val vehicle-info-plate` z-bind=`userVehicle.vehicle_year`></span></div>[NL] <div><label>Color</label><span class=`info-val vehicle-info-color` z-bind=`userVehicle.vehicle_color`></span></div>[NL] </div>-->[NL] <div class=`payment-info info-section`>[NL] <div class=`blue_bar final-amount`>[NL] <span class=`lbl`>Total</span><span class=`gold val   pricing-val {{priceupdate==1?'refreshing':''}}` z-type=`currency` z-bind=`reserveprice`></span>[NL] </div>[NL]<hr/>[NL] <label for=`non-member-payment-simulate` class=`non-member-payment-simulate-label`>Simulate Non Member</label><input type=`checkbox` class=`non-member-payment-simulate` id=`non-member-payment-simulate`/>[NL] <div class=`fxtx make-final-payment`>[NL] <div class=`blue_bar final-payment`>[NL] Make Payment[NL] </div>[NL] <img src=`app/theme/assets/cc-images.png`>[NL] </div>[NL] </div>[NL][NL] </div>[NL]</div>"
__bootstrap__.templates["app/data/reservecard2.html"] = "[NL]<div class=`reserve-card2`>[NL] <section  class=`section-bg`>[NL] <img src=`app/theme/assets/logo.jpg`/>[NL] </section>[NL] <div class=`reserve-info`>[NL] <div class=`reserve-hdr`>[NL] <span class=`schedule-info-resstatusString`  z-bind=`resstatusString`></span>[NL] <span class=`schedule-info-reservenum`  z-bind=`reservenum`></span>[NL] </div>[NL] <div class=`loc-map info-section`>[NL] </div>[NL] <div class=`user-bar-code`>[NL] </div>[NL] <div class=`schedule-info info-section`>[NL] <div class=`schedule-info-startdate info-val`  z-bind=`schedule.reserveDateTime`  z-format=`dddd, mmm dd, yyyy, hh:nn tt` ></div>[NL] <div><span class=`schedule-info-duration info-val` z-bind=`schedule.formattedDuration`></span>[NL] </div>[NL] <div class=`running-time`><div class=`running-time-slider`></div><div class=`running-time-message`></div></div>[NL] </div>[NL] <div class=`facility-info info-section`>[NL] <div class=`garage-name  info-section-title` z-bind=`facility.name` ></div>[NL] <div><span class=`info-val`  z-bind=`operator.name`></span></div>[NL] <div class=`garage-address`  z-bind=`facility.address`></div>[NL] <span>Slot:</span><span class=`info-val`  z-bind=`reserveSlot.slotname`> </span>[NL] <div class=`facility-services-info info-section cf`>[NL] <h5>Extra/Premium Services</h5>[NL] <ul class='srvc-items'>[NL][NL] </ul>[NL] </div>[NL] </div>[NL][NL] <div class=`user-reserve-info info-section`>[NL] <div class=`user-reserve-info-name  info-section-title` z-bind=`user.fullname` ></div>[NL] <div class=`car-info`>[NL] <div><label>Model</label><span class=`info-val vehicle-info-make`  z-bind=`userVehicle.vehicle_make`></span><span class=`info-val vehicle-info-model`  z-bind=`userVehicle.vehicle_model`></span><span class=`info-val vehicle-info-plate` z-bind=`userVehicle.vehicle_year`></span><span class=`info-val vehicle-info-color` z-bind=`userVehicle.vehicle_color`></span></div>[NL] <div><label>Plate</label><span class=`info-val vehicle-info-plate` z-bind=`userVehicle.vehicle_plate`></span></div>[NL] </div>[NL][NL] <div class=`rate-info`>[NL] Amount: <span class=`rate-info-rate info-val` z-format=`currency` z-bind=`reserveprice`></span>[NL] <span class=`info-val`  z-bind=`reserveslot.slotname`> </span>[NL] </div>[NL] </div>[NL]<div class=`reserve-actions`>[NL][NL]</div>[NL] </div>[NL]</div>"
__bootstrap__.templates["app/data/splash.html"] = "[NL]<div class=`app-splash`[NL] style=`top: 0; left: 0; width: 100%; height: 99.5%; position: absolute;background: radial-gradient(ellipse at center, rgba(90,180,244,1) 0%,rgba(7,101,183,1) 100%);text-align: center;`>[NL] <img src=`app/theme/assets/start-up-logo2.png` />[NL] <div class=`app-auth`>[NL] <form class=`app-auth-form` action=`javascript:void(0)`>[NL] <div> User Id</div>[NL] <input type=`text` class=`app-auth-loginid` autofocus=`true` placeholder=`User id`  autofocus=`autofocus` name=`auth_loginid` id=`auth_loginid`   style=`display:block;text-shadow:1px 1px 1px #ccc;background:white;border:1px solid #ccc;color:#333color:#333;padding:0 5px; font-size:1.2rem;line-height:2;width:16rem;border-radius:5px;`/>[NL] <div> Password</div>[NL] <input type=`password` class=`app-auth-pw` placeholder=`Password` autocomplete=`off`  name=`auth_pw` id=`auth_pw`   style=`display:block;text-shadow:1px 1px 1px #ccc;background:white;border:1px solid #ccc;color:#333color:#333;padding:0 5px; font-size:1.2rem;line-height:2;width:16rem;border-radius:5px;`/>[NL][NL] <div id=`login-msg`  class=`login-msg` style=`text-align:center;color:red;`></div>[NL][NL] <div style=`text-align:right;margin-top:5px;padding-right:5px;clear:both;height:30px;`>[NL] <span style=`float:left;` class=`app-auth-forgot-pw`>forgot password?</span>[NL] <button class=`app-auth-enter` type=`submit` style=`float:right;height: 1.8em;background:#f3f3f3; border: 2px solid #999; color: #333;padding: 1px 10px;color:#fff; background:#7AC548;border-color:#7AC548;` >Enter</button>[NL] </div>[NL] <div class=`app-auth-acts` >[NL] <span  class=`app-auth-new-account` onclick=`app.promptNewAccount()`>Create New Account</span>[NL] </div>[NL] </form>[NL] <div id=`auth__link` style=`cursor:pointer;top:100px;font-size:.9em;color:#fff;text-align:center;text-shadow:1px 1px 1px #fcfcfc;`>Login</div>[NL] </div>[NL]</div>[NL]<div id=`vhcheck` style=`position:absolute;left:1px;height:100vh;top:0;width:1px`>.</div>[NL]<div id=`calccheckvh` style=`position:absolute;left:1px;height:calc(100vh - 1px);top:0;width:1px`>.</div>[NL]<div id=`calccheck` style=`position:absolute;left:1px;height:calc(100% - 1px);top:0;width:1px`>.</div>"
__bootstrap__.modules["UI.Calendar"] = function(module){
var PopupView= $.require("PopupView");
    self.UI||(self.UI={}),

 UI.Calendar=(function CAL( ) {
    function getDateData(dt, opts) {
        var monthdate = $.date(dt) || $.date()
         var st = monthdate.trunc().clone(), currmonth = monthdate.month
        st.date = 1
        st.date -= st.day
        opts = opts || {}
         var filter = opts.dateFilter || function () { }
        var list=$.A.fill([],function(){
            var d = st.clone(),m=st.month;
             d.daytype=[
                (d.day == 0 || d.day == 6) ? "cal-weekend" : (m === currmonth ? "cal-weekday" : ""),
                filter(d) === false ? "cal-cell-disabled" : "",
                 m === currmonth ? "cal-currmonth" : (m < currmonth ? "cal-priormonth" : "cal-nextmonth"),
                (+st == +monthdate)?"cal-current-date":"",
            ].join(" ").trim()
            st.date++
            return d;
        },42)

        return {
            list:list,
            start:monthdate,
            currentdate:monthdate
        }
    }

    function buildContent(list, template) {
         var fin = []
        list.groupBy(function(a,i){return Math.floor(i/7)+1}).each(
            function(days,wk){
                fin.push(
                    "<div class='cal-week-row' data-key='" + wk + "'>",
                        days.map(template).join(""),
                    "</div>"
                )
            }
        )
         return fin
     }

    return function (dt, opts) {
        var options = opts || {}
        var hdrtemplate = $.simpleTemplate("<span  class='cal-cell-hdr' data-key='$day'>$ddd</span>"),
            template = $.simpleTemplate("<span  class='cal-week-cell $daytype' data-key='$long'><span class='cal-week-cell-label'>$dd</span></span>")

        var data=getDateData(dt, options)
        var hdrs = [
            "<div class='cal-label-hdr'>" ,
                "<span class='nav-link nav-prevyear'>&lt;&lt;</span><span class='nav-link nav-prevmonth'>&lt;</span>",
                "<span class='cal-labels'><div class='cal-month'>November</div><div class='cal-year'>2020</div></span>" ,
                "<span class='nav-link nav-nextyear'>&gt;&gt;</span><span class='nav-link nav-nextmonth'>&gt;</span>" ,
            "</div>",
            "<div class='cal-wkhdr'>" ,
                data.list.slice(0,7).map(hdrtemplate).join("") ,
            "</div>"
        ].join("")

        var pop, container=$d(options.container)
        if(!container){
            var popvw = $.require("PopupView");
            pop = new popvw($.extend({draggable: true, minWidth: 250, minHeight: 240,  resizable: true,offset:20,   title: options.title||"Calendar",anchor:options.ip||options.anchor},options.viewoptions||{}))
            container=pop.$content()
            pop.show()
        }
        var activeData={}
        function render(dt,datedata){
            if(datedata && !datedata.list){datedata=null}
            if(!datedata){
                datedata = getDateData(dt, options)
            }
            activeData=datedata;
            var cntnt=buildContent(activeData.list, template).join("")
            container.q(".cal-body").html(cntnt);
            container.q(".cal-month").html(activeData.start.mmm);
            container.q(".cal-year").html(activeData.start.yyyy);
            pop && pop.layout();
        }
        container.html( hdrs + "<div class='cal-body'></div>")
        container.q(".cal-label-hdr").on("click", function (ev, el) {
            if (el) {
                var nudate,curr=activeData.start
                if(!curr){return}
                nudate=curr.clone()
                 if(el.is(".nav-nextyear")){
                     nudate.year++;
                 } else if(el.is(".nav-prevyear")){
                     nudate.year--;
                 } else if(el.is(".nav-prevmonth")){
                     nudate.month--;
                 } else if(el.is(".nav-nextmonth")){
                     nudate.month++;
                 }else{
                     return
                 }
                render(nudate)
             }
        }, ".nav-link")
        container.q(".cal-body").on("click", function (ev, el) {
             if(opts.onselect){
                opts.onselect($.date(+el.domdata("key")))
            }

        }, ".cal-week-cell:not(.cal-cell-disabled)")
        render(dt,data)
        return {
            view:pop,
            container:container,
            hide:function(){
                pop?pop.hide():container.hide()
            },
            show:function(){  pop?pop.show():container.show() },
            render:function(dt){
                this.show();  render(dt);
                return this
            }
        }
    }
})();

module.exports=UI.Calendar
}
__bootstrap__.modules["DataGrid"] = function(module){
/*
     fitLayout
     pageSize
     resizable
     colresizable
     sortable
     highlightcolumn
     */
    var         //gridLayout="FIT",
        cntntwrapLayout  = (
                "<div class='grid-frame-header'>" +
                    "<div class='grid-info'><span class='grid-tools grid-title'></span><span class='grid-tools page-info'></span><span class='grid-tools columns-info'></span><span class='grid-tools grid-edit-menu'></span><span class='grid-tools grid-layout-menu'></span><span class='grid-tools'></span></div>" +
                    "<div class='ui-button-bar   ui-button-bar-right clear-fix'></div>" +
                "</div>" +
                "<div class='gridwrap'>" +
                    "$content" +
                "</div>" +
                "<div class='grid-footer'>" +
                    "<span class='msg'></span>" +
                "</div>"
            ),
        cntntLayout  = (
            "<table class='grid-tab'>" +
                "<colgroup>$colset</colgroup>" +
                "<caption>$caption</caption>" +
                "<thead class='grid-header'>" +
                "<tr class='grid-row'>$headercells</tr>" +
                "</thead>" +
                "<tbody class='grid-rowset'></tbody>" +
                "</table>"
            ),
        blockcntntLayout  = (
            "<div class='grid-tab'>" +
                "<span>$colset</span>" +
                "<caption>$caption</caption>" +
                "<div class='grid-rowset'></div>" +
                "</div>"
            ),
        landmarks={
                cols:"title,item,top,stub,img,lat,lng,tpe,thumb".split(/\,/)  ,
            url:"js/nyclandmarks.json"
        },
        pagerparts={
            firstpage:"<button data-key='1' type='button' title='first page'>&lt;&lt;</button>",
            lastpage:"<button data-key='-1' type='button' title='last page'>&gt;&gt;</button>",
            priorpage:"<button data-key='previous' type='button' title='previous page'>&lt;</button>",
            nextpage:"<button data-key='next' type='button' title='next page'>&gt;</button>",
            pageno:"<input value='$pageno' style='width:25px;'/>",
           loadmsg:"<img class='fxtx2 loadericon' style='float:left;visibility:hidden;margin-left:20px;margin-right:20px;height:32px;width:32px;' src='theme/img/bx_loader.gif'/>" +
                "<span class='fxtx2 loadmsg' style='margin-left:20px;float:left;min-width:20px;width:auto;'></span>"},
        pagertemplate  = (
            "<div class='grid-pager'>" +
                "$firstpage $priorpage $pageno $nextpage $lastpage of $totalpages ,rows $startrow to $endrow of $totalrows $loadmsg".split(/\s+/).map(function(it){
                     var ky=it.replace(/\$/,"");
                    return ("<span  class='grid-pager-text grid-pager-text-"+ky+"'>"+(it=="$"?"":it)+"</span>")
                        .replace(/\$([\w]+)/g,function(a,b){return pagerparts[b]||a})
                }).join("&nbsp;")+
                //replace(/\$([\w]+)/g,"<span class='grid-pager-text grid-pager-text-$1'>$1</span>") +
                "</div>"

            );

    var rowht=23 ,Core,Dom ,_gridoverlay,hdrwdoffst= 2,_arrayEach=function(clctn,fn){
        [].forEach.call(clctn,fn);
    },ZINDEX={BUTTONBAR:2,FILTER:1,FREEZEOVERLAY:1,FREEZEOVERLAYHDR:1,FREEZEBODY:1,FOOTERBAR:2,HDRCLONE:1,FRAMEHDR:1,GRIDHEADER:1   }
    function getOverlay(trgt){
        var rbnd=trgt.getBoundingClientRect();
        if(!_gridoverlay){
            _gridoverlay=document.body.appendChild(document.createElement("div"));
            _gridoverlay.style.cssText="background-color:#ccc;position:absolute;display:block;z-index:21;opacity:.1;left:"+rbnd.left+"px;top:"+rbnd.top+"px;height:"+rbnd.height+"px;width:"+rbnd.width+"px;"
        }
        _gridoverlay.style.cssText+="left:"+rbnd.left+"px;top:"+rbnd.top+"px;height:"+rbnd.height+"px;width:"+rbnd.width+"px;"
        return _gridoverlay;
    }
    function _rowModel(grid){
        var rowModelKlass=null,_grid=grid
        function _resolve(val){
            var id,ctx={}
            if(val) {
                if (val.__isgridcontext) {
                    ctx = val
                }
                else {
                    if (typeof(val)=="number") {ctx.id=val }
                    else if (!val.nodeType && val.id) {
                        ctx.id=val.id

                    }else if (val.nodeType ) {
                        ctx.row  = $d.selfOrUp(val,".grid-row");
                     }
                    if(!ctx.id&&ctx.record) {
                        ctx.id=ctx.record.id
                    }
                    if(ctx.id&&!ctx.row) {
                        ctx.row = _grid.domcomponents.gridWrap.q(".grid-row[data-id='" + ctx.id + "']");
                    }
                    if(!ctx.id&&ctx.row) {
                        ctx.id=ctx.row.domdata("id")
                    }
                    if(ctx.id&&!ctx.record) {
                        ctx.record=_grid.store.getList(true).findById(ctx.id)
                    }
                }
            }
            return ctx
        }
        return function rowModel(rw){
            if(!rowModelKlass){
                rowModelKlass=$.model.make({
                        record:null,el:null,
                        row:{get:function(){return this.el&&this.el.selfOrUp(".grid-row")}},
                        table:{get:function(){return this.el&&this.el.up(".grid-tab")}},
                        id:{get:function(){return this.record&&this.record.id}},
                        grid:null,
                        meta:{get:function(){return this.record&&this.record.meta }}
                    },{
                    findDomRow:function(id){
                        if(!id){return null}
                        if (typeof(id)=="number") {
                            return this.grid.domcomponents.gridWrap.q(".grid-row[data-id='" + id + "']");
                        }
                        else if (id.nodeType ) {
                            return  $d.selfOrup(id,".grid-row");
                        }
                    },
                    init:function(ctx){
                        this.grid=_grid
                        //if(!dom){return}
                        if(!(ctx&&ctx.row&&ctx.record)){return }//throw new Error("invaled row specs")}

                        this.record=ctx.record
                        this.el=$d(ctx.row)
                        $d.data(this.el,"_rowwidget",this)
                    } ,
                    clear:function(dom,grid,meta){
                        this.el= this.record =null
                        return this
                    },
                    isRendered:function(){
                        return this.el&&this.el.isAttached()
                    },
                    getCell:function(cel){
                        return this.grid._cellWidget(
                            this.grid.getContext(cel,{record:this.record,row:this.el,row:this.record?this.record.id:0})
                        );
                     },
                    getCells:function(cel){
                        var cells=[],meta=this.meta,cellWidget=this.grid._cellWidget.bind(this.grid)
                        if(this.row){
                            cells=$d.qq(this.row,".grid-cell")
                        }
                        if(cells.length){
                           return $d.qq(this.grid.domcomponents.gridWrap,".grid-col").map(function(c,i){
                               return cellWidget(cells[i],meta.find($d.domdata(c,"name")))
                           })
                        }
                    },
                    isInView:function(){
                        return this.el&&this.el.isInView()
                    },
                    refresh:function(data,andrender){
                        if(this.record){var ths=this
                            this.record.refresh( ).then(
                                function(){
                                    if(andrender){
                                        ths.render()
                                    }
                                }
                            )
                        }
                    },
                    save:function(data,andrender){
                        if(this.record){var ths=this
                            this.record.update(data).save().then(
                                function(){
                                    if(andrender){
                                        ths.render()
                                    }
                                }
                            )
                        }
                    },
                    render:function( ){
                        if(this.meta.size()<100 ){var rec=this.record
                            this.getCells().forEach(function(cl){
                                cl.render(rec.get(cl.name))
                            });
                            return
                        }
                         this.grid._renderer.renderSingleRow(this.record)
                        return this
                    }

                })
            }


            if(rw instanceof  rowModelKlass){return rw}
            var ctx=_resolve(rw)
            if(ctx && ctx.row && $d.data(ctx.row,"_rowwidget")){return $d.data(ctx.row,"_rowwidget")}
            if(!(ctx && ctx.row)){return null}
            var nu=new rowModelKlass(ctx,_grid )
            if(nu.row){
                nu.el=nu.row
                $d.data(nu.row,"_rowwidget",nu)
            }

            return nu
        }
        rowModel.resolve=_resolve
        return rowModel;
    }
    function _cellWidget(grid,contentclass){
        var kls=null,_grid=grid
        return function(cl0,meta){
            if(!kls){
                kls=Klass({
                    properties:{
                        meta:null
                        ,content:{get:function(){return (this.el&&contentclass)?this.el.selfOrDown(contentclass):this.el}},
                        row:{get:function(){return this.el&&this.el.up(".grid-row")}},
                        cell:{get:function(){return this.el}},
                        tab:{get:function(){return this.el&&this.el.up(".grid-tab")}},
                        container:null,
                        record:{get:function(){
                            if(this.__record){return this.__record}
                            if(this.container&&this.container.getRow) {
                                var rowmodel = this.container.getRow(this.row||this.el.parent())
                                if (rowmodel && rowmodel.record) {
                                    return rowmodel.record
                                }
                            }
                            return null
                        },set:function(v){this.__record=v}},
                        name:{get:function(){return this.meta&&this.meta.name}}
                    },
                    init:function(dom,container,meta){
                        var ctx=null;
                        this.container=container
                        if(dom&&(dom.meta||dom.column)&&dom.cell){ctx=dom;ctx.meta=ctx.meta||ctx.column}
                        else if(dom&&dom.__isgridcontext){ctx=dom}
                        else{ctx=container.getContext(dom)}
                        if(ctx&&ctx.column&&!ctx.meta){ctx.meta=ctx.column}
                        if(!(ctx&&ctx.cell&&ctx.meta)){
                            return
                            //throw new Error("invaled cell specs")
                        }
                         this.container=container
                        this.el=$d( ctx.cell)
                        this.meta=ctx.meta||ctx.column
                        if(typeof(this.meta)=="string"|| $.isPlain(this.meta)){
                            this.meta=new Data.Column(this.meta)
                        }
                        this.columnIndex=ctx.columnIndex
                    } ,
                    clear:function( ){
                        this.el= this.column=this.meta= null
                        this.columnIndex=-1
                        return this
                    },
                    getValue:function(){
                        var record=this.record
                        if( record){
                            return  record.get(this.name)
                        }
                    },
                    setValue:function(v){
                        var record=this.record
                        if( record){
                            return  record.set(this.name,v)
                        }
                        return this
                    },
                    update:function(val,andrender){
                        this.container._renderer&&this.container._renderer.pause()
                        this.setValue(this.name,val)
                        this.container._renderer&&this.container._renderer.resume()
                         if(andrender) {
                            this.render(val)
                        }
                        return this
                    },
                    render:function(val){
                        val=val==null?this.getValue():val
                        var c=this.meta?this.meta.getDisplayValue(val):val
                        if(this.meta&&this.meta.cellRenderer){
                            c=this.meta.cellRenderer(c)
                        }
                        this.content.html(c)
                        return this
                    }

                })
            }
            if(cl0&&cl0.nodeType&&$d.data(cl0,"_cellwidget")){return cl0.data("_cellwidget")}
            if(cl0 instanceof  kls){return cl0}
            return new kls(cl0,_grid,meta)
        }
    }

    var _rukesadded=0
    function addRules(){if(_rukesadded){return}
        $d.css.addRules("grid",

            {".gridtable":"overflow:hidden;",
                ".gridtable .grid-tab":"table-layout: fixed;border-collapse: collapse; min-width:99%;",
                ".gridtable.viewmode-tile .grid-header":"display:none;",
                ".gridtable.viewmode-tile tbody,.gridtable.viewmode-tile table":"display:block;",
            ".gridtable.viewmode-tile .grid-row":"  cursor: pointer; line-height:1.6;display:inline-block;vertical-align: top;padding:4px;height:auto;border:1px solid #ccc;margin:4px;border-radius:4px;overflow:hidden;",
            ".gridtable .grid-row pre":"margin:1px 0;white-space: pre-wrap;",
            ".gridtable.viewmode-block .gridwrap .grid-tab .grid-rowset .grid-row":"display: block;  padding:2px 4px;margin-bottom:10px;border-top:none;clear: both;",
            ".gridtable.viewmode-block .grid-row h2":"font-size:1.4em;line-height: 1.6;margin:0 0 2px 0;padding:0;font-weight:bold;",
            ".gridtable.scrollable .gridwrap":"position:absolute;width:100%;height:95%;top:30px;left:0;overflow:auto; ",
            ".gridtable .gridwrap .scroll-fit":"z-index:-1;position:absolute;right:0;top:0;width:1px;max-width:1px;",
            ".gridtable .gridwrap .scroll-fit div":"position:absolute;left:0;width:100%;height:20px; ",
                ".gridtable .grid-cell,.gridtable .grid-header-cell":" padding-left:2px;padding-right:0;box-sizing:border-box;",
                ".gridtable .headerclone .grid-header-cell,.gridtable thead .grid-header-cell":"height:2em",
                ".headerclone":"position:absolute;top:1px;height: 2em;z-index:1;left:0;width:auto;",
                ".gridtable .grid-frame-header,.gridtable .grid-footer":"height:30px;font-size:.9em;line-height:1.6;padding-left:5px;position:relative",
                ".gridtable.scrollable .grid-frame-header,.gridtable.scrollable .grid-footer":"position:absolute;width:100%;left:0;",
            ".gridtable.scrollable .grid-footer":"bottom:0",
            ".gridtable .grid-frame-header":"top:0;padding:2px 0;height:3em;",
            ".gridtable dl":"display:block;clear:both;padding-top:1px;position:relative;margin-bottom:2px;",
            ".gridtable dl dt":"color:gray;text-align:right;padding-right:10px;font-weight:bold;clear:left;float:left;width:150px;",
            ".gridtable dl dd":"display:block;margin-right :20px  ",
                ".gridtable .layout-options":"display:inline-block;height:24px;border-left:1px solid #ccc;margin-left:5px;padding-left:5px;float:right;",
                ".gridtable .layout-option":"cursor:pointer;",
            ".gridtable .layout-option-tile1":"background:url(../../theme/img/blockview.gif) center center no-repeat",
                ".gridtable .layout-option-table1":"background:url(../../theme/img/gridview.gif) center center no-repeat",
            ".gridtable dl dd,.gridtable  dl dt":"overflow:hidden;white-space:nowrap;text-overflow:ellipsis;height:1.6em;line-height:1.6; ",
             ".gridtable dl.cell-object-data":"width:90%; margin-left:0;margin-top:0;margin-right :0 ",
            ".gridtable dl.cell-object-data dd":"margin-right :0;  ",
            ".gridtable dl.cell-object-data dt":" max-width:50%;  ",
            ".gridtable .grid-row-wrap":" margin-bottom:5px;",
            ".gridtable.fixedheight .grid-cell .cell-content":"height:20px;max-height:20px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;",
            ".gridtable .grid-header-cell":"overflow:hidden;text-overflow: ellipsis;white-space: nowrap;border-bottom:1px solid #111",
                ".gridtable.issortable  .grid-header-cell":"cursor:pointer",
            ".col-resize-shadow":"position:absolute;z-index:20; opacity:.4;cursor:col-resize;",
            ".grid-fitLayout table":"max-width:100%  !important;min-width:98% ;width:98% ;table-layout:fixed;  ",
            ".gridtable .grid-frame-header .grid-title":"position:absolute;left:15px;top:2px;font-weight:bold;font-size: 1.2rem;",
            ".gridtable .grid-frame-header .ui-button-bar":"width:200px;position:relative;min-height:30",
            ".gridtable.zebra-col .grid-rowset .grid-row .grid-cell:nth-child(odd)":"background:$hilite-cell",
             ".gridtable.zebra-row .grid-rowset .grid-row:nth-child(odd)":"background:$zebra-row",

            ".grid-columnfreeze-overlay":"overflow: hidden; ",
            ".grid-columnfreeze-overlay .grid-row  .grid-header-cell":"border-left:none;margin-left:-1px  ; ",
                ".ui-toolbar-status-message":"font-size:.8rem;color:#666;",
                // ".gridtable .gridwrap .edit-active,.gridtable .gridwrap .edit-active .cell-content":"background-color:white;color:#111",//outline:2px solid green
          //  ".gridtable .gridwrap .edit-active-row":"background-color:#ffffee !important ",
           // ".gridtable .gridwrap .edit-active-row .edit-active .cell-content":"color:#333",
            ".gridtable .rownum":"width:20px;max-width:20px;min-width:20px;",
            ".grid-filter":"display:block;position:absolute; top:0;height:100%;width:100%;",
            ".grid-filter .grid-filter-stub":"background-image:url(  theme/filter.png);background-size:cover; width:45px;margin:3px;margin-right:15px;overflow:hidden; float:left;height: 85%; text-align: center;",
            ".grid-filter .grid-filter-content":"width:100%; height: 100%;text-align: left;cursor: pointer",
            ".grid-filter .grid-filter-content .filter-elem-wrap":"height:100%;display:inline-block;position:relative;float:left;margin:1px;margin-right:6px; min-width:60px;width:auto; border:none;overflow:hidden;white-space:nowrap; ",
            ".grid-filter .grid-filter-content .filter-elem-wrap  .filter-elem, .grid-filter .grid-filter-content .filter-elem-wrap .filter-elem_ph":"cursor:pointer;margin-right:5px;text-overflow:ellipsis;text-align:center;white-space:nowrap;z-index:1;display:block;bottom:0; line-height:1.4;padding:0 10px 0 5px;border-radius:4px;border:1px solid #ccc;",
            ".grid-filter .grid-filter-content .filter-elem-wrap  .filter-elem":"z-index:1;position:relative;visibility: hidden;max-width:150px;min-width:50px;margin-top: 12px;text-overflow: ellipsis;white-space: nowrap;overflow: hidden; ",
            ".grid-filter .grid-filter-content .filter-elem-wrap .filter-elem_ph":"z-index:2;max-width:200px;position:absolute;opacity:.8;  margin-right:30px;   line-height: 1.2;height: 1.4em;font-weight:bold;     border: none;  box-shadow: none;     text-align: left;  color:#428bca;  top:0px;left:-4px;z-index:10; font-size:.9em;width:auto; margin-left:0; background-color: transparent;background: transparent;    letter-spacing: .5em;",
            ".grid-filter .grid-filter-content .filter-elem-wrap .filter-elem_phX":"line-height: 1.2;height: 1.4em;font-weight:bold;     border: none;  box-shadow: none;     text-align: left;  color:#428bca;  top:-2px;left:-2px;z-index:10; font-size:.9em;width:auto; margin-left:0; background-color: transparent;background: transparent;    letter-spacing: .5em;",
            ".grid-filter .grid-filter-content .filter-elem-wrap.has-value.hide-ph .filter-elem_ph":"display: none !important;",
            ".grid-filter .grid-filter-content .filter-elem-wrap.has-value .filter-elem":"display:block;float:left;opacity: 1;visibility: visible",
            ".viewmode-table .grid-row":" height:2em;line-height:1.6; " ,
            ".gridwrap.nowrap table":"table-layout: auto; width:auto;",
                ".gridwrap .grid-cell":"overflow:hidden;",
            ".gridwrap.nowrap .grid-cell,.gridwrap.nowrap .grid-cell .cell-content":"white-space: nowrap;",
            ".gridtable .nodata-msg":"position:absolute; width:160px;text-align: center;padding:0;left:50%;top:50%;margin-left:-80px;margin-top:-30px",
            ".gridtable   .nodata-msg .content":"border:2px outset #333;height:40px;line-height:35px; vertical-align: middle",
            ".filter-elem-wrap .filter-elem-remove":"opacity:.1;display:block;position:absolute;color:red;cursor:pointer;text-align:right;right:2px;top:1px;line-height:8px;height:8px;width:8px;z-index:20;",
            ".filter-elem-wrap:hover .filter-elem_ph:hover .filter-elem-remove":"opacity:1",
            ".filter-elem-wrap .filter-elem_ph .filter-elem-remove":"font-size:1.2em;",
            ".filter-elem-wrap .filter-elem:hover .filter-elem-remove":"opacity:1" ,
                ".filter-elem-wrap:hover .filter-elem-add":"opacity:1" ,
                ".filter-elem-wrap .filter-elem-add":"z-index:1;float:left;position:relative;margin-top: 2px;text-align:center;color:green;font-weight:bold;font-size:1.1em;opacity:.3;width:14px; height:14px;",
                ".grid-column-selected":"background:$ui-darker",
                ".edit-modified":"color:blue"
        }   )
    }
    var GridRenderer=function(grid, optns){
        this.grid=grid; this.gridoptns=optns||{};
        var _saveColList,_rendered,lastRender=null
        this.isRendered=function(){return !!lastRender}
        this.pause=function pause(){this._paused=true}
        this.resume=function pause(){this._paused=false}
        this.render=function render(recs0,outer){
            if(this._paused){return}
            var g=this.grid,gridoptns=this.gridoptns,bindings={
                colset:(gridoptns.rownum?"<col/>":"")+g.cols.map(function(it){return "<col class='grid-col' data-name='"+it.dataIndex+"'/>"}).join(""),
                caption:"",
                headercells:(gridoptns.rownum?"<th class='grid-header-cell rownum'>#</th>":"")+g.cols.map(function(it){return "<th class='grid-header-cell'><div class='cell-content'>"+it.label+"</div></th>"}).join(""),
                rows:""  ,title:gridoptns.title||"Grid"

            } ,cmpo=this.grid.domcomponents;
            if(!cmpo.outer){
                cmpo.outer= $d(outer);
            }
            if(gridoptns.fitLayout){cmpo.outer.classList.add("grid-fitLayout")}
            var cntnt=(gridoptns.viewmode!="table"?blockcntntLayout:cntntLayout).replace(/\$([\w]+)/g,function(a,b){return bindings[b]||""})

            if(!cmpo.gridWrap){
                cmpo.outer.el.innerHTML=cntntwrapLayout.replace(/\$content/,cntnt ).replace(/`/g,",")
            }  else {
                cmpo.gridWrap.el.innerHTML=cntnt.replace(/`/g,",")
            }


            cmpo.gridWrap.st("li").addClass("list-row");
            //g._resize();  // cmpo.tab.style.width=cmpo.gridWrap.clientWidth+"px"
            //this.redraw()
            //setTimeout(this.grid.fire.bind(this.grid,"render"),500);
            //  cmpo.outer.style.display=""  ;
            g.observer.fireAsync("afterbuild")
        }
        this.wrapTemplate=function(content,tag){tag=tag||"div" ;var stl=""

            if(tag!="tr"){
                stl="display: block;clear:both;position: relative;border-bottom:none;"
                //width:"+((this.grid.domcomponents.gridWrap||this.grid.domcomponents.outer||{}).offsetWidth||"800")+"px"
                /*this.grid.on("afterrender resize",function(){
                    var w=this.domcomponents.gridWrap;
                    if(!this.isVisible()){this._needsRedraw=true;return}
                    w&&  w.st(".grid-row").css( {"width":w.offsetWidth+"px" })
                })*/
            }
            return ("<$tag style='"+stl+"' class='grid-row' data-id='$id'>"+ content +"</$tag>").replace(/\$tag/g,tag)
        }
        this.wrapRowTemplate=function(content,tag){tag=tag||"tr"
            if(String(content).trim().indexOf("grid-row")>-1){return content}
            return "<"+tag+" class='grid-row' data-id='$id'>"+content+"</"+tag+">"
        }
        this.getRowTemplate=function(){
            var tag="tr",tmpl= this.grid.config.viewmode=="table"?null:this.grid.config.rowtemplate
            if(!tmpl){
                tmpl= (this.gridoptns.rownum?"<td class='rownum'>$rownum</td>":"")+
                    grid.cols.map(
                        function(it){return "<td class='grid-cell'><div class='cell-content'>$"+it.dataIndex+"</div></td>"}
                    ).join("")
            } else{
                if(tmpl=="formview"){var labelwidth=this.grid.config.formlabelwidth||150
                    this.grid.config.rowtemplate=tmpl= this.grid.cols.map(function(it){
                        return "<label class='' style='float:left;width:"+(labelwidth)+"px;margin-bottom:5px;overflow:hidden;'>"+it.label+"</label><div style='margin-bottom:5px;max-width:90%'>$"+it.name+"</div>"
                    }).join("");
                }
                if(this.grid.config.wrapfieldsintemplate){
                    var m=this.grid.store.meta,fldtmpl="<$tag class='grid-cell' data-name='#name'><div class='cell-content'>$#name</div></$tag>"
                    this.grid.config.rowtemplate=  tmpl= tmpl.replace(/\$([\w]+)/g,function(a,b){
                        if(b=="id"){return a}
                        var f=m.findField(b)||{name:b}
                        if(f){var tag="div"
                            if(f.titlefield){tag="h2"}
                            return fldtmpl.replace(/#name/g, f.name).replace(/\$tag/g,tag)
                        }
                        return a
                    })
                     this.grid.config.wrapfieldsintemplate=null
                }


                tag=this.grid.config.rowtag||"div"}

            return this.wrapRowTemplate(tmpl,tag);
        }
        this.clear=function clear(rowset){if(this._paused){return}
            var bdy= rowset||this.grid.domcomponents.rowset
            var chldrn1=$.makeArray(bdy.children)
            while(chldrn1.length ){
                bdy.removeChild(chldrn1.pop())
            }
        }
        this.showNoDataMessage=function showNoDataMessage( ){
            if(this._currentcount){
                this.grid.domcomponents.gridWrap.show();return
            }
                 var msg=this.grid.config.noDataMessage||"No data found"
                if(!this.grid.nodatamsg){
                    this.grid.domcomponents.gridWrap.before("<div class='def-popup-style nodata-msg'><div class='content'></div></div>")
                    this.grid.nodatamsg=this.grid.domcomponents.outer.q('.nodata-msg')
                }
                    var st=this.grid.domcomponents.toolbar_status
                    if(st){st.clear();}
                    this.grid.domcomponents.loadmsg&& this.grid.domcomponents.loadmsg.html("&nbsp;");
                    if(this.grid.domcomponents.loadericon){
                        this.grid.domcomponents.loadericon.css("opacity",.01)
                        //this.domcomponents.loadericon.hide()
                    }

                //this.grid.domcomponents.gridWrap.hide();
                this.grid.nodatamsg.show().q(".content").html(msg)
            }
        this.renderRows=function renderRows(recs0,appnd,nothrottled){
            if(this._paused){return}
            nothrottled=true;
            var recs=recs0||this.grid.pager.getPageRecords() ,grid=this;
            if(recs && recs.data){
                recs=recs.data
            }
            if(!recs||!recs.length||(recs.length==1&&!recs[0])){
                this._currentcount=0;
                recs=[]
                this.clear();
                //this.showNoDataMessage (  )
            }
            else {
                if(this.grid.nodatamsg){this.grid.nodatamsg.hide()}
                this.grid.domcomponents.gridWrap.show();
                if(lastRender&&lastRender.length){}
                 var pr=this.grid.data("_lookupsresolve_promise")
                if(pr){
                    pr.then(function(r){
                        if(nothrottled){this.renderRows_inner(r);}
                        else{this.renderRows_inner_throttled(r);}

                        if(this.grid.nodatamsg){this.grid.nodatamsg.hide()}
                        lastRender=r
                    }.bind(this,recs)
                );
                } else {
                    this.renderRows_inner(recs);
                }
            }
            this.grid.fire("viewupdate",this.grid.pager);
        }
        this.renderRows_inner=function renderRows(recs,appnd){
            if(this._paused){return}
            var data,tmpl=this.getRowTemplate(),grid=this;;
             this._currentcount=0;
              if(recs&&recs.length){
                this._currentcount=recs.length;
                var tmpl=this.grid.store.StoreRecordProto.prepTemplate(tmpl)

                this._lastusedRowTemplate=tmpl
                data= recs.map(function(r,i){
                    if(r){r.rownum=i+1}
                    return r.applyTemplate(tmpl);
                }).join("")
                    .replace(/nan|undefined|\[object object\]|null/ig,"")


                if(!data.trim()){data=""}
                var bdy= this.grid.domcomponents.rowset ;
                var cln=document.createElement(bdy.tagName),prev=bdy.previousSibling,
                    next=bdy.nextSibling, par=bdy.parentNode,bdy1=bdy.el;//par.removeChild(bdy.el)
                var display=$d.css(par,"display");
                //
                if(!(appnd===true)){
                    this.clear(bdy1)
                }
                _rendered=1
                cln.innerHTML=data;
                var chldrn=$.makeArray(cln.children)
                par.style.display="none";
                try{
                    while(chldrn.length ){
                        bdy1.appendChild( chldrn.shift() )
                    }
                } finally{

                    par.style.display=display;
                }
                cln=null;

             }            // par.insertBefore(bdy1,next)
           // par.style.display=display||"";
            this.grid.domcomponents.outer.classList.add("viewmode-"+this.grid.config.viewmode)
              _saveColList=this.grid.cols.map(function(it){return it.name});


           this.grid.domcomponents.rowset.st(".grid-row").addClass("selectable")
            var grid=this.grid
            grid.cols.forEach(function(c){
                if(c.cellui && !$.is.empty(c.cellui)){
                    var ui=c.cellui,parstyle=null
                    if(ui.style && ui.style.background){
                        //parstyle={background:ui.style.background}
                    }
                    grid.getColumnCells(c,false,true,true).forEach(function(el){
                        $d.prop(el,ui)
                         if(parstyle){
                            $d.css($d.parent(el),parstyle)
                         }

                    });
                }
            });

              this.grid.afterRender() ;

            this.grid.fire("afterpageload",this.grid.pager);

            return this
        }//,{ delay:5 }) ;
        this.renderRows_inner_throttled=$.throttle( this.renderRows_inner.bind(this),true)
        this.findRow=function(rec){
            var id= 0,rw
            if(typeof(rec)=="number"){id=rec}
            else if(rec&&rec.nodeType){return $d.selfOrUp(".grid-row")}
            else if(rec){id=rec.id}
            if(id){
                rw= this.grid.domcomponents.gridWrap.q(".grid-row[data-id='"+id+"']");
                //var rwrec=this.grid.store.findById(id)

            }
            return rw
        }
        this.renderSingleRow=function renderSingleRow(recs){
            if(this._paused){return}
            var rec=Array.isArray(recs)?recs[0]:recs    ;if(!(rec&&rec.id>=0)){return}
            var html,ctx= this.grid.getRow(rec);
             if(ctx&&ctx.record){rec=ctx.record}
            if(ctx.row){
                if(this._lastusedRowTemplate){
                    html=this._lastusedRowTemplate.fn(rec)
                 }
                else{
                    html=rec.applyTemplate(this.getRowTemplate(),ctx.row.domIndex()+1)
                }
                var div=document.createElement("div")
                div.innerHTML="<table>"+html+"</table>"
                var nu=ctx.row.parent().insertBefore(div.querySelector("tr"),ctx.row)
                ctx.row.remove();
                ctx.row=$d(nu).addClass("selectable")
                //ctx.row.insert(html.replace(/nan|undefined|\[object object\]|null/ig,""),"replace")
            }
            this.grid.fire("viewupdate",this.grid.pager);
            return
        }
        this.redraw=function(clear){
            clear===true && this.clear();
            this.renderRows() ;
            return this
        }
        this.addrows =function _addrows( ){if(this._paused){return}
            //   var diff=this._lastDiff||0;if(!diff  ){return}
            var _all=[] , blanks=Math.min(this.pager.totalrows,Math.floor(diff/rowht))
            while(_all.length<blanks){[].push.apply(_all,this.pager.next()) }
             this.renderRows( _all,true);
        }
    }  ;
    //store selectedRecord cols
    var DataGrid=(function(){
        var _domC=function(){
            var  domcomponents={}
            Object.defineProperties(domcomponents,{
                grid:{value:this},
                outer:{value:null,writable:true,enumerable:true},
                gridWrap:{get:function(){return this.outer&&this.outer.q(".gridwrap")},set:function(){},enumerable:true},
                tabheader:{get:function(){return this.outer&&this.outer.q(".grid-header")},set:function(){},enumerable:true},
                tabheaderrow:{get:function(){return this.tabheader&&this.tabheader.tab.q(".grid-row")},set:function(){},enumerable:true},
                frameheader:{get:function(){return this.outer&&this.outer.q(".grid-frame-header")},set:function(){},enumerable:true},
                toolbar:{get:function(){if(!this.frameheader){return null}
                    var t=this.frameheader.q(".ui-button-bar")||this.frameheader.append("<div class='ui-button-bar ui-button-bar-right clear-fix' style='position: absolute; right: 1px; top: 0;    width: auto; minWidth:250,minHeight:30,text-align: right;  overflow: hidden; z-index: 1;'></div>")
                    return t
                },set:function(){},enumerable:true},

                toolbar_status:{get:function(){return this.outer&&this.outer.q(".ui-toolbar-status-message")},set:function(){},enumerable:true},
                headerclone:{get:function(){return this.outer&&this.outer.q(".headerclone")},set:function(){},enumerable:true},
                framefooter:{get:function(){return this.outer&&this.outer.q(".grid-footer")},set:function(){},enumerable:true},
                tab:{get:function(){return this.gridWrap&&this.gridWrap.q(".grid-tab")},set:function(){},enumerable:true},
                rowset:{get:function(){return this.tab&&this.tab.q(".grid-rowset")},set:function(){},enumerable:true},
                row:{value:function(idx){return this.rowset&&this.rowset.q(".grid-row:nth-child("+(idx+1)+")")},enumerable:true},
                rows:{value:function(idx){return this.rowset&&this.rowset.st(".grid-row")},enumerable:true },
                colset:{get:function(){return this.tab&&this.tab.st("col")},set:function(){},enumerable:true} ,
                loadmsg:{get:function(){return this.pagerwrap&&this.pagerwrap.q(".loadmsg")},set:function(){},enumerable:true} ,
                loadericon:{get:function(){return this.outer.q(".grid-footer .loadericon")},set:function(){},enumerable:true} ,

            pagerwrap:{get:function(){return this.outer.q(".grid-footer .msg")},set:function(){},enumerable:true} ,
                hdrInfo  :{value:function(){   var tabhdr=(this.headerclone||this.tabheader), b1=tabhdr?tabhdr.getBoundingClientRect():{},b={top: b1.top||0,height:b1.height||0,bottom:b1.bottom||0}
                    if(b.height<5&& this.tabheader && this.tabheader.dataset.savedht){b.height=+this.tabheader.dataset.savedht;b.bottom= b.top+ b.height}
                    var tt=this.outer.getBoundingClientRect().top,fr=this.frameheader,frht=fr?fr.offsetHeight: 0,
                        btm=frht?(frht+b.height):b.bottom-this.outer.getBoundingClientRect().top;
                    if(this.tabheader&&b.height>5&&!this.tabheader.dataset.savedht){this.tabheader.dataset.savedht= b.height}

                    return{
                        bottom:btm,
                        height:b.height,top:btm-b.height
                    }
                    } ,enumerable:true
                } ,
                resetscroll:{value:function resetscroll(){ var cmp=this
                    cmp.gridWrap.scrollTop=0; cmp.gridWrap.scrollLeft=0;
                    this.grid.pager.pageno=1
                },enumerable:true},
                setwidths:{value:function (st,w){ if(w&&w!="0px"&&w!="0"){st.maxWidth=st.minWidth=st.width=w}},enumerable:true},

                scrollTreshold:{value:-50},
                handleheaderSel:{value:function(ev){
                    //colresize sort or move
                    var gridctx=this.grid ,cmp=this
                    if(!(gridctx.colresizable||gridctx.sortable||gridctx.colMove)){return}
                    if($d.hasClass(cmp.outer,"resizing")){return}

                    var el=$d.hasClass(ev.target,"cell-content")?$d.parent(ev.target):ev.target,
                        dm=el.getBoundingClientRect(),act=0;
                             if(gridctx.colMove || gridctx.sortable) {
                                ev.stopPropagation && ev.stopPropagation()
                                //ev.stopImmediatePropagation && ev.stopImmediatePropagation()
                                 var sorted=0
                                $d.holdMouse2(el,{timeout:300,endonmousemove:true,
                                    onmove:function(ev){
                                        if(gridctx.sortable) {sorted=1
                                            gridctx.sortable.activate (ev,el);
                                        }
                                    },
                                    onend:function(){
                                        if(sorted){return}
                                        if(gridctx.colMove){
                                            gridctx.colMove.activate (ev,el)
                                        } else{
                                            if(gridctx.sortable) {
                                                gridctx.sortable.activate (ev,el);
                                            }
                                        }

                                     }
                                })
                             }
                         if(act) {
                            cmp.outer.classList.add("resizing")
                            $d(document).on("mouseup",function _mmup(ev){
                                cmp.outer.classList.remove("resizing");
                                $d(document).off("mouseup",_mmup);
                            })
                        }
                }
                }
            });


            this.domcomponents=domcomponents;
        }
        var _proto={panel:null,store:null,el:null}
        _proto.init= function( store,optn ){
            addRules();
            var gridOptns=Object.create(null),optns=Object(optn||{});
            this._cellWidget=_cellWidget(this,".cell-content")
            this._rowModel=_rowModel(this)
            this.store=store;
            var pager=this.store.pager.properties.toMap()
            if(pager.pagesize==-1){pager.pagesize=optns.pagesize||40}
            this.pager=new Data.pager(store)
            this.pager.updateProperties(pager)
            //    this.domContainer=DomCore.wrap(cntnr)


            this.pager.on("update",function(){
                this.loadPage()
            });
            _domC.call(this);
            _domC.call(this);
            if(optns.rowTemplate){optns.rowtemplate=optns.rowTemplate};
            ("sorttable colresizable colmove highlightcolumn rowHeight columns title headerFilter rowtemplate wrapfieldsintemplate viewmode  entityForm inlineEditor popupEditor inlneEditor columnFreeze zebraRow editoptions zebraColumn nowrap scrolling pagesize pagination fitLayout showlayoutoptions").split(/\s+/).forEach(
                function(k0){var k=String(k0);if(!(k in optns)&&(k.toLowerCase() in optns)){k=k.toLowerCase()}
                    if(k in optns){gridOptns[k0]=optns[k];}//delete optns[k]
                }
            );

            //pagination /scrolling
            if(gridOptns.scrolling==null){gridOptns.scrolling=30}
            if(gridOptns.scrolling==-1){
                gridOptns.rowHeight=gridOptns.rowHeight||20;
                if(gridOptns.scrolling>0){
                    gridOptns.pagesize= gridOptns.pagesize||gridOptns.scrolling;
                }
            }
            var ent=store.meta, collist

            if(gridOptns.pagesize && store) {pager.pagesize=gridOptns.pagesize}
            //columns

            if(gridOptns.columns){
                collist=gridOptns.columns.map(function(it){return ent.findField(it)||{label:it,name:it,dataIndex:it}}).filter(function(it){
                        return it && !(it.name=="id"||it.hidden||(it.ui && it.ui.hidden))
                    }
                )
            } else{
                collist=ent.findAll(function(it){return !(it.name=="id"||it.hidden||(it.ui && it.ui.hidden))})
            }
             this.cols=collist;
            this.config=this.config||{};
            //this.initComponent([optn])
            for(var k in gridOptns){this.config[k]=gridOptns[k]}
            this.config.gridoptns=gridOptns


            //this.cols=collist.map(function(it){ return ent.columns[it] });
            if(!this.config.viewmode && (this.config.rowtemplate &&!this.config.showlayoutoptions)) {
                this.config.viewmode ="block"
            }
            if(!this.config.viewmode){this.config.viewmode="table"}
            //rendering
            this._renderer=new GridRenderer(this,this.config);
            this.setupDataEvents()
             var c=this.getController()
            c.mixin({
                edit:function(){
                    if(!this.entityForm){ this.entityForm= DataGrid.plugins.entityForm(this).setup()}
                    if(this.selectedRecord && this.selectedRecord.id){
                        this.entityForm.setupForm(this.selectedRecord,true);
                    }
                },
                addrow:function(){
                    if(!this.entityForm){ this.entityForm= DataGrid.plugins.entityForm(this).setup()}
                    this.entityForm.setupForm(null,true);
                },

                del:function(){
                    if(this.selectedRecord && this.selectedRecord.id){
                        this.store.provider.delete(this.selectedRecord.id);
                    }
                },
                refresh:function(){
                    var st=this.domcomponents.toolbar_status
                    if(st){
                        st.html("Refreshing ...")
                        this.observer.once("afterrender",function(){
                            st.clear();
                            //st.html("last refreshed: "+ $.date().format("hh:nn tt"))
                        })
                    }
                    this._renderer.redraw()
                }
            },true);


            this.observer.once("afterbuild.evts",function(){
                this.on("resize",this.resize);
                var _lastCtx={} ,r=this.domcomponents.outer,ths=this,Dom=DomCore;
                this.domcomponents.gridWrap.__onscroll||
                this.domcomponents.gridWrap.on("scroll",this.domcomponents.gridWrap.__onscroll=function(ev){
                    ths.fire("scroll",ev)
                });

                var gridWrap=this.domcomponents.gridWrap
                this.domcomponents.outer.on("click",function(ev){
                    var cx = null
                    var rw=  Dom.selfOrUp(ev.target,".grid-row")
                    if(rw){
                        cx=ths.getRow(rw);
                    }
                    if(!(cx && cx.record)){return}
                    var rowdom=rw
                    if(rowdom && !rowdom.is(".selected")){
                        _lastCtx.row=null;
                    }
                    if(!(_lastCtx.row &&  _lastCtx.row.id===cx.id ) ) {
                            _lastCtx.row = cx;
                        rw.parent().qq(".selected").removeClass("selected")
                        rw.parent().qq('.grid-row[data-id="' + (cx.id) + '"]').addClass("selected")
                             cx.index = Dom.domIndex(cx.el)
                            ths.fire("rowselected", cx)

                    }
                    if( Dom.selfOrUp(ev.target,".grid-cell") ){
                        var cl=cx.getCell(Dom.selfOrUp(ev.target,".grid-cell"))
                        if(cl&&(!_lastCtx.cell || !(_lastCtx.cell &&  _lastCtx.cell.name===cl.name&&  _lastCtx.cell.el===cl.el)) ) {
                            _lastCtx.cell=cl
                            ths.fire("cellselected", cl)
                        }
                    }
                    if($d.is(ev.target,"[data-cmd]")){
                        //ths.getController().invoke(ev.target.dataset.cmd,[]);
                    }
                }) ;
                this.config.viewmode||(this.config.viewmode="grid")



                if(this.config.entityForm){
                    this.config.editable=this.config.entityForm;
                }
                if(this.config.editable){
                    this.config.entityForm=this.config.editable
                }
                if(this.domcomponents.toolbar){
                    this.buttonBar=this.domcomponents.toolbar.css({position:"absolute",r:1,t:"1px",  w:"auto",minWidth:150, textAlign:"right",overflow:"hidden",
                        zIndex:ZINDEX.BUTTONBAR});
                    if(this.config.entityForm){
                        if(!this.entityForm){
                            this.editable=this.entityForm=   DataGrid.plugins.entityForm(this).setup()
                        }
                        this.editable.addLinks(this.config.editable)
                        this.buttonBar.css("minWidth",Math.max(Number(String(this.buttonBar.css("min-width")).replace(/\D/g,"")),this.buttonBar.scrollWidth))
                        this.on("save",function(rec){
                            // this._renderer.renderSingleRow(rec)
                        })
                    }
                }
                if(this.config.title){
                    var dom=this.domcomponents.outer.q(".grid-title")
                    if(dom){
                        dom.html(this.config.title)
                    }
                }
               });

             this.observer.once("afterrender",function(){

                 setTimeout(this.resize.bind(this),500);
                  this._built=true
                 this.pager.on("pageloadstart.pager",function(){
                     this.domcomponents.loadmsg&& this.domcomponents.loadmsg.html("loading . .");
                     this.domcomponents.loadericon&&this.domcomponents.loadericon.show().css("opacity",1)
                     var st=this.domcomponents.toolbar_status
                      if(st){st.html("Loading ...")}
                      this.pager.observer.once("pageloadend" ,function(){
                         st && st.clear();
                         this.domcomponents.loadmsg&& this.domcomponents.loadmsg.html("&nbsp;");
                         if(this.domcomponents.loadericon){
                             this.domcomponents.loadericon.css("opacity",.01)
                             //this.domcomponents.loadericon.hide()
                         }
                     }.bind(this))

                 }.bind(this))

                 var plugins= DataGrid.plugins,gropts=this.config||{};
                  //grid-frame-header
                 if(!this.config.viewmode||this.config.viewmode=="grid"||this.config.viewmode=="table"){
                     this.colresizable =     plugins.colResize(this)
                      this.sortable     =     plugins.sortable(this)
                       if(this.config.scrollable!==false ) {
                            this.scrollable = plugins.scrollable(this)
                      }
                     if(this.config.columnFreeze){this.ColumnFreeze=  plugins.ColumnFreeze(this).setup()}
                 }  else {
                     this.domcomponents.tabheader && this.domcomponents.tabheader.hide()
                 }
                 if(this.config.infiniteScroll){this.infiniteScroll=  plugins.infiniteScroll(this).setup() ;this.pager.pagesize=200  }
                 if(this.sortable) {this.sortable.setup();}
                 if(this.scrollable) {this.scrollable.setup()}
                 if(this.config.showlayoutoptions&&this.config.rowtemplate){
                     this.layoutoptions=  plugins.layoutoptions(this).activate()
                 }
                 if( this.config.colmove||this.colmove){
                     this.colMove      =     plugins.colMove(this)}


                 var cn=this.config.filterContainer||this.domcomponents.frameheader
                 if(this.config.headerFilter&&cn){
                     this.config.filterContainer= cn
                     plugins.headerFilter(this).setup()
                    // cn.style.height="40px"
                 }
                 if(this.config.zebraColumn) {this.domcomponents.outer.addClass("zebra-col")}
                 if(this.config.zebraRow) {this.domcomponents.outer.addClass("zebra-row")}
                 if(this.config.nowrap) {this.domcomponents.gridWrap.addClass("nowrap")}
                    if(this.config.editoptions){
                        if(this.config.editoptions.add!=null){

                        }
                    }

                 if(this.ColumnFreeze) {this.ColumnFreeze.activate()}
                 if(this.colresizable) {this.colresizable.activate()}
                 if(this.colMove) {this.colMove.setup()}
                 if(this.config.popupEditor){
                     this.popupEditor=  plugins.popupEditor(this).setup()
                 }
                 if(this.config.inlineEditor){
                     this.inlineEditor=  plugins.inlineEditor(this).setup()
                 }
                  if(this.config.highlightcolumn&&this.config.viewmode!="block"){

                     this.on("cellselected",function(cx){
                         if(cx.columnIndex!=null&&cx.columnIndex>=0){
                             this.domcomponents.outer.st(".grid-column-selected").removeClass("grid-column-selected").
                                root(".grid-cell:nth-child("+(cx.columnIndex+1)+")").addClass("grid-column-selected")
                         }
                     })
                 }
                 this.domcomponents.framefooter.style.zIndex=ZINDEX.FOOTERBAR
                 this.domcomponents.frameheader.style.zIndex=ZINDEX.FRAMEHDR
                // plugins.gridMenu(this).setup();
                 this.domcomponents.tabheader &&  this.domcomponents.tabheader.on( "mousedown",
                     this.domcomponents.handleheaderSel.bind(this.domcomponents)
                 );
                 $d.addBoundsListener(this.domcomponents.outer,this.resize.bind(this));

             });
            var pr=Promise.deferred();
            this.data("_lookupsresolve_promise",pr)


              if(this.store){   var p=[]
                 this.cols.forEach(function(it){
                     if(it && !it.hidden&&it.hasLookup){
                         var pr=it.getLookupValueMap();
                         if(pr){p.push(pr)}
                     }
                 });
                 if(p.length){
                     var _resolved=0
                     Promise.all(p).then(function(){_resolved=1;
                         pr.resolve()
                      }.bind(this));
                     setTimeout(function(){
                         if(!_resolved){_resolved=1;
                             pr.resolve()
                      }}.bind(this),5000)

                 }else{ pr.resolve()  }
             }


        }
        _proto.addPlugin=function(id,optns){
            if( DataGrid.plugins[id]&&!(id in this)){
                this[id]= DataGrid.plugins[id](this);
                this[id].setup();
            }
            this[id] && this[id].activate && this[id].activate( optns )
        }
        _proto.removePlugin=function(id){
            if( DataGrid.plugins[id]&&!(id in this)){
                this[id].remove && this[id].remove();
            }
        }
        _proto.build=function(panel,recs){
            var dom;
            if(panel&&panel.nodeType){dom=panel;panel=null}
            else if(panel.contentWrap){this.panel=panel;dom=panel.contentWrap}
            else{dom=panel;panel=null}
            this.el=this.domcomponents.outer=$d(dom)

            if(!this.domcomponents.outer.hasClass("gridtable")){this.domcomponents.outer.addClass("gridtable")}
            if(this.config.rowHeight && this.config.rowHeight!="auto"){
                dom.classList.add("fixedheight")
            }
            dom.classList.add("unselectable")
            //this.domcomponents.frameheader && (this.domcomponents.frameheader.style.height="60px");
            if(panel){
                panel.on("resize afterlayout",$.throttle(function(){
                 this.fire("resize")}.bind(this),500))
            }
            //if(this.store){
                this.pager.observer.on("pageloadend",function(recs){
                     this._renderer.renderRows(this.store.getList() )
                    var st=this.domcomponents.toolbar_status
                    if(st){
                        //st.html("last refreshed: "+ $.date().format("hh:nn tt"))
                        }
                    this.updateMsg()
                }.bind(this))


            //}
            this._renderer.render( )
            if(this.store.records.size()&&this.store.records[0]){
                this._renderer.renderRows( )
            }else {var grid=this;
                this.store.observer.once("dataloadcompleted",function(){
                    var map=this.pager.properties.toMap()
                    delete map.pagesize
                    grid.pager.properties.update(map)
                    //grid._renderer.renderRows( )

                })
            }
            if(recs===true){
                this.pager.loadPage()
            }

            return this;
        }
        _proto.render=function( panel){

               if(!this._renderer.isRendered()&&panel ){

                   if(this.store && !this.store.size(true)){
                        this.pager.loadPage().then(function(){
                           this.build(panel)
                       }.bind(this))
                   } else{this.build(panel)    }

               } else{this._renderer.renderRows();}

             return this;
        }
        _proto.getStore=function(){return this.store}
        _proto.nav=function(mthd ){
            if(mthd && typeof(this.pager[mthd])=="function"){
                this.pager[mthd].apply(this.pager,$.makeArray(arguments,1))
            }
        }
        _proto.getColumnCells=function(name,allcells,safe,getcontentwrap){
            var colpos= 0,grid=this
            if(!name){return safe?[]:null}
            if(typeof(name)=="number"){colpos=name}
            else {
                var colmeta=$.is(name,Data.Column)?name:null
                if(!colmeta) {
                    var meta = this.store ? this.store.meta : this.meta, tofind = name
                    if (meta) {
                        tofind = (meta.find(name) || {}).name || name
                    }
                    colmeta = this.cols.find(function (c) {
                        return c.name == tofind
                    })
                }
                if (!colmeta) {
                    return safe?[]:null
                }
                var col = grid.domcomponents.tab.q('.grid-cell[data-name="' + colmeta.name + '"]')
                if (!col) {
                    col = this.domcomponents.gridWrap.q('col[data-name="' + colmeta.name + '"]')
                }
                if(col){colpos=col.at()+1}
            }
            if(colpos){var sel='.grid-cell:nth-child('+colpos+')'+(getcontentwrap?" .cell-content":"")
                if(allcells){
                    sel=sel+',.grid-header-cell:nth-child('+colpos+')'+(getcontentwrap?" .cell-content":"")+',.grid-footer-cell:nth-child('+colpos+')'+(getcontentwrap?" .cell-content":"")
                }
                return (allcells?grid.domcomponents.gridWrap:grid.domcomponents.rowset).st(sel)
            }
            return safe?[]:null
        }
        _proto.showStateMsg=function showStateMsg(msg,delay ){
            if(delay >0){
                setTimeout(showStateMsg.bind(this,msg),delay)
                return this
            }
               var d=this.domcomponents.loadmsg
                if(d){
                    if(!msg){d.css({opacity:0.01})}
                    else{d.show().html(String(msg)).css({opacity:1})}
                }
            return this
            }
        _proto.updateMsg= $.throttle(function _updateMsg( ){//
            var gridctx=this,d=gridctx.domcomponents.pagerwrap,store=this.store,pager=this.pager;
            if(!d||pager.pagesize<=0){return}
             if(!pager.totalrows || !pager.pageno){
                pager.recalc( store.size()) ;
             }
            pager.properties.recalcAll()

            if(!d.q(".grid-pager-text-pageno")){
                d.el.innerHTML=pagertemplate.replace(/\$([\w]+)/g,function(a,b){return pager[b]||""});//store.pager.toString( );
                d.on("click.gridpager",function(ev){ var key=$d.domdata(ev.target,"key");key && this.nav(Number(key)||key)}.bind(this)
                ,".grid-pager-text button")
                d.q("input").on("change",function(evt){ this.nav("nav",Number(evt.target.value)) }.bind(this))
             }   else{
                "startrow totalrows endrow totalpages pageno".split(/\s+/).forEach(function(k){
                    var el=d.q(".grid-pager-text-"+k);
                    if(!el){return}
                        if(k!="pageno"){el.html(pager[k])}
                        else{d.down("input").val(pager[k])}
                })
            }


        },{tailend:true});


        _proto.getContext=function _getContext(cel,rw ){

            var  cx={__isgridcontext:true}
            if(!(cel||rw)){return }
            if(cel && cel.__isgridcontext){
                return cel
            }
            if(rw && rw.__isgridcontext){
                cx=rw;
            }
            if(cel && cel.type&&cel.target&&cel.target.nodeType){
                cel=cel.target
            }
            if(cel && cel.nodeType){

                rw=$d.selfOrUp(cel,".grid-row");
                cel=$d.selfOrUp(cel,".grid-cell");
            }
            if( !(rw || cel)){return }
            if(rw) {
                if (rw === "first") {
                    cx.row = this.domcomponents.rowset.q('.grid-row')
                    cx.id = $d.domdata(cx.row, "id")
                }
                else if (rw && rw.__record__) {
                    cx.record = rw
                    cx.id = cx.record.id
                }
                else if ($.isPlain(rw)) {
                    cx.record = rw.record || rw;
                    cx.id = rw.id || cx.record.id
                    cx.row = rw.row
                    cx.column = rw.column
                    cx.cell = rw.cell
                    cx.columnname = rw.columnname
                }
                else if (rw && typeof(rw) != "object" && Number(rw) > 0) {
                    cx.record = this.store.getList().findById(rw)
                }
                else if (rw && rw.nodeType && $d.is(rw, ".grid-row")) {
                    cx.row = rw;
                }
            }
            if(cx.record&&!cx.id) {
                cx.id = cx.record.id;
            }
            if(!cx.id&&cx.row){
                cx.id = $d.domdata(cx.row, "id")
            }
            if(cx.id&&!cx.record&&this.store){
                cx.record=this.store.getList().findById(cx.id)
            }

            if(cx.id&&!cx.row&&this.domcomponents.rowset) {
                cx.row=this.domcomponents.rowset.q('.grid-row[data-id="'+cx.id+'"]')
            }
            if(typeof(cel)=="string"){
                cx.column=cx.column||this.store.meta.findField(cel)
                if(!cx.cell&&(cx.row&&cx.column)){
                    var col = grid.domcomponents.tab.q('.grid-cell[data-name="'+cx.column.name+'"]')
                    if(!col){
                        col=this.domcomponents.gridWrap.q('col[data-name="'+cx.column.name+'"]')
                        if(col){
                            cx.cell=cx.row.qq(".grid-cell")[col.at()]
                        }
                    }
                    else{cx.cell=col}

                }
            }
            if(!cel&&cx.cell){cel=cx.cell}
            if(cel&&cel.nodeType){
                if(!cx.cell){cx.cell=$d.selfOrUp(cel,".grid-cell")}
                if(!cx.column){
                    var name=$d.domdata(cx.cell,"name")
                    if(!name){
                        var idx=cx.columnIndex
                        if((idx==null || isNaN(idx)||idx<0) &&cx.cell&&!cx.column&&cx.cell.is("td")){
                            idx=$d.domIndex(cx.cell)
                        }
                        if(idx>=0){
                            cx.columnIndex=idx;
                            var col=this.domcomponents.gridWrap.q("col:nth-child("+(idx+1)+")")
                            if(col){name=$d.domdata(col,"name")}
                        }
                    }
                    if(name){
                        cx.column=this.store.meta.findField(name)
                    }
                }
          }

            if(cx.record ){return cx}
        }

        _proto.afterRender=function  afterRender( ){
              this.updateMsg();
             this.resize();
            //ths.domcomponents.gridWrap.scrollTop=0;
            if(this.config.viewmode=="block"){
                this.domcomponents.gridWrap.css({overflow:"auto"})
            }
            this.fire("afterrender");

        }
        _proto._resize= function _resize(w,h){
            var gridctx=this,Dom=$d,outer=gridctx.domcomponents.outer,
                rdm=outer.getBoundingClientRect(),
                wr= gridctx.domcomponents.gridWrap,
                ftr=outer.q(".grid-footer"),
                 hd=outer.q("table thead"),
                  clnhdr=gridctx.domcomponents.headerclone,
            info=gridctx.domcomponents.hdrInfo()
            var oht=rdm.height;
            //if(!outer.el.style.height && gridctx.domcomponents._h){oht=gridctx.domcomponents._h}
            if(oht &&wr ){
                var t=0//clnhdr?(info.bottom-4):info.top;
                var css={w: (rdm.width-8)}
                //if(gridctx.scrollable && gridctx.domcomponents._h!==oht){
                var frhd=outer.q(".grid-frame-header")
               if(frhd){t=frhd.offsetHeight}
                if(clnhdr){t += clnhdr.offsetHeight}
                if(t){css.top=t;}
                     //css.top=t;
                     css.h=oht-((ftr?ftr.offsetHeight:0)+(t))
                      gridctx.domcomponents._h=rdm.height
                    if(!outer.el.style.height){
                         //outer.el.style.height=$d.css(outer,"height")
                    }
             }
                Dom.css(   wr,css)
               if(clnhdr){
                  /// clnhdr.css({top:info.top,width:rdm.width-8,overflow:"hidden"})
               }



            if(this.config.viewmode=="tile"){
                this.domcomponents.rowset.css("width",this.domcomponents.gridWrap.width())
            }
            // if(wr.scrollHeight>wr.offsetHeight){wd=wd-14}
            //if(dm.width){Dom.css(tab,{width:(dm.width )+"px"});}
            var hndl=this.fire("afterresize")
        }
        _proto.getRow= function getRow(row){
            return this._rowModel(row)
        }
        _proto.findRow= function findRow(row){
            var model=this.getRow(row)
            if(model){
                return model.row
            }

        }
        _proto.cellAsWidget= function cellAsWidget(row,cell){
            var cl,c0l,row= this.getRow(row)
            if(row){
                return row.getCell(cell)
            }

         }
        _proto.resize= function _resize (w,h){
            if(!this.domcomponents.outer.isVisible(true)){this._needsRedraw=true;return}
            this._resize()}
        _proto.syncColWidths=function(){
            var tabhdr=this.domcomponents.gridWrap.q(".grid-tab .grid-header");
            var clonehdr=this.domcomponents.outer.q(".headerclone")||this.domcomponents.tabheader;
            clonehdr.style.overflow="hidden" ;//clonehdr.style.width=wr.style.width
            var clonehdrrow=clonehdr.firstElementChild
            //var hdrcell=this.domcomponents.gridWrap.q(".grid-tab .grid-header .grid-row .grid-header-cell:nth-child("+($d.at(t)+1)+")").el
            var clonecells=clonehdr.querySelectorAll(".grid-header-cell"),
                cells=tabhdr.querySelectorAll(".grid-header-cell")

            if(clonehdrrow && tabhdr.offsetWidth>0 && tabhdr.offsetWidth!=clonehdrrow.offsetWidth){

                _arrayEach(cells,function(it,i){
                    if(!it.offsetWidth){return}
                    clonecells[i].style.minWidth= clonecells[i].style.maxWidth=clonecells[i].style.width= (it.offsetWidth )+"px"
                })  ;
                //clonehdrrow.style.width=gridctx.domcomponents.tab.scrollWidth+"px"
                if(tabhdr.offsetWidth!=clonehdrrow.offsetWidth){
                    setTimeout(function(){
                        _arrayEach(cells,function(it,i){if(!it.offsetWidth){return}
                            clonecells[i].style.minWidth= clonecells[i].style.maxWidth=clonecells[i].style.width= (it.offsetWidth )+"px"
                        })  ;
                     },500)
                }
            }
        }
        _proto.setupDataEvents=function(){
            var store=this.store
            //Evnts
            store.on("dataloadprogress.gridloadobserver",this.updateMsg.bind(this));

            if(!this.config.infiniteScroll){
                /*this.pager.on("update", function(){
                    var res=this.pager.getPage(function(d){
                        this._renderer.renderRows(this.store.records);
                    }.bind(this))

                }.bind(this));
                */

            }


            store.on("data",function(ev){
                var type=ev.action||ev.type,bult=this._built
                 if(type=="load") {
                    this._renderer.renderRows();
                } else if((type=="delete"||type=="insert"||type=="update")) {
                     if (!bult) {return }

                     if(!(ev.record&& ev.record.id)){
                         console.log("no id for record")
                         return
                     }

                    this.store.applySortAndFilter(this.pager)
                     if (type == "delete" && this.store.findById(ev.record.id)){
                         //this.store
                     }

                    if (type == "delete" || type == "insert") {

                        this._renderer.renderRows();
                    } else if (type == "update" && ev.record) {
                        var r = this.getRow(ev.record);
                        if (! (r && r.row)) {
                            this._renderer.redraw()
                        }
                        else if(!this.config.ignoreupdate){
                            r.render();
                        }
                    }

                }

            }.bind(this));
            this.on("rowselected",function(cx){
                this.selectedRecord=cx.record;
            });
            this.on("viewupdate afterpageload",this.updateMsg.bind(this));

        }
        _proto.updateCell=function(rec,fld){
            var r=this.getRow(rec,fld)
            if(r&&fld){
                var cl=r.getCell(fld)
                //var cl=r.down('.grid-cell[data-datakey="'+fld+'"]')
                if(!cl){return}
                var f=this.store.meta.findField(cl.name)
                if(f&&cl.content){
                    var s= f.getDisplayValue(r.record.get(f.name))
                    if(s){
                        cl.content.html(s)
                    }
                }
            }
        }


        return Klass("View.DataGrid" ,_proto);
    })();


    /*Layout.impl.DataGrid=Klass("DataGrid",Layout.impl.base,{priority:10,
     setup:function(){

     },
     layout:function(){

     }

     }) ;
     */






//plugins
     DataGrid.plugins={
        layoutoptions:function(grid){
            var gridctx=grid,Dom=DomCore,_isactive=false,blocktemplate

            function onSelect(t){
                var k=$d.domdata(t,"key"),curr=gridctx.config.viewmode
                if(k&&k!=gridctx.config.viewmode){
                    gridctx.config.viewmode=k;
                    if(k=="table"){
                        blocktemplate=blocktemplate||gridctx.config.rowtemplate
                        gridctx.config.rowtemplate=null
                    }  else{
                        gridctx.config.rowtemplate=blocktemplate
                    }
                    gridctx.domcomponents.outer.hide().css("opacity",0.1).show()
                    gridctx.domcomponents.outer.removeClass("viewmode-"+curr)
                    gridctx.domcomponents.outer.addClass("fxtx")
                    setTimeout(function(){
                        gridctx.domcomponents.outer.css ("opacity", 1)
                         gridctx._renderer.renderRows(null,false,true)
                               setTimeout (function(){
                                 gridctx.domcomponents.outer.removeClass ("fxtx")
                             }, 1000)

                    },1)
                }
            }
            return {   label:"Loayout Options",
                setup:function(){


                    return this},
                activate:function(ev,el){
                    if(!_isactive){

                        _isactive=true;
                        blocktemplate=gridctx.config.rowtemplate
                        gridctx.config.rowtemplate=null

                        var dom=gridctx.domcomponents.toolbar.append("<span class='layout-options'><img valign='center'  src='theme/img/gridview.gif' class='layout-option' data-key='table' title='Grid View' /><img valign='center' src='theme/img/blockview.gif' class='layout-option' title='Tile View' data-key='tile'/></span>")
                        dom.st("img").css({border:"1px solid #ccc", margin:"0 2px"})
                        dom.on("click",function(ev,el){
                            el&&el.is(".layout-option")&&onSelect.call(gridctx,el)
                        },".layout-option")

                    }
                },
                remove:function(){_isactive=false;}
            };
        },
        colMove  :function(grid){
            var gridctx=grid,Dom=DomCore,_isactive=false,sel=".grid-header-cell",tracker=null
            return {   label:"Move Columns",
                setup:function(){

                    _isactive=true
                },
                activate:function(ev,el ){
                    var maxz=0,elhdr=gridctx.domcomponents.headerclone||gridctx.domcomponents.tabheader
                   var  optns= {
                       target:el,
                       start: function start(ev) {
                            var t = ev.el, dm = t.bounds()
                            var trgt = t.data("_sh"), l = t.offsetLeft
                            if (!trgt) {
                                var wr = gridctx.domcomponents.gridWrap, dm = t.bounds(), rdm = wr.getBoundingClientRect()
                                var sh = document.createElement("div");
                                sh.classList.add("col-resize-shadow");
                                $d.css(sh, {
                                    left: dm.left + "px",
                                    top: dm.top + "px",
                                    height: (rdm.bottom - (dm.top)) + "px",
                                    w: dm.width + "px",
                                    cursor: "col-resize"
                                });
                                sh = $d(document.body.appendChild(sh));
                                t.data("_sh", sh)
                                trgt = sh;
                            }
                            if (!maxz) {
                                $d.css(document.body, {cursor: "move"}).addClass("noselection");
                                maxz = elhdr.qq(sel).reduce(function (z, it) {
                                    return Math.max(z, Number($d.css(it, "zIndex")) || 0)
                                }, maxz || 0)
                                $d.css(trgt, "zIndex", ++maxz);
                            }
                        },
                        move: function move(ev) {
                            var el=ev.el
                             var trgt = el.data("_sh"), l = el.offsetLeft
                            if (!trgt) {
                                return
                            }

                            $d.css(trgt, "left", l + ev.data.delta.x)
                            var t1, b = $d.bounds(trgt), t, delta = ev.data.delta;
                            $d(trgt).hide()
                            t = document.elementFromPoint(b.left, b.top);
                            if (t) {
                                t1 = elhdr.qq(sel).filter(function (a) {
                                    return a.contains(t)
                                })[0];
                            }
                            ;
                            if (!t1) {
                                t = document.elementFromPoint(b.left + b.width / 2, b.top + b.height / 2);
                                t1 = elhdr.qq(sel).filter(function (a) {
                                    return a.contains(t)
                                })[0];
                            }
                            $d(trgt).show();
                            $d.data(this, "_current", t1 || null)

                        },
                        end: function end(ev) {var el=ev.el
                            var trgt = el.data("_sh")
                            var _current = $d.data(el, "_current"), s = $d.data(el, "_start");
                            $d.data(el, "_start", null);
                            $d.data(el, "_current", null)
                            $d.data(el, "_sh", null)
                            $d(document.body).css({cursor: "auto"})
                            if (trgt) {
                                $d.remove(trgt)
                            }
                            maxz = 0
                            if (_current) {
                                var nuidx = _current.at();

                                var idx = el.at();
                                if (nuidx == idx) {
                                    return
                                }
                                (gridctx.getColumnCells(idx + 1, true, true) || []).forEach(
                                    function (it) {
                                        //var t=it.parent().q(".grid-header-cell:nth-child("+nuidx+"),.grid-cell:nth-child("+nuidx+")")
                                        var t = it.sibling(nuidx - idx)
                                        if (!t) {
                                            return
                                        }
                                        it.parent().el.insertBefore(it.el, t.el.nextSibling)
                                    }
                                )

                            }
                        }
                    }
                    $d.on(el,"mousedown.mousetracker",function(){
                        $d.trackMouse(optns)
                    })
                  
                },
                remove:function(){_isactive=false;}
            };
        },
        colResize  :function(grid){
            var gridctx=grid,Dom=DomCore,_isactive=false,domhandle=null,dragging=0

            function onSelect(ev,t){
                if( !t ){
                    $d.css(document.body,{cursor:"auto"});
                    return
                }
                t= t.el||t
                var   wr= gridctx.domcomponents.gridWrap,dm=t.getBoundingClientRect(),rdm=  wr.getBoundingClientRect(),
                    st={x:ev.clientX,y:ev.clientY};
                // Dom.css(getOverlay(wr),{display:"block"}); ;

                Dom.css(document.body,{cursor:"col-resize"}).addClass("noselection");
                var tabhdr=gridctx.domcomponents.gridWrap.q(".grid-tab .grid-header");
                var clonehdr=gridctx.domcomponents.outer.q(".headerclone")||gridctx.domcomponents.tabheader;
                clonehdr.style.overflow="hidden" ;//clonehdr.style.width=wr.style.width
                var clonehdrrow=clonehdr.firstElementChild
                var hdrcell=gridctx.domcomponents.gridWrap.q(".grid-tab .grid-header .grid-row .grid-header-cell:nth-child("+($d.at(t)+1)+")").el
                var clonecells=clonehdr.querySelectorAll(".grid-header-cell"),
                    cells=tabhdr.querySelectorAll(".grid-header-cell");;
                tabhdr.st(".grid-header-cell").css("color",tabhdr.css("backgroundColor"))
                 var maxz=0
                  $d.on(t,"mousedown.mousetracker",function(){
                        $d.trackMouse(
                            {target:t,
                        start:function(ev){
                            dragging=1
                            var t=ev.el,dm=t.bounds()
                            var trgt=ev.el.data("_sh"),l=t.offsetLeft
                            if(!trgt) {//var t=this;
                                var wr=gridctx.domcomponents.gridWrap, dm=t.bounds (), rdm=wr.getBoundingClientRect ()
                                trgt=document.createElement ("div");
                                trgt.classList.add ("col-resize-shadow");

                                $d.css (trgt, {left: dm.left + "px", top: dm.top + "px", height: (rdm.bottom - (dm.top)) + "px", w: dm.width + "px", cursor: "col-resize"});
                                t.data ("_sh", trgt=$d (document.body.appendChild (trgt)))
                            }
                            if(!maxz) {
                                $d.css(document.body,{cursor:"move"}).addClass("noselection");
                                $d.toFront(trgt);
                            }
                        }
                        ,move:function(ev){
                            var trgt=ev.el.data("_sh"),l=t.offsetWidth
                            if(trgt&&ev&&ev){
                                $d.css (trgt,{left:dm.left,top:dm.top,width:Math.max(10,(l+ev.delta.x))}).toFront()
                            }

                        },
                        end:function(ev){
                            $d.css(document.body,{cursor:"auto"});
                            try{   var Dom=$d
                                var sh=ev.el.data("_sh")
                                ev.el.data("_sh",null)
                                if(!sh){dragging=0;return}
                                var idx,outer=gridctx.domcomponents.outer,p= t.parentNode,div= t.firstElementChild,wd=sh.offsetWidth ,
                                    _setwidths=gridctx.domcomponents.setwidths;
                                for(var i= 0,l=$.makeArray(p.children);i< l.length;i++){if(l[i]===t){idx=i;break;}} ;
                                if(idx>=0){
                                    //,td:nth-child("+(idx+1)+") .cell-content
                                    _arrayEach( outer.querySelectorAll(".grid-header-cell:nth-child("+(idx+1)+") ,col:nth-child("+(idx+1)+"),td:nth-child("+(idx+1)+")"),function(it){
                                        _setwidths(it.style,(wd-hdrwdoffst)+"px");
                                    })  ;
                                }
                                //gridctx.domcomponents.tab.scrollWidth&&$d.css({width:gridctx.domcomponents.tab.scrollWidth})
                                gridctx.syncColWidths()
                                //gridctx.domcomponents.tab.scrollWidth&&$d.css(clonehdrrow,{width:gridctx.domcomponents.tab.scrollWidth})

                            } finally{  dragging=0
                                // if(wr){wr.style.display=""}
                                //  Dom.css(getOverlay(wr),{display:"none"}) ;
                                if(sh){ sh.remove();sh=null;   }
                                $d.removeClass(document.body,"noselection")
                                $d.removeClass(gridctx.domcomponents.outer,"resizing")
                                _isactive=false;
                            }

                        }
                    })
           
                     })
                     

            }
            return {   label:"Resize Columns",
                setup:function(){
                    grid.on("render",function(){})
                    return this},
                activate:function(ev,el){
                    if(!_isactive){
                        var _last=null,compo=gridctx.domcomponents,header=compo.headerclone||compo.tabheader
                        if(!domhandle){
                            domhandle= header.append("<div>").addClass("col-resize-handle").css({position:"absolute",height:20,width:12,cursor:"col-resize",background:"url(theme/img/colresize_handle.png) no-repeat"})
                            domhandle.on("mousedown",function(ev){
                                if($d(this.data("_cell"))){
                                    $d(this.data("_cell")).up(".gridtable")
                                    onSelect(ev,$d(this.data("_cell")))
                                    _last=null
                                    ev.stopPropagation()
                                }
                            })
                        }
                        var offset=null
                        domhandle.hide()
                        _isactive=true;

                        header.on("mousemove",function(ev){
                            if(dragging){domhandle.hide();return}
                            if(!offset){
                                var par=$d.getOffsetParent(domhandle);
                                if(!par){return}
                                offset=header.bounds().top-par.bounds().top
                            }
                            var cell=$d(ev.target).selfOrUp(".grid-header-cell");
                            if(cell&&cell.id&&cell.id!==_last){  _last=cell.id
                                var b1=header.bounds(),b=cell.bounds()
                                domhandle.css({top:offset +   (b.height-20)/2,left: (b.right-b1.left)-6}).show().data("_cell",cell.id)
                             }

                         })
                     }
                },
                remove:function(){_isactive=false;}
            };
        },
        sortable:function(grid){
            var gridctx=grid   ,Dom=DomCore, _isactive =0
            function handleSort(ev,checked){
                if(!_isactive){return}
                var t=Dom.is(ev.target,".grid-header-cell")?$d(ev.target):Dom.up(ev.target,".grid-header-cell"),p,idx;
                if(!t){return}

                p=t.parentNode;idx=Dom.domIndex(t)
                var tab=Dom.up(t,".gridtable");if(!tab){return}
                var c=tab.q(".grid-tab col:nth-child("+(idx+1)+")");
                var nm=c? $d.domdata(c,"name"):"";

                if(nm){
                    gridctx.on("afterrender",function(){
                        gridctx.domcomponents.outer.qq(".grid-header-cell.sort-a,.grid-header-cell.sort-d").removeClass(["sort-d","sort-a"])
                        t.addClass("sort-"+gridctx.pager.sortdir)
                    },{once:true})
                    gridctx.pager.applySort(nm);
                    if(gridctx.pager.isCachedLocal){
                        gridctx.domcomponents.resetscroll()
                        gridctx._renderer.renderRows();
                    }


                    //c.addClass()
                }
            }
            return {   label:"Sort Columns",
                setup:function(){
                    if(_isactive){return}
                    _isactive=true;
                    gridctx.domcomponents.outer.addClass("issortable")
                    //grid.domcomponents.outer.on("click",
                    /*grid.domcomponents.outer.on("click.grid-header-cell",
                        function(ev,el){
                             handleSort.call(el,ev,true ) ;
                        },".grid-header-cell" );
                        */
                    return this;
                },
                activate:function( ev,el){
                    handleSort.call(el,ev,true ) ;
                },
                remove:function(){_isactive=false;}
            };

        },
        scrollable:function scrollable(grid){
            var   _isactive=0,cmp=grid?grid .domcomponents:null,Dom=DomCore,rowhdrht=0;
            function sethdht(){
                var hd=this
                var setStyle=$d.css.setStyle
                if(hd){
                    Dom.qq(hd,".grid-header-cell,.grid-row").forEach(function(c){

                        setStyle(c,"lineHeight","1px")
                        setStyle(c,"height","1px")
                        //c.style.lineHeight= "1px";c.style.height= "1px";
                        c.style.overflow= "hidden"
                    })

                        setTimeout(function(){
                            var b=grid.domcomponents.tab.bounds(),d=grid.domcomponents.tab.parent().bounds().left-b.left;
                            if(grid.domcomponents.headerclone){
                                $d.css(grid.domcomponents.headerclone,{left:( 1-d)})//,width: b.width
                            }
                        },10)



                    // hd.style.marginTop="-"+hd+"px";
                    //   hd.style.position="absolute"
                }
            }
            function onresize(){  if(!_isactive){return}
                if(grid.domcomponents.headerclone){
                    synchdrwidths( );
                }
                proc()
            }
            function setwidths(st,w){ if(w&&w!="0px"&&w!="0"){st.maxWidth=st.minWidth=st.width=w}}
            function synchdrwidths (hd0,cl0){   if(!_isactive){return}
                 var gridctx= grid,   Dom=$d, cmp=gridctx.domcomponents,_setwidths=setwidths, hd=hd0||cmp.tabheader, cl=cl0||cmp.headerclone;
                var firstrow=cmp.row(0);
                if(!(firstrow&&cl)){return}
                try{
                    var setStyle=$d.css.setStyle
                    hd.style.display="";hd.visibility="visible"
                    var cls=[];
                    [].forEach.call(firstrow.querySelectorAll(".grid-cell"),
                        function(it,i){
                            cls.push({width:Number(Dom.css(it,"width").replace(/[\D]+$/,""))})
                        }
                    );

                     _arrayEach(cl.querySelectorAll(".grid-header-cell .cell-content,.rownum"),
                        function(it,i){
                             if(!it.classList.contains("rownum") && cls[i]) {
                                 var par=it.parentNode
                                 setStyle(par, "width"  , cls[i].width + "px")
                                 setStyle(par, "minWidth", cls[i].width + "px")
                                 setStyle(par, "maxWidth", cls[i].width + "px")
                             }
                                 //cls[i] && _setwidths(it.parentNode.style,(cls[i].width )+"px");}
                         }
                    );

                    if(cls.length){
                        firstrow.classList.add("_widthadjusted");
                        _arrayEach(firstrow.querySelectorAll(".grid-cell .cell-content,.rownum"),
                            function(it,i){if(cls[i]==null){return}
                                //_setwidths(it.style,(cls[i].width)+"px");
                                var par=it.parentNode
                                setStyle(par, "width", cls[i].width + "px")
                                setStyle(par, "minWidth", cls[i].width + "px")
                                setStyle(par, "maxWidth", cls[i].width + "px")
                                //_setwidths(it.parentNode.style,(cls[i].width)+"px");
                            });
                        cmp.colset.forEach(function(it,i){
                            setStyle(it, "width", cls[i].width + "px")
                            //it.css({w:(cls[i].width)+"px"})
                        });
                    }

                } finally{
                    if(!rowhdrht&&hd.offsetHeight>10){rowhdrht=hd.offsetHeight; }

                    hd.style.visibility="hidden";
                 }
             }
            function proc(refresh){  if(!_isactive){return}
                var gridctx=grid,cmp=gridctx.domcomponents,
                    hd=cmp.tabheader,
                    hdcln=cmp.outer.querySelector(".headerclone"),
                    cl

                if(!cmp.gridWrap.querySelector(".grid-rowset .grid-row .grid-cell")){
                    return}
                cmp.gridWrap.css({overflow: "auto",position:"relative"})

                if(!hdcln){refresh=0}
                if(refresh===true){
                    if(hdcln) {hdcln.parentNode.removeChild(hdcln)}
                    hdcln=null;
                }
                if(hdcln||!hd){
                    if(hd){sethdht.call(hd)}
                    return
                }

                //Dom.st(cl,".grid-header-cell" )
                var   hi=cmp.hdrInfo() ;
                cl= cmp.outer.appendChild(hd.clone(true,true));
                cl.classList.add("headerclone")  ; cl.style.display="" ;
                hd.style.display="";
                var bg=Dom.css(hd,"backgroundColor")
                var setStyle=$d.css.setStyle
                $d(hd).qq(".grid-header-cell").forEach(function(it){setStyle(it,"color",bg)});
                Dom.css(cl,{visibility:"visible", z:50,l:"0",w:"auto"});//t:hi.top+"px",h: (hi.height)+"px",
                setStyle(cl,"top",hi.top+"px")
                setStyle(cl,"height",hi.height+"px")
                Dom.qq(cl,".grid-header-cell").forEach(function(c){
                    setStyle(c,"lineHeight",hi.height+"px")
                    setStyle(c,"height",hi.height+"px")
                    //c.style.lineHeight= c.style.height= hi.height+"px";
                });
                var h2=hi.height+4
                Dom.qq(cl,".grid-row").forEach(function(c){
                    setStyle(c,"lineHeight",h2+"px")
                    setStyle(c,"height",h2+"px")
                    //c.style.lineHeight= c.style.height= (hi.height+4)+"px";
                })
                setStyle(cl,"height",h2+"px")
                //cl.style.height=(hi.height+4)+"px";
                 var hdrrow=hd.firstElementChild;
                hdrrow.style.overflow="hidden";
                //hdrrow.style.height="1px";   //hdrrow.style.lineHeight=hd.style.lineHeight= d.style.height= "1px";
                setStyle(hdrrow,"height","1px")
                Dom(cl).on( "mousedown",
                    gridctx.domcomponents.handleheaderSel.bind(gridctx.domcomponents)
                );

                if(!refresh){
                    grid.on("scroll",function(ev){
                        sethdht.call(cmp.tabheader)
                    });
                    //ths.domcomponents.gridWrap.scrollTop=0;

                    sethdht.call(cmp.tabheader)
                    gridctx.on("viewupdate afterpageload ",function(){
                        sethdht.call(this.domcomponents.tabheader)
                    });
                } else{sethdht.call(cmp.tabheader)}
                //cmp.gridWrap.style.top=hi.bottom+"px"  ;
                synchdrwidths( hd,cl)
                return cl
            }

            return {    label:"Scrollable",
                setup:function(){
                    this.activate();
                    grid.on("pageload",function(){ proc(true) })
                    return this;
                },
                activate:function(){    _isactive   =1
                    onresize()
                    grid.domcomponents.gridWrap.css({overflow: "auto",position:"relative"})
                     grid.domcomponents.outer.addClass("scrollable")
                    grid.on("viewupdate afterrender afterresize", onresize );


                },
                remove:function(){_isactive=false;}
            };

        },
        headerFilter: function setupHeaderFilter(grid){
            var _isactive=0,filterholder=null,config=grid.config.headerFilter;
            if(!$.isPlain(config)){config={}}
            function setup(){
                if(grid.config.filterContainer && !$d.q(grid.config.filterContainer,".grid-filter")){
                    var filters=grid.filters||(grid.filters=[]),
                        tip="<span class='grid-filter-tip' style='float:left;margin-top:0;margin-left:20px;padding:0 3px;border: 1px solid #ccc;color:#666;font-size:.9rem;background-color:white;'>Add filter</span>";
                    var  colLkupMap={},Core=self.CoreUtils      , eltemplateEl, eltemplate="" +
                        "<span class='filter-elem-wrap'> " +
                        "  <div class='filter-elem_ph'></div>" +
                        "  <div class='filter-elem'></div>" +
                        "  <div class='filter-elem-add'>+</div>" +
                        "</span>";

                    grid.config.filterContainer.insert("<div class='ui-lighter grid-filter'>" +
                        "  <div class='bluegrdnt grid-filter-stub'> </div>" +
                        "  <div class='content grid-filter-content  ui-lighter'>"+tip+"</div>" +
                        "</div>").q(".grid-filter-content")
                    var wrap=grid.config.filterContainer.q(".grid-filter-content")
                    filterholder=new Data.criteria({meta:grid.store.meta});
                    var PopupView= $.require("PopupView")
                    var controller={
                        removeElement:function(fltritem,v,anchor){
                            filterholder.remove(fltritem.col,v )
                        },
                        showColList:function(fltritem,v,anchor){

                            var vw= null//wrap.data("_colpopup")
                            if(!vw){
                                vw=PopupView.lookupList(
                                    {keyname:"name",labelname:"label",

                                        list:grid.store.meta.collect(function(it){return {name:it.name,label:it.label}}).slice()
                                        .filter(function(a){return a.name != "id" && a.label && a.label.length>1 && (!config.filterColumns || config.filterColumns.indexOf(a.name)>=0 ) && (!config.ignoreColumns || config.ignoreColumns.indexOf(a.name)==-1 )})
                                    },
                                    {maxWidth:250,minWidth:100,
                                    anchor:anchor,
                                        callback:function(rec){var ky=rec.name,lbl=rec.label

                                            if(!filterholder.findElement(ky)){filterholder.append(ky)}
                                            var fltritem=filterholder.findElement(ky);
                                            //var anchor=$d.selfOrUp(([].slice.call(document.querySelectorAll(":hover"))).pop(),".list-item")
                                            controller.showValList(fltritem,ky,anchor,lbl )
                                            vw.hide();
                                            //filterholder.append(ky,"","=",lbl,true);
                                            //controller.updateView(fltritem,v,anchor,function(){
                                            //    controller.showValList(ky,v,vw.config.anchor )
                                            //})

                                        }
                                });

                                wrap.data("_colpopup",vw)
                                /*wrap.data("_colpopup",vw=View.lookupList({anchor:anchor,width:150,height:200, bottomAligned:true ,
                                    keyname:"name",labelname:"label" ,list:{list:grid.store.meta.collect(function(it){return {name:it.name,label:it.label}}).slice().filter(function(a){return a.name != "id" && a.label && a.label.length>1})}
                                },function(ky,lbl){
                                    if(!filterholder.findElement(ky)){filterholder.append(ky)}
                                    fltritem=filterholder.findElement(ky)
                                    controller.showValList(fltritem,v,vw.config.anchor )
                                    //filterholder.append(ky,"","=",lbl,true);
                                    //controller.updateView(fltritem,v,anchor,function(){
                                    //    controller.showValList(ky,v,vw.config.anchor )
                                    //})

                                }))*/
                            }
                            if(vw.config.options){vw.config.options.anchor=anchor}
                            else{vw.config.anchor=anchor}
                            vw.show( ) ;
                        },
                        showValList:function(fltritem,v,anchor,lbl){
                            //b,col,upd
                            //var vw= wrap.data("_wrappopup"),k= fltritem.col;
                            //if(!vw){
                                var vw=PopupView.lookupList([],
                                    {alignAnchor:"below" ,maxWidth:250,minWidth:150,
                                        callback:function(rec){
                                        var v=rec.name||rec.id,lbl=rec.label
                                        if(v==null){return}
                                        var col= vw.config.col,idx=vw.config.isupdate[0],lkupdata=vw.lkupdata;
                                        if(lkupdata && !lbl){
                                            for(var i= 0,l=lkupdata.list||lkupdata ,ln=l.length||0;i<ln;i++){
                                                if(l[i].id==v ){
                                                    lbl=l[i].label||l[i].value||v
                                                }
                                            }

                                        }
                                        if(idx>=0){
                                            filterholder.update(col,v,lbl,idx)
                                        }
                                        else{
                                            filterholder.append( col,v,null,lbl)
                                        }
                                            vw.hide()
                                        //var fltritem2=filterholder.findElement(col)
                                        //controller.updateView( fltritem2,idx,null,null)
                                    }}
                                )
                                /*wrap.data("_wrappopup",vw=View.lookupList({uiklass:"nowrap",anchor:anchor,width:250,height:200, bottomAligned:true},
                                    function(v,lbl){if(v==null){return}
                                        var col= vw.config.col,idx=vw.config.isupdate[0],lkupdata=vw.lkupdata;
                                        if(lkupdata && !lbl){
                                                for(var i= 0,l=lkupdata.list||lkupdata ,ln=l.length||0;i<ln;i++){
                                                    if(l[i].id==v ){
                                                        lbl=l[i].label||l[i].value||v
                                                    }
                                                }

                                        }
                                        if(idx>=0){
                                            filterholder.update(col,v,lbl,idx)
                                        }
                                        else{
                                            filterholder.append( col,v,null,lbl)
                                        }
                                        //var fltritem2=filterholder.findElement(col)
                                        //controller.updateView( fltritem2,idx,null,null)
                                    }))
                            }*/
                            vw.contentWrap.css("backgroundColor","#f9f9f9")
                            vw.config.col=fltritem.col;
                            vw.config.isupdate= [typeof(v)=="number"&&v>=0?v:-1];
                            $d.html(vw.config.header,"<h4>"+(fltritem.title||lbl||v||"")+"</h4><input type='search' style='width:100px;' class='search-box'/><span style='display: inline-block;margin-left:10px;' class='item-count'></span>")
                            var srchbox=$d(vw.config.header).q(".search-box")
                            srchbox.on("click",function(ev){
                                var val=this.val()
                                if(val){
                                    if(this.bounds().right-ev.x <20){
                                        this.val("");
                                        var items=this.up(".popup-view").qq(".list-item")
                                        items.css("display","block");
                                        this.up(".popup-view").q(".item-count").html(items.length)
                                    }
                                }
                            })
                            srchbox.on("keyup",function(ev){
                                var cnt= 0,val=this.val(),items=this.up(".popup-view").qq(".list-item")
                                if(val){val=val.toLowerCase()
                                    items.each(function(a){
                                        var vis=$d.text(a).toLowerCase().indexOf(val)>=0
                                        vis && cnt++;
                                        a.css("display",vis?"block":"none")
                                    })
                                } else{
                                    items.css("display","block")
                                    cnt=items.length
                                }
                                this.up(".popup-view").q(".item-count").html(cnt)
                            })
                            if(vw.config.options){vw.config.options.anchor=anchor}
                            else{vw.config.anchor=anchor}
                            var f=grid.store.meta?grid.store.meta.findField(fltritem.col):null
                            var crit
                            if(f&& !( f.primaryEntity)){
                                crit=grid.store.defaultCriteria
                            }
                            filterholder.getLookupList(fltritem.col,false,crit ).then(function(data){
                                vw.renderList(data,{anchor:anchor})
                                var list=data.data||data.list||data
                                vw.el.q(".item-count") && vw.el.q(".item-count").html(list.length)
                                //vw.lkupdata=data
                                vw.show( ) ;//data,anchor

                            });
                        },
                        updateView:function( fltritem,v,anchor,cb){

                            var  curr=grid.pager.filter||"";
                             var redrw=false;
                            if(filterholder.empty()){
                                grid.pager.filter="_clear_" ;
                                grid.pager.loadPage()
                            } else {
                                var js=grid.pager.isCachedLocal?filterholder.toJs(grid.pager.isCachedLocal):filterholder.toSql();
                                 if(grid.pager.update({filter:js})){
                                     grid.pager.loadPage()
                                }
                            }
                            //  if(redrw){ grid._renderer.redraw()  }
                            wrap.clear();
                            filterholder.collect(function(k,mdl){
                                if(mdl==null||mdl==""){return}
                                var nu=wrap.q("[data-key='"+k+"']")
                                var val=mdl.val,title=String(  mdl.title||k).trim()
                                var lst=[]
                                if(  val &&val.length){
                                    val=val.filter(function(it){return !(it.value==null||it.value=="undefined")})
                                    val.elem=nu;
                                    lst=val
                                }
                                if(  !lst.length ){
                                    return;
                                }
                                 if(!nu){
                                    if(!eltemplateEl){ eltemplateEl=$d(eltemplate) }


                                    nu=addel?addel.before(eltemplateEl.el.cloneNode(true)):wrap.append(eltemplateEl.el.cloneNode(true))
                                    nu.dataset.key=k   ; //nu.dataset.index=idx;
                                    nu.q(".filter-elem_ph").html(title )//.append("<div class='filter-elem-remove'>x</div>")
                                }


                                    var addel=nu.q(".filter-elem-add"),lkup;
                                    filterholder.getLookupList(k).then(function(data){
                                        lkup=data
                                    });
                                     lst.forEach(function(v){if(v==""||v==null){return}
                                        if(typeof(v)!="object"){v={value:v,label:v}}
                                        var el=nu.q(".filter-elem")||$d(nu.append("<div class='filter-elem'></div>"));
                                        var v1=v.value,cln=el.el.cloneNode(true),lbl=String(  v.label||v1).trim();cln.id="";
                                         if(addel){cln=addel.before(cln)}
                                        else{cln=  nu.append(cln );}


                                        cln.html(lbl);
                                        cln.append("<div class='filter-elem-remove'>x</div>")
                                        cln.title=cln.dataset.val=v1
                                    });
                                    var all=nu.qq(".filter-elem");
                                    if(all.length>1){all.forEach(function(it){if(!String(it.textContent).trim()){nu.el.removeChild(it.el||it)}})}
                                    nu.addClass("has-value") ;
                                    // nu.addClass("has-value").q(".filter-elem").html(  lbl)
                                //} else{ nu&&nu.removeClass("has-value")}
                                return nu
                            })  ;

                            wrap.append(tip)
                            grid.fire("viewupdate" );
                            wrap.qq(".filter-elem-wrap").forEach(function(it){if(it.scrollWidth-it.offsetWidth>0){it.style.width=(it.scrollWidth+1)+"px"}})
                            if(typeof(cb)=="function"){cb()}
                        }
                    }
                    filterholder.on("change",function(){
                        controller.updateView();
                    })
                     wrap.on("mousedown",function(evt){
                        if(evt.which==3||!_isactive){return}
                         var act,idx,fltritem,r=UI.Rect.create(evt),v=null;
                        r.top=wrap.bounds().bottom
                        var elem=$d.selfOrUp(evt.target,".filter-elem-wrap")
                        if(elem && elem.contains(evt.target)){
                            var k=elem.dataset.key , el=elem

                            var c=filterholder.meta.findField(k)
                            if(c){fltritem=filterholder.findElement(c.name)}
                            if(!fltritem){
                                filterholder.append(c.name)
                                fltritem=filterholder.findElement(c.name)
                                if(!fltritem){return}
                            }
                            var felem=$d.selfOrUp(evt.target,".filter-elem");
                            if(felem){
                                v=felem.dataset.val;
                                var arr=[].concat(fltritem.val)
                                if(!v){return}
                                idx=arr.indexOf(arr.find(function(it){return it.value==v}))
                                if(idx>=0&&$d.selfOrUp(evt.target,".filter-elem-remove")){
                                    v=idx;
                                     act=controller.removeElement
                                } else{   v=idx>=0?idx:v;
                                    act=controller.showValList;
                                }

                            } else {
                                if($d.selfOrUp(evt.target,".filter-elem-remove")){
                                    act=controller.removeElement
                                } else{act=controller.showValList}
                            }
                        } else{act=controller.showColList}
                        if(act){act.call(controller,fltritem,v, evt.target)}

                    })
                }
                grid.headerFilter=this;
            }
            return {   label:"Header Filter",
                getCriteriaHolder:function(){return filterholder},
                setup:function(){
                    this.activate();
                    return this;
                },
                activate:function(){  _isactive=1
                    setup.call(this)
                },
                remove:function(){_isactive=false;}
            };
        } ,
        infiniteScroll:function setupInfiniteScroll(grid){  var _isactive=0;
            //wr wrap
            function setup(){
                var wrp=grid.domcomponents.gridWrap,doc=document,clht=wrp.clientHeight, store=grid.store , rowht=20,
                    _addrowsbound=grid._renderer.addrows.bind(wrp._renderer), tab=grid.domcomponents.tab,rowset=grid.domcomponents.rowset,lasrscroll=0
                    var pageCache={}
                    if(rowset.q(".activepage")){return}
                    var _firstlastview=function(){
                        var b=wrp.getBoundingClientRect()
                        var top,top1=doc.elementFromPoint(b.left+30,b.top+15),//,".grid-row"),
                            last=doc.elementFromPoint(b.left+30,b.bottom-15),curr={};
                        if(top1&&!top1.classList.contains("grid-row")){top1=$d.up(top1,".grid-row")}
                        if(last&&!last.classList.contains("grid-row")){last=$d.up(last,".grid-row")}
                        return {top:top1,last:last}
                    }
                    var _handle=function(){
                         //if(tdif>1000){
                        var pr=Promise.deferred(),grid=this ,msg=grid.domcomponents.loadmsg,
                            lastrow=grid.domcomponents.tab.querySelector(".grid-rowset .grid-row:last-child")

                        grid.pager.next()
                        var scrtp=wrp.scrollTop
                        grid.pager.getPage(false,function(records){
                            grid.observer.once("afterpageload",function(){
                               if( grid.pager.pageno==grid.pager.totalpages){
                                    if(cmp.rowset.tagName!="TBODY"){
                                        cmp.rowset.style.height="auto"
                                    }
                                }
                                 if(msg){msg.html("...")};pr.resolve()
                            });
                            grid._renderer.renderRows(records,true)
                            //if(lastrow&&lastrow.scrollIntoView){
                               // lastrow.scrollIntoView(false);lastrow.classList.add("selected")
                           // }

                        })
                            return pr;
                        //}
                    }.bind(grid);
                var cmp=grid.domcomponents,scrollTreshold=  50  ,pageheight=0 ,totalheight=0
                function _onscroll (ev){

                    var grid=this,store=grid.store,cmp=grid.domcomponents,wrp=grid.domcomponents.gridWrap,tab=cmp.tab,nw=Date.now(),tdif=nw-lasrscroll,
                        tp=wrp.scrollTop,oldtp=wrp._scrollTop  ,pager=this.pager
                    wrp._scrollTop=tp;
                    if((oldtp && oldtp>tp) || pager.pageno>=pager.totalpages){return}
                    var vw=_firstlastview()

                     if(oldtp && oldtp>tp){return}//if moving up return
                    var  pr,t=tab.offsetHeight,ch=wrp.clientHeight,tot=tp+ ch,
                        last=tab.querySelector(".grid-rowset .grid-row:last-child"),t1=0,b;
                    if(!last) {return}
                    b=last.getBoundingClientRect()
                    t1=(b.top+b.height+10) -  wrp.getBoundingClientRect().top
                    wrp._lastDiff= tot-t1;lasrscroll=nw;
                     if(t1<(2*ch) ){
                         pr=_handle();
                     }

                    if(wrp._scrollLeft===tp){return}
                    wrp._scrollLeft=tp ;

                    cmp.headerclone&&(cmp.headerclone.style.left=(1-wrp.scrollLeft)+"px");
                    return pr
                };
                if(!pageheight) {pageheight=cmp.rowset.offsetHeight}
                if(pager.totalpages){
                    totalheight=pageheight*pager.totalpages
                    if(cmp.rowset.tagName!="TBODY"){
                        cmp.rowset.style.height=totalheight+"px"
                    }
                }
                grid.on("scroll", $.throttle(_onscroll,10))
                if(pager.totalrows*rowht> wrp.offsetHeight){
                    // var el=wrp.insertBefore(document.createElement("div"),tab); el.classList.add("scroll-fit")
                    //    DomCore.css(el,{ h:( store.pager.totalrows*rowht)+"px"})
                }
            }
            return {    label:"Infinite Scroll",
                setup:function(){
                    this.activate();
                    return this;
                },
                activate:function(){
                    setup.call(this)
                },
                remove:function(){_isactive=false;}
            };
        },
        ColumnFreeze:function(grid){
            var _isactive= 0,wrp,numofcols= 2,outer,Dom=DomCore,optns={},gwrp,colcnt,bdy,wrphdrht= 0,hdr;
            var lastctx={},  doc=document
            function proc(){ if(!_isactive){return}
                var headerclone=grid.domcomponents.headerclone,
                    headerrow=headerclone?headerclone.q(".grid-row"):grid.domcomponents.tabheader.q(".grid-row"),ifo=grid.domcomponents.hdrInfo(),
                    wrpbdy= wrp?wrp.querySelector(".grid-rowset"):null,
                    wrp_hdr= wrpbdy?wrpbdy.previousElementSibling:null;
                var b=gwrp.getBoundingClientRect()    ,w10=(wrp?wrp.offsetWidth: b.width)+10
                var top,top1=doc.elementFromPoint(b.left+w10,b.top+15),//,".grid-row"),
                    last=Dom.up(doc.elementFromPoint(b.left+w10,b.bottom-15),".grid-row"),curr={};

                if(wrpbdy){[].forEach.call(wrpbdy.querySelectorAll(".grid-row"),function(r){curr[r.dataset.id]=r});}
                if(gwrp.scrollTop<20){
                    top=bdy.el.firstElementChild;
                } else if(top1 && !Dom.up(top1,".grid-rowset")){
                    top1.style.display="none";
                    top=Dom.up(doc.elementFromPoint(b.left+w10,b.top+15),".grid-row")
                    top1.style.display="";
                } else{top=Dom.up(top1,".grid-row")}

                if(headerclone && gwrp.scrollLeft>0) {headerclone.el.style.marginLeft=(0-gwrp.scrollLeft)+"px"}
                var i= 5,mx=150;
                while(!last){i=i+15;if(i>mx){break;}
                    last=Dom.up(doc.elementFromPoint(b.left+w10,b.bottom-i),".grid-row")
                }

                if(top && last){//top.style.backgroundColor="red";last.style.backgroundColor="red"
                    if(lastctx.top===top && lastctx.last===last  ) {return}
                    lastctx.top=top ;lastctx.last=last
                    last=last.nextElementSibling    ||last
                    last=last.nextElementSibling    ||last
                    var w= [],rw=top,idx=-1,//clrows=$.makeArray(wrpbdy.children),
                        tofset= top.getBoundingClientRect().top - headerrow.getBoundingClientRect().bottom ;

                    //   _syncset(hdr,wrp_hdr)
                    var nurows=[], ccnt=colcnt ,nunu=[]
                    while(rw){var _id=rw.dataset.id||"";
                        if( !w.length){
                            for(var i=0;i<ccnt;i++){w.push(rw.children[i].offsetWidth)}
                        }
                        if(_id && curr[_id]){   curr[_id].className=rw.className
                            nurows.push(curr[_id]);
                            delete curr[_id]
                        }
                        else {
                            var rw1=rw.cloneNode(false);  rw1.id="";
                            rw1.className=rw.className      ;  rw1.classList.add("grid-clone-row") ;
                            rw1.style.height=rw.offsetHeight+"px"
                            for(var i=0;i<ccnt;i++){ var c=rw.children[i];if(!(w[i] && c)){continue;}
                                var nu= c.cloneNode(true) ,stl=nu.style ;
                                stl.minWidth=stl.maxWidth=stl.width=w[i]+"px"//Dom.css(c,"width");
                                rw1.appendChild(nu)
                            }
                            nunu.push([rw1,rw])
                            nurows.push(rw1);
                        }
                        //_syncset(rw,rw1)
                        if(rw===last){break;}
                        rw=rw.nextElementSibling;
                    }
                    for(var k in curr){curr[k].parentNode && curr[k].parentNode.removeChild(curr[k])}
                    while(nurows.length){wrpbdy.appendChild(nurows.shift());}
                    for(var i=0;i<ccnt;i++){ var c=wrp_hdr.children[i];if(!(w[i] && c)){continue;}
                        var  stl=c.style ;
                        stl.minWidth=stl.maxWidth=stl.width=w[i]+"px"//Dom.css(c,"width");
                    }
                    wrpbdy.style.marginTop=Math.min(0,tofset )+"px";
                    var  ww= w.reduce(function(m,it){return m+it},0) ;
                    if(ww>50){wrp.style.width=ww+"px" ;}
                    wrp.style.top=headerclone.style.top ;
                    wrp.style.height=(gwrp.offsetHeight+wrphdrht)+"px" ;


                }
            } ;
            function setup( num,refresh){   if(num>0){numofcols=num;}
                // var gridwr,outer
                outer=grid.domcomponents.outer ;
                gwrp=grid.domcomponents.gridWrap;
                colcnt=Number(numofcols)||Number(grid.config.columnFreeze)|| 1;
                bdy=grid.domcomponents.rowset ;
                hdr=gwrp.q(".grid-tab .grid-header .grid-row");
                if(!Dom){return}
                if(optns.rownum){colcnt++}
                if(!(bdy && bdy.el.childElementCount)){return}
                wrp=outer.q(".grid-columnfreeze-overlay")
                var
                    wrpbdy= wrp?wrp.querySelector(".grid-rowset"):null,
                    wrp_hdr= wrpbdy?wrpbdy.previousElementSibling:null ,
                    headerclone=grid.domcomponents.headerclone,
                    headerrow=headerclone?headerclone.q(".grid-row"):null,ifo=grid.domcomponents.hdrInfo();
                if(!headerclone){return}

                if(headerclone && (refresh===true||!wrp)){
                    //  gwrp.style.top=ifo.bottom+"px";
                    wrp=wrp||Dom(outer.appendChild(document.createElement("div")));wrp.className="grid-columnfreeze-overlay"
                    wrp.clear();
                    wrpbdy=wrp.appendChild(bdy.el.cloneNode(false));
                    Dom.css(wrp ,{l:1,w:0,position:"absolute",overflow:"hidden",borderTop:"none"})
                    wrp_hdr=wrp.insertBefore((hdr.el||hdr).cloneNode(false),wrpbdy)
                    wrp_hdr.style.borderTop="none";wrp_hdr.style.borderTop="#666"; wrp_hdr.style.left="1px";
                    wrp_hdr.style.top="-1px";    wrp_hdr.style.zIndex=ZINDEX.FREEZEOVERLAYHDR;
                    wrp_hdr.style.position="absolute";   wrp_hdr.style.display="block";

                    Dom.css(wrpbdy,{overflow:"hidden",padding:0,borderTop:"none",margin:0,position:"absolute",l:0,w:"100%",
                        zIndex:ZINDEX.FREEZEBODY});
                    for(var i=0;i<colcnt;i++){
                        wrp_hdr.appendChild(hdr.children[i].cloneNode(true));
                    }
                    wrphdrht=Number(String((headerclone||hdr).q(".grid-row").css("height")).replace(/[^\d\.]/g,""))
                    wrpbdy.style.height=gwrp.offsetHeight  +"px";wrpbdy.style.top=(wrphdrht+2)  +"px"
                    wrp_hdr.style.lineHeight= wrp_hdr.style.height  =wrphdrht+"px";
                    Dom.qq(wrp_hdr,".grid-header-cell,.grid-row").forEach(function(c){c.style.lineHeight= c.style.height= wrphdrht+"px";})
                }

                this.domcomponents.gridWrap.__onscroll||
                this.domcomponents.gridWrap.on("scroll",this.domcomponents.gridWrap.gridWrap.__onscroll=function(ev){
                    grid.fire("scroll",ev)
                });
                if(!refresh){
                    grid.on("scroll afterpageload aftercolresize", $.throttle(proc, {immediate:true,delay:10} ) );
                    grid.on("afterresize uireset", function(){if(_isactive){setup(0,true)} });


                }
                //wrp.onscroll=function(){setTimeout(cb,100)} ;
                proc()
                setTimeout(proc,10)  ; setTimeout(proc,50)
            }
            return {
                label:"Freeze Columns",
                optns:["number_of_Columns"],
                setup:function(){  return this;   },
                activate:function(num){
                    if(_isactive){return}
                    _isactive=1;
                    setTimeout(setup.bind(this),100,num)   ;
                    grid.on("render",function(){ if(_isactive){setup(0,true);setTimeout(proc,100);} })
                    return this;

                },
                remove:function(){
                    if(wrp && wrp.parentNode){wrp.parentNode.removeChild(wrp.el||wrp)}
                    _isactive=false;
                }
            };
        },
        /*gridMenu:function(g){
            var featurelist,link,popupvw,_isactive,grid= g,optns={};
            return {
                setup:function(){
                    if(g.buttonBar&&!g.buttonBar.q(".icon-cog")){
                    link= g.buttonBar.append("<button><a class='icon-cog'></a></button>")
                        .on("click",function(){this.activate()}.bind(this)).hide()
                    }
                    return this;
                },
                activate:function(val){
                    if(!popupvw){
                        var meta=grid.store.meta,collist=meta.getNames();
                        var plugins= DataGrid.plugins,list
                        plugins.nowrap||(plugins.nowrap=function(g){
                            var grid=g;
                            return {
                                setup:function(){grid.nowrap=this;
                                    this.activate()},
                                activate:function(){
                                grid.domcomponents.gridWrap.classList.add("nowrap")
                                grid.domcomponents.gridWrap.classList.remove("fitLayout")
                                grid.domcomponents.gridWrap.st(".grid-cell,.grid-header-cell").css({maxWidth:"-delete-",minWidth:"-delete-",width:"auto"})

                            },remove:function(){
                                grid.domcomponents.gridWrap.classList.remove("nowrap")
                                grid.domcomponents.gridWrap.classList.add("fitLayout")
                            },label:"No wrap"}
                        });
                        list=Object.keys( plugins).reduce(
                            function(m,k){var p=plugins[k](grid),l=p.label;
                                if(l){m.push({id:k,label:l,optns: p.optns})}return m;
                            },[]);
                        popupvw=View.popup({anchor:link,width:400,height:300, hideOnBlur:true,
                            panels:[ "columns","Sort","features"]

                        });
                        popupvw.addLayout("tab");
                        //
                         featurelist=View.lookupList({aspanel:true  , list:{list:list ,keyname:"id",
                                labelprovider:function(v){
                                    return ("<label style='position:relative;margin-left:30px;display:block' for='lookup_"+v.id+"'>" +
                                        "<input id='lookup_"+ v.id+"' value='"+v.id+"'"+(grid[v.id]?"checked='checked'":"")+" type='checkbox'/>"+( v.label)
                                        +
                                        (v.optns?"<div class='icon-arrow-down optn-expand' style='position:absolute;top:5px;right:2px;cursor:pointer:z-index:10'> </div>":"")
                                        +"</label>")}  }
                            },function(k,lbl){ var v=list.find(function(it){return it.id==k}),
                                ip=document.getElementById("lookup_"+ k)
                                if(v && v.optns){
                                    var nu,lbl,nu,ip=document.getElementById("lookup_"+ k)
                                    if(ip){lbl=ip.parentNode}
                                    if(lbl&&!(nu=lbl.nextElementSibling)){
                                        nu=$d.after(lbl,"<div style='line-height:2em'></div>")
                                    }
                                    nu=$d(nu);//nu.clear();
                                    if(!nu.q(".optnstext")){    var  _id=k;
                                        v.optns.map(function(k){
                                            nu.append("<label>"+String(k).replace(/^\w|_\w/g,function(a){return " "+a.split("").pop().toUpperCase()}).trim()+"<input class='optnstext' data-ref='"+k+"'data-name='"+k+"' style='width:60px;'/></label>")
                                            nu.q("input").el.onchange=function(evt){
                                                var el=this,ip=el.parentNode.parentNode.previousElementSibling.querySelector("input"),id=ip.value
                                                optns[id]=el.value;
                                                if(ip && plugins[id]){
                                                    if(ip.checked){
                                                        if(!grid[id]){grid[id]=plugins[id](grid)}
                                                        else{grid[id].remove && grid[id].remove()}
                                                        grid[id].activate(el.value)
                                                    }
                                                }}
                                        });
                                    }
                                }
                                ip.onchange=function(evt){
                                    var ip=this,id=ip.value
                                    if(plugins[id]){
                                        if(ip.checked){
                                            if(!grid[id]){grid[id]=plugins[id](grid);
                                                grid[id].setup( optns[id])
                                            }
                                            grid[id]&&grid[id].activate( optns[id])

                                        } else if(grid[id]) {grid[id].remove()}
                                    }
                                }


                            }
                        );


                        var curr=grid.cols.map(function(it){return it.name}),allcols=collist.map(function(it){return meta.findField(it)||{name:it,label:it}}),
                            list1={ keyname:"id",labelname:"label",list:allcols.map(function(it){return {id:it.name,label:(it.label=="-")||(it.label=="/")?it.name:it.label}})},
                            lbl=$.template(
                                $d.template(
                                    "label[style=d:b].col>input[type=checkbox][value=`id].chx+span{`label}"
                                ).render().html().replace(/`/g,"$"))
                        var columnlist=View.lookupList({aspanel:true ,list:list1,labelprovider:lbl})
                        var sortlist=View.lookupList({aspanel:true ,list:list1});
                        popupvw.columns.addLayout("frame");popupvw.columns.config.hideHeader=true ;
                        popupvw.columns.on("beforeshow",function(){this.contentWrap.qq("label.col .chx").forEach(function(it){it.checked=curr.indexOf(it.value)>=0})});
                        popupvw.columns.addButton("Apply","footer",function(){
                            var nu=this.contentWrap.qq("label.col .chx").filter(function(it){return !!it.checked}).map(function(it){return meta.findField(it.value)})
                            grid.cols.length=0;
                            [].push.apply(grid.cols,nu);
                            grid._renderer.render() ;
                        } )
                        popupvw.Sort.addLayout("frame");
                        popupvw.Sort.config.hideHeader=true;
                        popupvw.Sort.addButton("Apply","footer",function(){})

                        popupvw.columns.contentWrap.css("overflow","hidden")
                        popupvw.features.add(featurelist)
                        popupvw.columns.add( columnlist)
                        popupvw.Sort.add(sortlist)

                     }
                    popupvw.show()
                    popupvw.features.show();//
                    popupvw.el.st(".ui-button-bar").up().toFront();

                    // Popupvw.sort1.show();
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        },*/
        inlineEditor:function(g){
            g.config.ignoreupdate=true
            var config=g.config.inlineEditor;
            if(!$.isPlain(config)){config={}}
            var form= DataGrid.plugins.entityForm(g) ,_isactive,_menu=null,_ctx,wdspan,  _enabled=false, _model=null,_rowmodel
                ,_activeCell,
                _setTabidx=function(){
                     g.domcomponents.tab.st(".grid-rowset .grid-row .grid-cell .cell-content").prop("tabIndex",function(tabidx){return ++tabidx.i},{i:0})
                },

                    _save=function( ){ var cx=_rowmodel
                         if(cx&& cx.record&&cx.id){
                             if(config.onrowblur){
                                 config.onrowblur.call(g,_rowmodel,_activeCell,"save")
                             }
                             _cancel(false)
                                 g.showStateMsg("saving..")
                                var rec=cx.record,del=g.store.stats.deleted;
                                 rec.save().then(function(){
                                    this.showStateMsg("saved..").showStateMsg("",1000)
                                     rec.resetStatus( )
                                     _rowmodel&&_rowmodel.el&&_rowmodel.el.st(".edit-modified").removeClass("edit-modified")
                                 }.bind(g),
                                     function(msg){var m=((msg&&msg.error)?msg.error:msg);
                                         if(m){m="<span style='color:red'>"+m+"</span>"}
                                         this.showStateMsg(m||"error").showStateMsg("",1500)
                                     }.bind(g)
                                 )
                        }
                 } ,
                _cancel=function(norestore ){
                           if(_activeCell&&_activeCell.el) {
                              _activeCell.el.removeClass("edit-active")

                                if(!norestore ){
                                      if(_rowmodel&&_rowmodel.datamodel){
                                         _rowmodel.datamodel[_activeCell.name]=_activeCell.content.val()
                                          _activeCell.content.addClass("edit-modified")
                                      }

                             }

                            _activeCell.content.contentEditable = false;
                        }
                 } ,
                _delete=function(el,ev){  var cx=_rowmodel
                    if(cx&& cx.record&&cx.id){
                        g.store.provider.delete(cx.record).then(function(){
                            this.showStateMsg("deleted..").showStateMsg("",1000)
                                if(_menu){_menu.hide()}
                         }.bind(g)
                        );
                        if(config.onrowblur){
                            config.onrowblur.call(g,_rowmodel,_activeCell,"delete")
                        }
                        _cancel(true); _activeCell=null
                    }
                } ,

                _positionMenu=function(){
                    var cx=_rowmodel
                     if(_menu&&cx){
                         var b=cx.el.q(".cell-content").getBoundingClientRect(),offset=_menu.parent().getBoundingClientRect(),scroll=g.domcomponents.gridWrap.scrollTop;

                         var top=0
                         if(b.top > offset.top){top=((b.top-offset.top) ) }
                         if(b.top < offset.top|| (b.top+ b.height/2)>offset.bottom){
                             _menu.hide();
                         }
                         else{
                             _menu.css({top:top + b.height ,l: (b.right-offset.left)}).show()
                         }

                    }

                },
                _changeRow=function(nu){
                    if(_rowmodel&&_rowmodel===nu){return}
                    if(_rowmodel&&_rowmodel.el){
                        $d.removeClass(_rowmodel.el,"edit-active-row")
                    }
                    var old=_rowmodel;

                    _rowmodel=nu;
                     if(!_rowmodel.datamodel&&_rowmodel.record) {
                             _rowmodel.datamodel = _rowmodel.record//.makeModel(false,true);
                             //_rowmodel.el.data("_model", _rowmodel.datamodel)
                      }
                    if(config.onrowblur){
                        config.onrowblur.call(g,old)
                    }
                    if(config.onrowfocus){
                        config.onrowfocus.call(g,old,_rowmodel)
                    }
                    $d.addClass(_rowmodel.el,"edit-active-row")
                    setTimeout(_positionMenu,10)
            },
                _activate=function(celctx){
                    if(!_enabled||!_rowmodel){return}
                    var curr=_activeCell=cx,cx= celctx,el=celctx.el

                     if(cx&&cx.el&&!cx.el.hasClass("edit-active")){
                        _cancel(true )

                        _activeCell=cx
                        if(!cx.meta){return}
                             el.addClass("edit-active")
                            _rowmodel.el.addClass("edit-active-row")
                            $d.domdata(cx.el,"currval",$d.val(cx.content))
                             var m=_rowmodel.datamodel
                            if(!m ){
                              return
                            }
                            var inst=cx.meta.getUIInstance( )
                             inst.ip=cx.content
                            inst.build({model :m})
                            inst.setValue=cx.render.bind(cx)
                            cx.model=m
                            _ctx=cx
                            if(!inst.hasLookup ){
                                cx.content.contentEditable=true;
                                cx.content.on("blur.inline",function(ev){
                                    if(_rowmodel&&_rowmodel.el&&_rowmodel.el.contains(ev.target)){
                                        var cell=$d.selfOrUp(ev.target,".grid-cell")
                                        if(cell){
                                            var name=$d.domdata(cell,"name")
                                            if(name){
                                                _rowmodel.datamodel[name]=$d.text(ev.target)
                                            }
                                        }
                                    }
                                    _cancel(false );
                                    _activeCell=null
                                });
                             } else{
                                setTimeout(function(){inst.ip.trigger("mousedown")},10);
                            }
                         if(config.onrowblur){
                             config.onrowblur.call(g,_rowmodel,_activeCell)
                         }
                          setTimeout(_positionMenu,10)

                    }
                }

            return {   label:"Inline Cell Editor",
                setup:function(){   _setTabidx()
                    if(!_menu){
                        _menu=$d.template("div.inline-editor-menu.ui-button-group.fxtx_5[abs;opacity:.9;height:20;width:200;]>" +
                            "span.ui-button.small.green[-key:save;display:inline-block;]{Save}+" +
                            "span.ui-button.small.danger[-key:del;display:inline-block;]{Delete}" +""
                            //"span.ui-button.small.danger[-key:cancel;display:inline-block;]{Cancel}"
                        ).render().appendTo(g.domcomponents.gridWrap).q(".inline-editor-menu")
                        _menu.on("click",function(ev,el){var k=el.domdata("key")
                            if(k=="save"){_save()}
                            else if(k=="cancel"){_cancel(true);_activeCell=null}
                            else if(k=="del"){_delete();}

                        },"span")
                        _menu.hide()
                        _enabled=true;
                        g.on("viewupdate",_cancel);
                        g.on("afterrender",_setTabidx)
                        g.on("rowselected.inlineeditor",function(ev){
                            _changeRow(ev)
                        })
                        g.domcomponents.rowset.on("mousedown",function(ev,el){
                            var nur=g.getRow($d.selfOrUp(el,".grid-row"));
                            if(nur){
                                _changeRow(nur)
                                var celctx=nur.getCell(el)
                                celctx&&_activate(celctx)
                            }
                         },".grid-cell")
                        g.domcomponents.gridWrap.on("scroll",_positionMenu)

                    }
                    return this;
                },
                activate:function(){
                    form.activate();
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        },
        popupEditor:function(g){
            var form= DataGrid.plugins.entityForm(g) ,_isactive
            return {   label:"Popup Editor",
                setup:function(){
                    form.setup();
                    return this;
                },
                activate:function(){
                    form.activate();
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        },
        entityForm:function(g){
            var grid= g,formView,_rowActions=[],_isactive,_buttons={edit:null,add:null},
                _formInst=null,spec=g.config.entityForm ||{},_temmplateformInst={},
                _formClass=null,
                _panel=spec.panel,isDialog;
            if(g.data("entityForm")){return}
             g.data("entityForm",1)
             function newForm(){editForm()}
            function setupForm(rec,callback){


                if(callback===true){callback=editForm}
                callback=typeof(callback)=="function"?callback:function(){}
                if(spec.setUp){
                    _formInst=spec.setUp(g,rec)
                    formView=_formInst._view
                    callback(rec,_formInst)
                } else {
                    var template = spec.template, vw = formView, store = grid.store;
                    var currentrec = rec ? rec.clone() : g.store.StoreRecordProto.constructor.newInstance()
                    if (typeof(spec.template) == "function") {
                        template = spec.template(rec)
                    }
                    _formInst = _temmplateformInst[template || "_default"]
                    if (!vw) {
                        vw = _panel || g.config.formPanel || spec.panel
                        if (!vw) {
                            var PopupView = $.require("PopupView")
                            vw = new PopupView({
                                resizable: true,
                                centered: true,
                                title: $.titleize(spec.title || g.store.meta.name || ""),
                                height: spec.height || 400,
                                width: spec.width || 500
                            })//,layouts:"panel",footer:{height:40}})
                            isDialog = true
                            vw.observer.on("beforehide", function (el) {
                                if (el && $d.selfOrUp(el, ".popup-view")) {
                                    return false;
                                }

                            })
                        }
                        ;

                    }
					if(vw){formView = vw}
                }
               // if(vw.hasLayout("popup")){isDialog=true}
                formView && formView.show();
                if(!_formInst){
                    $.require("UI.Form",function(f){
                        currentrec.clear()
                             var opts={meta:store.meta,layoutTemplate:template,dataRecord:currentrec,panel:formView}
                        var props=f.classMeta.defaultProperties
                        $.each(spec,function(v,k){
                            if(k in props&&typeof(v)!=="undefined"){
                                opts[k]=v
                            }
                        })
                        opts.panel=opts.panel||formView
                          _formInst=f(opts);
                            _temmplateformInst[template||"_default"]=_formInst
                        _formInst.panel=vw
                          if(spec.oncreate){
                              spec.oncreate(_formInst)
                          }
                         vw.form=_formInst    ;
                             vw.contentWrap.clear();
                        _formInst.appendTo(vw.contentWrap)
                            .on("update",function(data){   });
                        _formInst.dataHandle={store:store}
                        _formInst.dataRecord.reset();
                        if(!spec.nobuttons) {
                            vw.addButton({
                                name: "Save",
                                location: spec.barlocation || (isDialog ? "footer" : "header"),
                                align: "center",
                                callback: function () {
                                    _formInst.save().then(function () {
                                        if (isDialog) {
                                            vw.hide()
                                        }
                                        g.pager.loadPage()
                                        g.fire("save", currentrec)
                                    })
                                }
                            });
                            vw.addButton({
                                name: "Cancel",
                                location: spec.barlocation || (isDialog ? "footer" : "header"),
                                align: "center",
                                callback: function () {
                                    vw.hide()
                                    g.fire("formcancel")
                                }
                            });
                            vw.layout();
                        }

                        g.fire("entityform",_formInst)
                        if(_formInst&&rec){_formInst.reset(rec.toMap())}
                             setTimeout( callback,0,rec,_formInst)
                        })
                } else {
                    _formInst.reset(rec?rec.toMap():null)
                    callback(rec,_formInst)
                }
            }
            function editForm(rec,fi){
                var vw= formView,store=grid.store,editmode=rec?"edit":"new" ;
                vw.record=rec||"null"
                vw.show();
                if(fi){
                    fi.editmode=editmode
                    fi.dataRecord =rec
                    rec && fi.reset(rec.toMap())
                } else{
                    setupForm(rec,function(rec,formInst){
                        if(formInst){
                            formInst.editmode=editmode
                            formInst.dataRecord=rec
                            rec && formInst.reset(rec.toMap())
                   // _formInst.reset((rec && rec.id)?rec.toMap():null)
                } else{ }

                    })
                }
                vw.setTitle&&vw.setTitle(
                    ($.titleize(spec.title||store.meta.name) +": "+(rec?rec.lbl:"")||"").replace(/undefined/,"")
                )


            }
            function _addLinks(config ){
                var links=(config||{}).links||[ "refresh","sep","addrow","edit","del","sep","settings"],opts=grid.config.editoptions||{}
                if(!spec.readonly){
                    if(opts.add!=null && !opts.add && links.indexOf("addrow")>=0){links.splice(links.indexOf("addrow"),1)}
                    if(opts.edit!=null && !opts.edit && links.indexOf("edit")>=0){links.splice(links.indexOf("edit"),1)}
                     if(opts.export){
                        opts.export= $.isPlain(opts.export)?opts.export:{}
                         opts.export.text=opts.export.text||"Export"
                        links.push( "export" )
                    }
                    if(opts.del!=null && !opts.del && links.indexOf("del")>=0){links.splice(links.indexOf("del"),1)}
                    if(!grid.domcomponents.toolbar.q("[data-cmd='edit']")) {
                        grid.iconBar=DataGrid.IconBar(grid,{floatable:true})
                        links.forEach(function(a){
                            grid.iconBar.add(a,opts[a])
                        })
                        grid.iconBar.getBar().prepend("<span class='ui-toolbar-status-message'></span>")
                        grid.iconBar.appendTo(grid.domcomponents.toolbar)

                        /*grid.domcomponents.toolbar.append ("<span class='ui-toolbar-status-message'></span>"+
                            links.map(function(a){return "<span data-cmd='$key' title='$key' class='ui-button-gl gl-icon-$key'></span>".replace(/\$key/g,a)}).join("")
                        )*/
                    }
 /*
                     if(!_buttons.add){
                        _buttons.add=grid.addButton({name:"Add",location:"header",callback:setupForm.bind(null,null,editForm )} );
                    }
                    if(!_buttons.edit){
                        _buttons.edit=grid.addButton({
                            name:"Edit", location:"header", callback:function(){
                                this.selectedRecord && this.selectedRecord.id && setupForm(this.selectedRecord,editForm);
                            }
                        });
                        _rowActions.push(_buttons.edit)
                    }
                    if(!_buttons.del){
                        _buttons.del=grid.addButton({
                            name:"Remove", location:"header", callback:function(){
                                this.selectedRecord && this.selectedRecord.id && this.store.provider[ "delete"](this.selectedRecord.id);
                            }
                        });
                        _rowActions.push(_buttons.del)
                    }*/
                    }
                return this
                }
            function _setup( ){
                if(grid.data("_formbutons")){return}

                if(spec.buttons){
                    $.each(spec.buttons,function(v,k){
                        var nm=typeof(k)=="string"?k:v.name
                        if(nm&&!_buttons[nm]&&v.callback){
                            _buttons[nm]=grid.addButton({name: v.label||nm,location:"header", klass: v.klass,style: v.style,callback: v.callback.bind(g,editForm )} );
                            if(v.rowaction){
                                _rowActions.push(_buttons[nm])
                            }
                        }
                    })
                }
                //if(!_buttons.add){setTimeout(_setup,500)}
                //else{

                    grid.on("viewupdate",function(pager){
                        _rowActions.forEach(
                            function(v,k){v.disable()}
                        );
                     });
                    grid.on("rowselected",function(r){
                        _rowActions.forEach(
                            function(v,k){v.enable()}
                        );
                    });
                grid.on("colselected",function(r){

                });
                grid.data("_formbutons",1)
                 if(grid.domcomponents.frameheader.q(".ui-button")){
                        return
                }
                if(grid.buttonBar){$d.toFront(grid.buttonBar)}


            }
            return {   label:"  Editor",
                getFormInst:function(){return _formInst},
                setPanel:function(p){_panel=p;return this},
                getPanel:function(){return formView||_panel},
                setupForm:setupForm,
                setup:function(){
                    this.activate();

                    grid.on("afterrender.grid",_setup)
                     return this;
                },
                activate:function( ){
                    _setup.call(this )    ;
                    return this;

                },
                addLinks:_addLinks,
                remove:function(){_isactive=false;}
            };
        } ,
        groupView: function(grid){
            return {
                label   :"Group View",
                setup   :function(){

                },
                activate:function(){

                },
                clear   :function(){

                }
            }
        },
        facetView: function(grid){
            var _isactive= 0,facetcols;
            return {   label:"Facet View",
                setup:function(){
                    this.activate();
                    return this;
                },
                activate:function(){
                    if(_isactive){return}
                    _isactive=1;
                    facetcols||(facetcols=grid.store.meta.findAll(function(it){return it.name!="id"}));
                    var facetList=new View("facetList","accordion",{width:200,location:"left"}),recs=grid.store.records
                    var facetPanels=facetcols.map(function(it){var nm=it.name;
                        var ll=recs.pluck(it.name).collect(function(it){ return it.format?it.format():String(it)}).uniq().sort();
                        var PopupView= $.require("PopupView")
                        return PopupView.lookupList(ll, {
                            id: it.name, label: it.label, aspanel: true, callback: function (rec) {
                                if (rec && rec.row && rec.row.classList) {
                                    if (rec.row.classList.contains("selected")) {
                                        rec.row.classList.remove("selected");
                                    } else {
                                        rec.row.classList.add("selected")
                                    }

                                    var fltr = [].map.call(facetList.contentWrap.querySelectorAll(".listbox-container"), function (f) {
                                        return [].map.call(f.querySelectorAll(".selected"), function (r) {
                                            return "it." + nm + " = '" + r.dataset.key + "'"
                                        }).join(" or ")
                                    }).filter(function (it) {
                                        return it.trim()
                                    }).join(") and (");
                                    fltr = "(" + fltr + ")"

                                    grid.pager.update({filter: fltr});
                                    grid._renderer.redraw(true)
                                }
                            }.bind(it)
                        }
                        ) });

                    facetPanels.forEach(function(it){facetList.add(it)});
                    if(grid.panel._parent){
                        var vw=grid.panel._parent;
                        grid.panel.config.location="center"
                        vw.add(facetList); grid.panel.removeLayout("fill");
                        vw.addLayout("border");
                        vw.layout();
                    }
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        }
    }

    DataGrid.generateTemplate=function(config){
        var cols=config.cols||[],rowname=config.rowname||"row"

        var hdrs=[],names=[],cellklass=((config.cellklass||"")+" grid-cell").trim();
        cols.forEach(function(a){if(!a){return}
            var name=typeof(a)=="string"?a: a.name,lbl=a.label|| $.titleize(name||"")
            if(!name){return}
            hdrs.push("<th  class='grid-header-cell'>"+lbl+"</th>")
            names.push("<td class='"+cellklass+"'>$"+name+"</td>")
        })
        var tmplate="<div class='gridtable viewmode-table'><table class='grid-tab'><thead class='grid-header'><tr class='grid-row'>"+hdrs.join("")+"</tr></thead><tbody class='grid-rowset'>$each("+rowname+"){<tr class='grid-row' data-id='$id'>"+names.join("")+"</tr>}</tbody></table></div>"
         return $.template(tmplate)
    }
if(typeof(View)!="undefined"){
    View.DataGrid=DataGrid
}
    DataGrid.IconBar=function(view,opts){
        if(!opts&& $.isPlain(view)){opts=view;view=null}
        var _bar=null,els={},_lastel=null,options= $.extend({floatable:false,controller:null,style:null,listener:null,template:null,basclass:"ui-button-gl"},opts||{})
        if(typeof(options.listener)!=="function"){options.listener=null}

        if(options.controller&&typeof(options.controller.invoke)!=="function"){options.controller=null}
        if(!options.controller&&view && view.getController ){
            options.controller=view.getController();
        }


        var api={
            getBar:function(){
                if(!_bar){
                    _bar=$d("<div/>").css({ w:"auto" ,overflow:"hidden",paddingBottom: "2px"})
                    _lastel=_bar.append('<span class="ui-button-gl ignore-link1 edge-handle"></span>')
                    if(options.style){_bar.css(options.style)}

                    _bar.on("mousedown",function(ev){
                        ev.stopPropagation&&ev.stopPropagation()
                        var memo={b:_bar.bounds()}
                        if(_bar.parent().el!=document.body||!_bar.data("_origparent")){
                            var bp=UI.Rect.from(memo.b ,true),bp2=_bar.parent().bounds() ;
                            bp.left=Math.min(bp2.left,bp.left-15)
                            bp.top=Math.min(bp2.top,bp.top-15)
                            bp.right=Math.max(bp2.right,bp.right+15)
                            bp.bottom=Math.max(bp2.bottom,bp.bottom+15)

                            _bar.data("_origparent",_bar.parent().id)
                            _bar.data("_origbounds", bp)
                            _bar.data("_orignext",( _bar.next()||{}).id)
                            _bar=_bar.appendTo(document.body)
                            _bar.addClass("layout-floating")
                            _bar.css({top:  memo.b.top,left:  memo.b.left,h:  memo.b.height,width: memo.b.width,position:"fixed"}).toFront(true)
                        }

                        $d.trackMouse({
                            target:_bar,
                            memo:memo ,
                            start:function(ev,memo){memo.point=UI.Point.from(true,memo.b.left,memo.b.top)  },
                            move:function(ev,memo){
                                memo.point.save().plus(ev.delta).applyCss(_bar.el).restore();
                            },end:function(ev,memo){memo.b.refresh()
                                var origpar=$d(_bar.data("_origparent"))
                                if(origpar && !_bar.parent().is(origpar)){
                                    var  bp=_bar.data("_origbounds")
                                    if(bp&&bp.contains(memo.b )) {
                                        var _orignext=$d(_bar.data("_orignext"))
                                        if(_orignext&&_orignext.parent().is(origpar)){_bar=_orignext.before(_bar)}
                                        else{_bar=origpar.append(_bar)}
                                        _bar.data("_origparent",null)
                                        if(!origpar.isAnimating()){origpar.highlight();}
                                        _bar.removeClass("layout-floating")
                                    } else{
                                        _bar.addClass("layout-floating")
                                    }

                                }
                            }

                        })
                    },".gl-icon-draghandle")
                    _bar.pointerselect(function(ev){
                        if(ev&&ev.target&&$d.is(ev.target,".ui-button-gl")){
                            var nm=ev.target.dataset.cmd
                            if(nm==="sep"||nm==="text"||ev.target.classList.contains("disabled") ||ev.target.classList.contains("ignore-link1")){return}
                            var el=els[nm];
                            if(el){
                                if(options.listener){
                                    options.listener(nm,ev)
                                }
                                if(options.controller){
                                    options.controller.invoke(nm,[ev])
                                }
                                if(el.callback){
                                    el.callback(ev)
                                }
                            }
                        }
                    })
                    if(options.floatable){
                        _lastel.addClass("gl-icon-draghandle")
                    } else{
                        _lastel.addClass("gl-icon-blank")
                    }
                }
                return _bar
            },
            getLink:function(nm){
                if(typeof(nm)=="string"){
                    return els[nm]
                } else if(typeof(nm)=="number"){
                    //
                }
            },
            addText:function(txt,pos){this.add("text",{text:txt,pos:pos});return this},
            addSep:function(txt){this.add("sep");return this},
            add:function(nm,detail,pos){

                if(Array.isArray(nm)){
                    nm.forEach(function(k){this.add(k)},this)
                    return this;
                }
                var data={}
                if($.isPlain(detail)){data=detail}
                else if(typeof(detail)=="function"){data.callback=detail}
                else if(typeof(detail)=="string"){data.text=detail}
                else if(typeof(detail)=="number"){data.pos=detail}
                if(typeof(pos)=="number"){data.pos=pos}
                if(nm.indexOf("text")==0){data.key=data.key||nm;nm="textwrap"}
                if(nm.indexOf("sep")==0&&nm!="sep"){data.key=data.key||nm;nm="sep"}
                data.key=data.key||nm

                if(nm!="sep" && nm!="textwrap" &&els[data.key]){return els[data.key]}
                if(data.pos=="top"){data.pos=0}
                var klas="gl-icon-"+nm
                if(!options.template){
                    var dom=$d("<span class='ui-button-gl'></span>")
                    options.template=dom.el.cloneNode(true)
                    dom.remove();
                }
                var bar=this.getBar()

                var nu
                if(nm=="text"){
                    nu=$d("<span/>")
                    if(data.text){
                        nu.text(data.text)
                    }
                }
                else {
                    nu = options.template.cloneNode(true)
                }
                nu.dataset.cmd = data.key
                var before=_lastel
                if(typeof(data.pos)=="number"){
                    if(data.pos==0){before=bar.down()}
                    else {
                        before=bar.down(data.pos)
                    }
                } else if(typeof(data.pos)=="string") {
                    if (els[data.pos]) {
                        before = els[data.pos].el
                    }
                }
                before=before||_lastel
                nu=before.before(nu)
                nu.addClass(klas)
                if(data.klass||data.className){
                    nu.addClass(data.klass||data.className)
                }
                var wdgt={el: nu, name: nm}
                if(nm!="sep" && nm!="textwrap") {
                    if (typeof(data.callback) == "function") {
                        wdgt.callback = data.callback
                    }
                    els[nm]=wdgt
                } else{
                    nu.addClass("disabled")
                }
                if(data.text){
                    nu.html(data.text).css({width: "auto"})
                }
                return wdgt

            },
            enable:function(nm){
                [].concat(nm||[]).forEach(
                    function(k){
                        if(els[k]){
                            els[k].el.removeClass("disabled")
                        }
                    }
                )
                return this;
            },
            disable:function(nm){
                [].concat(nm||[]).forEach(
                    function(k){
                        if(els[k]){
                            els[k].el.addClass("disabled")
                        }
                    }
                )
                return this;
            },
            setConfig:function(nm,val){
                options[nm]=val;
            },
            appendTo:function(dom){
                _bar=$d(dom).append(this.getBar())

                return this;
            }

        }
        return api;
    }

module.exports=DataGrid
}
__bootstrap__.modules["GraphWidget"] = function(module){
var worker = null,svgns="http://www.w3.org/2000/svg";
    var util = {
        extend: function (target) {
            target = target || {}
            for (var a = 1, args = arguments, arglength = args.length; a < arglength; a++) {
                if (!(args[a] && typeof(args[a]) == "object")) {
                    continue
                }
                var src = args[a];
                for (var arr = Object.keys(src), i = 0, len = arr.length, key; key = arr[i], i < len; i++) {
                    target[key] = src[key]
                }
            }
            return target
        },

        attrmap: {
            anchor: "text-anchor", color: "stroke", "background": "fill", "bg": "fill"
        }


    }

    function GraphWidget(data) {
        this.config = {}
        this._rendered = false;
        this.el = GraphWidget.makeEl()
         if (data  ) {
                 this.addSeries ( data)
         }

    }

    GraphWidget._worker = null
    GraphWidget.makeEl = function () {
        var worker = GraphWidget._worker
        if (!worker) {
            worker = document.createElement("div")
            worker.innerHTML = '\
         <svg width="100%" height="100%" >\
          <path d="M0 0, 1 1Z" stroke="black" class="txt-worker-path" stroke-width="1" fill="transparent"/>\
         <text x="0" y="15" class="txt-worker-text"> </text></svg>';
            worker.querySelector("path").style["-webkit-transition"] = worker.querySelector("path").style.transition = "all .5s ease"
            GraphWidget._worker = worker

        }
        var nu = worker.cloneNode(true);
        nu.style["-webkit-transition"] = nu.style.transition = "all .5s ease"
        return nu

    }
    GraphWidget.prototype.addText = function (text, style) {
        if (text && typeof(text) == "object") {
            var isarr = Array.isArray(text)
            for (var arr = Object.keys(text), i = 0, len = arr.length, key; key = arr[i], i < len; i++) {
                this.addText(isarr ? text[key] : key, isarr ? style : util.extend({}, style, text[key]))
            }
            return this
        }
        var txt = this.el.appendChild(this.el.querySelector(".txt-worker-text").cloneNode(true))
        if(txt.classList){txt.classList.remove("txt-worker-text")}
        else{
            txt.className=String(txt.className).replace(/\s*txt\-worker\s*/g,"")
        }
        txt.textContent = String(text);
        if (style) {
            for (var arr = Object.keys(style), i = 0, len = arr.length, key; key = arr[i], i < len; i++) {
                this.attr(key, style[key], txt)
            }
        }
        return this;
    }
    GraphWidget.prototype.parse = function (data) {
        if (data) {
            if (typeof(data) == "string") {
                data = data.split(/\s*[,\s]+\s*/).map(Number)
            }
            if (Array.isArray(data)||Array.isArray(data.data||data.points)) {
               return data;
            }
        }
    }
    GraphWidget.prototype.buildPath = function (data) {
        if(Array.isArray(data)){data={points:data,attr:{}}}
         var vals = data.points||data.data,attr=data.attr,path = [], x=0,ht= 0,pel
        if(vals.data){data=vals;vals=vals.data;}
        attr=attr||data.attr||{}
        if(data.type=="line"){
            path.push("M" + vals[0][0] + " " + vals[0][1], "L " + vals[1][0] +" "+vals[1][1] )
        } else {
            var minval=20,max = Math.max.apply(Math, vals), min = Math.min.apply(Math, vals), mid = min + (max - min / 2),
                first = vals.shift(), last = vals[vals.length - 1]
            ht = mid * 2 + 40, offset = (mid - min);
            //first=Math.max(minval,first)
            if (vals.length % 2) {
                vals.push(last)
            }
            if (data.smooth) {
                x = 0
                while (vals.length >= 2) {
                    x += 5
                    var p = "S " + x + " " + (offset + vals.shift())
                    x += 5;
                    p += ", " + x + " " + (offset + vals.shift())
                    path.push(p)
                }
            } else {
                x = 0
                while (vals.length) {
                    x += 5
                    path.push("L " + (x) + " " + (offset + vals.shift()))
                }
            }
            path.unshift("M0" + " " + first )
            ht=ht - 20
            path.push("L" + x + " " + ht, "L0 " + ht, "L0 " + first + "Z")
        }
        if(!path.length){return}

        pel = this.el.querySelector("path").cloneNode(true)
        this.attr("d", path.join(" "),pel)


        //this.config.viewBox = vw;
        //this.attr("viewBox", vw.join(" "));
        if (attr && typeof(attr) == "object") {
            for (var arr = Object.keys(attr), i = 0, len = arr.length, key; key = arr[i], i < len; i++) {
                if(key=="style"){

                } else if(key=="klass"||key=="class"||key=="className"){

                }
                else{this.attr(key, attr[key],pel)}
            }
        }
        var vw = [0, 0, x||0, ht||0];
        data.viewBox = vw;
        data.path = pel;
        return data;
    }
    GraphWidget.prototype.addSeries = function (name,data) {
        if(data==null&&name){data=name.data||name;name=name.name||name.label}
        if(!data){return}
        data=this.parse(data)
        if(!data){return}
        name=name||"_";
        this.config.data=this.config.data||[];
        this.config.data.push({name:name,data:data});
        return this;
    }
    GraphWidget.prototype.addLine = function (name,from, to,attr) {
         name=name||"_";
        this.config.data=this.config.data||[];
        this.config.data.push({name:name,line:true,type:"line",attr:attr,data:[from,to]});
        return this;
    }
    GraphWidget.prototype.render = function (data, dom) {
        if (data && data.nodeType) {
            dom = data;
            data = null
        }
        if (data) {
            this.addSeries("",data)
        }
         if(this.config.data){
            this.config.data=this.config.data.map(function(k){
                return this.buildPath(k)
            },this);
        }
        if (this.config.data.length) {
            var vw = [0, 0, 240, 170];
            this.config.data.forEach(function (p) {
                if (p.viewBox) {
                    vw[2] = Math.max(vw[2], p.viewBox[2]);
                    vw[3] = Math.max(vw[3], p.viewBox[3])
                }

                p.path = this.el.appendChild(p.path)
               // p.path.dataset.key= p.name||"_"
              /*  p.path.hilite = function () {
                    this.style.opacity=1
                    for (var l = this.parentNode.querySelectorAll("path"), i = 0; i < l.length; i++) {
                        if (l[i]!==this){if(!l[i].dataset || l[i].dataset.key=="_"){continue}
                            l[i].style.opacity=.1
                        }
                    }
                }
                p.path.onmouseover = function () {
                    this.hilite()
                }*/
            }, this)
            if (this.config.id && !GraphWidget._cache[this.config.id]) {
                GraphWidget._cache[this.config.id] = this.el.cloneNode(true)
            }
            this.config.viewBox = vw;
            this.attr("viewBox", vw.join(" "));
            this._rendered = true;
            this.el._pending=0
            /*this.el.onmousemove = function (ev) {
                if(ev.target.tagName==="path"){return}
                if(ev.target.tagName==="text" && ev.target.dataset&& ev.target.dataset.key){if(ev.target.dataset.key=="_"){return}
                    var p=this.querySelector("path[data-key='"+(ev.target.dataset.key)+"']")
                    if(p&& p.hilite){p.hilite()}
                    return
                }
                if(this._pending!=2){
                    if(!this._pending){
                        this._pending=1
                        setTimeout(function(){this._pending=2}.bind(this),1000)
                    }
                    return
                }
                this._pending=0
                for (var l = this.querySelectorAll("path"), i = 0; i < l.length; i++) {
                        l[i].style.opacity=1

                }

            }*/
        }
        if (dom) {
            this.appendTo(dom)
        }

        return this;
    }
    GraphWidget.prototype.cleanUp=function(){
        var wrkr=this.el.querySelector(".txt-worker-text")
        if(wrkr){wrkr.parentNode.removeChild(wrkr)}
        wrkr=this.el.querySelector(".txt-worker-path")
        if(wrkr){wrkr.parentNode.removeChild(wrkr)}
    }
    GraphWidget.prototype.attr = function (nm, val, el) {
        var pathel, ns = nm.indexOf(":") > 0 ? "http://www.w3.org/2000/svg" : null;//'
        nm = util.attrmap[nm] || nm
        if (el) {
            el.setAttributeNS(ns, nm, val)
            return this
        }

        if (nm == "d" || nm == "stroke" || nm == "fill") {
            pathel = this.el.querySelector("path")
            pathel.setAttributeNS(ns, nm, val)
            return
        }
        this.el.setAttributeNS(ns, nm, val)
        return this;
    }
    GraphWidget.prototype.clone = function (data) {
        var nu = new GraphWidget(data);
        nu.el = this.el.cloneNode(true)
        for (var i = 0, arr = Object.keys(this.config), length = arr.length, key; key = arr[i], i < length; i++) {
            if (key == "id" || key == "data") {
                continue
            }
            if (this.config[key] && typeof(this.config[key]) == "object") {
                nu.config[key] = JSON.parse(JSON.stringify(this.config[key]))
            }
            else {
                nu.config[key] = this.config[key]
            }
        }
        nu._rendered = this._rendered
        return nu
    }
    GraphWidget.prototype.getMarkup = function () {
        if (this.el.outerHTML) {
            return this.el.outerHTML
        } else {
            var div = document.createElement("div")
            div.appendChild(this.el)
            var str = div.innerHTML;
            div = null;
            return str;
        }
    }
    GraphWidget.prototype.writePNGResponse = function (reqquery, response, query) {

        jsdom = require('jsdom'),
            child_proc = require('child_process'),
            w = 400,
            h = 400,
            htmlStub ,
            markup = this.getMarkup();

        response.writeHead(200, {'Content-Type': 'image/png'});
        var convertWorker = child_proc.spawn(),
            values = query['data'] || ".5,.5"
                    .split(",")
                    .map(function (v) {
                        return parseFloat(v)
                    });

        convertWorker.stdout.on('data', function (data) {
            response.write(data);
        });
        convertWorker.on('exit', function (code) {
            response.end();
        });
        htmlStub = '<!DOCTYPE html><div id="graph" style="width:' + w + 'px;height:' + h + 'px;">' + markup + '</div>'
        jsdom.env({
            features: {QuerySelector: true}, html: htmlStub, done: function (errors, window) {
                var svgsrc = window.document.querySelector(".graph").innerHTML
                convertWorker.stdin.write(svgsrc);
                convertWorker.stdin.end();
            }
        });
    }
    GraphWidget.prototype.writeResponse = function (request, response) {
        var query = url.parse(request.url, true).query
        if (query.png) {
            return this.writePNGResponse(query, response)
        }
        response.setHeader("Content-Type", "image/svg+xml")
        response.write(this.getMarkup());
        response.end();
    }

    GraphWidget.prototype.appendTo = function (dom, clear, force) {

        if (dom) {
            if (typeof(dom) == "string") {
                dom = document.querySelector(dom)
            }
            if (dom && dom.nodeType) {
                if (clear) {
                    while (dom.firstChild) {
                        dom.removeChild(dom.firstChild)
                    }
                }
                if (!this._rendered || force) {
                    this.el = dom.appendChild(GraphWidget.makeEl().firstElementChild.cloneNode(true))//querySelector("svg")
                    this._rendered = false
                } else {
                    this.el = dom.appendChild(this.el)
                }
                this.el.querySelector("path").style["-webkit-transition"] = this.el.querySelector("path").style.transition = "all .5s ease"
            }
        }
        if (!this._rendered || this.data) {
            this.render()
        }
        return this
    }
    GraphWidget._cache = {}
    GraphWidget.create = function (config) {
        if (config && config.id && GraphWidget._cache[config.id]) {
            return GraphWidget._cache[config.id].clone();
        }
        return new GraphWidget(config);
    }

module.exports=    GraphWidget
}
__bootstrap__.modules["View.DataGrid"] = function(module){
/*
     fitLayout
     pageSize
     resizable
     colresizable
     sortable
     highlightcolumn
     */
    var         //gridLayout="FIT",
        cntntwrapLayout  = (
                "<div class='grid-frame-header'>" +
                    "<div class='grid-info'><span class='grid-tools grid-title'></span><span class='grid-tools page-info'></span><span class='grid-tools columns-info'></span><span class='grid-tools grid-edit-menu'></span><span class='grid-tools grid-layout-menu'></span><span class='grid-tools'></span></div>" +
                    "<div class='ui-button-bar   ui-button-bar-right clear-fix'></div>" +
                "</div>" +
                "<div class='gridwrap'>" +
                    "$content" +
                "</div>" +
                "<div class='grid-footer'>" +
                    "<span class='msg'></span>" +
                "</div>"
            ),
        cntntLayout  = (
            "<table class='grid-tab'>" +
                "<colgroup>$colset</colgroup>" +
                "<caption>$caption</caption>" +
                "<thead class='grid-header'>" +
                "<tr class='grid-row'>$headercells</tr>" +
                "</thead>" +
                "<tbody class='grid-rowset'></tbody>" +
                "</table>"
            ),
        blockcntntLayout  = (
            "<div class='grid-tab'>" +
                "<span>$colset</span>" +
                "<caption>$caption</caption>" +
                "<div class='grid-rowset'></div>" +
                "</div>"
            ),
        landmarks={
                cols:"title,item,top,stub,img,lat,lng,tpe,thumb".split(/\,/)  ,
            url:"js/nyclandmarks.json"
        },
        pagerparts={
            firstpage:"<button data-key='1' type='button' title='first page'>&lt;&lt;</button>",
            lastpage:"<button data-key='-1' type='button' title='last page'>&gt;&gt;</button>",
            priorpage:"<button data-key='previous' type='button' title='previous page'>&lt;</button>",
            nextpage:"<button data-key='next' type='button' title='next page'>&gt;</button>",
            pageno:"<input value='$pageno' style='width:25px;'/>",
           loadmsg:"<img class='fxtx2 loadericon' style='float:left;visibility:hidden;margin-left:20px;margin-right:20px;height:32px;width:32px;' src='theme/img/bx_loader.gif'/>" +
                "<span class='fxtx2 loadmsg' style='margin-left:20px;float:left;min-width:20px;width:auto;'></span>"},
        pagertemplate  = (
            "<div class='grid-pager'>" +
                "$firstpage $priorpage $pageno $nextpage $lastpage of $totalpages ,rows $startrow to $endrow of $totalrows $loadmsg".split(/\s+/).map(function(it){
                     var ky=it.replace(/\$/,"");
                    return ("<span  class='grid-pager-text grid-pager-text-"+ky+"'>"+(it=="$"?"":it)+"</span>")
                        .replace(/\$([\w]+)/g,function(a,b){return pagerparts[b]||a})
                }).join("&nbsp;")+
                //replace(/\$([\w]+)/g,"<span class='grid-pager-text grid-pager-text-$1'>$1</span>") +
                "</div>"

            );

    var rowht=23 ,Core,Dom ,_gridoverlay,hdrwdoffst= 2,_arrayEach=function(clctn,fn){
        [].forEach.call(clctn,fn);
    },ZINDEX={BUTTONBAR:2,FILTER:1,FREEZEOVERLAY:1,FREEZEOVERLAYHDR:1,FREEZEBODY:1,FOOTERBAR:2,HDRCLONE:1,FRAMEHDR:1,GRIDHEADER:1   }
    function getOverlay(trgt){
        var rbnd=trgt.getBoundingClientRect();
        if(!_gridoverlay){
            _gridoverlay=document.body.appendChild(document.createElement("div"));
            _gridoverlay.style.cssText="background-color:#ccc;position:absolute;display:block;z-index:21;opacity:.1;left:"+rbnd.left+"px;top:"+rbnd.top+"px;height:"+rbnd.height+"px;width:"+rbnd.width+"px;"
        }
        _gridoverlay.style.cssText+="left:"+rbnd.left+"px;top:"+rbnd.top+"px;height:"+rbnd.height+"px;width:"+rbnd.width+"px;"
        return _gridoverlay;
    }
    function _rowModel(grid){
        var rowModelKlass=null,_grid=grid
        function _resolve(val){
            var id,ctx={}
            if(val) {
                if (val.__isgridcontext) {
                    ctx = val
                }
                else {
                    if (typeof(val)=="number") {ctx.id=val }
                    else if (!val.nodeType && val.id) {
                        ctx.id=val.id

                    }else if (val.nodeType ) {
                        ctx.row  = $d.selfOrUp(val,".grid-row");
                     }
                    if(!ctx.id&&ctx.record) {
                        ctx.id=ctx.record.id
                    }
                    if(ctx.id&&!ctx.row) {
                        ctx.row = _grid.domcomponents.gridWrap.q(".grid-row[data-id='" + ctx.id + "']");
                    }
                    if(!ctx.id&&ctx.row) {
                        ctx.id=ctx.row.domdata("id")
                    }
                    if(ctx.id&&!ctx.record) {
                        ctx.record=_grid.store.getList(true).findById(ctx.id)
                    }
                }
            }
            return ctx
        }
        return function rowModel(rw){
            if(!rowModelKlass){
                rowModelKlass=$.model.make({
                        record:null,el:null,
                        row:{get:function(){return this.el&&this.el.selfOrUp(".grid-row")}},
                        table:{get:function(){return this.el&&this.el.up(".grid-tab")}},
                        id:{get:function(){return this.record&&this.record.id}},
                        grid:null,
                        meta:{get:function(){return this.record&&this.record.meta }}
                    },{
                    findDomRow:function(id){
                        if(!id){return null}
                        if (typeof(id)=="number") {
                            return this.grid.domcomponents.gridWrap.q(".grid-row[data-id='" + id + "']");
                        }
                        else if (id.nodeType ) {
                            return  $d.selfOrup(id,".grid-row");
                        }
                    },
                    init:function(ctx){
                        this.grid=_grid
                        //if(!dom){return}
                        if(!(ctx&&ctx.row&&ctx.record)){return }//throw new Error("invaled row specs")}

                        this.record=ctx.record
                        this.el=$d(ctx.row)
                        $d.data(this.el,"_rowwidget",this)
                    } ,
                    clear:function(dom,grid,meta){
                        this.el= this.record =null
                        return this
                    },
                    isRendered:function(){
                        return this.el&&this.el.isAttached()
                    },
                    getCell:function(cel){
                        return this.grid._cellWidget(
                            this.grid.getContext(cel,{record:this.record,row:this.el,row:this.record?this.record.id:0})
                        );
                     },
                    getCells:function(cel){
                        var cells=[],meta=this.meta,cellWidget=this.grid._cellWidget.bind(this.grid)
                        if(this.row){
                            cells=$d.qq(this.row,".grid-cell")
                        }
                        if(cells.length){
                           return $d.qq(this.grid.domcomponents.gridWrap,".grid-col").map(function(c,i){
                               return cellWidget(cells[i],meta.find($d.domdata(c,"name")))
                           })
                        }
                    },
                    isInView:function(){
                        return this.el&&this.el.isInView()
                    },
                    refresh:function(data,andrender){
                        if(this.record){var ths=this
                            this.record.refresh( ).then(
                                function(){
                                    if(andrender){
                                        ths.render()
                                    }
                                }
                            )
                        }
                    },
                    save:function(data,andrender){
                        if(this.record){var ths=this
                            this.record.update(data).save().then(
                                function(){
                                    if(andrender){
                                        ths.render()
                                    }
                                }
                            )
                        }
                    },
                    render:function( ){
                        if(this.meta.size()<100 ){var rec=this.record
                            this.getCells().forEach(function(cl){
                                cl.render(rec.get(cl.name))
                            });
                            return
                        }
                         this.grid._renderer.renderSingleRow(this.record)
                        return this
                    }

                })
            }


            if(rw instanceof  rowModelKlass){return rw}
            var ctx=_resolve(rw)
            if(ctx && ctx.row && $d.data(ctx.row,"_rowwidget")){return $d.data(ctx.row,"_rowwidget")}
            if(!(ctx && ctx.row)){return null}
            var nu=new rowModelKlass(ctx,_grid )
            if(nu.row){
                nu.el=nu.row
                $d.data(nu.row,"_rowwidget",nu)
            }

            return nu
        }
        rowModel.resolve=_resolve
        return rowModel;
    }
    function _cellWidget(grid,contentclass){
        var kls=null,_grid=grid
        return function(cl0,meta){
            if(!kls){
                kls=Klass({
                    properties:{
                        meta:null
                        ,content:{get:function(){return (this.el&&contentclass)?this.el.selfOrDown(contentclass):this.el}},
                        row:{get:function(){return this.el&&this.el.up(".grid-row")}},
                        cell:{get:function(){return this.el}},
                        tab:{get:function(){return this.el&&this.el.up(".grid-tab")}},
                        container:null,
                        record:{get:function(){
                            if(this.__record){return this.__record}
                            if(this.container&&this.container.getRow) {
                                var rowmodel = this.container.getRow(this.row||this.el.parent())
                                if (rowmodel && rowmodel.record) {
                                    return rowmodel.record
                                }
                            }
                            return null
                        },set:function(v){this.__record=v}},
                        name:{get:function(){return this.meta&&this.meta.name}}
                    },
                    init:function(dom,container,meta){
                        var ctx=null;
                        this.container=container
                        if(dom&&(dom.meta||dom.column)&&dom.cell){ctx=dom;ctx.meta=ctx.meta||ctx.column}
                        else if(dom&&dom.__isgridcontext){ctx=dom}
                        else{ctx=container.getContext(dom)}
                        if(ctx&&ctx.column&&!ctx.meta){ctx.meta=ctx.column}
                        if(!(ctx&&ctx.cell&&ctx.meta)){
                            return
                            //throw new Error("invaled cell specs")
                        }
                         this.container=container
                        this.el=$d( ctx.cell)
                        this.meta=ctx.meta||ctx.column
                        if(typeof(this.meta)=="string"|| $.isPlain(this.meta)){
                            this.meta=new Data.Column(this.meta)
                        }
                        this.columnIndex=ctx.columnIndex
                    } ,
                    clear:function( ){
                        this.el= this.column=this.meta= null
                        this.columnIndex=-1
                        return this
                    },
                    getValue:function(){
                        var record=this.record
                        if( record){
                            return  record.get(this.name)
                        }
                    },
                    setValue:function(v){
                        var record=this.record
                        if( record){
                            return  record.set(this.name,v)
                        }
                        return this
                    },
                    update:function(val,andrender){
                        this.container._renderer&&this.container._renderer.pause()
                        this.setValue(this.name,val)
                        this.container._renderer&&this.container._renderer.resume()
                         if(andrender) {
                            this.render(val)
                        }
                        return this
                    },
                    render:function(val){
                        val=val==null?this.getValue():val
                        var c=this.meta?this.meta.getDisplayValue(val):val
                        if(this.meta&&this.meta.cellRenderer){
                            c=this.meta.cellRenderer(c)
                        }
                        this.content.html(c)
                        return this
                    }

                })
            }
            if(cl0&&cl0.nodeType&&$d.data(cl0,"_cellwidget")){return cl0.data("_cellwidget")}
            if(cl0 instanceof  kls){return cl0}
            return new kls(cl0,_grid,meta)
        }
    }

    var _rukesadded=0
    function addRules(){if(_rukesadded){return}
        $d.css.addRules("grid",

            {".gridtable":"overflow:hidden;",
                ".gridtable .grid-tab":"table-layout: fixed;border-collapse: collapse; min-width:99%;",
                ".gridtable.viewmode-tile .grid-header":"display:none;",
                ".gridtable.viewmode-tile tbody,.gridtable.viewmode-tile table":"display:block;",
            ".gridtable.viewmode-tile .grid-row":"  cursor: pointer; line-height:1.6;display:inline-block;vertical-align: top;padding:4px;height:auto;border:1px solid #ccc;margin:4px;border-radius:4px;overflow:hidden;",
            ".gridtable .grid-row pre":"margin:1px 0;white-space: pre-wrap;",
            ".gridtable.viewmode-block .gridwrap .grid-tab .grid-rowset .grid-row":"display: block;  padding:2px 4px;margin-bottom:10px;border-top:none;clear: both;",
            ".gridtable.viewmode-block .grid-row h2":"font-size:1.4em;line-height: 1.6;margin:0 0 2px 0;padding:0;font-weight:bold;",
            ".gridtable.scrollable .gridwrap":"position:absolute;width:100%;height:95%;top:30px;left:0;overflow:auto; ",
            ".gridtable .gridwrap .scroll-fit":"z-index:-1;position:absolute;right:0;top:0;width:1px;max-width:1px;",
            ".gridtable .gridwrap .scroll-fit div":"position:absolute;left:0;width:100%;height:20px; ",
                ".gridtable .grid-cell,.gridtable .grid-header-cell":" padding-left:2px;padding-right:0;box-sizing:border-box;",
                ".gridtable .headerclone .grid-header-cell,.gridtable thead .grid-header-cell":"height:2em",
                ".headerclone":"position:absolute;top:1px;height: 2em;z-index:1;left:0;width:auto;",
                ".gridtable .grid-frame-header,.gridtable .grid-footer":"height:30px;font-size:.9em;line-height:1.6;padding-left:5px;position:relative",
                ".gridtable.scrollable .grid-frame-header,.gridtable.scrollable .grid-footer":"position:absolute;width:100%;left:0;",
            ".gridtable.scrollable .grid-footer":"bottom:0",
            ".gridtable .grid-frame-header":"top:0;padding:2px 0;height:3em;",
            ".gridtable dl":"display:block;clear:both;padding-top:1px;position:relative;margin-bottom:2px;",
            ".gridtable dl dt":"color:gray;text-align:right;padding-right:10px;font-weight:bold;clear:left;float:left;width:150px;",
            ".gridtable dl dd":"display:block;margin-right :20px  ",
                ".gridtable .layout-options":"display:inline-block;height:24px;border-left:1px solid #ccc;margin-left:5px;padding-left:5px;float:right;",
                ".gridtable .layout-option":"cursor:pointer;",
            ".gridtable .layout-option-tile1":"background:url(../../theme/img/blockview.gif) center center no-repeat",
                ".gridtable .layout-option-table1":"background:url(../../theme/img/gridview.gif) center center no-repeat",
            ".gridtable dl dd,.gridtable  dl dt":"overflow:hidden;white-space:nowrap;text-overflow:ellipsis;height:1.6em;line-height:1.6; ",
             ".gridtable dl.cell-object-data":"width:90%; margin-left:0;margin-top:0;margin-right :0 ",
            ".gridtable dl.cell-object-data dd":"margin-right :0;  ",
            ".gridtable dl.cell-object-data dt":" max-width:50%;  ",
            ".gridtable .grid-row-wrap":" margin-bottom:5px;",
            ".gridtable.fixedheight .grid-cell .cell-content":"height:20px;max-height:20px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;",
            ".gridtable .grid-header-cell":"overflow:hidden;text-overflow: ellipsis;white-space: nowrap;border-bottom:1px solid #111",
                ".gridtable.issortable  .grid-header-cell":"cursor:pointer",
            ".col-resize-shadow":"position:absolute;z-index:20; opacity:.4;cursor:col-resize;",
            ".grid-fitLayout table":"max-width:100%  !important;min-width:98% ;width:98% ;table-layout:fixed;  ",
            ".gridtable .grid-frame-header .grid-title":"position:absolute;left:15px;top:2px;font-weight:bold;font-size: 1.2rem;",
            ".gridtable .grid-frame-header .ui-button-bar":"width:200px;position:relative;min-height:30",
            ".gridtable.zebra-col .grid-rowset .grid-row .grid-cell:nth-child(odd)":"background:$hilite-cell",
             ".gridtable.zebra-row .grid-rowset .grid-row:nth-child(odd)":"background:$zebra-row",

            ".grid-columnfreeze-overlay":"overflow: hidden; ",
            ".grid-columnfreeze-overlay .grid-row  .grid-header-cell":"border-left:none;margin-left:-1px  ; ",
                ".ui-toolbar-status-message":"font-size:.8rem;color:#666;",
                // ".gridtable .gridwrap .edit-active,.gridtable .gridwrap .edit-active .cell-content":"background-color:white;color:#111",//outline:2px solid green
          //  ".gridtable .gridwrap .edit-active-row":"background-color:#ffffee !important ",
           // ".gridtable .gridwrap .edit-active-row .edit-active .cell-content":"color:#333",
            ".gridtable .rownum":"width:20px;max-width:20px;min-width:20px;",
            ".grid-filter":"display:block;position:absolute; top:0;height:100%;width:100%;",
            ".grid-filter .grid-filter-stub":"background-image:url(  theme/filter.png);background-size:cover; width:45px;margin:3px;margin-right:15px;overflow:hidden; float:left;height: 85%; text-align: center;",
            ".grid-filter .grid-filter-content":"width:100%; height: 100%;text-align: left;cursor: pointer",
            ".grid-filter .grid-filter-content .filter-elem-wrap":"height:100%;display:inline-block;position:relative;float:left;margin:1px;margin-right:6px; min-width:60px;width:auto; border:none;overflow:hidden;white-space:nowrap; ",
            ".grid-filter .grid-filter-content .filter-elem-wrap  .filter-elem, .grid-filter .grid-filter-content .filter-elem-wrap .filter-elem_ph":"cursor:pointer;margin-right:5px;text-overflow:ellipsis;text-align:center;white-space:nowrap;z-index:1;display:block;bottom:0; line-height:1.4;padding:0 10px 0 5px;border-radius:4px;border:1px solid #ccc;",
            ".grid-filter .grid-filter-content .filter-elem-wrap  .filter-elem":"z-index:1;position:relative;visibility: hidden;max-width:150px;min-width:50px;margin-top: 12px;text-overflow: ellipsis;white-space: nowrap;overflow: hidden; ",
            ".grid-filter .grid-filter-content .filter-elem-wrap .filter-elem_ph":"z-index:2;max-width:200px;position:absolute;opacity:.8;  margin-right:30px;   line-height: 1.2;height: 1.4em;font-weight:bold;     border: none;  box-shadow: none;     text-align: left;  color:#428bca;  top:0px;left:-4px;z-index:10; font-size:.9em;width:auto; margin-left:0; background-color: transparent;background: transparent;    letter-spacing: .5em;",
            ".grid-filter .grid-filter-content .filter-elem-wrap .filter-elem_phX":"line-height: 1.2;height: 1.4em;font-weight:bold;     border: none;  box-shadow: none;     text-align: left;  color:#428bca;  top:-2px;left:-2px;z-index:10; font-size:.9em;width:auto; margin-left:0; background-color: transparent;background: transparent;    letter-spacing: .5em;",
            ".grid-filter .grid-filter-content .filter-elem-wrap.has-value.hide-ph .filter-elem_ph":"display: none !important;",
            ".grid-filter .grid-filter-content .filter-elem-wrap.has-value .filter-elem":"display:block;float:left;opacity: 1;visibility: visible",
            ".viewmode-table .grid-row":" height:2em;line-height:1.6; " ,
            ".gridwrap.nowrap table":"table-layout: auto; width:auto;",
                ".gridwrap .grid-cell":"overflow:hidden;",
            ".gridwrap.nowrap .grid-cell,.gridwrap.nowrap .grid-cell .cell-content":"white-space: nowrap;",
            ".gridtable .nodata-msg":"position:absolute; width:160px;text-align: center;padding:0;left:50%;top:50%;margin-left:-80px;margin-top:-30px",
            ".gridtable   .nodata-msg .content":"border:2px outset #333;height:40px;line-height:35px; vertical-align: middle",
            ".filter-elem-wrap .filter-elem-remove":"opacity:.1;display:block;position:absolute;color:red;cursor:pointer;text-align:right;right:2px;top:1px;line-height:8px;height:8px;width:8px;z-index:20;",
            ".filter-elem-wrap:hover .filter-elem_ph:hover .filter-elem-remove":"opacity:1",
            ".filter-elem-wrap .filter-elem_ph .filter-elem-remove":"font-size:1.2em;",
            ".filter-elem-wrap .filter-elem:hover .filter-elem-remove":"opacity:1" ,
                ".filter-elem-wrap:hover .filter-elem-add":"opacity:1" ,
                ".filter-elem-wrap .filter-elem-add":"z-index:1;float:left;position:relative;margin-top: 2px;text-align:center;color:green;font-weight:bold;font-size:1.1em;opacity:.3;width:14px; height:14px;",
                ".grid-column-selected":"background:$ui-darker",
                ".edit-modified":"color:blue"
        }   )
    }
    var GridRenderer=function(grid, optns){
        this.grid=grid; this.gridoptns=optns||{};
        var _saveColList,_rendered,lastRender=null
        this.isRendered=function(){return !!lastRender}
        this.pause=function pause(){this._paused=true}
        this.resume=function pause(){this._paused=false}
        this.render=function render(recs0,outer){
            if(this._paused){return}
            var g=this.grid,gridoptns=this.gridoptns,bindings={
                colset:(gridoptns.rownum?"<col/>":"")+g.cols.map(function(it){return "<col class='grid-col' data-name='"+it.dataIndex+"'/>"}).join(""),
                caption:"",
                headercells:(gridoptns.rownum?"<th class='grid-header-cell rownum'>#</th>":"")+g.cols.map(function(it){return "<th class='grid-header-cell'><div class='cell-content'>"+it.label+"</div></th>"}).join(""),
                rows:""  ,title:gridoptns.title||"Grid"

            } ,cmpo=this.grid.domcomponents;
            if(!cmpo.outer){
                cmpo.outer= $d(outer);
            }
            if(gridoptns.fitLayout){cmpo.outer.classList.add("grid-fitLayout")}
            var cntnt=(gridoptns.viewmode!="table"?blockcntntLayout:cntntLayout).replace(/\$([\w]+)/g,function(a,b){return bindings[b]||""})

            if(!cmpo.gridWrap){
                cmpo.outer.el.innerHTML=cntntwrapLayout.replace(/\$content/,cntnt ).replace(/`/g,",")
            }  else {
                cmpo.gridWrap.el.innerHTML=cntnt.replace(/`/g,",")
            }


            cmpo.gridWrap.st("li").addClass("list-row");
            //g._resize();  // cmpo.tab.style.width=cmpo.gridWrap.clientWidth+"px"
            //this.redraw()
            //setTimeout(this.grid.fire.bind(this.grid,"render"),500);
            //  cmpo.outer.style.display=""  ;
            g.observer.fireAsync("afterbuild")
        }
        this.wrapTemplate=function(content,tag){tag=tag||"div" ;var stl=""

            if(tag!="tr"){
                stl="display: block;clear:both;position: relative;border-bottom:none;"
                //width:"+((this.grid.domcomponents.gridWrap||this.grid.domcomponents.outer||{}).offsetWidth||"800")+"px"
                /*this.grid.on("afterrender resize",function(){
                    var w=this.domcomponents.gridWrap;
                    if(!this.isVisible()){this._needsRedraw=true;return}
                    w&&  w.st(".grid-row").css( {"width":w.offsetWidth+"px" })
                })*/
            }
            return ("<$tag style='"+stl+"' class='grid-row' data-id='$id'>"+ content +"</$tag>").replace(/\$tag/g,tag)
        }
        this.wrapRowTemplate=function(content,tag){tag=tag||"tr"
            if(String(content).trim().indexOf("grid-row")>-1){return content}
            return "<"+tag+" class='grid-row' data-id='$id'>"+content+"</"+tag+">"
        }
        this.getRowTemplate=function(){
            var tag="tr",tmpl= this.grid.config.viewmode=="table"?null:this.grid.config.rowtemplate
            if(!tmpl){
                tmpl= (this.gridoptns.rownum?"<td class='rownum'>$rownum</td>":"")+
                    grid.cols.map(
                        function(it){return "<td class='grid-cell'><div class='cell-content'>$"+it.dataIndex+"</div></td>"}
                    ).join("")
            } else{
                if(tmpl=="formview"){var labelwidth=this.grid.config.formlabelwidth||150
                    this.grid.config.rowtemplate=tmpl= this.grid.cols.map(function(it){
                        return "<label class='' style='float:left;width:"+(labelwidth)+"px;margin-bottom:5px;overflow:hidden;'>"+it.label+"</label><div style='margin-bottom:5px;max-width:90%'>$"+it.name+"</div>"
                    }).join("");
                }
                if(this.grid.config.wrapfieldsintemplate){
                    var m=this.grid.store.meta,fldtmpl="<$tag class='grid-cell' data-name='#name'><div class='cell-content'>$#name</div></$tag>"
                    this.grid.config.rowtemplate=  tmpl= tmpl.replace(/\$([\w]+)/g,function(a,b){
                        if(b=="id"){return a}
                        var f=m.findField(b)||{name:b}
                        if(f){var tag="div"
                            if(f.titlefield){tag="h2"}
                            return fldtmpl.replace(/#name/g, f.name).replace(/\$tag/g,tag)
                        }
                        return a
                    })
                     this.grid.config.wrapfieldsintemplate=null
                }


                tag=this.grid.config.rowtag||"div"}

            return this.wrapRowTemplate(tmpl,tag);
        }
        this.clear=function clear(rowset){if(this._paused){return}
            var bdy= rowset||this.grid.domcomponents.rowset
            var chldrn1=$.makeArray(bdy.children)
            while(chldrn1.length ){
                bdy.removeChild(chldrn1.pop())
            }
        }
        this.showNoDataMessage=function showNoDataMessage( ){
            if(this._currentcount){
                this.grid.domcomponents.gridWrap.show();return
            }
                 var msg=this.grid.config.noDataMessage||"No data found"
                if(!this.grid.nodatamsg){
                    this.grid.domcomponents.gridWrap.before("<div class='def-popup-style nodata-msg'><div class='content'></div></div>")
                    this.grid.nodatamsg=this.grid.domcomponents.outer.q('.nodata-msg')
                }
                    var st=this.grid.domcomponents.toolbar_status
                    if(st){st.clear();}
                    this.grid.domcomponents.loadmsg&& this.grid.domcomponents.loadmsg.html("&nbsp;");
                    if(this.grid.domcomponents.loadericon){
                        this.grid.domcomponents.loadericon.css("opacity",.01)
                        //this.domcomponents.loadericon.hide()
                    }

                //this.grid.domcomponents.gridWrap.hide();
                this.grid.nodatamsg.show().q(".content").html(msg)
            }
        this.renderRows=function renderRows(recs0,appnd,nothrottled){
            if(this._paused){return}
            nothrottled=true;
            var recs=recs0||this.grid.pager.getPageRecords() ,grid=this;
            if(recs && recs.data){
                recs=recs.data
            }
            if(!recs||!recs.length||(recs.length==1&&!recs[0])){
                this._currentcount=0;
                recs=[]
                this.clear();
                //this.showNoDataMessage (  )
            }
            else {
                if(this.grid.nodatamsg){this.grid.nodatamsg.hide()}
                this.grid.domcomponents.gridWrap.show();
                if(lastRender&&lastRender.length){}
                 var pr=this.grid.data("_lookupsresolve_promise")
                if(pr){
                    pr.then(function(r){
                        if(nothrottled){this.renderRows_inner(r);}
                        else{this.renderRows_inner_throttled(r);}

                        if(this.grid.nodatamsg){this.grid.nodatamsg.hide()}
                        lastRender=r
                    }.bind(this,recs)
                );
                } else {
                    this.renderRows_inner(recs);
                }
            }
            this.grid.fire("viewupdate",this.grid.pager);
        }
        this.renderRows_inner=function renderRows(recs,appnd){
            if(this._paused){return}
            var data,tmpl=this.getRowTemplate(),grid=this;;
             this._currentcount=0;
              if(recs&&recs.length){
                this._currentcount=recs.length;
                var tmpl=this.grid.store.StoreRecordProto.prepTemplate(tmpl)

                this._lastusedRowTemplate=tmpl
                data= recs.map(function(r,i){
                    if(r){r.rownum=i+1}
                    return r.applyTemplate(tmpl);
                }).join("")
                    .replace(/nan|undefined|\[object object\]|null/ig,"")


                if(!data.trim()){data=""}
                var bdy= this.grid.domcomponents.rowset ;
                var cln=document.createElement(bdy.tagName),prev=bdy.previousSibling,
                    next=bdy.nextSibling, par=bdy.parentNode,bdy1=bdy.el;//par.removeChild(bdy.el)
                var display=$d.css(par,"display");
                //
                if(!(appnd===true)){
                    this.clear(bdy1)
                }
                _rendered=1
                cln.innerHTML=data;
                var chldrn=$.makeArray(cln.children)
                par.style.display="none";
                try{
                    while(chldrn.length ){
                        bdy1.appendChild( chldrn.shift() )
                    }
                } finally{

                    par.style.display=display;
                }
                cln=null;

             }            // par.insertBefore(bdy1,next)
           // par.style.display=display||"";
            this.grid.domcomponents.outer.classList.add("viewmode-"+this.grid.config.viewmode)
              _saveColList=this.grid.cols.map(function(it){return it.name});


           this.grid.domcomponents.rowset.st(".grid-row").addClass("selectable")
            var grid=this.grid
            grid.cols.forEach(function(c){
                if(c.cellui && !$.is.empty(c.cellui)){
                    var ui=c.cellui,parstyle=null
                    if(ui.style && ui.style.background){
                        //parstyle={background:ui.style.background}
                    }
                    grid.getColumnCells(c,false,true,true).forEach(function(el){
                        $d.prop(el,ui)
                         if(parstyle){
                            $d.css($d.parent(el),parstyle)
                         }

                    });
                }
            });

              this.grid.afterRender() ;

            this.grid.fire("afterpageload",this.grid.pager);

            return this
        }//,{ delay:5 }) ;
        this.renderRows_inner_throttled=$.throttle( this.renderRows_inner.bind(this),true)
        this.findRow=function(rec){
            var id= 0,rw
            if(typeof(rec)=="number"){id=rec}
            else if(rec&&rec.nodeType){return $d.selfOrUp(".grid-row")}
            else if(rec){id=rec.id}
            if(id){
                rw= this.grid.domcomponents.gridWrap.q(".grid-row[data-id='"+id+"']");
                //var rwrec=this.grid.store.findById(id)

            }
            return rw
        }
        this.renderSingleRow=function renderSingleRow(recs){
            if(this._paused){return}
            var rec=Array.isArray(recs)?recs[0]:recs    ;if(!(rec&&rec.id>=0)){return}
            var html,ctx= this.grid.getRow(rec);
             if(ctx&&ctx.record){rec=ctx.record}
            if(ctx.row){
                if(this._lastusedRowTemplate){
                    html=this._lastusedRowTemplate.fn(rec)
                 }
                else{
                    html=rec.applyTemplate(this.getRowTemplate(),ctx.row.domIndex()+1)
                }
                var div=document.createElement("div")
                div.innerHTML="<table>"+html+"</table>"
                var nu=ctx.row.parent().insertBefore(div.querySelector("tr"),ctx.row)
                ctx.row.remove();
                ctx.row=$d(nu).addClass("selectable")
                //ctx.row.insert(html.replace(/nan|undefined|\[object object\]|null/ig,""),"replace")
            }
            this.grid.fire("viewupdate",this.grid.pager);
            return
        }
        this.redraw=function(clear){
            clear===true && this.clear();
            this.renderRows() ;
            return this
        }
        this.addrows =function _addrows( ){if(this._paused){return}
            //   var diff=this._lastDiff||0;if(!diff  ){return}
            var _all=[] , blanks=Math.min(this.pager.totalrows,Math.floor(diff/rowht))
            while(_all.length<blanks){[].push.apply(_all,this.pager.next()) }
             this.renderRows( _all,true);
        }
    }  ;
    //store selectedRecord cols
    var DataGrid=(function(){
        var _domC=function(){
            var  domcomponents={}
            Object.defineProperties(domcomponents,{
                grid:{value:this},
                outer:{value:null,writable:true,enumerable:true},
                gridWrap:{get:function(){return this.outer&&this.outer.q(".gridwrap")},set:function(){},enumerable:true},
                tabheader:{get:function(){return this.outer&&this.outer.q(".grid-header")},set:function(){},enumerable:true},
                tabheaderrow:{get:function(){return this.tabheader&&this.tabheader.tab.q(".grid-row")},set:function(){},enumerable:true},
                frameheader:{get:function(){return this.outer&&this.outer.q(".grid-frame-header")},set:function(){},enumerable:true},
                toolbar:{get:function(){if(!this.frameheader){return null}
                    var t=this.frameheader.q(".ui-button-bar")||this.frameheader.append("<div class='ui-button-bar ui-button-bar-right clear-fix' style='position: absolute; right: 1px; top: 0;    width: auto; minWidth:250,minHeight:30,text-align: right;  overflow: hidden; z-index: 1;'></div>")
                    return t
                },set:function(){},enumerable:true},

                toolbar_status:{get:function(){return this.outer&&this.outer.q(".ui-toolbar-status-message")},set:function(){},enumerable:true},
                headerclone:{get:function(){return this.outer&&this.outer.q(".headerclone")},set:function(){},enumerable:true},
                framefooter:{get:function(){return this.outer&&this.outer.q(".grid-footer")},set:function(){},enumerable:true},
                tab:{get:function(){return this.gridWrap&&this.gridWrap.q(".grid-tab")},set:function(){},enumerable:true},
                rowset:{get:function(){return this.tab&&this.tab.q(".grid-rowset")},set:function(){},enumerable:true},
                row:{value:function(idx){return this.rowset&&this.rowset.q(".grid-row:nth-child("+(idx+1)+")")},enumerable:true},
                rows:{value:function(idx){return this.rowset&&this.rowset.st(".grid-row")},enumerable:true },
                colset:{get:function(){return this.tab&&this.tab.st("col")},set:function(){},enumerable:true} ,
                loadmsg:{get:function(){return this.pagerwrap&&this.pagerwrap.q(".loadmsg")},set:function(){},enumerable:true} ,
                loadericon:{get:function(){return this.outer.q(".grid-footer .loadericon")},set:function(){},enumerable:true} ,

            pagerwrap:{get:function(){return this.outer.q(".grid-footer .msg")},set:function(){},enumerable:true} ,
                hdrInfo  :{value:function(){   var tabhdr=(this.headerclone||this.tabheader), b1=tabhdr?tabhdr.getBoundingClientRect():{},b={top: b1.top||0,height:b1.height||0,bottom:b1.bottom||0}
                    if(b.height<5&& this.tabheader && this.tabheader.dataset.savedht){b.height=+this.tabheader.dataset.savedht;b.bottom= b.top+ b.height}
                    var tt=this.outer.getBoundingClientRect().top,fr=this.frameheader,frht=fr?fr.offsetHeight: 0,
                        btm=frht?(frht+b.height):b.bottom-this.outer.getBoundingClientRect().top;
                    if(this.tabheader&&b.height>5&&!this.tabheader.dataset.savedht){this.tabheader.dataset.savedht= b.height}

                    return{
                        bottom:btm,
                        height:b.height,top:btm-b.height
                    }
                    } ,enumerable:true
                } ,
                resetscroll:{value:function resetscroll(){ var cmp=this
                    cmp.gridWrap.scrollTop=0; cmp.gridWrap.scrollLeft=0;
                    this.grid.pager.pageno=1
                },enumerable:true},
                setwidths:{value:function (st,w){ if(w&&w!="0px"&&w!="0"){st.maxWidth=st.minWidth=st.width=w}},enumerable:true},

                scrollTreshold:{value:-50},
                handleheaderSel:{value:function(ev){
                    //colresize sort or move
                    var gridctx=this.grid ,cmp=this
                    if(!(gridctx.colresizable||gridctx.sortable||gridctx.colMove)){return}
                    if($d.hasClass(cmp.outer,"resizing")){return}

                    var el=$d.hasClass(ev.target,"cell-content")?$d.parent(ev.target):ev.target,
                        dm=el.getBoundingClientRect(),act=0;
                             if(gridctx.colMove || gridctx.sortable) {
                                ev.stopPropagation && ev.stopPropagation()
                                //ev.stopImmediatePropagation && ev.stopImmediatePropagation()
                                 var sorted=0
                                $d.holdMouse2(el,{timeout:300,endonmousemove:true,
                                    onmove:function(ev){
                                        if(gridctx.sortable) {sorted=1
                                            gridctx.sortable.activate (ev,el);
                                        }
                                    },
                                    onend:function(){
                                        if(sorted){return}
                                        if(gridctx.colMove){
                                            gridctx.colMove.activate (ev,el)
                                        } else{
                                            if(gridctx.sortable) {
                                                gridctx.sortable.activate (ev,el);
                                            }
                                        }

                                     }
                                })
                             }
                         if(act) {
                            cmp.outer.classList.add("resizing")
                            $d(document).on("mouseup",function _mmup(ev){
                                cmp.outer.classList.remove("resizing");
                                $d(document).off("mouseup",_mmup);
                            })
                        }
                }
                }
            });


            this.domcomponents=domcomponents;
        }
        var _proto={panel:null,store:null,el:null}
        _proto.init= function( store,optn ){
            addRules();
            var gridOptns=Object.create(null),optns=Object(optn||{});
            this._cellWidget=_cellWidget(this,".cell-content")
            this._rowModel=_rowModel(this)
            this.store=store;
            var pager=this.store.pager.properties.toMap()
            if(pager.pagesize==-1){pager.pagesize=optns.pagesize||40}
            this.pager=new Data.pager(store)
            this.pager.updateProperties(pager)
            //    this.domContainer=DomCore.wrap(cntnr)


            this.pager.on("update",function(){
                this.loadPage()
            });
            _domC.call(this);
            _domC.call(this);
            if(optns.rowTemplate){optns.rowtemplate=optns.rowTemplate};
            ("sorttable colresizable colmove highlightcolumn rowHeight columns title headerFilter rowtemplate wrapfieldsintemplate viewmode  entityForm inlineEditor popupEditor inlneEditor columnFreeze zebraRow editoptions zebraColumn nowrap scrolling pagesize pagination fitLayout showlayoutoptions").split(/\s+/).forEach(
                function(k0){var k=String(k0);if(!(k in optns)&&(k.toLowerCase() in optns)){k=k.toLowerCase()}
                    if(k in optns){gridOptns[k0]=optns[k];}//delete optns[k]
                }
            );

            //pagination /scrolling
            if(gridOptns.scrolling==null){gridOptns.scrolling=30}
            if(gridOptns.scrolling==-1){
                gridOptns.rowHeight=gridOptns.rowHeight||20;
                if(gridOptns.scrolling>0){
                    gridOptns.pagesize= gridOptns.pagesize||gridOptns.scrolling;
                }
            }
            var ent=store.meta, collist

            if(gridOptns.pagesize && store) {pager.pagesize=gridOptns.pagesize}
            //columns

            if(gridOptns.columns){
                collist=gridOptns.columns.map(function(it){return ent.findField(it)||{label:it,name:it,dataIndex:it}}).filter(function(it){
                        return it && !(it.name=="id"||it.hidden||(it.ui && it.ui.hidden))
                    }
                )
            } else{
                collist=ent.findAll(function(it){return !(it.name=="id"||it.hidden||(it.ui && it.ui.hidden))})
            }
             this.cols=collist;
            this.config=this.config||{};
            //this.initComponent([optn])
            for(var k in gridOptns){this.config[k]=gridOptns[k]}
            this.config.gridoptns=gridOptns


            //this.cols=collist.map(function(it){ return ent.columns[it] });
            if(!this.config.viewmode && (this.config.rowtemplate &&!this.config.showlayoutoptions)) {
                this.config.viewmode ="block"
            }
            if(!this.config.viewmode){this.config.viewmode="table"}
            //rendering
            this._renderer=new GridRenderer(this,this.config);
            this.setupDataEvents()
             var c=this.getController()
            c.mixin({
                edit:function(){
                    if(!this.entityForm){ this.entityForm= DataGrid.plugins.entityForm(this).setup()}
                    if(this.selectedRecord && this.selectedRecord.id){
                        this.entityForm.setupForm(this.selectedRecord,true);
                    }
                },
                addrow:function(){
                    if(!this.entityForm){ this.entityForm= DataGrid.plugins.entityForm(this).setup()}
                    this.entityForm.setupForm(null,true);
                },

                del:function(){
                    if(this.selectedRecord && this.selectedRecord.id){
                        this.store.provider.delete(this.selectedRecord.id);
                    }
                },
                refresh:function(){
                    var st=this.domcomponents.toolbar_status
                    if(st){
                        st.html("Refreshing ...")
                        this.observer.once("afterrender",function(){
                            st.clear();
                            //st.html("last refreshed: "+ $.date().format("hh:nn tt"))
                        })
                    }
                    this._renderer.redraw()
                }
            },true);


            this.observer.once("afterbuild.evts",function(){
                this.on("resize",this.resize);
                var _lastCtx={} ,r=this.domcomponents.outer,ths=this,Dom=DomCore;
                this.domcomponents.gridWrap.__onscroll||
                this.domcomponents.gridWrap.on("scroll",this.domcomponents.gridWrap.__onscroll=function(ev){
                    ths.fire("scroll",ev)
                });

                var gridWrap=this.domcomponents.gridWrap
                this.domcomponents.outer.on("click",function(ev){
                    var cx = null
                    var rw=  Dom.selfOrUp(ev.target,".grid-row")
                    if(rw){
                        cx=ths.getRow(rw);
                    }
                    if(!(cx && cx.record)){return}
                    var rowdom=rw
                    if(rowdom && !rowdom.is(".selected")){
                        _lastCtx.row=null;
                    }
                    if(!(_lastCtx.row &&  _lastCtx.row.id===cx.id ) ) {
                            _lastCtx.row = cx;
                        rw.parent().qq(".selected").removeClass("selected")
                        rw.parent().qq('.grid-row[data-id="' + (cx.id) + '"]').addClass("selected")
                             cx.index = Dom.domIndex(cx.el)
                            ths.fire("rowselected", cx)

                    }
                    if( Dom.selfOrUp(ev.target,".grid-cell") ){
                        var cl=cx.getCell(Dom.selfOrUp(ev.target,".grid-cell"))
                        if(cl&&(!_lastCtx.cell || !(_lastCtx.cell &&  _lastCtx.cell.name===cl.name&&  _lastCtx.cell.el===cl.el)) ) {
                            _lastCtx.cell=cl
                            ths.fire("cellselected", cl)
                        }
                    }
                    if($d.is(ev.target,"[data-cmd]")){
                        //ths.getController().invoke(ev.target.dataset.cmd,[]);
                    }
                }) ;
                this.config.viewmode||(this.config.viewmode="grid")



                if(this.config.entityForm){
                    this.config.editable=this.config.entityForm;
                }
                if(this.config.editable){
                    this.config.entityForm=this.config.editable
                }
                if(this.domcomponents.toolbar){
                    this.buttonBar=this.domcomponents.toolbar.css({position:"absolute",r:1,t:"1px",  w:"auto",minWidth:150, textAlign:"right",overflow:"hidden",
                        zIndex:ZINDEX.BUTTONBAR});
                    if(this.config.entityForm){
                        if(!this.entityForm){
                            this.editable=this.entityForm=   DataGrid.plugins.entityForm(this).setup()
                        }
                        this.editable.addLinks(this.config.editable)
                        this.buttonBar.css("minWidth",Math.max(Number(String(this.buttonBar.css("min-width")).replace(/\D/g,"")),this.buttonBar.scrollWidth))
                        this.on("save",function(rec){
                            // this._renderer.renderSingleRow(rec)
                        })
                    }
                }
                if(this.config.title){
                    var dom=this.domcomponents.outer.q(".grid-title")
                    if(dom){
                        dom.html(this.config.title)
                    }
                }
               });

             this.observer.once("afterrender",function(){

                 setTimeout(this.resize.bind(this),500);
                  this._built=true
                 this.pager.on("pageloadstart.pager",function(){
                     this.domcomponents.loadmsg&& this.domcomponents.loadmsg.html("loading . .");
                     this.domcomponents.loadericon&&this.domcomponents.loadericon.show().css("opacity",1)
                     var st=this.domcomponents.toolbar_status
                      if(st){st.html("Loading ...")}
                      this.pager.observer.once("pageloadend" ,function(){
                         st && st.clear();
                         this.domcomponents.loadmsg&& this.domcomponents.loadmsg.html("&nbsp;");
                         if(this.domcomponents.loadericon){
                             this.domcomponents.loadericon.css("opacity",.01)
                             //this.domcomponents.loadericon.hide()
                         }
                     }.bind(this))

                 }.bind(this))

                 var plugins= DataGrid.plugins,gropts=this.config||{};
                  //grid-frame-header
                 if(!this.config.viewmode||this.config.viewmode=="grid"||this.config.viewmode=="table"){
                     this.colresizable =     plugins.colResize(this)
                      this.sortable     =     plugins.sortable(this)
                       if(this.config.scrollable!==false ) {
                            this.scrollable = plugins.scrollable(this)
                      }
                     if(this.config.columnFreeze){this.ColumnFreeze=  plugins.ColumnFreeze(this).setup()}
                 }  else {
                     this.domcomponents.tabheader && this.domcomponents.tabheader.hide()
                 }
                 if(this.config.infiniteScroll){this.infiniteScroll=  plugins.infiniteScroll(this).setup() ;this.pager.pagesize=200  }
                 if(this.sortable) {this.sortable.setup();}
                 if(this.scrollable) {this.scrollable.setup()}
                 if(this.config.showlayoutoptions&&this.config.rowtemplate){
                     this.layoutoptions=  plugins.layoutoptions(this).activate()
                 }
                 if( this.config.colmove||this.colmove){
                     this.colMove      =     plugins.colMove(this)}


                 var cn=this.config.filterContainer||this.domcomponents.frameheader
                 if(this.config.headerFilter&&cn){
                     this.config.filterContainer= cn
                     plugins.headerFilter(this).setup()
                    // cn.style.height="40px"
                 }
                 if(this.config.zebraColumn) {this.domcomponents.outer.addClass("zebra-col")}
                 if(this.config.zebraRow) {this.domcomponents.outer.addClass("zebra-row")}
                 if(this.config.nowrap) {this.domcomponents.gridWrap.addClass("nowrap")}
                    if(this.config.editoptions){
                        if(this.config.editoptions.add!=null){

                        }
                    }

                 if(this.ColumnFreeze) {this.ColumnFreeze.activate()}
                 if(this.colresizable) {this.colresizable.activate()}
                 if(this.colMove) {this.colMove.setup()}
                 if(this.config.popupEditor){
                     this.popupEditor=  plugins.popupEditor(this).setup()
                 }
                 if(this.config.inlineEditor){
                     this.inlineEditor=  plugins.inlineEditor(this).setup()
                 }
                  if(this.config.highlightcolumn&&this.config.viewmode!="block"){

                     this.on("cellselected",function(cx){
                         if(cx.columnIndex!=null&&cx.columnIndex>=0){
                             this.domcomponents.outer.st(".grid-column-selected").removeClass("grid-column-selected").
                                root(".grid-cell:nth-child("+(cx.columnIndex+1)+")").addClass("grid-column-selected")
                         }
                     })
                 }
                 this.domcomponents.framefooter.style.zIndex=ZINDEX.FOOTERBAR
                 this.domcomponents.frameheader.style.zIndex=ZINDEX.FRAMEHDR
                // plugins.gridMenu(this).setup();
                 this.domcomponents.tabheader &&  this.domcomponents.tabheader.on( "mousedown",
                     this.domcomponents.handleheaderSel.bind(this.domcomponents)
                 );
                 $d.addBoundsListener(this.domcomponents.outer,this.resize.bind(this));

             });
            var pr=Promise.deferred();
            this.data("_lookupsresolve_promise",pr)


              if(this.store){   var p=[]
                 this.cols.forEach(function(it){
                     if(it && !it.hidden&&it.hasLookup){
                         var pr=it.getLookupValueMap();
                         if(pr){p.push(pr)}
                     }
                 });
                 if(p.length){
                     var _resolved=0
                     Promise.all(p).then(function(){_resolved=1;
                         pr.resolve()
                      }.bind(this));
                     setTimeout(function(){
                         if(!_resolved){_resolved=1;
                             pr.resolve()
                      }}.bind(this),5000)

                 }else{ pr.resolve()  }
             }


        }
        _proto.addPlugin=function(id,optns){
            if( DataGrid.plugins[id]&&!(id in this)){
                this[id]= DataGrid.plugins[id](this);
                this[id].setup();
            }
            this[id] && this[id].activate && this[id].activate( optns )
        }
        _proto.removePlugin=function(id){
            if( DataGrid.plugins[id]&&!(id in this)){
                this[id].remove && this[id].remove();
            }
        }
        _proto.build=function(panel,recs){
            var dom;
            if(panel&&panel.nodeType){dom=panel;panel=null}
            else if(panel.contentWrap){this.panel=panel;dom=panel.contentWrap}
            else{dom=panel;panel=null}
            this.el=this.domcomponents.outer=$d(dom)

            if(!this.domcomponents.outer.hasClass("gridtable")){this.domcomponents.outer.addClass("gridtable")}
            if(this.config.rowHeight && this.config.rowHeight!="auto"){
                dom.classList.add("fixedheight")
            }
            dom.classList.add("unselectable")
            //this.domcomponents.frameheader && (this.domcomponents.frameheader.style.height="60px");
            if(panel){
                panel.on("resize afterlayout",$.throttle(function(){
                 this.fire("resize")}.bind(this),500))
            }
            //if(this.store){
                this.pager.observer.on("pageloadend",function(recs){
                     this._renderer.renderRows(this.store.getList() )
                    var st=this.domcomponents.toolbar_status
                    if(st){
                        //st.html("last refreshed: "+ $.date().format("hh:nn tt"))
                        }
                    this.updateMsg()
                }.bind(this))


            //}
            this._renderer.render( )
            if(this.store.records.size()&&this.store.records[0]){
                this._renderer.renderRows( )
            }else {var grid=this;
                this.store.observer.once("dataloadcompleted",function(){
                    var map=this.pager.properties.toMap()
                    delete map.pagesize
                    grid.pager.properties.update(map)
                    //grid._renderer.renderRows( )

                })
            }
            if(recs===true){
                this.pager.loadPage()
            }

            return this;
        }
        _proto.render=function( panel){

               if(!this._renderer.isRendered()&&panel ){

                   if(this.store && !this.store.size(true)){
                        this.pager.loadPage().then(function(){
                           this.build(panel)
                       }.bind(this))
                   } else{this.build(panel)    }

               } else{this._renderer.renderRows();}

             return this;
        }
        _proto.getStore=function(){return this.store}
        _proto.nav=function(mthd ){
            if(mthd && typeof(this.pager[mthd])=="function"){
                this.pager[mthd].apply(this.pager,$.makeArray(arguments,1))
            }
        }
        _proto.getColumnCells=function(name,allcells,safe,getcontentwrap){
            var colpos= 0,grid=this
            if(!name){return safe?[]:null}
            if(typeof(name)=="number"){colpos=name}
            else {
                var colmeta=$.is(name,Data.Column)?name:null
                if(!colmeta) {
                    var meta = this.store ? this.store.meta : this.meta, tofind = name
                    if (meta) {
                        tofind = (meta.find(name) || {}).name || name
                    }
                    colmeta = this.cols.find(function (c) {
                        return c.name == tofind
                    })
                }
                if (!colmeta) {
                    return safe?[]:null
                }
                var col = grid.domcomponents.tab.q('.grid-cell[data-name="' + colmeta.name + '"]')
                if (!col) {
                    col = this.domcomponents.gridWrap.q('col[data-name="' + colmeta.name + '"]')
                }
                if(col){colpos=col.at()+1}
            }
            if(colpos){var sel='.grid-cell:nth-child('+colpos+')'+(getcontentwrap?" .cell-content":"")
                if(allcells){
                    sel=sel+',.grid-header-cell:nth-child('+colpos+')'+(getcontentwrap?" .cell-content":"")+',.grid-footer-cell:nth-child('+colpos+')'+(getcontentwrap?" .cell-content":"")
                }
                return (allcells?grid.domcomponents.gridWrap:grid.domcomponents.rowset).st(sel)
            }
            return safe?[]:null
        }
        _proto.showStateMsg=function showStateMsg(msg,delay ){
            if(delay >0){
                setTimeout(showStateMsg.bind(this,msg),delay)
                return this
            }
               var d=this.domcomponents.loadmsg
                if(d){
                    if(!msg){d.css({opacity:0.01})}
                    else{d.show().html(String(msg)).css({opacity:1})}
                }
            return this
            }
        _proto.updateMsg= $.throttle(function _updateMsg( ){//
            var gridctx=this,d=gridctx.domcomponents.pagerwrap,store=this.store,pager=this.pager;
            if(!d||pager.pagesize<=0){return}
             if(!pager.totalrows || !pager.pageno){
                pager.recalc( store.size()) ;
             }
            pager.properties.recalcAll()

            if(!d.q(".grid-pager-text-pageno")){
                d.el.innerHTML=pagertemplate.replace(/\$([\w]+)/g,function(a,b){return pager[b]||""});//store.pager.toString( );
                d.on("click.gridpager",function(ev){ var key=$d.domdata(ev.target,"key");key && this.nav(Number(key)||key)}.bind(this)
                ,".grid-pager-text button")
                d.q("input").on("change",function(evt){ this.nav("nav",Number(evt.target.value)) }.bind(this))
             }   else{
                "startrow totalrows endrow totalpages pageno".split(/\s+/).forEach(function(k){
                    var el=d.q(".grid-pager-text-"+k);
                    if(!el){return}
                        if(k!="pageno"){el.html(pager[k])}
                        else{d.down("input").val(pager[k])}
                })
            }


        },{tailend:true});


        _proto.getContext=function _getContext(cel,rw ){

            var  cx={__isgridcontext:true}
            if(!(cel||rw)){return }
            if(cel && cel.__isgridcontext){
                return cel
            }
            if(rw && rw.__isgridcontext){
                cx=rw;
            }
            if(cel && cel.type&&cel.target&&cel.target.nodeType){
                cel=cel.target
            }
            if(cel && cel.nodeType){

                rw=$d.selfOrUp(cel,".grid-row");
                cel=$d.selfOrUp(cel,".grid-cell");
            }
            if( !(rw || cel)){return }
            if(rw) {
                if (rw === "first") {
                    cx.row = this.domcomponents.rowset.q('.grid-row')
                    cx.id = $d.domdata(cx.row, "id")
                }
                else if (rw && rw.__record__) {
                    cx.record = rw
                    cx.id = cx.record.id
                }
                else if ($.isPlain(rw)) {
                    cx.record = rw.record || rw;
                    cx.id = rw.id || cx.record.id
                    cx.row = rw.row
                    cx.column = rw.column
                    cx.cell = rw.cell
                    cx.columnname = rw.columnname
                }
                else if (rw && typeof(rw) != "object" && Number(rw) > 0) {
                    cx.record = this.store.getList().findById(rw)
                }
                else if (rw && rw.nodeType && $d.is(rw, ".grid-row")) {
                    cx.row = rw;
                }
            }
            if(cx.record&&!cx.id) {
                cx.id = cx.record.id;
            }
            if(!cx.id&&cx.row){
                cx.id = $d.domdata(cx.row, "id")
            }
            if(cx.id&&!cx.record&&this.store){
                cx.record=this.store.getList().findById(cx.id)
            }

            if(cx.id&&!cx.row&&this.domcomponents.rowset) {
                cx.row=this.domcomponents.rowset.q('.grid-row[data-id="'+cx.id+'"]')
            }
            if(typeof(cel)=="string"){
                cx.column=cx.column||this.store.meta.findField(cel)
                if(!cx.cell&&(cx.row&&cx.column)){
                    var col = grid.domcomponents.tab.q('.grid-cell[data-name="'+cx.column.name+'"]')
                    if(!col){
                        col=this.domcomponents.gridWrap.q('col[data-name="'+cx.column.name+'"]')
                        if(col){
                            cx.cell=cx.row.qq(".grid-cell")[col.at()]
                        }
                    }
                    else{cx.cell=col}

                }
            }
            if(!cel&&cx.cell){cel=cx.cell}
            if(cel&&cel.nodeType){
                if(!cx.cell){cx.cell=$d.selfOrUp(cel,".grid-cell")}
                if(!cx.column){
                    var name=$d.domdata(cx.cell,"name")
                    if(!name){
                        var idx=cx.columnIndex
                        if((idx==null || isNaN(idx)||idx<0) &&cx.cell&&!cx.column&&cx.cell.is("td")){
                            idx=$d.domIndex(cx.cell)
                        }
                        if(idx>=0){
                            cx.columnIndex=idx;
                            var col=this.domcomponents.gridWrap.q("col:nth-child("+(idx+1)+")")
                            if(col){name=$d.domdata(col,"name")}
                        }
                    }
                    if(name){
                        cx.column=this.store.meta.findField(name)
                    }
                }
          }

            if(cx.record ){return cx}
        }

        _proto.afterRender=function  afterRender( ){
              this.updateMsg();
             this.resize();
            //ths.domcomponents.gridWrap.scrollTop=0;
            if(this.config.viewmode=="block"){
                this.domcomponents.gridWrap.css({overflow:"auto"})
            }
            this.fire("afterrender");

        }
        _proto._resize= function _resize(w,h){
            var gridctx=this,Dom=$d,outer=gridctx.domcomponents.outer,
                rdm=outer.getBoundingClientRect(),
                wr= gridctx.domcomponents.gridWrap,
                ftr=outer.q(".grid-footer"),
                 hd=outer.q("table thead"),
                  clnhdr=gridctx.domcomponents.headerclone,
            info=gridctx.domcomponents.hdrInfo()
            var oht=rdm.height;
            //if(!outer.el.style.height && gridctx.domcomponents._h){oht=gridctx.domcomponents._h}
            if(oht &&wr ){
                var t=0//clnhdr?(info.bottom-4):info.top;
                var css={w: (rdm.width-8)}
                //if(gridctx.scrollable && gridctx.domcomponents._h!==oht){
                var frhd=outer.q(".grid-frame-header")
               if(frhd){t=frhd.offsetHeight}
                if(clnhdr){t += clnhdr.offsetHeight}
                if(t){css.top=t;}
                     //css.top=t;
                     css.h=oht-((ftr?ftr.offsetHeight:0)+(t))
                      gridctx.domcomponents._h=rdm.height
                    if(!outer.el.style.height){
                         //outer.el.style.height=$d.css(outer,"height")
                    }
             }
                Dom.css(   wr,css)
               if(clnhdr){
                  /// clnhdr.css({top:info.top,width:rdm.width-8,overflow:"hidden"})
               }



            if(this.config.viewmode=="tile"){
                this.domcomponents.rowset.css("width",this.domcomponents.gridWrap.width())
            }
            // if(wr.scrollHeight>wr.offsetHeight){wd=wd-14}
            //if(dm.width){Dom.css(tab,{width:(dm.width )+"px"});}
            var hndl=this.fire("afterresize")
        }
        _proto.getRow= function getRow(row){
            return this._rowModel(row)
        }
        _proto.findRow= function findRow(row){
            var model=this.getRow(row)
            if(model){
                return model.row
            }

        }
        _proto.cellAsWidget= function cellAsWidget(row,cell){
            var cl,c0l,row= this.getRow(row)
            if(row){
                return row.getCell(cell)
            }

         }
        _proto.resize= function _resize (w,h){
            if(!this.domcomponents.outer.isVisible(true)){this._needsRedraw=true;return}
            this._resize()}
        _proto.syncColWidths=function(){
            var tabhdr=this.domcomponents.gridWrap.q(".grid-tab .grid-header");
            var clonehdr=this.domcomponents.outer.q(".headerclone")||this.domcomponents.tabheader;
            clonehdr.style.overflow="hidden" ;//clonehdr.style.width=wr.style.width
            var clonehdrrow=clonehdr.firstElementChild
            //var hdrcell=this.domcomponents.gridWrap.q(".grid-tab .grid-header .grid-row .grid-header-cell:nth-child("+($d.at(t)+1)+")").el
            var clonecells=clonehdr.querySelectorAll(".grid-header-cell"),
                cells=tabhdr.querySelectorAll(".grid-header-cell")

            if(clonehdrrow && tabhdr.offsetWidth>0 && tabhdr.offsetWidth!=clonehdrrow.offsetWidth){

                _arrayEach(cells,function(it,i){
                    if(!it.offsetWidth){return}
                    clonecells[i].style.minWidth= clonecells[i].style.maxWidth=clonecells[i].style.width= (it.offsetWidth )+"px"
                })  ;
                //clonehdrrow.style.width=gridctx.domcomponents.tab.scrollWidth+"px"
                if(tabhdr.offsetWidth!=clonehdrrow.offsetWidth){
                    setTimeout(function(){
                        _arrayEach(cells,function(it,i){if(!it.offsetWidth){return}
                            clonecells[i].style.minWidth= clonecells[i].style.maxWidth=clonecells[i].style.width= (it.offsetWidth )+"px"
                        })  ;
                     },500)
                }
            }
        }
        _proto.setupDataEvents=function(){
            var store=this.store
            //Evnts
            store.on("dataloadprogress.gridloadobserver",this.updateMsg.bind(this));

            if(!this.config.infiniteScroll){
                /*this.pager.on("update", function(){
                    var res=this.pager.getPage(function(d){
                        this._renderer.renderRows(this.store.records);
                    }.bind(this))

                }.bind(this));
                */

            }


            store.on("data",function(ev){
                var type=ev.action||ev.type,bult=this._built
                 if(type=="load") {
                    this._renderer.renderRows();
                } else if((type=="delete"||type=="insert"||type=="update")) {
                     if (!bult) {return }

                     if(!(ev.record&& ev.record.id)){
                         console.log("no id for record")
                         return
                     }

                    this.store.applySortAndFilter(this.pager)
                     if (type == "delete" && this.store.findById(ev.record.id)){
                         //this.store
                     }

                    if (type == "delete" || type == "insert") {

                        this._renderer.renderRows();
                    } else if (type == "update" && ev.record) {
                        var r = this.getRow(ev.record);
                        if (! (r && r.row)) {
                            this._renderer.redraw()
                        }
                        else if(!this.config.ignoreupdate){
                            r.render();
                        }
                    }

                }

            }.bind(this));
            this.on("rowselected",function(cx){
                this.selectedRecord=cx.record;
            });
            this.on("viewupdate afterpageload",this.updateMsg.bind(this));

        }
        _proto.updateCell=function(rec,fld){
            var r=this.getRow(rec,fld)
            if(r&&fld){
                var cl=r.getCell(fld)
                //var cl=r.down('.grid-cell[data-datakey="'+fld+'"]')
                if(!cl){return}
                var f=this.store.meta.findField(cl.name)
                if(f&&cl.content){
                    var s= f.getDisplayValue(r.record.get(f.name))
                    if(s){
                        cl.content.html(s)
                    }
                }
            }
        }


        return Klass("View.DataGrid" ,_proto);
    })();


    /*Layout.impl.DataGrid=Klass("DataGrid",Layout.impl.base,{priority:10,
     setup:function(){

     },
     layout:function(){

     }

     }) ;
     */






//plugins
     DataGrid.plugins={
        layoutoptions:function(grid){
            var gridctx=grid,Dom=DomCore,_isactive=false,blocktemplate

            function onSelect(t){
                var k=$d.domdata(t,"key"),curr=gridctx.config.viewmode
                if(k&&k!=gridctx.config.viewmode){
                    gridctx.config.viewmode=k;
                    if(k=="table"){
                        blocktemplate=blocktemplate||gridctx.config.rowtemplate
                        gridctx.config.rowtemplate=null
                    }  else{
                        gridctx.config.rowtemplate=blocktemplate
                    }
                    gridctx.domcomponents.outer.hide().css("opacity",0.1).show()
                    gridctx.domcomponents.outer.removeClass("viewmode-"+curr)
                    gridctx.domcomponents.outer.addClass("fxtx")
                    setTimeout(function(){
                        gridctx.domcomponents.outer.css ("opacity", 1)
                         gridctx._renderer.renderRows(null,false,true)
                               setTimeout (function(){
                                 gridctx.domcomponents.outer.removeClass ("fxtx")
                             }, 1000)

                    },1)
                }
            }
            return {   label:"Loayout Options",
                setup:function(){


                    return this},
                activate:function(ev,el){
                    if(!_isactive){

                        _isactive=true;
                        blocktemplate=gridctx.config.rowtemplate
                        gridctx.config.rowtemplate=null

                        var dom=gridctx.domcomponents.toolbar.append("<span class='layout-options'><img valign='center'  src='theme/img/gridview.gif' class='layout-option' data-key='table' title='Grid View' /><img valign='center' src='theme/img/blockview.gif' class='layout-option' title='Tile View' data-key='tile'/></span>")
                        dom.st("img").css({border:"1px solid #ccc", margin:"0 2px"})
                        dom.on("click",function(ev,el){
                            el&&el.is(".layout-option")&&onSelect.call(gridctx,el)
                        },".layout-option")

                    }
                },
                remove:function(){_isactive=false;}
            };
        },
        colMove  :function(grid){
            var gridctx=grid,Dom=DomCore,_isactive=false,sel=".grid-header-cell",tracker=null
            return {   label:"Move Columns",
                setup:function(){

                    _isactive=true
                },
                activate:function(ev,el ){
                    var maxz=0,elhdr=gridctx.domcomponents.headerclone||gridctx.domcomponents.tabheader
                   var  optns= {
                       target:el,
                       start: function start(ev) {
                            var t = ev.el, dm = t.bounds()
                            var trgt = t.data("_sh"), l = t.offsetLeft
                            if (!trgt) {
                                var wr = gridctx.domcomponents.gridWrap, dm = t.bounds(), rdm = wr.getBoundingClientRect()
                                var sh = document.createElement("div");
                                sh.classList.add("col-resize-shadow");
                                $d.css(sh, {
                                    left: dm.left + "px",
                                    top: dm.top + "px",
                                    height: (rdm.bottom - (dm.top)) + "px",
                                    w: dm.width + "px",
                                    cursor: "col-resize"
                                });
                                sh = $d(document.body.appendChild(sh));
                                t.data("_sh", sh)
                                trgt = sh;
                            }
                            if (!maxz) {
                                $d.css(document.body, {cursor: "move"}).addClass("noselection");
                                maxz = elhdr.qq(sel).reduce(function (z, it) {
                                    return Math.max(z, Number($d.css(it, "zIndex")) || 0)
                                }, maxz || 0)
                                $d.css(trgt, "zIndex", ++maxz);
                            }
                        },
                        move: function move(ev) {
                            var el=ev.el
                             var trgt = el.data("_sh"), l = el.offsetLeft
                            if (!trgt) {
                                return
                            }

                            $d.css(trgt, "left", l + ev.data.delta.x)
                            var t1, b = $d.bounds(trgt), t, delta = ev.data.delta;
                            $d(trgt).hide()
                            t = document.elementFromPoint(b.left, b.top);
                            if (t) {
                                t1 = elhdr.qq(sel).filter(function (a) {
                                    return a.contains(t)
                                })[0];
                            }
                            ;
                            if (!t1) {
                                t = document.elementFromPoint(b.left + b.width / 2, b.top + b.height / 2);
                                t1 = elhdr.qq(sel).filter(function (a) {
                                    return a.contains(t)
                                })[0];
                            }
                            $d(trgt).show();
                            $d.data(this, "_current", t1 || null)

                        },
                        end: function end(ev) {var el=ev.el
                            var trgt = el.data("_sh")
                            var _current = $d.data(el, "_current"), s = $d.data(el, "_start");
                            $d.data(el, "_start", null);
                            $d.data(el, "_current", null)
                            $d.data(el, "_sh", null)
                            $d(document.body).css({cursor: "auto"})
                            if (trgt) {
                                $d.remove(trgt)
                            }
                            maxz = 0
                            if (_current) {
                                var nuidx = _current.at();

                                var idx = el.at();
                                if (nuidx == idx) {
                                    return
                                }
                                (gridctx.getColumnCells(idx + 1, true, true) || []).forEach(
                                    function (it) {
                                        //var t=it.parent().q(".grid-header-cell:nth-child("+nuidx+"),.grid-cell:nth-child("+nuidx+")")
                                        var t = it.sibling(nuidx - idx)
                                        if (!t) {
                                            return
                                        }
                                        it.parent().el.insertBefore(it.el, t.el.nextSibling)
                                    }
                                )

                            }
                        }
                    }
                    $d.on(el,"mousedown.mousetracker",function(){
                        $d.trackMouse(optns)
                    })
                  
                },
                remove:function(){_isactive=false;}
            };
        },
        colResize  :function(grid){
            var gridctx=grid,Dom=DomCore,_isactive=false,domhandle=null,dragging=0

            function onSelect(ev,t){
                if( !t ){
                    $d.css(document.body,{cursor:"auto"});
                    return
                }
                t= t.el||t
                var   wr= gridctx.domcomponents.gridWrap,dm=t.getBoundingClientRect(),rdm=  wr.getBoundingClientRect(),
                    st={x:ev.clientX,y:ev.clientY};
                // Dom.css(getOverlay(wr),{display:"block"}); ;

                Dom.css(document.body,{cursor:"col-resize"}).addClass("noselection");
                var tabhdr=gridctx.domcomponents.gridWrap.q(".grid-tab .grid-header");
                var clonehdr=gridctx.domcomponents.outer.q(".headerclone")||gridctx.domcomponents.tabheader;
                clonehdr.style.overflow="hidden" ;//clonehdr.style.width=wr.style.width
                var clonehdrrow=clonehdr.firstElementChild
                var hdrcell=gridctx.domcomponents.gridWrap.q(".grid-tab .grid-header .grid-row .grid-header-cell:nth-child("+($d.at(t)+1)+")").el
                var clonecells=clonehdr.querySelectorAll(".grid-header-cell"),
                    cells=tabhdr.querySelectorAll(".grid-header-cell");;
                tabhdr.st(".grid-header-cell").css("color",tabhdr.css("backgroundColor"))
                 var maxz=0
                  $d.on(t,"mousedown.mousetracker",function(){
                        $d.trackMouse(
                            {target:t,
                        start:function(ev){
                            dragging=1
                            var t=ev.el,dm=t.bounds()
                            var trgt=ev.el.data("_sh"),l=t.offsetLeft
                            if(!trgt) {//var t=this;
                                var wr=gridctx.domcomponents.gridWrap, dm=t.bounds (), rdm=wr.getBoundingClientRect ()
                                trgt=document.createElement ("div");
                                trgt.classList.add ("col-resize-shadow");

                                $d.css (trgt, {left: dm.left + "px", top: dm.top + "px", height: (rdm.bottom - (dm.top)) + "px", w: dm.width + "px", cursor: "col-resize"});
                                t.data ("_sh", trgt=$d (document.body.appendChild (trgt)))
                            }
                            if(!maxz) {
                                $d.css(document.body,{cursor:"move"}).addClass("noselection");
                                $d.toFront(trgt);
                            }
                        }
                        ,move:function(ev){
                            var trgt=ev.el.data("_sh"),l=t.offsetWidth
                            if(trgt&&ev&&ev){
                                $d.css (trgt,{left:dm.left,top:dm.top,width:Math.max(10,(l+ev.delta.x))}).toFront()
                            }

                        },
                        end:function(ev){
                            $d.css(document.body,{cursor:"auto"});
                            try{   var Dom=$d
                                var sh=ev.el.data("_sh")
                                ev.el.data("_sh",null)
                                if(!sh){dragging=0;return}
                                var idx,outer=gridctx.domcomponents.outer,p= t.parentNode,div= t.firstElementChild,wd=sh.offsetWidth ,
                                    _setwidths=gridctx.domcomponents.setwidths;
                                for(var i= 0,l=$.makeArray(p.children);i< l.length;i++){if(l[i]===t){idx=i;break;}} ;
                                if(idx>=0){
                                    //,td:nth-child("+(idx+1)+") .cell-content
                                    _arrayEach( outer.querySelectorAll(".grid-header-cell:nth-child("+(idx+1)+") ,col:nth-child("+(idx+1)+"),td:nth-child("+(idx+1)+")"),function(it){
                                        _setwidths(it.style,(wd-hdrwdoffst)+"px");
                                    })  ;
                                }
                                //gridctx.domcomponents.tab.scrollWidth&&$d.css({width:gridctx.domcomponents.tab.scrollWidth})
                                gridctx.syncColWidths()
                                //gridctx.domcomponents.tab.scrollWidth&&$d.css(clonehdrrow,{width:gridctx.domcomponents.tab.scrollWidth})

                            } finally{  dragging=0
                                // if(wr){wr.style.display=""}
                                //  Dom.css(getOverlay(wr),{display:"none"}) ;
                                if(sh){ sh.remove();sh=null;   }
                                $d.removeClass(document.body,"noselection")
                                $d.removeClass(gridctx.domcomponents.outer,"resizing")
                                _isactive=false;
                            }

                        }
                    })
           
                     })
                     

            }
            return {   label:"Resize Columns",
                setup:function(){
                    grid.on("render",function(){})
                    return this},
                activate:function(ev,el){
                    if(!_isactive){
                        var _last=null,compo=gridctx.domcomponents,header=compo.headerclone||compo.tabheader
                        if(!domhandle){
                            domhandle= header.append("<div>").addClass("col-resize-handle").css({position:"absolute",height:20,width:12,cursor:"col-resize",background:"url(theme/img/colresize_handle.png) no-repeat"})
                            domhandle.on("mousedown",function(ev){
                                if($d(this.data("_cell"))){
                                    $d(this.data("_cell")).up(".gridtable")
                                    onSelect(ev,$d(this.data("_cell")))
                                    _last=null
                                    ev.stopPropagation()
                                }
                            })
                        }
                        var offset=null
                        domhandle.hide()
                        _isactive=true;

                        header.on("mousemove",function(ev){
                            if(dragging){domhandle.hide();return}
                            if(!offset){
                                var par=$d.getOffsetParent(domhandle);
                                if(!par){return}
                                offset=header.bounds().top-par.bounds().top
                            }
                            var cell=$d(ev.target).selfOrUp(".grid-header-cell");
                            if(cell&&cell.id&&cell.id!==_last){  _last=cell.id
                                var b1=header.bounds(),b=cell.bounds()
                                domhandle.css({top:offset +   (b.height-20)/2,left: (b.right-b1.left)-6}).show().data("_cell",cell.id)
                             }

                         })
                     }
                },
                remove:function(){_isactive=false;}
            };
        },
        sortable:function(grid){
            var gridctx=grid   ,Dom=DomCore, _isactive =0
            function handleSort(ev,checked){
                if(!_isactive){return}
                var t=Dom.is(ev.target,".grid-header-cell")?$d(ev.target):Dom.up(ev.target,".grid-header-cell"),p,idx;
                if(!t){return}

                p=t.parentNode;idx=Dom.domIndex(t)
                var tab=Dom.up(t,".gridtable");if(!tab){return}
                var c=tab.q(".grid-tab col:nth-child("+(idx+1)+")");
                var nm=c? $d.domdata(c,"name"):"";

                if(nm){
                    gridctx.on("afterrender",function(){
                        gridctx.domcomponents.outer.qq(".grid-header-cell.sort-a,.grid-header-cell.sort-d").removeClass(["sort-d","sort-a"])
                        t.addClass("sort-"+gridctx.pager.sortdir)
                    },{once:true})
                    gridctx.pager.applySort(nm);
                    if(gridctx.pager.isCachedLocal){
                        gridctx.domcomponents.resetscroll()
                        gridctx._renderer.renderRows();
                    }


                    //c.addClass()
                }
            }
            return {   label:"Sort Columns",
                setup:function(){
                    if(_isactive){return}
                    _isactive=true;
                    gridctx.domcomponents.outer.addClass("issortable")
                    //grid.domcomponents.outer.on("click",
                    /*grid.domcomponents.outer.on("click.grid-header-cell",
                        function(ev,el){
                             handleSort.call(el,ev,true ) ;
                        },".grid-header-cell" );
                        */
                    return this;
                },
                activate:function( ev,el){
                    handleSort.call(el,ev,true ) ;
                },
                remove:function(){_isactive=false;}
            };

        },
        scrollable:function scrollable(grid){
            var   _isactive=0,cmp=grid?grid .domcomponents:null,Dom=DomCore,rowhdrht=0;
            function sethdht(){
                var hd=this
                var setStyle=$d.css.setStyle
                if(hd){
                    Dom.qq(hd,".grid-header-cell,.grid-row").forEach(function(c){

                        setStyle(c,"lineHeight","1px")
                        setStyle(c,"height","1px")
                        //c.style.lineHeight= "1px";c.style.height= "1px";
                        c.style.overflow= "hidden"
                    })

                        setTimeout(function(){
                            var b=grid.domcomponents.tab.bounds(),d=grid.domcomponents.tab.parent().bounds().left-b.left;
                            if(grid.domcomponents.headerclone){
                                $d.css(grid.domcomponents.headerclone,{left:( 1-d)})//,width: b.width
                            }
                        },10)



                    // hd.style.marginTop="-"+hd+"px";
                    //   hd.style.position="absolute"
                }
            }
            function onresize(){  if(!_isactive){return}
                if(grid.domcomponents.headerclone){
                    synchdrwidths( );
                }
                proc()
            }
            function setwidths(st,w){ if(w&&w!="0px"&&w!="0"){st.maxWidth=st.minWidth=st.width=w}}
            function synchdrwidths (hd0,cl0){   if(!_isactive){return}
                 var gridctx= grid,   Dom=$d, cmp=gridctx.domcomponents,_setwidths=setwidths, hd=hd0||cmp.tabheader, cl=cl0||cmp.headerclone;
                var firstrow=cmp.row(0);
                if(!(firstrow&&cl)){return}
                try{
                    var setStyle=$d.css.setStyle
                    hd.style.display="";hd.visibility="visible"
                    var cls=[];
                    [].forEach.call(firstrow.querySelectorAll(".grid-cell"),
                        function(it,i){
                            cls.push({width:Number(Dom.css(it,"width").replace(/[\D]+$/,""))})
                        }
                    );

                     _arrayEach(cl.querySelectorAll(".grid-header-cell .cell-content,.rownum"),
                        function(it,i){
                             if(!it.classList.contains("rownum") && cls[i]) {
                                 var par=it.parentNode
                                 setStyle(par, "width"  , cls[i].width + "px")
                                 setStyle(par, "minWidth", cls[i].width + "px")
                                 setStyle(par, "maxWidth", cls[i].width + "px")
                             }
                                 //cls[i] && _setwidths(it.parentNode.style,(cls[i].width )+"px");}
                         }
                    );

                    if(cls.length){
                        firstrow.classList.add("_widthadjusted");
                        _arrayEach(firstrow.querySelectorAll(".grid-cell .cell-content,.rownum"),
                            function(it,i){if(cls[i]==null){return}
                                //_setwidths(it.style,(cls[i].width)+"px");
                                var par=it.parentNode
                                setStyle(par, "width", cls[i].width + "px")
                                setStyle(par, "minWidth", cls[i].width + "px")
                                setStyle(par, "maxWidth", cls[i].width + "px")
                                //_setwidths(it.parentNode.style,(cls[i].width)+"px");
                            });
                        cmp.colset.forEach(function(it,i){
                            setStyle(it, "width", cls[i].width + "px")
                            //it.css({w:(cls[i].width)+"px"})
                        });
                    }

                } finally{
                    if(!rowhdrht&&hd.offsetHeight>10){rowhdrht=hd.offsetHeight; }

                    hd.style.visibility="hidden";
                 }
             }
            function proc(refresh){  if(!_isactive){return}
                var gridctx=grid,cmp=gridctx.domcomponents,
                    hd=cmp.tabheader,
                    hdcln=cmp.outer.querySelector(".headerclone"),
                    cl

                if(!cmp.gridWrap.querySelector(".grid-rowset .grid-row .grid-cell")){
                    return}
                cmp.gridWrap.css({overflow: "auto",position:"relative"})

                if(!hdcln){refresh=0}
                if(refresh===true){
                    if(hdcln) {hdcln.parentNode.removeChild(hdcln)}
                    hdcln=null;
                }
                if(hdcln||!hd){
                    if(hd){sethdht.call(hd)}
                    return
                }

                //Dom.st(cl,".grid-header-cell" )
                var   hi=cmp.hdrInfo() ;
                cl= cmp.outer.appendChild(hd.clone(true,true));
                cl.classList.add("headerclone")  ; cl.style.display="" ;
                hd.style.display="";
                var bg=Dom.css(hd,"backgroundColor")
                var setStyle=$d.css.setStyle
                $d(hd).qq(".grid-header-cell").forEach(function(it){setStyle(it,"color",bg)});
                Dom.css(cl,{visibility:"visible", z:50,l:"0",w:"auto"});//t:hi.top+"px",h: (hi.height)+"px",
                setStyle(cl,"top",hi.top+"px")
                setStyle(cl,"height",hi.height+"px")
                Dom.qq(cl,".grid-header-cell").forEach(function(c){
                    setStyle(c,"lineHeight",hi.height+"px")
                    setStyle(c,"height",hi.height+"px")
                    //c.style.lineHeight= c.style.height= hi.height+"px";
                });
                var h2=hi.height+4
                Dom.qq(cl,".grid-row").forEach(function(c){
                    setStyle(c,"lineHeight",h2+"px")
                    setStyle(c,"height",h2+"px")
                    //c.style.lineHeight= c.style.height= (hi.height+4)+"px";
                })
                setStyle(cl,"height",h2+"px")
                //cl.style.height=(hi.height+4)+"px";
                 var hdrrow=hd.firstElementChild;
                hdrrow.style.overflow="hidden";
                //hdrrow.style.height="1px";   //hdrrow.style.lineHeight=hd.style.lineHeight= d.style.height= "1px";
                setStyle(hdrrow,"height","1px")
                Dom(cl).on( "mousedown",
                    gridctx.domcomponents.handleheaderSel.bind(gridctx.domcomponents)
                );

                if(!refresh){
                    grid.on("scroll",function(ev){
                        sethdht.call(cmp.tabheader)
                    });
                    //ths.domcomponents.gridWrap.scrollTop=0;

                    sethdht.call(cmp.tabheader)
                    gridctx.on("viewupdate afterpageload ",function(){
                        sethdht.call(this.domcomponents.tabheader)
                    });
                } else{sethdht.call(cmp.tabheader)}
                //cmp.gridWrap.style.top=hi.bottom+"px"  ;
                synchdrwidths( hd,cl)
                return cl
            }

            return {    label:"Scrollable",
                setup:function(){
                    this.activate();
                    grid.on("pageload",function(){ proc(true) })
                    return this;
                },
                activate:function(){    _isactive   =1
                    onresize()
                    grid.domcomponents.gridWrap.css({overflow: "auto",position:"relative"})
                     grid.domcomponents.outer.addClass("scrollable")
                    grid.on("viewupdate afterrender afterresize", onresize );


                },
                remove:function(){_isactive=false;}
            };

        },
        headerFilter: function setupHeaderFilter(grid){
            var _isactive=0,filterholder=null,config=grid.config.headerFilter;
            if(!$.isPlain(config)){config={}}
            function setup(){
                if(grid.config.filterContainer && !$d.q(grid.config.filterContainer,".grid-filter")){
                    var filters=grid.filters||(grid.filters=[]),
                        tip="<span class='grid-filter-tip' style='float:left;margin-top:0;margin-left:20px;padding:0 3px;border: 1px solid #ccc;color:#666;font-size:.9rem;background-color:white;'>Add filter</span>";
                    var  colLkupMap={},Core=self.CoreUtils      , eltemplateEl, eltemplate="" +
                        "<span class='filter-elem-wrap'> " +
                        "  <div class='filter-elem_ph'></div>" +
                        "  <div class='filter-elem'></div>" +
                        "  <div class='filter-elem-add'>+</div>" +
                        "</span>";

                    grid.config.filterContainer.insert("<div class='ui-lighter grid-filter'>" +
                        "  <div class='bluegrdnt grid-filter-stub'> </div>" +
                        "  <div class='content grid-filter-content  ui-lighter'>"+tip+"</div>" +
                        "</div>").q(".grid-filter-content")
                    var wrap=grid.config.filterContainer.q(".grid-filter-content")
                    filterholder=new Data.criteria({meta:grid.store.meta});
                    var PopupView= $.require("PopupView")
                    var controller={
                        removeElement:function(fltritem,v,anchor){
                            filterholder.remove(fltritem.col,v )
                        },
                        showColList:function(fltritem,v,anchor){

                            var vw= null//wrap.data("_colpopup")
                            if(!vw){
                                vw=PopupView.lookupList(
                                    {keyname:"name",labelname:"label",

                                        list:grid.store.meta.collect(function(it){return {name:it.name,label:it.label}}).slice()
                                        .filter(function(a){return a.name != "id" && a.label && a.label.length>1 && (!config.filterColumns || config.filterColumns.indexOf(a.name)>=0 ) && (!config.ignoreColumns || config.ignoreColumns.indexOf(a.name)==-1 )})
                                    },
                                    {maxWidth:250,minWidth:100,
                                    anchor:anchor,
                                        callback:function(rec){var ky=rec.name,lbl=rec.label

                                            if(!filterholder.findElement(ky)){filterholder.append(ky)}
                                            var fltritem=filterholder.findElement(ky);
                                            //var anchor=$d.selfOrUp(([].slice.call(document.querySelectorAll(":hover"))).pop(),".list-item")
                                            controller.showValList(fltritem,ky,anchor,lbl )
                                            vw.hide();
                                            //filterholder.append(ky,"","=",lbl,true);
                                            //controller.updateView(fltritem,v,anchor,function(){
                                            //    controller.showValList(ky,v,vw.config.anchor )
                                            //})

                                        }
                                });

                                wrap.data("_colpopup",vw)
                                /*wrap.data("_colpopup",vw=View.lookupList({anchor:anchor,width:150,height:200, bottomAligned:true ,
                                    keyname:"name",labelname:"label" ,list:{list:grid.store.meta.collect(function(it){return {name:it.name,label:it.label}}).slice().filter(function(a){return a.name != "id" && a.label && a.label.length>1})}
                                },function(ky,lbl){
                                    if(!filterholder.findElement(ky)){filterholder.append(ky)}
                                    fltritem=filterholder.findElement(ky)
                                    controller.showValList(fltritem,v,vw.config.anchor )
                                    //filterholder.append(ky,"","=",lbl,true);
                                    //controller.updateView(fltritem,v,anchor,function(){
                                    //    controller.showValList(ky,v,vw.config.anchor )
                                    //})

                                }))*/
                            }
                            if(vw.config.options){vw.config.options.anchor=anchor}
                            else{vw.config.anchor=anchor}
                            vw.show( ) ;
                        },
                        showValList:function(fltritem,v,anchor,lbl){
                            //b,col,upd
                            //var vw= wrap.data("_wrappopup"),k= fltritem.col;
                            //if(!vw){
                                var vw=PopupView.lookupList([],
                                    {alignAnchor:"below" ,maxWidth:250,minWidth:150,
                                        callback:function(rec){
                                        var v=rec.name||rec.id,lbl=rec.label
                                        if(v==null){return}
                                        var col= vw.config.col,idx=vw.config.isupdate[0],lkupdata=vw.lkupdata;
                                        if(lkupdata && !lbl){
                                            for(var i= 0,l=lkupdata.list||lkupdata ,ln=l.length||0;i<ln;i++){
                                                if(l[i].id==v ){
                                                    lbl=l[i].label||l[i].value||v
                                                }
                                            }

                                        }
                                        if(idx>=0){
                                            filterholder.update(col,v,lbl,idx)
                                        }
                                        else{
                                            filterholder.append( col,v,null,lbl)
                                        }
                                            vw.hide()
                                        //var fltritem2=filterholder.findElement(col)
                                        //controller.updateView( fltritem2,idx,null,null)
                                    }}
                                )
                                /*wrap.data("_wrappopup",vw=View.lookupList({uiklass:"nowrap",anchor:anchor,width:250,height:200, bottomAligned:true},
                                    function(v,lbl){if(v==null){return}
                                        var col= vw.config.col,idx=vw.config.isupdate[0],lkupdata=vw.lkupdata;
                                        if(lkupdata && !lbl){
                                                for(var i= 0,l=lkupdata.list||lkupdata ,ln=l.length||0;i<ln;i++){
                                                    if(l[i].id==v ){
                                                        lbl=l[i].label||l[i].value||v
                                                    }
                                                }

                                        }
                                        if(idx>=0){
                                            filterholder.update(col,v,lbl,idx)
                                        }
                                        else{
                                            filterholder.append( col,v,null,lbl)
                                        }
                                        //var fltritem2=filterholder.findElement(col)
                                        //controller.updateView( fltritem2,idx,null,null)
                                    }))
                            }*/
                            vw.contentWrap.css("backgroundColor","#f9f9f9")
                            vw.config.col=fltritem.col;
                            vw.config.isupdate= [typeof(v)=="number"&&v>=0?v:-1];
                            $d.html(vw.config.header,"<h4>"+(fltritem.title||lbl||v||"")+"</h4><input type='search' style='width:100px;' class='search-box'/><span style='display: inline-block;margin-left:10px;' class='item-count'></span>")
                            var srchbox=$d(vw.config.header).q(".search-box")
                            srchbox.on("click",function(ev){
                                var val=this.val()
                                if(val){
                                    if(this.bounds().right-ev.x <20){
                                        this.val("");
                                        var items=this.up(".popup-view").qq(".list-item")
                                        items.css("display","block");
                                        this.up(".popup-view").q(".item-count").html(items.length)
                                    }
                                }
                            })
                            srchbox.on("keyup",function(ev){
                                var cnt= 0,val=this.val(),items=this.up(".popup-view").qq(".list-item")
                                if(val){val=val.toLowerCase()
                                    items.each(function(a){
                                        var vis=$d.text(a).toLowerCase().indexOf(val)>=0
                                        vis && cnt++;
                                        a.css("display",vis?"block":"none")
                                    })
                                } else{
                                    items.css("display","block")
                                    cnt=items.length
                                }
                                this.up(".popup-view").q(".item-count").html(cnt)
                            })
                            if(vw.config.options){vw.config.options.anchor=anchor}
                            else{vw.config.anchor=anchor}
                            var f=grid.store.meta?grid.store.meta.findField(fltritem.col):null
                            var crit
                            if(f&& !( f.primaryEntity)){
                                crit=grid.store.defaultCriteria
                            }
                            filterholder.getLookupList(fltritem.col,false,crit ).then(function(data){
                                vw.renderList(data,{anchor:anchor})
                                var list=data.data||data.list||data
                                vw.el.q(".item-count") && vw.el.q(".item-count").html(list.length)
                                //vw.lkupdata=data
                                vw.show( ) ;//data,anchor

                            });
                        },
                        updateView:function( fltritem,v,anchor,cb){

                            var  curr=grid.pager.filter||"";
                             var redrw=false;
                            if(filterholder.empty()){
                                grid.pager.filter="_clear_" ;
                                grid.pager.loadPage()
                            } else {
                                var js=grid.pager.isCachedLocal?filterholder.toJs(grid.pager.isCachedLocal):filterholder.toSql();
                                 if(grid.pager.update({filter:js})){
                                     grid.pager.loadPage()
                                }
                            }
                            //  if(redrw){ grid._renderer.redraw()  }
                            wrap.clear();
                            filterholder.collect(function(k,mdl){
                                if(mdl==null||mdl==""){return}
                                var nu=wrap.q("[data-key='"+k+"']")
                                var val=mdl.val,title=String(  mdl.title||k).trim()
                                var lst=[]
                                if(  val &&val.length){
                                    val=val.filter(function(it){return !(it.value==null||it.value=="undefined")})
                                    val.elem=nu;
                                    lst=val
                                }
                                if(  !lst.length ){
                                    return;
                                }
                                 if(!nu){
                                    if(!eltemplateEl){ eltemplateEl=$d(eltemplate) }


                                    nu=addel?addel.before(eltemplateEl.el.cloneNode(true)):wrap.append(eltemplateEl.el.cloneNode(true))
                                    nu.dataset.key=k   ; //nu.dataset.index=idx;
                                    nu.q(".filter-elem_ph").html(title )//.append("<div class='filter-elem-remove'>x</div>")
                                }


                                    var addel=nu.q(".filter-elem-add"),lkup;
                                    filterholder.getLookupList(k).then(function(data){
                                        lkup=data
                                    });
                                     lst.forEach(function(v){if(v==""||v==null){return}
                                        if(typeof(v)!="object"){v={value:v,label:v}}
                                        var el=nu.q(".filter-elem")||$d(nu.append("<div class='filter-elem'></div>"));
                                        var v1=v.value,cln=el.el.cloneNode(true),lbl=String(  v.label||v1).trim();cln.id="";
                                         if(addel){cln=addel.before(cln)}
                                        else{cln=  nu.append(cln );}


                                        cln.html(lbl);
                                        cln.append("<div class='filter-elem-remove'>x</div>")
                                        cln.title=cln.dataset.val=v1
                                    });
                                    var all=nu.qq(".filter-elem");
                                    if(all.length>1){all.forEach(function(it){if(!String(it.textContent).trim()){nu.el.removeChild(it.el||it)}})}
                                    nu.addClass("has-value") ;
                                    // nu.addClass("has-value").q(".filter-elem").html(  lbl)
                                //} else{ nu&&nu.removeClass("has-value")}
                                return nu
                            })  ;

                            wrap.append(tip)
                            grid.fire("viewupdate" );
                            wrap.qq(".filter-elem-wrap").forEach(function(it){if(it.scrollWidth-it.offsetWidth>0){it.style.width=(it.scrollWidth+1)+"px"}})
                            if(typeof(cb)=="function"){cb()}
                        }
                    }
                    filterholder.on("change",function(){
                        controller.updateView();
                    })
                     wrap.on("mousedown",function(evt){
                        if(evt.which==3||!_isactive){return}
                         var act,idx,fltritem,r=UI.Rect.create(evt),v=null;
                        r.top=wrap.bounds().bottom
                        var elem=$d.selfOrUp(evt.target,".filter-elem-wrap")
                        if(elem && elem.contains(evt.target)){
                            var k=elem.dataset.key , el=elem

                            var c=filterholder.meta.findField(k)
                            if(c){fltritem=filterholder.findElement(c.name)}
                            if(!fltritem){
                                filterholder.append(c.name)
                                fltritem=filterholder.findElement(c.name)
                                if(!fltritem){return}
                            }
                            var felem=$d.selfOrUp(evt.target,".filter-elem");
                            if(felem){
                                v=felem.dataset.val;
                                var arr=[].concat(fltritem.val)
                                if(!v){return}
                                idx=arr.indexOf(arr.find(function(it){return it.value==v}))
                                if(idx>=0&&$d.selfOrUp(evt.target,".filter-elem-remove")){
                                    v=idx;
                                     act=controller.removeElement
                                } else{   v=idx>=0?idx:v;
                                    act=controller.showValList;
                                }

                            } else {
                                if($d.selfOrUp(evt.target,".filter-elem-remove")){
                                    act=controller.removeElement
                                } else{act=controller.showValList}
                            }
                        } else{act=controller.showColList}
                        if(act){act.call(controller,fltritem,v, evt.target)}

                    })
                }
                grid.headerFilter=this;
            }
            return {   label:"Header Filter",
                getCriteriaHolder:function(){return filterholder},
                setup:function(){
                    this.activate();
                    return this;
                },
                activate:function(){  _isactive=1
                    setup.call(this)
                },
                remove:function(){_isactive=false;}
            };
        } ,
        infiniteScroll:function setupInfiniteScroll(grid){  var _isactive=0;
            //wr wrap
            function setup(){
                var wrp=grid.domcomponents.gridWrap,doc=document,clht=wrp.clientHeight, store=grid.store , rowht=20,
                    _addrowsbound=grid._renderer.addrows.bind(wrp._renderer), tab=grid.domcomponents.tab,rowset=grid.domcomponents.rowset,lasrscroll=0
                    var pageCache={}
                    if(rowset.q(".activepage")){return}
                    var _firstlastview=function(){
                        var b=wrp.getBoundingClientRect()
                        var top,top1=doc.elementFromPoint(b.left+30,b.top+15),//,".grid-row"),
                            last=doc.elementFromPoint(b.left+30,b.bottom-15),curr={};
                        if(top1&&!top1.classList.contains("grid-row")){top1=$d.up(top1,".grid-row")}
                        if(last&&!last.classList.contains("grid-row")){last=$d.up(last,".grid-row")}
                        return {top:top1,last:last}
                    }
                    var _handle=function(){
                         //if(tdif>1000){
                        var pr=Promise.deferred(),grid=this ,msg=grid.domcomponents.loadmsg,
                            lastrow=grid.domcomponents.tab.querySelector(".grid-rowset .grid-row:last-child")

                        grid.pager.next()
                        var scrtp=wrp.scrollTop
                        grid.pager.getPage(false,function(records){
                            grid.observer.once("afterpageload",function(){
                               if( grid.pager.pageno==grid.pager.totalpages){
                                    if(cmp.rowset.tagName!="TBODY"){
                                        cmp.rowset.style.height="auto"
                                    }
                                }
                                 if(msg){msg.html("...")};pr.resolve()
                            });
                            grid._renderer.renderRows(records,true)
                            //if(lastrow&&lastrow.scrollIntoView){
                               // lastrow.scrollIntoView(false);lastrow.classList.add("selected")
                           // }

                        })
                            return pr;
                        //}
                    }.bind(grid);
                var cmp=grid.domcomponents,scrollTreshold=  50  ,pageheight=0 ,totalheight=0
                function _onscroll (ev){

                    var grid=this,store=grid.store,cmp=grid.domcomponents,wrp=grid.domcomponents.gridWrap,tab=cmp.tab,nw=Date.now(),tdif=nw-lasrscroll,
                        tp=wrp.scrollTop,oldtp=wrp._scrollTop  ,pager=this.pager
                    wrp._scrollTop=tp;
                    if((oldtp && oldtp>tp) || pager.pageno>=pager.totalpages){return}
                    var vw=_firstlastview()

                     if(oldtp && oldtp>tp){return}//if moving up return
                    var  pr,t=tab.offsetHeight,ch=wrp.clientHeight,tot=tp+ ch,
                        last=tab.querySelector(".grid-rowset .grid-row:last-child"),t1=0,b;
                    if(!last) {return}
                    b=last.getBoundingClientRect()
                    t1=(b.top+b.height+10) -  wrp.getBoundingClientRect().top
                    wrp._lastDiff= tot-t1;lasrscroll=nw;
                     if(t1<(2*ch) ){
                         pr=_handle();
                     }

                    if(wrp._scrollLeft===tp){return}
                    wrp._scrollLeft=tp ;

                    cmp.headerclone&&(cmp.headerclone.style.left=(1-wrp.scrollLeft)+"px");
                    return pr
                };
                if(!pageheight) {pageheight=cmp.rowset.offsetHeight}
                if(pager.totalpages){
                    totalheight=pageheight*pager.totalpages
                    if(cmp.rowset.tagName!="TBODY"){
                        cmp.rowset.style.height=totalheight+"px"
                    }
                }
                grid.on("scroll", $.throttle(_onscroll,10))
                if(pager.totalrows*rowht> wrp.offsetHeight){
                    // var el=wrp.insertBefore(document.createElement("div"),tab); el.classList.add("scroll-fit")
                    //    DomCore.css(el,{ h:( store.pager.totalrows*rowht)+"px"})
                }
            }
            return {    label:"Infinite Scroll",
                setup:function(){
                    this.activate();
                    return this;
                },
                activate:function(){
                    setup.call(this)
                },
                remove:function(){_isactive=false;}
            };
        },
        ColumnFreeze:function(grid){
            var _isactive= 0,wrp,numofcols= 2,outer,Dom=DomCore,optns={},gwrp,colcnt,bdy,wrphdrht= 0,hdr;
            var lastctx={},  doc=document
            function proc(){ if(!_isactive){return}
                var headerclone=grid.domcomponents.headerclone,
                    headerrow=headerclone?headerclone.q(".grid-row"):grid.domcomponents.tabheader.q(".grid-row"),ifo=grid.domcomponents.hdrInfo(),
                    wrpbdy= wrp?wrp.querySelector(".grid-rowset"):null,
                    wrp_hdr= wrpbdy?wrpbdy.previousElementSibling:null;
                var b=gwrp.getBoundingClientRect()    ,w10=(wrp?wrp.offsetWidth: b.width)+10
                var top,top1=doc.elementFromPoint(b.left+w10,b.top+15),//,".grid-row"),
                    last=Dom.up(doc.elementFromPoint(b.left+w10,b.bottom-15),".grid-row"),curr={};

                if(wrpbdy){[].forEach.call(wrpbdy.querySelectorAll(".grid-row"),function(r){curr[r.dataset.id]=r});}
                if(gwrp.scrollTop<20){
                    top=bdy.el.firstElementChild;
                } else if(top1 && !Dom.up(top1,".grid-rowset")){
                    top1.style.display="none";
                    top=Dom.up(doc.elementFromPoint(b.left+w10,b.top+15),".grid-row")
                    top1.style.display="";
                } else{top=Dom.up(top1,".grid-row")}

                if(headerclone && gwrp.scrollLeft>0) {headerclone.el.style.marginLeft=(0-gwrp.scrollLeft)+"px"}
                var i= 5,mx=150;
                while(!last){i=i+15;if(i>mx){break;}
                    last=Dom.up(doc.elementFromPoint(b.left+w10,b.bottom-i),".grid-row")
                }

                if(top && last){//top.style.backgroundColor="red";last.style.backgroundColor="red"
                    if(lastctx.top===top && lastctx.last===last  ) {return}
                    lastctx.top=top ;lastctx.last=last
                    last=last.nextElementSibling    ||last
                    last=last.nextElementSibling    ||last
                    var w= [],rw=top,idx=-1,//clrows=$.makeArray(wrpbdy.children),
                        tofset= top.getBoundingClientRect().top - headerrow.getBoundingClientRect().bottom ;

                    //   _syncset(hdr,wrp_hdr)
                    var nurows=[], ccnt=colcnt ,nunu=[]
                    while(rw){var _id=rw.dataset.id||"";
                        if( !w.length){
                            for(var i=0;i<ccnt;i++){w.push(rw.children[i].offsetWidth)}
                        }
                        if(_id && curr[_id]){   curr[_id].className=rw.className
                            nurows.push(curr[_id]);
                            delete curr[_id]
                        }
                        else {
                            var rw1=rw.cloneNode(false);  rw1.id="";
                            rw1.className=rw.className      ;  rw1.classList.add("grid-clone-row") ;
                            rw1.style.height=rw.offsetHeight+"px"
                            for(var i=0;i<ccnt;i++){ var c=rw.children[i];if(!(w[i] && c)){continue;}
                                var nu= c.cloneNode(true) ,stl=nu.style ;
                                stl.minWidth=stl.maxWidth=stl.width=w[i]+"px"//Dom.css(c,"width");
                                rw1.appendChild(nu)
                            }
                            nunu.push([rw1,rw])
                            nurows.push(rw1);
                        }
                        //_syncset(rw,rw1)
                        if(rw===last){break;}
                        rw=rw.nextElementSibling;
                    }
                    for(var k in curr){curr[k].parentNode && curr[k].parentNode.removeChild(curr[k])}
                    while(nurows.length){wrpbdy.appendChild(nurows.shift());}
                    for(var i=0;i<ccnt;i++){ var c=wrp_hdr.children[i];if(!(w[i] && c)){continue;}
                        var  stl=c.style ;
                        stl.minWidth=stl.maxWidth=stl.width=w[i]+"px"//Dom.css(c,"width");
                    }
                    wrpbdy.style.marginTop=Math.min(0,tofset )+"px";
                    var  ww= w.reduce(function(m,it){return m+it},0) ;
                    if(ww>50){wrp.style.width=ww+"px" ;}
                    wrp.style.top=headerclone.style.top ;
                    wrp.style.height=(gwrp.offsetHeight+wrphdrht)+"px" ;


                }
            } ;
            function setup( num,refresh){   if(num>0){numofcols=num;}
                // var gridwr,outer
                outer=grid.domcomponents.outer ;
                gwrp=grid.domcomponents.gridWrap;
                colcnt=Number(numofcols)||Number(grid.config.columnFreeze)|| 1;
                bdy=grid.domcomponents.rowset ;
                hdr=gwrp.q(".grid-tab .grid-header .grid-row");
                if(!Dom){return}
                if(optns.rownum){colcnt++}
                if(!(bdy && bdy.el.childElementCount)){return}
                wrp=outer.q(".grid-columnfreeze-overlay")
                var
                    wrpbdy= wrp?wrp.querySelector(".grid-rowset"):null,
                    wrp_hdr= wrpbdy?wrpbdy.previousElementSibling:null ,
                    headerclone=grid.domcomponents.headerclone,
                    headerrow=headerclone?headerclone.q(".grid-row"):null,ifo=grid.domcomponents.hdrInfo();
                if(!headerclone){return}

                if(headerclone && (refresh===true||!wrp)){
                    //  gwrp.style.top=ifo.bottom+"px";
                    wrp=wrp||Dom(outer.appendChild(document.createElement("div")));wrp.className="grid-columnfreeze-overlay"
                    wrp.clear();
                    wrpbdy=wrp.appendChild(bdy.el.cloneNode(false));
                    Dom.css(wrp ,{l:1,w:0,position:"absolute",overflow:"hidden",borderTop:"none"})
                    wrp_hdr=wrp.insertBefore((hdr.el||hdr).cloneNode(false),wrpbdy)
                    wrp_hdr.style.borderTop="none";wrp_hdr.style.borderTop="#666"; wrp_hdr.style.left="1px";
                    wrp_hdr.style.top="-1px";    wrp_hdr.style.zIndex=ZINDEX.FREEZEOVERLAYHDR;
                    wrp_hdr.style.position="absolute";   wrp_hdr.style.display="block";

                    Dom.css(wrpbdy,{overflow:"hidden",padding:0,borderTop:"none",margin:0,position:"absolute",l:0,w:"100%",
                        zIndex:ZINDEX.FREEZEBODY});
                    for(var i=0;i<colcnt;i++){
                        wrp_hdr.appendChild(hdr.children[i].cloneNode(true));
                    }
                    wrphdrht=Number(String((headerclone||hdr).q(".grid-row").css("height")).replace(/[^\d\.]/g,""))
                    wrpbdy.style.height=gwrp.offsetHeight  +"px";wrpbdy.style.top=(wrphdrht+2)  +"px"
                    wrp_hdr.style.lineHeight= wrp_hdr.style.height  =wrphdrht+"px";
                    Dom.qq(wrp_hdr,".grid-header-cell,.grid-row").forEach(function(c){c.style.lineHeight= c.style.height= wrphdrht+"px";})
                }

                this.domcomponents.gridWrap.__onscroll||
                this.domcomponents.gridWrap.on("scroll",this.domcomponents.gridWrap.gridWrap.__onscroll=function(ev){
                    grid.fire("scroll",ev)
                });
                if(!refresh){
                    grid.on("scroll afterpageload aftercolresize", $.throttle(proc, {immediate:true,delay:10} ) );
                    grid.on("afterresize uireset", function(){if(_isactive){setup(0,true)} });


                }
                //wrp.onscroll=function(){setTimeout(cb,100)} ;
                proc()
                setTimeout(proc,10)  ; setTimeout(proc,50)
            }
            return {
                label:"Freeze Columns",
                optns:["number_of_Columns"],
                setup:function(){  return this;   },
                activate:function(num){
                    if(_isactive){return}
                    _isactive=1;
                    setTimeout(setup.bind(this),100,num)   ;
                    grid.on("render",function(){ if(_isactive){setup(0,true);setTimeout(proc,100);} })
                    return this;

                },
                remove:function(){
                    if(wrp && wrp.parentNode){wrp.parentNode.removeChild(wrp.el||wrp)}
                    _isactive=false;
                }
            };
        },
        /*gridMenu:function(g){
            var featurelist,link,popupvw,_isactive,grid= g,optns={};
            return {
                setup:function(){
                    if(g.buttonBar&&!g.buttonBar.q(".icon-cog")){
                    link= g.buttonBar.append("<button><a class='icon-cog'></a></button>")
                        .on("click",function(){this.activate()}.bind(this)).hide()
                    }
                    return this;
                },
                activate:function(val){
                    if(!popupvw){
                        var meta=grid.store.meta,collist=meta.getNames();
                        var plugins= DataGrid.plugins,list
                        plugins.nowrap||(plugins.nowrap=function(g){
                            var grid=g;
                            return {
                                setup:function(){grid.nowrap=this;
                                    this.activate()},
                                activate:function(){
                                grid.domcomponents.gridWrap.classList.add("nowrap")
                                grid.domcomponents.gridWrap.classList.remove("fitLayout")
                                grid.domcomponents.gridWrap.st(".grid-cell,.grid-header-cell").css({maxWidth:"-delete-",minWidth:"-delete-",width:"auto"})

                            },remove:function(){
                                grid.domcomponents.gridWrap.classList.remove("nowrap")
                                grid.domcomponents.gridWrap.classList.add("fitLayout")
                            },label:"No wrap"}
                        });
                        list=Object.keys( plugins).reduce(
                            function(m,k){var p=plugins[k](grid),l=p.label;
                                if(l){m.push({id:k,label:l,optns: p.optns})}return m;
                            },[]);
                        popupvw=View.popup({anchor:link,width:400,height:300, hideOnBlur:true,
                            panels:[ "columns","Sort","features"]

                        });
                        popupvw.addLayout("tab");
                        //
                         featurelist=View.lookupList({aspanel:true  , list:{list:list ,keyname:"id",
                                labelprovider:function(v){
                                    return ("<label style='position:relative;margin-left:30px;display:block' for='lookup_"+v.id+"'>" +
                                        "<input id='lookup_"+ v.id+"' value='"+v.id+"'"+(grid[v.id]?"checked='checked'":"")+" type='checkbox'/>"+( v.label)
                                        +
                                        (v.optns?"<div class='icon-arrow-down optn-expand' style='position:absolute;top:5px;right:2px;cursor:pointer:z-index:10'> </div>":"")
                                        +"</label>")}  }
                            },function(k,lbl){ var v=list.find(function(it){return it.id==k}),
                                ip=document.getElementById("lookup_"+ k)
                                if(v && v.optns){
                                    var nu,lbl,nu,ip=document.getElementById("lookup_"+ k)
                                    if(ip){lbl=ip.parentNode}
                                    if(lbl&&!(nu=lbl.nextElementSibling)){
                                        nu=$d.after(lbl,"<div style='line-height:2em'></div>")
                                    }
                                    nu=$d(nu);//nu.clear();
                                    if(!nu.q(".optnstext")){    var  _id=k;
                                        v.optns.map(function(k){
                                            nu.append("<label>"+String(k).replace(/^\w|_\w/g,function(a){return " "+a.split("").pop().toUpperCase()}).trim()+"<input class='optnstext' data-ref='"+k+"'data-name='"+k+"' style='width:60px;'/></label>")
                                            nu.q("input").el.onchange=function(evt){
                                                var el=this,ip=el.parentNode.parentNode.previousElementSibling.querySelector("input"),id=ip.value
                                                optns[id]=el.value;
                                                if(ip && plugins[id]){
                                                    if(ip.checked){
                                                        if(!grid[id]){grid[id]=plugins[id](grid)}
                                                        else{grid[id].remove && grid[id].remove()}
                                                        grid[id].activate(el.value)
                                                    }
                                                }}
                                        });
                                    }
                                }
                                ip.onchange=function(evt){
                                    var ip=this,id=ip.value
                                    if(plugins[id]){
                                        if(ip.checked){
                                            if(!grid[id]){grid[id]=plugins[id](grid);
                                                grid[id].setup( optns[id])
                                            }
                                            grid[id]&&grid[id].activate( optns[id])

                                        } else if(grid[id]) {grid[id].remove()}
                                    }
                                }


                            }
                        );


                        var curr=grid.cols.map(function(it){return it.name}),allcols=collist.map(function(it){return meta.findField(it)||{name:it,label:it}}),
                            list1={ keyname:"id",labelname:"label",list:allcols.map(function(it){return {id:it.name,label:(it.label=="-")||(it.label=="/")?it.name:it.label}})},
                            lbl=$.template(
                                $d.template(
                                    "label[style=d:b].col>input[type=checkbox][value=`id].chx+span{`label}"
                                ).render().html().replace(/`/g,"$"))
                        var columnlist=View.lookupList({aspanel:true ,list:list1,labelprovider:lbl})
                        var sortlist=View.lookupList({aspanel:true ,list:list1});
                        popupvw.columns.addLayout("frame");popupvw.columns.config.hideHeader=true ;
                        popupvw.columns.on("beforeshow",function(){this.contentWrap.qq("label.col .chx").forEach(function(it){it.checked=curr.indexOf(it.value)>=0})});
                        popupvw.columns.addButton("Apply","footer",function(){
                            var nu=this.contentWrap.qq("label.col .chx").filter(function(it){return !!it.checked}).map(function(it){return meta.findField(it.value)})
                            grid.cols.length=0;
                            [].push.apply(grid.cols,nu);
                            grid._renderer.render() ;
                        } )
                        popupvw.Sort.addLayout("frame");
                        popupvw.Sort.config.hideHeader=true;
                        popupvw.Sort.addButton("Apply","footer",function(){})

                        popupvw.columns.contentWrap.css("overflow","hidden")
                        popupvw.features.add(featurelist)
                        popupvw.columns.add( columnlist)
                        popupvw.Sort.add(sortlist)

                     }
                    popupvw.show()
                    popupvw.features.show();//
                    popupvw.el.st(".ui-button-bar").up().toFront();

                    // Popupvw.sort1.show();
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        },*/
        inlineEditor:function(g){
            g.config.ignoreupdate=true
            var config=g.config.inlineEditor;
            if(!$.isPlain(config)){config={}}
            var form= DataGrid.plugins.entityForm(g) ,_isactive,_menu=null,_ctx,wdspan,  _enabled=false, _model=null,_rowmodel
                ,_activeCell,
                _setTabidx=function(){
                     g.domcomponents.tab.st(".grid-rowset .grid-row .grid-cell .cell-content").prop("tabIndex",function(tabidx){return ++tabidx.i},{i:0})
                },

                    _save=function( ){ var cx=_rowmodel
                         if(cx&& cx.record&&cx.id){
                             if(config.onrowblur){
                                 config.onrowblur.call(g,_rowmodel,_activeCell,"save")
                             }
                             _cancel(false)
                                 g.showStateMsg("saving..")
                                var rec=cx.record,del=g.store.stats.deleted;
                                 rec.save().then(function(){
                                    this.showStateMsg("saved..").showStateMsg("",1000)
                                     rec.resetStatus( )
                                     _rowmodel&&_rowmodel.el&&_rowmodel.el.st(".edit-modified").removeClass("edit-modified")
                                 }.bind(g),
                                     function(msg){var m=((msg&&msg.error)?msg.error:msg);
                                         if(m){m="<span style='color:red'>"+m+"</span>"}
                                         this.showStateMsg(m||"error").showStateMsg("",1500)
                                     }.bind(g)
                                 )
                        }
                 } ,
                _cancel=function(norestore ){
                           if(_activeCell&&_activeCell.el) {
                              _activeCell.el.removeClass("edit-active")

                                if(!norestore ){
                                      if(_rowmodel&&_rowmodel.datamodel){
                                         _rowmodel.datamodel[_activeCell.name]=_activeCell.content.val()
                                          _activeCell.content.addClass("edit-modified")
                                      }

                             }

                            _activeCell.content.contentEditable = false;
                        }
                 } ,
                _delete=function(el,ev){  var cx=_rowmodel
                    if(cx&& cx.record&&cx.id){
                        g.store.provider.delete(cx.record).then(function(){
                            this.showStateMsg("deleted..").showStateMsg("",1000)
                                if(_menu){_menu.hide()}
                         }.bind(g)
                        );
                        if(config.onrowblur){
                            config.onrowblur.call(g,_rowmodel,_activeCell,"delete")
                        }
                        _cancel(true); _activeCell=null
                    }
                } ,

                _positionMenu=function(){
                    var cx=_rowmodel
                     if(_menu&&cx){
                         var b=cx.el.q(".cell-content").getBoundingClientRect(),offset=_menu.parent().getBoundingClientRect(),scroll=g.domcomponents.gridWrap.scrollTop;

                         var top=0
                         if(b.top > offset.top){top=((b.top-offset.top) ) }
                         if(b.top < offset.top|| (b.top+ b.height/2)>offset.bottom){
                             _menu.hide();
                         }
                         else{
                             _menu.css({top:top + b.height ,l: (b.right-offset.left)}).show()
                         }

                    }

                },
                _changeRow=function(nu){
                    if(_rowmodel&&_rowmodel===nu){return}
                    if(_rowmodel&&_rowmodel.el){
                        $d.removeClass(_rowmodel.el,"edit-active-row")
                    }
                    var old=_rowmodel;

                    _rowmodel=nu;
                     if(!_rowmodel.datamodel&&_rowmodel.record) {
                             _rowmodel.datamodel = _rowmodel.record//.makeModel(false,true);
                             //_rowmodel.el.data("_model", _rowmodel.datamodel)
                      }
                    if(config.onrowblur){
                        config.onrowblur.call(g,old)
                    }
                    if(config.onrowfocus){
                        config.onrowfocus.call(g,old,_rowmodel)
                    }
                    $d.addClass(_rowmodel.el,"edit-active-row")
                    setTimeout(_positionMenu,10)
            },
                _activate=function(celctx){
                    if(!_enabled||!_rowmodel){return}
                    var curr=_activeCell=cx,cx= celctx,el=celctx.el

                     if(cx&&cx.el&&!cx.el.hasClass("edit-active")){
                        _cancel(true )

                        _activeCell=cx
                        if(!cx.meta){return}
                             el.addClass("edit-active")
                            _rowmodel.el.addClass("edit-active-row")
                            $d.domdata(cx.el,"currval",$d.val(cx.content))
                             var m=_rowmodel.datamodel
                            if(!m ){
                              return
                            }
                            var inst=cx.meta.getUIInstance( )
                             inst.ip=cx.content
                            inst.build({model :m})
                            inst.setValue=cx.render.bind(cx)
                            cx.model=m
                            _ctx=cx
                            if(!inst.hasLookup ){
                                cx.content.contentEditable=true;
                                cx.content.on("blur.inline",function(ev){
                                    if(_rowmodel&&_rowmodel.el&&_rowmodel.el.contains(ev.target)){
                                        var cell=$d.selfOrUp(ev.target,".grid-cell")
                                        if(cell){
                                            var name=$d.domdata(cell,"name")
                                            if(name){
                                                _rowmodel.datamodel[name]=$d.text(ev.target)
                                            }
                                        }
                                    }
                                    _cancel(false );
                                    _activeCell=null
                                });
                             } else{
                                setTimeout(function(){inst.ip.trigger("mousedown")},10);
                            }
                         if(config.onrowblur){
                             config.onrowblur.call(g,_rowmodel,_activeCell)
                         }
                          setTimeout(_positionMenu,10)

                    }
                }

            return {   label:"Inline Cell Editor",
                setup:function(){   _setTabidx()
                    if(!_menu){
                        _menu=$d.template("div.inline-editor-menu.ui-button-group.fxtx_5[abs;opacity:.9;height:20;width:200;]>" +
                            "span.ui-button.small.green[-key:save;display:inline-block;]{Save}+" +
                            "span.ui-button.small.danger[-key:del;display:inline-block;]{Delete}" +""
                            //"span.ui-button.small.danger[-key:cancel;display:inline-block;]{Cancel}"
                        ).render().appendTo(g.domcomponents.gridWrap).q(".inline-editor-menu")
                        _menu.on("click",function(ev,el){var k=el.domdata("key")
                            if(k=="save"){_save()}
                            else if(k=="cancel"){_cancel(true);_activeCell=null}
                            else if(k=="del"){_delete();}

                        },"span")
                        _menu.hide()
                        _enabled=true;
                        g.on("viewupdate",_cancel);
                        g.on("afterrender",_setTabidx)
                        g.on("rowselected.inlineeditor",function(ev){
                            _changeRow(ev)
                        })
                        g.domcomponents.rowset.on("mousedown",function(ev,el){
                            var nur=g.getRow($d.selfOrUp(el,".grid-row"));
                            if(nur){
                                _changeRow(nur)
                                var celctx=nur.getCell(el)
                                celctx&&_activate(celctx)
                            }
                         },".grid-cell")
                        g.domcomponents.gridWrap.on("scroll",_positionMenu)

                    }
                    return this;
                },
                activate:function(){
                    form.activate();
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        },
        popupEditor:function(g){
            var form= DataGrid.plugins.entityForm(g) ,_isactive
            return {   label:"Popup Editor",
                setup:function(){
                    form.setup();
                    return this;
                },
                activate:function(){
                    form.activate();
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        },
        entityForm:function(g){
            var grid= g,formView,_rowActions=[],_isactive,_buttons={edit:null,add:null},
                _formInst=null,spec=g.config.entityForm ||{},_temmplateformInst={},
                _formClass=null,
                _panel=spec.panel,isDialog;
            if(g.data("entityForm")){return}
             g.data("entityForm",1)
             function newForm(){editForm()}
            function setupForm(rec,callback){


                if(callback===true){callback=editForm}
                callback=typeof(callback)=="function"?callback:function(){}
                if(spec.setUp){
                    _formInst=spec.setUp(g,rec)
                    formView=_formInst._view
                    callback(rec,_formInst)
                } else {
                    var template = spec.template, vw = formView, store = grid.store;
                    var currentrec = rec ? rec.clone() : g.store.StoreRecordProto.constructor.newInstance()
                    if (typeof(spec.template) == "function") {
                        template = spec.template(rec)
                    }
                    _formInst = _temmplateformInst[template || "_default"]
                    if (!vw) {
                        vw = _panel || g.config.formPanel || spec.panel
                        if (!vw) {
                            var PopupView = $.require("PopupView")
                            vw = new PopupView({
                                resizable: true,
                                centered: true,
                                title: $.titleize(spec.title || g.store.meta.name || ""),
                                height: spec.height || 400,
                                width: spec.width || 500
                            })//,layouts:"panel",footer:{height:40}})
                            isDialog = true
                            vw.observer.on("beforehide", function (el) {
                                if (el && $d.selfOrUp(el, ".popup-view")) {
                                    return false;
                                }

                            })
                        }
                        ;

                    }
					if(vw){formView = vw}
                }
               // if(vw.hasLayout("popup")){isDialog=true}
                formView && formView.show();
                if(!_formInst){
                    $.require("UI.Form",function(f){
                        currentrec.clear()
                             var opts={meta:store.meta,layoutTemplate:template,dataRecord:currentrec,panel:formView}
                        var props=f.classMeta.defaultProperties
                        $.each(spec,function(v,k){
                            if(k in props&&typeof(v)!=="undefined"){
                                opts[k]=v
                            }
                        })
                        opts.panel=opts.panel||formView
                          _formInst=f(opts);
                            _temmplateformInst[template||"_default"]=_formInst
                        _formInst.panel=vw
                          if(spec.oncreate){
                              spec.oncreate(_formInst)
                          }
                         vw.form=_formInst    ;
                             vw.contentWrap.clear();
                        _formInst.appendTo(vw.contentWrap)
                            .on("update",function(data){   });
                        _formInst.dataHandle={store:store}
                        _formInst.dataRecord.reset();
                        if(!spec.nobuttons) {
                            vw.addButton({
                                name: "Save",
                                location: spec.barlocation || (isDialog ? "footer" : "header"),
                                align: "center",
                                callback: function () {
                                    _formInst.save().then(function () {
                                        if (isDialog) {
                                            vw.hide()
                                        }
                                        g.pager.loadPage()
                                        g.fire("save", currentrec)
                                    })
                                }
                            });
                            vw.addButton({
                                name: "Cancel",
                                location: spec.barlocation || (isDialog ? "footer" : "header"),
                                align: "center",
                                callback: function () {
                                    vw.hide()
                                    g.fire("formcancel")
                                }
                            });
                            vw.layout();
                        }

                        g.fire("entityform",_formInst)
                        if(_formInst&&rec){_formInst.reset(rec.toMap())}
                             setTimeout( callback,0,rec,_formInst)
                        })
                } else {
                    _formInst.reset(rec?rec.toMap():null)
                    callback(rec,_formInst)
                }
            }
            function editForm(rec,fi){
                var vw= formView,store=grid.store,editmode=rec?"edit":"new" ;
                vw.record=rec||"null"
                vw.show();
                if(fi){
                    fi.editmode=editmode
                    fi.dataRecord =rec
                    rec && fi.reset(rec.toMap())
                } else{
                    setupForm(rec,function(rec,formInst){
                        if(formInst){
                            formInst.editmode=editmode
                            formInst.dataRecord=rec
                            rec && formInst.reset(rec.toMap())
                   // _formInst.reset((rec && rec.id)?rec.toMap():null)
                } else{ }

                    })
                }
                vw.setTitle&&vw.setTitle(
                    ($.titleize(spec.title||store.meta.name) +": "+(rec?rec.lbl:"")||"").replace(/undefined/,"")
                )


            }
            function _addLinks(config ){
                var links=(config||{}).links||[ "refresh","sep","addrow","edit","del","sep","settings"],opts=grid.config.editoptions||{}
                if(!spec.readonly){
                    if(opts.add!=null && !opts.add && links.indexOf("addrow")>=0){links.splice(links.indexOf("addrow"),1)}
                    if(opts.edit!=null && !opts.edit && links.indexOf("edit")>=0){links.splice(links.indexOf("edit"),1)}
                     if(opts.export){
                        opts.export= $.isPlain(opts.export)?opts.export:{}
                         opts.export.text=opts.export.text||"Export"
                        links.push( "export" )
                    }
                    if(opts.del!=null && !opts.del && links.indexOf("del")>=0){links.splice(links.indexOf("del"),1)}
                    if(!grid.domcomponents.toolbar.q("[data-cmd='edit']")) {
                        grid.iconBar=DataGrid.IconBar(grid,{floatable:true})
                        links.forEach(function(a){
                            grid.iconBar.add(a,opts[a])
                        })
                        grid.iconBar.getBar().prepend("<span class='ui-toolbar-status-message'></span>")
                        grid.iconBar.appendTo(grid.domcomponents.toolbar)

                        /*grid.domcomponents.toolbar.append ("<span class='ui-toolbar-status-message'></span>"+
                            links.map(function(a){return "<span data-cmd='$key' title='$key' class='ui-button-gl gl-icon-$key'></span>".replace(/\$key/g,a)}).join("")
                        )*/
                    }
 /*
                     if(!_buttons.add){
                        _buttons.add=grid.addButton({name:"Add",location:"header",callback:setupForm.bind(null,null,editForm )} );
                    }
                    if(!_buttons.edit){
                        _buttons.edit=grid.addButton({
                            name:"Edit", location:"header", callback:function(){
                                this.selectedRecord && this.selectedRecord.id && setupForm(this.selectedRecord,editForm);
                            }
                        });
                        _rowActions.push(_buttons.edit)
                    }
                    if(!_buttons.del){
                        _buttons.del=grid.addButton({
                            name:"Remove", location:"header", callback:function(){
                                this.selectedRecord && this.selectedRecord.id && this.store.provider[ "delete"](this.selectedRecord.id);
                            }
                        });
                        _rowActions.push(_buttons.del)
                    }*/
                    }
                return this
                }
            function _setup( ){
                if(grid.data("_formbutons")){return}

                if(spec.buttons){
                    $.each(spec.buttons,function(v,k){
                        var nm=typeof(k)=="string"?k:v.name
                        if(nm&&!_buttons[nm]&&v.callback){
                            _buttons[nm]=grid.addButton({name: v.label||nm,location:"header", klass: v.klass,style: v.style,callback: v.callback.bind(g,editForm )} );
                            if(v.rowaction){
                                _rowActions.push(_buttons[nm])
                            }
                        }
                    })
                }
                //if(!_buttons.add){setTimeout(_setup,500)}
                //else{

                    grid.on("viewupdate",function(pager){
                        _rowActions.forEach(
                            function(v,k){v.disable()}
                        );
                     });
                    grid.on("rowselected",function(r){
                        _rowActions.forEach(
                            function(v,k){v.enable()}
                        );
                    });
                grid.on("colselected",function(r){

                });
                grid.data("_formbutons",1)
                 if(grid.domcomponents.frameheader.q(".ui-button")){
                        return
                }
                if(grid.buttonBar){$d.toFront(grid.buttonBar)}


            }
            return {   label:"  Editor",
                getFormInst:function(){return _formInst},
                setPanel:function(p){_panel=p;return this},
                getPanel:function(){return formView||_panel},
                setupForm:setupForm,
                setup:function(){
                    this.activate();

                    grid.on("afterrender.grid",_setup)
                     return this;
                },
                activate:function( ){
                    _setup.call(this )    ;
                    return this;

                },
                addLinks:_addLinks,
                remove:function(){_isactive=false;}
            };
        } ,
        groupView: function(grid){
            return {
                label   :"Group View",
                setup   :function(){

                },
                activate:function(){

                },
                clear   :function(){

                }
            }
        },
        facetView: function(grid){
            var _isactive= 0,facetcols;
            return {   label:"Facet View",
                setup:function(){
                    this.activate();
                    return this;
                },
                activate:function(){
                    if(_isactive){return}
                    _isactive=1;
                    facetcols||(facetcols=grid.store.meta.findAll(function(it){return it.name!="id"}));
                    var facetList=new View("facetList","accordion",{width:200,location:"left"}),recs=grid.store.records
                    var facetPanels=facetcols.map(function(it){var nm=it.name;
                        var ll=recs.pluck(it.name).collect(function(it){ return it.format?it.format():String(it)}).uniq().sort();
                        var PopupView= $.require("PopupView")
                        return PopupView.lookupList(ll, {
                            id: it.name, label: it.label, aspanel: true, callback: function (rec) {
                                if (rec && rec.row && rec.row.classList) {
                                    if (rec.row.classList.contains("selected")) {
                                        rec.row.classList.remove("selected");
                                    } else {
                                        rec.row.classList.add("selected")
                                    }

                                    var fltr = [].map.call(facetList.contentWrap.querySelectorAll(".listbox-container"), function (f) {
                                        return [].map.call(f.querySelectorAll(".selected"), function (r) {
                                            return "it." + nm + " = '" + r.dataset.key + "'"
                                        }).join(" or ")
                                    }).filter(function (it) {
                                        return it.trim()
                                    }).join(") and (");
                                    fltr = "(" + fltr + ")"

                                    grid.pager.update({filter: fltr});
                                    grid._renderer.redraw(true)
                                }
                            }.bind(it)
                        }
                        ) });

                    facetPanels.forEach(function(it){facetList.add(it)});
                    if(grid.panel._parent){
                        var vw=grid.panel._parent;
                        grid.panel.config.location="center"
                        vw.add(facetList); grid.panel.removeLayout("fill");
                        vw.addLayout("border");
                        vw.layout();
                    }
                    return this;

                },
                remove:function(){_isactive=false;}
            };
        }
    }

    DataGrid.generateTemplate=function(config){
        var cols=config.cols||[],rowname=config.rowname||"row"

        var hdrs=[],names=[],cellklass=((config.cellklass||"")+" grid-cell").trim();
        cols.forEach(function(a){if(!a){return}
            var name=typeof(a)=="string"?a: a.name,lbl=a.label|| $.titleize(name||"")
            if(!name){return}
            hdrs.push("<th  class='grid-header-cell'>"+lbl+"</th>")
            names.push("<td class='"+cellklass+"'>$"+name+"</td>")
        })
        var tmplate="<div class='gridtable viewmode-table'><table class='grid-tab'><thead class='grid-header'><tr class='grid-row'>"+hdrs.join("")+"</tr></thead><tbody class='grid-rowset'>$each("+rowname+"){<tr class='grid-row' data-id='$id'>"+names.join("")+"</tr>}</tbody></table></div>"
         return $.template(tmplate)
    }
if(typeof(View)!="undefined"){
    View.DataGrid=DataGrid
}
    DataGrid.IconBar=function(view,opts){
        if(!opts&& $.isPlain(view)){opts=view;view=null}
        var _bar=null,els={},_lastel=null,options= $.extend({floatable:false,controller:null,style:null,listener:null,template:null,basclass:"ui-button-gl"},opts||{})
        if(typeof(options.listener)!=="function"){options.listener=null}

        if(options.controller&&typeof(options.controller.invoke)!=="function"){options.controller=null}
        if(!options.controller&&view && view.getController ){
            options.controller=view.getController();
        }


        var api={
            getBar:function(){
                if(!_bar){
                    _bar=$d("<div/>").css({ w:"auto" ,overflow:"hidden",paddingBottom: "2px"})
                    _lastel=_bar.append('<span class="ui-button-gl ignore-link1 edge-handle"></span>')
                    if(options.style){_bar.css(options.style)}

                    _bar.on("mousedown",function(ev){
                        ev.stopPropagation&&ev.stopPropagation()
                        var memo={b:_bar.bounds()}
                        if(_bar.parent().el!=document.body||!_bar.data("_origparent")){
                            var bp=UI.Rect.from(memo.b ,true),bp2=_bar.parent().bounds() ;
                            bp.left=Math.min(bp2.left,bp.left-15)
                            bp.top=Math.min(bp2.top,bp.top-15)
                            bp.right=Math.max(bp2.right,bp.right+15)
                            bp.bottom=Math.max(bp2.bottom,bp.bottom+15)

                            _bar.data("_origparent",_bar.parent().id)
                            _bar.data("_origbounds", bp)
                            _bar.data("_orignext",( _bar.next()||{}).id)
                            _bar=_bar.appendTo(document.body)
                            _bar.addClass("layout-floating")
                            _bar.css({top:  memo.b.top,left:  memo.b.left,h:  memo.b.height,width: memo.b.width,position:"fixed"}).toFront(true)
                        }

                        $d.trackMouse({
                            target:_bar,
                            memo:memo ,
                            start:function(ev,memo){memo.point=UI.Point.from(true,memo.b.left,memo.b.top)  },
                            move:function(ev,memo){
                                memo.point.save().plus(ev.delta).applyCss(_bar.el).restore();
                            },end:function(ev,memo){memo.b.refresh()
                                var origpar=$d(_bar.data("_origparent"))
                                if(origpar && !_bar.parent().is(origpar)){
                                    var  bp=_bar.data("_origbounds")
                                    if(bp&&bp.contains(memo.b )) {
                                        var _orignext=$d(_bar.data("_orignext"))
                                        if(_orignext&&_orignext.parent().is(origpar)){_bar=_orignext.before(_bar)}
                                        else{_bar=origpar.append(_bar)}
                                        _bar.data("_origparent",null)
                                        if(!origpar.isAnimating()){origpar.highlight();}
                                        _bar.removeClass("layout-floating")
                                    } else{
                                        _bar.addClass("layout-floating")
                                    }

                                }
                            }

                        })
                    },".gl-icon-draghandle")
                    _bar.pointerselect(function(ev){
                        if(ev&&ev.target&&$d.is(ev.target,".ui-button-gl")){
                            var nm=ev.target.dataset.cmd
                            if(nm==="sep"||nm==="text"||ev.target.classList.contains("disabled") ||ev.target.classList.contains("ignore-link1")){return}
                            var el=els[nm];
                            if(el){
                                if(options.listener){
                                    options.listener(nm,ev)
                                }
                                if(options.controller){
                                    options.controller.invoke(nm,[ev])
                                }
                                if(el.callback){
                                    el.callback(ev)
                                }
                            }
                        }
                    })
                    if(options.floatable){
                        _lastel.addClass("gl-icon-draghandle")
                    } else{
                        _lastel.addClass("gl-icon-blank")
                    }
                }
                return _bar
            },
            getLink:function(nm){
                if(typeof(nm)=="string"){
                    return els[nm]
                } else if(typeof(nm)=="number"){
                    //
                }
            },
            addText:function(txt,pos){this.add("text",{text:txt,pos:pos});return this},
            addSep:function(txt){this.add("sep");return this},
            add:function(nm,detail,pos){

                if(Array.isArray(nm)){
                    nm.forEach(function(k){this.add(k)},this)
                    return this;
                }
                var data={}
                if($.isPlain(detail)){data=detail}
                else if(typeof(detail)=="function"){data.callback=detail}
                else if(typeof(detail)=="string"){data.text=detail}
                else if(typeof(detail)=="number"){data.pos=detail}
                if(typeof(pos)=="number"){data.pos=pos}
                if(nm.indexOf("text")==0){data.key=data.key||nm;nm="textwrap"}
                if(nm.indexOf("sep")==0&&nm!="sep"){data.key=data.key||nm;nm="sep"}
                data.key=data.key||nm

                if(nm!="sep" && nm!="textwrap" &&els[data.key]){return els[data.key]}
                if(data.pos=="top"){data.pos=0}
                var klas="gl-icon-"+nm
                if(!options.template){
                    var dom=$d("<span class='ui-button-gl'></span>")
                    options.template=dom.el.cloneNode(true)
                    dom.remove();
                }
                var bar=this.getBar()

                var nu
                if(nm=="text"){
                    nu=$d("<span/>")
                    if(data.text){
                        nu.text(data.text)
                    }
                }
                else {
                    nu = options.template.cloneNode(true)
                }
                nu.dataset.cmd = data.key
                var before=_lastel
                if(typeof(data.pos)=="number"){
                    if(data.pos==0){before=bar.down()}
                    else {
                        before=bar.down(data.pos)
                    }
                } else if(typeof(data.pos)=="string") {
                    if (els[data.pos]) {
                        before = els[data.pos].el
                    }
                }
                before=before||_lastel
                nu=before.before(nu)
                nu.addClass(klas)
                if(data.klass||data.className){
                    nu.addClass(data.klass||data.className)
                }
                var wdgt={el: nu, name: nm}
                if(nm!="sep" && nm!="textwrap") {
                    if (typeof(data.callback) == "function") {
                        wdgt.callback = data.callback
                    }
                    els[nm]=wdgt
                } else{
                    nu.addClass("disabled")
                }
                if(data.text){
                    nu.html(data.text).css({width: "auto"})
                }
                return wdgt

            },
            enable:function(nm){
                [].concat(nm||[]).forEach(
                    function(k){
                        if(els[k]){
                            els[k].el.removeClass("disabled")
                        }
                    }
                )
                return this;
            },
            disable:function(nm){
                [].concat(nm||[]).forEach(
                    function(k){
                        if(els[k]){
                            els[k].el.addClass("disabled")
                        }
                    }
                )
                return this;
            },
            setConfig:function(nm,val){
                options[nm]=val;
            },
            appendTo:function(dom){
                _bar=$d(dom).append(this.getBar())

                return this;
            }

        }
        return api;
    }

module.exports=DataGrid
}
__bootstrap__.modules["UI.Form"] = function(module){
self.UI||(self.UI={});

var UIField = $.createClass(function(columnModel,specs){
    this.columnModel=columnModel;

    var ui=columnModel.ui||(columnModel.ui={});
    specs=$.extend({ip: null,  wrapel: null,    val: null,      hidden: null,  listvw: null,labelel: null,labelstyle:null,   valueWrap: null,
        renderer:null,
        defaultproperty: "val",   wrapstyle: null,    wrapklass: null,   wasvalid: null,  inline: null },specs||{});
    if(specs){
        var modelupdates={}
        $.each(specs,function(v,k){
            if(ui && (k in ui)){
                if(ui.setUI){ui.setUI(k,v);}
                else{ui[k]=v;}
            } else if(k=="ui" ){
                if($.isPlain(v)){
                    if($.isPlain(ui)){
                        $.extend(ui,v);
                    } else if(ui.setUI){
                        $.each(v,function(v,k){
                            ui.setUI(k,v);
                        })
                    }
                }
            } else {
                if(v==null && columnModel[k]!=null) {

                } else{
                    modelupdates[k] = v;
                }
            }
        });
        columnModel.update(modelupdates);
    }
    $.delegateTo(this,"columnModel");
},{

    resetState: function() {},
    buildFragment: function() {
        this.fieldTemplate || (this.fieldTemplate = $.require("UI.Form").defaultFieldTemplate);
        var a = this.fieldTemplate(this);
        if(a && a.nodeType==11){a= a.firstChild}
        var wrapel=this.columnModel.wrapel = $d(a);
        this.labelel = wrapel.q(".ui-ip-label");
        this.ip = wrapel.q("input,textarea,select");
        $.emitter.augment(this)
        return this
    },
    sync: function() {},
    getRenderer:function(  ){
        var models= $.require("UI.Form").models||{}
        var specs=this.columnModel||{}
        var renderer = specs.renderer||models[specs.fieldrenderer||"--"]||models[specs.type] || models[specs.iptype] || models[specs.name] ;
        if (!renderer) {
            if (!renderer && ("time" == specs.type || "time" == specs.actualtype)) {
                for (var o = [], p = 0, q = $.date().format("mm/dd/yyyy"); 24 > p;) {
                    for (var r = 0; 4 > r; r++) {
                        var s = (0 == p || 12 == p ? 12 : (12 + p) % 12) + ":" + (15 * r || "00") + (p >= 12 ? " pm" : " am");
                        o.push({
                            id: +new Date(q + " " + s),
                            label: s
                        })
                    }
                    p++
                }
                specs.list = o
             }
            var iptype = (specs.ui || {}).iptype || "text";
            if(!renderer && (specs.hasLookup||specs.list)){
                renderer= models.datalist
            }
            if(!renderer && ("checkbox" == iptype || "bool" == iptype || "bool" == specs.type || "boolean" == specs.type || "tinyint" == specs.actualtype)) {
                renderer = models["boolean"]
            }
            if(!renderer && ("img" == specs.type || "img" == iptype) ){
                renderer= models.img
            }

        }
        if("function" == typeof renderer){
            renderer = { render: renderer }
        }
        return renderer;

    },
    applyFieldUI: function(  ) {
        var columnModel=this.columnModel||{}
        var wrapel = columnModel.wrapel = columnModel.wrapel || columnModel.ip;
        var ip = columnModel.ip;
        if(ip){
            var iptype=columnModel.iptype||columnModel.ui.iptype
             iptype && !columnModel.renderer && (ip.type =  iptype);
            ("id" == columnModel.name || columnModel.hidden) && (ip.type = "hidden", columnModel.wrapel.hide());
            "email" == columnModel.name && "text" == ip.type && (ip.type = "email") ;
            var width=columnModel.width||columnModel.ui.width
            columnModel.ui.width && (ip.style.width =  width + "px")
            var height=columnModel.height||columnModel.ui.height
            columnModel.ui.height && (ip.style.height =  height + "px")
            var style=columnModel.style||columnModel.ui.style
            style && $d.css(ip,  style)
            var klass=columnModel.klass||columnModel.ui.klass
            $d.addClass(ip,  klass || [])
            $d.prop(ip, columnModel.ui.attr || {})
            columnModel.hasLookup && !columnModel.readonly && "search" != ip.type && !/SELECT/i.test(ip.tagName) && $d.up(ip).addClass("glyph-ddn");
            columnModel.typeInfo && columnModel.typeInfo.isDate() && $d(ip).after("Z!div.gl-icon-cfndar[marginLeft:-20]");
            var nolabel=columnModel.nolabel||columnModel.ui.nolabel
            nolabel && wrapel.addClass("nolabel")
            var labeltop=columnModel.labeltop||columnModel.ui.labeltop
            labeltop && wrapel.addClass("label-top")
            var block=columnModel.block||columnModel.ui.block
             block && wrapel.css("display", "block")
            columnModel.hidden && columnModel.wrapel && $d.hide(columnModel.wrapel);
        }

        var labelwidth = columnModel.ui.labelwidth||columnModel.labelwidth;
        if (labelwidth) {
            var D =  wrapel.q(".ui-ip-label");
            D && (D.style.width = labelwidth + ("auto" == labelwidth ? "" : "px"))
        }
        var labelstyle = columnModel.labelstyle|| columnModel.ui.labelstyle;
        if(labelstyle){
            var D =  wrapel.q(".ui-ip-label");
            D && D.css(labelstyle)
        }
        var wrapklass = columnModel.wrapklass || columnModel.ui.wrapklass;
        wrapel && wrapklass && String(wrapklass).split(/[\s,]/).forEach(function(a) {
            wrapel.classList.add(a)
        });
        var wrapstyle = columnModel.wrapstyle|| columnModel.ui.wrapstyle;
        if(wrapstyle){
            $d.css(columnModel.wrapel || $d.parent(columnModel.ip), wrapstyle);
        }

         ip && $d.on( ip, "click", function() {
            this.fire("selection")
        }.bind(this));

        if(!columnModel.inline && columnModel.wrapel){
            //j.wrapel.addClass("field-wrap-inline")
        }
        return this
    },
    attachField: function(  form,dom) {
        var columnModel=this
         try {
             this.render({
                model: form.model,
                panel: form.panel,
                meta: form.meta
            })
        } catch (z) {
            console.error(z)
        }
        var wrapel = columnModel.wrapel,name=columnModel.name
        if ((!dom || ! dom.q("input[name='" + name + "'],select[name='" + name + "'],textarea[name='" + name + "']")) && form.formDom) {
            var A = form.formDom.q(".field-wrap2[data-key='" + name + "']") || form.formDom.q(".field-wrap[data-key='" + name + "']");
            if(A){
                if( columnModel.wrapel && A){
                    if(columnModel.wrapel != A) {
                        columnModel.wrapel = A.append(columnModel.wrapel)
                    }
                } else{
                    columnModel.wrapel=A
                }
            } else{
                if(columnModel.wrapel){
                    columnModel.wrapel= form.formDom.append(columnModel.wrapel)
                }

            }
        }
    },
    build: function(form ) {
        var columnModel=this.columnModel||{}
        $.delegateTo(this,"columnModel");
        var name = columnModel.name ;
        form=form||{}
        if (!(!name || columnModel.hidden || (columnModel.ui && columnModel.ui.hidden))) {
            var  dom= form.formDom ? form.formDom.q(".field-wrap2[data-key='" + name + "']") : null
             if (!form.layoutTemplate ||  dom) {
                if (form.model ){
                    form.model.hasProperty(name) || form.model.addProperty(name, {
                        type: columnModel.typeInfo
                    });
                    form.model.onchange(name, function(a) {
                        this.setValue(a.value, a.valueLabel)
                    }.bind(this))

                    if("combo" == columnModel.iptype || "combo" == columnModel.ui.iptype) {
                        columnModel.ui.combo = !0
                        columnModel.ui.iptype = "search"
                    };
                }


                columnModel.renderer=this.getRenderer(   );
                this.attachField( form,dom);
                this.applyFieldUI(  )
            }
        }
    },
    render: function(a) {
         this.ip || this.buildFragment()
        var renderer=this.renderer||this.columnModel.renderer
        if(renderer){
            renderer.init && renderer.init(this.ip, a);
            renderer.render && renderer.render(this, a)
        }

        this.applyUI()
         return this
    },
    applyUI: function() {},
    onchange: function(a) {
        return this.on("change", a)
    },
    oninput: function(a) {
        return this.on("input", a)
    },
    isModified: function() {},
    applyFormat: function(a) {
        var b = a;
        if(this.type=="date" && typeof(this.format)=="string"){
            return $.date.format(a,this.format);
        }
        return this.format && "function" == typeof(this.format.fn || this.format) && (this.hasLookup && (this.getLookupValueMap(), this._lookupmap && this._lookupmap[String(b)] && (b = this._lookupmap[String(b)])), b = (this.format.fn || this.format)(b)), b
    },
    setValue: function(a, b) {
        var c = this.validate(a);
        if (null !== c && c != this.valueOf() && this.ip  && this.ip.dataset.val != c) {
            if (this.ip.dataset.val = c, b && b != c) c = this.applyFormat(b);
            else if (!this.ip.is("input,select,textarea") || "text" == this.ip.el.type || "search" == this.ip.el.type) {
                var d;
                if (this.format && (d = this.applyFormat(c), c == d ? d = null : c = d), !d)
                    if (this.hasLookup) {

                        var e = c;
                        this.getLookupValueMap(), this.typeInfo && this.typeInfo.isDate() && (e = +this.typeInfo.coerce(c)), e = e || c, this._lookupmap && this._lookupmap[e || c] ? c = this._lookupmap[e] : this.getLookupValue(e).then(function(a) {
                            var b = a || c;

                            this.ip.val(b)
                        }.bind(this))
                    } else {
                        c = this.typeInfo.format(c);
                    }
                "date" == this.ip.el.type && "valueAsDate" in this.ip.el ? (this.ip.el.valueAsDate = new Date(c), c = null) : c = null == d ? c : d
            }

            return (null == c || "null" == a || "0" == String(c)) && (c = ""), this.ip.val(c), this
        }
    }
});
    var fieldtemplate="<label class='field-wrap' data-key=$name' for='$name'>" +
            "<span class='ui-ip-label'>$label</span>" +
            "<span class='ipwrap'>" +
                "$iff (iptype is  select ){<select name='$name' style='$ipstyle' class='ui-ip' placeholder='$placeholder'><option> $placeholder </option></select>} " +
                "$else{<input type='$iptype' name='$name' style='$ipstyle' class='ui-ip'  placeholder='$placeholder'/>}" +
            "</span>" +
        "</label>",


        parsedtemplate,parsedtemplate_multiline
var _worker
    var _tmplt=function(field,multiline){
        //if(!parsedtemplate){parsedtemplate=$d.template(fieldtemplate)}
         var t=parsedtemplate||(parsedtemplate=$.template(fieldtemplate)),model=field.columnModel||field
        if(multiline===true){
            t=parsedtemplate_multiline||(parsedtemplate_multiline=$d.template(fieldtemplate.replace(/input/,"textarea")))
        }
        var name=model.name,label=model.label||titleize(name),iptype=model.hasLookup?"select":(model.iptype||"text"),ipstyle="",placeholder=String(model.placeholder||titleize(label)||"").trim()
        if(model.label =="_"||model.label =="-"){label =""}
        if(!_worker){
            _worker=document.createElement("div")
        }
        _worker.innerHTML=t({name:name,label:label,iptype:iptype,ipstyle:ipstyle,placeholder:placeholder}).trim();
        var el=_worker.removeChild(_worker.firstElementChild)
        //var el1=document.
        if(!label ){$d.addClass(el,"nolabel")}
        return el
     },
        titleize=function(s){ if(!s || s.length<3){return s}
         return String(s).replace(/[_\.]/g," ").replace(/([A-Z])/g," $1").replace(/([a-z])name/g,"$1 Name").replace(/^[a-z]/g,function(a){return a.toUpperCase()}).trim()
    }

    function _addValidation(fldmodel){

    }
     function _parseTemplate(tmpl,meta){
         var tp="z"
         if(typeof(tmpl)!="string"){return}
         tmpl=tmpl.trim().replace(/[\r]/g,"").trim()

         if(/^[\.]+\n/.test(tmpl)){
             var arr=[],widths=[],rows,cols=0,cellwd
                 tmpl=String(tmpl).replace(/\{\{([\w:]+)\}\}/gm,function(a,b){widths.push(1);return "!"+arr.push(b)+"!`"})
                 rows=String(tmpl).replace(/[\r]/mg,"").split(/\n|\[NL\]/gm).map(function(it){return it.trim()}).filter(function(it){return it.trim()})
                 if(/^[\.\s]+$/.test(rows[0])){
                     cols=rows[0].split(/\s*\.\s*/).length-1;rows.shift()
                 }
                 cellwd=Math.round((1/cols )*100)
                 var mm=rows.map(function(r){
                     var l=r.replace(/\s*\.\s*/,"||").split(/\|/),mrkup=[],widths=[],cells=l.length ,cellwd1=Math.round((1/cells)*100);
                     l.forEach(function(cl,i){
                         cl.replace(/!(\d+)!`/g,function(a,b){
                              var i=mrkup.push("<cell!>")-1
                             var idx=Number(b)-1
                             widths[idx]=1
                             var arr1=arr[idx].split(":")
                             if(arr1.length==2){widths[idx]=Number(arr1[1]||1);arr[idx]=arr1[0]}
                             var nm=arr[idx],ff={name:nm},w=widths[idx]||1;;
                             //var f=meta.findField(nm),ffif(!f){return ""}
                             // ff=f.properties.toMap();
                             // ff.iptype=ff.iptype||(ff.name=="id"?"hidden":ff.type=="date"?"date":"text"); //>(span.ui-ip-label{$label}+span.ipwrap>ip[type=$iptype ; name=$name].ui-ip)
                             mrkup[i]='<label class="field-wrap2" style="width:'+(cellwd*w)+'%" data-key="$name" for="$name"></label>'.replace(/\$([\w]+)/g,function(a,b){return ff[b]||b})

                         })

                     });
                     mrkup=mrkup.join("").replace(/(<cell!>)+/g,function(a,b){var r=a.split("!").length ; ;return "<span class='form-row-cell' style='width:"+(r*cellwd1)+"%'></span>"})
                     return mrkup
                     //
                 });


                 return  mm.join("\n")

         }else{
             var optns={
             abbr:{
                 ofw:"field-wrap2",
                 flr:"form-layout-row",fwr:"field-wrap2",
                 lblstyle:"display: block; clear: both; margin: 6px 0px;",
                 iplblstyle:"display: inline-block; width: 120px;",
                 ipstyle:"width: 300px; line-height: 2;"
             }};
             var ftmplt='label.field-wrap2[-key=$name;for=$name]'
             tmpl=String(tmpl).replace(/\{\{([\w:_]+)\}\}/gm,function(a,nm){
                 var w=0
                 if(nm.indexOf(":")>0){var ar=nm.split(":");w=Number(ar[1]);nm=ar[0]}
                 var f=meta.findField(nm),ff
                 if(!f){return ""}
                 if(w){f.ui.width=w; }
                 ff={name: f.name};
                 return ftmplt.replace(/\$([\w_]+)/g,function(a,b){return ff[b]||""})
             })
             rows=String(tmpl).replace(/[\r]/mg,"").split(/\n|\[NL\]/gm).map(function(it){return it.trim()})
                 .filter(function(it){return it.trim()})
                 .map(function(it){return "div.form-layout-row>("+it.trim()+")"})
             if(/^Z!/i.test(tmpl)){
                   var holder=document.createElement("div")
                 rows.map(function(t){
                     $d.template(t.trim(), $.clone(optns)).render( ).appendTo(holder)
                 });
                 return holder
             } else{
             return rows.map (function(t){
                   var flds=t.replace(/\[([\w_]+)\]/g,function(a,b){
                     return "<span class='field-wrap2' data-key='"+b+"'></span>"
                 });
                 return "<div class='form-layout-row'>"+flds+"</div>"
         }).join("");
             }
         }
      }

    var EDITSTATE={NOTMODIFIED:0,MODIFIED:1,RESET:-1} ,initval={}

   var  _form=self.Klass("UI.Form",{
       defaultCriteria:null,
       _fields:{},fieldKlass:null,formDom:null,dom:null,meta:null,layoutTemplate:null,dataHandle:null,
       bindings:null,dataRecord:null, layoutmode:{},  editmode:null,
       errordom:null, panel:null,model:null,ui:{},

       initialize:function  (){
           this.state={NEW:false, EDIT:false,  NOTINVIEW:false}

               if(arguments.length&&!$.isPlain(arguments[0])){
               this.meta=arguments[0];
               this.columnConfig=arguments[1];
               this.layoutTemplate=arguments[2];
               this.dataRecord=arguments[3];
               if(arguments[4]&&$.isPlain(arguments[4])){
                   this.updateProperties(arguments[4])
               }
           }
           this.config=this.config||{}
           if(!this.fieldKlass){this.fieldKlass= Data.UIField}
           //if(!this.fieldKlass){this.fieldKlass= UIField}
           this.fieldset=List.from([]).chainable(this.fieldKlass)

           if(this.dom||this.el){
               this.formDom=this.el||this.dom
           }
           var columnConfig=[]
           if(this.formDom){
               $d.qq(this.formDom,"input,textarea,select").forEach(
                   function(ip){
                       columnConfig.push(ip.name|| $.d.domdata(ip,"name")|| $.d.domdata(ip,"key")|| ip.id)
                   }
               )
           } else {
               columnConfig=this.columnConfig
           }
            if(!columnConfig&&this.meta){
                columnConfig=this.meta.items.findAll(function(it){
                        return it && !(it.hidden||it.viewonly==true||(it.ui&&it.ui.hidden ))
                    }).sort(
                        function(a,b){return a.index-b.index
                    }).collect("name")
              // this.columnConfig=this.meta.getNames().filter(function(it){
              //     if(!it||(it.hidden||(it.ui&&it.ui.hidden))){return false};
              // return true}).sort(function(a,b){return a.index-b.index})

           }
           this.columnConfig=columnConfig

           this.bindings=[]
           var hasrecord= this.dataRecord
           if(!this.dataRecord&&this.meta){
               this.dataRecord=this.meta.createRecord()
           }
           this.model=this.model ||$.model((this.meta||{}).name);
           this.make(this.columnConfig)
           this.setupEvents();
           if(hasrecord){
               this.reset(hasrecord.toMap());
           }
       },

       getProvider:function(){
           if(this.dataHandle&&this.dataHandle.store&&this.dataHandle.store.provider){
               return this.dataHandle.store.provider
           }
           if(this.dataRecord&&this.dataRecord.provider){
               return this.dataRecord.provider
           }
           if(this.meta){
               return this.meta.getProvider()
           }
        } ,
       save:function(){
           var  pr=Promise.deferred()
            if(!this.checkValidity()){
                pr.reject({error:"validation failed"})
               return pr
           }
           var m=this.model, provider,store,dataHandle=this.dataHandle,
               rec=this.dataRecord||((dataHandle&&dataHandle.record)?dataHandle.record:null),data ;
           this.each(function(k,f){
               f.sync&&f.sync(m)
           });
           var mods=this.getModValues()

             data=mods //datarec.mod().reduce(function(m,k){m[k]=datarec.get(k);return m},{}),pr,
           provider=this.getProvider()
           data.id= m.id
           if(dataHandle && dataHandle.record && dataHandle.record.id){
               data.id=dataHandle.record.id;
           }
            if(!data.id && rec){
                data.id=rec.id
            }

           if(data.id>0){var id=data.id
               data=this.dataRecord?$.disjoint(data,this.dataRecord.toMap(true) ):data;
               data.id=id;
           } else{
               data=$.compact(this.model.toMap());

           }

           if(rec && rec.meta){
               rec.meta.eachItem(function(c,nm){
                   if(c.defaultValue  && data[c.name]==null){
                       data[c.name]=typeof(c.defaultValue)=="function"?c.defaultValue():c.defaultValue
                   }
               })
           }
            if(this.defaultCriteria){
                $.extend(data,this.defaultCriteria)
            } else if(rec.store && $.isPlain(rec.store.defaultCriteria)){
                $.extend(data,rec.store.defaultCriteria)
            }
           this.fire("beforesave",data);

           if(provider){
               data.tmzoffset=(location.href.indexOf("localhost")>=0 || location.href.indexOf("127.0.0.1")>=0)?0: (new Date()).getTimezoneOffset()/60;
                      if(data.id>0){
                       pr=  provider.update(data)
                       pr.then(function(data){
                            if(dataHandle&&dataHandle.record) {dataHandle.record.update(data)}

                       },function(error){
                       })
                   } else{
                       pr=  provider.insert(data)
                   }
            }
             return pr;
        },
       getModValues:function(nonulls,unwrap){
           var map={},dataHandle=this.dataHandle;
           var props=this.model, rec=this.dataRecord||((dataHandle&&dataHandle.record)?dataHandle.record:null) ;
           if(this.editmode==="new"){
               map=this.model.toMap(true)
               $.each(props.keys(),function(k) {
                   var desc=props.getDescriptor(k),dv=desc.defaultValue
                   if(map[k]==null&&dv!=null){
                       map[k]=dv;
                   }

               })
           } else{
               this.each(function(k,m) {
                   var val=props.getItem(k),desc=props.getDescriptor(k)
                   if(rec && rec[k]!==val){
                       map[k]=val;
                   }
                   if(desc && desc.defaultValue!=null&&(map[k]==null )){
                       map[k]=desc.defaultValue;
                   }
                });
           }
           return map;
       } ,
       getValues:function(nonulls,unwrap){
            return this.model.toMap();
       }  ,
       setValues:function(vals){
           if(!vals){return}
            return this.reset(vals)
       }   ,
        reset:function(data ) {
            this.state.resetMode=true
           // if(!this.model.isPaused()){this.model.pause();}
            this.formDom&&this.formDom.el.reset();
            var largevals=[]
            this.each(function(k,f){
                f.wasvalid=false;  f.ip&&f.ip.val("");
                f.setValue("")
                f.value="";
                f.ip && (f.ip.dataset.val="");
                if(f.actualtype=="clob"||f.actualtype=="blob"){
                    largevals.push(f)
                }
                if(data&&!(k in data)){data[k]=""}
            });
            if(this.errordom){this.errordom.hide()}
          //  $.each(this.formDom.elements,function(it){if($d.hasClass(it,"noform")){return}
          //      $d.trigger(it,"change")})
            this.fire("reset")
           // this.model.reset()//.resume();
             this.state.resetMode=false;
            if(data&&typeof(data)=="object"){
                var model=this.model;
                this.each(function(k,v){
                   if(k in data){
                       model.setItem(k,data[k])
                       v.setValue(data[k])
                   }
                });

            }
            if(largevals.length&&this.editmode!="new"){
                var toget=[]
               if(data) {
                   toget=largevals.filter(function(it){return !data[it.name]||String(data[it.name]).indexOf("link:")==0})
               }
                if(toget.length&&data.id&&this.meta){  var nm=this.meta.name,model=this.model,p=this.getProvider()
                    toget.forEach(function(f){
                        p.getValue(data.id, f.name).then(function(a){
                            model[f.name]=a
                        })
                    })
                }
            }
              return this;
         },
        each:function(fn) { for(var k in this._fields){fn(k,this._fields[k])}   },
       addComponent:function(nm,specs){  },
       findIp:function(name){
           return this.formDom?this.formDom.q("input[data-key='"+name+"'],textarea[data-key='"+name+"'],select[data-key='"+name+"'],input[name='"+name+"'],textarea[name='"+name+"'],select[name='"+name+"']")  :null
       },
       getField:function(name){
           return this._fields[name]||this._fields[String(name).toLowerCase()]
       },
       getIpList:function(){
            return this.formDom?this.formDom.qq("input[data-key],textarea[data-key],select[data-key='"+name+"']")  :[]
       },
       setupEvents:function( ){
           var $form=this
           for(var i=0,l=$.keys(this._fields),ln=l.length;i<ln;i++){
               var inst=    this._fields[l[i]],nm=l[i]
               var model=inst,ip=inst.ip
              $d.on(ip,"change",function(ev){
                   if($form.state.resetMode){return}
                   var inpt=ev.target,v=$d.val(inpt);
                     $form.checkValidity(inpt,v)
                    $form.model[inpt.name]=v
                    return;
               });

       }
       },
       addField:function(nm,specs){
         if(typeof(nm)!="string"){return}
        var  fld=this.meta.findField(nm);
         if(!fld||(fld.hidden||(fld.ui&&fld.ui.hidden))){return}
           var inst=fld.getUIInstance()
        //var inst=new UIField(fld,specs)
           inst.statics||(inst.statics={});
           inst.statics.fieldTemplate=_tmplt
           inst.statics.notifyValidationError=  function(rec){ }
           return inst.build(this,specs )
           //return inst.build(this )

    },
       checkValidity:function(fld,val){
          /* $.findAll(this.formDom.elements,function(it){if($d.hasClass(it,"noform")){return}
               return !it.checkValidity()}).forEach(
               function(it){if($d.hasClass(it,"noform")){return}
                   $d.trigger(it,"invalid")}
           )*/
           return true
       },
       makeField:function(meta) { },
        make:function(allspecs) {
            var fldmap={}  ,ths=this,template,layout=this.layoutTemplate
            template=layout?_parseTemplate(layout,this.meta):null

            this.dom=document.createDocumentFragment();
             var form=$d(this.dom.appendChild(document.createElement("form")));
            this.errordom=$d("Z:div.fxtx_5[pos:a;top:99%;right:0;font-size:.8em;height:1px;overflow:hidden;fontSize:.7em;color:maroon]{A valid value is required.}")
            this.errordom=form.append(this.errordom).css({opacity:0})
            form.style.cssText='padding:4px;position:relative;display:block;overflow:auto;'
             if(this.layoutmode.klass){
                form.addClass(this.layoutmode.klass)
            }
            form.el.onsubmit=function(ev){
                var activeEl=document.activeElement
                if(!activeEl || activeEl==document.body){activeEl=[].slice.call(document.querySelectorAll(":hover")).pop()}
                if(!activeEl || (activeEl.type!="image")) {
                    if (this.checkValidity()) {
                        this.save()
                        return
                    }
                }
                ev.stopPropagation&&ev.stopPropagation();
                   // ev.preventDefault&&ev.preventDefault();
                    return false;
            }.bind(this)
            this.formDom=form
            if(template){
               if(template.nodeType){
                   var copynodes=function copynodes(src,trgt){
                       while(src.firstChild){
                           var to,from=src.removeChild(src.firstChild)
                           if(from&&from.cloneNode){
                                to=trgt.appendChild(from.cloneNode(false) )
                                copynodes(from,to)
                           }
                       }
                   }
                   if(template.nodeType==1){
                       copynodes(template.el||template,form.el.el||form.el )
                    }
                   else{
                       var nu=form.appendChild(template )
                    }
               } else{form.html(String(template));}
            }
            var isarr=$.isArray(allspecs)
                $.each(allspecs,function(v,k){var nm=(k&&typeof(k)=="string")?k:(typeof(v)=="string"?v:v.name)
                     //||this.layoutmode.labelwidth
                    var inst=this.addField(nm,typeof(v)=="string"?{}:v);
                    if(inst){
                        this._fields[nm]=inst
                    }
                ;
            },this);
            if(this.ui.labelwidth){
                $d.css.addRule("#"+this.formDom.id+" .ui-ip-label","width:"+this.ui.labelwidth+"px")
            }
            if(this.ui.labeltop){
                this.formDom.addClass("label-top")
            }


            return this;
        },

       adjustFieldWidths:function() {
           if(this._fields && this.formDom && !this.config.noadjustwidth){
               var dom=$d(this.formDom),inner=dom.innerWidth()-20;
               var lblwidth=dom.st(".ui-ip-label").width().max()||0
               var av= inner-lblwidth
               if(inner<100||!lblwidth||av < 150){return}
               $.values(this._fields).filter(function(f){return (f && f.ip && !f.width && !f.inline)}).forEach(
                   function(f){ f.ip.el.style.width=av+"px"  },this
               )
           }
       },
         appendTo:function(cntnr0){  var cntnr=cntnr0
             if(!cntnr){return}

             if(cntnr&&(cntnr.contentWrap )){if(!this.panel){this.panel=cntnr}
                 cntnr=cntnr.contentWrap||cntnr.el}
             var cntnrel=$d(cntnr);
            if(this._fields && this.dom){
                var _setDims=function(e){
                    if(cntnrel.is("._hidden")||(cntnrel.parentNode && cntnrel.parentNode.classList.contains("_hidden"))){return}
                    var par=$d(this.form).parent()
                     var outer= par.innerHeight()
                    if(outer){
                        this.form.style.height=outer+"px";
                            //(cntnrel.clientHeight-(this.form.offsetTop+5))+"px";
                    }
                    this.adjustFieldWidths()
                }.bind(this)
                $d(cntnrel).insert(this.dom);
                if(cntnr.isComponent){
                    cntnr.on("afterlayout",function(){
                        _setDims()
                    })
                } else{
                    cntnrel.on("resize",_setDims)
                }
                this.form=$d( $d.qq(cntnrel,"form").pop() );
                _setDims();
                setTimeout(_setDims,500)
               // cntnrel.watchDimensions();
                cntnrel.on("resize",_setDims)
              }
            return this
        }
 });
    _form.defaultFieldTemplate=_tmplt



    _form.models={
        datalist:{
            render:function(model,form,list){
                var PopupView=$.require("PopupView")
                var columnModel=model.columnModel||model
                var cb=function(l){
                    if(model.ip && /SELECT/i.test(model.ip.tagName)){
                        $d.addOptions(model.ip, l.list||l)
                        $d.val(model.ip,form.model[model.name])

                    } else{
                        model._lkuplist= PopupView.lookupList({anchor:model.ip, height:200,list:l,  addEvent:true,nonative:true,bottomAligned:false,
                                ascombo:columnModel.ui.combo
                            },function(k,lbl){
                                form.model[model.name]=k
                                //this.fire("uivaluechange",{name:model.name,value:k,newValue:k,valueLabel:lbl})
                            }.bind(model)
                        )
                    }

                }
                if($.isArray(list)){cb(list)}
                else if(!columnModel.readonly&&columnModel.hasLookup ){
                    if(form.meta&&columnModel.primaryEntity){

                        app.getEntity(columnModel.primaryEntity).then(
                            function(ent){
                                 if(ent.findField(form.meta.name+"_id")){

                                     if(form.model["id"]){
                                         form.model.watch("id",function(r){
                                             if(r.value){
                                                 model.getDynaLookupList(r.value  ,cb)
                                             }
                                         })}     else{
                                         model.getDynaLookupList( form.model["id"]   ,cb)
                                    }} else{
                                     model.getLookupList().then( cb);
                                 }

                            },
                            function(ent){
                                model.getLookupList().then( cb);
                            }
                        )
                    } else{columnModel.getLookupList().then( cb);}


                    /*$d(model.ip).on("mousedown",function(evt){
                         this.getLookupList().then(
                         function(l){
                             this.listvw.layout().show(l,evt.target);}.bind(this));
                        }.bind(model))*/
                }
                if(model.ip && /SELECT/i.test(model.ip.tagName)){
                    model.setValue=function(a){
                        if(this.name=="operator_id"){
                            this.__value=a;

                        }
                        if(this.ip){
                            $d.val(this.ip.el,a+"");
                        }
                    }
                }
                if(model.ip){
                    if(model.ui.combo){model.ip.type="search";}
                    else if(model.ip && !/SELECT/i.test(model.ip.tagName)){ model.ip.readOnly=true}
                }

            }
        },
        hidden:{
            name:"id",
            render:function(model,form){
                model.hidden=true;
                 model.ip.type="hidden"
            }
        },
        color:{ "type":"color",
           render:function(model,form){
               if(!model.ip || model.ip.data("_colorpicker")){return}
               model.ip.prop("readonly",true)
               model.setValue=function(a){
                    if(String(a).length==6 && /^[A-F0-9]+$/.test(a)){a="#"+a}
                     model.ip.css("backgroundColor",a)
               }
               model.hasPopup=true


               $.require("ColorPicker",function(ColorPicker){
                   function onselect(color,nohide) {
                       var val = color.getColorName()
                       if (!val){
                           val = String(color.toHex()).replace(/^\#/, "")
                        }
                        form.model[model.name]=val
                        if(!nohide){_picker.hide()  }
                   }
                   var _picker=new ColorPicker(onselect,onselect)
                   model.ip && model.ip.on("mousedown",function(evt){
                     _picker.activate(model.ip)

                   })
                   model.ip && model.ip.data("_colorpicker",_picker)
               })
           }
        } ,
        date:{"type":"date",
            render:function(model,form){
                 if(model.asIP){

                }
                model.hasPopup=true
                var PopupView=$.require("PopupView")
                if(model.actualtype=="time"){
                     var l=List.create().fill(0,0,24).collect(function(l,i){var v= i,s=i==0?"12":((v>12?(v-12):v)+""),ap=(v>=12?"pm":"am") ;return [s+":00"+ap,s+":15"+ap,s+":30"+ap,s+":45"+ap]}).flatten();
                    model._lkuplist= PopupView.lookupList(l.toArray(), {
                            anchor: model.ip, height: 200,
                            callback: function (rec) {
                                form.model[model.name] = $.typeInfo.TIME.coerce(rec.id)
                                //this.fire("uivaluechange",{name:model.name,value:k,newValue:k,valueLabel:lbl})
                            }.bind(model)
                        }
                    );
                    model.ip &&  model.ip.on("mousedown",function(evt){
                        model._lkuplist.show();
                    });
                    return
                };
                $.require("UI.Calendar",function(cal){
                    var calmodel=null;
                    model.ip &&  model.ip.on("mousedown",function(evt){
                         var ip=evt.target;
                        if(!calmodel){
                            calmodel=cal(null,{ ip:ip,
                                onselect:function(k,lbl){
                                    form.model[model.name]=k
                                    //model.fire("uivaluechange",{name:model.name,value:k,newValue:k,valueLabel:lbl})
                                    calmodel.view.hide()
                                }
                            });
                         //    model.ui.calvw.el.css({border:"1px solid #666"})
                         //   model.ui.calvw.setConfig("anchor",ip).layout().show();
                      }
                      calmodel.view&&calmodel.view.show();
                      calmodel.render( model.val||new Date()   );
                });
                    model.ip &&  model.ip.prop("readonly",true)
                });
            }
        },
        "radioset":{"type":"radioset",
            init:function(model,form){

            } ,render:function(model,form){
                if(model.ip){model.ip.el.type="text"

                    var el=$d.template("label.toggle-switch>span.aa[-on:yes;-off=no]>div.bb{.}+strong").render().el
                    el.setAttribute("for",model.ip.id)
                    el.setAttribute("forLabel",model.ip.id)
                    el.insertBefore(model.ip.el,el.firstChild)
                    var wrap=model.wrapel?model.wrapel.q(".ipwrap"):null
                    if(!wrap && !$d.is(model.ip,"input")){wrap=model.ip}
                    wrap&&wrap.append(el);
                 }
            }
        },
        "boolean":{"type":"boolean",
            init:function(model){

            } ,render:function(model,form){
                if(model.ip){
                    if(!$d.is(model.ip,"input")){
                        return _form.models.datalist.render(model,form,[{label:"Yes",id:1},{label:"No",id:0}])
                    }

                    model.ip.el.type="checkbox"
                    var el=$d.template("div.toggle-switch>span.aa[-on:yes;-off=no]>div.bb{.}+strong").render().el
                    el.style.position="relative"
                    $d(el).on("click",function(){
                        if($d.is(model.ip,'input[type="checkbox"]')) {
                            model.ip.checked = !model.ip.checked
                            form.model[model.name] = model.ip.checked ? 1 : 0
                        }  else  {
                            form.model[model.name]= form.model[model.name]?0:1
                        }
                     });
                    //el.setAttribute("for",model.ip.id)
                    //el.setAttribute("forLabel",model.ip.id)
                     el.insertBefore(model.ip.el,el.firstChild)
                    var wrap=model.wrapel?model.wrapel.q(".ipwrap"):null
                    if($d.isFormInput(model.ip )){
                        wrap.append(el);
                    }

                  }
            }
        },
        rte:{
            init:function(){
             } ,
            render:function(model,form){
                var _pending
                $.require("rte", function(r){
                     $d.onAttach (model.ip, function(){
                         model.R=self.rte.setup(model.ip)
                         if(_pending){
                             model.R.setContent(_pending)
                             _pending=null
                         }
                     })
                 })

                model.sync=function(rec){if(!this.R){return}
                    rec[this.name]= (this.R.getContent()||"").trim()
                }
                model.setValue=function(a){
                    if(this.R){
                        this.R.setContent(String(a ))
                    } else{_pending=String(a )}


                }
            }
        } ,
        rtf:{
           init:function(){

           } ,
            render:function(model,form){
                function _setup(wysihtml5){
                    var r=$d.template("<ul class='wyshtml-toolbar' >$each{<li data-wysihtml5-command='$name'  class='command' title='$title'>$label</li>}</ul>")
                    function _cap(a){return a.charAt(0).toUpperCase()+ a.substr(1)}
                    var data="bold,createLink,fontSize,foreColor,formatBlock,formatInline,insertHTML,insertImage,insertLineBreak,insertOrderedList,insertUnorderedList,italic,justifyCenter,justifyLeft,justifyRight,underline".split(/\,/).map(function(a){return {name:a,title:a,label:_cap(a)}})
                    //var toolbar=$d("div").html(r(data))
                    var toolbar= model.ip.before(r(data))
                    new wysihtml5.Editor(model.ip.el, { // Could also pass a DOM node instead of an ID
                        name:                 model.name,// Give the editor a name, the name will also be set as class name on the iframe and on the iframe's body
                        style:                true, // Whether the editor should look like the textarea (by adopting styles)
                          toolbar:              toolbar.el,// Id of the toolbar element or DOM node, pass false value if you don't want any toolbar logic
                        autoLink:             true,// Whether urls, entered by the user should automatically become clickable-links
                        // Object which includes parser rules to apply when html gets inserted via copy & paste
                        // See parser_rules/*.js for examples
                        parserRules:          { tags: { br: {}, span: {}, div: {}, p: {} }, classes: {} },
                        parser:               wysihtml5.dom.parse, // Parser method to use when the user inserts content via copy & paste
                        composerClassName:    "wysihtml5-editor",// Class name which should be set on the contentEditable element in the created sandbox iframe, can be styled via the 'stylesheets' option
                        bodyClassName:        "wysihtml5-supported",// Class name to add to the body when the wysihtml5 editor is supported
                        useLineBreaks:        true,// By default wysihtml5 will insert a <br> for line breaks, set this to false to use <p>
                        stylesheets:          [], // Array (or single string) of stylesheet urls to be loaded in the editor's iframe
                        //  placeholderText:      undef,// Placeholder text to use, defaults to the placeholder attribute on the textarea element
                        supportTouchDevices:  true,// Whether the rich text editor should be rendered on touch devices (wysihtml5 >= 0.3.0 comes with basic support for iOS 5)
                        cleanUp:              true// Whether senseless <span> elements (empty or without attributes) should be removed/replaced with their content
                    });
                }
                $.require("wysihtml5",function(wysihtml5){
                 $d.onAttach(model.ip,function(){_setup(wysihtml5)})

              })


            }
        } ,
        "img":{"type":"image", defaultValue:location.href.split("/").slice(0,4).join("/")+"/theme/img/noimg.png",
        init:function(model,form){
            if(!model.ip){   return}
                model.ip.type="image"
                model.ip.addEventListener("mousedown",function(ev){
                    ev.preventDefault&&ev.preventDefault()
                  //  return false;
                    var bar,  updlbl=model.wrapel,
                        uploadbutton=this ,img=this,wd ; model.hasPopup=true
                    $.require(["$File"],function(){
                    model._img=img;
                    var ip=null,b=updlbl.el.getBoundingClientRect(),mousepos=$d.util.mousePos  ,
                    d=document.createElement("div") ,iptemplate
                    d.innerHTML="<input class='noform' type='image' style='width:5px;height:5px;background-color:transparent;border:none;z-index:20;position: absolute;opacity:.1' name='upload-file' id='upload-file' type='file'/>",
                        iptemplate= d.removeChild(d.firstChild) ;
                    updlbl.on("mousemove",function(ev){
                        if(!wd){wd=(uploadbutton.offsetWidth+5);updlbl.style.width=wd+"px";
                            b=updlbl.el.getBoundingClientRect();
                        }
                        if(!ip || !updlbl.querySelector("input")){
                            ip=updlbl.insertBefore(iptemplate.cloneNode(true),uploadbutton.el)
                            $File.setupIp(ip,{type:'image',reader:"dataURL",
                                complete:function(pr){
                                    form.model[model.name]= this.result
                                //    model.fire("uivaluechange",{name:model.name,value:this.result,newValue:this.result})
                                    if(ip){updlbl.removeChild(ip);ip=null;}
                                }})
                        }
                        if(b.top==0){b=updlbl.el.getBoundingClientRect(); }
                        var pos=mousepos(ev )
                        pos.x=(pos.x- (b.left+3));pos.y=(pos.y- (b.top+3));
                        if(pos.y<=0 || pos.x<=0 || pos.y> b.height || pos.x>wd){return}
                        ip.style.top=pos.y+"px";ip.style.left=pos.x+"px"
                    })
                })
                    return false;
            });
            /*function _setVal(a){if(a==null){return}
                 var v=typeof(a)=="string"?a:a.value
                var val=String(v)
                if(val.indexOf("data:")!=0&&val.indexOf("//")==-1){val="//"+val}
                this.ip.setAttribute("src", val)
                this.ip.setAttribute("value", val)
                this.ip.value=val
                this.ip.dataset.val=val
            }*/


         //   model.on("value",_setVal)
            model.setValue=function(a){
                if(a){
                    if(this.reader){
                        a=this.reader(a)
                    }
                }
                var val=String(a )
                if(val.indexOf("data:")!=0&&val.indexOf("//")==-1){val="//"+val}
                this.ip.setAttribute("src", val)
             }
         }

        },
        "attachment": (function(){
             var attachmentsStore
            function _setup(model, form,store){
                if(!app.attachmentsStore) {app.attachmentsStore=store;}
                //$d.hide(model.ip)

                var bar, updlbl=model.wrapel.q(".ipwrap"),    wd;
                model.hasPopup=true
                var ip=null,iptemplate, b=updlbl.el.getBoundingClientRect (), mousepos=$d.util.mousePos  , $file, d=document.createElement ("div") , iptemplate
                d.innerHTML="<input class='noform ipfileworker' style='width:5px;height:5px;background-color:transparent;border:none;z-index:20;position: absolute;opacity:.1' name='upload-file' id='upload-file' type='file'/>",
                    iptemplate=d.removeChild (d.firstChild);
                $.require(["$File"], function(){
                    $file=$File
                })
                function mv(ev){
                    var  uploadbutton=model.ip ;
                    if(!wd) {
                        wd=(uploadbutton.offsetWidth + 5);
                        if($d.css(updlbl,"display")!="block") {
                            updlbl.style.width=wd + "px";
                        }
                        b=updlbl.el.getBoundingClientRect ();
                    }
                    if( !updlbl.querySelector (".ipfileworker")) {
                        ip=updlbl.el.appendChild (iptemplate.cloneNode (true))
                         $File.setupIp (ip, {type: 'doc', reader: "dataURL",//dataURL
                             progress: function(n){
                                 if(n.percent<=1){model.ip.val("");}
                                 model.ip.placeholder="loading .."+ n.percent+"%"
                             },
                             complete: function(result){
                                updlbl.off("mousemove", mv);
                                 model.ip.placeholder="uploading .."
                                var info=this.info,type=info.type,mtype=info.type
                                 store.provider.insert({nm: info.name, isbase64:1,filename: info.name, sz: info.sz, mimetype: info.mimetype,
                                    lastts: +info.lastmodified,type: info.type, data: result
                                }).then(
                                    function(d){
                                        form.model[model.name]=d.id
                                          updlbl.on("mousemove", mv);
                                    }
                                )
                                // model.fire("uivaluechange",{name:model.name,value:this.result,newValue:this.result})
                                if(ip) {
                                    updlbl.removeChild (ip);
                                    ip=null;
                                }
                            }})

                    }
                    //if(b.top == 0) {
                        b=updlbl.el.getBoundingClientRect ();
                    //}
                    var pos=mousepos (ev)
                    pos.x=(pos.x - (b.left + 3));
                    pos.y=(pos.y - (b.top + 3));
                    if(pos.y<=0||pos.x<=0||pos.y>b.height||pos.x>wd) {
                        return
                    }
                    ip.style.top=pos.y + "px";
                    ip.style.left=pos.x + "px"
                }
                updlbl.on ("mousemove", mv);
                if( model.ip){
                    if(!model.ip.placeholder){model.ip.placeholder="Click to select a file"}
                    model.ip.type="text"
                    $d.prop (model.ip, "readonly", true)
                }



             }
            return {"type": "attachment",
                init: function(model, form){
                    if(!model.ip) {
                        return
                    }
                    if(!attachmentsStore) {
                        app.getEntity ("attachments").then (function(a){
                            attachmentsStore=a.createStore ()
                            _setup (model, form, attachmentsStore)
                        })
                    }else {
                        _setup (model, form, attachmentsStore)
                    }

                }

            }
        })()
         ,
        "file":{"type":"file",
            init:function(model,form){
                if(!model.ip){   return}
                //$d.hide(model.ip)
                var bar,  updlbl=model.wrapel,
                    uploadbutton=this ,img=this,wd ; model.hasPopup=true
                var ip=null,b=updlbl.el.getBoundingClientRect(),mousepos=$d.util.mousePos  ,
                    $file,d=document.createElement("div") ,iptemplate
                d.innerHTML="<input class='noform ipfileworker' style='width:5px;height:5px;background-color:transparent;border:none;z-index:20;position: absolute;opacity:.1' name='upload-file' id='upload-file' type='file'/>",
                    iptemplate= d.removeChild(d.firstChild) ;
                $.require(["$File"],function(){
                    $file=$File
                })
                updlbl.on("mousemove",function(ev){
                    if(!wd){wd=(uploadbutton.offsetWidth+5);updlbl.style.width=wd+"px";
                        b=updlbl.el.getBoundingClientRect();
                    }
                    if(!ip || !updlbl.querySelector("input")){
                        ip=updlbl.insertBefore(iptemplate.cloneNode(true),uploadbutton.el)
                        $File.setupIp(ip,{type:'doc',reader:"dataURL",
                            complete:function(result){
                                var info=this.info
                                form.model[model.name]= JSON.stringify({name:info.name,sz:info.sz,type:info.type,data:result})
                                //    model.fire("uivaluechange",{name:model.name,value:this.result,newValue:this.result})
                                if(ip){updlbl.removeChild(ip);ip=null;}
                            }})
                    }
                    if(b.top==0){b=updlbl.el.getBoundingClientRect(); }
                    var pos=mousepos(ev )
                    pos.x=(pos.x- (b.left+3));pos.y=(pos.y- (b.top+3));
                    if(pos.y<=0 || pos.x<=0 || pos.y> b.height || pos.x>wd){return}
                    ip.style.top=pos.y+"px";ip.style.left=pos.x+"px"
                })
                if(model.ip){
                    model.ip.type="text"
                    $d.prop(model.ip,"readonly",true)
                    model.setValue=function(a){
                        if(!a){return this.ip.prop("value", "")}

                        var json=$.isJsonString(a)
                        if(json){
                            this.ip.prop("value", json.name||json.filename)
                        }else{ this.ip.prop("value", String(a ))
                        }
                    }
                }

            }

        },
        pic:{"name":"pic","type":"string", defaultValue:location.href.split("/").slice(0,4).join("/")+"/theme/img/noimg.png",
            reader:{read:function(val0){var val=null;
                if(typeof(val0)=="string"){
                    val=String(val0).replace(/^["\\]|["\\]$/g,"");
                    if(val.indexOf("data")!=0){
                        val=null
                    }

                }
                return val
            }
            },
            render:function(mdl,form){
                var src="",wd=mdl.ui.width?Math.max(100,mdl.ui.width):200    ,DEFAULTIMG=app?(app.contextPath+"theme/img/pictures.png"):"",
                ht=mdl.ui.height?Math.max(100,mdl.ui.height):(wd*.75)
                mdl.hasPopup=true
                $d(mdl.ip).insert("" +
                    "<span class=' ' style='position:relative;  display: inline-block;'>" +
                    "<img data-key='snap' style='width:"+wd+"px;height:"+ht+"px;' src='"+src+"'/>" +
                    "<div  class='pic-bar' style='text-align: center'>" +
                    "   <button class='ui-button small smaller' style='margin:0' type='button' data-key='snap'>Snap</button>" +
                    "   <span class='for-upload-file' style='position:relative;overflow:hidden;margin-left:-8px'>" +
                    "    <button  class='ui-button small smaller'type='button' data-key='upload' style='z-index:1;border-top-left-radius:0;border-bottom-left-radius:0;'>upload</button>" +
                    "   </span>" +
                    "</div>" +
                    "</span>"
                    ,"before") ;
                mdl.ip.type="hidden" ;
                if(!mdl.label&&mdl.labelel) {
                    mdl.labelel.hide();
                } else{
                         $.timer.when(function( ){ return mdl.wrapel.height() > 50  },
                            function( ){
                                var ht=mdl.wrapel.height();
                                if(ht&&ht>100) {
                                    mdl.labelel&&mdl.labelel.css ({lineHeight: ht+"px"})
                                }
                            },
                            {dur:200,maxduration:5})
                 }
                //mdl.wrap.querySelector(".field-label").style.verticalAlign="top";

                var d=document.createElement("div") ,iptemplate
                d.innerHTML="<input style='width:5px;height:5px;background-color:transparent;border:none;z-index:20;position: absolute;opacity:.1' name='upload-file' id='upload-file' type='file'/>",
                    iptemplate= d.removeChild(d.firstChild);d=null;
                mdl.setValue=function(rec){
                    if(!rec||rec=="null"){rec="";$d.addClass(mdl._img,"default-picture")}
                    else{$d.removeClass(mdl._img,"default-picture")}
                    mdl._img.el.src=rec ;
                    mdl._img.dataset.key=''
                }
                mdl.onUpdate=function(dataurl){
                    form.model[mdl.name]= dataurl
                  //  this.fire("uivaluechange",{name:this.name,value:dataurl,newValue:dataurl})
                }

                /*mdl.on("value",function(rec){
                    this._img.el.src=rec.value;
                    this._img.dataset.key=''
                });*/
                var bar=$d(mdl.wrapel).q(".pic-bar"),updlbl=bar.q(".for-upload-file"),
                    uploadbutton=$d.q(updlbl,"button") ,img=$d.q(mdl.wrapel,"img"),wd ;
                mdl._img=img;


                var ip=null,b=updlbl.el.getBoundingClientRect(),mousepos=$d.util.mousePos

                updlbl.on("mousemove",function(ev){
                    if(!ip){return}
                    if(!wd){wd=(uploadbutton.offsetWidth+5);updlbl.style.width=wd+"px";
                        b=updlbl.el.getBoundingClientRect();
                    }

                    if(b.top==0){b=updlbl.el.getBoundingClientRect(); }
                    var pos=mousepos(ev )
                    pos.x=(pos.x- (b.left+3));pos.y=(pos.y- (b.top+3));
                    if(pos.y<=0 || pos.x<=0 || pos.y> b.height || pos.x>wd){return}

                    ip.style.top=pos.y+"px";ip.style.left=pos.x+"px"
                });
                var snapshot
                function _snap(ev){
                    if(!($d.is(ev.target,"button")||$d.is(ev.target,"img"))){return}
                    var el=$d(ev.target)
                    if(el.dataset.key=="snap"&&UI.snapshot){
                        var img=$d.q(this.parentNode,"img"),b=img.getBoundingClientRect()

                         snapshot=UI.snapshot(null,{width:Math.max(180, b.width),top: b.top  ,left: b.left-10 ,callback:function(resultimg,canvas,cntnr){
                            if(resultimg){img.el.src=resultimg.src
                                mdl.onUpdate( resultimg.src    )
                            }
                        }})
                        if(snapshot&&snapshot.moveTo&&form&&form.panel){form.panel.on("afterlayout",  function(){
                            if(mdl._img){
                                setTimeout(function(){
                                    var b=$d.bounds(mdl._img);
                                    snapshot.moveTo(b.left, b.top)
                                },100)
                            }
                        })}
                    }
                 }

                $.require(["UI.snapshot","$File"],function(snapshot,$File){
                    var bar=$d(mdl.wrapel).q(".pic-bar")
                    if(!ip || !updlbl.querySelector("input")){
                        ip=updlbl.insertBefore(iptemplate.cloneNode(true),uploadbutton)
                        $File.setupIp(ip,{type:'image',reader:"dataURL",
                            complete:function(pr){
                                mdl.onUpdate(this.result)
                                if(ip){updlbl.removeChild(ip);ip=null;}
                            }})
                    }

                    bar.on("click",_snap);
                });


            }
        }

    }
UI.Form=_form;



module.exports=UI.Form
}
__bootstrap__.modules["ColorPicker"] = function(module){
function autoscale(canvas){
        var ctx = canvas.getContext('2d');
        var ratio = window.devicePixelRatio || 1;
        if (1 != ratio) {
            canvas.style.width = canvas.width + 'px';
            canvas.style.height = canvas.height + 'px';
            canvas.width *= ratio;
            canvas.height *= ratio;
            ctx.scale(ratio, ratio);
        }
        return canvas;
    };

    function rgb(r,g,b) {
        return 'rgb(' + r + ', ' + g + ', ' + b + ')';
    }

    /** RGBA util.   */

    function rgba(r,g,b,a) {
        return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + a + ')';
    }

    /** Mouse position util. */

    function localPos(e) {
        var offset = e.target.getBoundingClientRect();
        return {
            x: e.pageX - offset.left,
            y: e.pageY - offset.top
        };
    }
    function addCSSRule(sheet, selector, rules, index) {
        try{
        if(sheet.insertRule) {
            sheet.insertRule(selector + "{" + rules + "}", index||0);
        }
        else {
            sheet.addRule(selector, rules, index||0);
        }
        } catch(e){}
    }
    /**
     * Initialize a new `ColorPicker`.
     * Emits:  `change` with the given color object
     */

    function ColorPicker(onselect,onchange,currval) {
        this._colorPos = {};
        var div=document.createElement("div");
        div.innerHTML='' +
            '<div class="color-picker" style="height:185px;">' +
                '<div class="color-picker-canvas" style="height:165px;text-align:center;white-space:nowrap;position: relative;">' +
                    '<canvas class="main"></canvas><canvas style="position:absolute;top:0;left:205px;text-align:center;white-space:nowrap" class="spectrum"></canvas>' +
                '</div>' +
                '<div class="color-picker-named" style="text-align:center;">' +
                    '<select class="color-picker-named-list" style="width:150px"><option value="0">-named colors-</option></select>' +
                    '<span class="named-sel-prev" style="display:inline-block;width:20px;margin:0 3px;">&nbsp;</span>' +
                '</div><div  style="text-align:center;margin-top:4px;"><button class="ui-button named-sel blue">OK</button></div>' +
            '</div>'
        this.el =  div.removeChild(div.firstChild)
        var sheet=document.styleSheets[0],css={".color-picker canvas":"border: 1px solid #888;display:inline-block;",".color-picker canvas.main:hover":"cursor: crosshair;",".color-picker canvas.spectrum:hover":"cursor: row-resize;",".color-picker canvas:active":"cursor: none;"}
        Object.keys(css).forEach(function(k){addCSSRule(sheet, k, css[k])});

        if(onselect){this.on("select",onselect)}
        if(onchange){this.on("change",onchange)}
        var sellist=this.el.querySelector(".color-picker-named-list")
        if(sellist && sellist.options.length<2){
            var colors=webcolors.slice();
            colors.sort(function(a,b){return String(a[0]+" ").charCodeAt(0) - String(b[0]+" ").charCodeAt(0) });
              for(var i= 0, ln=colors.length;i<ln;i++){
                var nm=colors[i][0]||"";if(!nm){continue;}
                var id=nm.toLowerCase(),label=nm.replace(/([A-Z])/g," $1").trim();

                var opt=document.createElement("option")
                opt.text = label
                opt.setAttribute && opt.setAttribute("value", id);
                typeof(sellist.add)=="function"?sellist.add(opt):sellist.appendChild(opt);
            }
            sellist.onchange=function(){
                var prev=this.parentNode.querySelector(".named-sel-prev")
                if(prev){ prev.style.backgroundColor=this.value}
            }
            this.el.querySelector(".named-sel").addEventListener("click",function(){
                onchange(new Color(sellist.value))
            });

        }


    }

    ColorPicker.prototype.activate=function(anchor,color,container){
        this.container=$d(container);
        if(!this.container){
            var popupview=$.require("PopupView")
            this._vw=new popupview({anchor:anchor,title:"Color Picker" , width:240,minHeight:230,destroyonhide:true });
            this._vw.show()
            this.container=this._vw.contentWrap
        }
        this.el=$d(this.container.append(this.el))
        this.main = this.el.q('.main');
        this.spectrum = this.el.q('.spectrum');
        this.hue(rgb(255, 0, 0));
        this.spectrumEvents(); this.mainEvents();
        this.w = 200;  this.h = 160;
        this.render();
        //this._vw.setConfig("anchor",anchor).layout().show(anchor);
        var sellist=this.container.q(".color-picker-named-list")
        if(sellist){
            if(color){
                sellist.value=String(color).toLowerCase()
            } else {
                sellist.value="0"
                this.container.q(".named-sel-prev").css({backgroundColor:"white"})
            }
        }
    }
    ColorPicker.prototype.on=function(type,fn){this._listeners||(this._listeners={});this._listeners[type]||(this._listeners[type]=[]);
        if(typeof(fn)=="function"){this._listeners[type].push(fn)}
    };
    ColorPicker.prototype.emit=function(type){var a=[].slice.call(arguments,1);
        this._listeners&&this._listeners[type]&&this._listeners[type].forEach(function(it){it.apply(this,a)},this)
    };

    /**
     * Spectrum related events.
     * @api private
     */

    ColorPicker.prototype.spectrumEvents = function(){
        var self = this , canvas =  this.spectrum , down;

        function update(e) {
            var offsetY = localPos(e).y;
            var color = self.hueAt(offsetY - 4);
            self.hue(color.toString());
            if (!((e.which&&e.which == 3)||(e.button&&e.button== 2))){}
            //self.emit('change', color);
            self._huePos = offsetY;
            self.render();
        }

        canvas.addEventListener("mousedown",function(e){
            if ((e.which&&e.which == 3)||(e.button&&e.button== 2)){return}
            e.preventDefault();
            down = true;
            update(e);
        });

        canvas.addEventListener("mousemove",function(e){
            if (down) update(e);
        });

        canvas.addEventListener("mouseup",function(e){
            if ((e.which&&e.which == 3)||(e.button&&e.button== 2)){return}
            down = false;
        });
    };

    /**
     * Hue / lightness events.
     * @api private
     */

    ColorPicker.prototype.mainEvents = function(){
        var self = this , canvas =  this.main , down;
        function update(e,onmove) {
            var color;
            self._colorPos = localPos(e);
            color = self.colorAt(self._colorPos.x, self._colorPos.y);
            self.color(color.toString());
            if(!onmove){
                self._selected=color;
                self.emit('change', new Color(color))
            }
            self.render();
        }

        canvas.addEventListener("mousedown",function(e){
            if ((e.which&&e.which == 3)||(e.button&&e.button== 2)){return}
            e.preventDefault();
            down = true;
            update(e);
        });

        canvas.addEventListener("mousemove",function(e){
            if (down) update(e,true);
        });

        canvas.addEventListener("mouseup",function(e){
            if ((e.which&&e.which == 3)||(e.button&&e.button== 2)){return}
            down = false;
        });
    };

    /**
     * Get the RGB color at `(x, y)`.
     *
     * @param {Number} x
     * @param {Number} y
     * @return {Object}
     * @api private
     */

    ColorPicker.prototype.colorAt = function(x, y){
        var data = this.main.getContext('2d').getImageData(x, y, 1, 1).data;

        return {
            r: data[0],  g: data[1],  b: data[2],
            toString: function(){   return rgb(this.r, this.g, this.b);  }
        };
    };

    /**
     * Get the RGB value at `y`.
     *
     * @param {Type} name
     * @return {Type}
     * @api private
     */

    ColorPicker.prototype.hueAt = function(y){
        var data = this.spectrum.getContext('2d').getImageData(0, y, 1, 1).data;
        return {
            r: data[0], g: data[1],    b: data[2],
            toString: function(){   return rgb(this.r, this.g, this.b);   }
        };
    };

    /**
     * Get or set `color`.
     *
     * @param {String} color
     * @return {String|ColorPicker}
     * @api public
     */

    ColorPicker.prototype.color = function(color){
        if (0 == arguments.length) return this._color;
        this._color = color;
        return this;
    };

    /**
     * Get or set hue `color`.
     *
     * @param {String} color
     * @return {String|ColorPicker}
     * @api public
     */

    ColorPicker.prototype.hue = function(color){
        // TODO: update pos
        if (0 == arguments.length) return this._hue;
        this._hue = color;
        return this;
    };
    ColorPicker.prototype.hide = function(){
           this._vw&&this._vw.hide()
    }
    /**
     * Render with the given `options`.
     *
     * @param {Object} options
     * @api public
     */

    ColorPicker.prototype.render = function(options){
        options = options || {};
        this.renderMain(options);
        this.renderSpectrum(options);

    };

    /**
     * Render spectrum.
     *
     * @api private
     */

    ColorPicker.prototype.renderSpectrum = function(options){
        var el = this.el  , canvas = this.spectrum , ctx = canvas.getContext('2d') , pos = this._huePos
            , w = this.w * .12    , h = this.h;

        canvas.width = w;  canvas.height = h;
        canvas.style.left=(this.w+2)+"px"
        autoscale(canvas);

        var grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, rgb(255, 0, 0));
        grad.addColorStop(.15, rgb(255, 0, 255));
        grad.addColorStop(.33, rgb(0, 0, 255));
        grad.addColorStop(.49, rgb(0, 255, 255));
        grad.addColorStop(.67, rgb(0, 255, 0));
        grad.addColorStop(.84, rgb(255, 255, 0));
        grad.addColorStop(1, rgb(255, 0, 0));

        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, w, h);

        // pos
        if (!pos) return;
        ctx.fillStyle = rgba(0,0,0, .5);
        ctx.fillRect(0, pos, w, 1);
        ctx.fillStyle = rgba(255,255,255, .7);
        ctx.fillRect(0, pos + 1, w, 1);
    };

    /**
     * Render hue/luminosity canvas.
     * @api private
     */

    ColorPicker.prototype.renderMain = function(options){
        var el = this.el  , canvas = this.main   , ctx = canvas.getContext('2d')
            , w = this.w     , h = this.h
            , x = (this._colorPos.x || w) + .5  , y = (this._colorPos.y || 0) + .5;
        canvas.width = w; canvas.height = h;
        autoscale(canvas);

        var grad = ctx.createLinearGradient(0, 0, w, 0);
        grad.addColorStop(0, rgb(255, 255, 255));
        grad.addColorStop(1, this._hue);

        ctx.fillStyle = grad;  ctx.fillRect(0, 0, w, h);

        grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, rgba(255, 255, 255, 0));
        grad.addColorStop(1, rgba(0, 0, 0, 1));

        ctx.fillStyle = grad;   ctx.fillRect(0, 0, w, h);

        // pos
        var rad = 10;
        ctx.save();
        ctx.beginPath();
        ctx.lineWidth = 1;

        // outer dark
        ctx.strokeStyle = rgba(0,0,0,.5);
        ctx.arc(x, y, rad / 2, 0, Math.PI * 2, false);
        ctx.stroke();

        // outer light
        ctx.strokeStyle = rgba(255,255,255,.5);
        ctx.arc(x, y, rad / 2 - 1, 0, Math.PI * 2, false);
        ctx.stroke();

        ctx.beginPath();
        ctx.restore();
    }


    var webcolors=     
        [
    ["Pink","FFC0CB",[  255,192,203]],
	["LightPink","FFB6C1",[  255,182,193]],
	["HotPink","FF69B4",[  255,105,180]],
	["DeepPink","FF1493",[  255,20,147]],
	["PaleVioletRed","DB7093",[  219,112,147]],
	["MediumVioletRed","C71585",[  199,21,133]],
	["LightSalmon","FFA07A",[  255,160,122]],
	["Salmon","FA8072",[  250,128,114]],
	["DarkSalmon","E9967A",[  233,150,122]],
	["LightCoral","F08080",[  240,128,128]],
	["IndianRed","CD5C5C",[  205,92,92]],
	["Crimson","DC143C",[  220,20,60]],
	["FireBrick","B22222",[  178,34,34]],
	["DarkRed","8B0000",[  139,0,0]],
	["Red","FF0000",[  255,0,0]],
	["OrangeRed","FF4500",[  255,69,0]],
	["Tomato","FF6347",[  255,99,71]],
	["Coral","FF7F50",[  255,127,80]],
	["DarkOrange","FF8C00",[  255,140,0]],
	["Orange","FFA500",[  255,165,0]],
	["Yellow","FFFF00",[  255,255,0]],
	["LightYellow","FFFFE0",[  255,255,224]],
	["LemonChiffon","FFFACD",[  255,250,205]],
	["LightGoldenrodYellow","FAFAD2",[  250,250,210]],
	["PapayaWhip","FFEFD5",[  255,239,213]],
	["Moccasin","FFE4B5",[  255,228,181]],
	["PeachPuff","FFDAB9",[  255,218,185]],
	["PaleGoldenrod","EEE8AA",[  238,232,170]],
	["Khaki","F0E68C",[  240,230,140]],
	["DarkKhaki","BDB76B",[  189,183,107]],
	["Gold","FFD700",[  255,215,0]],
	["Cornsilk","FFF8DC",[  255,248,220]],
	["BlanchedAlmond","FFEBCD",[  255,235,205]],
	["Bisque","FFE4C4",[  255,228,196]],
	["NavajoWhite","FFDEAD",[  255,222,173]],
	["Wheat","F5DEB3",[  245,222,179]],
	["BurlyWood","DEB887",[  222,184,135]],
	["Tan","D2B48C",[  210,180,140]],
	["RosyBrown","BC8F8F",[  188,143,143]],
	["SandyBrown","F4A460",[  244,164,96]],
	["Goldenrod","DAA520",[  218,165,32]],
	["DarkGoldenrod","B8860B",[  184,134,11]],
	["Peru","CD853F",[  205,133,63]],
	["Chocolate","D2691E",[  210,105,30]],
	["SaddleBrown","8B4513",[  139,69,19]],
	["Sienna","A0522D",[  160,82,45]],
	["Brown","A52A2A",[  165,42,42]],
	["Maroon","800000",[  128,0,0]],
[  "DarkOliveGreen","556B2F",[  85,107,47]],
[  "Olive","808000",[  128,128,0]],
[  "OliveDrab","6B8E23",[  107,142,35]],
[  "YellowGreen","9ACD32",[  154,205,50]],
[  "LimeGreen","32CD32",[  50,205,50]],
[  "Lime","00FF00",[  0,255,0]],
[  "LawnGreen","7CFC00",[  124,252,0]],
[  "Chartreuse","7FFF00",[  127,255,0]],
[  "GreenYellow","ADFF2F",[  173,255,47]],
[  "SpringGreen","00FF7F",[  0,255,127]],
[  "MediumSpringGreen","00FA9A",[  0,250,154]],
[  "LightGreen","90EE90",[  144,238,144]],
[  "PaleGreen","98FB98",[  152,251,152]],
[  "DarkSeaGreen","8FBC8F",[  143,188,143]],
[  "MediumSeaGreen","3CB371",[  60,179,113]],
[  "SeaGreen","2E8B57",[  46,139,87]],
[  "ForestGreen","228B22",[  34,139,34]],
[  "Green","008000",[  0,128,0]],
[  "DarkGreen","006400",[  0,100,0]],
[  "MediumAquamarine","66CDAA",[  102,205,170]],
[  "Aqua","00FFFF",[  0,255,255]],
[  "Cyan","00FFFF",[  0,255,255]],
[  "LightCyan","E0FFFF",[  224,255,255]],
[  "PaleTurquoise","AFEEEE",[  175,238,238]],
[  "Aquamarine","7FFFD4",[  127,255,212]],
[  "Turquoise","40E0D0",[  64,224,208]],
[  "MediumTurquoise","48D1CC",[  72,209,204]],
[  "DarkTurquoise","00CED1",[  0,206,209]],
[  "LightSeaGreen","20B2AA",[  32,178,170]],
[  "CadetBlue","5F9EA0",[  95,158,160]],
[  "DarkCyan","008B8B",[  0,139,139]],
[  "Teal","008080",[  0,128,128]],
[  "LightSteelBlue","B0C4DE",[  176,196,222]],
[  "PowderBlue","B0E0E6",[  176,224,230]],
[  "LightBlue","ADD8E6",[  173,216,230]],
[  "SkyBlue","87CEEB",[  135,206,235]],
[  "LightSkyBlue","87CEFA",[  135,206,250]],
[  "DeepSkyBlue","00BFFF",[  0,191,255]],
[  "DodgerBlue","1E90FF",[  30,144,255]],
[  "CornFlowerBlue","6495ED",[  100,149,237]],
[  "SteelBlue","4682B4",[  70,130,180]],
[  "RoyalBlue","4169E1",[  65,105,225]],
[  "Blue","0000FF",[  0,0,255]],
[  "MediumBlue","0000CD",[  0,0,205]],
[  "DarkBlue","00008B",[  0,0,139]],
[  "Navy","000080",[  0,0,128]],
[  "MidnightBlue","191970",[  25,25,112]],
[  "Lavender","E6E6FA",[  230,230,250]],
[  "Thistle","D8BFD8",[  216,191,216]],
[  "Plum","DDA0DD",[  221,160,221]],
[  "Violet","EE82EE",[  238,130,238]],
[  "Orchid","DA70D6",[  218,112,214]],
[  "Fuchsia","FF00FF",[  255,0,255]],
[  "Magenta","FF00FF",[  255,0,255]],
[  "MediumOrchid","BA55D3",[  186,85,211]],
[  "MediumPurple","9370DB",[  147,112,219]],
[  "BlueViolet","8A2BE2",[  138,43,226]],
[  "DarkViolet","9400D3",[  148,0,211]],
[  "DarkOrchid","9932CC",[  153,50,204]],
[  "DarkMagenta","8B008B",[  139,0,139]],
[  "Purple","800080",[  128,0,128]],
[  "Indigo","4B0082",[  75,0,130]],
[  "DarkSlateBlue","483D8B",[  72,61,139]],
[  "SlateBlue","6A5ACD",[  106,90,205]],
[  "MediumSlateBlue","7B68EE",[  123,104,238]],
[  "White","FFFFFF",[  255,255,255]],
[  "Snow","FFFAFA",[  255,250,250]],
[  "Honeydew","F0FFF0",[  240,255,240]],
[  "MintCream","F5FFFA",[  245,255,250]],
[  "Azure","F0FFFF",[  240,255,255]],
[  "AliceBlue","F0F8FF",[  240,248,255]],
[  "GhostWhite","F8F8FF",[  248,248,255]],
[  "WhiteSmoke","F5F5F5",[  245,245,245]],
[  "Seashell","FFF5EE",[  255,245,238]],
[  "Beige","F5F5DC",[  245,245,220]],
[  "OldLace","FDF5E6",[  253,245,230]],
[  "FloralWhite","FFFAF0",[  255,250,240]],
[  "Ivory","FFFFF0",[  255,255,240]],
[  "AntiqueWhite","FAEBD7",[  250,235,215]],
[  "Linen","FAF0E6",[  250,240,230]],
[  "LavenderBlush","FFF0F5",[  255,240,245]],
[  "MistyRose","FFE4E1",[  255,228,225]],
[  "Gainsboro","DCDCDC",[  220,220,220]],
[  "LightGrey","D3D3D3",[  211,211,211]],
[  "Silver","C0C0C0",[  192,192,192]],
[  "DarkGray","A9A9A9",[  169,169,169]],
[  "Gray","808080",[  128,128,128]],
[  "DimGray","696969",[  105,105,105]],
[  "LightSlateGray","778899",[  119,136,153]],
[  "SlateGray","708090",[  112,128,144]],
[  "DarkSlateGray","2F4F4F",[  47,79,79]],
[  "Black","000000",[  0,0,0]
    ]
        ];


  //  To calculate the web-safe values (0, 3, 6, 9, C and F), the integer values (0 to 255) are divided by 51, rounded to whole numbers and the multiplied with 3.
    //To calculate the short hex values (0 to 9 and A to F), the integer values (0 to 255)    are divided by 17 and then rounded to whole numbers.

    //To calculate the percentage values (0% to 100%), the integer values (0 to 255) are divided by 2.55 and then rounded to whole numbers.
    var Color=function(val){
        this.r=0;this.g=0;this.b=0;this.o=1;this.name=1;this.hex=1;
        this.parse.apply(this,arguments)

    }
    Color._masks={b:0xFF0000, g:0xFF00, r:0xFF};
    Color.prototype.parse=function parse(val){
        if(val==null){return null}
        if(arguments.length>=3) {
            this.fromArray([].slice.call(arguments))
        } else if(!isNaN(val)&& (+val)>=0){
                var m=Color._masks,bgrValue=+val
                this.b=Math.max(0,((bgrValue & m.b) >> 16))||0
                this.g=Math.max(0,((bgrValue & m.g) >> 8))||0
                this.r=Math.max(0,((bgrValue & m.r)))||0;

        } else if(typeof(val)=="string"){val=val.trim()
                if(val.indexOf("rgb")==0){
                    this.fromArray(val)
                } else{
                    if(val.indexOf("#")==0){val=val.substr(1)}
                    var lc=val.toLowerCase();
                    var rs=webcolors.filter(function(it){return it[0].toLowerCase()==lc||it[1].toLowerCase()==lc})[0]

                    if(rs){
                        this.r=rs[2][0];this.g=rs[2][1];this.b=rs[2][2]
                        this.name=rs[0]
                        this.hex=rs[1]
                    }
                    else if(val && /^[0-9a-f]+$/i.test(val)){
                        var r,g,b,arr=[];
                        if (String(val).length == 3){arr=String(val).split("");
                            arr =[arr[0]+arr[0],arr[1]+arr[1],arr[2]+arr[2]];
                        } else {
                            arr =String(val).match(/[0-9a-f]{2}/ig)||[]
                        }
                        this.r = parseInt(arr[0], 16);  this.g = parseInt(arr[1], 16); this.b = parseInt(arr[2], 16);
                        if(arr[3]!=null){this.o=arr[3]}

                    }
                }
            }  else if(val && val.length&&val.length>=3){
                this.fromArray(val)
            }else if(val && typeof(val)=="object"){
                this.fromArray([val.r,val.g,val.b])
            }

    }
    Color.prototype.fromArray=function fromArray(arr0) {
        var arr=arr0.map(Number)
        this.r= arr[0]
        this.g= arr[1]
        this.b= arr[2]
        if(arr[3]!=null){this.o=arr[3]}
    }
    Color.prototype.toRgb=function toRgb(hex_string) {
        return "rgb("+([this.r,this.g,this.b].join(","))+")"
    }
    Color.prototype.fromNumber=function toNumber(num) {
        var m=Color._masks
        this.b=((bgrValue & m.b) >> 16)
        this.g=((bgrValue & m.g) >> 8)
        this.r=((bgrValue & m.r));
        return this

    }
    Color.prototype.getColorName=function getColorName() {
        var hex
        if(!this.name){
              hex=this.toHex(false);
            this.name = webcolors.filter(function(it){return it[1]==hex})[0]
        }
        return this.name==1?"":this.name;
    }
    Color.prototype.sub=Color.prototype.minus=function minus(val,mutate) {
        if(mutate){
            this.parse(this.toNumber()-Color.from(val).toNumber())
        }
        return Color.from(this.toNumber()-Color.from(val).toNumber())
    }
    Color.prototype.toString= function() {
        return JSON.stringify(this.toMap())
    }
    Color.prototype.toMap= function() {
        return {r:this.r,g:this.g,b:this.b};
    }
    Color.prototype.plus=Color.prototype.add=function add(val,mutate) {
        if(mutate){
              this.parse(Color.from(val).toNumber()+this.toNumber())
        }
        return Color.from(Color.from(val).toNumber()+this.toNumber())
    }
    Color.prototype.toNumber=function toNumber() {
        if(this.r){
            return  (this.b << 16) + (this.g << 8) + r;
        }
     }
    Color.prototype.valueOf=function valueOf() {
        return this.toNumber();
    }
    Color.prototype.toHex=function toHex(includeHash) {
        var hex = this.hex
        if (!hex || hex === 1) {
            hex = [(this.r || 0  ).toString(16), (this.g  || 0).toString(16), (this.b||0).toString(16)].map(function (r) {
                return (r.length == 1 ? "0" : "") + r
            }).join("");
        }
        return (((includeHash||includeHash===undefined) ? '#' : '') + hex ).toUpperCase();
    }
    Color.from=function(val){
        if(!val){return new Color()}
        return new Color(val)
    }
    var inst=null
    Color.colorPicker= ColorPicker
    Color.names=webcolors.reduce(function(m,k){m[k[0]]=k[1];return m},{});
    Color.webcolors=webcolors
    var _addNamedColorRulesadded=0
    Color.isNamedColor=function(k){
        return Color.getNamedColorMap()[String(k).toLowerCase()]

    }
    var _namedColorMap=null
    Color.getNamedColorMap=function(){
        if(!_namedColorMap) {
            _namedColorMap = {}
            webcolors.forEach(function (it) {
                if (!(it[0] && typeof(it[0]) == "string")) {
                    return
                }
                var k = it[0]
                _namedColorMap[k.toLowerCase()] = {hex: "#" + it[1], rgb: it[2]}
                if (k.indexOf("gray") >= 0) {
                    _namedColorMap[k.replace( "gray","grey").toLowerCase()] = {hex: "#" + it[1], rgb: it[2]}
                }
            })
        }
        return _namedColorMap
    }
    Color.addNamedColorRules=function(){
        if(_addNamedColorRulesadded){return}
        var m =Color.getNamedColorMap() ,map={}
        Object.keys(m).forEach(function(it){
            var k=it.toLowerCase().trim()
            map["color_"+k]=m[it].hex
        })
        webcolors.forEach(function(it){
            var k=String(it[0]).trim().replace(/\W+/g,"_").toLowerCase().trim()
            if(!map["color_"+k]){map["color_"+k.toLowerCase()]="#"+it[1]}
        })

        $d.css.addRules("webcolors",map)

        _addNamedColorRulesadded=1
    }
    ColorPicker.Color=Color
    try{
        $.Color=Color;
    } catch(e){}

module.exports=ColorPicker
}
__bootstrap__.modules["QRCode"] = function(module){
/**
 * Created by Atul on 7/13/2015.
 */
/**
 * @fileoverview
 * - Using the 'QRCode for Javascript library'
 * - Fixed dataset of 'QRCode for Javascript library' for support full-spec.
 * - this library has no dependencies.
 *
 * @author davidshimjs
 * @see <a href="http://www.d-project.com/" target="_blank">http://www.d-project.com/</a>
 * @see <a href="http://jeromeetienne.github.com/jquery-qrcode/" target="_blank">http://jeromeetienne.github.com/jquery-qrcode/</a>
 */
var QRCode;

//(function () {
	//---------------------------------------------------------------------
	// QRCode for JavaScript
	//
	// Copyright (c) 2009 Kazuhiko Arase
	//
	// URL: http://www.d-project.com/
	//
	// Licensed under the MIT license:
	//   http://www.opensource.org/licenses/mit-license.php
	//
	// The word "QR Code" is registered trademark of 
	// DENSO WAVE INCORPORATED
	//   http://www.denso-wave.com/qrcode/faqpatent-e.html
	//
	//---------------------------------------------------------------------
	function QR8bitByte(data) {
		this.mode = QRMode.MODE_8BIT_BYTE;
		this.data = data;
		this.parsedData = [];

		// Added to support UTF-8 Characters
		for (var i = 0, l = this.data.length; i < l; i++) {
			var byteArray = [];
			var code = this.data.charCodeAt(i);

			if (code > 0x10000) {
				byteArray[0] = 0xF0 | ((code & 0x1C0000) >>> 18);
				byteArray[1] = 0x80 | ((code & 0x3F000) >>> 12);
				byteArray[2] = 0x80 | ((code & 0xFC0) >>> 6);
				byteArray[3] = 0x80 | (code & 0x3F);
			} else if (code > 0x800) {
				byteArray[0] = 0xE0 | ((code & 0xF000) >>> 12);
				byteArray[1] = 0x80 | ((code & 0xFC0) >>> 6);
				byteArray[2] = 0x80 | (code & 0x3F);
			} else if (code > 0x80) {
				byteArray[0] = 0xC0 | ((code & 0x7C0) >>> 6);
				byteArray[1] = 0x80 | (code & 0x3F);
			} else {
				byteArray[0] = code;
			}

			this.parsedData.push(byteArray);
		}

		this.parsedData = Array.prototype.concat.apply([], this.parsedData);

		if (this.parsedData.length != this.data.length) {
			this.parsedData.unshift(191);
			this.parsedData.unshift(187);
			this.parsedData.unshift(239);
		}
	}

	QR8bitByte.prototype = {
		getLength: function (buffer) {
			return this.parsedData.length;
		},
		write: function (buffer) {
			for (var i = 0, l = this.parsedData.length; i < l; i++) {
				buffer.put(this.parsedData[i], 8);
			}
		}
	};

	function QRCodeModel(typeNumber, errorCorrectLevel) {
		this.typeNumber = typeNumber;
		this.errorCorrectLevel = errorCorrectLevel;
		this.modules = null;
		this.moduleCount = 0;
		this.dataCache = null;
		this.dataList = [];
	}

	QRCodeModel.prototype = {
		addData: function (data) {
			var newData = new QR8bitByte(data);
			this.dataList.push(newData);
			this.dataCache = null;
		}, isDark: function (row, col) {
			if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) {
				throw new Error(row + "," + col);
			}
			return this.modules[row][col];
		}, getModuleCount: function () {
			return this.moduleCount;
		}, make: function () {
			this.makeImpl(false, this.getBestMaskPattern());
		}, makeImpl: function (test, maskPattern) {
			this.moduleCount = this.typeNumber * 4 + 17;
			this.modules = new Array(this.moduleCount);
			for (var row = 0; row < this.moduleCount; row++) {
				this.modules[row] = new Array(this.moduleCount);
				for (var col = 0; col < this.moduleCount; col++) {
					this.modules[row][col] = null;
				}
			}
			this.setupPositionProbePattern(0, 0);
			this.setupPositionProbePattern(this.moduleCount - 7, 0);
			this.setupPositionProbePattern(0, this.moduleCount - 7);
			this.setupPositionAdjustPattern();
			this.setupTimingPattern();
			this.setupTypeInfo(test, maskPattern);
			if (this.typeNumber >= 7) {
				this.setupTypeNumber(test);
			}
			if (this.dataCache == null) {
				this.dataCache = QRCodeModel.createData(this.typeNumber, this.errorCorrectLevel, this.dataList);
			}
			this.mapData(this.dataCache, maskPattern);
		}, setupPositionProbePattern: function (row, col) {
			for (var r = -1; r <= 7; r++) {
				if (row + r <= -1 || this.moduleCount <= row + r)continue;
				for (var c = -1; c <= 7; c++) {
					if (col + c <= -1 || this.moduleCount <= col + c)continue;
					if ((0 <= r && r <= 6 && (c == 0 || c == 6)) || (0 <= c && c <= 6 && (r == 0 || r == 6)) || (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
						this.modules[row + r][col + c] = true;
					} else {
						this.modules[row + r][col + c] = false;
					}
				}
			}
		},
		  getBestMaskPattern: function () {
			var minLostPoint = 0;
			var pattern = 0;
			for (var i = 0; i < 8; i++) {
				this.makeImpl(true, i);
				var lostPoint = QRUtil.getLostPoint(this);
				if (i == 0 || minLostPoint > lostPoint) {
					minLostPoint = lostPoint;
					pattern = i;
				}
			}
			return pattern;
		},
		createMovieClip: function (target_mc, instance_name, depth) {
			var qr_mc = target_mc.createEmptyMovieClip(instance_name, depth);
			var cs = 1;
			this.make();
			for (var row = 0; row < this.modules.length; row++) {
				var y = row * cs;
				for (var col = 0; col < this.modules[row].length; col++) {
					var x = col * cs;
					var dark = this.modules[row][col];
					if (dark) {
						qr_mc.beginFill(0, 100);
						qr_mc.moveTo(x, y);
						qr_mc.lineTo(x + cs, y);
						qr_mc.lineTo(x + cs, y + cs);
						qr_mc.lineTo(x, y + cs);
						qr_mc.endFill();
					}
				}
			}
			return qr_mc;
		},
		setupTimingPattern: function () {
			for (var r = 8; r < this.moduleCount - 8; r++) {
				if (this.modules[r][6] != null) {
					continue;
				}
				this.modules[r][6] = (r % 2 == 0);
			}
			for (var c = 8; c < this.moduleCount - 8; c++) {
				if (this.modules[6][c] != null) {
					continue;
				}
				this.modules[6][c] = (c % 2 == 0);
			}
		},
		setupPositionAdjustPattern: function () {
			var pos = QRUtil.getPatternPosition(this.typeNumber);
			for (var i = 0; i < pos.length; i++) {
				for (var j = 0; j < pos.length; j++) {
					var row = pos[i];
					var col = pos[j];
					if (this.modules[row][col] != null) {
						continue;
					}
					for (var r = -2; r <= 2; r++) {
						for (var c = -2; c <= 2; c++) {
							if (r == -2 || r == 2 || c == -2 || c == 2 || (r == 0 && c == 0)) {
								this.modules[row + r][col + c] = true;
							} else {
								this.modules[row + r][col + c] = false;
							}
						}
					}
				}
			}
		},
		setupTypeNumber: function (test) {
			var bits = QRUtil.getBCHTypeNumber(this.typeNumber);
			for (var i = 0; i < 18; i++) {
				var mod = (!test && ((bits >> i) & 1) == 1);
				this.modules[Math.floor(i / 3)][i % 3 + this.moduleCount - 8 - 3] = mod;
			}
			for (var i = 0; i < 18; i++) {
				var mod = (!test && ((bits >> i) & 1) == 1);
				this.modules[i % 3 + this.moduleCount - 8 - 3][Math.floor(i / 3)] = mod;
			}
		},
		setupTypeInfo: function (test, maskPattern) {
			var data = (this.errorCorrectLevel << 3) | maskPattern;
			var bits = QRUtil.getBCHTypeInfo(data);
			for (var i = 0; i < 15; i++) {
				var mod = (!test && ((bits >> i) & 1) == 1);
				if (i < 6) {
					this.modules[i][8] = mod;
				} else if (i < 8) {
					this.modules[i + 1][8] = mod;
				} else {
					this.modules[this.moduleCount - 15 + i][8] = mod;
				}
			}
			for (var i = 0; i < 15; i++) {
				var mod = (!test && ((bits >> i) & 1) == 1);
				if (i < 8) {
					this.modules[8][this.moduleCount - i - 1] = mod;
				} else if (i < 9) {
					this.modules[8][15 - i - 1 + 1] = mod;
				} else {
					this.modules[8][15 - i - 1] = mod;
				}
			}
			this.modules[this.moduleCount - 8][8] = (!test);
		},
		mapData: function (data, maskPattern) {
			var inc = -1;
			var row = this.moduleCount - 1;
			var bitIndex = 7;
			var byteIndex = 0;
			for (var col = this.moduleCount - 1; col > 0; col -= 2) {
				if (col == 6)col--;
				while (true) {
					for (var c = 0; c < 2; c++) {
						if (this.modules[row][col - c] == null) {
							var dark = false;
							if (byteIndex < data.length) {
								dark = (((data[byteIndex] >>> bitIndex) & 1) == 1);
							}
							var mask = QRUtil.getMask(maskPattern, row, col - c);
							if (mask) {
								dark = !dark;
							}
							this.modules[row][col - c] = dark;
							bitIndex--;
							if (bitIndex == -1) {
								byteIndex++;
								bitIndex = 7;
							}
						}
					}
					row += inc;
					if (row < 0 || this.moduleCount <= row) {
						row -= inc;
						inc = -inc;
						break;
					}
				}
			}
		}
	};
	QRCodeModel.PAD0 = 0xEC;
	QRCodeModel.PAD1 = 0x11;
	QRCodeModel.createData = function (typeNumber, errorCorrectLevel, dataList) {
		var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, errorCorrectLevel);
		var buffer = new QRBitBuffer();
		for (var i = 0; i < dataList.length; i++) {
			var data = dataList[i];
			buffer.put(data.mode, 4);
			buffer.put(data.getLength(), QRUtil.getLengthInBits(data.mode, typeNumber));
			data.write(buffer);
		}
		var totalDataCount = 0;
		for (var i = 0; i < rsBlocks.length; i++) {
			totalDataCount += rsBlocks[i].dataCount;
		}
		if (buffer.getLengthInBits() > totalDataCount * 8) {
			throw new Error("code length overflow. ("
				+ buffer.getLengthInBits()
				+ ">"
				+ totalDataCount * 8
				+ ")");
		}
		if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) {
			buffer.put(0, 4);
		}
		while (buffer.getLengthInBits() % 8 != 0) {
			buffer.putBit(false);
		}
		while (true) {
			if (buffer.getLengthInBits() >= totalDataCount * 8) {
				break;
			}
			buffer.put(QRCodeModel.PAD0, 8);
			if (buffer.getLengthInBits() >= totalDataCount * 8) {
				break;
			}
			buffer.put(QRCodeModel.PAD1, 8);
		}
		return QRCodeModel.createBytes(buffer, rsBlocks);
	};
	QRCodeModel.createBytes = function (buffer, rsBlocks) {
		var offset = 0;
		var maxDcCount = 0;
		var maxEcCount = 0;
		var dcdata = new Array(rsBlocks.length);
		var ecdata = new Array(rsBlocks.length);
		for (var r = 0; r < rsBlocks.length; r++) {
			var dcCount = rsBlocks[r].dataCount;
			var ecCount = rsBlocks[r].totalCount - dcCount;
			maxDcCount = Math.max(maxDcCount, dcCount);
			maxEcCount = Math.max(maxEcCount, ecCount);
			dcdata[r] = new Array(dcCount);
			for (var i = 0; i < dcdata[r].length; i++) {
				dcdata[r][i] = 0xff & buffer.buffer[i + offset];
			}
			offset += dcCount;
			var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount);
			var rawPoly = new QRPolynomial(dcdata[r], rsPoly.getLength() - 1);
			var modPoly = rawPoly.mod(rsPoly);
			ecdata[r] = new Array(rsPoly.getLength() - 1);
			for (var i = 0; i < ecdata[r].length; i++) {
				var modIndex = i + modPoly.getLength() - ecdata[r].length;
				ecdata[r][i] = (modIndex >= 0) ? modPoly.get(modIndex) : 0;
			}
		}
		var totalCodeCount = 0;
		for (var i = 0; i < rsBlocks.length; i++) {
			totalCodeCount += rsBlocks[i].totalCount;
		}
		var data = new Array(totalCodeCount);
		var index = 0;
		for (var i = 0; i < maxDcCount; i++) {
			for (var r = 0; r < rsBlocks.length; r++) {
				if (i < dcdata[r].length) {
					data[index++] = dcdata[r][i];
				}
			}
		}
		for (var i = 0; i < maxEcCount; i++) {
			for (var r = 0; r < rsBlocks.length; r++) {
				if (i < ecdata[r].length) {
					data[index++] = ecdata[r][i];
				}
			}
		}
		return data;
	};
	var QRMode = {MODE_NUMBER: 1 << 0, MODE_ALPHA_NUM: 1 << 1, MODE_8BIT_BYTE: 1 << 2, MODE_KANJI: 1 << 3};
	var QRErrorCorrectLevel = {L: 1, M: 0, Q: 3, H: 2};
	var QRMaskPattern = {
		PATTERN000: 0,
		PATTERN001: 1,
		PATTERN010: 2,
		PATTERN011: 3,
		PATTERN100: 4,
		PATTERN101: 5,
		PATTERN110: 6,
		PATTERN111: 7
	};
	var QRUtil = {
		PATTERN_POSITION_TABLE: [[], [6, 18], [6, 22], [6, 26], [6, 30], [6, 34], [6, 22, 38], [6, 24, 42], [6, 26, 46], [6, 28, 50], [6, 30, 54], [6, 32, 58], [6, 34, 62], [6, 26, 46, 66], [6, 26, 48, 70], [6, 26, 50, 74], [6, 30, 54, 78], [6, 30, 56, 82], [6, 30, 58, 86], [6, 34, 62, 90], [6, 28, 50, 72, 94], [6, 26, 50, 74, 98], [6, 30, 54, 78, 102], [6, 28, 54, 80, 106], [6, 32, 58, 84, 110], [6, 30, 58, 86, 114], [6, 34, 62, 90, 118], [6, 26, 50, 74, 98, 122], [6, 30, 54, 78, 102, 126], [6, 26, 52, 78, 104, 130], [6, 30, 56, 82, 108, 134], [6, 34, 60, 86, 112, 138], [6, 30, 58, 86, 114, 142], [6, 34, 62, 90, 118, 146], [6, 30, 54, 78, 102, 126, 150], [6, 24, 50, 76, 102, 128, 154], [6, 28, 54, 80, 106, 132, 158], [6, 32, 58, 84, 110, 136, 162], [6, 26, 54, 82, 110, 138, 166], [6, 30, 58, 86, 114, 142, 170]],
		G15: (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0),
		G18: (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0),
		G15_MASK: (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1),
		getBCHTypeInfo: function (data) {
			var d = data << 10;
			while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15) >= 0) {
				d ^= (QRUtil.G15 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15)));
			}
			return ((data << 10) | d) ^ QRUtil.G15_MASK;
		},
		getBCHTypeNumber: function (data) {
			var d = data << 12;
			while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18) >= 0) {
				d ^= (QRUtil.G18 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18)));
			}
			return (data << 12) | d;
		},
		getBCHDigit: function (data) {
			var digit = 0;
			while (data != 0) {
				digit++;
				data >>>= 1;
			}
			return digit;
		},
		getPatternPosition: function (typeNumber) {
			return QRUtil.PATTERN_POSITION_TABLE[typeNumber - 1];
		},
		getMask: function (maskPattern, i, j) {
			switch (maskPattern) {
				case QRMaskPattern.PATTERN000:
					return (i + j) % 2 == 0;
				case QRMaskPattern.PATTERN001:
					return i % 2 == 0;
				case QRMaskPattern.PATTERN010:
					return j % 3 == 0;
				case QRMaskPattern.PATTERN011:
					return (i + j) % 3 == 0;
				case QRMaskPattern.PATTERN100:
					return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;
				case QRMaskPattern.PATTERN101:
					return (i * j) % 2 + (i * j) % 3 == 0;
				case QRMaskPattern.PATTERN110:
					return ((i * j) % 2 + (i * j) % 3) % 2 == 0;
				case QRMaskPattern.PATTERN111:
					return ((i * j) % 3 + (i + j) % 2) % 2 == 0;
				default:
					throw new Error("bad maskPattern:" + maskPattern);
			}
		},
		getErrorCorrectPolynomial: function (errorCorrectLength) {
			var a = new QRPolynomial([1], 0);
			for (var i = 0; i < errorCorrectLength; i++) {
				a = a.multiply(new QRPolynomial([1, QRMath.gexp(i)], 0));
			}
			return a;
		},
		getLengthInBits: function (mode, type) {
			if (1 <= type && type < 10) {
				switch (mode) {
					case QRMode.MODE_NUMBER:
						return 10;
					case QRMode.MODE_ALPHA_NUM:
						return 9;
					case QRMode.MODE_8BIT_BYTE:
						return 8;
					case QRMode.MODE_KANJI:
						return 8;
					default:
						throw new Error("mode:" + mode);
				}
			} else if (type < 27) {
				switch (mode) {
					case QRMode.MODE_NUMBER:
						return 12;
					case QRMode.MODE_ALPHA_NUM:
						return 11;
					case QRMode.MODE_8BIT_BYTE:
						return 16;
					case QRMode.MODE_KANJI:
						return 10;
					default:
						throw new Error("mode:" + mode);
				}
			} else if (type < 41) {
				switch (mode) {
					case QRMode.MODE_NUMBER:
						return 14;
					case QRMode.MODE_ALPHA_NUM:
						return 13;
					case QRMode.MODE_8BIT_BYTE:
						return 16;
					case QRMode.MODE_KANJI:
						return 12;
					default:
						throw new Error("mode:" + mode);
				}
			} else {
				throw new Error("type:" + type);
			}
		},
		getLostPoint: function (qrCode) {
			var moduleCount = qrCode.getModuleCount();
			var lostPoint = 0;
			for (var row = 0; row < moduleCount; row++) {
				for (var col = 0; col < moduleCount; col++) {
					var sameCount = 0;
					var dark = qrCode.isDark(row, col);
					for (var r = -1; r <= 1; r++) {
						if (row + r < 0 || moduleCount <= row + r) {
							continue;
						}
						for (var c = -1; c <= 1; c++) {
							if (col + c < 0 || moduleCount <= col + c) {
								continue;
							}
							if (r == 0 && c == 0) {
								continue;
							}
							if (dark == qrCode.isDark(row + r, col + c)) {
								sameCount++;
							}
						}
					}
					if (sameCount > 5) {
						lostPoint += (3 + sameCount - 5);
					}
				}
			}
			for (var row = 0; row < moduleCount - 1; row++) {
				for (var col = 0; col < moduleCount - 1; col++) {
					var count = 0;
					if (qrCode.isDark(row, col))count++;
					if (qrCode.isDark(row + 1, col))count++;
					if (qrCode.isDark(row, col + 1))count++;
					if (qrCode.isDark(row + 1, col + 1))count++;
					if (count == 0 || count == 4) {
						lostPoint += 3;
					}
				}
			}
			for (var row = 0; row < moduleCount; row++) {
				for (var col = 0; col < moduleCount - 6; col++) {
					if (qrCode.isDark(row, col) && !qrCode.isDark(row, col + 1) && qrCode.isDark(row, col + 2) && qrCode.isDark(row, col + 3) && qrCode.isDark(row, col + 4) && !qrCode.isDark(row, col + 5) && qrCode.isDark(row, col + 6)) {
						lostPoint += 40;
					}
				}
			}
			for (var col = 0; col < moduleCount; col++) {
				for (var row = 0; row < moduleCount - 6; row++) {
					if (qrCode.isDark(row, col) && !qrCode.isDark(row + 1, col) && qrCode.isDark(row + 2, col) && qrCode.isDark(row + 3, col) && qrCode.isDark(row + 4, col) && !qrCode.isDark(row + 5, col) && qrCode.isDark(row + 6, col)) {
						lostPoint += 40;
					}
				}
			}
			var darkCount = 0;
			for (var col = 0; col < moduleCount; col++) {
				for (var row = 0; row < moduleCount; row++) {
					if (qrCode.isDark(row, col)) {
						darkCount++;
					}
				}
			}
			var ratio = Math.abs(100 * darkCount / moduleCount / moduleCount - 50) / 5;
			lostPoint += ratio * 10;
			return lostPoint;
		}
	};
	var QRMath = {
		glog: function (n) {
			if (n < 1) {
				throw new Error("glog(" + n + ")");
			}
			return QRMath.LOG_TABLE[n];
		},
		gexp: function (n) {
			while (n < 0) {
				n += 255;
			}
			while (n >= 256) {
				n -= 255;
			}
			return QRMath.EXP_TABLE[n];
		},
		EXP_TABLE: new Array(256), LOG_TABLE: new Array(256)
	};
	for (var i = 0; i < 8; i++) {
		QRMath.EXP_TABLE[i] = 1 << i;
	}
	for (var i = 8; i < 256; i++) {
		QRMath.EXP_TABLE[i] = QRMath.EXP_TABLE[i - 4] ^ QRMath.EXP_TABLE[i - 5] ^ QRMath.EXP_TABLE[i - 6] ^ QRMath.EXP_TABLE[i - 8];
	}
	for (var i = 0; i < 255; i++) {
		QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]] = i;
	}
	function QRPolynomial(num, shift) {
		if (num.length == undefined) {
			throw new Error(num.length + "/" + shift);
		}
		var offset = 0;
		while (offset < num.length && num[offset] == 0) {
			offset++;
		}
		this.num = new Array(num.length - offset + shift);
		for (var i = 0; i < num.length - offset; i++) {
			this.num[i] = num[i + offset];
		}
	}

	QRPolynomial.prototype = {
		get: function (index) {
			return this.num[index];
		},
		getLength: function () {
			return this.num.length;
		},
		multiply: function (e) {
			var num = new Array(this.getLength() + e.getLength() - 1);
			for (var i = 0; i < this.getLength(); i++) {
				for (var j = 0; j < e.getLength(); j++) {
					num[i + j] ^= QRMath.gexp(QRMath.glog(this.get(i)) + QRMath.glog(e.get(j)));
				}
			}
			return new QRPolynomial(num, 0);
		},
		mod: function (e) {
			if (this.getLength() - e.getLength() < 0) {
				return this;
			}
			var ratio = QRMath.glog(this.get(0)) - QRMath.glog(e.get(0));
			var num = new Array(this.getLength());
			for (var i = 0; i < this.getLength(); i++) {
				num[i] = this.get(i);
			}
			for (var i = 0; i < e.getLength(); i++) {
				num[i] ^= QRMath.gexp(QRMath.glog(e.get(i)) + ratio);
			}
			return new QRPolynomial(num, 0).mod(e);
		}
	};
	function QRRSBlock(totalCount, dataCount) {
		this.totalCount = totalCount;
		this.dataCount = dataCount;
	}

	QRRSBlock.RS_BLOCK_TABLE = [[1, 26, 19], [1, 26, 16], [1, 26, 13], [1, 26, 9], [1, 44, 34], [1, 44, 28], [1, 44, 22], [1, 44, 16], [1, 70, 55], [1, 70, 44], [2, 35, 17], [2, 35, 13], [1, 100, 80], [2, 50, 32], [2, 50, 24], [4, 25, 9], [1, 134, 108], [2, 67, 43], [2, 33, 15, 2, 34, 16], [2, 33, 11, 2, 34, 12], [2, 86, 68], [4, 43, 27], [4, 43, 19], [4, 43, 15], [2, 98, 78], [4, 49, 31], [2, 32, 14, 4, 33, 15], [4, 39, 13, 1, 40, 14], [2, 121, 97], [2, 60, 38, 2, 61, 39], [4, 40, 18, 2, 41, 19], [4, 40, 14, 2, 41, 15], [2, 146, 116], [3, 58, 36, 2, 59, 37], [4, 36, 16, 4, 37, 17], [4, 36, 12, 4, 37, 13], [2, 86, 68, 2, 87, 69], [4, 69, 43, 1, 70, 44], [6, 43, 19, 2, 44, 20], [6, 43, 15, 2, 44, 16], [4, 101, 81], [1, 80, 50, 4, 81, 51], [4, 50, 22, 4, 51, 23], [3, 36, 12, 8, 37, 13], [2, 116, 92, 2, 117, 93], [6, 58, 36, 2, 59, 37], [4, 46, 20, 6, 47, 21], [7, 42, 14, 4, 43, 15], [4, 133, 107], [8, 59, 37, 1, 60, 38], [8, 44, 20, 4, 45, 21], [12, 33, 11, 4, 34, 12], [3, 145, 115, 1, 146, 116], [4, 64, 40, 5, 65, 41], [11, 36, 16, 5, 37, 17], [11, 36, 12, 5, 37, 13], [5, 109, 87, 1, 110, 88], [5, 65, 41, 5, 66, 42], [5, 54, 24, 7, 55, 25], [11, 36, 12], [5, 122, 98, 1, 123, 99], [7, 73, 45, 3, 74, 46], [15, 43, 19, 2, 44, 20], [3, 45, 15, 13, 46, 16], [1, 135, 107, 5, 136, 108], [10, 74, 46, 1, 75, 47], [1, 50, 22, 15, 51, 23], [2, 42, 14, 17, 43, 15], [5, 150, 120, 1, 151, 121], [9, 69, 43, 4, 70, 44], [17, 50, 22, 1, 51, 23], [2, 42, 14, 19, 43, 15], [3, 141, 113, 4, 142, 114], [3, 70, 44, 11, 71, 45], [17, 47, 21, 4, 48, 22], [9, 39, 13, 16, 40, 14], [3, 135, 107, 5, 136, 108], [3, 67, 41, 13, 68, 42], [15, 54, 24, 5, 55, 25], [15, 43, 15, 10, 44, 16], [4, 144, 116, 4, 145, 117], [17, 68, 42], [17, 50, 22, 6, 51, 23], [19, 46, 16, 6, 47, 17], [2, 139, 111, 7, 140, 112], [17, 74, 46], [7, 54, 24, 16, 55, 25], [34, 37, 13], [4, 151, 121, 5, 152, 122], [4, 75, 47, 14, 76, 48], [11, 54, 24, 14, 55, 25], [16, 45, 15, 14, 46, 16], [6, 147, 117, 4, 148, 118], [6, 73, 45, 14, 74, 46], [11, 54, 24, 16, 55, 25], [30, 46, 16, 2, 47, 17], [8, 132, 106, 4, 133, 107], [8, 75, 47, 13, 76, 48], [7, 54, 24, 22, 55, 25], [22, 45, 15, 13, 46, 16], [10, 142, 114, 2, 143, 115], [19, 74, 46, 4, 75, 47], [28, 50, 22, 6, 51, 23], [33, 46, 16, 4, 47, 17], [8, 152, 122, 4, 153, 123], [22, 73, 45, 3, 74, 46], [8, 53, 23, 26, 54, 24], [12, 45, 15, 28, 46, 16], [3, 147, 117, 10, 148, 118], [3, 73, 45, 23, 74, 46], [4, 54, 24, 31, 55, 25], [11, 45, 15, 31, 46, 16], [7, 146, 116, 7, 147, 117], [21, 73, 45, 7, 74, 46], [1, 53, 23, 37, 54, 24], [19, 45, 15, 26, 46, 16], [5, 145, 115, 10, 146, 116], [19, 75, 47, 10, 76, 48], [15, 54, 24, 25, 55, 25], [23, 45, 15, 25, 46, 16], [13, 145, 115, 3, 146, 116], [2, 74, 46, 29, 75, 47], [42, 54, 24, 1, 55, 25], [23, 45, 15, 28, 46, 16], [17, 145, 115], [10, 74, 46, 23, 75, 47], [10, 54, 24, 35, 55, 25], [19, 45, 15, 35, 46, 16], [17, 145, 115, 1, 146, 116], [14, 74, 46, 21, 75, 47], [29, 54, 24, 19, 55, 25], [11, 45, 15, 46, 46, 16], [13, 145, 115, 6, 146, 116], [14, 74, 46, 23, 75, 47], [44, 54, 24, 7, 55, 25], [59, 46, 16, 1, 47, 17], [12, 151, 121, 7, 152, 122], [12, 75, 47, 26, 76, 48], [39, 54, 24, 14, 55, 25], [22, 45, 15, 41, 46, 16], [6, 151, 121, 14, 152, 122], [6, 75, 47, 34, 76, 48], [46, 54, 24, 10, 55, 25], [2, 45, 15, 64, 46, 16], [17, 152, 122, 4, 153, 123], [29, 74, 46, 14, 75, 47], [49, 54, 24, 10, 55, 25], [24, 45, 15, 46, 46, 16], [4, 152, 122, 18, 153, 123], [13, 74, 46, 32, 75, 47], [48, 54, 24, 14, 55, 25], [42, 45, 15, 32, 46, 16], [20, 147, 117, 4, 148, 118], [40, 75, 47, 7, 76, 48], [43, 54, 24, 22, 55, 25], [10, 45, 15, 67, 46, 16], [19, 148, 118, 6, 149, 119], [18, 75, 47, 31, 76, 48], [34, 54, 24, 34, 55, 25], [20, 45, 15, 61, 46, 16]];
	QRRSBlock.getRSBlocks = function (typeNumber, errorCorrectLevel) {
		var rsBlock = QRRSBlock.getRsBlockTable(typeNumber, errorCorrectLevel);
		if (rsBlock == undefined) {
			throw new Error("bad rs block @ typeNumber:" + typeNumber + "/errorCorrectLevel:" + errorCorrectLevel);
		}
		var length = rsBlock.length / 3;
		var list = [];
		for (var i = 0; i < length; i++) {
			var count = rsBlock[i * 3 + 0];
			var totalCount = rsBlock[i * 3 + 1];
			var dataCount = rsBlock[i * 3 + 2];
			for (var j = 0; j < count; j++) {
				list.push(new QRRSBlock(totalCount, dataCount));
			}
		}
		return list;
	};
	QRRSBlock.getRsBlockTable = function (typeNumber, errorCorrectLevel) {
		switch (errorCorrectLevel) {
			case QRErrorCorrectLevel.L:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 0];
			case QRErrorCorrectLevel.M:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 1];
			case QRErrorCorrectLevel.Q:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 2];
			case QRErrorCorrectLevel.H:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 3];
			default:
				return undefined;
		}
	};
	function QRBitBuffer() {
		this.buffer = [];
		this.length = 0;
	}

	QRBitBuffer.prototype = {
		get: function (index) {
			var bufIndex = Math.floor(index / 8);
			return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) == 1;
		},
		put: function (num, length) {
			for (var i = 0; i < length; i++) {
				this.putBit(((num >>> (length - i - 1)) & 1) == 1);
			}
		},
		getLengthInBits: function () {
			return this.length;
		},
		putBit: function (bit) {
			var bufIndex = Math.floor(this.length / 8);
			if (this.buffer.length <= bufIndex) {
				this.buffer.push(0);
			}
			if (bit) {
				this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
			}
			this.length++;
		}
	};
	var QRCodeLimitLength = [[17, 14, 11, 7], [32, 26, 20, 14], [53, 42, 32, 24], [78, 62, 46, 34], [106, 84, 60, 44], [134, 106, 74, 58], [154, 122, 86, 64], [192, 152, 108, 84], [230, 180, 130, 98], [271, 213, 151, 119], [321, 251, 177, 137], [367, 287, 203, 155], [425, 331, 241, 177], [458, 362, 258, 194], [520, 412, 292, 220], [586, 450, 322, 250], [644, 504, 364, 280], [718, 560, 394, 310], [792, 624, 442, 338], [858, 666, 482, 382], [929, 711, 509, 403], [1003, 779, 565, 439], [1091, 857, 611, 461], [1171, 911, 661, 511], [1273, 997, 715, 535], [1367, 1059, 751, 593], [1465, 1125, 805, 625], [1528, 1190, 868, 658], [1628, 1264, 908, 698], [1732, 1370, 982, 742], [1840, 1452, 1030, 790], [1952, 1538, 1112, 842], [2068, 1628, 1168, 898], [2188, 1722, 1228, 958], [2303, 1809, 1283, 983], [2431, 1911, 1351, 1051], [2563, 1989, 1423, 1093], [2699, 2099, 1499, 1139], [2809, 2213, 1579, 1219], [2953, 2331, 1663, 1273]];

	function _isSupportCanvas() {
		return typeof CanvasRenderingContext2D != "undefined";
	}

	// android 2.x doesn't support Data-URI spec
	function _getAndroid() {
		var android = false;
		var sAgent = navigator.userAgent;

		if (/android/i.test(sAgent)) { // android
			android = true;
			var aMat = sAgent.toString().match(/android ([0-9]\.[0-9])/i);

			if (aMat && aMat[1]) {
				android = parseFloat(aMat[1]);
			}
		}

		return android;
	}

	var svgDrawer = (function() {

		var Drawing = function (el, htOption) {
			this._el = el;
			this._htOption = htOption;
		};

		Drawing.prototype.draw = function (oQRCode) {
			var _htOption = this._htOption;
			var _el = this._el;
			var nCount = oQRCode.getModuleCount();
			var nWidth = Math.floor(_htOption.width / nCount);
			var nHeight = Math.floor(_htOption.height / nCount);

			this.clear();

			function makeSVG(tag, attrs) {
				var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
				for (var k in attrs)
					if (attrs.hasOwnProperty(k)) el.setAttribute(k, attrs[k]);
				return el;
			}

			var svg = makeSVG("svg" , {'viewBox': '0 0 ' + String(nCount) + " " + String(nCount), 'width': '100%', 'height': '100%', 'fill': _htOption.colorLight});
			svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
			_el.appendChild(svg);

			svg.appendChild(makeSVG("rect", {"fill": _htOption.colorLight, "width": "100%", "height": "100%"}));
			svg.appendChild(makeSVG("rect", {"fill": _htOption.colorDark, "width": "1", "height": "1", "id": "template"}));

			for (var row = 0; row < nCount; row++) {
				for (var col = 0; col < nCount; col++) {
					if (oQRCode.isDark(row, col)) {
						var child = makeSVG("use", {"x": String(row), "y": String(col)});
						child.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#template")
						svg.appendChild(child);
					}
				}
			}
		};
		Drawing.prototype.clear = function () {
			while (this._el.hasChildNodes())
				this._el.removeChild(this._el.lastChild);
		};
		return Drawing;
	})();

	var useSVG = document.documentElement.tagName.toLowerCase() === "svg";

	// Drawing in DOM by using Table tag
	var Drawing = useSVG ? svgDrawer : !_isSupportCanvas() ? (function () {
		var Drawing = function (el, htOption) {
			this._el = el;
			this._htOption = htOption;
		};

		/**
		 * Draw the QRCode
		 *
		 * @param {QRCode} oQRCode
		 */
		Drawing.prototype.draw = function (oQRCode) {
			var _htOption = this._htOption;
			var _el = this._el;
			var nCount = oQRCode.getModuleCount();
			var nWidth = Math.floor(_htOption.width / nCount);
			var nHeight = Math.floor(_htOption.height / nCount);
			var aHTML = ['<table style="border:0;border-collapse:collapse;">'];

			for (var row = 0; row < nCount; row++) {
				aHTML.push('<tr>');

				for (var col = 0; col < nCount; col++) {
					aHTML.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:' + nWidth + 'px;height:' + nHeight + 'px;background-color:' + (oQRCode.isDark(row, col) ? _htOption.colorDark : _htOption.colorLight) + ';"></td>');
				}

				aHTML.push('</tr>');
			}

			aHTML.push('</table>');
			_el.innerHTML = aHTML.join('');

			// Fix the margin values as real size.
			var elTable = _el.childNodes[0];
			var nLeftMarginTable = (_htOption.width - elTable.offsetWidth) / 2;
			var nTopMarginTable = (_htOption.height - elTable.offsetHeight) / 2;

			if (nLeftMarginTable > 0 && nTopMarginTable > 0) {
				elTable.style.margin = nTopMarginTable + "px " + nLeftMarginTable + "px";
			}
		};

		/**
		 * Clear the QRCode
		 */
		Drawing.prototype.clear = function () {
			this._el.innerHTML = '';
		};

		return Drawing;
	})() :
		(function () { // Drawing in Canvas
		function _onMakeImage() {
			this._elImage.src = this._elCanvas.toDataURL("image/png");
			this._elImage.style.display = "inline-block";
			this._elCanvas.style.display = "none";
		}

		// Android 2.1 bug workaround
		// http://code.google.com/p/android/issues/detail?id=5141
		if (this._android && this._android <= 2.1) {
			var factor = 1 / window.devicePixelRatio;
			var drawImage = CanvasRenderingContext2D.prototype.drawImage;
			CanvasRenderingContext2D.prototype.drawImage = function (image, sx, sy, sw, sh, dx, dy, dw, dh) {
				if (("nodeName" in image) && /img/i.test(image.nodeName)) {
					for (var i = arguments.length - 1; i >= 1; i--) {
						arguments[i] = arguments[i] * factor;
					}
				} else if (typeof dw == "undefined") {
					arguments[1] *= factor;
					arguments[2] *= factor;
					arguments[3] *= factor;
					arguments[4] *= factor;
				}

				drawImage.apply(this, arguments);
			};
		}

		/**
		 * Check whether the user's browser supports Data URI or not
		 *
		 * @private
		 * @param {Function} fSuccess Occurs if it supports Data URI
		 * @param {Function} fFail Occurs if it doesn't support Data URI
		 */
		function _safeSetDataURI(fSuccess, fFail) {
			var self = this;
			self._fFail = fFail;
			self._fSuccess = fSuccess;

			// Check it just once
			if (self._bSupportDataURI === null) {
				var el = document.createElement("img");
				var fOnError = function() {
					self._bSupportDataURI = false;

					if (self._fFail) {
						self._fFail.call(self);
					}
				};
				var fOnSuccess = function() {
					self._bSupportDataURI = true;

					if (self._fSuccess) {
						self._fSuccess.call(self);
					}
				};

				el.onabort = fOnError;
				el.onerror = fOnError;
				el.onload = fOnSuccess;
				el.src = "data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="; // the Image contains 1px data.
				return;
			} else if (self._bSupportDataURI === true && self._fSuccess) {
				self._fSuccess.call(self);
			} else if (self._bSupportDataURI === false && self._fFail) {
				self._fFail.call(self);
			}
		};

		/**
		 * Drawing QRCode by using canvas
		 *
		 * @constructor
		 * @param {HTMLElement} el
		 * @param {Object} htOption QRCode Options
		 */
		var Drawing = function (el, htOption) {
			this._bIsPainted = false;
			this._android = _getAndroid();

			this._htOption = htOption;
			this._elCanvas = document.createElement("canvas");
			this._elCanvas.width = htOption.width;
			this._elCanvas.height = htOption.height;
			el.appendChild(this._elCanvas);
			this._el = el;
			this._oContext = this._elCanvas.getContext("2d");
			this._bIsPainted = false;
			this._elImage = document.createElement("img");
			this._elImage.alt = "Scan me!";
			this._elImage.style.display = "none";
			this._el.appendChild(this._elImage);
			this._bSupportDataURI = null;
		};

		/**
		 * Draw the QRCode
		 *
		 * @param {QRCode} oQRCode
		 */
		Drawing.prototype.draw = function (oQRCode) {
			var _elImage = this._elImage;
			var _oContext = this._oContext;
			var _htOption = this._htOption;

			var nCount = oQRCode.getModuleCount();
			var nWidth = _htOption.width / nCount;
			var nHeight = _htOption.height / nCount;
			var nRoundedWidth = Math.round(nWidth);
			var nRoundedHeight = Math.round(nHeight);

			_elImage.style.display = "none";
			this.clear();

			for (var row = 0; row < nCount; row++) {
				for (var col = 0; col < nCount; col++) {
					var bIsDark = oQRCode.isDark(row, col);
					var nLeft = col * nWidth;
					var nTop = row * nHeight;
					_oContext.strokeStyle = bIsDark ? _htOption.colorDark : _htOption.colorLight;
					_oContext.lineWidth = 1;
					_oContext.fillStyle = bIsDark ? _htOption.colorDark : _htOption.colorLight;
					_oContext.fillRect(nLeft, nTop, nWidth, nHeight);

					// ?? ???? ?? ??
					_oContext.strokeRect(
						Math.floor(nLeft) + 0.5,
						Math.floor(nTop) + 0.5,
						nRoundedWidth,
						nRoundedHeight
					);

					_oContext.strokeRect(
						Math.ceil(nLeft) - 0.5,
						Math.ceil(nTop) - 0.5,
						nRoundedWidth,
						nRoundedHeight
					);
				}
			}

			this._bIsPainted = true;
		};

		/**
		 * Make the image from Canvas if the browser supports Data URI.
		 */
		Drawing.prototype.makeImage = function () {
			if (this._bIsPainted) {
				_safeSetDataURI.call(this, _onMakeImage);
			}
		};

		/**
		 * Return whether the QRCode is painted or not
		 *
		 * @return {Boolean}
		 */
		Drawing.prototype.isPainted = function () {
			return this._bIsPainted;
		};

		/**
		 * Clear the QRCode
		 */
		Drawing.prototype.clear = function () {
			this._oContext.clearRect(0, 0, this._elCanvas.width, this._elCanvas.height);
			this._bIsPainted = false;
		};

		/**
		 * @private
		 * @param {Number} nNumber
		 */
		Drawing.prototype.round = function (nNumber) {
			if (!nNumber) {
				return nNumber;
			}

			return Math.floor(nNumber * 1000) / 1000;
		};

		return Drawing;
	})();

	/**
	 * Get the type by string length
	 *
	 * @private
	 * @param {String} sText
	 * @param {Number} nCorrectLevel
	 * @return {Number} type
	 */
	function _getTypeNumber(sText, nCorrectLevel) {
		var nType = 1;
		var length = _getUTF8Length(sText);

		for (var i = 0, len = QRCodeLimitLength.length; i <= len; i++) {
			var nLimit = 0;

			switch (nCorrectLevel) {
				case QRErrorCorrectLevel.L :
					nLimit = QRCodeLimitLength[i][0];
					break;
				case QRErrorCorrectLevel.M :
					nLimit = QRCodeLimitLength[i][1];
					break;
				case QRErrorCorrectLevel.Q :
					nLimit = QRCodeLimitLength[i][2];
					break;
				case QRErrorCorrectLevel.H :
					nLimit = QRCodeLimitLength[i][3];
					break;
			}

			if (length <= nLimit) {
				break;
			} else {
				nType++;
			}
		}

		if (nType > QRCodeLimitLength.length) {
			throw new Error("Too long data");
		}

		return nType;
	}

	function _getUTF8Length(sText) {
		var replacedText = encodeURI(sText).toString().replace(/\%[0-9a-fA-F]{2}/g, 'a');
		return replacedText.length + (replacedText.length != sText ? 3 : 0);
	}

	/**
	 * @class QRCode
	 * @constructor
	 * @example
	 * new QRCode(document.getElementById("test"), "http://jindo.dev.naver.com/collie");
	 *
	 * @example
	 * var oQRCode = new QRCode("test", {
	 *    text : "http://naver.com",
	 *    width : 128,
	 *    height : 128
	 * });
	 *
	 * oQRCode.clear(); // Clear the QRCode.
	 * oQRCode.makeCode("http://map.naver.com"); // Re-create the QRCode.
	 *
	 * @param {HTMLElement|String} el target element or 'id' attribute of element.
	 * @param {Object|String} vOption
	 * @param {String} vOption.text QRCode link data
	 * @param {Number} [vOption.width=256]
	 * @param {Number} [vOption.height=256]
	 * @param {String} [vOption.colorDark="#000000"]
	 * @param {String} [vOption.colorLight="#ffffff"]
	 * @param {QRCode.CorrectLevel} [vOption.correctLevel=QRCode.CorrectLevel.H] [L|M|Q|H]
	 */
	QRCode = function (el, vOption) {
		this._htOption = {
			width : 256,
			height : 256,
			typeNumber : 4,
			colorDark : "#000000",
			colorLight : "#ffffff",
			correctLevel : QRErrorCorrectLevel.H
		};

		if (typeof vOption === 'string') {
			vOption	= {
				text : vOption
			};
		}

		// Overwrites options
		if (vOption) {
			for (var i in vOption) {
				this._htOption[i] = vOption[i];
			}
		}

		if (typeof el == "string") {
			el = document.getElementById(el);
		}

		if (this._htOption.useSVG) {
			Drawing = svgDrawer;
		}

		this._android = _getAndroid();
		this._el = el;
		this._oQRCode = null;
		this._oDrawing = new Drawing(this._el, this._htOption);

		if (this._htOption.text) {
			this.makeCode(this._htOption.text);
		}
	};

	/**
	 * Make the QRCode
	 *
	 * @param {String} sText link data
	 */
	QRCode.prototype.makeCode = function (sText) {
		this._oQRCode = new QRCodeModel(_getTypeNumber(sText, this._htOption.correctLevel), this._htOption.correctLevel);
		this._oQRCode.addData(sText);
		this._oQRCode.make();
		this._el.title = sText;
		this._oDrawing.draw(this._oQRCode);
		this.makeImage();
	};

	/**
	 * Make the Image from Canvas element
	 * - It occurs automatically
	 * - Android below 3 doesn't support Data-URI spec.
	 *
	 * @private
	 */
	QRCode.prototype.makeImage = function () {
		if (typeof this._oDrawing.makeImage == "function" && (!this._android || this._android >= 3)) {
			this._oDrawing.makeImage();
		}
	};

	/**
	 * Clear the QRCode
	 */
	QRCode.prototype.clear = function () {
		this._oDrawing.clear();
	};

	/**
	 * @name QRCode.CorrectLevel
	 */
	QRCode.CorrectLevel = QRErrorCorrectLevel;
//})();

module.exports=QRCode;
}
__bootstrap__.cachedtemplates={"View":{"as":"View","url":"libs/layout.js"},"Starz":{"url":"libs/module-Starz.js","asexports":true},"snapshot":{"url":"libs/ui/snapshot.js"},"UI.snapshot":{"url":"libs/UI/snapshot.js"},"UI.SvgChart":{"url":"libs/UI/svgchart.js"},"zSelector3":{"url":"libs/zSelector3.js"},"$File":{"url":"libs/fileapi.js"},"FILE":{"url":"libs/fileapi.js"},"Svg":{"url":"libs/svg.js"},"$.AUTH":{"url":"libs/auth.js"},"ace":{"url":["libs/ace/ace.js","libs/ace/mode-javascript.js"]},"Editor":{"dependancies":["ace","DomCore"],"url":"libs/editor.js"},"wysihtml5":{"url":["libs/wysihtml5-0.4.0pre.min.js","libs/wysihtml.css"]},"rte":{"url":"libs/rtf.js"},"Angular":{"url":"http://code.angularjs.org/1.2.13/angular.min.js"},"CoffeeScript":{"url":"http://coffeescript.org/extras/coffee-script.js"},"bootstraplib":{"dependencies":["http://code.jquery.com/jquery-latest.min.js","../css/bootstrap.css!#position:top"],"resolver":"function(){if(self.jQuery){self.jQuery.noConflict() }}","url":"http://getbootstrap.com/dist/js/bootstrap.js"},"traceur":{"url":"https://traceur-compiler.googlecode.com/git/bin/traceur.js"},"$.S":{"url":"libs/string.js"}}